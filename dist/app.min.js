function extending(){var t=Array.prototype.pop.call(arguments);return Array.prototype.slice.call(arguments).forEach(function(e){t.prototype=$.extend(Object.create(e.prototype),t.prototype)}),t.prototype.constructor=t,t}function extendingJQuery(t){return t.prototype=$.extend(Object.create(jQuery.prototype),t.prototype),t.prototype.constructor=t,t.prototype.pushStack=function(t){var e=jQuery.merge(this.get(0)==t?new this.constructor:$(),t);return e.prevObject=this,e.context=this.context,e},t}function tmpl(t,e,i,n){function a(t){return String(t+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function r(t,e){var i={},n={},r=l[(/<([\w:]+)/.exec(t)||["",""])[1].toLowerCase()]||l._default,o=r[0];for($.each(e,function(t,e){"string"==$.type(e)?n[t]=a(e):e instanceof jQuery?e.length&&(i[t]=e,e.is("tr")?n[t]='<tbody id="JQ_tmpl_'+t+'"></tbody>':e.is("span")?n[t]='<span id="JQ_tmpl_'+t+'"></span>':e.is("option")?n[t]='<optgroup id="JQ_tmpl_'+t+'"></optgroup>':n[t]='<div id="JQ_tmpl_'+t+'"></div>'):n[t]=null==e?"":e}),t=$(t?r[1]+t.format(n)+r[2]:""),$.each(i,function(e,i){t.find("#JQ_tmpl_"+e).append(i),i.is("tr")?i.parent("tbody").removeAttr("id"):i.unwrap()});o--;)t=t.children();return t}e=e||{},i=i instanceof Element?$(i):i;var o,s=$("#tmpl-"+t),l={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[1,"<div>","</div>"]},c=$();return l.tbody=l.tfoot=l.colgroup=l.caption=l.thead,l.th=l.td,s.length?(o=s.html().replace(/(?:\/\*(?:[\s\S]*?)\*\/)|(?:([\s;])+\/\/(?:.*)$)/gim,"").replace(/\\s{2,}|\t|\n|\r/gim,"").trim(),c=Array.isArray(e)?$.makeSet(e.map(function(t){return r(o,t)})):r(o,e),null==i?c:("prepend"===n?i.prepend(c):i.append(c),c)):(console.group("tmpl_error"),console.log("error in "+t),console.log("items",e),console.log("addTo",i),console.log("inputs",{template_type:t,items:e,addTo:i,direction:n}),console.groupEnd(),$())}function parseUri(t,e){t=decodeURIComponent(t);var i={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},n=i.parser[i.strictMode?"strict":"loose"].exec(t),a={},r=14;for(e&&$.extend(i,e);r--;)a[i.key[r]]=n[r]||"";return a[i.q.name]={},a[i.key[12]].replace(i.q.parser,function(t,e,n){e&&(a[i.q.name][e]=n)}),Object.defineProperties(a,{wo_query:{get:function(){return a[i.key[1]]+"://"+a[i.key[6]]+a[i.key[9]]}}}),a}function storeStat(t,e,i){window.__stats=window.__stats?window.__stats:[],window.__stats.push({entity_id:t,entity_type:e,event_type:i})}function getUnitsText(t,e){t=Math.abs(t);return t.toString().indexOf(".")>-1?e.GEN:t%10==1&&t%100!=11?e.NOM:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?e.GEN:e.PLU}function getGenderText(t,e){if("string"==typeof e)return e;switch(t){default:case OneUser.GENDER.MALE:return e.MAS;case OneUser.GENDER.FEMALE:return e.FEM;case OneUser.GENDER.NEUTRAL:return e.NEU}}function formatDates(t,e,i){function n(t,e,i,n,a){var r,o=["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"],s={d:e,D:e,t:i,T:i,M:n+1,MM:n+1>9?n+1:"0"+(n+1),MMM:__LOCALES.ru_RU.DATE.MONTH_SHORT_NAMES[n].toLocaleLowerCase(),MMMM:__LOCALES.ru_RU.DATE.MONTH_NAMES[n].toLocaleLowerCase(),MMMMs:o[n],Y:a,YY:a.substr(2,2),YYYY:a};return"string"==typeof t?r=t.format(s).capitalize():Array.isArray(t)?r=t.map(function(t){return t.format(s).capitalize()}):t instanceof jQuery?(r=$(),t.each(function(t,e){var i=$(e).clone();i.text(e.innerText.format(s).capitalize()),r=r.add(i)})):(r={},$.each(t,function(t,e){r[t]=e.format(s).capitalize()})),r}var a,r,o,s,l,c,d=!1,_=[],u=t.length-1,p={},h=[];return e||(e={date:"{D} {MMMMs} {YYYY}",time:"{T}"}),"string"==typeof e?d=e.contains(/\{T\}|\{t\}/)&&void 0!==t[0].start_time:(d=void 0!==t[0].start_time,$.each(e,function(){d=d||this.contains(/\{T\}|\{t\}/)})),i?(d&&(l=t[0].end_time?displayTimeRange(t[0].start_time,t[0].end_time):displayTimeRange(t[0].start_time)),t.forEach(function(t,e){a=moment.unix(t.event_date),o=a.year(),s=a.month(),p[o]||(p[o]={}),p[o][s]||(p[o][s]=[]),r?s!==r.month()||-1!==r.diff(a,"days")?(p[r.year()][r.month()].push(_.join("-")),_[0]=a.format("D")):_[1]=a.format("D"):_[0]=a.format("D"),e===u?p[o][s].push(_.join("-")):r=a}),$.each(p,function(t,i){$.each(i,function(i,a){h.push(n(e,a.join(", "),d?l:"",i,t))})})):(t.forEach(function(t,e){a=moment.unix(t.event_date),o=a.year(),s=a.month(),l=t.end_time?displayTimeRange(t.start_time,t.end_time):displayTimeRange(t.start_time),p[o]||(p[o]={}),p[o][s]||(p[o][s]=[]),r?s!==r.month()||-1!==r.diff(a,"days")||c!==l?(p[r.year()][r.month()].push({date:_.join("-"),time:c}),_=[a.format("D")]):_[1]=a.format("D"):_=[a.format("D")],e===u?p[o][s].push({date:_.join("-"),time:l}):(r=a,c=l)}),$.each(p,function(t,i){$.each(i,function(i,a){var r,o=[],s=[];$.each(a,function(t,e){r?e.time!=r?(o.push({date:s.join(", "),time:r}),s=[e.date]):s.push(e.date):s=[e.date],t===a.length-1?o.push({date:s.join(", "),time:e.time}):r=e.time}),$.each(o,function(a,r){h.push(n(e,r.date,d?r.time:"",i,t))})})})),h}function trimSeconds(t){return t=t.split(":"),3==t.length&&(t=t.splice(0,2)),t.join(":")}function displayDateRange(t,e){var i=moment.unix(t),n=moment.unix(e),a=moment();return i.isSame(n,"year")?i.isSame(n,"month")?i.isSame(n,"day")?i.format(i.isSame(a,"year")?"D MMM":"D MMM YYYY"):i.format("D")+"-"+n.format(i.isSame(a,"year")?"D MMM":"D MMM YYYY"):i.format("D MMM")+" - "+n.format(i.isSame(a,"year")?"D MMM":"D MMM YYYY"):i.format("MMM YYYY")+" - "+n.format("MMM YYYY")}function displayTimeRange(t,e){return e?e!=t||"00:00:00"!=t&&"00:00"!=t?trimSeconds(t)+" - "+trimSeconds(e):"Весь день":trimSeconds(t)}function formatCurrency(t,e,i,n,a){t=+t||0,e=e||" ",i=i||".";var r=(""+t).split(".")[1],o=t<0?"-":"",s=parseInt(Math.abs(t),10)+"",l=s.length>3?s.length%3:0;return""+(n?n+e:"")+o+(l?s.substr(0,l)+e:"")+s.substr(l).replace(/(\d{3})(?=\d)/g,"$1"+e)+(r?i+r:"")+(a?e+a:"")}function formatTicketNumber(t){return(""+t).replace(/(\d{3})/g,"$1 ").trim()}function unixTimestampToISO(t,e){return moment.unix(t).format(e||__C.DATE_FORMAT)}function guid(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}function randomString(t){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return new Array(t||32).fill("").map(function(){return e.charAt(Math.floor(Math.random()*e.length))}).join("")}function isFormValid(t){t=t instanceof Element?$(t):t;var e=!0,i=t.find("input, textarea"),n=i,a={};return t[0].checkValidity()||(i.each(function(t,e){e.name&&(a[e.name]=a[e.name]?a[e.name].add(e):$(e))}),$.each(a,function(t,i){var a=0;i.length>1&&(a=i.filter(function(t,e){return!$(e).is(":disabled")&&(e.checked&&"on"!==e.value||"radio"!==e.type)&&(e.checked&&"on"!==e.value||"on"===e.value||"checkbox"!==e.type)}).length,a||(handleErrorField(i),scrollTo(i,400,function(){showNotifier({text:i.data("error_message")||"Заполнены не все обязательные поля",status:!1})}),e=!1),n=n.not(i))}),n.each(function(t,i){(i.required&&(""===i.value.trim()||!i.checkValidity())||""!==i.value.trim()&&!i.checkValidity())&&(handleErrorField(i),scrollTo(i,400,function(){showNotifier({text:$(i).data("error_message")||"Заполнены не все обязательные поля",status:!1})}),e=!1)})),e}function getFilenameFromURL(t){return t?t.split("\\").pop().split("/").pop():""}function isPercentageString(t){return 0===/^[1-9]\d*%$|^0%$/.search(t)}function isBase64(t){return t.contains(";base64,")}function isFunction(t){return t&&"function"==typeof t}function isKeyPressed(t,e){return t.keyCode===e}function empty(t){return null==t||"object"==typeof t&&$.isEmptyObject(t)||t instanceof Array&&0===t.length}function range(t,e,i){var n=[];for(e=e||0,i=i||1;e!==t;e+=i)n.push(e);return n}function localeFromNamespace(t,e,i){for(var n in e)if(e.hasOwnProperty(n)&&e[n]===t)return i[n];return""}function initSelect2(t,e){var i={placeholder:"Выберите",allowClear:!0,containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"};return t.hasClass("-Handled_ToSelect2")&&t.select2("destroy"),e&&$.extend(!0,i,e),t.select2(i).addClass("-Handled_ToSelect2"),t}function outerAjax(t,e,i){e=e||{};var n;return e.fields instanceof Fields&&(e.fields=e.fields.toString()),n=$.ajax({url:t,data:e,method:"GET",contentType:i||"application/x-www-form-urlencoded; charset=UTF-8"}),n.then(function(t,e,i){return t}).promise()}function bindLimitInputSize(t){t=t||$("body"),t.find(".LimitSize").not(".-Handled_LimitSize").each(function(t,e){var i=$(e),n=i.closest(".form_unit"),a=i.data("maxlength"),r=i.siblings(".form_prompt");r.length?r.text(i.val().length+"/"+a):(i.after($("<p>").addClass("form_prompt").text(i.val().length+"/"+a)),r=i.siblings(".form_prompt")),i.on("input",function(){var t=i.val().length;if(i.is("textarea")){var e=i.val().match(/\n/g);t=e?t+e.length:t}t>a?n.addClass("-status_error"):n.hasClass("-status_error")&&n.removeClass("-status_error"),r.text(t+"/"+a)})}).addClass("-Handled_LimitSize")}function trimAvatarsCollection(t){t=t||$("body"),t.find(".AvatarsCollection").each(function(){var t=$(this),e=t.hasClass("-shifted"),i=t.hasClass("-subscribed"),n=t.find(".avatar"),a=n.outerWidth(),r=n.length;(i||e)&&r<t.data("max_amount")?t.width(1===r?a*r:a*r-6*(r-1)):t.width(1===r?0:a*(r-1)-6*(r-2)),t.addClass("-trimmed")})}function bindDatePickers(t){t=t||$("body"),t.find(".DatePicker").not(".-Handled_DatePicker").each(function(t,e){new DatePicker(e,$(e).data()).init()}).addClass("-Handled_DatePicker")}function bindTabs(t,e){t=t||$("body"),e="boolean"!=typeof e||e,t.find(".Tabs").not(".-Handled_Tabs").each(function(t,i){var n,a,r,o,s=$(i),l=s.data("tabs_id"),c=!!s.data("focus_on_change"),d=new MutationObserver(function(t){var e=$(t[t.length-1].target),i=e.closest(".TabsBody");i=e.hasClass("TabsBody")?i.add(e):i,i.each(function(t,e){var i=$(e);i.hasClass(__C.CLASSES.ACTIVE)&&(s.addClass("-in_progress"),i.parent().height(i.outerHeight()))})});l?(n=s.find('.TabsBodyWrapper[data-tabs_id="'+l+'"]'),r=s.find('.HeaderTabs[data-tabs_id="'+l+'"]')):(n=s.find(".TabsBodyWrapper:first"),r=s.find(".HeaderTabs:first")),a=n.children(".TabsBody"),o=r.children(".Tab"),Object.defineProperties(s,{currentTabsIndex:{get:function(){return o.index(o.filter("."+__C.CLASSES.ACTIVE))}},tabsCount:{get:function(){return o.length}}}),s.setToTab=function(t){var e=o.eq(t),i=a.eq(t);e.length&&!e.hasClass(__C.CLASSES.ACTIVE)&&(o.removeClass(__C.CLASSES.ACTIVE),a.removeClass(__C.CLASSES.ACTIVE),e.addClass(__C.CLASSES.ACTIVE),i.addClass(__C.CLASSES.ACTIVE),s.trigger("tabs:change"),c&&scrollTo(i,400))},s.nextTab=function(){s.setToTab(s.currentTabsIndex+1)},s.prevTab=function(){s.setToTab(s.currentTabsIndex-1)},s.connectMutationObserver=function(){a.each(function(t,e){d.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]})})},s.disconnectMutationObserver=function(){d.disconnect(),n.height("auto")},o.filter("."+__C.CLASSES.ACTIVE).length||o.eq(0).addClass(__C.CLASSES.ACTIVE),a.removeClass(__C.CLASSES.ACTIVE).eq(s.currentTabsIndex).addClass(__C.CLASSES.ACTIVE),n.on("transitionend",function(){s.removeClass("-in_progress"),s.trigger("progress_end")}),e&&(n.height(a.filter("."+__C.CLASSES.ACTIVE).outerHeight()),s.connectMutationObserver()),o.on("click",function(){s.setToTab(o.index(this))}),s.data("instance",s)}).addClass("-Handled_Tabs")}function bindShareButtons(t){t=t||$("body"),t.find(".ShareButton").not(".-Handled_ShareButton").each(function(t,e){var i=$(e);i.on("click",function(){window.open(i.data("href"),i.data("title"),"width=600,height=440,resizable=yes,scrollbars=no,status=no")})}).addClass("-Handled_ShareButton")}function bindSelect2(t){t=t||$("body");var e=t.is(".ToSelect2")?t:t.find(".ToSelect2");return e.not(".-Handled_ToSelect2").each(function(t,e){initSelect2($(e))}).addClass("-Handled_ToSelect2"),e}function bindRippleEffect(t){t=t||$("body");var e=t.is(".RippleEffect")?t:t.find(".RippleEffect");return e.not(".-Handled_RippleEffect").on("click.RippleEffect",function(t){var e,i,n,a,r=$(this),o=$();0===r.children(".Ripple").length&&r.prepend('<span class="ripple Ripple"></span>'),o=r.children(".Ripple"),o.removeClass("animate"),o.height()||o.width()||(i=Math.max(r.outerWidth(),r.outerHeight()),o.css({height:i,width:i})),n=t.pageX-r.offset().left-o.width()/2,a=t.pageY-r.offset().top-o.height()/2,o.css({top:a+"px",left:n+"px"}).addClass("animate"),e=o.data("timeout"),empty(e)||clearTimeout(e),e=setTimeout(function(){o.removeClass("animate")},650),o.data("timeout",e)}).addClass("-Handled_RippleEffect"),e}function bindDropdown(t){t=t||$("body");var e=t.is(".DropdownButton")?t:t.find(".DropdownButton");return e.not(".-Handled_DropdownButton").each(function(){var t,e=$(this),i=e.resolveInstance(),n=e.data(),a=$(".DropdownBox").filter('[data-dropdown_id="'+n.dropdown+'"]');if(i.initiate)return i.initiate();a.data($.extend({},a.data(),n)),a.closeDropbox=function(){$("body").off("mousedown.CloseDropdown"),$(document).off("keyup.CloseDropdown"),a.removeClass("-show"),e.addClass("-dropdown_active")},empty(n.ddWidth)||("self"===n.ddWidth?a.width(e.outerWidth()):(isFinite(n.ddWidth)||isPercentageString(n.ddWidth))&&a.width(n.ddWidth)),empty(n.ddPosX)&&empty(n.ddPosY)||(t=e.position(),empty(n.ddPosX)||a.css("left",function(){return"self.center"===n.ddPosX?t.left+e.outerWidth()/2-a.outerWidth()/2:"center"===n.ddPosX?a.parent().outerWidth()/2-a.outerWidth()/2:isFinite(n.ddPosX)?n.ddPosX:void 0}()),empty(n.ddPosY)||a.css("top",function(){return"self.center"===n.ddPosY?t.top+e.outerHeight()/2-a.outerHeight()/2:"center"===n.ddPosY?a.parent().outerHeight()/2-a.outerHeight()/2:isFinite(n.ddPosY)?t.top+e.outerHeight()+n.ddPosY:void 0}())),a.find(".CloseDropdown").on("click.CloseDropdown",a.closeDropbox),e.on("click.OpenDropdown",function(){a.addClass("-show"),e.addClass("-dropdown_active"),$("body").on("mousedown.CloseDropdown",function(t){$(t.target).closest(a).length||a.closeDropbox()}),$(document).on("keyup.CloseDropdown",function(t){isKeyPressed(t,__C.KEY_CODES.ESC)&&a.closeDropbox()})}),e.data("dropdown_box",a)}).addClass("-Handled_DropdownButton"),e}function bindFileLoadButton(t){t=t||$("body"),t.find(".FileLoadButton").not(".-Handled_FileLoadButton").click(function(t){$(this).children("input").get(0).click()}).addClass("-Handled_FileLoadButton")}function bindCollapsing(t){t=t||$("body"),t.find(".CollapsingWrapper").not(".-Handled_Collapsing").each(function(){function e(){var t=r.parents(".Tabs").resolveInstance();t.length&&t.disconnectMutationObserver(),r.addClass("-in_progress"),a.hasClass(__C.CLASSES.ACTIVE)?r.height(n):r.height(c.outerHeight()),r.toggleClass("-opened"),a.toggleClass(__C.CLASSES.ACTIVE),t.length&&t.connectMutationObserver()}function i(){a.$trigger.each(function(){var t=$(this);t.is(":checkbox")&&t.prop("checked",!t.prop("checked"))})}var n,a=$(this),r=a,o=r.closest(".Collapsing"),s=a.data("collapsing_id"),l=new MutationObserver(function(t){var e=$(t[t.length-1].target),i=e.parents(".CollapsingContent");i=e.hasClass("CollapsingContent")?i.add(e):i,i.each(function(t,e){var i=$(e),n=i.parent();n.hasClass("-opened")&&n.addClass("-in_progress").height(i.outerHeight())})}),c=r.children(".CollapsingContent");o=o.length?o:t,a.$trigger=o.find(s?'.CollapsingTrigger[data-collapsing_id="'+s+'"]':".CollapsingTrigger:first"),r.hasClass("-fading")?(n=a.data("defaultHeight")<c.height()?a.data("defaultHeight"):c.height(),!a.hasClass(__C.CLASSES.ACTIVE)&&r.height()<n&&r.height(n)):n=a.data("defaultHeight")?a.data("defaultHeight"):0,a.toggleCollapsing=function(){i(),e()},a.openCollapsing=function(){a.hasClass(__C.CLASSES.ACTIVE)||a.toggleCollapsing()},a.closeCollapsing=function(){a.hasClass(__C.CLASSES.ACTIVE)&&a.toggleCollapsing()},a.bindTrigger=function(t){var i=t.is(":checkbox")||t.is(":radio")?"change":"click";t?(t.on(i+".toggleCollapsing",e),a.$trigger=a.$trigger.add(t)):a.$trigger.on(i+".toggleCollapsing",e),a.$trigger.addClass("-Handled_CollapsingTrigger")},a.bindTrigger(a.$trigger),r.on("transitionend",function(){r.removeClass("-in_progress")}),n&&r.on("click.OpenCollapsing",function(){a.openCollapsing()}),l.observe(r.get(0),{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]}),a.data("instance",a)}).addClass("Handled_Collapsing")}function bindControlSwitch(t){t=t||$("body"),t.find(".Switch").not(".-Handled_Switch").each(function(e,i){var n=$(i);n.switching=t.find('.Switching[data-switch_id="'+n.data("switch_id")+'"]'),n.on("change.Switch",function(){n.switching.each(function(t,e){var i=$(e);i.is("fieldset")?i.prop("disabled",!i.prop("disabled")):i.toggleStatus("disabled")})})}).addClass("-Handled_Switch")}function bindCallModal(t){return t=t||$("body"),t.find("."+__C.CLASSES.HOOKS.CALL_MODAL).not("."+__C.CLASSES.HOOKS.HANDLED+__C.CLASSES.HOOKS.CALL_MODAL).each(function(){$(this).on("click.CallModal",function(){var t=$(this),e=t.data(),i=e.modal_title,n=e.modal,a=e.modal_type;if(!n){switch(a){case __C.MODAL_TYPES.FAVORS:n=new FavoredModal(e.modal_event_id,i);break;case __C.MODAL_TYPES.SUBSCRIBERS:n=new SubscribersModal(e.modal_organization_id,i);break;case __C.MODAL_TYPES.EDITORS:n=new EditorsModal(e.modal_organization_id,i,e.modal_specific_role);break;case __C.MODAL_TYPES.MAP:n=new MapModal(e.modal_map_location,i);break;case __C.MODAL_TYPES.MEDIA:var r=e.modal_media_type,o=e.modal_media_url;if(!o)if(t.is("img"))o=t.attr("src"),r="image";else if(t.is("video"))r="video";else{var s=t.css("background-image");"none"!==s&&(o=-1!=s.indexOf('"')?s.slice(s.indexOf('"')+1,s.indexOf('"',s.indexOf('"')+1)):s.slice(s.indexOf("(")+1,s.indexOf(")")),r="image")}n=new MediaModal(parseUri(o).wo_query,r);break;case __C.MODAL_TYPES.CROPPER:n=new CropperModal(e.source_img,e);break;case __C.MODAL_TYPES.FRIENDS_LIST:n=new FriendsListModal(e.modal_entity);break;case __C.MODAL_TYPES.SUBSCRIBERS_LIST:n=new SubscriptionsListModal(e.modal_entity);break;case __C.MODAL_TYPES.TICKET:n=new TicketsModal(e.tickets||e.ticket_uuid);break;case __C.MODAL_TYPES.ADD_STAFF:n=new AddStaffModal(e.modal_org_id,e.modal_role);break;default:n=new StdModal(i,e.modal_content,e.modal_style)}t.data("modal",n)}n.show()})}).addClass(__C.CLASSES.HOOKS.HANDLED+__C.CLASSES.HOOKS.CALL_MODAL)}function bindPageLinks(t){return t=t||$("body"),(t.is(".Link")?t:t.find(".Link")).not(".-Handled_Link").on("click.pageRender",function(t){var e=$(this);if(e.hasClass(__C.CLASSES.DISABLED))return!1;1===t.which&&(t.preventDefault(),__APP.changeState(e.attr("href")))}).addClass("-Handled_Link")}function handleErrorField(t){var e;return t instanceof jQuery?t.is(".form_unit")?(t.closest(".form_unit").hasClass("-status_error")||(e=t.find("input, select, textarea"),t.addClass("-status_error").off("input.ClearError change.ClearError").one("input.ClearError change.ClearError",function(){t.off("input.ClearError change.ClearError").removeClass("-status_error"),e.off("blur.ClearError")}),e.off("blur.ClearError").one("blur.ClearError",function(){""!==$(this).val().trim()&&t.trigger("input.ClearError")})),t):t.closest(".form_unit").length?handleErrorField(t.closest(".form_unit")):t:handleErrorField($(t))}function toDataUrl(t,e){var i=new XMLHttpRequest;i.responseType="blob",i.onload=function(){var t=new FileReader;t.onloadend=function(){e(t.result)},t.readAsDataURL(i.response)},i.open("GET",t),i.send()}function showNotifier(t){$.notify({message:t.text,pos:t.pos?t.pos:"top-right",status:t.status?"success":"danger"})}function isNotDesktop(){var t=!1;return function(e){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0)}(navigator.userAgent||navigator.vendor||window.opera),t}function scrollTo(t,e,i){var n;return n=t instanceof jQuery?t.offset().top-150:t instanceof Element?$(t).offset().top-150:t-150,!i||i instanceof Function||(i=function(){}),$("body").stop().animate({scrollTop:Math.ceil(n)},{duration:e||400,easing:"swing",complete:i}),n}function isScrollRemain(t){return t=t||200,$(window).height()+$(window).scrollTop()+ +t>=$(document).height()}function setDefaultValue(t,e){return void 0===t||"object"==typeof t&&$.isEmptyObject(t)?e:t}function searchToObject(){var t,e,i=window.location.search.substring(1).split("&"),n={};for(e in i)if(i.hasOwnProperty(e)){if(""===i[e])continue;t=i[e].split("="),n[decodeURIComponent(t[0])]=decodeURIComponent(t[1])}return n}function hashToObject(){var t,e,i=window.location.hash.substring(1).split("&"),n={};for(e in i)if(i.hasOwnProperty(e)){if(""===i[e])continue;t=i[e].split("="),n[decodeURIComponent(t[0])]=decodeURIComponent(t[1])}return n}function checkRedirect(t,e,i){var n=window.location.pathname;return t&&i^n.contains(t)?__APP.changeState(e,!0,!0):__APP.USER.isLoggedOut()&&n.contains("/admin")?__APP.changeState("/",!0,!0):!n.contains("/statistics")||__APP.changeState(n.replace("statistics","admin"),!0,!0)}__C={API_TOKENS:{DADATA:"7f2a3dad57bdaefebcb6e26ef7600b62b9658467"},CLASSES:{MATERIAL:"material",FLOATING_MATERIAL:"material -floating_material",IMG_HOLDER:"img_holder",COMPONENT:{ACTION:"action",BUTTON:"button"},TEXT_COLORS:{ACCENT:"-text_color_accent"},TEXT_WEIGHT:{BOLD:"-font_weight_bold",BOLDER:"-font_weight_bolder",LIGHTER:"-font_weight_lighter"},COLORS:{ACCENT:"-color_accent",PRIMARY:"-color_primary",DEFAULT:"-color_default",NEUTRAL:"-color_neutral",NEUTRAL_ACCENT:"-color_neutral_accent",MARGINAL:"-color_marginal",MARGINAL_ACCENT:"-color_marginal_accent",MARGINAL_PRIMARY:"-color_marginal_primary",MARGINAL_FRANKLIN:"-color_marginal_franklin",MARGINAL_BUBBLEGUM:"-color_marginal_bubble_gum",YANDEX:"-color_yandex"},ALIGN:{LEFT:"-align_left",CENTER:"-align_center",RIGHT:"-align_right"},UNIVERSAL_STATES:{EMPTY:"-empty",ROUNDED:"-rounded",SHADOWED:"-shadowed",BORDERED:"-bordered",UPPERCASE:"-transform_uppercase",NO_UPPERCASE:"-no_uppercase"},STATUS:{SUCCESS:"-status_success",WARNING:"-status_warning",PENDING:"-status_pending",ERROR:"-status_error",DISABLED:"-status_disabled"},SIZES:{X30:"-size_30x30",X40:"-size_40x40",X50:"-size_50x50",X55:"-size_55x55",HUGE:"-size_huge",BIG:"-size_big",LOW:"-size_low",WIDE:"-size_wide",SMALL:"-size_small"},MODAL_STATES:{FIXED:"-fixed",NO_PADDING:"-no_padding",SIZE:{WIDE:"-size_wide",NARROW:"-size_narrow",TINY:"-size_tiny",RESPONSIVE:"-size_responsive"}},HOOKS:{HANDLED:"-Handled_",RIPPLE:"RippleEffect",ADD_STAFF:"AddStaff",ADD_TO_FAVORITES:"AddToFavorites",TEXT:"Text",CALL_MODAL:"CallModal",CLOSE_MODAL:"CloseModal",DROPDOWN_BUTTON:"DropdownButton",ADD_AVATAR:{ANCESTOR:"AddAvatarWrapper",COLLECTION:"AvatarsCollection",QUANTITY:"FavoredCount",STATES:{CAST:"-cast",CASTABLE:"-castable",SHIFT:"-shift",SHIFTED:"-shifted"}}},ACTIVE:"-active",DISABLED:"-disabled",HIDDEN:"-hidden",SHOW:"-show",ICONS:{STAR:"fa-star",STAR_O:"fa-star-o",BELL_O:"fa-bell-o",TIMES:"fa-times",PLUS:"fa-plus",MINUS:"fa-minus",CHECK:"fa-check",PENCIL:"fa-pencil",EYE:"fa-eye",EYE_CLOSE:"fa-eye-slash",TICKET:"fa-ticket",DOWNLOAD:"fa-download"},ICON_CLASS:"fa_icon"},SOCICON_CLASSES:{vk:"fa-vk",google:"fa-google-plus",facebook:"fa-facebook-official"},DATE_FORMAT:"YYYY-MM-DD",TIME_FORMAT:"HH:mm",MODAL_TYPES:{FAVORS:"favors",SUBSCRIBERS:"subscribers",EDITORS:"editors",MAP:"map",MEDIA:"media",CROPPER:"cropper",FRIENDS_LIST:"friends_list",SUBSCRIBERS_LIST:"subscribers_list",TICKET:"tickets",ADD_STAFF:"add_staff"},COLORS:{PRIMARY:"#2e3b50",MUTED:"#3e4d66",MUTED_80:"#657184",MUTED_50:"#9fa6b3",MUTED_30:"#c5c9d1",TEXT:"#4a4a4a",ACCENT:"#f82969",ACCENT_ALT:"#ff5f9e",FRANKLIN:"#28be84",FRANKLIN_ALT:"#23d792"},STATS:{EVENT_VIEW:"view",EVENT_VIEW_DETAIL:"view_detail",EVENT_OPEN_SITE:"open_site",EVENT_OPEN_MAP:"open_map",ORGANIZATION_OPEN_SITE:"open_site",EVENT_ENTITY:"event",ORGANIZATION_ENTITY:"organization"},ENTITIES:{USER:"user",EVENT:"event",ORGANIZATION:"organization"},DEFERRED_STATES:{PENDING:"pending",RESOLVED:"resolved",REJECTED:"rejected"},KEY_CODES:{ENTER:13,ESC:27}},Object.freeze(__C),String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.contains=function(t){return-1!==this.search(t)},String.prototype.format=function(t){return this.replace(/\{(\w+)\}/g,function(e,i){return null!=t[i]?t[i]:""})},String.prototype.toCamelCase=function(t){return this.split(t||" ").map(function(t){return t.capitalize()}).join("")},String.prototype.toUnderscore=function(){return(this.charAt(0).toLowerCase()+this.slice(1)).replace(/([A-Z])/g,function(t){return"_"+t.toLowerCase()})},String.prototype.appendAjaxData=function(t){return t.fields&&t.fields instanceof Array&&(t.fields=t.fields.join(",")),this+JSON.stringify(t)},Object.props=function(t){return Object.keys(t).filter(function(e){return"function"!=typeof t[e]})},Object.getProps=function(t){var e={};return $.each(t,function(t,i){"function"!=typeof i&&(e[t]=i)}),e},Object.methods=function(t){var e=[];return Object.keys(t).forEach(function(i){"function"==typeof t[i]&&e.push(i)}),e},"function"!=typeof Object.values&&(Object.values=function(t){var e=[];for(var i in t)t.hasOwnProperty(i)&&t.propertyIsEnumerable(i)&&e.push(t[i]);return e}),Object.toHtmlDataSet=function(){var t=[],e=this;return Object.props(e).forEach(function(i){t.push((0!=i.indexOf("data-")?"data-"+i:i)+'="'+e[i]+'"')}),t.join(" ")},Object.toHtmlAttributes=function(){var t=[],e=this;return Object.props(e).forEach(function(i){t.push(i+'="'+e[i]+'"')}),t.join(" ")},Array.newFrom=function(t,e){var i,n,a=t.slice(0);if(arguments.length>1)for(n=1;n<arguments.length;n++)switch(typeof(i=arguments[n])){case"number":case"string":case"boolean":$.merge(a,[i]);break;case"object":i instanceof Array?$.merge(a,i):$.merge(a,Object.keys(i).map(function(t){return i[t]}));break;default:console.error("")}return a},Array.toSpaceSeparatedString=function(){return this.join(" ")},Array.prototype.clean=function(t){for(var e=0;e<this.length;e++)this[e]==t&&(this.splice(e,1),e--);return this},Array.prototype.merge=function(t){var e=Array.prototype.slice.call(arguments),i={},n=[],a=0,r=0;for(e.unshift(this),a=0;a<e.length;a++)for(r=0;r<e[a].length;r++)!0!==i[e[a][r]]&&(n[n.length]=e[a][r],i[e[a][r]]=!0);return n},Array.prototype.contains=function(t){return-1!==this.indexOf(t)},[].includes||(Array.prototype.includes=function(t){"use strict";var e=Object(this),i=parseInt(e.length)||0;if(0===i)return!1;var n,a=parseInt(arguments[1])||0;for(a>=0?n=a:(n=i+a)<0&&(n=0);n<i;){var r=e[n];if(t===r||t!==t&&r!==r)return!0;n++}return!1}),Math.roundTo=function(t,e){var i=Math.pow(10,e||0);return Math.round(t*i)/i},function(t){function e(e){var i,n,a,r=t(e.elem),o={separator:" ",group_length:3,suffix:"",prefix:""};if(e.elem.nodeType&&e.elem.parentNode){if(i=t.extend(!0,{},o,r.data()),n=Math.floor(e.now),a=n.toString(),a.length>i.group_length){var s=function(t,e){for(var i,n,a,r=t.split("").reverse(),o=[],s=0,l=Math.ceil(t.length/e);s<l;s++){for(i="",a=0;a<e&&(n=s*e+a)!==t.length;a++)i+=r[n];o.push(i)}return o}(a,i.group_length);a=function(t){var e=t.length-1,i=t[e].split("").reverse().join("");return t[e]=parseInt(i,10).toString().split("").reverse().join(""),t}(s).join(i.separator),a=a.split("").reverse().join("")}r.prop("number",e.now).text(i.prefix+a+i.suffix)}}t.Tween&&t.Tween.propHooks?t.Tween.propHooks.number={set:e}:t.fx.step.number=e}(window.jQuery),$.fn.extend({toggleStatus:function(t){var e=this;return e.is(".form_unit")?t.split(" ").forEach(function(t){var i=e.find("input, select, textarea, button");"disabled"===t&&(e.hasClass("-status_disabled")?i.removeAttr("disabled"):i.attr("disabled",!0)),e.toggleClass("-status_"+t)}):e.is("input, textarea, select, button")?e.closest(".form_unit").toggleStatus(t):e.length&&e.find(".form_unit").toggleStatus(t),this},serializeForm:function(t){var e=/^(?:input|select|textarea|keygen)/i,i=/^(?:submit|button|image|reset|file)$/i,n=/^(?:checkbox|radio)$/i,a=/\r?\n/g,r=this.map(function(){var t=$.prop(this,"elements");return t?$.makeArray(t):this});switch(t){case"array":var o,s=[],l={};return o=r.filter(function(){return this.name&&!$(this).is(":disabled")&&"checkbox"===this.type}),o.each(function(){l[this.name]?l[this.name]=l[this.name].add(this):l[this.name]=$(this)}),$.each(l,function(t,e){var i;1===e.length?i="on"===e.val()?e.prop("checked"):e.val():(i=[],e.filter(":checked").each(function(){i.push("on"===this.value?this.checked:this.value)})),s.push({name:t,value:i})}),r.not(o).filter(function(){var t=this.type;return this.name&&!$(this).is(":disabled")&&e.test(this.nodeName)&&!i.test(t)&&(this.checked&&"on"!=this.value||"radio"!=t)&&(this.checked&&"on"!=this.value||"on"==this.value||"checkbox"!=t)}).each(function(t,e){var i=$(this).val(),n="";switch(this.type){case"radio":case"checkbox":n="on"==i?this.checked?1:0:i;break;default:n=i.replace(a,"\r\n")}null!=i&&s.push({name:e.name,value:n})}),s;case"object":default:var c={};return r.filter(function(){return this.name&&!$(this).is(":disabled")&&e.test(this.nodeName)&&!i.test(this.type)&&!n.test(this.type)}).each(function(t,e){var i=$(e),n=e.name,o=i.val(),s=function(t,e){var i=$(e);return i.is(":enabled")&&i.is('[name="'+n+'"]')};if(r.filter(s).length>1)c[n]=void 0===c[n]?[]:c[n],c[n].push(o?o.replace(a,"\r\n"):o);else if("hidden"===i.attr("type")&&0===o.indexOf("data.")){for(var l=o.split("."),d=i.data(l[1]),_=2;l[_];)d=d[l[_]],_++;c[n]=d}else c[n]=o||0===o?o.replace(a,"\r\n"):null}),r.filter(function(){return this.name&&!$(this).is(":disabled")&&n.test(this.type)&&(this.checked&&"on"!==this.value||"on"===this.value&&"checkbox"===this.type)}).each(function(t,e){var i=e.name,n=e.value;switch(e.type){case"radio":c[i]=n;break;case"checkbox":
r.filter("[name='"+i+"']").length>1&&"on"!==n?(c[i]=void 0===c[i]?[]:c[i],c[i].push(n)):c[i]="on"!==n?n:!!e.checked}}),c}},animateNumber:function(t){for(var e=[t],i=1,n=arguments.length;i<n;i++)e.push(arguments[i]);return this.data(t),this.animate.apply(this,e)},tablesort:function(t){t=setDefaultValue(t,{});var e,i=this.get(0),n=null;return Tablesort&&"function"==typeof Tablesort?(n=new Tablesort(i,t),e=new MutationObserver(function(){n.refresh()}),e.observe(i,{attributes:!0,childList:!0}),this.data({tablesort_instance:n,mutation_observer_instance:e})):console.error("Tablesort is not defined"),n},resolveInstance:function(){var t=this.data("instance");return t||this},outerHTML:function(){var t="";return this.each(function(e,i){t+=i.outerHTML}),t}}),jQuery.makeSet=function(t){return $($.map(t,function(t){return t.get()}))},function(t,e,i){var n={},a={},r=function(e){return"string"==t.type(e)&&(e={message:e}),arguments[1]&&(e=t.extend(e,"string"==t.type(arguments[1])?{status:arguments[1]}:arguments[1])),new s(e).show()},o=function(t,e){if(t)for(var i in a)t===a[i].group&&a[i].close(e);else for(var i in a)a[i].close(e)},s=function(e){this.options=t.extend({},s.defaults,e),this.uuid="ID"+(new Date).getTime()+"RAND"+Math.ceil(1e5*Math.random()),this.element=t(['<div class="uk-notify-message alert-dismissable">','<a class="close">&times;</a>',"<div>"+this.options.message+"</div>","</div>"].join("")).data("notifyMessage",this),this.options.status&&(this.element.addClass("alert alert-"+this.options.status),this.currentstatus=this.options.status),this.group=this.options.group,a[this.uuid]=this,n[this.options.pos]||(n[this.options.pos]=t('<div class="uk-notify uk-notify-'+this.options.pos+'"></div>').appendTo("body").on("click",".uk-notify-message",function(){t(this).data("notifyMessage").close()}))};t.extend(s.prototype,{uuid:!1,element:!1,timout:!1,currentstatus:"",group:!1,show:function(){if(!this.element.is(":visible")){var t=this;n[this.options.pos].show().prepend(this.element);var e=parseInt(this.element.css("margin-bottom"),10);return this.element.css({opacity:0,"margin-top":-1*this.element.outerHeight(),"margin-bottom":0}).animate({opacity:1,"margin-top":0,"margin-bottom":e},function(){if(t.options.timeout){var e=function(){t.close()};t.timeout=setTimeout(e,t.options.timeout),t.element.hover(function(){clearTimeout(t.timeout)},function(){t.timeout=setTimeout(e,t.options.timeout)})}}),this}},close:function(t){var e=this,i=function(){e.element.remove(),n[e.options.pos].children().length||n[e.options.pos].hide(),delete a[e.uuid]};this.timeout&&clearTimeout(this.timeout),t?i():this.element.animate({opacity:0,"margin-top":-1*this.element.outerHeight(),"margin-bottom":0},function(){i()})},content:function(t){var e=this.element.find(">div");return t?(e.html(t),this):e.html()},status:function(t){return t?(this.element.removeClass("alert alert-"+this.currentstatus).addClass("alert alert-"+t),this.currentstatus=t,this):this.currentstatus}}),s.defaults={message:"",status:"normal",timeout:5e3,group:null,pos:"top-center"},t.notify=r,t.notify.message=s,t.notify.closeAll=o}(jQuery,window,document),function(t){t.cookies={getItem:function(t){return t?decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null:null},setItem:function(t,e,i,n,a,r){var o="";if(!t||/^(?:expires|max\-age|path|domain|secure)$/i.test(t))return!1;if(i)switch(i.constructor){case Number:o=i===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+i;break;case String:o="; expires="+i;break;case Date:o="; expires="+i.toUTCString()}return document.cookie=encodeURIComponent(t)+"="+encodeURIComponent(e)+o+(a?"; domain="+a:"")+(n?"; path="+n:"")+(r?"; secure":""),!0},removeItem:function(t,e,i){return!!this.hasItem(t)&&(document.cookie=encodeURIComponent(t)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(i?"; domain="+i:"")+(e?"; path="+e:""),!0)},hasItem:function(t){return!!t&&new RegExp("(?:^|;\\s*)"+encodeURIComponent(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},keys:function(){for(var t=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),e=t.length,i=0;i<e;i++)t[i]=decodeURIComponent(t[i]);return t}}}(window),AsynchronousConnection=function(){function t(){if("object"==typeof t.instance)return t.instance;t.instance=this}return t.HTTP_METHODS={GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE"},Object.freeze(t.HTTP_METHODS),t.prototype.dealAjax=t.dealAjax=function(t,e,i,n,a,r){return $.ajax({url:e,data:i,method:t,contentType:n||"application/x-www-form-urlencoded; charset=UTF-8"}).then(function(t,e,i){return t.hasOwnProperty("status")&&t.hasOwnProperty("data")&&t.hasOwnProperty("code")&&t.hasOwnProperty("text")?t.data:t}).fail(r).done(a)},t.prototype.multipleAjax=t.multipleAjax=function(){var t,e=arguments[arguments.length-1]instanceof Function,i=e?Array.prototype.splice.call(arguments,0,arguments.length-1):Array.prototype.slice.call(arguments);return t=$.when.apply($,i),e&&t.done(Array.prototype.shift.call(arguments)),t.promise()},t}(),Payment=extending(AsynchronousConnection,function(){function t(){if("object"==typeof t.instance)return t.instance;t.instance=this}return t.payForTariff=function(t,e){return AsynchronousConnection.dealAjax(AsynchronousConnection.HTTP_METHODS.POST,"/api/v1/payments/organizations/",{organization_id:t},null,e)},t.doPayment=function(t,e,i){var n=tmpl("payment-form",{customer_id:__APP.USER.full_name,cps_email:__APP.USER.email,callback_url:i||location.href,payment_uuid:t,sum:e},__APP.CURRENT_PAGE.$wrapper);__APP.IS_WIDGET&&n.attr("target","__blank"),n.submit().remove()},t}()),ServerConnection=extending(AsynchronousConnection,function(){function t(){if("object"==typeof t.instance)return t.instance;this.current_connections=[],this.error_log=[],t.instance=this}function e(e,i,n){n=void 0!==n?n:t.stdErrorHandler,i="function"!=typeof i?function(){}:i;try{e.status?i(e.data,e.text):n(e)}catch(t){n(t)}}return t.MAX_ENTITIES_LENGTH=1e4,t.stdErrorHandler=function(t){console.error("Exorcizamus te, omnis immundus spiritus, omnis satanica potestas, omnis incursio infernalis adversarii, omnis legio, omnis congregatio et secta diabolica, in nomine et virtute Domini Nostri Jesu Christi, eradicare et effugare a Dei Ecclesia, ab animabus ad imaginem Dei conditis ac pretioso divini Agni sanguine redemptis!\n",t),showNotifier({text:"Упс, что-то пошло не так",status:!1})},t.prototype.ajaxErrorHandler=function(t,e,i,n){var a,r=Array.prototype.slice.call(arguments),o={};switch(r.length){case 4:a=["event","jqxhr","settings","thrownError"],r.forEach(function(t,e){o[a[e]]=t});break;case 3:a=["jqxhr","text","thrownError"],r.forEach(function(t,e){o[a[e]]=t});break;case 1:o=r[0];break;default:r.forEach(function(t,e){o[e]=t})}console.groupCollapsed("AJAX error"),o.thrownError&&console.log("Thrown error:",o.thrownError),o.event&&o.event.type&&console.log("Error type:",o.event.type),o.event&&o.event.text&&console.log("Description:",o.event.text),o.jqxhr&&(o.jqxhr.responseJSON&&o.jqxhr.responseJSON.text?(console.log("Response:",o.jqxhr.responseJSON.text),showNotifier({text:o.jqxhr.responseJSON.text,status:!1})):o.jqxhr.statusText&&showNotifier({text:o.jqxhr.statusText,status:!1})),o.settings&&(console.log("URL:",o.settings.url),console.log("Method:",o.settings.type)),o.stack?(console.log("Thrown error:",o.name),console.log("Description:",o.message),console.log("Error stacktrace:",o.stack)):console.error("Error stacktrace:"),console.groupEnd(),this.error_log.push(o)},t.prototype.dealAjax=t.dealAjax=function(t,i,n,a,r,o){n=n||{};var s,l=this;return n.fields instanceof Fields&&(n.fields=n.fields.toString()),i=i.contains("/api/v1")?i:"/api/v1"+i,s=$.ajax({url:i,data:n,method:t,contentType:a||"application/x-www-form-urlencoded; charset=UTF-8"}),this.current_connections.push(s),s.fail(function(t,e,i){"abort"!==i&&(isFunction(o)?o(null,t,this,i):l.ajaxErrorHandler(null,t,this,i))}).then(function(t,i,n){return e(t,function(t,e){isFunction(r)&&r(t)}),t.data}).promise()},t.prototype.getData=function(t,e,i,n){return this.dealAjax(AsynchronousConnection.HTTP_METHODS.GET,t,this.validateData(e),"application/json",function(t){empty(e.length)||empty(e.offset)||(e.offset+=e.length),isFunction(i)&&i(t)},n)},t.prototype.updateData=function(t,e,i,n,a){return i?this.dealAjax(AsynchronousConnection.HTTP_METHODS.PUT,t,JSON.stringify(e),"application/json",n,a):this.dealAjax(AsynchronousConnection.HTTP_METHODS.PUT,t,e,"application/x-www-form-urlencoded; charset=UTF-8",n,a)},t.prototype.addData=function(t,e,i,n,a){return i?this.dealAjax(AsynchronousConnection.HTTP_METHODS.POST,t,JSON.stringify(e),"application/json",n,a):this.dealAjax(AsynchronousConnection.HTTP_METHODS.POST,t,e,"application/x-www-form-urlencoded; charset=UTF-8",n,a)},t.prototype.deleteData=function(t,e,i,n){return this.dealAjax(AsynchronousConnection.HTTP_METHODS.DELETE,t+"?"+$.param(e),{},"application/json",i,n)},t.prototype.validateData=function(t){t=t||{};var e=[];return t.order_by&&(e="string"==typeof t.order_by?t.order_by.split(","):t.order_by,e=e.map(function(t){return t.trim().replace("-","")}),t.order_by instanceof Array&&(t.order_by=t.order_by.join(","))),t.fields?t.fields instanceof Array?t.fields=t.fields.merge(e):t.fields instanceof Fields&&e.length&&e.forEach(function(e){t.fields.add(e)}):t.fields=e,t.fields=(t.fields=t.fields.toString())?t.fields:void 0,t},t.prototype.abortAllConnections=function(){for(var t;this.current_connections.length;)t=this.current_connections.pop(),200===t.state&&"pending"!==t.state()||t.abort()},t}()),ServerExports=extending(AsynchronousConnection,function(){function t(){if("object"==typeof t.instance)return t.instance;t.instance=this}return t.EXPORT_EXTENSION={XLSX:"xlsx",HTML:"html"},t.prototype.export=function(e,i){return $.fileDownload(e,{data:{format:i||t.EXPORT_EXTENSION.XLSX}})},t.prototype.organizationSubscribers=function(t,e){return this.export("/api/v1/statistics/organizations/"+t+"/subscribers/export",e)},t.prototype.eventOrders=function(t,e){return this.export("/api/v1/statistics/events/"+t+"/orders/export",e)},t.prototype.eventTickets=function(t,e){return this.export("/api/v1/statistics/events/"+t+"/tickets/export",e)},t.prototype.eventTicket=function(t,e){return this.export("/events/{event_id}/tickets/{ticket_uuid}/export".format({event_id:t,ticket_uuid:e}))},t}()),-1==window.location.hostname.indexOf(".test.evendate.ru")?window.socket=io.connect("https:"==window.location.protocol?":8443":":8080",{secure:"https:"==window.location.protocol}):window.socket=io({path:"/node/socket.io"}),socket.on("log",function(t){console.log(t)}),socket.on("image.getFromURLDone",function(t){t.error?showNotifier({text:t.error,status:!1}):ImgLoader.handleImgUpload(ImgLoader.current_load_context,t.data,t.filename)}),EntityInterface=function(){function t(){}return t.prototype.setData=function(t){},t}(),Fields=function(){function t(t){this.add.apply(this,arguments)}function e(e){var i={};return e instanceof Array||(e=e.replace(/\s+/g,"").match(/(\w+\{[^}]+}|\w+)/g)),e.forEach(function(e){var n=e.split("{"),a={};n.length>1&&(a=JSON.parse("{"+n[1].replace(/(\w+):/g,function(t,e){return'"'+e+'":'})),a.fields&&(a.fields=new(Function.prototype.bind.apply(t,[null].concat(a.fields.split(","))))),a.order_by&&(a.order_by=a.order_by.split(","))),i[n[0]]=a}),i}var i=function(){function e(t){var e;for(e in t)this[e]=t[e]}return Object.defineProperties(e.prototype,{toString:{value:function(){var e=this,i=Object.props(this),n={};return 0===i.length?"":(i.forEach(function(i){n[i]=e[i]instanceof Array||e[i]instanceof t?e[i].toString():e[i]}),JSON.stringify(n))}},merge:{value:function(t){return $.extend(this,t)}}}),e}();return Object.defineProperty(t.prototype,"toString",{value:function(){var t=this,e=Object.props(this);if(0!==e.length)return e.map(function(e){return e+t[e]}).join(",")}}),t.parseFields=function(i){return i instanceof t?i.copy():new t(e(i))},t.prototype.get=function(t){return this.has(t)?this[t]:null},t.prototype.push=t.prototype.add=function(){var t,e=Array.prototype.splice.call(arguments,0),n={};e.forEach(function(t){"string"==typeof t?n[t]={}:t instanceof Array?t.forEach(function(t){n[t]={}}):t instanceof Object&&Object.props(t).forEach(function(e){n[e]=t[e]})});for(t in n)this.has(t)?this[t].merge(n[t]):this[t]=new i(n[t]);return this},t.prototype.pull=function(t){var e=this.get(t);return this.delete(t),e},t.prototype.has=function(t){return void 0!==this[t]},t.prototype.delete=function(t){return!!this.has(t)&&delete this[t]},t.prototype.copy=function(){return new t(this)},t}(),OneEntity=extending(EntityInterface,function(){function t(){}return t.prototype.ID_PROP_NAME="id",t.prototype.setData=function(e){var i;Array.isArray(e)&&(e=e[0]);for(i in e)e.hasOwnProperty(i)&&this.hasOwnProperty(i)&&((this[i]instanceof EntitiesCollection||this[i]instanceof t)&&null!=e[i]?this[i].setData(e[i]):this[i]=e[i]);return this},t}()),EntitiesCollection=extending(Array,function(){function t(){Object.defineProperties(this,{__lookup:{value:{},writable:!0,enumerable:!1,configurable:!1},last_pushed:{value:[]}})}return t.prototype.collection_of=OneEntity,t.prototype.setData=function(t){return t=t instanceof Array?t:[t],this.push.apply(this,t),this},t.prototype.getByID=function(t){return this.__lookup.hasOwnProperty(t)?this.__lookup[t]:null},t.prototype.has=function(t){return this.getByID(t)instanceof OneEntity},t.prototype.push=function(t){var e,i=this.collection_of.prototype.ID_PROP_NAME,n=arguments;this.last_pushed.splice(0);for(var a=0,r=n[a];a<n.length;r=n[++a])(!r[i]||r[i]&&!this.has(r[i]))&&(e=r instanceof this.collection_of?r:(new this.collection_of).setData(r),this.last_pushed.push(e),this[this.length++]=e,e[i]&&(this.__lookup[e[i]]=e),this.createAdditionalLookup(e));return this.length},t.prototype.createAdditionalLookup=function(){},t.prototype.getArrayCopy=function(){return this.map(function(t){return t})},t.prototype.remove=function(t){return this.has(t)?(delete this.__lookup[t],this.splice(this.indexOf(this.getByID(t)),1)):[]},t.prototype.empty=function(){return this.last_pushed.splice(0,this.last_pushed.length),this.__lookup={},this.splice(0,this.length),this},t.prototype.sortBy=function(t,e){var i=t.split(".");this.sort(function(t,n){var a=Object.assign({},t),r=Object.assign({},n);return i.forEach(function(t){a="object"==typeof a[t]?Object.assign({},a[t]):a[t],r="object"==typeof r[t]?Object.assign({},r[t]):r[t]}),isFinite(a)&&isFinite(r)?e?a-r:r-a:a.name>r.name?e?1:-1:a.name<r.name?e?-1:1:0})},t}()),EventEmailTextsModel=extending(OneEntity,function(){function t(){OneEntity.call(this),this.payed=null,this.approved=null,this.not_approved=null,this.after_event=null}return t}()),OrganizationModel=extending(OneEntity,function(){function t(t){this.organization_id=null,this.name=null,this.short_name=null,this.description=null,this.site_url=null,this.default_address=null,this.vk_url=null,this.facebook_url=null,this.type_id=null,this.background=null,this.background_filename=null,this.logo=null,this.logo_filename=null,this.detail_info_url=null,this.email=null,this.city_id=null,this.country_id=null,this.is_private=null,t&&e(this,t)}function e(t,e){var i;for(i in e)if(e.hasOwnProperty(i))if(t.hasOwnProperty(i))t[i]=e[i];else switch(i){case"background_img_url":isBase64(e[i])&&(t.background=e[i]);break;case"img_url":isBase64(e[i])&&(t.logo=e[i]);break;case"city":t.city_id=e[i]instanceof OneCity?e[i].id:e[i];break;case"country":t.country_id=e[i].id}return t}return t.prototype.setData=function(t){return e(this,t)},t.prototype.toString=function(){return JSON.stringify(this)},t}()),TariffModel=extending(OneEntity,function(){function t(t){var e=this;this.tariff_id=null,this.name=null,this.since=null,this.till=null,this.available_additional_notifications=null,this.available_event_publications=null,this.event_publications=null,this.available_tickets_selling=null,this.available_telegram_bots=null,this.available_slack_bots=null,this.available_auditory_analytics=null,this.available_in_city=null,this.price=null,Object.defineProperties(this,{is_full:{get:function(){return 0!==e.price}},events_publication_left:{get:function(){return e.available_event_publications-e.event_publications}}}),t&&setData(this,t)}return t}()),DateModel=extending(OneEntity,function(){function t(){this.event_date="",this.start_time="",this.end_time=""}return t}()),DateModelsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=DateModel,t}()),InterestModel=extending(OneEntity,function(){function t(){this.topic_id=setDefaultValue(this.topic_id,0),this.topic_name=null,this.value=null,this.updated_at=null}return t.prototype.ID_PROP_NAME="topic_id",t}()),InterestModelsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=InterestModel,t}()),PromocodeModel=extending(OneEntity,function(){function t(){this.uuid=null,this.event_id=null,this.code=null,this.is_fixed=null,this.is_percentage=null,this.effort=null,this.use_limit=null,this.start_date=null,this.end_date=null,this.enabled=null,this.created_at=null,this.updated_at=null}return t.prototype.ID_PROP_NAME="uuid",t}()),PromocodeModelsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=PromocodeModel,t}()),RegistrationFieldModel=extending(OneEntity,function(){function t(){this.uuid=null,this.type=null,this.label=null,this.order_number=null,this.required=setDefaultValue(null,!1),this.values=[]}return t.TYPES={EMAIL:"email",FIRST_NAME:"first_name",LAST_NAME:"last_name",PHONE_NUMBER:"phone_number",ADDITIONAL_TEXT:"additional_text",CUSTOM:"custom",EXTENDED_CUSTOM:"extended_custom",SELECT:"select",SELECT_MULTI:"select_multi"},t.DEFAULT_LABEL={EMAIL:"E-mail",FIRST_NAME:"Имя",LAST_NAME:"Фамилия",PHONE_NUMBER:"Номер телефона",ADDITIONAL_TEXT:"Дополнительное текстовое поле",CUSTOM:"Дополнительное текстовое поле",EXTENDED_CUSTOM:"Дополнительное текстовое поле",SELECT:"Выбор одного варианта",SELECT_MULTI:"Выбор нескольких вариантов"},t.isCustomField=function(e){switch(e.type){case t.TYPES.EMAIL:case t.TYPES.FIRST_NAME:case t.TYPES.LAST_NAME:case t.TYPES.PHONE_NUMBER:return!1;default:case t.TYPES.CUSTOM:case t.TYPES.EXTENDED_CUSTOM:case t.TYPES.ADDITIONAL_TEXT:case t.TYPES.SELECT:case t.TYPES.SELECT_MULTI:return!0}},t.isPredefinedField=function(e){return!t.isCustomField(e)},t.prototype.setData=function(t){var e;Array.isArray(t)&&(t=t[0]);for(e in t)t.hasOwnProperty(e)&&this.hasOwnProperty(e)&&(this[e]=t[e]);return this},t}()),RegistrationFieldModelsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=RegistrationFieldModel,t.prototype.push=function(t){var e=this,i=Array.prototype.slice.call(arguments);return this.last_pushed.splice(0),i.forEach(function(t){e.last_pushed.push(e[e.length++]=t instanceof e.collection_of?t:(new e.collection_of).setData(t))}),this.length},t.prototype.sortByType=function(){var t=[RegistrationFieldModel.TYPES.LAST_NAME,RegistrationFieldModel.TYPES.FIRST_NAME,RegistrationFieldModel.TYPES.EMAIL];return this.sort(function(e,i){var n=t.indexOf(e.type),a=t.indexOf(i.type);return-1===n&&-1!==a?1:-1!==n&&-1===a?-1:n===a?0:n<a?-1:n>a?1:0}),this},t.prototype.sortByOrder=function(){return this.sort(function(t,e){return t.order_number-e.order_number}),this},t}()),RegistrationSelectFieldValue=function(){function t(t){this.value=setDefaultValue(t,null),this.uuid=null}return t}(),OneAbstractActivity=extending(OneEntity,function(){function t(){this.stat_type_id=0,this.user_id=0,this.user=new OneUser(this.user_id),this.entity="",this.type_code="",this.created_at=0}return t.TYPES={SUBSCRIBE:"subscribe",FAVE:"fave",UNSUBSCRIBE:"unsubscribe",UNFAVE:"unfave",SHARE_VK:"share_vk",SHARE_FB:"share_fb",SHARE_TW:"share_tw"},Object.freeze(t.TYPES),t.TYPES_INDEX={subscribe:"SUBSCRIBE",fave:"FAVE",unsubscribe:"UNSUBSCRIBE",unfave:"UNFAVE",share_vk:"SHARE",share_fb:"SHARE",share_tw:"SHARE"},Object.freeze(t.TYPES_INDEX),t}()),OneEventActivity=extending(OneAbstractActivity,function(){function t(){OneAbstractActivity.call(this),this.event_id=0,this.event=new OneEvent(this.event_id)}return t}()),OneOrganizationActivity=extending(OneAbstractActivity,function(){function t(){OneAbstractActivity.call(this),this.organization_id=0,this.organization=new OneOrganization(this.organization_id)}return t}()),UsersActivitiesCollection=extending(EntitiesCollection,function(){function t(t){EntitiesCollection.call(this),Object.defineProperty(this,"user_id",{value:t})}return Object.defineProperty(t.prototype,"collection_of",{value:OneAbstractActivity}),t.setDefaultData=function(t){return"string"==typeof t.fields?t.fields=t.fields.split(","):t.fields instanceof Array||(t.fields=[]),t.fields=t.fields.merge(["created_at","type_code","event","organization"]),t.order_by=setDefaultValue(t.order_by,"-created_at"),t.length=setDefaultValue(t.length,20),t},t.prototype.push=function(t){for(var e=0;e<arguments.length;e++)arguments[e]instanceof this.collection_of?this[this.length]=arguments[e]:void 0!=arguments[e].event_id?this[this.length]=(new OneEventActivity).setData(arguments[e]):void 0!=arguments[e].organization_id&&(this[this.length]=(new OneOrganizationActivity).setData(arguments[e])),this.length++;return this.length},t.fetch=function(e,i,n){return i=t.setDefaultData(i),__APP.SERVER.getData("/api/v1/users/"+e+"/actions",i,n)},t.prototype.fetch=function(t,e,i,n){var a=this,r={fields:t,offset:this.length,length:e};return i&&(r.order_by=i),this.constructor.fetch(this.user_id,r).then(function(t){return a.setData(t),(new a.constructor).setData(t)})},t}()),OneCity=extending(OneEntity,function(){function t(t){this.id=setDefaultValue(t,0),this.en_name=null,this.country_id=null,this.local_name=null,this.organization_type=new CategoriesCollection,this.timediff_seconds=null}return t}()),CitiesCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneCity,t.fetchCities=function(t,e){return __APP.SERVER.getData("/api/v1/organizations/cities",t,e)},t.prototype.getByName=function(t){for(var e=0;e<this.length;e++)if(this[e].en_name==t)return this[e];return null},t.prototype.has=function(t){return($.isNumeric(t)?this.getByID(t):this.getByName(t))instanceof OneEntity},t.prototype.fetchCities=function(e,i,n,a){var r=this;return t.fetchCities({fields:e||void 0,offset:this.length,length:i||void 0,order_by:n||void 0},function(t){r.setData(t),a&&"function"==typeof a&&a.call(r,r.last_pushed)})},t}()),OneCategory=extending(OneEntity,function(){function t(t,e){this.id=setDefaultValue(t,0),this.name=null,this.order_position=null,this.organizations=new OrganizationsCollection,this.loading=!1,t&&e&&(this.loading=!0,this.fetchCategory([],function(){this.loading=!1,$(window).trigger("fetch.OneCategory")}))}return t.fetchCategory=function(t,e,i){return __APP.SERVER.getData("/api/v1/organizations/types",$.extend({},e,{id:t}),i)},t.prototype.fetchCategory=function(t,e){var i=this;return this.constructor.fetchCategory(i.id,{fields:t},function(t){i.setData(t),e&&"function"==typeof e&&e.call(i,t[0])})},t}()),CategoriesCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneCategory,t.fetchCategories=function(t,e){return __APP.SERVER.getData("/api/v1/organizations/types",t,e)},t.prototype.fetchCategories=function(t,e,i){var n=this,a=$.extend({},t,{offset:this.length,length:e});return this.constructor.fetchCategories(a,function(t){n.setData(t),i&&"function"==typeof i&&i.call(n,t)})},t.prototype.fetchCategoriesWithOrganizations=function(t,e,i,n){var a=this,r=$.extend({},t,{offset:this.length,length:i}),o="organizations"+JSON.stringify(__APP.SERVER.validateData(e));return r.fields?Array.isArray(r.fields)||(r.fields=r.fields.split(",")):r.fields=[],r.fields.push(o),this.constructor.fetchCategories(r,function(t){a.setData(t),n&&"function"==typeof n&&n.call(a,t)})},t}()),OneDate=extending(DateModel,function(){function t(){DateModel.call(this),this.id=0,this.event_id=0,this.organization_id=0,this.events_count=0,this.favored_count=0}return t}()),DatesCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneDate,t.fetchDates=function(t,e){return __APP.SERVER.getData("/api/v1/events/dates",t,e)},t}()),OneOrder=extending(OneEntity,function(){function t(e,i){var n=this;this.uuid=setDefaultValue(i,null),this.event_id=setDefaultValue(e,0),this.number=null,this._order_content=null,this.is_canceled=null,this.status_id=null,this.status_type_code=null,this.sum=null,this.final_sum=null,this.created_at=null,this.updated_at=null,this.payed_at=null,this.canceled_at=null,this.promocode=new PromocodeModel,this.tickets=new TicketsCollection,this.registration_fields=new RegistrationFieldsCollection,this.user_id=null,this.user=new OneUser,Object.defineProperties(this,{status_name:{get:function(){return localeFromNamespace(n.status_type_code,t.EXTENDED_ORDER_STATUSES,__LOCALES.ru_RU.TEXTS.TICKET_STATUSES)}},m_created_at:{get:function(){return moment.unix(n.created_at)}},m_updated_at:{get:function(){return moment.unix(n.updated_at)}},m_payed_at:{get:function(){return moment.unix(n.payed_at)}},m_canceled_at:{get:function(){return moment.unix(n.canceled_at)}},order_content:{get:function(){return JSON.parse(n._order_content||"{}")},set:function(t){return"string"==typeof t?n._order_content=t:"object"==typeof t&&null!==t?n._order_content=JSON.stringify(t):void 0}}})}return t.prototype.ID_PROP_NAME="uuid",t.ORDER_STATUSES={WAITING_PAYMENT_LEGAL_ENTITY:"order_waiting_for_payment_legal_entity",WAITING_FOR_PAYMENT:"waiting_for_payment",IS_PENDING:"is_pending",APPROVED:"approved",PAYED:"payed",WITHOUT_PAYMENT:"without_payment",RETURNED_BY_ORGANIZATION:"returned_by_organization",RETURNED_BY_CLIENT:"returned_by_client",REJECTED:"rejected"},t.EXTENDED_ORDER_STATUSES=$.extend({PAYMENT_CANCELED_AUTO:"payment_canceled_auto",PAYMENT_CANCELED_BY_CLIENT:"payment_canceled_by_client"},t.ORDER_STATUSES),t.isGreenStatus=function(e){switch(e){case t.EXTENDED_ORDER_STATUSES.APPROVED:case t.EXTENDED_ORDER_STATUSES.PAYED:case t.EXTENDED_ORDER_STATUSES.WITHOUT_PAYMENT:return!0;default:return!1}},t.isYellowStatus=function(e){switch(e){case t.EXTENDED_ORDER_STATUSES.WAITING_PAYMENT_LEGAL_ENTITY:case t.EXTENDED_ORDER_STATUSES.WAITING_FOR_PAYMENT:case t.EXTENDED_ORDER_STATUSES.IS_PENDING:return!0;default:return!1}},t.isRedStatus=function(e){switch(e){case t.EXTENDED_ORDER_STATUSES.PAYMENT_CANCELED_BY_CLIENT:case t.EXTENDED_ORDER_STATUSES.RETURNED_BY_ORGANIZATION:case t.EXTENDED_ORDER_STATUSES.PAYMENT_CANCELED_AUTO:case t.EXTENDED_ORDER_STATUSES.RETURNED_BY_CLIENT:case t.EXTENDED_ORDER_STATUSES.REJECTED:return!0;default:return!1}},t.isDisabledStatus=function(e){switch(e){case t.EXTENDED_ORDER_STATUSES.IS_PENDING:case t.EXTENDED_ORDER_STATUSES.WAITING_PAYMENT_LEGAL_ENTITY:case t.EXTENDED_ORDER_STATUSES.WAITING_FOR_PAYMENT:case t.EXTENDED_ORDER_STATUSES.PAYMENT_CANCELED_AUTO:case t.EXTENDED_ORDER_STATUSES.PAYMENT_CANCELED_BY_CLIENT:case t.EXTENDED_ORDER_STATUSES.RETURNED_BY_ORGANIZATION:case t.EXTENDED_ORDER_STATUSES.RETURNED_BY_CLIENT:case t.EXTENDED_ORDER_STATUSES.REJECTED:return!0;default:return!1}},t.fetchOrder=function(t,e,i,n){return __APP.SERVER.getData("/api/v1/events/"+t+"/orders/"+e,{fields:i},n)},t.changeStatus=function(t,e,i,n){return __APP.SERVER.updateData("/api/v1/events/"+t+"/orders/"+e,{status:i},!1,n)},t.makeLegalEntityPayment=function(t,e,i,n){return __APP.SERVER.addData("/api/v1/events/"+t+"/orders/"+e+"/legal_entity",i,!0,n)},t.updateLegalEntityPayment=function(t,e,i,n){return __APP.SERVER.updateData("/api/v1/events/"+t+"/orders/"+e+"/legal_entity",i,!0,n)},t.fetchBitcoinData=function(t,e,i){return __APP.SERVER.addData("/api/v1/events/"+t+"/orders/"+e+"/bitcoin",null,!1,i)},t.prototype.fetchOrder=function(t,e){var i=this;return this.constructor.fetchOrder(this.event_id,this.uuid,t,function(t){i.setData(t),isFunction(e)&&e.call(i,t)})},t.prototype.changeStatus=function(e,i){var n=this;return t.changeStatus(this.event_id,this.uuid,e,function(){n.status_type_code=e,isFunction(i)&&i.call(n,n)})},t.prototype.makeLegalEntityPayment=function(e,i){var n=this;return t.makeLegalEntityPayment(this.event_id,this.uuid,e,function(){isFunction(i)&&i.call(n,n)})},t.prototype.updateLegalEntityPayment=function(e,i){var n=this;return t.updateLegalEntityPayment(this.event_id,this.uuid,e,function(){isFunction(i)&&i.call(n,n)})},t.prototype.fetchBitcoinData=function(e){var i=this;return t.fetchBitcoinData(this.event_id,this.uuid,function(t){isFunction(e)&&e.call(i,t)})},t}()),OrdersCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneOrder,t}()),AbstractEventOrdersCollection=extending(OrdersCollection,function(){function t(t){OrdersCollection.call(this),this.event_id=setDefaultValue(t,0)}return t.fetchOrders=function(t,e,i){return $.promise()},t.prototype.fetchOrders=function(t,e,i,n){var a=this;return this.constructor.fetchOrders(this.event_id,{fields:t||void 0,offset:this.length,length:e||void 0,order_by:i||void 0},function(t){a.setData(t),isFunction(n)&&n.call(a,a.last_pushed)})},t.prototype.fetchAllOrders=function(t,e,i){var n=this;return this.empty(),this.constructor.fetchOrders(this.event_id,{fields:t||void 0,offset:0,length:ServerConnection.MAX_ENTITIES_LENGTH,order_by:e||void 0},function(t){n.setData(t),isFunction(i)&&i.call(n,n.last_pushed)}).then(function(){return n.last_pushed})},t}()),EventAllOrdersCollection=extending(AbstractEventOrdersCollection,function(){function t(t){AbstractEventOrdersCollection.call(this,t)}return t.fetchOrders=function(t,e,i){return __APP.SERVER.getData("/api/v1/statistics/events/"+t+"/orders",e,i)},t.prototype.export=function(t){return(new ServerExports).eventOrders(this.event_id,t)},t}()),EventMyOrdersCollection=extending(AbstractEventOrdersCollection,function(){function t(t){AbstractEventOrdersCollection.call(this,t)}return t.fetchOrders=function(t,e,i){return __APP.SERVER.getData("/api/v1/events/"+t+"/orders",e,i)},t}()),OneTag=extending(OneEntity,function(){function t(t,e){this.id=t||0,this.name="",t&&e&&(this.loading=!0,this.fetchTag(function(){this.loading=!1,$(window).trigger("fetch.OneTag")}))}return t.fetchTag=function(t,e){return __APP.SERVER.getData("/api/v1/tags/"+t,{},e)},t.prototype.fetchTag=function(t){var e=this;return this.constructor.fetchTag(e.id,function(i){e.setData(i[0]),t&&"function"==typeof t&&t.call(e,i[0])})},t}()),TagsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneTag,t.fetchTags=function(t,e){return __APP.SERVER.getData("/api/v1/tags/",t,e)},t.prototype.fetchTags=function(t,e){var i=this;return this.constructor.fetchTags(t,function(t){i.setData(t),e&&"function"==typeof e&&e.call(i,t)})},t}()),OneTicket=extending(OneEntity,function(){function t(t,e){this.uuid=setDefaultValue(e,0),this.event_id=setDefaultValue(t,0),this.user_id=null,this.type_code=null,this.ticket_type_uuid=null,this.ticket_order_uuid=null,this.status=null,this.checkout=null,this.price=null,this.number=null,this.ticket_type=new OneTicketType,this.order=new OneOrder,this.user=new OneUser,this.created_at=null}return t.prototype.ID_PROP_NAME="uuid",t.fetchTicket=function(t,e,i,n){return __APP.SERVER.getData("/api/v1/events/"+t+"/tickets/"+e,{fields:i},n)},t.check=function(t,e,i){return __APP.SERVER.updateData("/api/v1/statistics/events/"+t+"/tickets/"+e,{checkout:!0},!1,i)},t.uncheck=function(t,e,i){
return __APP.SERVER.updateData("/api/v1/statistics/events/"+t+"/tickets/"+e,{checkout:!1},!1,i)},t.exportTicket=function(t,e){return(new ServerExports).eventTicket(t,e)},t.openTicketPage=function(t){return __APP.changeState("/ticket/{ticket_uuid}".format({ticket_uuid:t}))},t.prototype.fetchTicket=function(e,i){var n=this;return t.fetchTicket(this.event_id,this.uuid,e,function(t){n.setData(t),i&&"function"==typeof i&&i.call(n,t)})},t.prototype.check=function(e){var i=this;return t.check(this.event_id,this.uuid,function(){i.checkout=!0,e&&"function"==typeof e&&e.call(i,i)})},t.prototype.uncheck=function(e){var i=this;return t.uncheck(this.event_id,this.uuid,function(){i.checkout=!1,e&&"function"==typeof e&&e.call(i,i)})},t.prototype.export=function(){return t.exportTicket(this.event_id,this.uuid)},t.prototype.openPage=function(){return t.openTicketPage(this.uuid)},t}()),TicketsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneTicket,t}()),AbstractEventTicketsCollection=extending(TicketsCollection,function(){function t(t){TicketsCollection.call(this),Object.defineProperty(this,"event_id",{value:setDefaultValue(t,-1)})}return t.fetchTickets=function(t,e,i){return $.Deferred().promise()},t.prototype.fetchTickets=function(t,e,i,n){var a=this;return this.constructor.fetchTickets(this.event_id,{fields:t||void 0,offset:this.length,length:e||void 0,order_by:i||void 0},function(t){a.setData(t),isFunction(n)&&n.call(a,a.last_pushed)})},t}()),OneTicketType=extending(OneEntity,function(){function t(t,e){var i=this;this.uuid=setDefaultValue(e,null),this.event_id=setDefaultValue(t,null),this.type_code=null,this.name=null,this.comment=null,this.price=null,this.is_selling=null,this.sell_start_date=null,this.sell_end_date=null,this.start_after_ticket_type_code=null,this.amount=null,this.min_count_per_user=null,this.max_count_per_user=null,this.promocode=null,this.promocode_effort=null,Object.defineProperties(this,{formatted_sell_start_date:{get:function(){return i.sell_start_date?moment.unix(i.sell_start_date).format(__LOCALE.DATE.DATE_FORMAT):""}},formatted_sell_end_date:{get:function(){return i.sell_end_date?moment.unix(i.sell_end_date).format(__LOCALE.DATE.DATE_FORMAT):""}}})}return t.prototype.ID_PROP_NAME="uuid",t.fetchTicketType=function(t,e,i,n){return __APP.SERVER.getData("/api/v1/events/"+t+"/ticket_types/"+e,{fields:i},n)},t.prototype.fetchOrder=function(e,i){var n=this;return t.fetchTicketType(this.event_id,this.uuid,e,function(t){n.setData(t),isFunction(i)&&i.call(n,t)})},t}()),TicketTypesCollection=extending(EntitiesCollection,function(){function t(t){EntitiesCollection.call(this),this.event_id=setDefaultValue(t,0)}return t.prototype.collection_of=OneTicketType,t.fetchTicketTypes=function(t,e,i){return __APP.SERVER.getData("/api/v1/events/"+t+"/ticket_types",e,i)},t.prototype.fetchTicketTypes=function(e,i,n,a){var r=this;return t.fetchTicketTypes(this.event_id,{fields:e||void 0,offset:this.length,length:i||void 0,order_by:n||void 0},function(t){r.setData(t),a&&"function"==typeof a&&a.call(r,r.last_pushed)})},t}()),OneOrganization=extending(OneEntity,function(){function t(t,e){var i=this;this.id=t||0,this.name=null,this.short_name=null,this.description=null,this.img_url=null,this.img_small_url=null,this.img_medium_url=null,this.background_img_url=null,this.background_small_img_url=null,this.background_medium_img_url=null,this.type_id=null,this.type_name=null,this.site_url=null,this.default_address=null,this.events=new EventsCollection,this.subscription_id=null,this.is_subscribed=null,this.subscribed_count=null,this.subscribed=new UsersCollection,this.privileges=[],this.is_private=null,this.brand_color=null,this.tariff=new TariffModel,this.city=new OneCity,this.country=null,this.email=null,this.staff=new UsersCollection,this.status=null,this.is_new=null,this.new_events_count=null,this.actual_events_count=null,this.vk_url=null,this.facebook_url=null,Object.defineProperties(this,{role:{get:function(){return OneUser.recognizeRole(i.privileges)}},admins:{get:function(){return i.staff.getSpecificStaff(OneUser.ROLE.ADMIN)}},moderators:{get:function(){return i.staff.getSpecificStaff(OneUser.ROLE.MODERATOR)}},logo_large_url:{get:function(){return i.img_url},set:function(t){return i.img_url=t}},logo_medium_url:{get:function(){return i.img_medium_url},set:function(t){return i.img_medium_url=t}},logo_small_url:{get:function(){return i.img_small_url},set:function(t){return i.img_small_url=t}}}),this.loading=!1,t&&e&&(this.loading=!0,this.fetchOrganization([],function(){this.loading=!1,$(window).trigger("fetch.OneOrganization")}))}return t.fetchOrganization=function(t,e,i){return __APP.SERVER.getData("/api/v1/organizations/"+t,{fields:e},i)},t.createOrganization=function(t,e,i){return __APP.SERVER.addData("/api/v1/organizations/",t,!0,e,i)},t.updateOrganization=function(t,e,i,n){return __APP.SERVER.updateData("/api/v1/organizations/"+t,e,!0,i,n)},t.addStaff=function(t,e,i,n){return __APP.SERVER.addData("/api/v1/organizations/"+t+"/staff",{user_id:e,role:i},!1,n)},t.removeStaff=function(t,e,i,n){return __APP.SERVER.deleteData("/api/v1/organizations/"+t+"/staff",{user_id:e,role:i},n)},t.subscribeOrganization=function(t,e){return __APP.SERVER.addData("/api/v1/organizations/"+t+"/subscriptions",{},!1,e)},t.unsubscribeOrganization=function(t,e){return __APP.SERVER.deleteData("/api/v1/organizations/"+t+"/subscriptions",{},e)},t.prototype.fetchOrganization=function(e,i){var n=this;return t.fetchOrganization(n.id,e,function(t){n.setData(t),isFunction(i)&&i.call(n,n)})},t.prototype.createOrganization=function(e,i,n){var a=this;return t.createOrganization(e,function(t){a.setData(e),a.id=t.organization_id,isFunction(i)&&i.call(a,a)},n)},t.prototype.updateOrganization=function(e,i,n){var a=this;return t.updateOrganization(a.id,e,function(t){a.setData(e),isFunction(i)&&i.call(a,a)},n)},t.prototype.subscribe=function(t){var e=this;return this.constructor.subscribeOrganization(this.id,function(i){this.is_subscribed=!0,this.subscribed_count++,isFunction(t)&&t.call(e,i)})},t.prototype.unsubscribe=function(t){var e=this;return this.constructor.unsubscribeOrganization(this.id,function(i){this.is_subscribed=!1,this.subscribed_count=this.subscribed_count?this.subscribed_count-1:this.subscribed_count,isFunction(t)&&t.call(e,i)})},t.prototype.addStaff=function(e,i,n){var a=this,r=new OneUser(e);return __APP.SERVER.multipleAjax(t.addStaff(this.id,e,i),r.fetchUser(new Fields)).done(function(t,e){a.staff.setData(r),isFunction(n)&&n.call(a,r)}).promise()},t.prototype.removeStaff=function(e,i,n){var a=this;return t.removeStaff(this.id,e,i,function(){isFunction(n)&&n.call(a,a.staff.remove(e))})},t}()),OrganizationsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneOrganization,t.fetchSubscribedOrganizations=function(t,e){return __APP.SERVER.getData("/api/v1/organizations/subscriptions",t,e)},t.fetchMyOrganizations=function(t,e,i){return t=Array.isArray(t)?t.join(","):t,__APP.SERVER.getData("/api/v1/organizations/",$.extend({},e,{roles:t}),i)},t.fetchRecommendations=function(t,e){return __APP.SERVER.getData("/api/v1/organizations/recommendations",t,e)},t.prototype.fetchSubscribedOrganizations=function(t,e,i,n){var a=this,r={fields:t,offset:this.length,length:e,order_by:i||void 0};return this.constructor.fetchSubscribedOrganizations(r,function(t){a.setData(t),n&&"function"==typeof n&&n.call(a,t)})},t.prototype.fetchMyOrganizations=function(e,i,n,a,r){var o=this,s={fields:i,length:n,offset:this.length,order_by:a||void 0};return t.fetchMyOrganizations(e,s,function(t){o.setData(t),isFunction(r)&&r.call(o,o.last_pushed)})},t}()),OneUser=extending(OneEntity,function(){function t(t){var e=this;this.id=setDefaultValue(t,0),this.first_name=null,this.last_name=null,this.middle_name=null,this.gender=null,this.email=null,this.avatar_url=null,this.blurred_image_url=null,this.link=null,this.type=null,this.role=null,this.is_friend=null,this.is_editor=null,this.accounts=[],this.accounts_links={},this.vk_uid=null,this.google_uid=null,this.facebook_uid=null,this.subscriptions=new OrganizationsCollection,this.favored=new FavoredEventsCollection,this.actions=new UsersActivitiesCollection(t),this.interests=new InterestModelsCollection,Object.defineProperty(this,"full_name",{enumerable:!0,get:function(){return e.first_name+" "+e.last_name}})}return t.prototype.subscriptions_fields=["img_small_url","subscribed_count","new_events_count","actual_events_count"],Object.freeze(t.prototype.subscriptions_fields),t.ROLE={UNAUTH:"unauth",USER:"user",MODERATOR:"moderator",ADMIN:"admin"},Object.freeze(t.ROLE),t.GENDER={MALE:"male",FEMALE:"female",NEUTRAL:"neutral"},Object.freeze(t.GENDER),t.ACCOUNTS={VK:"vk",GOOGLE:"google",FACEBOOK:"facebook"},Object.freeze(t.ACCOUNTS),t.fetchUser=function(t,e,i){return __APP.SERVER.getData("/api/v1/users/"+t,{fields:e},i)},t.fetchFavored=function(t,e,i){return __APP.SERVER.getData("/api/v1/users/"+t+"/favorites",e,i)},t.fetchSubscriptions=function(t,e,i){return __APP.SERVER.getData("/api/v1/users/"+t+"/subscriptions",e,i)},t.fetchUserActivity=function(t,e,i){return UsersActivitiesCollection.fetch(t,{fields:e},i)},t.recognizeRole=function(e){var i=t.ROLE.USER;return e.forEach(function(e){1!=e.role_id&&e.name!=t.ROLE.ADMIN||(i=t.ROLE.ADMIN),2!=e.role_id&&e.name!=t.ROLE.MODERATOR||i===t.ROLE.ADMIN||(i=t.ROLE.MODERATOR)}),i||t.ROLE.UNAUTH},t.prototype.fetchUser=function(e,i){var n=this;return e=setDefaultValue(e,[]),t.fetchUser(n.id,e,function(t){t=t instanceof Array?t[0]:t,n.setData(t),i&&"function"==typeof i&&i.call(n,t)})},t.prototype.fetchFavored=function(e,i){var n=this;return e.offset=this.favored.length,t.fetchFavored(n.id,e).done(function(t){n.favored.setData(t),i&&"function"==typeof i&&i.call(n,n.favored.last_pushed)}).promise()},t.prototype.fetchSubscriptions=function(e,i){var n=this;return e.offset=this.subscriptions.length,t.fetchSubscriptions(n.id,e).done(function(t){n.subscriptions.setData(t),i&&"function"==typeof i&&i.call(n,n.subscriptions.last_pushed)}).promise()},t}()),UsersCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneUser,t.getSpecificStaff=function(t,e){return e.filter(function(e){return e.role===t})},t.fetchUsers=function(t,e){return __APP.SERVER.getData("/api/v1/users/",t,e)},t.fetchEventFavorites=function(t,e,i){return __APP.SERVER.getData("/api/v1/events/"+t,{fields:"favored".appendAjaxData(__APP.SERVER.validateData(e))},function(t){e.length&&e.offset&&(e.offset+=e.length),i&&"function"==typeof i&&i(t[0].favored)})},t.fetchOrganizationSubscribers=function(t,e,i){return __APP.SERVER.getData("/api/v1/organizations/"+t,{fields:"subscribed".appendAjaxData(__APP.SERVER.validateData(e))},function(t){e.length&&e.offset&&(e.offset+=e.length),i&&"function"==typeof i&&i(t[0].subscribed)})},t.fetchOrganizationStaff=function(t,e,i){return __APP.SERVER.getData("/api/v1/organizations/"+t+"/staff/",e,i)},t.prototype.getSpecificStaff=function(e){return t.getSpecificStaff(e,this)},t.prototype.fetchUsers=function(e,i,n){var a=this,r=$.extend(e,{offset:this.length,length:i});return t.fetchUsers(r,function(t){a.setData(t),n&&"function"==typeof n&&n.call(a,t)})},t.prototype.fetchEventFavorites=function(e,i,n,a){var r=this,o=$.extend({},n,{offset:this.length,length:i});return t.fetchEventFavorites(e,o,function(t){r.setData(t),a&&"function"==typeof a&&a.call(r,t)})},t.prototype.fetchOrganizationSubscribers=function(t,e,i,n){var a=this,r=$.extend({},i,{offset:this.length,length:e});return this.constructor.fetchOrganizationSubscribers(t,r,function(t){a.setData(t),n&&"function"==typeof n&&n.call(a,t)})},t.prototype.fetchOrganizationStaff=function(e,i,n,a){var r=this,o=$.extend({},n,{offset:this.length,length:i});return t.fetchOrganizationStaff(e,o,function(t){r.setData(t),a&&"function"==typeof a&&a.call(r,t)})},t}()),OneNotification=extending(OneEntity,function(){function t(){var e=this;this.uuid=null,this.event_id=null,this.notification_time=null,this.notification_type=null,this.sent_time=null,this.done=null,this.created_at=null,this.updated_at=null,Object.defineProperty(this,t.prototype.ID_PROP_NAME,{get:function(){return e.uuid||e.notification_type}})}return t.prototype.ID_PROP_NAME="guid",t.NOTIFICATIN_TYPES={NOW:"notification-now",CANCELED:"notification-event-canceled",CHANGED_DATES:"notification-event-changed-dates",CHANGED_LOCATION:"notification-event-changed-location",CHANGED_PRICE:"notification-event-changed-price",CHANGED_REGISTRATION:"notification-event-changed-registration",ONE_DAY_REGISTRATION_CLOSE:"notification-one-day-registration-close",BEFORE_THREE_HOURS:"notification-before-three-hours",BEFORE_DAY:"notification-before-day",BEFORE_THREE_DAYS:"notification-before-three-days",BEFORE_WEEK:"notification-before-week",BEFORE_QUARTER_OF_HOUR:"notification-before-quarter-of-hour",CUSTOM:"notification-custom",REGISTRATION_APPROVED:"notification-registration-approved",REGISTRATION_CHECKED_OUT:"notification-registration-checked-out",REGISTRATION_NOT_CHECKED_OUT:"notification-registration-not-checked-out",REGISTRATION_NOT_APPROVED:"notification-registration-not-approved",USERS:"users-notification",ADDITIONAL_FOR_ORGANIZATION:"notification-additional-for-organization"},t}()),NotificationsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneNotification,t}()),OneEvent=extending(OneEntity,function(){function t(t,e){var i=this,n=["organization_id","organization_short_name","organization_logo_large_url","organization_logo_medium_url","organization_logo_small_url"];this.id=t||0,this.title=null,this.description=null,this.location=null,this.latitude=null,this.longitude=null,this.is_online=null,this.detail_info_url=null,this.orders=new AbstractEventOrdersCollection(t),this.orders_count=null,this.ticketing_locally=null,this.ticketing_available=null,this.tickets=new AbstractEventTicketsCollection(t),this.ticket_types=new TicketTypesCollection(t),this.booking_time=null,this.registration_locally=null,this.registration_available=null,this.registration_required=null,this.registration_limit_count=null,this.registration_till=null,this.registration_approve_status=null,this.registration_approvement_required=null,this.is_registered=null,this.registered_count=null,this.registered_users=new UsersCollection,this.registration_fields=new RegistrationFieldModelsCollection,this.organization=new OneOrganization,this.image_vertical_url=null,this.image_horizontal_url=null,this.image_horizontal_large_url=null,this.image_horizontal_medium_url=null,this.image_horizontal_small_url=null,this.is_free=null,this.min_price=null,this.dates=new DatesCollection,this.is_same_time=null,this.first_event_date=null,this.last_event_date=null,this.nearest_event_date=null,this.tags=new TagsCollection,this.promocodes=new PromocodeModelsCollection,this.accept_bitcoins=null,this.notifications=new NotificationsCollection,this.favored=new UsersCollection,this.favored_users_count=null,this.favored_friends_count=null,this.is_favorite=null,this.public_at=null,this.canceled=null,this.can_edit=null,this.actuality=null,this.vk_post_link=null,this.email_texts=new EventEmailTextsModel,this.creator_id=null,this.created_at=null,this.updated_at=null,n.forEach(function(t){Object.defineProperty(i,t,{enumerable:!0,get:function(){return i.organization[t.replace("organization_","")]},set:function(e){return i.organization[t.replace("organization_","")]=e}})}),this.loading=!1,t&&e&&(this.loading=!0,this.fetchEvent(void 0,function(){this.loading=!1,$(window).trigger("fetch.OneEvent")}))}return t.STATUS={CANCEL:"cancel",BRING_BACK:"bring_back",HIDE:"hide",SHOW:"show"},t.fetchEvent=function(t,e,i){return __APP.SERVER.getData("/api/v1/events/"+t,{fields:new Fields(e)},i)},t.createEvent=function(t,e,i){return __APP.SERVER.addData("/api/v1/events/",t,!0,e,i)},t.updateEvent=function(t,e,i,n){return __APP.SERVER.updateData("/api/v1/events/"+t,e,!0,i,n)},t.changeEventStatus=function(e,i,n){var a={};return i=Array.isArray(i)?i:[i],i.forEach(function(e){switch(e){case t.STATUS.CANCEL:a.canceled=!0;break;case t.STATUS.BRING_BACK:a.canceled=!1;break;case t.STATUS.HIDE:a.hidden=!0;break;case t.STATUS.SHOW:a.hidden=!1}}),__APP.SERVER.updateData("/api/v1/events/"+e+"/status",a,!1,function(){n&&"function"==typeof n&&n.call(self,a)})},t.addFavored=function(t,e){return __APP.SERVER.addData("/api/v1/events/"+t+"/favorites",{},!1,e)},t.deleteFavored=function(t,e){return __APP.SERVER.deleteData("/api/v1/events/"+t+"/favorites",{},e)},t.addEventNotification=function(t,e,i){return __APP.SERVER.addData("/api/v1/events/"+t+"/notifications",{notification_type:e},!1,i)},t.deleteEventNotification=function(t,e,i){return __APP.SERVER.deleteData("/api/v1/events/"+t+"/notifications/"+e,{},i)},t.registerToEvent=function(t,e,i){return __APP.SERVER.addData("/api/v1/events/"+t+"/orders",{registration_fields:e,tickets:[{uuid:null,count:1}]},!0,i)},t.buyTickets=function(t,e,i,n){return __APP.SERVER.addData("/api/v1/events/"+t+"/orders",{tickets:e,promocode:i||null},!0,n)},t.makeOrder=function(e,i,n,a,r){return empty(i)?t.registerToEvent(e,n,r):empty(n)?t.buyTickets(e,i,a,r):__APP.SERVER.addData("/api/v1/events/"+e+"/orders",{registration_fields:n,tickets:i,promocode:a||null},!0,r)},t.prototype.fetchEvent=function(e,i){var n=this;return t.fetchEvent(n.id,e,function(t){n.setData(t[0]),isFunction(i)&&i.call(n,t[0])})},t.prototype.createEvent=function(t,e,i){var n=this;return this.constructor.createEvent(t,function(i){n.setData(t),n.id=i.event_id,isFunction(e)&&e.call(n,t)},i)},t.prototype.updateEvent=function(t,e,i){var n=this;return this.constructor.updateEvent(n.id,t,function(i){n.setData(t),isFunction(e)&&e.call(n,t)},i)},t.prototype.changeEventStatus=function(t,e){var i=this;return this.constructor.changeEventStatus(i.id,t,function(t){i.setData(t),isFunction(e)&&e.call(i,t)})},t.prototype.addNotification=function(t,e){return this.constructor.addEventNotification(this.id,t,e)},t.prototype.deleteNotification=function(t,e){return this.constructor.deleteEventNotification(this.id,t,e)},t.prototype.registerToEvent=function(t,e){var i=this;return this.constructor.registerToEvent(this.id,t,function(t){i.is_registered=!0,isFunction(e)&&e.call(i,t)})},t.prototype.buyTickets=function(t,e,i){return this.constructor.buyTickets(this.id,t,e,i)},t.prototype.makeOrder=function(t,e,i,n){var a=this;return this.constructor.makeOrder(this.id,t,e,i,n).then(function(t){var e=new OneOrder(a.id);return e.setData($.extend({registration_fields:t.registration_fields,tickets:t.tickets,user_id:__APP.USER.id,user:__APP.USER},t.order)),a.orders.push(e),{sum:t.sum,order:e,send_data:t}})},t}()),EventsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneEvent,t.KIND={MY:"my",FAVORED:"favored",RECOMMENDED:"recommended"},t.fetchEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/",t,e)},t.fetchMyEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/my",t,e)},t.fetchFavoredEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/favorites",t,e)},t.fetchRecommendedEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/recommendations",t,e)},t.fetchOrganizationsEvents=function(t,e,i){return __APP.SERVER.getData("/api/v1/events/",$.extend({},e,{organization_id:t}),i)},t.prototype.fetchEvents=function(e,i,n,a){var r=this,o="fetchEvents",s=$.extend({},i,{offset:this.length,length:n});switch(e){default:o="fetchEvents";break;case t.KIND.MY:o="fetchMyEvents";break;case t.KIND.FAVORED:o="fetchFavoredEvents";break;case t.KIND.RECOMMENDED:o="fetchRecommendedEvents"}return this.constructor[o](s,function(t){r.setData(t),isFunction(a)&&a.call(r,r.last_pushed)})},t.prototype.fetchFeed=function(t,e,i,n){var a=this,r=$.extend({fields:t,offset:this.length,length:e},i);return this.constructor.fetchEvents(r,function(t){a.setData(t),isFunction(n)&&n.call(a,a.last_pushed)})},t.prototype.fetchOrganizationsEvents=function(t,e,i,n){var a=this,r=$.extend({},e,{offset:this.length,length:i});return this.constructor.fetchOrganizationsEvents(t,r,function(t){a.setData(t),n&&"function"==typeof n&&n.call(a,a.last_pushed)})},t.prototype.fetchOrganizationsFeed=function(t,e,i,n){var a=this,r={fields:e,offset:this.length,length:i};return this.constructor.fetchOrganizationsEvents(t,r,function(t){a.setData(t),n&&"function"==typeof n&&n.call(a,a.last_pushed)})},t}()),ActualEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchEvents=function(t,e){return t.fields=t.fields?"string"==typeof t.fields?t.fields.split(","):t.fields:[],t.fields.push("actuality"),t.future=!0,t.order_by="-actuality",EventsCollection.fetchMyEvents(t,e)},t}()),CanceledEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchOrganizationsEvents=function(t,e,i){return e.fields=e.fields?"string"==typeof e.fields?e.fields.split(","):e.fields:[],e.fields.push("updated_at"),e.is_canceled=!0,e.order_by="-updated_at",EventsCollection.fetchOrganizationsEvents(t,e,i)},t}()),DayEventsCollection=extending(EventsCollection,function(){function t(t){if(!t)throw Error("DayEventsCollection must have date parameter");EventsCollection.call(this),this.date=t}return t.fetchEvents=function(t,e,i){return e.date=t,EventsCollection.fetchMyEvents(e,i)},t.prototype.fetchFeed=function(t,e,i,n){var a=this,r=$.extend({fields:t,offset:this.length,length:e},i);return this.constructor.fetchEvents(this.date,r,function(t){a.setData(t),isFunction(n)&&n.call(a,t)})},t}()),DelayedEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchOrganizationsEvents=function(t,e,i){return e.fields=e.fields?"string"==typeof e.fields?e.fields.split(","):e.fields:[],e.fields.push("public_at"),e.is_delayed=!0,e.is_canceled=!1,e.order_by="public_at",EventsCollection.fetchOrganizationsEvents(t,e,i)},t}()),OneEventWithStatistics=extending(OneEvent,function(){function t(t,e){OneEvent.apply(this,arguments),this.view=0,this.view_detail=0,this.fave=0,this.unfave=0,this.open_site=0,this.notifications_sent=0}return t}()),EventsWithStatisticsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.prototype.collection_of=OneEventWithStatistics,t.fetchEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/",t,e)},t.fetchMyEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/my",t,e)},t.fetchFavoredEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/favorites",t,e)},t.fetchRecommendedEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/recommendations",t,e)},t.fetchOrganizationsEvents=function(t,e,i){return e.statistics=!0,__APP.SERVER.getData("/api/v1/events/",$.extend({},e,{organization_id:t}),i)},t}()),FavoredEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchEvents=function(t,e){return t.future=!0,EventsCollection.fetchFavoredEvents(t,e)},t}()),FriendsEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchEvents=function(t,e){return t.fields=t.fields?"string"==typeof t.fields?t.fields.split(","):t.fields:[],t.fields.push("favored_friends_count"),t.future=!0,t.order_by="-favored_friends_count",EventsCollection.fetchMyEvents(t,e)},t}()),FutureEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchOrganizationsEvents=function(t,e,i){return e.future=!0,e.order_by="nearest_event_date",EventsCollection.fetchOrganizationsEvents(t,e,i)},t}()),PastEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchOrganizationsEvents=function(t,e,i){return e.till=moment().format(__C.DATE_FORMAT),e.order_by="-last_event_date",EventsCollection.fetchOrganizationsEvents(t,e,i)},t}()),RecommendedEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchEvents=function(t,e){return t.future=!0,t.order_by="-rating",EventsCollection.fetchRecommendedEvents(t,e)},t}()),TimelineEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchEvents=function(t,e){return t.future=!0,EventsCollection.fetchMyEvents(t,e)},t}()),OneExtendedOrder=extending(OneOrder,function(){function t(t,e){OneOrder.call(this,t,e),this.event=new OneEvent(this.event_id)}return t.convertToExtended=function(t,e){var i;return t.orders&&t.orders instanceof Array?(i=t.orders.reduce(function(t,i){return empty(t)&&i.uuid===e?i:t},{}),i.event=t):i=null,i},t.fetchOrder=function(e,i,n,a){return n=Fields.parseFields(n),OneEvent.fetchEvent(e,new Fields($.extend(!0,{},n.pull("event"),{orders:{filters:"uuid="+i,fields:n}})),function(e){isFunction(a)&&a(t.convertToExtended(e[0],i))}).then(function(e){return t.convertToExtended(e[0],i)})},t}()),ExtendedOrdersCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this),Object.defineProperties(this,{__events_length:{writable:!0,value:0}})}return t.prototype.collection_of=OneExtendedOrder,t.convertToExtendedOrders=function(t){return t.reduce(function(t,e){return t.concat(e.orders?e.orders.reduce(function(t,i){return i.event=e,t.push(i),t},[]):[])},[])},t.convertFieldsToAjaxData=function(t){t=t?Fields.parseFields(t):new Fields;var e,i={};return t.has("event")&&(i=t.pull("event")),e=new Fields({orders:{fields:t}}),i.fields?(i.fields=Fields.parseFields(i.fields),i.fields.push(e)):i.fields=e,i},t}()),MyOrdersCollection=extending(ExtendedOrdersCollection,function(){function t(){ExtendedOrdersCollection.call(this)}return t.fetchOrders=function(t,e){return t=t||{},EventsCollection.fetchEvents($.extend({},ExtendedOrdersCollection.convertFieldsToAjaxData(t.fields),{length:t.length,offset:t.offset,registered:!0}),function(t){isFunction(e)&&e(ExtendedOrdersCollection.convertToExtendedOrders(t))}).then(ExtendedOrdersCollection.convertToExtendedOrders)},t.prototype.fetchOrders=function(e,i,n,a){var r=this,o=this.__events_length;return this.__events_length+=i||20,t.fetchOrders({fields:e||void 0,offset:o,length:i||20,order_by:n||void 0},function(t){r.setData(t),isFunction(a)&&a.call(r,r.last_pushed)})},t.prototype.fetchAllOrders=function(e,i,n){var a=this;return this.__events_length=ServerConnection.MAX_ENTITIES_LENGTH,t.fetchOrders({fields:e||void 0,offset:0,length:ServerConnection.MAX_ENTITIES_LENGTH,order_by:i||void 0},function(t){a.setData(t),isFunction(n)&&n.call(a,a.last_pushed)})},t}()),Statistics=function(){function t(){this.id=0,this.entity=null,this.view=[],this.fave=[],this.unfave=[],this.notifications_sent=[],this.dynamics={view:[],fave:[]}}return t.prototype.setData=function(t){return $.extend(!0,this,t instanceof Array?t[0]:t)},t.SCALES={MINUTE:"minute",HOUR:"hour",DAY:"day",WEEK:"week",MONTH:"month",YEAR:"year",OVERALL:"overall"},t.ENTITIES={EVENT:"events",ORGANIZATION:"organizations"},t.fetchStatistics=function(t,e,i,n,a,r,o){var s={scale:i,fields:[]};switch(a instanceof Array?s.fields=s.fields.concat(a):$.each(a,function(t,e){Object.getOwnPropertyNames(e).length?s.fields.push(t+JSON.stringify(e)):s.fields.push(t)}),r&&s.fields.push("dynamics"+JSON.stringify(__APP.SERVER.validateData(r))),typeof n){case"string":n&&(s.since=n);break;case"object":n.since&&(s.since=n.since),n.till&&(s.till=n.till);break;default:case"boolean":}return __APP.SERVER.getData("/api/v1/statistics/"+t+"/"+e,s,o)},t.prototype.fetchStatistics=function(e,i,n,a,r){var o=this;return t.fetchStatistics(this.entity,this.id,e,i,n,a,function(t){o.setData(t),r&&"function"==typeof r&&r.call(o,t)})},t}(),EventStatistics=extending(Statistics,function(){function t(t){Statistics.apply(this),this.id=t,this.entity=Statistics.ENTITIES.EVENT,this.open_site=[],this.view_detail=[],this.open_conversion=[],this.fave_conversion=[],this.dynamics.fave_conversion=[],this.dynamics.open_conversion=[]}return t}()),OrganizationsStatistics=extending(Statistics,function(){function t(t){Statistics.apply(this),this.id=t,this.entity=Statistics.ENTITIES.ORGANIZATION,this.subscribe=[],this.unsubscribe=[],this.conversion=[],this.audience={},this.dynamics.subscribe=[],this.dynamics.conversion=[]}return t}()),OnePromocode=extending(PromocodeModel,function(){function t(t,e){PromocodeModel.call(this),this.event_id=setDefaultValue(t,null),this.uuid=setDefaultValue(e,null)}return t.fetchPromocodebyCodeName=function(t,e,i,n,a){return __APP.SERVER.getData("/api/v1/events/"+t+"/promocodes",{code:e,fields:i},n,a)},t.prototype.fetchPromocodebyCodeName=function(e,i,n,a){var r=this;return t.fetchPromocodebyCodeName(this.event_id,e,i,function(t){r.setData(t),isFunction(n)&&n.call(r,t)},a)},t}()),EventAllTicketsCollection=extending(AbstractEventTicketsCollection,function(){function t(t){AbstractEventTicketsCollection.call(this,t)}return t.fetchTickets=function(t,e,i){return e=e||{},__APP.SERVER.getData("/api/v1/statistics/events/"+t+"/tickets",e,i)},t.prototype.export=function(t){return(new ServerExports).eventTickets(this.event_id,t)},t}()),EventMyTicketsCollection=extending(AbstractEventTicketsCollection,function(){function t(t){AbstractEventTicketsCollection.call(this,t)}return t.fetchTickets=function(t,e,i){return __APP.SERVER.getData("/api/v1/events/"+t+"/tickets",e,i)},t}()),SearchEventTicketsCollection=extending(EventAllTicketsCollection,function(){function t(t,e){EventAllTicketsCollection.call(this,e),this.query_string=t}return t.fetchTickets=function(t,e,i,n){return i=i||{},$.isNumeric(t)?i.number=t:i.user_name=t,EventAllTicketsCollection.fetchTickets(e,i,n)},t.prototype.fetchTickets=function(e,i,n,a){var r=this;return t.fetchTickets(this.query_string,this.event_id,{fields:e||void 0,offset:this.length,length:i||void 0,order_by:n||void 0},function(t){r.setData(t),isFunction(a)&&a.call(r,r.last_pushed)})},t}()),SearchResults=extending(OneEntity,function(){function t(t){this.query_string=t,this.events=new EventsCollection,this.organizations=new OrganizationsCollection}return t.sanitizeQueryVar=function(t){var e={};return 0===t.indexOf("#")?e.tags=t.replace("#",""):e.q=t,e},t.fetchEventsAndOrganizations=function(e,i,n){return __APP.SERVER.getData("/api/v1/search/",$.extend({},t.sanitizeQueryVar(e),i),n)},t.prototype.fetchEvents=function(e,i){var n=this,a={fields:"events"+JSON.stringify($.extend({},__APP.SERVER.validateData(e),{offset:this.events.length}))};return t.fetchEventsAndOrganizations(n.query_string,a,function(t){n.setData(t),i&&"function"==typeof i&&i.call(n,t.events)})},t.prototype.fetchOrganizations=function(e,i){var n=this,a={fields:"organizations"+JSON.stringify($.extend({},__APP.SERVER.validateData(e),{offset:this.organizations.length}))};return t.fetchEventsAndOrganizations(n.query_string,a,function(t){n.setData(t),i&&"function"==typeof i&&i.call(n,t.organizations)})},t.prototype.fetchEventsAndOrganizations=function(e,i,n){var a=this,r={fields:new Fields("search_score"),order:"-search_score"};return e&&r.fields.push({events:$.extend({},__APP.SERVER.validateData(e),{offset:this.events.length})}),i&&!t.sanitizeQueryVar(a.query_string).tags&&r.fields.push({organizations:$.extend({},__APP.SERVER.validateData(i),{offset:this.organizations.length})}),t.fetchEventsAndOrganizations(a.query_string,r,function(t){a.setData(t),isFunction(n)&&n.call(a,t)})},t}()),RegistrationField=extending(OneEntity,function(){function t(){var t=this;this.form_field_uuid=null,this.form_field_label=null,this.form_field_type=null,this.form_field_type_id=null,this.form_field_required=null,this.value=null,this.values=[],
this.created_at=null,this.updated_at=null,Object.defineProperties(this,{uuid:{get:function(){return t.form_field_uuid},set:function(e){return t.form_field_uuid=e}},label:{get:function(){return t.form_field_label},set:function(e){return t.form_field_label=e}},type:{get:function(){return t.form_field_type},set:function(e){return t.form_field_type=e}},required:{get:function(){return t.form_field_required},set:function(e){return t.form_field_required=e}}})}return t.prototype.ID_PROP_NAME="form_field_uuid",t.TYPES=RegistrationFieldModel.TYPES,t.DEFAULT_LABEL=RegistrationFieldModel.DEFAULT_LABEL,t.isCustomField=RegistrationFieldModel.isCustomField,t}()),RegistrationFieldsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this),Object.defineProperties(this,{__types:{value:{},writable:!0,enumerable:!1,configurable:!1}});for(var t in RegistrationFieldModel.TYPES)RegistrationFieldModel.TYPES.hasOwnProperty(t)&&(this.__types[RegistrationFieldModel.TYPES[t]]=[]);Object.freeze(this.__types)}return t.prototype.collection_of=RegistrationField,t.prototype.createAdditionalLookup=function(t){t instanceof RegistrationField&&this.__types[t.type].push(t)},t}()),OneExtendedTicket=extending(OneTicket,function(){function t(e,i){var n=this;OneTicket.call(this,e,i),this.event=new OneEvent(e),Object.defineProperties(this,{status_name:{get:function(){return localeFromNamespace(n.order.status_type_code,t.TICKET_STATUSES,__LOCALES.ru_RU.TEXTS.TICKET_STATUSES)}},status_type_code:{get:function(){return n.order.status_type_code}}})}return t.prototype.ID_PROP_NAME="uuid",t.TICKET_STATUSES=$.extend({USED:"used"},OneOrder.EXTENDED_ORDER_STATUSES),t.createFrom=function(e,i){var n=new t;return n.setData($.extend(!0,{event:i},e)),n},t.extractTicketFromData=function(t){return t.map(function(t){var e=1===t.tickets.length?t.tickets.shift():t.tickets,i=e.order,n=e.ticket_type;return!i&&t.orders&&(i=t.orders.reduce(function(t,i){return t||i.uuid===e.ticket_order_uuid&&i},!1)),!n&&t.ticket_types&&(n=t.ticket_types.reduce(function(t,i){return t||i.uuid===e.ticket_type_uuid&&i},!1)),$.extend(e,{event:t,order:i,ticket_type:n})})},t.extractTicketFromEvent=function(e){var i=new OneEvent,n=new t(e.id);return i.setData(e),n.setData($.extend(i.tickets[0],{event:i,event_id:i.id,order:i.orders.getByID(i.tickets[0].ticket_order_uuid)})),n},t.fetchTicket=function(t,e,i,n){var a;return i=Fields.parseFields(i),a=$.extend(!0,{},i.pull("event"),{fields:new Fields({tickets:{filters:"uuid="+e,fields:i}})}),__APP.SERVER.getData("/api/v1/events/"+t,a,n)},t.exportTicket=OneTicket.exportTicket,t.prototype.fetchTicket=function(e,i){var n=this;return t.fetchTicket(this.event_id,this.uuid,e,function(e){var a=t.extractTicketFromData(e);n.setData(a),isFunction(i)&&i.call(n,a)})},t}()),ExtendedTicketsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneExtendedTicket,t.convertTicketFieldsToEventAjaxData=function(t){t=t?Fields.parseFields(t):new Fields;var e,i={};return t.has("event")&&(i=t.pull("event")),e=new Fields({tickets:{fields:t}}),i.fields?(i.fields=Fields.parseFields(i.fields),i.fields.push(e)):i.fields=e,i},t.extractTicketsFromEvent=function(e){var i=new OneEvent,n=new t;return i.setData(e),n.setData(i.tickets.map(function(t){return $.extend({},t,{event_id:i.id,event:i})})),n},t}()),EventsExtendedTicketsCollection=extending(ExtendedTicketsCollection,function(){function t(t){ExtendedTicketsCollection.call(this),Object.defineProperty(this,"event_id",{value:t})}return t.fetchTickets=function(t,e,i){return OneEvent.fetchEvent(t,ExtendedTicketsCollection.convertTicketFieldsToEventAjaxData(e).fields,i)},t.prototype.fetchTickets=function(e,i,n,a){var r=this;return t.fetchTickets(this.event_id,e).then(function(t){return r.setData(ExtendedTicketsCollection.extractTicketsFromEvent(t)),isFunction(a)&&a.call(r,r.last_pushed),r.last_pushed})},t}()),MyTicketsCollection=extending(ExtendedTicketsCollection,function(){function t(){ExtendedTicketsCollection.call(this)}return t.fetchTickets=function(t,e){t=t||{};var i=ExtendedTicketsCollection.convertTicketFieldsToEventAjaxData(t.fields);return __APP.SERVER.getData("/api/v1/events",$.extend(i,{length:t.length,offset:t.offset,registered:!0}),e)},t.prototype.fetchTickets=function(e,i,n,a){var r=this;return t.fetchTickets({fields:e||void 0,offset:this.length,length:i||void 0,order_by:n||void 0}).then(function(t){return r.setData(t.map(ExtendedTicketsCollection.extractTicketsFromEvent).reduce(function(t,e){return t.push.apply(t,e),t},[])),isFunction(a)&&a.call(r,r.last_pushed),r.last_pushed})},t}()),CurrentUser=extending(OneUser,function(){function t(){if("object"==typeof t.instance)return t.instance;OneUser.call(this,"me"),this.selected_city=new OneCity,this.friends=new UsersCollection,this.friends_activities=new e,t.instance=this}var e=extending(UsersActivitiesCollection,function(){function t(){}return t.fetch=function(t,e){return t=UsersActivitiesCollection.setDefaultData(t),t.fields=t.fields.merge(["user"]),__APP.SERVER.getData("/api/v1/users/feed",t,e)},t}());return t.fetchFriends=function(t,e){return __APP.SERVER.getData("/api/v1/users/friends",t,e)},t.prototype.fetchUser=function(t,e){var i=this,n=OneUser.fetchUser("me",t),a=function(t){t=t instanceof Array?t[0]:t,i.setData(t),e&&"function"==typeof e&&e.call(i,t)};return t=setDefaultValue(t,[]),t.hasOwnProperty("friends")?__APP.SERVER.multipleAjax(n,this.fetchFriends(t.friends)).done(function(t,e){t=t instanceof Array?t[0]:t,t.friends=e,a(t)}).promise():n.done(a).promise()},t.prototype.fetchFriends=function(e,i){var n=this;return e=$.extend(e,{offset:n.friends.length}),t.fetchFriends(e,function(t){n.friends.setData(t),i&&"function"==typeof i&&i.call(n,n.friends.last_pushed)})},t.prototype.logout=function(){return $.ajax({url:"/index.php",data:{logout:!0},complete:function(){window.location="/"}})},t.prototype.isLoggedOut=function(){return-1===this.id},t.prototype.subscribeToOrganization=function(t,e){var i=this;return i.subscriptions.has(t)?(console.warn("Current user is already subscribed to this organization"),null):(OneOrganization.fetchOrganization(t,i.subscriptions_fields,function(t){i.subscriptions.push(t[0]),e&&"function"==typeof e&&e.call(i,t)}),OneOrganization.subscribeOrganization(t))},t.prototype.unsubscribeFromOrganization=function(t,e){var i=this;return i.subscriptions.has(t)?OneOrganization.unsubscribeOrganization(t,function(){i.subscriptions.remove(t),e&&"function"==typeof e&&e.call(i,t)}):(console.warn("Current user isn`t subscribed to this organization"),null)},t}()),OrganizationSubscribersCollection=extending(UsersCollection,function(){function t(t){UsersCollection.call(this),Object.defineProperty(this,"organization_id",{value:t})}return t.fetchSubscribers=function(t,e,i){return e=e||{},__APP.SERVER.getData("/api/v1/organizations/"+t,{fields:new Fields({subscribed:e})},function(t){isFunction(i)&&i(t[0].subscribed)}).then(function(t){return t[0].subscribed})},t.prototype.fetchSubscribers=function(e,i,n,a){var r=this;return t.fetchSubscribers(this.organization_id,{fields:e||void 0,offset:this.length||void 0,length:i||void 0,order_by:n||void 0},function(t){r.setData(t),isFunction(a)&&a.call(r,r.last_pushed)}).then(function(){return r.last_pushed})},t.prototype.fetchAllSubscribers=function(e,i,n){var a=this;return t.fetchSubscribers(this.organization_id,{fields:e||void 0,offset:0,length:ServerConnection.MAX_ENTITIES_LENGTH,order_by:i||void 0},function(t){a.setData(t),isFunction(n)&&n.call(a,a.last_pushed)}).then(function(){return a.last_pushed})},t.prototype.export=function(t){return(new ServerExports).organizationSubscribers(this.organization_id,t)},t}()),Calendar=function(){function t(e,i){if(this.options={classes:{wrapper_class:"calendar_wrapper",header_class:"calendar_header",prev_btn_class:"calendar_prev_btn",next_btn_class:"calendar_next_btn",month_name_class:"calendar_month_name",table_class:"calendar_month",thead_class:"calendar_thead",tbody_class:"calendar_tbody",tr_class:"calendar_week",head_tr_class:"calendar_weekdays_row",th_class:"calendar_weekday",td_class:"calendar_day",day_class:"day_num",td_additional_classes:[],td_disabled_class:"-disabled",table_cell_class:"calendar_cell",today_class:"today"},additional_dataset:{},selection_type:t.SELECTION_TYPES.SINGLE,weekday_selection:!1,month_selection:!1,disable_selection:!1,min_date:!1,max_date:!1,locale:"ru",labels:{}},e&&(e instanceof Element||"string"==typeof e)){if(e=$(e),0===e.length)throw new Error("Такого элемента не существует");if(e.length>1)throw new Error("Элементов с заданным аргументов найдено несколько")}if(!(e instanceof jQuery))throw new TypeError("Аргумент должен быть экземпляром jQuery, элементом DOM, либо CSS селектором");$.extend(!0,this.options,i,e.data()),!1!==this.options.min_date&&!1!==this.options.max_date&&moment(this.options.max_date).diff(this.options.min_date,"days")<=0&&(this.options.max_date=!1),!0!==this.options.weekday_selection&&!0!==this.options.month_selection||(this.options.selection_type=t.SELECTION_TYPES.MULTI),this.selected_days=[],this.selected_weeks={},this.selected_months=[],this.last_action="",this.last_selected_days="",this.now_selected_day="",this.prev_selected_day="",this.formatted_days={},this.$calendar=e,this.current_month=moment(new Date),this._today=moment(new Date)}return t.SELECTION_TYPES={SINGLE:"single",MULTI:"multi"},t.prototype.flush=function(){this.selected_days=[],this.selected_weeks={},this.selected_months=[],this.last_action="",this.last_selected_days="",this.now_selected_day="",this.prev_selected_day="",this.formatted_days={},this.destroyTable()},t.prototype.setMonth=function(t,e){switch(t){case"prev":this.current_month=this.current_month.add(-1,"months");break;case"next":this.current_month=this.current_month.add(1,"months");break;case"current":this.current_month=moment(new Date);break;default:this.current_month=e?this.current_month.set({year:e,month:t-1}):this.current_month.month(t-1)}return this.renderTable(),this.$calendar.trigger("change:month"),this},t.prototype.destroyTable=function(){return this.$calendar.find("."+this.options.classes.th_class).removeClass(__C.CLASSES.ACTIVE).off("click"),this.$calendar.find(".MonthName").removeClass(__C.CLASSES.ACTIVE).off("click"),this.$calendar.find(".CalendarTableBody").remove(),this},t.prototype.setMonthName=function(){return this.$calendar.find(".MonthName").data("month",this.current_month.month()).text(this.current_month.format("MMMM YYYY").capitalize()),this},t.prototype.buildTable=function(){var t,e,i=this.$calendar.find(".CalendarTable"),n=this.current_month.daysInMonth(),a=this.current_month.date(1).day(),r=this.current_month.date(n).day(),o=[],s=[],l=[];for(var c in this.options.additional_dataset)this.options.additional_dataset.hasOwnProperty(c)&&l.push("data-"+c+"="+this.options.additional_dataset[c]);for(var d=1;d<=n;d++)this.current_month.date(d),t=this.current_month.format(__C.DATE_FORMAT),e=moment(t),s=[this.options.classes.table_cell_class,this.options.classes.td_class,"Day_"+t,"DayOfWeek_"+this.current_month.day(),"DayOfMonth_"+this.current_month.month()].concat(this.options.classes.td_additional_classes),(!1===this.options.min_date||e.diff(this.options.min_date,"d")>=0)&&(!1===this.options.max_date||e.diff(this.options.max_date,"d")<=0)||s.push(this.options.classes.td_disabled_class),this.current_month.format(__C.DATE_FORMAT)==this._today.format(__C.DATE_FORMAT)&&s.push(this.options.classes.today_class),o.push(tmpl("calendar-div",{td_classes:s.join(" "),number:this.current_month.date(),day_number:this.current_month.day(),date:this.current_month.format(__C.DATE_FORMAT),date_text:this.current_month.format("DD MMMM YYYY"),dataset:l.join(" ")}));var _=this.current_month.clone();if(1!=a){_.add(-1,"months"),_.date(_.daysInMonth());do{t=_.format(__C.DATE_FORMAT),e=moment(t),s=[this.options.classes.table_cell_class,this.options.classes.td_class,"Day_"+t,"DayOfWeek_"+_.day(),"DayOfMonth_"+_.month(),"not_this_month"].concat(this.options.classes.td_additional_classes),(!1===this.options.min_date||e.diff(this.options.min_date,"d")>=0)&&(!1===this.options.max_date||e.diff(this.options.max_date,"d")<=0)||s.push(this.options.classes.td_disabled_class),o.unshift(tmpl("calendar-div",{td_classes:s.join(" "),number:_.date(),day_number:_.day(),date:_.format(__C.DATE_FORMAT),date_text:_.format("DD MMMM YYYY"),dataset:l.join(" ")})),_.add(-1,"days")}while(0!=_.day())}if(0!=r){_=this.current_month.clone();do{_.add(1,"days"),t=_.format(__C.DATE_FORMAT),e=moment(t),s=[this.options.classes.table_cell_class,this.options.classes.td_class,"Day_"+t,"DayOfWeek_"+_.day(),"DayOfMonth_"+_.month(),"not_this_month"].concat(this.options.classes.td_additional_classes),(!1===this.options.min_date||e.diff(this.options.min_date,"d")>=0)&&(!1===this.options.max_date||e.diff(this.options.max_date,"d")<=0)||s.push(this.options.classes.td_disabled_class),o.push(tmpl("calendar-div",{td_classes:s.join(" "),number:_.date(),day_number:_.day(),date:_.format(__C.DATE_FORMAT),date_text:_.format("DD MMMM YYYY"),dataset:l.join(" ")}))}while(0!=_.day())}for(var u=$("<tbody>").addClass("CalendarTableBody"),p=0,h=0,f=[tmpl("calendar-row",{tr_class:this.options.classes.tr_class})],S=0;S<o.length;S++)7==p&&(f.push(tmpl("calendar-row",{tr_class:this.options.classes.tr_class})),p=0,h++),f[h].append(o[S]),p++;return f.forEach(function(t){u.append(t)}),i.append(u),this},t.prototype.renderTable=function(){if(this.destroyTable().buildTable().activateSelectedDays().setMonthName(),!this.options.disable_selection){switch(this.options.selection_type){case t.SELECTION_TYPES.MULTI:this.bindDragSelection();break;case t.SELECTION_TYPES.SINGLE:this.bindDaySelection()}!0===this.options.weekday_selection&&this.bindWeekdaySelection(),!0===this.options.month_selection&&this.bindMonthSelection()}return this},t.prototype.selectToday=function(){return this.$calendar.find("."+this.options.classes.td_class+"."+this.options.classes.today_class).addClass(__C.CLASSES.ACTIVE),this},t.prototype.formatDays=function(){var t={"январь":"января","февраль":"февраля","март":"марта","апрель":"апреля","май":"мая","июнь":"июня","июль":"июля","август":"августа","сентябрь":"сентября","октябрь":"октября","ноябрь":"ноября","декабрь":"декабря"},e=moment(this.now_selected_day),i=e.month(),n=e.month(i),a=n.daysInMonth(),r=n.date(1);for(void 0===this.formatted_days[i]&&(this.formatted_days[i]={},this.formatted_days[i].selected_days=[],this.formatted_days[i].month_name=t[e.format("MMMM")]),this.formatted_days[i].selected_days.push(e.format(__C.DATE_FORMAT)),this.formatted_days[i].text="";a;)console.log(this.formatted_days[i].selected_days),-1!==this.formatted_days[i].selected_days.indexOf(r.format(__C.DATE_FORMAT))&&(this.formatted_days[i].text+=""+r.format("D")),r=r.add(1,"d"),a--;return console.log(this.formatted_days[i].text),this},t.prototype.selectDays=function(e){function i(e){switch(n.options.selection_type){case t.SELECTION_TYPES.MULTI:-1===n.selected_days.indexOf(e)&&(n.selected_days.push(e),n.selected_days.sort());break;default:case t.SELECTION_TYPES.SINGLE:n.$calendar.find("."+n.options.classes.td_class+"."+__C.CLASSES.ACTIVE).removeClass(__C.CLASSES.ACTIVE),n.selected_days=[e]}n.$calendar.find(".Day_"+e).addClass(__C.CLASSES.ACTIVE)}var n=this;if(Array.isArray(e)){var a=[];e.forEach(function(t){(!1===n.options.min_date||moment(t).diff(n.options.min_date)>=0)&&(!1===n.options.max_date||moment(t).diff(n.options.max_date)<=0)?i(t):a.push(t)}),a.forEach(function(t){e.splice(e.indexOf(t),1)})}else(!1===n.options.min_date||moment(e).diff(n.options.min_date)>=0)&&(!1===n.options.max_date||moment(e).diff(n.options.max_date)<=0)?(i(e),e=[e]):e=[];return e.length&&(n.last_action="select",n.last_selected_days=e,n.$calendar.trigger("change:days")),this},t.prototype.deselectDays=function(e){function i(t){var e,i=n.$calendar.find(".Day_"+t),a=n.$calendar.find(".Week_"+i.data("weekday")),r=n.$calendar.find(".MonthName"),o=n.current_month.format("YYYY"),s=n.current_month.format("MM"),l=n.current_month.format("YYYY.MM");n.selected_days.splice(n.selected_days.indexOf(t),1),n.selected_days.sort(),-1!==n.selected_months.indexOf(l)&&(r.removeClass(__C.CLASSES.ACTIVE),n.selected_months.splice(n.selected_months.indexOf(l),1)),void 0!==n.selected_weeks[o]&&void 0!==n.selected_weeks[o][s]&&-1!==(e=n.selected_weeks[o][s].indexOf(i.data("weekday")))&&(a.removeClass(__C.CLASSES.ACTIVE),n.selected_weeks[o][s].splice(e,1)),n.$calendar.find(".Day_"+t).removeClass(__C.CLASSES.ACTIVE)}var n=this;return this.options.selection_type===t.SELECTION_TYPES.MULTI&&(Array.isArray(e)?e.forEach(function(t){i(t)}):i(e),n.last_action="deselect",n.last_selected_days=e,n.$calendar.trigger("change:days")),this},t.prototype.selectWeek=function(t){var e,i=this,n=i.$calendar.find(".Week_"+t),a=i.$calendar.find(".DayOfWeek_"+t).not(".not_this_month"),r=i.current_month.format("YYYY"),o=i.current_month.format("MM"),s=[];return a.each(function(t){s.push(a.eq(t).data("date"))}),void 0===i.selected_weeks[r]&&(i.selected_weeks[r]={}),void 0===i.selected_weeks[r][o]&&(i.selected_weeks[r][o]=[]),e=i.selected_weeks[r][o].indexOf(t),-1===e?(n.addClass(__C.CLASSES.ACTIVE),i.selectDays(s),i.selected_weeks[r][o].push(t)):(n.removeClass(__C.CLASSES.ACTIVE),i.deselectDays(s),i.selected_weeks[r][o].splice(e,1)),this},t.prototype.selectMonth=function(t){var e=this,i=e.$calendar.find(".MonthName"),n=e.$calendar.find(".DayOfMonth_"+t),a=e.current_month.format("YYYY.MM"),r=e.selected_months.indexOf(a),o=[];return n.each(function(t){o.push(n.eq(t).data("date"))}),-1===r?(i.addClass(__C.CLASSES.ACTIVE),e.selectDays(o),e.selected_months.push(a)):(i.removeClass(__C.CLASSES.ACTIVE),e.deselectDays(o),e.selected_months.splice(r,1)),this},t.prototype.bindMonthArrows=function(){var t=this;return this.$calendar.find(".NextMonth").off("click.NextMonth").on("click.NextMonth",function(){t.setMonth("next")}),this.$calendar.find(".PrevMonth").off("click.PrevMonth").on("click.PrevMonth",function(){t.setMonth("prev")}),this},t.prototype.bindDaySelection=function(){var e=this,i=e.$calendar.find("."+this.options.classes.td_class),n=i.not("."+this.options.classes.td_disabled_class);return i.off("click.bindDaySelection"),n.on("click.bindDaySelection",function(){e.options.selection_type===t.SELECTION_TYPES.MULTI&&$(this).hasClass(__C.CLASSES.ACTIVE)?e.deselectDays($(this).data("date")):e.selectDays($(this).data("date"))}),this},t.prototype.bindWeekdaySelection=function(){var t=this;return t.$calendar.find("."+this.options.classes.th_class).on("click",function(){t.selectWeek($(this).data("weekday"))}),this},t.prototype.bindMonthSelection=function(){var t=this;return t.$calendar.find(".MonthName").on("click",function(){t.selectMonth($(this).data("month"))}),this},t.prototype.bindDragSelection=function(){function t(t){t=t.is("."+i.options.classes.td_class)?t:t.closest("."+i.options.classes.td_class),t.not("."+i.options.classes.td_disabled_class).length&&(t.hasClass(__C.CLASSES.ACTIVE)?i.deselectDays(t.data("date")):i.selectDays(t.data("date")))}function e(){i.$calendar.find("."+i.options.classes.td_class).off("mouseenter.DragSelection")}var i=this;return i.$calendar.off("mousedown.RangeSelection").on("mousedown.RangeSelection",function(e){t($(e.target)),i.$calendar.find("."+i.options.classes.td_class).not("."+i.options.classes.td_disabled_class).on("mouseenter.DragSelection",function(e){e.preventDefault(),t($(e.target))})}).on("mouseup",e).on("mouseleave",e),this},t.prototype.activateSelectedDays=function(){var t=this,e=t.current_month.format("YYYY"),i=t.current_month.format("MM");return t.selected_days.forEach(function(e){t.$calendar.find(".Day_"+e).addClass(__C.CLASSES.ACTIVE)}),-1!==t.selected_months.indexOf(e+"."+i)&&t.$calendar.find(".MonthName").addClass(__C.CLASSES.ACTIVE),void 0!==t.selected_weeks[e]&&void 0!==t.selected_weeks[e][i]&&t.selected_weeks[e][i].forEach(function(e){t.$calendar.find(".Week_"+e).addClass(__C.CLASSES.ACTIVE)}),this},t.prototype.setDaysWithEvents=function(t){var e=this,i=Object.assign({since:e.current_month.startOf("month").format(__C.DATE_FORMAT),till:e.current_month.endOf("month").format(__C.DATE_FORMAT),length:500,my:!0,unique:!0},t);return e.$calendar.find(".feed_calendar_td").removeClass("Controller has_favorites").addClass(__C.CLASSES.DISABLED),DatesCollection.fetchDates(i,function(t){t.forEach(function(t){var i=e.$calendar.find(".Day_"+moment.unix(t.event_date).format(__C.DATE_FORMAT));i.length&&i.html(tmpl("link",{title:i.children().text(),classes:e.options.classes.day_class,page:"/feed/day/"+i.data("date")})).addClass(t.favorites_count>0?"has_favorites":"").removeClass(__C.CLASSES.DISABLED)}),e.bindDaySelection(),bindPageLinks(e.$calendar)}),this},t.prototype.init=function(){return this.$calendar.empty().append(tmpl("calendar",this.options.classes)),this.options.weekday_selection&&this.$calendar.addClass("-weekday_selection"),this.options.month_selection&&this.$calendar.addClass("-month_selection"),this.$calendar.data("calendar",this),this.$calendar.data("instance",this),this.$calendar.data("days",this.selected_days),this.$calendar.data("options",this.options),this.bindMonthArrows().renderTable(),this},t}(),DatePicker=function(){function t(t,e){if(this.options={classes:{},close_on_pick:!0,min_date:!1,max_date:!1,labels:{}},t instanceof Element||"string"==typeof t){if(t=$(t),0===t.length)throw new Error("Такого элемента не существует");if(t.length>1)throw new Error("Элементов с заданным аргументов найдено несколько")}if(!(t instanceof jQuery))throw new TypeError("Аргумент должен быть экземпляром jQuery, элементом DOM, либо CSS селектором");$.extend(!0,this.options,e,t.data()),this.$datepicker=t,this.$datepicker_modal=tmpl("datepicker",{}),this.$input=t.is("input")?t:t.find("input"),this.calendar=new Calendar(this.$datepicker_modal.children(".DatePickerCalendar"),{min_date:this.options.min_date,max_date:this.options.max_date}),this.prev_selected_day=void 0!==this.options.selected_day?this.options.selected_day:this.$input.val()||"",this.selected_day=void 0!==this.options.selected_day?this.options.selected_day:this.$input.val()||"",this.formated_selected_day=this.selected_day.toString().split("-").reverse().join(".")}return t.prototype.init=function(){var t=this;return this.bindOpener().$datepicker.data("datepicker",this).data("instance",this),this.$datepicker.addClass("-unselectable -Handled_DatePicker"),this.$input.length&&(this.$input.attr("readonly",!0),Object.defineProperty(this.$input.get(0),"value",{get:function(){return t.selected_day}})),this.calendar.init().$calendar.on("change:days",function(){t.prev_selected_day=t.selected_day,t.selected_day=t.calendar.selected_days.toString(),t.formated_selected_day=t.calendar.selected_days.toString().split("-").reverse().join("."),t.$datepicker.is("input")||t.$datepicker.find(".DatePickerDisplayText").text(t.formated_selected_day),t.$input.val(t.selected_day).trigger("change"),t.options.close_on_pick&&t.closeDialog(),t.$datepicker.trigger("date-picked"),t.$datepicker.trigger("change")}),this},t.prototype.bindOpener=function(){function t(){e.$input.is(":disabled")?e.$datepicker.one("click",t):e.openDialog()}var e=this;return this.$datepicker.one("click",t),this},t.prototype.openDialog=function(){var t=this.$datepicker.offset();return $("body").append(this.$datepicker_modal),this.$datepicker_modal.css({top:t.top+this.$datepicker.outerHeight()+2,left:t.left+this.$datepicker.width()-this.$datepicker_modal.width(),maxWidth:this.$datepicker.width()}),this.calendar.renderTable(),this.bindCloseDialog(),this},t.prototype.bindCloseDialog=function(){var t=this;return $(document).off("click.checkOnClick").on("click.checkOnClick",function(e){var i=$(e.target);(0===i.closest(t.$datepicker_modal).length&&0===i.closest(t.$datepicker).length||i.closest(".SubmitDatePicker").length)&&t.closeDialog()}).off("keydown.checkOnKeyDown").on("keydown.checkOnKeyDown",function(e){9!==e.keyCode&&13!==e.keyCode&&27!==e.keyCode||t.closeDialog()}),this},t.prototype.closeDialog=function(){return $(document).off("click.checkOnClick").off("keydown.checkOnKeyDown"),this.$datepicker_modal.detach(),this.calendar.flush(),this.bindOpener(),this},t.prototype.destroy=function(){return this.closeDialog().$datepicker.data("datepicker",""),this},t}(),DropDown=extendingJQuery(function(){function t(t,e,i,n,a,r){this.options=$.extend(!0,{position:{x:0,y:0}},n),this.afterInit=r||function(){},i=Builder.normalizeBuildProps(i),jQuery.fn.init.call(this,tmpl("button",{title:e,classes:i.classes,attributes:i.attributes})),this.data(i.dataset),this.dropdown=tmpl("dropdown-"+t,a),this.data("instance",this)}return t.prototype.initiate=function(){var t=this;this.addClass(__C.CLASSES.HOOKS.HANDLED+__C.CLASSES.HOOKS.DROPDOWN_BUTTON),$("body").append(this.dropdown).one("Page:change/start",function(){t.destroy()}),this.on("click.OpenDropDown",function(){t.openDropdown()}),this.afterInit(),this.dropdown.find(".CloseDropdown").on("click.CloseDropdown",function(){t.closeDropdown()})},t.prototype.openDropdown=function(){var t=this,e=this.offset();this.dropdown.addClass(__C.CLASSES.SHOW),this.addClass("-dropdown_active"),empty(this.options.width)||("self"===this.options.width?this.dropdown.width(this.outerWidth()):(isFinite(this.options.width)||isPercentageString(this.options.width))&&this.dropdown.width(this.options.width)),this.dropdown.css({left:function(t,e,i,n){switch(t){case"center":return e+i/2-n/2;case"right":return e+i-n;default:if(isFinite(t))return e+t}}(this.options.position.x,e.left,this.outerWidth(),this.dropdown.outerWidth()),top:function(t,e,i,n){return"center"===t?e+i/2-n/2:isFinite(t)?e+i+t:void 0}(this.options.position.y,e.top,this.outerHeight(),this.dropdown.outerHeight())}),$("body").on("mousedown.CloseDropdown",function(e){$(e.target).closest(t.dropdown).length||t.closeDropdown()}),$(document).on("keyup.CloseDropdown",function(e){isKeyPressed(e,__C.KEY_CODES.ESC)&&t.closeDropdown()})},t.prototype.closeDropdown=function(){$("body").off("mousedown.CloseDropdown"),$(document).off("keyup.CloseDropdown"),this.dropdown.removeClass(__C.CLASSES.SHOW),this.removeClass("-dropdown_active")},t.prototype.destroy=function(){this.closeDropdown(),this.dropdown.remove(),this.remove()},t}()),ImgLoader=function(){function ImgLoader(){}return ImgLoader.current_load_context=null,ImgLoader.init=function(t){t=t||$("body"),t.find(".ImgLoadWrap").each(function(){var t=$(this),e=t.find(".ImgSrc"),i=t.find(".ImgPreview");e.off("change.CroppedPreview").on("change.CroppedPreview",function(){i.attr("src",this.value)}),i.attr("src")&&t.find(".CropperButton").removeClass(__C.CLASSES.HIDDEN),t.find(".LoadImg").off("change.LoadImg").on("change.LoadImg",function(e){var i,n=e.target.files;if(0==n.length)return!1;for(var a,r=0;a=n[r];r++)i=new FileReader,i.onload=function(e){return function(i){var n=i.target.result;ImgLoader.handleImgUpload(t,n,e.name)}}(a),i.readAsDataURL(a)}),t.find(".LoadByURLButton").not("-Handled_LoadByURLButton").on("click.LoadByURL",function(){ImgLoader.current_load_context=t,socket.emit("image.getFromURL",t.find(".LoadByURLAddress").val()),Pace.restart()}).addClass("-Handled_LoadByURLButton"),t.find(".CropperButton").off("click.CallCropper").on("click.CallCropper",function(){ImgLoader.callImgCropper(t,t.data("src")?t.data("src"):e.val())})})},ImgLoader.callImgCropper=function($context,source){var $parent=$context.closest(".ImgLoadWrap"),$img_source=$parent.find(".ImgSrc"),cropper_modal=$parent.data("modal");return cropper_modal&&cropper_modal.image_src!=source&&cropper_modal.destroy(),cropper_modal&&cropper_modal.image_src==source||($parent.data("src",source),cropper_modal=new CropperModal(source,{aspectRatio:eval($parent.data("aspect_ratio"))}),$parent.data("modal",cropper_modal)),cropper_modal.show(),cropper_modal.modal.on("crop",function(t,e){$img_source.val(e).trigger("change")}),cropper_modal},ImgLoader.handleImgUpload=function(t,e,i){var n=t.closest(".ImgLoadWrap");n.data("src",e),n.find(".FileName").val(i),n.find(".CropperButton").removeClass(__C.CLASSES.HIDDEN),ImgLoader.callImgCropper(n,e)},ImgLoader}(),ProgressBar=extendingJQuery(function(){function t(i,n){var a={};Object.keys(t.STRINGS).forEach(function(e){null!=i[e]&&(a[t.STRINGS[e]]=i[e])}),jQuery.fn.init.call(this,tmpl("progress-bar",$.extend(!0,Builder.normalizeBuildProps(n),{dataset:a}))),this.options=n,this.$strip=this.find(".ProgressBarComplete"),this.data($.extend({instance:this},n.dataset)),null!=i.NUMBER&&null!=i.OVERALL?e(this.$strip,i.NUMBER/i.OVERALL*100):null!=i.PERCENTAGE&&e(this.$strip,i.PERCENTAGE)}function e(t,e){t.width(Math.roundTo(e,3)+($.isNumeric(e)?"%":""))}return t.STRINGS={NUMBER:"abs_number",OVERALL:"abs_of",PERCENTAGE:"percentage"},t.prototype.set=function(i){var n=this.data();$.isNumeric(i)?(this.attr("data-"+t.STRINGS.NUMBER,i),this.data(t.STRINGS.NUMBER,i),e(this.$strip,i/n[t.STRINGS.OVERALL]*100)):(n[t.STRINGS.NUMBER]&&n[t.STRINGS.OVERALL]?(this.attr("data-"+t.STRINGS.NUMBER,n[t.STRINGS.NUMBER]=n[t.STRINGS.OVERALL]*parseFloat(i)/100),this.data(t.STRINGS.NUMBER,n[t.STRINGS.NUMBER])):(this.attr("data-"+t.STRINGS.PERCENTAGE,n[t.STRINGS.PERCENTAGE]=parseFloat(i)),this.data(t.STRINGS.PERCENTAGE,n[t.STRINGS.PERCENTAGE])),e(this.$strip,i))},t.prototype.setMax=function(i){var n=this.data();this.attr("data-"+t.STRINGS.OVERALL,i),this.data(t.STRINGS.OVERALL,i),e(this.$strip,n[t.STRINGS.NUMBER]/i*100)},t}()),QuantityInput=extendingJQuery(function(){function t(t,e){e=$.extend({min:0},e);var i,n,a,r=this,o=e.min&&e.min>0?e.min:0;i=__APP.BUILD.button({title:"+",classes:["QuantityInputPlus","quantity_input_button",__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.HOOKS.RIPPLE],attributes:{tabindex:-1}}),n=__APP.BUILD.button({title:"–",classes:["QuantityInputMinus","quantity_input_button",__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.HOOKS.RIPPLE],attributes:{tabindex:-1}}),a=__APP.BUILD.inputNumber($.extend({value:o,size:2},t),["quantity_input"],null,{min:e.min,max:e.max||null}),jQuery.fn.init.call(this,tmpl("quantity-input",{minus_button:n,input:a,plus_button:i})),this.options=e,bindRippleEffect(i),bindRippleEffect(n),this.plus=i,this.input=a,this.minus=n,!empty(this.options.min)&&o<=this.options.min&&(this.input.val(this.options.min),this.disableMinus()),!empty(this.options.max)&&o>=this.options.max&&(this.input.val(this.options.max),this.disablePlus()),Object.defineProperty(this[0],"value",{get:function(){return+r.input.val()},set:function(t){var e=r.input.val();return parseInt(e)!==parseInt(t)&&(r.input.val(t),r.check(),parseInt(r.input.val())===parseInt(t)&&r.input.trigger("QuantityInput::change",[t,e])),t}}),this.data("instance",this),this.initiate()}return t.prototype.activatePlus=function(){this.plus.removeAttr("disabled")},t.prototype.disablePlus=function(){this.plus.attr("disabled",!0)},t.prototype.activateMinus=function(){this.minus.removeAttr("disabled")},t.prototype.disableMinus=function(){this.minus.attr("disabled",!0)},t.prototype.check=function(t){t=empty(t)?this.input.val():t,!empty(this.options.max)&&t>=this.options.max?this.disablePlus():this.activatePlus(),!empty(this.options.min)&&t<=this.options.min?this.disableMinus():this.activateMinus()},t.prototype.decrement=function(){var t=+this.input.val();if(this.check(t-1),!empty(this.options.min)&&t-1<this.options.min)return!1;this.input.val(t-1).trigger("QuantityInput::change",[t-1,t])},t.prototype.increment=function(){var t=+this.input.val();if(this.check(t+1),!empty(this.options.max)&&t+1>this.options.max)return!1;this.input.val(t+1).trigger("QuantityInput::change",[t+1,t])},t.prototype.initiate=function(){var t=this;this.plus.on("click.PlusQuantity",function(){t.increment()}),this.minus.on("click.MinusQuantity",function(){t.decrement()}),this.input.on("input",function(){t.input.trigger("QuantityInput::change",[t.input.val()]),t.check()}).on("change",function(){
t.input.trigger("QuantityInput::change",[t.input.val()])})},t}()),ActionButton=extendingJQuery(function(){function t(e){e=e||{};var i=this;this.options=$.extend(!0,{classes:[],icons:null,colors:null,labels:null},this.options,e),this.has_icon=!e.hasOwnProperty("has_icon")||!!e.has_icon,this.is_checked=!!e.is_checked,this.is_add_avatar=!!e.is_add_avatar,this.has_icon?this.options.classes.push(this.icon_class):this.options.icons={},this.options.icons=this.options.icons?this.options.icons:{},this.options.colors=this.options.colors?this.options.colors:{},this.options.labels=this.options.labels?this.options.labels:{},this.classes={},$.each(t.STATES,function(t,e){i.classes[e]=[].concat(i.options.icons?i.options.icons[e]:[]).concat(i.options.colors?i.options.colors[e]:[]).join(" ")}),jQuery.fn.init.call(this,__APP.BUILD.button(this.is_checked?{classes:this.options.classes.concat(this.classes[t.STATES.CHECKED]).concat(this.checked_state_class?this.checked_state_class:[]),title:this.options.labels[t.STATES.CHECKED]}:{classes:this.options.classes.concat(this.classes[t.STATES.UNCHECKED]),title:this.options.labels[t.STATES.UNCHECKED]})),this.data("instance",this),this.initiate()}function e(t){var e=t.closest("."+__C.CLASSES.HOOKS.ADD_AVATAR.ANCESTOR),i=e.find("."+__C.CLASSES.HOOKS.ADD_AVATAR.COLLECTION),n=e.find("."+__C.CLASSES.HOOKS.ADD_AVATAR.QUANTITY),a=i.find(".avatar"),r=a.length;if(i.data("max_amount")>=r)i.hasClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED)?(i.removeClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED),i.width(1==r?0:a.outerWidth()*(r-1)-6*(r-2))):(i.addClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED),i.width(a.outerWidth()*r-6*(r-1)));else{if(n.length){var o=parseInt(n.text());i.hasClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED)?(n.text(o-1),o-1<=0&&n.parent().addClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.CAST)):(n.text(o+1),n.parent().removeClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.CAST))}i.toggleClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFT+" "+__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED)}}return t.STATES={CHECKED:"checked",UNCHECKED:"unchecked",CHECKED_HOVER:"checked_hover",UNCHECKED_HOVER:"unchecked_hover"},t.prototype.checked_state_class="",t.prototype.icon_class=__C.CLASSES.ICON_CLASS,t.prototype.onClick=function(){},t.prototype.afterCheck=function(){var e=this.is(":hover");this.is_checked=!0,this.removeClass("".concat(this.classes[t.STATES.UNCHECKED_HOVER]," ",this.classes[t.STATES.UNCHECKED])).addClass("".concat(this.classes[e?t.STATES.CHECKED_HOVER:t.STATES.CHECKED]," ",this.checked_state_class)).children("."+__C.CLASSES.HOOKS.TEXT).text(this.options.labels[e?t.STATES.CHECKED_HOVER:t.STATES.CHECKED])},t.prototype.afterUncheck=function(){var e=this.is(":hover");this.is_checked=!1,this.removeClass("".concat(this.classes[t.STATES.CHECKED_HOVER]," ",this.classes[t.STATES.CHECKED]," ",this.checked_state_class)).addClass("".concat(this.classes[e?t.STATES.UNCHECKED_HOVER:t.STATES.UNCHECKED])).children("."+__C.CLASSES.HOOKS.TEXT).text(this.options.labels[e?t.STATES.UNCHECKED_HOVER:t.STATES.UNCHECKED])},t.prototype.showAuthModal=function(){var t;return(t=this.data("modal"))||(t=new AuthModal,this.data("modal",t)),t.show()},t.prototype.initiate=function(){var i=this;this.on("mouseenter.HoverActionButton",function(){i.removeClass(i.classes[i.is_checked?t.STATES.CHECKED:t.STATES.UNCHECKED]).addClass(i.classes[i.is_checked?t.STATES.CHECKED_HOVER:t.STATES.UNCHECKED_HOVER]),i.children("."+__C.CLASSES.HOOKS.TEXT).text(i.options.labels[i.is_checked?t.STATES.CHECKED_HOVER:t.STATES.UNCHECKED_HOVER])}).on("mouseleave.LeaveActionButton",function(){i.removeClass(i.classes[i.is_checked?t.STATES.CHECKED_HOVER:t.STATES.UNCHECKED_HOVER]).addClass(i.classes[i.is_checked?t.STATES.CHECKED:t.STATES.UNCHECKED]),i.children("."+__C.CLASSES.HOOKS.TEXT).text(i.options.labels[i.is_checked?t.STATES.CHECKED:t.STATES.UNCHECKED])}).on("click.Action",function(){if(__APP.USER.isLoggedOut())return i.showAuthModal();i.onClick(),i.is_add_avatar&&e(i),window.askToSubscribe instanceof Function&&window.askToSubscribe()})},t}()),AddToFavoriteButton=extending(ActionButton,function(){function t(t,e){this.options={labels:{checked:__LOCALES.ru_RU.TEXTS.BUTTON.FAVORED,unchecked:__LOCALES.ru_RU.TEXTS.BUTTON.ADD_FAVORITE,checked_hover:__LOCALES.ru_RU.TEXTS.BUTTON.REMOVE_FAVORITE,unchecked_hover:__LOCALES.ru_RU.TEXTS.BUTTON.ADD_FAVORITE},colors:{checked:__C.CLASSES.COLORS.ACCENT,unchecked:__C.CLASSES.COLORS.DEFAULT,checked_hover:__C.CLASSES.COLORS.ACCENT,unchecked_hover:__C.CLASSES.COLORS.NEUTRAL_ACCENT},icons:{checked:__C.CLASSES.ICONS.STAR,unchecked:__C.CLASSES.ICONS.STAR_O,checked_hover:__C.CLASSES.ICONS.TIMES,unchecked_hover:__C.CLASSES.ICONS.STAR_O}},this.event_id=t,ActionButton.call(this,e)}return t.prototype.checked_state_class="-Favored",t.prototype.showAuthModal=function(){var t;return(t=this.data("modal"))||(t=new AuthModal(location.origin+"/event/"+this.event_id),this.data("modal",t)),cookies.setItem("auth_command","add_to_favorite"),cookies.setItem("auth_entity_id",this.event_id),t.show()},t.prototype.onClick=function(){var t=this;this.is_checked?OneEvent.deleteFavored(this.event_id,function(){t.afterUncheck()}):OneEvent.addFavored(this.event_id,function(){t.afterCheck()})},t}()),OrderButton=extending(ActionButton,function(){function t(t,e){this.options={labels:{checked:t.ticketing_locally?"Куплен":"Зарегистрирован",unchecked:t.ticketing_locally?"Купить":"Регистрация",checked_hover:"Открыть билеты",unchecked_hover:t.ticketing_locally?"Купить":"Регистрация"},colors:{checked:__C.CLASSES.COLORS.ACCENT,unchecked:__C.CLASSES.COLORS.DEFAULT,checked_hover:__C.CLASSES.COLORS.ACCENT,unchecked_hover:__C.CLASSES.COLORS.NEUTRAL_ACCENT},icons:{checked:__C.CLASSES.ICONS.CHECK,unchecked:t.ticketing_locally?__C.CLASSES.ICONS.TICKET:__C.CLASSES.ICONS.PENCIL,checked_hover:__C.CLASSES.ICONS.TICKET,unchecked_hover:t.ticketing_locally?__C.CLASSES.ICONS.TICKET:__C.CLASSES.ICONS.PENCIL}},this.event=t,this.modal=null,this.is_disabled=this.event.ticketing_locally?!this.event.ticketing_available:this.event.registration_locally&&!this.event.registration_available,e.is_checked=!1,ActionButton.call(this,e)}return t.prototype.checked_state_class="-Ordered",t.prototype.showAuthModal=function(){var t;return(t=this.data("modal"))||(t=new AuthModal(location.origin+"/event/"+this.event.id+"/order"),this.data("modal",t)),cookies.removeItem("auth_command"),cookies.removeItem("auth_entity_id"),t.show()},t.prototype.onClick=function(){if(this.is_disabled)return this.off("click.RippleEffect").addClass(__C.CLASSES.HOOKS.HANDLED+__C.CLASSES.HOOKS.RIPPLE),!1;__APP.changeState("/event/"+this.event.id+"/order")},t.prototype.initiate=function(){this.is_disabled?this.attr("disabled",!0):ActionButton.prototype.initiate.call(this)},t}()),SubscribeButton=extending(ActionButton,function(){function t(t,e){this.options={labels:{checked:__LOCALES.ru_RU.TEXTS.BUTTON.SUBSCRIBED,unchecked:__LOCALES.ru_RU.TEXTS.BUTTON.ADD_SUBSCRIPTION,checked_hover:__LOCALES.ru_RU.TEXTS.BUTTON.REMOVE_SUBSCRIPTION,unchecked_hover:__LOCALES.ru_RU.TEXTS.BUTTON.ADD_SUBSCRIPTION},colors:{checked:__C.CLASSES.COLORS.ACCENT,unchecked:__C.CLASSES.COLORS.NEUTRAL_ACCENT,checked_hover:__C.CLASSES.COLORS.ACCENT,unchecked_hover:__C.CLASSES.COLORS.NEUTRAL_ACCENT},icons:{checked:__C.CLASSES.ICONS.CHECK,unchecked:__C.CLASSES.ICONS.PLUS,checked_hover:__C.CLASSES.ICONS.TIMES,unchecked_hover:__C.CLASSES.ICONS.PLUS}},this.org_id=t,ActionButton.call(this,e)}return t.prototype.checked_state_class="-Subscribed",t.prototype.showAuthModal=function(){var t;return(t=this.data("modal"))||(t=new AuthModal(location.origin+"/organization/"+this.org_id),this.data("modal",t)),cookies.setItem("auth_command","subscribe_to"),cookies.setItem("auth_entity_id",this.org_id),t.show()},t.prototype.onClick=function(){var t=this;t.is_checked?__APP.USER.unsubscribeFromOrganization(t.org_id,function(){t.afterUncheck(),$(window).trigger("unsubscribe",[t.org_id])}):__APP.USER.subscribeToOrganization(t.org_id,function(){t.afterCheck(),$(window).trigger("subscribe",[t.org_id])})},t}()),ModalsCollection=extending(Array,function(){function t(t){this.max_length=t,Object.defineProperty(this,"last_id",{value:0,writable:!0,enumerable:!1,configurable:!1})}return t.prototype.push=function(t){return t instanceof AbstractModal&&(t.id=++this.last_id,this[this.length++]=t,this.length>this.max_length&&this.shift().destroy()),this.length},t}()),Modals=function(){function t(){if("object"==typeof t.instance)return t.instance;this.collection=new ModalsCollection(5),this.active_modal=null,this.modal_wrapper=$(".modal_wrapper"),this.modal_destroyer=new e($(".modal_destroyer")),t.instance=this}var e=extendingJQuery(function(){function t(t){jQuery.fn.init.call(this,t),this.on("click.CloseModal",function(){AbstractModal.hideCurrent()})}return t.prototype.adjustHeight=function(t){var e=$(window).height(),i=t;return this.height(i>e?i:e)},t}());return t.prototype.bindCallModal=bindCallModal,t}(),AbstractModal=function(){function t(e){this.id=0,this.title="",this.type=this.constructor.name,this.style=e||t.STYLES.NONE,this.modal=$(),this.content_wrapper=$(),this.content="",this.scrollTop=0,this.wrapper_is_scrollable=!1,this.content_is_scrollable=!1,this.is_upload_disabled=!1,this.is_rendered=!1,this.is_inited=!1,this.is_shown=!1,__APP.MODALS.collection.push(this)}return t.prototype.modal_wrapper=(new Modals).modal_wrapper,Object.defineProperty(t.prototype,"block_scroll",{get:function(){return t.prototype.modal_wrapper.data("block_scroll")},set:function(e){return t.prototype.modal_wrapper.data("block_scroll",e)}}),t.hideCurrent=function(){__APP.MODALS.active_modal&&__APP.MODALS.active_modal.hide()},t.STYLES={NONE:0,OK_ONLY:1,OK_CANCEL:2,ABORT_RETRY_IGNORE:3,YES_NO_CANCEL:4,YES_NO:5,RETRY_CANCEL:6,CRITICAL:10,QUESTION:11,EXCLAMATION:12,INFORMATION:13},Object.freeze(t.STYLES),t.prototype.__render=function(e){var i;switch(this.style){case t.STYLES.OK_ONLY:i=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.PRIMARY,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"OK"});break;case t.STYLES.OK_CANCEL:i=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.PRIMARY,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"OK"},{classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Отмена"});break;case t.STYLES.ABORT_RETRY_IGNORE:i=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.MARGINAL_BUBBLEGUM,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Прервать"},{classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Повтор"},{classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Пропустить"});break;case t.STYLES.YES_NO_CANCEL:i=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.MARGINAL_FRANKLIN,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Да"},{classes:[__C.CLASSES.COLORS.MARGINAL_BUBBLEGUM,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Нет"},{classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Отмена"});break;case t.STYLES.YES_NO:i=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.MARGINAL_FRANKLIN,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Да"},{classes:[__C.CLASSES.COLORS.MARGINAL_BUBBLEGUM,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Нет"});break;case t.STYLES.RETRY_CANCEL:i=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Повтор"},{classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Отмена"})}return this.modal=__APP.BUILD.modal($.extend({type:this.type,title:this.title,content:this.content,footer_buttons:i},e)),this.content_wrapper=this.modal.find(".ModalContent"),this.is_rendered=!0,this.content||(this.content=this.content_wrapper.children()),this},t.prototype.__init=function(){function e(t){t.is_upload_disabled||t.block_scroll||(t.block_scroll=!0,t.onScrollToBottom(function(){t.block_scroll=!1,t.adjustDestroyerHeight()}))}var i=this;return this.is_rendered?(this.modal.find(".CloseModal").on("click.CloseModal",function(){t.hideCurrent()}),$(document).on("keyup.CloseModal",function(e){isKeyPressed(e,__C.KEY_CODES.ESC)&&($(this).off("keyup.CloseModal"),t.hideCurrent())}),this.wrapper_is_scrollable&&this.onScrollToBottom!==t.prototype.onScrollToBottom&&this.modal_wrapper.on("scroll",function(){i.modal_wrapper.height()+i.modal_wrapper.scrollTop()>=i.modal.height()&&e(i)}),this.content_is_scrollable&&(this.content.scrollbar({onScroll:this.onScrollToBottom!==t.prototype.onScrollToBottom?function(t){t.scroll===t.maxScroll&&e(i)}:void 0}),this.modal.on("modal:disappear",function(){i.content.scrollTop(0)})),this.is_inited=!0,this):(console.error("Modal has not been rendered yet"),this)},t.prototype.__show=function(){var e=this;return this.is_rendered?(t.hideCurrent(),$("body").addClass("-open_modal"),__APP.MODALS.active_modal=this,this.modal_wrapper.append(this.modal.addClass("-faded").removeClass(__C.CLASSES.HIDDEN)),this.adjustDestroyerHeight(),this.modal.trigger("modal:show"),setTimeout(function(){e.modal.removeClass("-faded"),e.modal_wrapper.scrollTop(e.scrollTop),e.modal.trigger("modal:appear"),e.is_shown=!0},200),this.is_inited||this.init(),this):this.render().show()},t.prototype.__hide=function(){var t=this;return this.scrollTop=this.modal_wrapper.scrollTop(),$(document).off("keyup.CloseModal"),$("body").removeClass("-open_modal"),__APP.MODALS.active_modal=void 0,this.modal.addClass("-faded"),this.modal.trigger("modal:disappear"),setTimeout(function(){t.modal.addClass(__C.CLASSES.HIDDEN).trigger("modal:close"),t.is_shown=!1},200),this},t.prototype.onScrollToBottom=function(t){return t.call(this),this},t.prototype.adjustDestroyerHeight=function(){return __APP.MODALS.modal_destroyer.adjustHeight(this.modal.outerHeight(!0)),this},t.prototype.render=function(t){return this.__render($.extend({classes:[__C.CLASSES.FLOATING_MATERIAL]},t))},t.prototype.init=function(){return this.__init()},t.prototype.show=function(){return this.__show()},t.prototype.hide=function(){return this.__hide()},t.prototype.destroyNested=function(){return this},t.prototype.destroy=function(){var t=__APP.MODALS.collection.indexOf(this);return this.hide(),__APP.MODALS.modal_wrapper.trigger("modal.beforeDestroy"),this.destroyNested(),this.modal.remove(),-1!=t&&__APP.MODALS.collection.splice(t,1),__APP.MODALS.modal_wrapper.trigger("modal.afterDestroy"),this},t}(),AddStaffModal=extending(AbstractModal,function(){function t(t,e){AbstractModal.call(this),this.org_id=t,this.organization=new OneOrganization(this.org_id),this.role=e}return t.prototype.render=function(){return this.content=tmpl("modal-add-staff-content",{modal_id:this.id,org_id:this.org_id,role:this.role}),this.__render({width:380,classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.SIZE.TINY],content_classes:[__C.CLASSES.ALIGN.CENTER]}),this},t.prototype.init=function(){function t(t){return __APP.BUILD.avatarBlocks(t,{avatar_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]}).outerHTML()}var e=this,i=this.content.find(".SearchByName");return bindRippleEffect(this.content),initSelect2(i,{width:"100%",placeholder:i.attr("placeholder"),ajax:{url:"/api/v1/users/",dataType:"JSON",data:function(t,e,i){return{name:t}},results:function(e,i,n){var a=new UsersCollection;return a.setData(e.data),{results:a,text:t}}},containerCssClass:"",dropdownCssClass:"form_select2_drop",formatResult:t,formatSelection:t}),this.content.find(".AddStaff").on("click",function(){var t=$(this).closest("form").serializeForm();e.organization.addStaff(t.user_id,t.role,function(i){__APP.CURRENT_PAGE.$view.trigger("staff:add",[t.role,i]),e.hide()})}),this},t}()),AuthModal=extending(AbstractModal,function(){function t(t,e){AbstractModal.call(this),this.content=tmpl("modal-auth-content",{heading:"Войдите через социальную сеть, чтобы совершить это действие"}),this.redirect_to=t,!1===e&&(this.hide=function(){})}return t.prototype.render=function(t){return this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.SIZE.TINY],content_classes:[__C.CLASSES.ALIGN.CENTER]}),this},t.prototype.init=function(){var t=this;return this.modal.find(".AuthButton").each(function(){$(this).on("click",function(e){var i=$(this).data("auth_network");window.yaCounter32442130&&window.yaCounter32442130.reachGoal(i.toUpperCase()+"AuthStart");try{window.localStorage.setItem("redirect_to",encodeURIComponent(t.redirect_to))}catch(e){}isNotDesktop()?window.location.href=__APP.AUTH_URLS[i]:window.open(__APP.AUTH_URLS[i],i.toUpperCase()+"_AUTH_WINDOW","status=1,toolbar=0,menubar=0&height=500,width=700"),e.preventDefault()})}),this.__init(),bindRippleEffect(this.modal),this},t}()),BitcoinModal=extending(AbstractModal,function(){function t(t,e){var i=[];AbstractModal.call(this),this.title="Оплата через Bitcoin",this.event=new OneEvent,this.order=new OneOrder,this.fetching_promise=$.Deferred().promise(),this.render_deferred=$.Deferred(),t instanceof OneEvent?this.event.setData(t):"number"==typeof t&&(this.event.id=t),e instanceof OneOrder?this.order.setData(e):"string"==typeof e&&(this.order.event_id=this.event.id,this.order.uuid=e),this.address=null,this.amount=null,i.push(this.order.fetchBitcoinData()),(empty(t)||"number"==typeof t)&&i.push(this.event.fetchEvent()),(empty(e)||"string"==typeof e)&&i.push(this.order.fetchOrder()),this.fetching_promise=__APP.SERVER.multipleAjax.apply(__APP.SERVER,i)}return t.prototype.render=function(t){var e=this;return this.fetching_promise.done(function(t){e.amount=t.amount,e.address=t.address,e.content=tmpl("modal-bitcoin-content",{order_number:formatTicketNumber(e.order.number),ticket_types:tmpl("modal-bitcoin-ticket-type-row",[]),event_id:e.event.id,order_uuid:e.order.uuid,bitcoin_amount:e.amount,bitcoin_address:e.address}),e.__render({classes:[__C.CLASSES.FLOATING_MATERIAL],width:480,content_classes:[__C.CLASSES.MODAL_STATES.NO_PADDING],footer_buttons:__APP.BUILD.button({classes:[__C.CLASSES.COLORS.MARGINAL,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Готово"})}),e.render_deferred.resolve()}),this},t.prototype.show=function(){var t=this;return this.render(),this.render_deferred.done(function(){t.__show()}),this},t}()),CityChooseModal=extending(AbstractModal,function(){function t(t){AbstractModal.call(this,AbstractModal.STYLES.OK_ONLY),this.cities=t,this.title="Выбор города"}return t.prototype.show=function(){var t=this;return this.cities?(this.__show(),this):(this.cities=new CitiesCollection,this.cities.fetchCities("timediff_seconds",0,"distance,local_name",function(){t.__show()}),this)},t.prototype.render=function(){return this.content=tmpl("modal-city-choose-content",{cities:tmpl("option",this.cities.map(function(t){return{val:t.id,display_name:t.local_name}}))}),this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL],width:400}),this},t.prototype.init=function(){return initSelect2(this.content.find("#city_choose_modal_select")).select2("val",1),this.__init(),this},t.prototype.hide=function(){__APP.USER.selected_city=this.cities.getByID(this.content.find("#city_choose_modal_select").val());try{localStorage.setItem("selected_city",JSON.stringify(__APP.USER.selected_city))}catch(t){}return this.__hide(),__APP.reload(),this},t}()),CropperModal=extending(AbstractModal,function(){function t(t,e){if(AbstractModal.call(this),!t)throw Error("To initiate cropper you need to pass image source (image_src)");e="object"==typeof e?e:{},this.image_src=t,this.content=tmpl("modal-cropper-content",{image_src:this.image_src}),this.options=$.extend({viewMode:1,responsive:!1,scalable:!1,zoomable:!1,zoomOnWheel:!1},e)}return t.prototype.render=function(){var t=this,e=this.content;return this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.SIZE.WIDE],content_classes:[__C.CLASSES.MODAL_STATES.NO_PADDING,__C.CLASSES.IMG_HOLDER],footer_buttons:tmpl("button",[{classes:[__C.CLASSES.COLORS.PRIMARY,"CropButton",__C.CLASSES.HOOKS.RIPPLE].join(" "),title:"Кадрировать"},{classes:[__C.CLASSES.COLORS.DEFAULT,"DestroyCropButton",__C.CLASSES.HOOKS.RIPPLE].join(" "),title:"Отмена"}])}),e.on("load",function(){e.cropper(t.options)}).attr("src",this.image_src),this},t.prototype.init=function(){var t=this;return this.modal.find(".CropButton").on("click.Crop",function(){t.crop(),t.hide()}),this.modal.find(".DestroyCropButton").on("click.DestroyCrop",function(){t.hide()}),this},t.prototype.destroyNested=function(){return this.content.cropper("destroy"),this.modal.find(".CropButton").off("click.Crop"),this.modal.find(".DestroyCropButton").off("click.DestroyCrop"),this},t.prototype.crop=function(){return this.modal.trigger("crop",[this.content.cropper("getCroppedCanvas").toDataURL()]),this},t}()),MapModal=extending(AbstractModal,function(){function t(t){if(AbstractModal.call(this),!t)throw Error("To initiate map you need to pass location (location)");this.location=t}return t.prototype.render=function(){return this.content=tmpl("modal-map-content",{iframe_height:$(window).height()-200,location:this.location}),this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.SIZE.WIDE],content_classes:[__C.CLASSES.MODAL_STATES.NO_PADDING]}),this},t.prototype.show=function(){var t=this,e=$(window);return e.on("resize.changeMapHeight",function(){t.content.height(e.height()-200),t.adjustDestroyerHeight()}),this.__show(),this},t.prototype.hide=function(){return $(window).off("resize.changeMapHeight"),this.__hide(),this},t}()),MediaModal=extending(AbstractModal,function(){function t(t,e){if(AbstractModal.call(this),!t)throw Error("To open media you need to pass media source (src)");"image"===e&&(this.content=tmpl("modal-image-media-content",{src:t})),this.src=t,this.format=e||"image"}return t.prototype.render=function(){return this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.SIZE.RESPONSIVE],content_classes:[__C.CLASSES.IMG_HOLDER,__C.CLASSES.MODAL_STATES.NO_PADDING]}),this},t.prototype.show=function(){var t=this;return this.content.on("load",function(){t.adjustDestroyerHeight()}),this.__show(),this},t}()),StdModal=extending(AbstractModal,function(){function t(t,e,i){AbstractModal.call(this,i),this.title=t,this.content=e}return t.STYLES=AbstractModal.STYLES,Object.freeze(t.STYLES),t}()),TicketsModal=extending(AbstractModal,function(){function t(t){if(AbstractModal.call(this),t instanceof ExtendedTicketsCollection)this.tickets=t;else{if(!(t instanceof Array||t instanceof OneExtendedTicket))throw Error("Constructor needs instance of OneExtendedTicket class to create new instance of TicketsModal");this.tickets=new ExtendedTicketsCollection,this.tickets.setData(t)}}return t.prototype.render=function(t){var e=this;return this.content=tmpl("modal-ticket-content",Builder.normalizeTicketProps(this.tickets).map(function(t,i){var n=e.tickets[i].order.payed_at||e.tickets[i].created_at;return t.cover_width=480,t.card_classes.push("-ticket_extended",__C.CLASSES.FLOATING_MATERIAL),$.extend(t,{cover_height:269,event_id:e.tickets[i].event.id,ticket_uuid:e.tickets[i].uuid,number_formatted:formatTicketNumber(e.tickets[i].number),payed_at_formatted:moment.unix(n).format(__LOCALES.ru_RU.DATE.DATE_TIME_FORMAT),price_formatted:+e.tickets[i].price?formatCurrency(e.tickets[i].price," ",".","","₽"):"Бесплатно"})})),this.__render({content_classes:[__C.CLASSES.MODAL_STATES.NO_PADDING]}),this},t}()),AbstractListModal=extending(AbstractModal,function(){function t(t){AbstractModal.call(this),this.content=tmpl("modal-list-content"),this.entity=t,this.entities=new EntitiesCollection,this.content_is_scrollable=!0}return t.prototype.render=function(){return this.__render({width:384,height:"calc(100% - 140px)",classes:["material","-floating","-fixed"],content_classes:["list_modal_content"]}),this},t.prototype.uploadEntities=function(){return $.Deferred.resolve().promise()},t.prototype.buildEntities=function(t){return $()},t.prototype.show=function(){var t=this;return this.content.children().length?(this.__show(),this):(this.render(),this.content.append(this.buildEntities(this.entities)),this.entities.length<5?this.uploadEntities().done(function(){t.__show()}):this.__show(),this)},t.prototype.onScrollToBottom=function(t){var e=this,i=__APP.BUILD.loaderBlock(this.content);return this.uploadEntities().fail(function(){e.block_scroll=!1}).done(function(){i.remove(),t.call(e)}),this},t}()),FriendsListModal=extending(AbstractListModal,function(){function t(e){if("object"==typeof t.instance)return t.instance;AbstractListModal.call(this,e),this.title="Подписки на пользователей",this.entities=this.entity.friends,t.instance=this}return t.prototype.uploadEntities=function(){var t=this;return __APP.USER.fetchFriends({length:20}).done(function(e){e.length?t.content.append(t.buildEntities(e)):t.is_upload_disabled=!0}).promise()},t.prototype.buildEntities=function(t){var e=__APP.BUILD.avatarBlocks(t,{is_link:!0,entity:__C.ENTITIES.USER,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]});return bindPageLinks(e),e},t}()),SubscriptionsListModal=extending(AbstractListModal,function(){function t(t){AbstractListModal.call(this,t),this.title="Подписки на организации",this.entities=this.entity.subscriptions}return t.prototype.uploadEntities=function(){var t=this;return this.entity.fetchSubscriptions({length:20}).done(function(e){e.length?t.content.append(t.buildEntities(e)):t.is_upload_disabled=!0}).promise()},t.prototype.buildEntities=function(t){var e=__APP.BUILD.avatarBlocks(t,{is_link:!0,entity:__C.ENTITIES.ORGANIZATION,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]});return bindPageLinks(e),e},t}()),PreviewRegistrationModal=extending(AbstractModal,function(){function t(t){AbstractModal.call(this),this.event=t,this.title="Регистрация"}return t.prototype.render=function(){var t=this;return this.__render({classes:["material","-floating"],width:400,content:tmpl("modal-registration-content",{modal_id:this.id,required_star:tmpl("required-star"),event_title:this.event.title,fields:$.makeSet(this.event.registration_fields.map(t.buildRegistrationField.bind(t)))})}),this},t.prototype.init=function(){return this.content.find(".RegisterButton").prop("disabled",!0),initSelect2(this.content.find(".ToSelect2"),{dropdownCssClass:"form_select2_drop form_select2_drop_no_search"}),this.__init(),this},t.prototype.buildRegistrationField=function(t){var e=this;switch(t.type){case RegistrationFieldModel.TYPES.SELECT:return function(t,e){return tmpl("form-unit",Builder.normalizeBuildProps($.extend(!0,{},t,{label:tmpl("label",Builder.normalizeBuildProps({id:t.id,label:t.label})),form_element:__APP.BUILD.select(e.map(function(t){return{display_name:t.value,val:t.uuid||guid()}}),{id:t.id,name:t.name,required:t.required},t.classes)})))}({id:"registration_form_"+e.id+"_"+t.uuid,name:t.uuid,unit_classes:["Registration"+t.type.toCamelCase("_")+"Field"],classes:["form_select2","ToSelect2"],label:$("<span>"+t.label+"</span>").add(t.required?tmpl("required-star"):$()),required:t.required},t.values instanceof Array?t.values:[]);case RegistrationFieldModel.TYPES.SELECT_MULTI:return function(t,e){return tmpl("form-unit",Builder.normalizeBuildProps($.extend(!0,{},t,{unit_classes:t.classes,label:tmpl("label",Builder.normalizeBuildProps({id:t.id+"_label",label:t.label})),form_element:__APP.BUILD.checkbox.apply(__APP.BUILD,e.map(function(e){return{id:"registration_field_value_"+(e.uuid||guid()),name:t.name,label:e.value,attributes:{value:e.uuid||guid(),required:t.required}}}))})))}({id:"registration_form_"+e.id+"_"+t.uuid,type:"checkbox",name:t.uuid,classes:["Registration"+t.type.toCamelCase("_")+"Field"],label:$("<span>"+t.label+"</span>").add(t.required?tmpl("required-star"):$()),required:t.required},t.values instanceof Array?t.values:[]);default:return __APP.BUILD.formUnit({id:"registration_form_"+this.id+"_"+t.uuid,type:t.type===RegistrationFieldModel.TYPES.EXTENDED_CUSTOM?"textarea":t.type,name:t.uuid,classes:["Registration"+t.type.toCamelCase("_")+"Field"],label:$("<span>"+t.label+"</span>").add(t.required?tmpl("required-star"):$()),placeholder:t.label,required:t.required,helptext:function(t){switch(t){case RegistrationFieldModel.TYPES.EMAIL:return"На почту Вам поступит сообщение с подтверждением регистрации";case RegistrationFieldModel.TYPES.FIRST_NAME:return"Используйте настоящее имя для регистрации";case RegistrationFieldModel.TYPES.LAST_NAME:return"Используйте настоящюю фамилию для регистрации";default:return""}}(t.type)})}},t}()),RegistrationModal=extending(PreviewRegistrationModal,function(){function t(t){PreviewRegistrationModal.call(this,t)}return t.prototype.init=function(){var t=this;return this.content.find(".RegisterButton").on("click.Register",function(){var e=$(this),i=e.closest(".RegistrationModalForm");e.attr("disabled",!0),isFormValid(i)?OneEvent.registerToEvent(t.event.id,i.serializeForm("array").map(function(t){return{uuid:t.name,value:t.value}})).always(function(){e.removeAttr("disabled")}).done(function(){t.modal.trigger("registration:success"),t.hide()}):e.removeAttr("disabled")}),this.content.find(".RegistrationFirstNameField").val(__APP.USER.first_name),this.content.find(".RegistrationLastNameField").val(__APP.USER.last_name),this.content.find(".RegistrationEmailField").val(__APP.USER.email),bindRippleEffect(this.content),initSelect2(this.content.find(".ToSelect2"),{dropdownCssClass:"form_select2_drop form_select2_drop_no_search"}),this.__init(),this},t}()),AbstractUsersModal=extending(AbstractModal,function(){function t(e,i){if(AbstractModal.call(this),this.title=i,this.entity_id=e,this.entities_length=30,this.is_upload_disabled=!1,this.users=new UsersCollection,this.is_first=!0,this.wrapper_is_scrollable=!0,this.constructor===t)throw new Error("Can't instantiate abstract class!")}return t.prototype.show=function(){var t=this;return this.block_scroll=!1,this.users.length?(this.__show(),this):(this.render({width:"60%"}),this.uploadUsers(function(){t.__show()}),this)},t.prototype.init=function(){return bindPageLinks(this.modal),this.__init(),this},t.prototype.onScrollToBottom=function(t){var e=this;return this.uploadUsers(function(){t.call(e)}),this},t.prototype.hide=function(){return this.block_scroll=!1,this.modal_wrapper.off("scroll.uploadUsers"),this.__hide(),this},t.prototype.uploadUsers=function(t){},t.prototype.buildUsers=function(t){var e=$(),i="true"==this.content_wrapper.find(".UserTombstone").eq(-1).data("is_friend"),n=this;return t.forEach(function(t,a){(n.is_first&&!a||i!=t.is_friend)&&(e=e.add(tmpl("modal-users-divider",{label:t.is_friend?"Друзья":"Все"})),i=t.is_friend),e=e.add(__APP.BUILD.userTombstones(t,{tombstone_classes:["UserTombstone"],is_link:!0,dataset:{is_friend:t.is_friend}}))}),e},t.prototype.afterUpload=function(t){var e,i=this;t.length?(e=this.buildUsers(t),this.content_wrapper.append(e),this.is_first=!1,this.entities_length=10,this.adjustDestroyerHeight(),bindPageLinks(e),e.on("click.hideModal",function(){i.hide()})):this.is_upload_disabled=!0},t}()),EditorsModal=extending(AbstractUsersModal,function(){function t(t,e,i){AbstractUsersModal.call(this,t,e||"Редакторы"),this.ajax_data={order_by:"role,first_name"},i&&(this.ajax_data.roles=i)}return t.prototype.uploadUsers=function(t){var e=this;return this.users.fetchOrganizationStaff(this.entity_id,this.entities_length,this.ajax_data,function(i){e.afterUpload(i),t&&"function"==typeof t&&t(i)})},t.prototype.buildUsers=function(t){
var e=$(),i=this.content_wrapper.find(".UserTombstone").last().data("role"),n={admin:"Администраторы",moderator:"Модераторы"},a=this;return t.forEach(function(t,r){(a.is_first&&!r||i!=t.role)&&(e=e.add(tmpl("modal-users-divider",{label:n[t.role]})),i=t.role),e=e.add(__APP.BUILD.userTombstones(t,{tombstone_classes:["UserTombstone"],is_link:!0,dataset:{role:t.role}}))}),e},t}()),FavoredModal=extending(AbstractUsersModal,function(){function t(t,e){if(!t)throw Error("To open favored modal you need to pass event_id");AbstractUsersModal.call(this,t,e||"Добавили в избранное"),this.ajax_data={fields:["is_friend"],order_by:"-is_friend,first_name"}}return t.prototype.uploadUsers=function(t){var e=this;return this.users.fetchEventFavorites(this.entity_id,this.entities_length,this.ajax_data,function(i){e.afterUpload(i),t&&"function"==typeof t&&t(i)})},t}()),SubscribersModal=extending(AbstractUsersModal,function(){function t(t,e){if(!t)throw Error("To open favored modal you need to pass organization_id");AbstractUsersModal.apply(this,[t,e||"Подписались"]),this.entity_id=t,this.ajax_data={fields:["is_friend"],order_by:"-is_friend,first_name"}}return t.prototype.uploadUsers=function(t){var e=this;return this.users.fetchOrganizationSubscribers(this.entity_id,this.entities_length,this.ajax_data,function(i){e.afterUpload(i),t&&"function"==typeof t&&t(i)})},t}()),Builder=function(){function t(){if("object"==typeof t.instance)return t.instance;t.instance=this}return t.normalizeBuildProps=function(t,e,i,n){return t=t||{},e?e.push("classes"):e=["classes"],i?i.push("dataset"):i=["dataset"],n?n.push("attributes"):n=["attributes"],e.forEach(function(e){t[e]=t[e]?"string"==typeof t[e]?t[e].split(" "):t[e]:[],t[e].toString=Array.toSpaceSeparatedString}),i.forEach(function(e){t[e]=t[e]?t[e]:{},t[e].toString=Array.isArray(t[e])?Array.toSpaceSeparatedString:Object.toHtmlDataSet}),n.forEach(function(e){t[e]=t[e]?t[e]:{},t[e].toString=Array.isArray(t[e])?Array.toSpaceSeparatedString:Object.toHtmlAttributes}),t},t.prototype.button=function(){var e=Array.prototype.slice.call(arguments);return tmpl("button",e.map(function(e){return t.normalizeBuildProps(e)})).each(function(t,i){var n=e[t],a=$(i);n.dataset&&a.data(n.dataset),n.classes&&n.classes.contains(__C.CLASSES.HOOKS.RIPPLE)&&(bindRippleEffect(a),a.addClass(__C.CLASSES.HOOKS.HANDLED+__C.CLASSES.HOOKS.RIPPLE))})},t.prototype.input=function(e,i,n){return tmpl("input",t.normalizeBuildProps({classes:i,attributes:e,dataset:n})).each(function(t,e){n&&$(e).data(n)})},t.prototype.inputNumber=function(t,e,i,n){return t=$.extend({},t),e=e?e instanceof Array?e:e.split(","):[],i=i||{},this.input(t,e.concat("form_input"),i).inputmask($.extend({alias:"numeric",autoGroup:!1,digits:2,digitsOptional:!0,allowPlus:!1,allowMinus:!1,rightAlign:!1},n))},t.prototype.select=function(e,i,n,a,r){var o;return e.unshift({id:"-1"}),o=tmpl("select",t.normalizeBuildProps({options:__APP.BUILD.option(e),classes:n,attributes:i,dataset:a})),a&&o.data(a),o.val(r||"-1"),o},t.prototype.dateSelect=function(e,i,n,a,r,o){var s=tmpl("date-select",t.normalizeBuildProps({name:e,label:i,value:n,attributes:a||{},classes:r||[],dataset:o||{}}));return new DatePicker(s,o||{}).init(),s.addClass("-Handled_DatePicker"),s},t.prototype.textarea=function(e,i,n,a){return tmpl("textarea",t.normalizeBuildProps({value:n,classes:i,attributes:e,dataset:a})).each(function(t,e){a&&$(e).data(a)})},t.prototype.link=function(e){return bindPageLinks(tmpl("link",[].map.call(arguments,function(e){return t.normalizeBuildProps(e)})))},t.prototype.linkButton=function(e){return bindPageLinks(tmpl("link-button",[].map.call(arguments,function(e){return t.normalizeBuildProps(e)})))},t.prototype.actionLink=function(e,i,n,a,r){return tmpl("action-link",t.normalizeBuildProps({href:e,title:i,classes:n,dataset:a,attributes:r}))},t.prototype.actionButton=function(e){var i=e instanceof Array?e:[].slice.call(arguments);return tmpl("action-button",i.map(function(e){return t.normalizeBuildProps(e)})).each(function(t){$(this).data(i[t].dataset)})},t.prototype.option=function(e){var i=e instanceof Array?e:arguments;return tmpl("option",[].map.call(i,function(e){return t.normalizeBuildProps(e)})).each(function(t,e){i[t].dataset&&$(e).data(i[t].dataset)})},t.prototype.switch=function(e,i,n,a,r,o){var s=t.normalizeBuildProps({id:e,name:i,attributes:a,classes:r,dataset:o});return n?s.attributes.checked=n:delete s.attributes.checked,s.attributes.tabindex=s.attributes.tabindex?s.attributes.tabindex:-1,tmpl("switch",s)},t.prototype.radioCheckbox=function(e,i){if("checkbox"===e||"radio"===e)return i=t.normalizeBuildProps(i,["unit_classes"]),-1===i.classes.indexOf("form_checkbox")&&-1===i.classes.indexOf("form_radio")&&i.classes.unshift("form_"+e),i.unit_classes.unshift("form_unit"),i.attributes.checked||delete i.attributes.checked,i.attributes.tabindex=i.attributes.tabindex?i.attributes.tabindex:-1,tmpl("radio-checkbox",$.extend(i,{type:e}));throw Error('Принимаемый аргумент type может быть либо "radio" либо "checkbox", придурок')},t.prototype.radio=function(t){var e=this;return $.makeSet([].map.call(arguments,function(t){return e.radioCheckbox("radio",t)}))},t.prototype.checkbox=function(t){var e=this,i=t instanceof Array?t:arguments;return $.makeSet([].map.call(i,function(t){return e.radioCheckbox("checkbox",t)}))},t.prototype.radioGroup=function(e){var i,n=this,a=$.extend({},t.normalizeBuildProps(e));return a.units instanceof jQuery||(a.units=n.radio.apply(n,a.units.map(function(t){var e=$.extend(t,{name:a.name});return e.id||(e.id=guid()),e}))),i=tmpl("radio-group",a),i.data(e.dataset),i},t.prototype.formHelpText=function(e,i,n){return tmpl("form-helptext",t.normalizeBuildProps({text:e,dataset:i,attributes:n}))},t.prototype.formUnit=function(e){var i=this,n=["hidden","text","search","tel","url","email","password","date","time","number","range","color","checkbox","radio","file","submit","image","reset","button"];return $.makeSet(Array.prototype.map.call(arguments,function(e){switch(e.type){case"radio":return i.radio(e);case"checkbox":return i.checkbox(e);default:return tmpl("form-unit",t.normalizeBuildProps({unit_classes:e.unit_classes||[],label:e.label?tmpl("label",t.normalizeBuildProps({id:e.id,label:e.label,label_classes:e.label_classes},["label_classes"])):"",helptext:e.helptext?i.formHelpText(e.helptext,e.helptext_dataset,e.helptext_attributes):"",form_element:function(t){var e=t.classes?t.classes instanceof Array?t.classes:t.classes.split(","):[],a={id:t.id,name:t.name,required:t.required?t.required:void 0,readonly:t.readonly?t.readonly:void 0,placeholder:t.placeholder,tabindex:t.tabindex};switch(t.type){case"date":return i.dateSelect(t.name,t.value?moment(t.value).format(__LOCALE.DATE.DATE_FORMAT):"Дата",t.value,$.extend({},t.attributes,{required:t.required?t.required:void 0}),e,t.dataset);case"textarea":return i.textarea($.extend({},t.attributes,a),e.concat("form_textarea"),t.value,t.dataset);case"time":return i.input($.extend({},t.attributes,a,{value:null!=t.value?t.value:void 0,placeholder:"23:59"}),e.concat("form_input","-time_input"),t.dataset).inputmask("hh:mm",{insertMode:!1,clearIncomplete:!0,placeholder:"  :  ",greedy:!1,showMaskOnHover:!1});case"switch":return i.switch(t.id,t.name,t.checked,$.extend({required:t.required?t.required:void 0,placeholder:t.placeholder,tabindex:t.tabindex},t.attributes),t.classes,t.dataset);case"number":return i.inputNumber($.extend({},t.attributes,a,{autocomplete:"off",value:empty(t.value)?void 0:t.value}),e,t.dataset,t.inputmask);default:return i.input($.extend({},t.attributes,a,{type:t.type&&-1!==n.indexOf(t.type)?t.type:"text",value:null!=t.value?t.value:void 0}),e.concat("form_input"),t.dataset)}}(e)},["unit_classes"]))}}))},t.prototype.cap=function(e,i){return tmpl("cap",$.extend({message:e},t.normalizeBuildProps(i||{})))},t.prototype.overlayCap=function(e,i){return tmpl("overlay-cap",$.extend({content:e},t.normalizeBuildProps(i||{})))},t.prototype.tags=function(e,i){function n(t){return $.extend(!0,{},{name:t.name.toLowerCase(),page:"/search/tag/"+encodeURIComponent(t.name.toLowerCase())},i)}return i=t.normalizeBuildProps(i),e instanceof Array?tmpl("tag",e.map(n)):tmpl("tag",n(e))},t.prototype.orderStatusBlock=function(t){return tmpl("order-status",{name:localeFromNamespace(t,OneOrder.EXTENDED_ORDER_STATUSES,__LOCALE.TEXTS.TICKET_STATUSES),status:function(t){switch(!0){case OneOrder.isGreenStatus(t):return"success";case OneOrder.isYellowStatus(t):return"warning";case OneOrder.isRedStatus(t):return"error"}}(t)})},t.prototype.loaderBlock=function(t,e){return tmpl("loader-block",{loader:tmpl("loader")},t,e)},t.prototype.overlayLoader=function(t,e){return tmpl("loader-block",{classes:"-loader_overlay",loader:tmpl("loader")},t,e)},t.prototype.fields=function(t){var e;return e=1===arguments.length?[t]:[].slice.call(arguments),$.makeSet(e.map(function(t){return t instanceof Array?tmpl("fields-wrapper",{classes:"-columns_"+t.length,fields:tmpl("field",t)}):tmpl("field",t)}))},t.prototype.socialLinks=function(e,i){var n=[],a={VK:"vk",GOOGLE:"google-plus",FACEBOOK:"facebook-official"};return $.each(OneUser.ACCOUNTS,function(r,o){var s={slug:o,icon_slug:a[r]};e.hasOwnProperty(o)?(s.html_tag="a",s.attributes={href:e[o],target:"_blank"}):s.html_tag="span",n.push(t.normalizeBuildProps($.extend(s,i)))}),tmpl("user-social-links-wrapper",{links:tmpl("user-social-link",n)})},t.prototype.userTombstones=function(e,i){var n=this;return i=t.normalizeBuildProps(i,["avatar_classes","tombstone_classes"]),i.avatar_classes.push("-rounded"),i.avatar_classes.push("-size_"+(i.size?i.size:"70x70")),i.is_link?(i.html_tag="a",i.tombstone_classes.push("link Link")):i.html_tag="div",tmpl("user-tombstone",(e instanceof Array?e:[e]).map(function(t){return i.is_link&&(i.attributes.href="/user/"+t.id),$.extend(!0,{},t,{avatar:n.avatars(t,{classes:i.avatar_classes}),name:t.full_name?t.full_name:[t.first_name,t.last_name].join(" ")},i)}))},t.prototype.avatarBlocks=function(e,i){var n=this;return i=t.normalizeBuildProps(i,["avatar_classes","block_classes"]),i.is_link?(i.html_tag="a",i.block_classes.push("link","Link")):i.html_tag="div",tmpl("avatar-block",(e instanceof Array?e:[e]).map(function(t){var e,a;return i.entity&&i.entity===__C.ENTITIES.USER||t instanceof OneUser||t.first_name?(e=t.full_name?t.full_name:t.first_name+" "+t.last_name,a="/user/"+t.id):(e=t.short_name?t.short_name:t.name,a="/organization/"+t.id),$.extend(!0,{id:t.id,avatar:n.avatars(t,{classes:i.avatar_classes}),attributes:{href:a},name:e},i)}))},t.prototype.staffAvatarBlocks=function(t,e,i,n){var a=this;return tmpl("staff-avatar-block",e.map(function(t){return{avatar_block:a.avatarBlocks(t,i),can_edit:n?"-can_edit":""}})).each(function(t,n){var a={user:e[t]};i&&i.dataset&&$.extend(a,i.dataset),$(n).data(a)}).find(".RemoveStaff").on("click.RemoveStaff",function(){var e=$(this).closest(".StaffAvatarBlock"),i=e.data("user"),n=tmpl("staff-avatar-block-removing",{username:[i.first_name,i.last_name].join(" ")});OneOrganization.removeStaff(t,i.id,i.role).done(function(){e.after(n),e.detach(),n.find(".ReturnStaff").on("click",function(){OneOrganization.addStaff(t,i.id,i.role).done(function(){n.after(e),n.remove()})})})}).end()},t.prototype.addUserAvatarBlock=function(e,i,n){var a;switch(n=t.normalizeBuildProps(n,["avatar_classes","block_classes"]),n.block_classes.push("link",__C.CLASSES.HOOKS.ADD_STAFF,__C.CLASSES.HOOKS.CALL_MODAL),i){case OneUser.ROLE.ADMIN:a="Добавить администратора";break;case OneUser.ROLE.MODERATOR:a="Добавить модератора"}return tmpl("avatar-block",$.extend({html_tag:"div",name:a,avatar:tmpl("avatar",{classes:n.avatar_classes,avatar_url:window.location.origin+"/app/img/add_user.svg"})},n)).data({modal_type:"add_staff",modal_org_id:e,modal_role:i})},t.prototype.avatars=function(e,i){function n(t){return $.extend(!0,{avatar_url:t.avatar_url,name:t.full_name?t.full_name:t.first_name+" "+t.last_name},i)}function a(t){return $.extend(!0,{avatar_url:t.img_small_url?t.img_small_url:t.img_url,name:t.short_name?t.short_name:t.name},i)}var r,o=function(){},s=[];if(!(!e||e instanceof Array&&!e.length)){switch(i=t.normalizeBuildProps(i),!0){case e instanceof OneUser:case e instanceof UsersCollection:o=n;break;case e instanceof OneOrganization:case e instanceof OrganizationsCollection:o=a;break;default:s=e instanceof Array?e:[e],o=s[0].avatar_url?n:a}return r=e instanceof Array?e:[e],tmpl("avatar",r.map(o))}},t.prototype.avatarCollection=function(e,i,n,a){var r=t.normalizeBuildProps(n,["counter_classes"]),o=i;return r.dataset.max_amount=i,r.classes.push("-max_"+i),r.avatars=this.avatars(__APP.USER).add(this.avatars(e.filter(function(t){return __APP.USER.id!=t.id&&!(o--<=0)}))),r.more_avatars_count=(a||e.length)-i,r.more_avatars_count<=0&&r.counter_classes.push("-cast"),tmpl("avatars-collection",r)},t.prototype.activity=function(e,i){var n=this instanceof t?this:new t,a={};return a[OneAbstractActivity.TYPES.SUBSCRIBE]="plus",a[OneAbstractActivity.TYPES.FAVE]="star",a[OneAbstractActivity.TYPES.UNSUBSCRIBE]=a[OneAbstractActivity.TYPES.UNFAVE]="minus",i=t.normalizeBuildProps(i,["avatar_classes"]),i.avatar_classes.push(__C.CLASSES.SIZES.X50,__C.CLASSES.UNIVERSAL_STATES.ROUNDED),tmpl("activity-block",(e instanceof Array?e:[e]).map(function(t){var e={},r=__LOCALES.ru_RU.TEXTS.ACTIVITY[OneAbstractActivity.TYPES_INDEX[t.type_code]];switch(!0){case t instanceof OneOrganizationActivity:e={entity:"organization",img_url:t.organization.img_small_url?t.organization.img_small_url:t.organization.img_url,entity_url:"/organization/"+t.organization.id,hero_text:t.organization.short_name};break;case t instanceof OneEventActivity:e={entity:"event",img_url:t.event.image_horizontal_small_url?t.event.image_horizontal_small_url:t.event.image_horizontal_url,entity_url:"/event/"+t.event.id,hero_text:t.event.title}}return $.extend(e,{creator_avatar:n.avatars(t.user,{classes:i.avatar_classes,is_link:i.avatar_is_link,badge:tmpl("avatar-badge",{icon_class:a[t.type_code]})}),type_code:t.type_code,additional_info:getGenderText(t.user.gender,r),creator_url:"/user/"+t.user.id,creator_name:t.user.full_name?t.user.full_name:t.user.first_name+" "+t.user.last_name,date:moment.unix(t.created_at).calendar(null,__LOCALES.ru_RU.DATE.CALENDAR_DATE_TIME)})}))},t.prototype.organizationItems=function(e,i){e=e instanceof Array?e:[e];var n=this;return tmpl("organization-item",e.map(function(t){return t.counter_classes=t.new_events_count?[]:[__C.CLASSES.HIDDEN],t}).map(function(e){return $.extend(!0,{avatar_block:n.avatarBlocks(e,{entity:__C.ENTITIES.ORGANIZATION,avatar_classes:[__C.CLASSES.SIZES.X30]})},e,t.normalizeBuildProps(i,["avatar_classes","block_classes","counter_classes"]))}))},t.prototype.organizationCard=function(t){var e=this;return tmpl("organization-card",t.map(function(t){return $.extend(!0,{},t,{background_image:t.background_small_img_url||t.background_img_url?e.link({page:"/organization/"+t.id,classes:["organization_unit_background"],attributes:{style:"background-image: url("+(t.background_small_img_url||t.background_img_url)+")"}}):"",avatar:e.avatars(t,{classes:["organization_unit_avatar",__C.CLASSES.SIZES.X55,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.SHADOWED]}),subscribe_button:new SubscribeButton(t.id,{is_checked:t.is_subscribed,colors:{unchecked:__C.CLASSES.COLORS.MARGINAL_ACCENT,unchecked_hover:__C.CLASSES.COLORS.MARGINAL_ACCENT},has_icons:!1,classes:[__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.RIPPLE]}),subscribed_text:t.subscribed_count+getUnitsText(t.subscribed_count,__LOCALES.ru_RU.TEXTS.SUBSCRIBERS),redact_org_button:t.role===OneUser.ROLE.UNAUTH||t.role===OneUser.ROLE.USER?"":e.link({classes:["button",__C.CLASSES.SIZES.LOW,__C.CLASSES.COLORS.MARGINAL_PRIMARY,__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.PENCIL,__C.CLASSES.UNIVERSAL_STATES.EMPTY,__C.CLASSES.HOOKS.RIPPLE],page:"/admin/organization/"+t.id+"/edit"})})}))},t.prototype.eventBlocks=function(t,e){var i=this;return tmpl("event-block",t.map(function(t){var n=e.sort_date_type?e.sort_date_type:"nearest_event_date",a=moment.unix(t[n]?t[n]:t.first_event_date),r=e.last_date!==a.format(__C.DATE_FORMAT),o=[__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.SIZES.SMALL,__C.CLASSES.HOOKS.ADD_AVATAR.COLLECTION,__C.CLASSES.HOOKS.CALL_MODAL];return t.is_favorite&&o.push(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED),e.last_date=a.format(__C.DATE_FORMAT),$.extend({},t,{cover_width:550,divider:r?tmpl("divider",{title:a.calendar().capitalize()}):"",action_buttons:new AddToFavoriteButton(t.id,{is_add_avatar:!0,is_checked:t.is_favorite,classes:["event_block_main_action_button",__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.ADD_TO_FAVORITES,__C.CLASSES.HOOKS.RIPPLE]}),date:a.format(__C.DATE_FORMAT),avatars_collection:i.avatarCollection(t.favored,3,{dataset:{modal_type:"favors",modal_event_id:t.id},classes:o,counter_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.COLORS.MARGINAL,__C.CLASSES.HOOKS.ADD_AVATAR.STATES.CASTABLE]},t.favored_users_count),time:t.dates.reduce(function(t,e){return moment.unix(e.event_date).format(__C.DATE_FORMAT)===a.format(__C.DATE_FORMAT)&&t.push(displayTimeRange(e.start_time,e.end_time)),t},[]).join("; ")})}))},t.prototype.organisationsCategoriesItems=function(t){return t instanceof Array||(t=[t]),tmpl("organization-category",t.map(function(t){var e,i=[];return t.organizations&&t.organizations.new_events_count?(e=t.organizations.reduce(function(t,e){return t+e.new_events_count},0),i=e?["counter"]:["counter",__C.CLASSES.HIDDEN]):(e="",i=[__C.CLASSES.HIDDEN]),{category_id:t.id,category_name:t.name,order_position:t.order_position,aside_classes:i,new_events_count:"+"+e}}))},t.prototype.subscribers=function(t,e){var i=this;return tmpl("subscriber",t.map(function(t,n){var a=void 0===e||e!==t.is_friend;return e=t.is_friend,{divider:a?tmpl("subscriber-divider",{label:t.is_friend?"Друзья":"Все подписчики"}):"",avatar_block:i.avatarBlocks(t,{is_link:!0,entity:__C.ENTITIES.USER,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.UNIVERSAL_STATES.SHADOWED],block_classes:["subscriber"]})}}))},t.prototype.eventCards=function(t){var e,i=this,n=t instanceof Array?t:[t];return e=tmpl("event-card",n.map(function(t){var e=[__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.SIZES.SMALL,__C.CLASSES.HOOKS.ADD_AVATAR.COLLECTION,__C.CLASSES.HOOKS.CALL_MODAL],n=[],a=new OneOrganization(t.organization_id);return a.setData({short_name:t.organization_short_name,img_url:t.organization_logo_small_url}),t.is_favorite&&e.push(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED),n.push({text:displayDateRange(t.dates[0].event_date,t.dates[t.dates.length-1].event_date)+(t.is_same_time?", "+displayTimeRange(t.dates[0].start_time,t.dates[0].end_time):"")}),t.registration_required&&t.registration_till&&n.push({text:"Регистрация до "+moment.unix(t.registration_till).calendar().toLowerCase()}),t.is_free?n.push({text:"Бесплатно"}):n.push({text:"Цена от "+(t.min_price?formatCurrency(t.min_price):0)+" руб."}),$.extend(!0,{cover_width:405,organization_avatar_block:i.avatarBlocks(a,{block_classes:[__C.CLASSES.SIZES.SMALL],is_link:!0,entity:__C.ENTITIES.ORGANIZATION}),action_button:new AddToFavoriteButton(t.id,{is_add_avatar:!0,is_checked:t.is_favorite,classes:[__C.CLASSES.SIZES.LOW,__C.CLASSES.SIZES.WIDE,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.RIPPLE]}),avatars_collection:i.avatarCollection(t.favored,4,{dataset:{modal_type:"favors",modal_event_id:t.id},classes:e,counter_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.COLORS.MARGINAL_PRIMARY,__C.CLASSES.HOOKS.ADD_AVATAR.STATES.CASTABLE]},t.favored_users_count),feed_event_infos:tmpl("event-card-info",n),header_buttons:__APP.USER.isLoggedOut()?"":i.button({classes:["feed_event_header_button","feed_event_header_button_hide_event",__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.EMPTY,"HideEvent"],dataset:{"event-id":t.id},title:"×"})},t)})),n.forEach(function(t,i){e.eq(i).appear(function(){storeStat(t.id,__C.STATS.EVENT_ENTITY,__C.STATS.EVENT_VIEW)},{accY:100})}),e},t.prototype.registrationFields=function(t){if(t instanceof RegistrationField)t=[t];else if(!(t instanceof Array))throw TypeError("Component builder accepts only RegistrationFieldsCollection, RegistrationField or array of RegistrationField object types");var e=$(),i=[],n=[RegistrationField.TYPES.EMAIL,RegistrationField.TYPES.PHONE_NUMBER,RegistrationField.TYPES.ADDITIONAL_TEXT,RegistrationField.TYPES.CUSTOM,RegistrationField.TYPES.SELECT,RegistrationField.TYPES.SELECT_MULTI,RegistrationField.TYPES.EXTENDED_CUSTOM];return(t.__types[RegistrationField.TYPES.FIRST_NAME].length||t.__types[RegistrationField.TYPES.LAST_NAME].length)&&(t.__types[RegistrationField.TYPES.LAST_NAME].length&&i.push({name:"Фамилия",value:t.__types[RegistrationField.TYPES.LAST_NAME][0].value}),t.__types[RegistrationField.TYPES.FIRST_NAME].length&&i.push({name:"Имя",value:t.__types[RegistrationField.TYPES.FIRST_NAME][0].value}),e=e.add(tmpl("fields-wrapper",{classes:2===i.length?"-columns_2":"",fields:tmpl("field",i)}))),e.add(tmpl("field",n.reduce(function(e,i){return i===RegistrationField.TYPES.FIRST_NAME||i===RegistrationField.TYPES.LAST_NAME?e:e.concat(t.__types[i].map(function(t){return{name:t.label||RegistrationField.DEFAULT_LABEL[i],value:function(t){switch(t.type){case RegistrationFieldModel.TYPES.SELECT:case RegistrationFieldModel.TYPES.SELECT_MULTI:return t.values&&t.values.length?t.values.map(function(t){return t.value}).join(", "):"—";default:return t.value||"—"}}(t)}}))},[])))},t.normalizeTicketProps=function(e){return(e instanceof Array?e:[e]).map(function(e){var i,n=t.normalizeBuildProps({card_classes:[],title:e.event.title,location:e.event.location,status_name:e.status_name,status_type_code:e.status_type_code,ticket_type_name:e.ticket_type.name,image_horizontal_url:e.event.image_horizontal_url,image_horizontal_large_url:e.event.image_horizontal_large_url||e.event.image_horizontal_url,image_horizontal_medium_url:e.event.image_horizontal_medium_url},["card_classes"]);switch(!0){case OneOrder.isGreenStatus(n.status_type_code):n.card_classes.push(__C.CLASSES.STATUS.SUCCESS);break;case OneOrder.isYellowStatus(n.status_type_code):n.card_classes.push(__C.CLASSES.STATUS.PENDING);break;case OneOrder.isRedStatus(n.status_type_code):n.card_classes.push(__C.CLASSES.STATUS.ERROR)}return n.card_classes.push(OneOrder.isDisabledStatus(n.status_type_code)?__C.CLASSES.DISABLED:__C.CLASSES.HOOKS.CALL_MODAL),e.event.is_same_time?(i=e.event.dates[0],n.formatted_dates=displayDateRange(i.event_date,e.event.dates[e.event.dates.length-1].event_date)+", "+displayTimeRange(i.start_time,i.end_time)):(i=e.event.nearest_event_date,n.formatted_dates=displayDateRange(i,i)),n})},t.prototype.ticketCards=function(e){return tmpl("ticket-card",t.normalizeTicketProps(e).map(function(t){return t.cover_width=260,t})).each(function(t,i){$(i).data({modal_type:__C.MODAL_TYPES.TICKET,tickets:e[t]})})},t.prototype.modal=function(e){var i,n=t.normalizeBuildProps(e,["content_classes"]),a={modal_header:"",modal_type:n.type,modal_content:n.content,modal_classes:n.classes,modal_content_classes:n.content_classes,modal_footer:""};return n.header?a.modal_header=n.header:n.title&&(a.modal_header=tmpl("modal-header",{title:n.title,close_button:this.button({classes:[__C.CLASSES.UNIVERSAL_STATES.EMPTY,"-modal_destroyer",__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"×"})})),n.footer?a.modal_footer=n.footer:n.footer_buttons&&(a.modal_footer=tmpl("modal-footer",{footer_buttons:n.footer_buttons})),i=tmpl("modal",a),n.width&&i.width(n.width),n.height&&i.height(n.height),i},t}(),AbstractSidebar=function(){function t(){this.$sidebar=$("#main_sidebar"),this.$subscribed_orgs=$(".SidebarOrganizationsList")}return t.prototype.init=function(){this.$sidebar.find(".SidebarNav").addClass("-items_"+this.$sidebar.find(".SidebarNavItem").not(".-hidden").length),this.$sidebar.find(".SidebarScroll").scrollbar()},t.prototype.updateSubscriptions=function(){},t}(),Sidebar=extending(AbstractSidebar,function(){function t(){AbstractSidebar.call(this)}return t.prototype.init=function(){var t=this;t.updateSubscriptions(),$(window).on("subscribe unsubscribe",function(){t.updateSubscriptions()}),AbstractSidebar.prototype.init.call(this)},t.prototype.updateSubscriptions=function(){var t=this.$subscribed_orgs,e=0,i=$.map(t.children(),function(t){return $(t).data("organization_id")}),n=__APP.USER.subscriptions.filter(function(t){return-1===i.indexOf(t.id)}),a=i.filter(function(t){return!__APP.USER.subscriptions.has(t)});n.length&&(__APP.BUILD.organizationItems(n,{block_classes:["animated"],avatar_classes:["-size_30x30"]})[t.length?"prependTo":"appendTo"](t).each(function(t,i){setTimeout(function(){$(i).addClass("-show")},e+=100)}),bindPageLinks(t)),a.length&&a.forEach(function(e){var i=t.find('.organization_item[data-organization_id="'+e+'"]').removeClass("-show");setTimeout(function(){i.remove()},500)})},t}()),SidebarNoAuth=extending(AbstractSidebar,function(){function t(){AbstractSidebar.call(this)}return t.prototype.init=function(){this.$sidebar.find(".SidebarOrganizationsScroll").addClass(__C.CLASSES.HIDDEN),AbstractSidebar.prototype.init.call(this)},t}()),AppInspectorComponents=function(){function t(){if("object"==typeof t.instance)return t.instance;t.instance=this}return t.prototype.avatarBlock=function(t){return bindPageLinks(__APP.BUILD.avatarBlocks(t,{is_link:!0,entity:__C.ENTITIES.USER,avatar_classes:[__C.CLASSES.SIZES.X50,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]}))},t.prototype.title=function(t){return tmpl("app-inspector-title",{title:t})},t.prototype.tickets=function(t){var e;return e=arguments.length>1?[].slice.call(arguments):t instanceof Array?t:[t],tmpl("app-inspector-ticket",e.map(function(t){return{fields:tmpl("fields-wrapper",[{classes:"-columns_2",fields:tmpl("field",[{name:"Номер",value:formatTicketNumber(t.number)},{name:"Цена",value:t.price?t.price:"Бесплатно"}])},{classes:"-field_big",fields:tmpl("field",{name:"Название",value:t.ticket_type.name})}]),footer:t.checkout?tmpl("app-inspector-ticket-footer"):""}})).each(function(t,i){$(i).data("ticket",e[t])})},t.prototype.event=function(t){return bindPageLinks(tmpl("app-inspector-event",t))},t}(),AbstractAppInspector=extendingJQuery(function(){function t(){var e=this;this.id=t.collection.push(this)-1,this.title=setDefaultValue(this.title,null),this.$content=setDefaultValue(this.$content,$()),this.is_shown=!1,this.is_rendered=!1,jQuery.fn.init.call(this,tmpl("app-inspector",{id:this.id,title:this.title,content:this.$content})),this.find(".AppInspectorRemoveButton").on("click.CloseInspector",function(){e.hide()}),t.collection.length>5&&t.collection[0].destroy()}return t.$wrapper=$(".AppInspectorsWrapper"),t.collection=[],t.currentInspector=null,t.build=new AppInspectorComponents,t.hideCurrent=function(){t.currentInspector&&t.currentInspector.hide()},t.destroyAll=function(){t.collection.forEach(function(t){t.destroy()})},t.prototype.render=function(){t.$wrapper.append(this),this.is_rendered=!0,this.initiate(),this.find(".AppInspectorScroll").scrollbar()},t.prototype.initiate=function(){},t.prototype.show=function(){var e=this;t.currentInspector&&t.currentInspector.hide(),this.is_rendered||this.render(),setTimeout(function(){e.addClass(__C.CLASSES.SHOW)},100),t.currentInspector=this,this.is_shown=!0},t.prototype.hide=function(){this.removeClass(__C.CLASSES.SHOW),t.currentInspector=null,this.is_shown=!1},t.prototype.destroy=function(){this.is_shown&&this.hide(),t.collection.splice(this.id,1),this.is_rendered=!1,this.remove()},$("body").on("keyup.CloseCurrentAppInspector",function(e){isKeyPressed(e,__C.KEY_CODES.ESC)&&t.hideCurrent()}),Object.seal(t),t}()),ClientAppInspector=extending(AbstractAppInspector,function(){function t(t){this.client=t,this.title="Клиент",this.$interests_spiderweb_chart_container=$('<div class="SpiderWeb"></div>'),this.$content=tmpl("client-app-inspector",{client:AbstractAppInspector.build.avatarBlock(t),interests_title:AbstractAppInspector.build.title("Интересы"),interests_spiderweb_chart:this.$interests_spiderweb_chart_container}),AbstractAppInspector.call(this)}return t.prototype.initiate=function(){this.$interests_spiderweb_chart_container.highcharts({title:{text:!1},legend:{enabled:!1},tooltip:{pointFormatter:function(){return"<b>"+Math.roundTo(this.y,2)+"%</b>"}},chart:{backgroundColor:null,plotBorderWidth:null,plotShadow:!1,style:{fontFamily:"inherit",fontSize:"inherit"},polar:!0,type:"area",spacing:[0,0,0,0],width:364,height:340},plotOptions:{series:{states:{hover:{lineWidth:2}}},area:{fillOpacity:.5,marker:{enabled:!1,symbol:"circle",radius:2}}},colors:[__C.COLORS.FRANKLIN],pane:{size:"59%"},xAxis:{categories:this.client.interests.map(function(t){return t.topic_name}),tickmarkPlacement:"on",labels:{reserveSpace:!0,y:5},lineWidth:0},yAxis:{labels:!1,tickAmount:5,gridLineInterpolation:"polygon",lineWidth:0,min:0},series:[{data:this.client.interests.map(function(t){return t.value})}],credits:{enabled:!1}})},t}()),OrderAppInspector=extending(AbstractAppInspector,function(){function t(t,e){this.order=t,this.event=e,this.title="Заказ "+formatTicketNumber(this.order.number),this.$content=tmpl("order-app-inspector",{orderer:AbstractAppInspector.build.avatarBlock(this.order.user),status_block:__APP.BUILD.orderStatusBlock(this.order.status_type_code),tickets_title:AbstractAppInspector.build.title("Билеты"),tickets:AbstractAppInspector.build.tickets(this.order.tickets),registration_form_title:AbstractAppInspector.build.title("Анкета регистрации"),registration_fields:__APP.BUILD.registrationFields(this.order.registration_fields),event_title:AbstractAppInspector.build.title("Событие"),event:AbstractAppInspector.build.event(this.event)}),AbstractAppInspector.call(this)}return t}()),AbstractTopBar=function(){function t(){this.$main_header=$("#main_header")}return t.prototype.init=function(){var t=this.$main_header.find(".TopBarOverlay"),e=t.find(".TopBarSearchButton"),i=t.find(".TopBarSearchInput");e.on("click.OpenSearchBar",function(){t.hasClass("-open_search_bar")?__APP.changeState("/search/"+encodeURIComponent(i.val())):(t.addClass("-open_search_bar"),i.focus())}),i.on("keypress",function(t){13===t.which&&(0===i.val().indexOf("#")?__APP.changeState("/search/tag/"+encodeURIComponent(i.val().replace("#",""))):__APP.changeState("/search/"+encodeURIComponent(i.val())))}).on("keydown",function(e){27===e.keyCode&&(t.removeClass("-open_search_bar"),i.val(""))}).on("blur",function(){""===i.val()&&t.removeClass("-open_search_bar")}),this.$main_header.find(".SidebarBurger").add($(".MainSectionCap")).on("click",function(){$("body").toggleClass("-open_sidebar")}),bindRippleEffect(this.$main_header),bindPageLinks(this.$main_header)},t}(),TopBar=extending(AbstractTopBar,function(){function t(){AbstractTopBar.call(this)}return t.prototype.init=function(){AbstractTopBar.prototype.init.call(this)},t}()),TopBarNoAuth=extending(AbstractTopBar,function(){function t(){AbstractTopBar.call(this)}return t.prototype.init=function(){this.$main_header.find(".LoginButton").on("click",function(){cookies.removeItem("auth_command"),cookies.removeItem("auth_entity_id"),new AuthModal(location.href).show()}),AbstractTopBar.prototype.init.call(this)},t}()),Page=function(){function t(){this.name=this.constructor.name,this.state_name=this.name,this.page_title=setDefaultValue(this.page_title,""),this.page_title_obj=setDefaultValue(this.page_title_obj,""),this.$view=setDefaultValue(this.$view,$(".PageView")),this.$wrapper=setDefaultValue(this.$wrapper,$()),this.wrapper_tmpl=setDefaultValue(this.wrapper_tmpl,"std"),this.with_header_tabs=setDefaultValue(this.with_header_tabs,!1),
this.render_vars=setDefaultValue(this.render_vars,{}),this.rendering_defer=$.Deferred(),this.fetching_data_defer=$.Deferred()}return t.routeNewPage=function(e){var i,n=decodeURIComponent(e).split("/"),a=[];return i=n.reduce(function(t,e){return e?t.hasOwnProperty(e)?t[e]:Object.keys(t).reduce(function(i,n){return!i&&0===n.indexOf("^")&&new RegExp(n).test(e)?(a.push(e),t[n]):i},!1):t},__APP.ROUTING),i=i.prototype instanceof t?i:i[""]&&i[""].prototype instanceof t?i[""]:NotFoundPage,new(Function.prototype.bind.apply(i,[null].concat(a)))},t.prototype.show=function(){var t,e=this,i=$("#main_header"),n=__APP.PREVIOUS_PAGE.wrapper_tmpl!==e.wrapper_tmpl,a=n?"$view":"$wrapper",r=__APP.PREVIOUS_PAGE[a].length?__APP.PREVIOUS_PAGE[a]:n?$(".PageView"):$(".PageView").find(".Content"),o=History.getState();r.addClass("-faded"),$("body").trigger("Page:change/start",[__APP.CURRENT_PAGE,__APP.PREVIOUS_PAGE]),setTimeout(function(){r.addClass(__C.CLASSES.HIDDEN),e.with_header_tabs?i.addClass("-with_tabs"):i.removeClass("-with_tabs"),$("body").removeClass(function(t,e){return(e.match(/(^|\s)-state_\S+/g)||[]).join(" ")}).addClass("-state_"+e.state_name.toUnderscore()),n&&e.$view.html(tmpl(e.wrapper_tmpl+"-wrapper",{})),e.$wrapper=e.$view.find(".Content"),e.$wrapper.empty(),e.$view.removeClass(__C.CLASSES.HIDDEN),e.$wrapper.removeClass(__C.CLASSES.HIDDEN),e[a].addClass("-faded"),e.rendering_defer.resolve()},200),$.when(e.rendering_defer,e.fetching_data_defer).done(function(){(e.page_title_obj||e.page_title)&&__APP.changeTitle(e.page_title_obj?e.page_title_obj:e.page_title),e.renderHeaderTabs(),$(window).scrollTop(0),e.render(),t=o.data.parsed_page_uri&&o.data.parsed_page_uri.anchor?e.$wrapper.find("#"+o.data.parsed_page_uri.anchor):$(),bindPageLinks(),$("body").trigger("Page:change/end",[__APP.CURRENT_PAGE,__APP.PREVIOUS_PAGE]),setTimeout(function(){e[a].removeClass("-faded"),t.length&&scrollTo(t,400)},200)})},t.prototype.renderHeaderTabs=function(){},t.prototype.fetchData=function(){return this.fetching_data_defer.resolve().promise()},t.prototype.render=function(){},t.prototype.destroy=function(){},t}(),FeedPage=extending(Page,function(){function t(){Page.call(this),this.fields=t.fields.copy(),this.events=new EventsCollection,this.next_events_length=10,this.cities=new CitiesCollection,this.wrapper_tmpl="feed",this.with_header_tabs=!0}return t.fields=new Fields("organization_short_name","organization_logo_small_url","dates","is_same_time","favored_users_count","is_favorite","is_registered","ticketing_locally","ticketing_available","registration_locally","registration_available","registration_required","registration_till","registration_limit_count","is_free","min_price",{favored:{fields:"is_friend",order_by:"-is_friend",length:5}}),t.prototype.bindFeedEvents=function(t){trimAvatarsCollection(t),bindRippleEffect(t),bindDropdown(t),__APP.MODALS.bindCallModal(t),bindPageLinks(t),t.find(".HideEvent").not(".-Handled_HideEvent").each(function(){var t=$(this),e=t.parents(".FeedEvent"),i=t.data("event-id");t.on("click",function(){e.addClass("-cancel"),OneEvent.changeEventStatus(i,OneEvent.STATUS.HIDE,function(){e.after(tmpl("button",{classes:"-color_neutral ReturnEvent",title:"Вернуть событие",dataset:'data-event-id="'+i+'"'})),e.siblings(".ReturnEvent").not(".-Handled_ReturnEvent").on("click",function(){var t=$(this);OneEvent.changeEventStatus(i,OneEvent.STATUS.SHOW,function(){t.remove(),e.removeClass("-cancel")})}).addClass("-Handled_ReturnEvent")})})}).addClass("-Handled_HideEvent")},t.prototype.addNoEventsBlock=function(){var t=tmpl("feed-no-event",{text:"Как насчет того, чтобы подписаться на организации?",button:__APP.BUILD.link({title:"Перейти к каталогу",classes:["button","-color_neutral_accent","RippleEffect"],page:"/organizations"})},this.$wrapper);bindPageLinks(t),bindRippleEffect(t)},t.prototype.appendEvents=function(t){var e=this,i=__APP.BUILD.loaderBlock(e.$wrapper);return e.block_scroll=!0,e.events.fetchFeed(this.fields,this.next_events_length,{city_id:__APP.USER.selected_city.id},function(n){var a=__APP.BUILD.eventCards(e.events.last_pushed);e.block_scroll=!1,a.length?(e.$wrapper.append(a),e.bindFeedEvents(a),isFunction(t)&&t(a)):(e.addNoEventsBlock(),$(window).off("scroll.upload"+e.constructor.name)),i.remove()})},t.prototype.initFeedCalendar=function(){var t=this,e=t.events.date,i=new Calendar(t.$view.find(".FeedCalendar"),{classes:{wrapper_class:"feed_calendar_wrapper",table_class:"feed_calendar_table",thead_class:"feed_calendar_thead",tbody_class:"feed_calendar_tbody",th_class:"feed_calendar_th",td_class:"feed_calendar_td",td_disabled:__C.CLASSES.DISABLED}});i.init(),e&&i.setMonth(e.split("-")[1],e.split("-")[0]).selectDays(e),i.setDaysWithEvents({city_id:__APP.USER.selected_city.id}),i.$calendar.on("change:month",function(){bindPageLinks(i.$calendar),i.setDaysWithEvents({city_id:__APP.USER.selected_city.id})})},t.prototype.initCitySelect=function(){var t=this;t.cities.fetchCities(null,0,"distance,local_name").done(function(){var e=t.$view.find(".FeedCitiesSelect");e.html(tmpl("option",t.cities.map(function(t){return{val:t.id,display_name:t.local_name}}))),initSelect2(e),e.select2("val",__APP.USER.selected_city.id).off("change.SelectCity").on("change.SelectCity",function(){__APP.USER.selected_city=t.cities.getByID($(this).val()),__APP.reload(),t.initFeedCalendar()})})},t.prototype.render=function(){var e=this,i=$(window);if(__APP.PREVIOUS_PAGE instanceof t||(e.initFeedCalendar(),e.initCitySelect()),__APP.USER.isLoggedOut()){if(__APP.renderHeaderTabs([{title:"Актуальные",page:"/feed/actual"},{title:"По времени",page:"/feed/timeline"}]),e.$view.find(".BecomeOrg").on("click",function(t){return cookies.removeItem("auth_command"),cookies.removeItem("auth_entity_id"),new AuthModal(location.origin+"/add/organization").show(),!1}),"/feed/favored"===window.location.pathname||"/feed/recommendations"===window.location.pathname)return __APP.changeState("/feed/actual",!0,!0),null}else __APP.renderHeaderTabs([{title:"Актуальные",page:"/feed/actual"},{title:"По времени",page:"/feed/timeline"},{title:"Избранные",page:"/feed/favored"},{title:"Рекомендованные",page:"/feed/recommendations"}]);i.off("scroll"),e.appendEvents(function(){isScrollRemain(1e3)&&e.appendEvents(),i.on("scroll.upload"+e.constructor.name,function(){isScrollRemain(1e3)&&!e.block_scroll&&e.appendEvents()})})},t}()),ActualEventsPage=extending(FeedPage,function(){function t(){FeedPage.apply(this),this.events=new ActualEventsCollection,this.page_title="Актуальные события"}return t}()),DayEventsPage=extending(FeedPage,function(){function t(t){if(!t)throw Error("DayEventsCollection must have date parameter");FeedPage.apply(this),this.date=t,this.events=new DayEventsCollection(this.date),this.page_title="События на "+moment(this.date).format("D MMMM YYYY")}return t}()),FavoredEventsPage=extending(FeedPage,function(){function t(){FeedPage.apply(this),this.events=new FavoredEventsCollection,this.page_title="Избранные события"}return t}()),FriendsEventsPage=extending(FeedPage,function(){function t(){FeedPage.apply(this),this.events=new FriendsEventsCollection,this.page_title="События друзей"}return t}()),RecommendedEventsPage=extending(FeedPage,function(){function t(){FeedPage.apply(this),this.events=new RecommendedEventsCollection,this.page_title="Рекомендованные события"}return t}()),TimelineEventsPage=extending(FeedPage,function(){function t(){FeedPage.apply(this),this.events=new TimelineEventsCollection,this.page_title="События по времени"}return t}()),AdminPage=extending(Page,function(){function t(){Page.apply(this),this.state_name="admin",this.SCALES={MINUTE:"minute",HOUR:"hour",DAY:"day",WEEK:"week",MONTH:"month",YEAR:"year",OVERALL:"overall"},this.highchart_defaults={chart:{backgroundColor:null,plotBorderWidth:null,plotShadow:!1,style:{fontFamily:"inherit",fontSize:"inherit"}},title:{text:!1},credits:{enabled:!1}}}return t.prototype.areaChartSeriesNormalize=function(t){function e(t,e,i){return{name:a[e],data:t.map(function(t,e){return[moment.unix(t.time_value).valueOf(),t[i]]})}}var i={open_conversion:{with:"open_site",to:"view"},fave_conversion:{with:"fave",to:"open_site"},conversion:{with:"subscribe",to:"view"}},n={subscribe_unsubscribe:{subscribe:"subscribe",unsubscribe:"unsubscribe"}},a={notifications_sent:"Отправлено уведомлений",view:"Просмотры",view_detail:"Открытий страницы события из ленты Evendate",conversion:"Конверсия",subscribe:"Подписалось",unsubscribe:"Отписалось",open_site:"Открытий страницы события",open_conversion:"Конверсия просмотра события в ленте к открытию страницы события",fave:"Кол-во пользователей, которые добавили событие в избранное",fave_conversion:"Конверсия открытия страницы события к добавлениям в избранное"},r={showInLegend:!1,lineWidth:0,fillOpacity:0,states:{hover:{enabled:!1}}},o={};return $.each(t,function(t,a){o[t]=[],i.hasOwnProperty(t)?(o[t].push($.extend(!0,{tooltip:{valueSuffix:" %"}},e(a,t,"value"))),$.each(i[t],function(i,n){o[t].push($.extend(!0,{},r,e(a,n,i)))})):n.hasOwnProperty(t)?$.each(n[t],function(i,n){o[t].push(e(a,n,i))}):o[t].push(e(a,t,"value"))}),o},t.prototype.buildAreaCharts=function(t,e){var i=this,n=i.areaChartSeriesNormalize(t),a={notifications_sent:{title:"Отправлено уведомлений пользователям",wrapper_class:"NotificationsSentAreaChart"},view:{title:"Просмотры",wrapper_class:"ViewAreaChart"},view_detail:{title:"Открытий страницы события",wrapper_class:"ViewDetailAreaChart"},open_site:{title:"Открытий страницы события из ленты Evendate",wrapper_class:"OpenSiteAreaChart"},open_conversion:{title:"Конверсия просмотров/открытий",wrapper_class:"OpenConversionsAreaChart"},fave:{title:"Добавлений в избранное",wrapper_class:"FaveAreaChart"},fave_conversion:{title:"Конверсия открытий/добавлений в избранное",wrapper_class:"FaveConversionsAreaChart"},subscribe_unsubscribe:{title:"Подписчики",wrapper_class:"SubscriberAreaChart"},conversion:{title:"Конверсия просмотров/подписок",wrapper_class:"ConversionAreaChart"}},r=[["rgba(35, 215, 146, 0.18)","rgba(101, 101, 101, 0.6)","rgba(101, 101, 101, 0.6)"],["rgba(35, 215, 146, 0.09)","rgba(101, 101, 101, 0.6)","rgba(101, 101, 101, 0.6)"]],o=$.extend(!0,{},i.highchart_defaults,{chart:{type:"areaspline",plotBackgroundColor:"#fcfcfc",plotBorderColor:"#ebebeb",plotBorderWidth:1},colors:[__C.COLORS.FRANKLIN,__C.COLORS.MUTED_80,__C.COLORS.ACCENT,__C.COLORS.MUTED,__C.COLORS.MUTED_50,__C.COLORS.MUTED_30],title:{align:"left",margin:20},legend:{enabled:!0,align:"left",itemStyle:{color:__C.COLORS.TEXT,cursor:"pointer",fontSize:"14px",fontWeight:"500",y:0},itemMarginTop:24,itemMarginBottom:5,symbolHeight:18,symbolWidth:18,symbolRadius:9,itemDistance:42,x:30},plotOptions:{series:{states:{hover:{lineWidth:2}}},areaspline:{fillOpacity:.5,marker:{enabled:!1,symbol:"circle",radius:2,states:{hover:{enabled:!0}}},dataGrouping:{dateTimeLabelFormats:{millisecond:["%b %e, %H:%M:%S.%L","%b %e, %H:%M:%S.%L","-%H:%M:%S.%L"],second:["%b %e, %H:%M:%S","%b %e, %H:%M:%S","-%H:%M:%S"],minute:["%b %e, %H:%M","%b %e, %H:%M","-%H:%M"],hour:["%b %e, %H:%M","%b %e, %H:%M","-%H:%M"],day:["%b %e, %Y","%b %e","-%b %e, %Y"],week:["%b %e, %Y","%b %e","-%b %e, %Y"],month:["%B %Y","%B","-%B %Y"],year:["%Y","%Y","-%Y"]}}}},tooltip:{headerFormat:"<b>{point.key}</b><br/>",positioner:function(t,e){return{x:this.chart.plotLeft,y:this.chart.plotTop}},shadow:!1,shape:"square",valueDecimals:0,xDateFormat:"%e %b %Y",shared:!0},scrollbar:{enabled:!1},navigator:{outlineColor:"#ebebeb",outlineWidth:1,maskInside:!1,maskFill:"rgba(245, 245, 245, 0.66)",handles:{backgroundColor:"#9fa7b6",borderColor:"#fff"},xAxis:{gridLineWidth:0,labels:{align:"left",reserveSpace:!0,style:{color:"#888"},x:0,y:null}}},rangeSelector:{buttonTheme:{width:null,height:22,fill:"none",stroke:"none",r:14,style:{color:__C.COLORS.MUTED_80,fontSize:"13px",fontWeight:"400",textTransform:"uppercase",dominantBaseline:"middle"},states:{hover:{fill:__C.COLORS.MUTED_50,style:{color:"#fff"}},select:{fill:__C.COLORS.MUTED_80,style:{color:"#fff",fontWeight:"400"}}}},buttons:[{type:"day",count:7,text:"   Неделя   "},{type:"month",count:1,text:"   Месяц   "},{type:"year",count:1,text:"   Год   "},{type:"all",text:"   Все время   "}],allButtonsEnabled:!0,selected:2,labelStyle:{display:"none"},inputEnabled:!1},xAxis:{gridLineWidth:1,gridLineDashStyle:"dash",type:"datetime",showEmpty:!1,tickPosition:"inside",dateTimeLabelFormats:{minute:"%H:%M",hour:"%H:%M",day:"%e %b",week:"%e %b",month:"%b %y",year:"%Y"}},yAxis:{allowDecimals:!1,floor:0,min:0,gridLineDashStyle:"dash",opposite:!1,title:{text:!1}}},e);$.each(n,function(t){var e={title:{text:a[t].title}};e.series=n[t].map(function(t,e){return 0!==t.fillOpacity?$.extend(!0,{},t,{fillColor:{linearGradient:{x1:0,x2:0,y1:0,y2:1},stops:r.map(function(t,i){return[i,t[e]]})}}):t}),"conversion"!=t&&"open_conversion"!=t&&"fave_conversion"!=t||(e.yAxis={max:100,labels:{format:"{value}%"}}),i.$wrapper.find("."+a[t].wrapper_class).highcharts("StockChart",$.extend(!0,{},o,e))})},t.prototype.updateScoreboards=function(t,e,i,n,a){var r=!!e.dynamics;n||(n=Object.keys(i)),n.forEach(function(n){var o,s="Scoreboard"+n.toCamelCase("_"),l=t.find("."+s);switch(n){case"conversion":case"open_conversion":case"fave_conversion":o="%"}l.length||(l=tmpl(r?"scoreboard-with-dynamics":"scoreboard",{type:s,title:i[n],size:a?"-size_"+a:"-size_normal",number:0+o,dynamic_by_week:0+o},t)),void 0!==e.numbers[n]&&l.find(".ScoreboardNumber").animateNumber({number:Math.round(e.numbers[n]),suffix:o},2e3,"easeOutSine"),r&&void 0!==e.dynamics[n]&&l.find(".ScoreboardDynamic").animateNumber({number:Math.round(e.dynamics[n]),prefix:0==e.dynamics[n]?void 0:e.dynamics[n]>0?"+":"-",suffix:o},2e3,"easeOutSine").siblings("label").removeClass("fa-caret-up -text_color_franklin fa-caret-down -text_color_bubblegum").addClass(0==e.dynamics[n]?"":e.dynamics[n]>0?"fa-caret-up -text_color_franklin":"fa-caret-down -text_color_bubblegum")})},t}()),AdminEventPage=extending(AdminPage,function(){function t(e){AdminPage.call(this),this.id=e,this.event=new OneEvent(this.id),this.event_fields=t.fields,this.with_header_tabs=!0}return t.fields=new Fields("organization_short_name","ticketing_locally","registration_locally","registration_approvement_required"),t.prototype.fetchData=function(){return this.fetching_data_defer=this.event.fetchEvent(this.event_fields)},t.prototype.renderHeaderTabs=function(){var t=[];t.push({title:"Обзор",page:"/admin/event/"+this.id+"/overview"}),this.event.registration_approvement_required&&t.push({title:"Заявки",page:"/admin/event/"+this.id+"/requests"}),(this.event.registration_locally||this.event.ticketing_locally)&&(t.push({title:"Контроль входа",page:"/admin/event/"+this.id+"/check_in"}),t.push({title:"Заказы",page:"/admin/event/"+this.id+"/orders"})),t.push({title:"Редактирование",page:"/admin/event/"+this.id+"/edit"}),__APP.renderHeaderTabs(t)},t}()),AdminEventAuditoryPage=extending(AdminEventPage,function(){function t(t){AdminEventPage.apply(this,arguments)}return t.prototype.render=function(){},t}()),AdminEventCheckInPage=extending(AdminEventPage,function(){function t(i){var n=this;AdminEventPage.call(this,i),this.current_checkin_state=t.STATES.AWAITING,this.tickets_fields=new Fields("user","ticket_type","event_id"),this.tickets=new e(i),this.searching_tickets=new SearchEventTicketsCollection("",i),this.is_searching_state=!1,this.is_fetching=!1,this.progress_bar=new ProgressBar({NUMBER:this.tickets.checked.length,OVERALL:this.tickets.length},{classes:["-with_label"]}),this.table_body=$(),Object.defineProperties(this,{page_title_obj:{get:function(){return[{title:"Организации",page:"/admin"},{title:n.event.organization_short_name,page:"/admin/organization/"+n.event.organization_id},n.event.title+" - контроль входа"]}},is_awaiting_state:{get:function(){return n.current_checkin_state===t.STATES.AWAITING}}})}var e=extending(EventAllTicketsCollection,function(){function t(t){var e=this;EventAllTicketsCollection.call(this,t),Object.defineProperties(this,{awaiting:{get:function(){return e.filter(function(t){return!t.checkout})}},new_awaiting:{get:function(){return e.last_pushed.filter(function(t){return!t.checkout})}},checked:{get:function(){return e.filter(function(t){return t.checkout})}},new_checked:{get:function(){return e.last_pushed.filter(function(t){return t.checkout})}}})}return t.fetchTickets=EventAllTicketsCollection.fetchTickets,t}());return t.STATES={AWAITING:"awaiting",CHECKED:"checked"},t.ACTION_TEXTS={AWAITING_NORMAL:"Ожидает подтверждения",AWAITING_HOVER:"Подтвердить вход",CHECKED_NORMAL:"Подтверждён",CHECKED_HOVER:"Отменить подтверждение"},t.prototype.fetchData=function(){return this.fetching_data_defer=__APP.SERVER.multipleAjax(AdminEventPage.prototype.fetchData.call(this),this.tickets.fetchTickets(this.tickets_fields,0,"created_at"))},t.prototype.buildTableRows=function(e,i){e=e?e instanceof Array?e:[e]:[];var n,a=this;return e.length?(n=tmpl("event-admin-check-in-row",e.map(function(e){return{ticket_id:e.uuid,number:e.number,full_name:e.user.full_name,avatar_block:__APP.BUILD.avatarBlocks(e.user,{entity:__C.ENTITIES.USER,avatar_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]}),ticket_type:e.ticket_type.name,state_modificator:"-ticket_status_"+(e.checkout?t.STATES.CHECKED:t.STATES.AWAITING),status_text:e.checkout?t.ACTION_TEXTS.CHECKED_NORMAL:t.ACTION_TEXTS.AWAITING_NORMAL,action_text:e.checkout?t.ACTION_TEXTS.CHECKED_HOVER:t.ACTION_TEXTS.AWAITING_HOVER}})),n.find(".CheckoutTicket").not(".-Handled_CheckoutTicket").on("click",function(){var e=a.tickets.getByID($(this).closest(".Ticket").data("ticket_uuid"));OneTicket[e.checkout?"uncheck":"check"](e.event_id,e.uuid,function(){a.changeTicketState(e,e.checkout?t.STATES.AWAITING:t.STATES.CHECKED)})}).addClass("-Handled_CheckoutTicket"),n):tmpl("event-admin-check-in-row-no-tickets",{text:i||"Нет билетов"})},t.prototype.changeTicketState=function(e,i){var n;this.is_searching_state?(n=this.table_body.find(".Ticket_"+e.uuid),n.toggleClass(Object.values(t.STATES).map(function(t){return"-ticket_status_"+t}).join(" ")),n.find(".StatusText").text(t.ACTION_TEXTS[e.checkout?"AWAITING_NORMAL":"CHECKED_NORMAL"]),n.find(".CheckoutTicket").text(t.ACTION_TEXTS[e.checkout?"AWAITING_HOVER":"CHECKED_HOVER"])):e.checkout!==this.is_awaiting_state&&(i===(this.is_awaiting_state?t.STATES.AWAITING:t.STATES.CHECKED)?this.table_body.append(this.buildTableRows(e)):this.table_body.find(".Ticket_"+e.uuid).remove()),(e.checkout&&i===t.STATES.AWAITING||!e.checkout&&i===t.STATES.CHECKED)&&(e.checkout=!e.checkout,this.progress_bar.set(this.tickets.checked.length)),this.is_searching_state||this.tickets[this.current_checkin_state].length||this.table_body.html(this.buildTableRows([]))},t.prototype.initSearch=function(){var t=this;this.is_searching_state=!0,this.$wrapper.find(".RadioGroup").find("input").prop("checked",!1),this.$wrapper.find(".ClearSearch").one("click",function(){t.$wrapper.find(".SearchTickets").val(""),t.deInitSearch()}),$(window).on("keydown.deInitSearch",function(e){27===e.keyCode&&t.deInitSearch()})},t.prototype.deInitSearch=function(){this.is_searching_state=!1,$(window).off("keydown.deInitSearch"),this.$wrapper.find("#event_admin_check_in_type_"+this.current_checkin_state).prop("checked",!0),this.table_body.html(this.buildTableRows(this.tickets[this.current_checkin_state]))},t.prototype.init=function(){var t=this;this.$wrapper.find(".RadioGroup").on("change",function(e){t.current_checkin_state=$(e.target).val(),t.table_body.html(t.buildTableRows(t.tickets[t.current_checkin_state]))}),this.$wrapper.find(".SearchTickets").on("input",function(e){var i=$(e.target).val();t.is_searching_state||t.initSearch(),__APP.SERVER.abortAllConnections(),""===i?t.deInitSearch():(t.searching_tickets=new SearchEventTicketsCollection(i,t.event.id),t.fetching_data_defer=t.searching_tickets.fetchTickets(t.tickets_fields,0,"created_at",function(){t.table_body.html(t.buildTableRows(this.last_pushed))}))})},t.prototype.loadRest=function(){var t=this;return this.tickets.fetchTickets(this.tickets_fields,0,"created_at",function(){this.last_pushed.length&&(t.progress_bar.setMax(t.tickets.length),t.progress_bar.set(t.tickets.checked.length),t.table_body.append(t.buildTableRows(this["new_"+t.current_checkin_state])),t.fetching_data_defer=t.loadRest())})},t.prototype.render=function(){this.progress_bar.setMax(this.tickets.length),this.progress_bar.set(this.tickets.checked.length),this.$wrapper.html(tmpl("event-admin-check-in-page",{radio_group:__APP.BUILD.radioGroup({name:"check_in_type",units:[{id:"event_admin_check_in_type_awaiting",label:"Ожидают",attributes:{value:t.STATES.AWAITING,checked:!0}},{id:"event_admin_check_in_type_checked",label:"Проверенные",attributes:{value:t.STATES.CHECKED}}]}),progress_bar:this.progress_bar,rows:this.buildTableRows(this.tickets.awaiting)})),this.table_body=this.$wrapper.find(".CheckInTable").children("tbody"),this.fetching_data_defer=this.loadRest(),this.init()},t}()),AbstractEditEventPage=extending(Page,function(){function t(){var t=this,e=["id","title","description","location","detail_info_url","organization_id","image_horizontal_url"];Page.call(this),this.event=new OneEvent,this.state_name="admin",this.MainCalendar=null,this.my_organizations=new OrganizationsCollection,this.my_organizations_fields=new Fields("default_address",{tariff:{fields:new Fields("available_additional_notifications","available_event_publications","event_publications")}}),this.render_vars={organization_options:null,start_time:null,end_time:null,min_price_input:null,image_horizontal_filename:null,registration_till_date_select:null,registration_till_time_input:null,registration_limit_count_input:null,registration_predefined_fields:null,registration_custom_fields:null,ticket_types:null,add_ticket_type_button:null,booking_time_input:null,promocodes:null,add_promocode_button:null,public_at_date_select:null,public_at_time_input:null,additional_notification_date_select:null,additional_notification_time_input:null,vk_image_base64:null,vk_image_filename:null,vk_image_url:null,vk_post_link:null,button_text:null},e.forEach(function(e){Object.defineProperty(t.render_vars,e,{enumerable:!0,get:function(){return t.event[e]}})}),Object.defineProperties(this.render_vars,{organizations_wrapper_classes:{enumerable:!0,get:function(){return t.my_organizations.length<2?__C.CLASSES.HIDDEN:""}},current_date:{enumerable:!0,get:function(){return moment().format(__C.DATE_FORMAT)}}}),Object.defineProperties(this,{organization_id:{get:function(){return t.event.organization_id},set:function(e){t.event.organization_id=e}},is_edit:{get:function(){return!!t.event.id}}})}return t.lastRegistrationFieldId=0,t.lastTicketTypeRowId=0,t.lastPromocodeRowId=0,t.registrationCustomFieldBuilder=function(e){e=e?e instanceof Array?e:[e]:[{}];var i;return i=tmpl("edit-event-registration-custom-field",e.filter(function(e){return!!RegistrationFieldModel.isCustomField(e)&&(e.id=e.id?e.id:t.lastRegistrationFieldId++,!0)}).map(function(e){return $.extend({},e,{registration_custom_field_values:e.values&&e.values.length?t.registrationCustomFieldValuesBuilder(e.id,e.values):""})})),initSelect2(i.find(".RegistrationCustomFieldType"),{dropdownCssClass:"form_select2_drop form_select2_drop_no_search"}).on("change.SelectRegistrationCustomFieldType",function(){var e=$(this),i=e.closest(".RegistrationCustomField"),n=i.find(".RegistrationCustomFieldValues");switch(e.val()){case RegistrationFieldModel.TYPES.ADDITIONAL_TEXT:case RegistrationFieldModel.TYPES.EXTENDED_CUSTOM:n.html("");break;case RegistrationFieldModel.TYPES.SELECT:case RegistrationFieldModel.TYPES.SELECT_MULTI:n.is(":empty")&&n.html(t.registrationCustomFieldValuesBuilder(i.find(".RegistrationFieldId").val()))}}),e.forEach(function(t){t.required&&i.find("#edit_event_registration_"+t.id+"_custom_field_required").prop("checked",!0),t.type&&i.find("#edit_event_registration_"+t.id+"_field_type").select2("val",t.type)}),i.find(".RegistrationCustomFieldLabel, .RegistrationCustomFieldType").on("change.RemoveRegistrationFieldUUID",function(){$(this).closest(".RegistrationCustomField").find(".RegistrationCustomFieldUUID").val("")}),i},t.registrationCustomFieldValuesBuilder=function(e,i){var n=i instanceof Array?i:[],a=tmpl("edit-event-registration-custom-field-values",{id:e,values:t.registrationCustomFieldValueBuilder(e,n),last_value_id:n.length});return a.find(".AddValue").on("click.AddValue",function(){var i=+a.data("last_value_id")+1,n=t.registrationCustomFieldValueBuilder(e,{value:"Вариант "+i,value_id:i});a.find(".RegistrationCustomFieldValuesWrapper").append(n),a.data("last_value_id",i),n.find(".ValueInput").focus().get(0).select()}),a},t.registrationCustomFieldValueBuilder=function(t,e){var i=e instanceof Array?e:e?[e]:[],n=tmpl("edit-event-registration-custom-field-value",i.map(function(e,i){return{id:t,value_id:e.value_id||i,value_uuid:e.uuid,checkbox_radio:__APP.BUILD.checkbox({attributes:{disabled:!0}}),input:__APP.BUILD.input({name:"registration_"+t+"_field_"+(e.value_id||i)+"_value",value:e.value},["edit_event_registration_custom_field_value_input","form_input","-flat","ValueInput"])}}));return n.find(".RemoveValue").on("click.RemoveValue",function(){$(this).closest(".RegistrationFieldValue").remove()}),n},t.ticketTypeRowsBuilder=function(e){var i=e?e instanceof Array?e:[e]:[new OneTicketType],n=tmpl("edit-event-tickets-row",i.map(function(e){var i=++t.lastTicketTypeRowId;return{row_num:i,uuid:e.uuid,type_code:e.type_code||randomString(),name_input:__APP.BUILD.formUnit({id:"event_edit_ticket_type_"+i+"_name",classes:["TicketTypeName"],name:"ticket_type_"+i+"_name",value:e.name||"",placeholder:"Название типа билета",required:!0}).on("input",function(){t.checkTicketTypeSellAfter($(this).closest(".TicketTypes"))}),amount_input:__APP.BUILD.formUnit({id:"event_edit_ticket_type_"+i+"_amount",name:"ticket_type_"+i+"_amount",value:empty(e.amount)?"":e.amount,placeholder:0,required:!0}),price_input:__APP.BUILD.formUnit({id:"event_edit_ticket_type_"+i+"_price",name:"ticket_type_"+i+"_price",value:empty(e.price)?"":e.price,placeholder:0,required:!0}),comment_form_unit:__APP.BUILD.formUnit({label:"Описание типа билетов",type:"textarea",name:"ticket_type_{row_num}_comment".format({row_num:i}),value:e.comment,placeholder:"Описание типа билетов (опционально)",helptext:"Краткое описание типа билетов, объясняющее пользователям отличие этого типа от других"}),tickets_sell_start_date_checkbox:__APP.BUILD.formUnit({id:"event_edit_ticket_type_"+i+"_start_by_date",label:"По дате",type:"checkbox",name:"ticket_type_"+i+"_start_by_date",dataset:{switch_id:"ticket_type_"+i+"_start_by_date"},classes:["TicketTypeStartByDateSwitch","Switch"],unit_classes:["-inline"]}),tickets_sell_start_date_select:__APP.BUILD.formUnit({type:"date",name:"ticket_type_"+i+"_sell_start_date",value:e.sell_start_date?unixTimestampToISO(e.sell_start_date):void 0}),tickets_sell_start_after_checkbox:__APP.BUILD.formUnit({id:"event_edit_ticket_type_"+i+"_start_after",label:"По истечении продаж билета",type:"checkbox",name:"ticket_type_"+i+"_start_after",dataset:{switch_id:"ticket_type_"+i+"_start_after"},classes:["TicketTypeStartAfterSwitch","Switch"],unit_classes:["-inline"]}),tickets_sell_start_after_select:__APP.BUILD.select([],{name:"ticket_type_"+i+"_start_after_code"},"TicketTypeSellAfter",null,e.start_after_ticket_type_code),tickets_sell_end_date_select:__APP.BUILD.formUnit({label:"Дата",type:"date",name:"ticket_type_"+i+"_sell_end_date",value:e.sell_end_date?unixTimestampToISO(e.sell_end_date):void 0,unit_classes:["-inline"]}),tickets_by_order_min_amount_input:__APP.BUILD.formUnit({id:"event_edit_ticket_type_"+i+"_min_count_per_user",type:"number",label:"Минимум",name:"ticket_type_"+i+"_min_count_per_user",value:e.min_count_per_user||0,unit_classes:["-inline"],required:!0,attributes:{size:6}}),tickets_by_order_max_amount_input:__APP.BUILD.formUnit({id:"event_edit_ticket_type_"+i+"_max_count_per_user",type:"number",label:"Максимум",name:"ticket_type_"+i+"_max_count_per_user",value:e.max_count_per_user||30,unit_classes:["-inline"],attributes:{size:6}}),close_expanded_button:__APP.BUILD.actionButton({title:"Скрыть настройки",classes:["-color_marginal","TicketTypeHideButton"]}).on("click.HideTicketType",function(){$(this).closest(".CollapsingWrapper").resolveInstance().closeCollapsing()})}}));return bindControlSwitch(n),bindCollapsing(n),bindPageLinks(n),n.not(".ExpandRow").each(function(e){var n=$(this),a=n.next(".ExpandRow");n.data("ticket_type",i[e]),n.find(".TicketTypeExpandButton").on("click.ExpandTicketType",function(){a.siblings(".ExpandRow").find(".CollapsingWrapper").each(function(){$(this).resolveInstance().closeCollapsing()}),a.find(".CollapsingWrapper").resolveInstance().toggleCollapsing()}),n.find(".TicketTypeDeleteButton").on("click.DeleteTicketType",function(){var e=n.parent();a.remove(),n.remove(),e.children().length||e.append(tmpl("edit-event-tickets-row-empty")),t.checkTicketTypeSellAfter(e.closest(".TicketTypes"))})}),n.filter(".ExpandRow").each(function(t){var e=$(this);e.data("ticket_type",i[t]),i[t].sell_start_date&&e.find(".TicketTypeStartByDateSwitch").prop("checked",!0).trigger("change"),i[t].promocode&&e.find(".TicketTypePromoSwitch").prop("checked",!0).trigger("change")}),n},t.promocodeRowsBuilder=function(e){var i,n=e?e instanceof Array?e:[e]:[new PromocodeModel];return i=tmpl("edit-event-promocode-row",n.map(function(e){var i=++t.lastPromocodeRowId,n=!1!==e.enabled;return{id:i,uuid:e.uuid,code_input:__APP.BUILD.formUnit({name:"promocode_"+i+"_code",value:e.code,placeholder:"Введите промокод",readonly:!n||void 0,classes:["PromocodeFormInput"],required:!0}),effort_input:__APP.BUILD.inputNumber({name:"promocode_"+i+"_effort",value:e.effort,placeholder:"0",readonly:!n||void 0,required:!0},["PromocodeFormInput"]),type_switch:__APP.BUILD.switch("event_edit_promocode_"+i+"_is_fixed","promocode_"+i+"_is_fixed",e.is_fixed),service_control:e.uuid?__APP.BUILD.switch("event_edit_promocode_"+i+"_enabled","promocode_"+i+"_enabled",e.enabled,null,["PromocodeDisable"]):__APP.BUILD.button({title:"×",classes:["event_edit_row_delete_button",__C.CLASSES.COMPONENT.ACTION,__C.CLASSES.UNIVERSAL_STATES.EMPTY,"PromocodeDeleteButton"]})}})),i.find(".PromocodeDeleteButton").on("click.DeletePromocode",function(){$(this).closest(".PromocodeRow").remove()}),i.find(".PromocodeDisable").on("click.DisablePromocode",".FormSwitchInput",function(){var t=$(this).parents(".PromocodeRow").find(".PromocodeFormInput");this.checked?t.removeAttr("readonly"):t.attr("readonly",!0)}),i},t.checkTicketTypeSellAfter=function(t){var e=t.find("select.TicketTypeSellAfter"),i=t.children("tbody").children().not(".ExpandRow"),n=[];i.each(function(t){var e=$(this);n.push({display_name:e.find(".TicketTypeName").val()||"Тип билета "+(t+1),val:e.find(".TicketTypeCode").val()})}),e.each(function(){var t=$(this),e=t.closest("tr").prev().find(".TicketTypeCode").val(),i=t.select2("val");t.select2("destroy"),t.html(__APP.BUILD.option(n.filter(function(t){return t.val!==e}))),initSelect2(t),t.select2("val",i)}),e.length<2?t.find(".TicketTypeSellAfterFieldset").attr("disabled",!0):t.find(".TicketTypeSellAfterFieldset").removeAttr("disabled"),e.length>0?t.closest(".EditEventForm").find(".EmailTicketing").removeClass(__C.CLASSES.HIDDEN):t.closest(".EditEventForm").find(".EmailTicketing").addClass(__C.CLASSES.HIDDEN)},t.prototype.fetchData=function(){return this.fetching_data_defer=this.my_organizations.fetchMyOrganizations(["admin","moderator"],this.my_organizations_fields)},t.prototype.gatherSendData=function(){var t=this.$wrapper.find(".EditEventForm").serializeForm(),e={event_id:parseInt(t.event_id)?parseInt(t.event_id):null,title:t.title?t.title.trim():"",organization_id:t.organization_id,description:t.description?t.description.trim():"",different_time:!!t.different_time,dates:new DateModelsCollection,is_online:!!t.is_online,
location:t.location&&t.location.trim()?t.location.trim():null,detail_info_url:t.detail_info_url?t.detail_info_url.trim():null,image_horizontal:t.image_horizontal,filenames:{horizontal:t.filename_horizontal},is_free:!!t.is_free,vk_post:!!t.vk_post,min_price:t.is_free?null:t.min_price,delayed_publication:!!t.delayed_publication,registration_required:!!t.registration_required,registration_locally:!!t.registration_locally,registration_approvement_required:!!t.registration_approvement_required,email_texts:{payed:t.email_payed_text||null,approved:t.email_approved_text||null,not_approved:t.email_not_approved_text||null,after_event:t.email_after_event_text||null}};return t.different_time?(t.event_date instanceof Array||(t.event_date=[t.event_date],t.start_time=[t.start_time],t.end_time=[t.end_time]),e.dates.setData(t.event_date.map(function(e,i){return{event_date:e,start_time:t.start_time[i],end_time:t.end_time[i]}}))):e.dates.setData(this.MainCalendar.selected_days.map(function(e){return{event_date:e,start_time:t.start_time,end_time:t.end_time}})),e.dates=e.dates.getArrayCopy(),t.registration_required&&(t.registration_limit_by_date&&(e.registration_till=moment(t.registration_till_date+(t.registration_till_time?" "+t.registration_till_time:"")).tz("UTC").format()),t.registration_limit_by_quantity&&(e.registration_limit_count=t.registration_limit_count),t.registration_fields&&t.registration_fields.length&&(e.registration_fields=(new RegistrationFieldModelsCollection).setData(t.registration_fields.map(function(e){var i=new RegistrationFieldModel;return t["registration_"+e+"_field_type"]&&(i.type=t["registration_"+e+"_field_type"]),i.required=t["registration_"+e+"_field_required"],t["registration_"+e+"_field_uuid"]&&(i.uuid=t["registration_"+e+"_field_uuid"]),t["registration_"+e+"_field_label"]&&(i.label=t["registration_"+e+"_field_label"].trim()),t["registration_"+e+"_field_order_number"]&&(i.order_number=t["registration_"+e+"_field_order_number"]||null),t["registration_"+e+"_field_values"]&&(i.values=t["registration_"+e+"_field_values"].map(function(i){var n=new RegistrationSelectFieldValue;return n.value=t["registration_"+e+"_field_"+i+"_value"],n.uuid=setDefaultValue(t["registration_"+e+"_field_"+i+"_value_uuid"],null),n})),i})).getArrayCopy())),t.tags&&(e.tags=t.tags.split(",")),t.ticket_types&&(e.ticket_types=(t.ticket_types instanceof Array?t.ticket_types:[t.ticket_types]).map(function(e){return{uuid:t["ticket_type_"+e+"_uuid"]||null,name:t["ticket_type_"+e+"_name"],comment:t["ticket_type_"+e+"_comment"],type_code:t["ticket_type_"+e+"_type_code"],amount:t["ticket_type_"+e+"_amount"],price:t["ticket_type_"+e+"_price"],start_after_ticket_type_code:t["ticket_type_"+e+"_start_after_ticket_type_code"]||null,sell_start_date:t["ticket_type_"+e+"_start_by_date"]?t["ticket_type_"+e+"_sell_start_date"]:null,sell_end_date:t["ticket_type_"+e+"_sell_end_date"]||null,min_count_per_user:t["ticket_type_"+e+"_min_count_per_user"],max_count_per_user:t["ticket_type_"+e+"_max_count_per_user"]}}),e.ticketing_locally=!0,e.booking_time=0==+t.booking_time?1:t.booking_time,e.accept_bitcoins=t.accept_bitcoins),t.promocodes&&(e.promocodes=(t.promocodes instanceof Array?t.promocodes:[t.promocodes]).map(function(e){return{uuid:t["promocode_"+e+"_uuid"]||null,code:t["promocode_"+e+"_code"],effort:t["promocode_"+e+"_effort"],is_fixed:t["promocode_"+e+"_is_fixed"],is_percentage:!t["promocode_"+e+"_is_fixed"],enabled:!1!==t["promocode_"+e+"_enabled"],use_limit:t["promocode_"+e+"_use_limit"]||1e3,start_date:t["promocode_"+e+"_start_date"]||null,end_date:t["promocode_"+e+"_end_date"]||null}})),t.delayed_publication&&(e.public_at=moment(t.public_at_date+" "+t.public_at_time).tz("UTC").format()),t.additional_notification&&(e.additional_notification_time=moment(t.additional_notification_date+" "+t.additional_notification_time).tz("UTC").format()),t.vk_post&&(e.vk={guid:t.vk_guid,image:t.vk_image,filename:t.vk_filename,description:t.vk_description}),e},t.prototype.checkTariffAvailabilities=function(){var t=this,e=t.my_organizations.getByID(t.organization_id),i=t.$wrapper.find(".FormOverallFields"),n=t.$wrapper.find(".AdditionalNotificationSwitch"),a=t.$wrapper.find(".AvailableEventPublicationsWrapper");e.tariff.available_additional_notifications?(n.prop("disabled",!1),n.closest(".AdditionalNotificationSwitchParent").removeClass(__C.CLASSES.STATUS.DISABLED),t.$wrapper.find(".BuySubscriptionLink").addClass(__C.CLASSES.HIDDEN)):(n.prop("checked")&&n.prop("checked",!1).trigger("change"),n.prop("disabled",!0),n.closest(".AdditionalNotificationSwitchParent").addClass(__C.CLASSES.STATUS.DISABLED),t.$wrapper.find(".BuySubscriptionLink").removeClass(__C.CLASSES.HIDDEN).attr("href","/admin/organization/"+t.organization_id+"/settings#change_tariff")),e.tariff.events_publication_left<=5?(a.removeClass(__C.CLASSES.HIDDEN),a.find(".AvailableEventPublications").text(e.tariff.events_publication_left)):a.addClass(__C.CLASSES.HIDDEN),i.attr("disabled",e.tariff.events_publication_left<=0&&!t.is_edit)},t.prototype.initCrossPosting=function(){function t(){var t,i=e.gatherSendData(),n="";n+=i.title?i.title+"\n\n":"",i.dates&&i.dates.length&&(n+=i.dates.length>1?"Дата начала: ":"Начало: ",n+=moment(i.dates[0].event_date).format("D MMMM YYYY"),1===i.dates.length&&i.dates[0].start_time&&(n+=" в "+i.dates[0].start_time)),i.registration_required&&i.registration_till?(t=moment(i.registration_till),n+=" (регистрация заканчивается: "+t.format("D MMMM YYYY")+" в "+t.format("HH:mm")+")\n"):n+="\n",n+=i.location?i.location+"\n\n":"",n+=i.description?i.description+"\n\n":"",i.is_free||(n+=i.min_price?"Цена от "+i.min_price+"\n\n":""),i.detail_info_url?n+=i.detail_info_url:i.event_id&&(n+="https://evendate.ru/event/"+i.event_id),e.$wrapper.find(".VKPostText").val(n)}var e=this;this.$wrapper.find(".OnChangeCrossPost").on("change.crossPostingToVK",t),this.MainCalendar.$calendar.on("change:days.crossPostingToVK",t),this.$wrapper.find(".VKPostText").one("click",function(){e.deInitCrossPosting()}),function(){var t=e.$wrapper.find(".EventEditHorizontalImageHolder"),i=t.find(".ImgSrc"),n=t.find(".FileName"),a=e.$wrapper.find(".EditEventVKImageHolder"),r=a.find(".ImgPreview"),o=a.find(".ImgSrc"),s=a.find(".FileName");new MutationObserver(function(){var t=i.val();r.attr("src",t),o.val(t),s.val(n.val())}).observe(i.get(0),{attributes:!0})}()},t.prototype.deInitCrossPosting=function(){this.$wrapper.find(".OnChangeCrossPost").off("change.crossPostingToVK"),this.MainCalendar.$calendar.off("change:days.crossPostingToVK")},t.prototype.submitForm=function(){function t(){__APP.changeState("/event/"+n.event.id)}function e(){n.$wrapper.removeClass(__C.CLASSES.STATUS.DISABLED),l.remove()}var i,n=this,a=n.$wrapper.find(".EditEventForm"),r=a.find("input.EventTags"),o=a.serializeForm(),s=!!n.event.id,l=$();if(function(t,e){function i(t,e,i){var n,a;return e&&(n=t.parents(".TabsBody:last"),a=n.closest(".Tabs").resolveInstance(),a.setToTab(a.find(".TabsBodyWrapper:first").children().index(n)),scrollTo(t,400,function(){showNotifier({text:i,status:!1})})),handleErrorField(t),!1}var n=!0,a=t.find("#edit_event_different_time").prop("checked")?t.find('[class^="TableDay_"]'):t.find(".MainTime");return t.find(":required").not(t.find(":disabled")).each(function(){var t=$(this);""===t.val().trim()?n=i(t,n,"Заполните все обязательные поля"):t.hasClass("LimitSize")&&t.val().trim().length>t.data("maxlength")&&(n=i(t,n,"Количество символов превышает установленное значение"))}),e.selected_days.length||(n=i(e.$calendar,n,"Выберите даты для события")),a.each(function(){var t=$(this),e=t.find(".StartTime, .EndTime"),a=e.filter(".StartTime").inputmask("unmaskedvalue"),r=e.filter(".EndTime").inputmask("unmaskedvalue");e.each(function(){var t=$(this);""===t.val()&&(n=i(t,n,"Заполните время события"))}),n&&a>r&&(n=i(t,n,"Начальное время не может быть позже конечного"))}),""===r.val().trim()&&(n=i(r.siblings(".EventTags"),n,"Необходимо выбрать хотя бы один тэг")),!o.registration_limit_by_quantity||o.registration_fields&&o.registration_fields.length||(n=i(t.find("#edit_event_registration_fields"),n,"Должно быть выбрано хотя бы одно поле регистрации в анкете")),s||t.find(".DataUrl").each(function(){var t=$(this);""===t.val().trim()&&(n=i(t.closest(".ImgLoadWrap"),n,"Пожалуйста, добавьте к событию обложку"))}),n}(a,n.MainCalendar)){n.$wrapper.addClass(__C.CLASSES.STATUS.DISABLED),l=__APP.BUILD.overlayLoader(n.$view);try{i=this.gatherSendData(),s?n.event.updateEvent(i,t).always(e):n.event.createEvent(i,t).always(e)}catch(t){ServerConnection.stdErrorHandler(t)}}},t.prototype.init=function(){function e(){l.find(".RegistrationFieldOrderNumber").val("").filter(function(){return 0===$(this).closest(":disabled").length}).each(function(t){$(this).val(t+1)})}var i=this,n=i.$wrapper.find(".EditEventPageTabs"),a=i.$wrapper.find(".EditEventBottomButtons").children(),r=a.filter(".EditEventNextPageButton"),o=a.filter(".EditEventPrevPageButton"),s=a.filter(".EditEventSubmitButton"),l=i.$wrapper.find(".RegistrationFields");bindDatePickers(i.$wrapper),bindSelect2(i.$wrapper),bindTabs(i.$wrapper),bindControlSwitch(i.$wrapper),bindCallModal(i.$wrapper),bindLimitInputSize(i.$wrapper),bindRippleEffect(i.$wrapper),bindFileLoadButton(i.$wrapper),ImgLoader.init(i.$wrapper),initSelect2(i.$wrapper.find(".EditEventOrganizationsSelect")).on("change",function(){i.organization_id=+this.value,i.checkTariffAvailabilities(i.organization_id)}).select2("val",i.organization_id),initSelect2(i.$wrapper.find(".EventTags"),{tags:!0,width:"100%",placeholder:"Выберите до 5 тегов",maximumSelectionLength:5,maximumSelectionSize:5,tokenSeparators:[",",";"],multiple:!0,createSearchChoice:function(t,e){if(0===$(e).filter(function(){return 0===this.text.localeCompare(t)}).length)return{id:t,text:t}},ajax:{url:"/api/v1/tags/",dataType:"JSON",data:function(t,e){return{name:t}},results:function(t){var e=[];return t.data.forEach(function(t){t.text=t.name,e.push(t)}),{results:e}}}}),i.checkTariffAvailabilities(i.organization_id),function(){function t(t){t.find(".RemoveRow").not(".-Handled_RemoveRow").each(function(t,e){$(e).on("click",function(){i.MainCalendar.deselectDays($(this).closest("tr").data("date"))}).addClass("-Handled_RemoveRow")})}function e(){c={},i.MainCalendar.selected_days.forEach(function(t,e,i){var n=moment(t);void 0===c[n.month()]&&(c[n.month()]={},c[n.month()].selected_days=[],c[n.month()].month_name=d[n.format("MMMM")]),c[n.month()].selected_days.push(n.date())}),o.empty().removeClass("hidden"),Object.keys(c).length?$.each(c,function(t,e){o.append($("<p>").text(e.selected_days.join(", ")+" "+e.month_name))}):o.html("<p>Даты не выбраны</p>")}function n(t,e){t.sort(function(t,e){var i=$(t).data("date"),n=$(e).data("date");return i>n?1:i<n?-1:0}),t.detach().appendTo(e)}function a(e){var a;a=function(t){t=t instanceof Array?t:[t];var e=moment().format(__C.DATE_FORMAT);return tmpl("selected-table-day",t.map(function(t,i){return{date:t,formatted_date:t.split("-").reverse().join("."),today:e,start_time:__APP.BUILD.formUnit({name:"start_time",type:"time",classes:["StartTime"]}),end_time:__APP.BUILD.formUnit({name:"end_time",type:"time",classes:["EndTime"]})}}))}(e),bindDatePickers(a),t(a),_=_.add(a),a.find(".DatePicker").each(function(){var t=$(this).data("datepicker");t.$datepicker.on("date-picked",function(){i.MainCalendar.deselectDays(t.prev_selected_day).selectDays(t.selected_day),n(_,s)})}),n(_,s)}function r(){if("select"===i.MainCalendar.last_action)a(i.MainCalendar.last_selected_days);else if("deselect"===i.MainCalendar.last_action)if(Array.isArray(i.MainCalendar.last_selected_days)){var t=[];i.MainCalendar.last_selected_days.forEach(function(e){t.push(".TableDay_"+e)}),_.remove(t.join(", ")),_=_.not(t.join(", "))}else _.remove(".TableDay_"+i.MainCalendar.last_selected_days),_=_.not(".TableDay_"+i.MainCalendar.last_selected_days);n(_,s)}var o=i.$wrapper.find(".EventSelectedDaysText"),s=i.$wrapper.find(".SelectedDaysRows"),l=i.$wrapper.find(".AddDayToTable").data("datepicker"),c={},d={"январь":"января","февраль":"февраля","март":"марта","апрель":"апреля","май":"мая","июнь":"июня","июль":"июля","август":"августа","сентябрь":"сентября","октябрь":"октября","ноябрь":"ноября","декабрь":"декабря"},_=$();i.MainCalendar=new Calendar(".EventDatesCalendar",{weekday_selection:!0,month_selection:!0,min_date:moment().format(__C.DATE_FORMAT)}),i.MainCalendar.init(),a(i.MainCalendar.selected_days),i.$wrapper.find(".SelectedDaysRows").toggleStatus("disabled"),i.MainCalendar.$calendar.on("change:days.displayFormattedText",e),i.MainCalendar.$calendar.on("change:days.buildTable",r),l.$datepicker.on("date-picked",function(){i.MainCalendar.selectDays(l.selected_day)})}(),function(){__APP.USER.accounts.contains(OneUser.ACCOUNTS.VK)&&__APP.SERVER.dealAjax(AsynchronousConnection.HTTP_METHODS.GET,"/api/v1/organizations/vk_groups").done(function(t){var e=i.$wrapper.find("select.VkGroupsSelect");e.append(__APP.BUILD.option(t.map(function(t){return{val:t.gid,display_name:t.name,dataset:{img:t.photo}}}))).trigger("change"),1===t.length&&e.prop("disabled",!0).after(__APP.BUILD.input({type:"hidden",name:"vk_guid",value:e.val()})),i.initCrossPosting()})}(),bindCollapsing(i.$wrapper),n=n.resolveInstance(),i.$wrapper.find(".Placepicker").placepicker(),i.$wrapper.find(".EditEventDefaultAddress").off("click.defaultAddress").on("click.defaultAddress",function(){i.$wrapper.find(".Placepicker").val(i.my_organizations.getByID(i.organization_id).default_address).trigger("input").trigger("change")}),i.$wrapper.find(".EditEventIsOnline").off("change.OnlineEvent").on("change.OnlineEvent",function(){i.$wrapper.find("#edit_event_placepicker").prop("required",!$(this).prop("checked"))}),l=i.$wrapper.find(".RegistrationFields").sortable({scroll:!0,animation:150,draggable:".Draggable",handle:".DragHandle",filter:".RemoveRegistrationCustomField",onFilter:function(t){$(t.item).closest(".RegistrationCustomField").remove(),e()},onEnd:e}),l.find(".PredefinedFieldSwitch").on("change",e),i.$wrapper.find(".AddRegistrationCustomField").off("click.AddRegistrationCustomField").on("click.AddRegistrationCustomField",function(){l.append(t.registrationCustomFieldBuilder()),e()}),i.$wrapper.find(".RegistrationLocallySwitch").off("change.EmailRegistrationLocallySwitch").on("change.EmailRegistrationLocallySwitch",function(){i.$wrapper.find(".EmailRegistration").toggleClass(__C.CLASSES.HIDDEN)}),i.$wrapper.find(".RegistrationPreview").on("click.RegistrationPreview",function(){var t=$(this),e=$(this).closest("fieldset").serializeForm(),i=new RegistrationFieldModelsCollection,n=new OneEvent,a=t.data("modal");e.registration_fields&&i.setData(e.registration_fields.map(function(t){return{uuid:guid(),type:e["registration_"+t+"_field_type"],label:e["registration_"+t+"_field_label"]||RegistrationFieldModel.DEFAULT_LABEL[e["registration_"+t+"_field_type"].toUpperCase()],required:e["registration_"+t+"_field_required"],order_number:e["registration_"+t+"_field_order_number"],values:e["registration_"+t+"_field_values"]?e["registration_"+t+"_field_values"].map(function(i){var n=new RegistrationSelectFieldValue;return n.value=e["registration_"+t+"_field_"+i+"_value"],n.uuid=e["registration_"+t+"_field_"+i+"_value_uuid"]||guid(),n}):null}})).sortByOrder(),e.registration_fields=i,n.setData(e),a instanceof PreviewRegistrationModal&&a.destroy(),a=new PreviewRegistrationModal(n),t.data("modal",a),a.show()}),t.checkTicketTypeSellAfter(i.$wrapper.find(".TicketTypes")),n.on("tabs:change",function(){0===n.currentTabsIndex?o.addClass(__C.CLASSES.HIDDEN):o.removeClass(__C.CLASSES.HIDDEN),n.currentTabsIndex===n.tabsCount-1?(r.addClass(__C.CLASSES.HIDDEN),s.removeClass(__C.CLASSES.HIDDEN)):(r.removeClass(__C.CLASSES.HIDDEN),s.addClass(__C.CLASSES.HIDDEN))}),r.off("click.nextPage").on("click.nextPage",n.nextTab),o.off("click.nextPage").on("click.prevPage",n.prevTab),s.off("click.Submit").on("click.Submit",function(){i.submitForm()})},t.prototype.preRender=function(){var e=this,i=moment.unix(this.event.registration_till),n=moment.unix(this.event.public_at),a=this.event.notifications.getByID(OneNotification.NOTIFICATIN_TYPES.ADDITIONAL_FOR_ORGANIZATION),r=a?moment.unix(a.notification_time):null;this.render_vars.organization_options=__APP.BUILD.option(this.my_organizations.map(function(t){return{val:t.id,dataset:{organization:t,"image-url":t.img_url,"default-address":t.default_address},display_name:t.name}})),this.render_vars.start_time=__APP.BUILD.formUnit({label:"Начало",id:"edit_event_start_time",name:"start_time",type:"time",classes:["StartTime","OnChangeCrossPost"],unit_classes:["-inline"],value:this.event.dates.length?this.event.dates[0].start_time:void 0,required:!0}),this.render_vars.end_time=__APP.BUILD.formUnit({label:"Конец",id:"edit_event_end_time",name:"end_time",type:"time",classes:["EndTime"],unit_classes:["-inline"],value:this.event.dates.length?this.event.dates[0].end_time:void 0}),this.render_vars.min_price_input=__APP.BUILD.formUnit({label:"Цена от",id:"edit_event_min_price",name:"min_price",type:"number",unit_classes:["-inline","MinPrice"],classes:["OnChangeCrossPost"],value:this.event.min_price,placeholder:"Минимальная цена"}),this.render_vars.registration_till_date_select=__APP.BUILD.formUnit({label:"Дата окончания регистрации",name:"registration_till_date",type:"date",value:this.event.registration_till?i.format(__C.DATE_FORMAT):void 0,required:!0,unit_classes:["-inline"],attributes:{class:"OnChangeCrossPost"},dataset:{selected_day:this.event.registration_till?i.format(__C.DATE_FORMAT):"",min_date:moment().add(1,"d").format(__C.DATE_FORMAT)}}),this.render_vars.registration_till_time_input=__APP.BUILD.formUnit({label:"Время",id:"edit_event_registration_till_time",type:"time",name:"registration_till_time",value:this.event.registration_till?i.format(__C.TIME_FORMAT):void 0,classes:["OnChangeCrossPost"],unit_classes:["-inline"],required:!0}),this.render_vars.registration_limit_count_input=__APP.BUILD.formUnit({label:"Максимальное кол-во",id:"edit_event_registration_limit_count",name:"registration_limit_count",type:"number",unit_classes:["-inline","RegistrationQuantity"],value:this.event.registration_limit_count,placeholder:"3 000",required:!0}),this.render_vars.registration_predefined_fields=tmpl("edit-event-registration-predefined-field",[{id:t.lastRegistrationFieldId++,order_number:t.lastRegistrationFieldId,type:"last_name",name:"Фамилия",description:"Текстовое поле для ввода фамилии"},{id:t.lastRegistrationFieldId++,order_number:t.lastRegistrationFieldId,type:"first_name",name:"Имя",description:"Текстовое поле для ввода имени"},{id:t.lastRegistrationFieldId++,order_number:t.lastRegistrationFieldId,type:"email",name:"E-mail",description:"Текстовое поле для ввода адреса электронной почты"},{id:t.lastRegistrationFieldId++,order_number:t.lastRegistrationFieldId,type:"phone_number",name:"Номер телефона",description:"Текстовое поля для ввода номера телефона"}]),this.render_vars.add_ticket_type_button=__APP.BUILD.actionButton({title:"Добавить билет",classes:[__C.CLASSES.COLORS.ACCENT,__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.PLUS]}).on("click.AddTicketTypeRow",function(){var i=e.$wrapper.find(".TicketTypes"),n=i.find(".ExpandRow").find(".CollapsingWrapper");0===i.find("tbody").length&&i.append($("<tbody></tbody>")),i=i.find("tbody"),1===i.children().length&&i.children().hasClass("EmptyRow")?i.html(t.ticketTypeRowsBuilder()):i.append(t.ticketTypeRowsBuilder()),t.checkTicketTypeSellAfter(i),n.length&&n.each(function(){$(this).resolveInstance().closeCollapsing()})}),this.render_vars.booking_time_input=__APP.BUILD.formUnit({label:"Срок брони билета",id:"edit_event_booking_time",name:"booking_time",type:"number",helptext:"Количество часов, в течении которых участник может оплатить свой заказ",value:this.event.booking_time||1,required:!0,attributes:{size:2}}),this.render_vars.add_promocode_button=__APP.BUILD.actionButton({title:"Добавить промокод",classes:[__C.CLASSES.COLORS.ACCENT,__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.PLUS]}).on("click.AddPromocodeRow",function(){var i=e.$wrapper.find(".Promocodes");0===i.find("tbody").length&&i.append($("<tbody></tbody>")),i=i.find("tbody"),1===i.children().length&&i.children().hasClass("EmptyRow")?i.html(t.promocodeRowsBuilder()):i.append(t.promocodeRowsBuilder())}),this.render_vars.email_payed_form_unit=__APP.BUILD.formUnit({label:"Сообщение при успешной оплате заказа",id:"edit_event_email_payed_form_unit",name:"email_payed_text",type:"textarea",value:this.event.email_texts.payed}),this.render_vars.email_approved_form_unit=__APP.BUILD.formUnit({label:"Сообщение при подтверждении заявки",id:"edit_event_email_approved_form_unit",name:"email_approved_text",type:"textarea",value:this.event.email_texts.approved}),this.render_vars.email_not_approved_form_unit=__APP.BUILD.formUnit({label:"Сообщение при отказе в заявке",id:"edit_event_email_not_approved_form_unit",name:"email_not_approved_text",type:"textarea",value:this.event.email_texts.not_approved}),this.render_vars.email_after_event_form_unit=__APP.BUILD.formUnit({label:"Сообщение после окончания события",id:"edit_event_email_after_event_form_unit",name:"email_after_event_text",type:"textarea",value:this.event.email_texts.after_event}),this.render_vars.public_at_date_select=__APP.BUILD.formUnit({label:"Дата",name:"public_at_date",type:"date",value:this.event.public_at?n.format(__C.DATE_FORMAT):void 0,required:!0,unit_classes:["-inline"],dataset:{min_date:moment().format(__C.DATE_FORMAT)}}),this.render_vars.public_at_time_input=__APP.BUILD.formUnit({label:"Время",id:"edit_event_public_at_time",name:"public_at_time",type:"time",unit_classes:["-inline"],value:this.event.public_at?n.format(__C.TIME_FORMAT):void 0,required:!0}),this.render_vars.additional_notification_date_select=__APP.BUILD.formUnit({label:"Дата",name:"additional_notification_date",type:"date",value:a?r.format(__C.DATE_FORMAT):void 0,required:!0,unit_classes:["-inline"],dataset:{min_date:moment().format(__C.DATE_FORMAT)}}),this.render_vars.additional_notification_time_input=__APP.BUILD.formUnit({label:"Время",id:"edit_event_additional_notification_time",name:"additional_notification_time",type:"time",unit_classes:["-inline"],value:a?r.format(__C.TIME_FORMAT):void 0,required:!0})},t.prototype.render=function(){return __APP.USER.isLoggedOut()?(__APP.changeState("/feed/actual",!0,!0),null):checkRedirect("event/add",this.organization_id?"/add/event/to/"+this.organization_id:"/add/event")?this.organization_id&&!this.my_organizations.has(this.organization_id)?__APP.changeState("/",!0,!0):(this.organization_id=this.organization_id?this.organization_id:this.my_organizations[0].id,this.preRender(),this.$wrapper.html(tmpl("edit-event-page",this.render_vars)),void this.init()):null},t}()),EditEventPage=extending(AbstractEditEventPage,function(){function t(e){AbstractEditEventPage.call(this),this.page_title="Редактирование события",this.event=new OneEvent(e),this.event_fields=t.fields}return t.fields=new Fields("accept_bitcoins","email_texts","booking_time","promocodes","vk_post_link",{ticket_types:{fields:new Fields("amount","comment","price","sell_start_date","sell_end_date","min_count_per_user","max_count_per_user")}}),t.prototype.fetchData=function(){return this.fetching_data_defer=__APP.SERVER.multipleAjax(this.event.fetchEvent(this.event_fields),this.my_organizations.fetchMyOrganizations(["admin","moderator"],this.my_organizations_fields))},t.prototype.preRender=function(){var t={last_name:{type:"last_name",name:"Фамилия",description:"Текстовое поле для ввода фамилии"},first_name:{type:"first_name",name:"Имя",description:"Текстовое поле для ввода имени"},email:{type:"email",name:"E-mail",description:"Текстовое поле для ввода адреса электронной почты"},phone_number:{type:"phone_number",name:"Номер телефона",description:"Текстовое поля для ввода номера телефона"}},e=[],i=this.event.ticket_types.filter(function(t){return"registration"!==t.type_code});AbstractEditEventPage.prototype.preRender.call(this),this.render_vars.button_text="Сохранить",this.render_vars.image_horizontal_filename=getFilenameFromURL(this.event.image_horizontal_url),this.render_vars.registration_custom_fields=AbstractEditEventPage.registrationCustomFieldBuilder(this.event.registration_fields.filter(RegistrationFieldModel.isCustomField)),this.render_vars.ticket_types=i.length?AbstractEditEventPage.ticketTypeRowsBuilder(i):tmpl("edit-event-tickets-row-empty"),this.render_vars.promocodes=this.event.promocodes.length?AbstractEditEventPage.promocodeRowsBuilder(this.event.promocodes):tmpl("edit-event-promocode-row-empty"),this.render_vars.vk_post_link=this.event.vk_post_link?__APP.BUILD.actionLink(this.event.vk_post_link,"Страница публикации во Вконтакте",[__C.CLASSES.COLORS.ACCENT,"-no_uppercase"],{},{target:"_blank"}):"",this.event.registration_fields.length&&(this.event.registration_fields.filter(RegistrationFieldModel.isPredefinedField).sort(function(t,e){return t.order_number-e.order_number}).forEach(function(i){t[i.type].id=AbstractEditEventPage.lastRegistrationFieldId++,t[i.type].order_number=i.order_number,e.push(t[i.type]),delete t[i.type]}),Object.values(t).forEach(function(t){t.id=AbstractEditEventPage.lastRegistrationFieldId++,e.push(t)}),this.render_vars.registration_predefined_fields=tmpl("edit-event-registration-predefined-field",e))},t.prototype.init=function(){var t=this;AbstractEditEventPage.prototype.init.call(this),function(e,i,n){var a=e.find(".EventDatesCalendar").data("calendar"),r=e.find(".SelectedDaysRows");n||t.$wrapper.find("#edit_event_different_time").prop("checked",!0).trigger("change"),a.selectDays(i.map(function(t){return moment.unix(t.event_date).format(__C.DATE_FORMAT)})),i.forEach(function(t){var e=r.find(".TableDay_"+moment.unix(t.event_date).format(__C.DATE_FORMAT));e.find(".StartTime").val(t.start_time),t.end_time.length&&e.find(".EndTime").val(t.end_time)})}(this.$wrapper,this.event.dates,this.event.is_same_time),this.$wrapper.find("input.EventTags").select2("data",this.event.tags.map(function(t){return{id:parseInt(t.id),text:t.name}})),this.event.image_horizontal_url&&toDataUrl(this.event.image_horizontal_url,function(e){t.$wrapper.find(".HorizontalImageSource").val(e||null)}),empty(this.event.public_at)?this.$wrapper.find(".DelayedPublicationSwitch").toggleStatus("disabled"):this.$wrapper.find(".DelayedPublicationSwitch").prop("checked",!0).trigger("change"),this.event.is_free||this.$wrapper.find(".IsFreeSwitch").prop("checked",!1).trigger("change"),this.event.registration_required&&(this.$wrapper.find("#edit_event_registration_required").prop("checked",!0).trigger("change"),this.event.registration_locally?this.$wrapper.find(".RegistrationLocallySwitch").prop("checked",!0).trigger("change"):this.$wrapper.find("#edit_event_registration_side").prop("checked",!0).trigger("change"),this.event.registration_till&&this.$wrapper.find("#edit_event_registration_limit_by_date").prop("checked",!0).trigger("change"),this.event.registration_limit_count&&this.$wrapper.find("#edit_event_registration_limit_by_quantity").prop("checked",!0).trigger("change"),this.event.registration_approvement_required&&this.$wrapper.find("#edit_event_registration_approvement_required").prop("checked",!0).trigger("change"),this.event.registration_fields.forEach(function(e){RegistrationFieldModel.isCustomField(e)||(t.$wrapper.find("#edit_event_registration_"+e.type+"_field_uuid").val(e.uuid),t.$wrapper.find("#edit_event_registration_"+e.type+"_field_enable").prop("checked",!0).trigger("change"),e.required&&t.$wrapper.find("#edit_event_registration_"+e.type+"_field_required").prop("checked",!0))})),this.event.accept_bitcoins&&this.$wrapper.find(".AcceptBitcoinsCheckbox").prop("checked",!0).trigger("change"),this.event.notifications.has(OneNotification.NOTIFICATIN_TYPES.ADDITIONAL_FOR_ORGANIZATION)&&this.$wrapper.find(".AdditionalNotificationSwitch").prop("disabled",!1).trigger("change"),this.$wrapper.find(".VkPostFieldset").prop("disabled",!0),this.event.vk_post_link&&this.$wrapper.find(".VkPostTrigger").prop("checked",!0)},t}()),AdminEventEditPage=extending(EditEventPage,AdminEventPage,function(){function t(t){var e=this;EditEventPage.call(this,t),AdminEventPage.call(this,t),this.event_fields=EventPage.fields.copy().add(AdminEventPage.fields,EditEventPage.fields),Object.defineProperty(this,"page_title_obj",{get:function(){return[{title:"Организации",page:"/admin"},{title:e.event.organization_short_name,page:"/admin/organization/"+e.event.organization_id},e.event.title+" - редактирование"]}})}return t}()),AdminEventEditPage.prototype.renderHeaderTabs=AdminEventPage.prototype.renderHeaderTabs,AdminEventOrdersPage=extending(AdminEventPage,function(){function t(t){var e=this;AdminEventPage.call(this,t),this.orders=new EventAllOrdersCollection(t),this.orders_fields=new Fields("created_at","registration_fields",{user:{fields:new Fields("email")},tickets:{fields:new Fields("ticket_type")}}),this.event_fields.add("orders_count"),this.$loader=$(),this.ordersTable=null,Object.defineProperties(this,{page_title_obj:{get:function(){return[{title:"Организации",page:"/admin"},{title:e.event.organization_short_name,page:"/admin/organization/"+e.event.organization_id},e.event.title+" - заказы"]}}})}return t.prototype.initOrdersTable=function(){var t=this;this.ordersTable=this.$wrapper.find(".OrdersTable").eq(0).DataTable({paging:!0,columnDefs:[],dom:'t<"data_tables_pagination"p>',language:{url:__LOCALE.DATATABLES_URL}}),this.$wrapper.find(".OrdersTableSearch").on("input",function(){t.ordersTable.search(this.value).draw()})},t.prototype.init=function(){bindDropdown(this.$wrapper)},t.prototype.render=function(){var t=this,e=$();e=e.add(new DropDown("export-formats","Выгрузка",{classes:[__C.CLASSES.SIZES.LOW,__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.DOWNLOAD,__C.CLASSES.COLORS.MARGINAL_PRIMARY,__C.CLASSES.HOOKS.RIPPLE,__C.CLASSES.HOOKS.DROPDOWN_BUTTON]},{width:"self",position:{x:"right",y:5}},{xlsx_href:"/api/v1/statistics/events/"+this.event.id+"/orders/export?format=xlsx",html_href:"/api/v1/statistics/events/"+this.event.id+"/orders/export?format=html"})),this.$wrapper.html(tmpl("admin-event-orders-page",{header_buttons:e,loader:this.$loader=__APP.BUILD.overlayLoader()})),this.orders.fetchAllOrders(this.orders_fields).done(function(){var e=tmpl("admin-event-orders-page-tr",t.orders.map(function(t){return{uuid:t.uuid,number:formatTicketNumber(t.number),status:__APP.BUILD.orderStatusBlock(t.status_type_code),orderer:t.user.full_name,email:t.user.email,buy_time:moment.unix(t.created_at).format(__LOCALE.DATE.DATE_TIME_FORMAT)}}));e.find(".DataTableRowExpand").on("click.ExpandRow",function(){var e,i,n,a=$(this),r=a.closest("tr"),o=t.ordersTable.row(r);o.child.isShown()||(o.child(tmpl("admin-event-orders-page-table-child-row",{ticket_rows:tmpl("admin-event-orders-page-ticket-row",t.orders.getByID(r.data("order_uuid")).tickets.map(function(t){return $.extend({},t,{number:formatTicketNumber(t.number),ticket_type_name:t.ticket_type.name,price:t.price?t.price:"Бесплатно",used:t.checkout?"Билет использован":""})}))})).show(),r.addClass("-has_child")),e=o.child(),i=e.find(".CollapsingWrapper"),n=e.find(".CollapsingContent"),i.height()?i.height(0).removeClass("-opened"):i.height(n.outerHeight()).addClass("-opened"),a.toggleClass([__C.CLASSES.ACTIVE,__C.CLASSES.ICONS.PLUS,__C.CLASSES.ICONS.MINUS].join(" "))}),e.on("click.SelectRow",function(i){var n=$(this),a=n.data();$(i.target).hasClass("DataTableRowExpand")||(a.inspector&&a.inspector.is_shown?a.inspector.hide():(a.inspector instanceof OrderAppInspector||(a.inspector=new OrderAppInspector(t.orders.getByID(n.data("order_uuid")),t.event),n.data(a)),a.inspector.show()),e.not(n).removeClass("-selected"),n.toggleClass("-selected"))}),t.ordersTable||t.initOrdersTable(),t.ordersTable.rows.add(e).draw(),t.$loader.remove(),t.$wrapper.find(".OrdersTableWrapper").removeClass(__C.CLASSES.STATUS.DISABLED)}),
this.init()},t}()),AdminEventOverviewPage=extending(AdminEventPage,function(){function t(t){AdminEventPage.apply(this,arguments),this.graphics_stats=new EventStatistics(this.id),this.scoreboards_stats=new EventStatistics(this.id),this.event_fields.add(new Fields("favored_users_count","is_same_time","dates"))}return t.prototype.render=function(){var t=this;if(this.renderHeaderTabs(),__APP.changeTitle([{title:"Организации",page:"/admin"},{title:this.event.organization_short_name,page:"/admin/organization/"+this.event.organization_id},this.event.title]),!checkRedirect("overview","/admin/event/"+this.event.id+"/overview",!0))return null;this.$wrapper.html(tmpl("eventstat-overview",$.extend(!0,{},this.event,{cover_width:280,dates_block:tmpl("eventstat-overview-datetime",{date:displayDateRange(this.event.first_event_date,this.event.last_event_date),time:this.event.is_same_time?displayTimeRange(this.event.dates[0].start_time,this.event.dates[0].end_time):"Разное время"})}))),this.$wrapper.find(".EventStatAreaCharts").children(".AreaChart").html(tmpl("loader")),this.scoreboards_stats.fetchStatistics(Statistics.SCALES.OVERALL,!1,["notifications_sent","view","fave","view_detail","fave_conversion","open_conversion"],null,function(e){var i={numbers:{}};$.each(e,function(t,e){i.numbers[t]=e[0].value}),t.updateScoreboards(t.$wrapper.find(".EventstatsScoreboards"),i,{fave:"Добавлений в избранное",view:"Просмотров события"},["fave","view"]),t.updateScoreboards(t.$wrapper.find(".EventstatsBigScoreboards"),i,{notifications_sent:"Уведомлений отправлено",view:"Просмотров",view_detail:"Открытий",open_conversion:"Конверсия открытий",fave:"Добавлений",fave_conversion:"Конверсия добавлений"},["notifications_sent","view","view_detail","open_conversion","fave","fave_conversion"],"big")}),this.graphics_stats.fetchStatistics(Statistics.SCALES.DAY,moment(__APP.EVENDATE_BEGIN,"DD-MM-YYYY").format(),["notifications_sent","view","fave","view_detail","fave_conversion","open_conversion"],null,function(e){t.buildAreaCharts(e,{rangeSelector:{selected:1}})}),__APP.MODALS.bindCallModal(t.$wrapper),bindPageLinks(t.$wrapper)},t}()),AdminEventRequestsPage=extending(AdminEventPage,function(){function t(t){var e=this,n={shouldSort:!0,threshold:.1,distance:1e3,keys:["number","user.full_name"]};AdminEventPage.call(this,t),this.event_fields.add("orders_count"),this.requests=new i(t),this.requests_fields=new Fields("created_at","registration_fields",{user:{fields:new Fields("email")}}),this.$loader=$(),this.$new_requests_list=$(),this.$approved_requests_list=$(),this.$rejected_requests_list=$(),this.current_requests_list="new",this.$requests_detail=$(),this.Tabs=$(),Object.defineProperties(this,{page_title_obj:{get:function(){return[{title:"Организации",page:"/admin"},{title:e.event.organization_short_name,page:"/admin/organization/"+e.event.organization_id},e.event.title+" - заявки"]}},new_requests_fuse:{get:function(){return new Fuse(e.requests.new_requests,n)}},approved_requests_fuse:{get:function(){return new Fuse(e.requests.approved_requests,n)}},rejected_requests_fuse:{get:function(){return new Fuse(e.requests.rejected_requests,n)}}})}var e=extending(OneOrder,function(){function t(t,e){OneOrder.call(this,t,e)}return t.fetchRequest=OneOrder.fetchOrder,t.prototype.approveRequest=function(t){return this.changeStatus(OneOrder.ORDER_STATUSES.APPROVED,t)},t.prototype.rejectRequest=function(t){return this.changeStatus(OneOrder.ORDER_STATUSES.REJECTED,t)},t}()),i=extending(EventAllOrdersCollection,function(){function t(t){var e=this;EventAllOrdersCollection.call(this,t),Object.defineProperties(this,{new_requests:{get:function(){return e.filter(function(t){return t.status_type_code===OneOrder.ORDER_STATUSES.IS_PENDING})}},approved_requests:{get:function(){return e.filter(function(t){return t.status_type_code===OneOrder.ORDER_STATUSES.APPROVED})}},rejected_requests:{get:function(){return e.filter(function(t){return t.status_type_code===OneOrder.ORDER_STATUSES.REJECTED})}}})}return t.prototype.collection_of=e,t.fetchOrders=t.fetchRequests=EventAllOrdersCollection.fetchOrders,t.prototype.fetchAllRequests=EventAllOrdersCollection.prototype.fetchAllOrders,t}());return t.prototype.requestItemBuilder=function(t){var e=this,i=t instanceof Array?t:[t],n=tmpl("event-admin-request-item",i.map(function(t){var e=[];return t.status_type_code!==OneOrder.ORDER_STATUSES.IS_PENDING&&t.status_type_code!==OneOrder.ORDER_STATUSES.APPROVED||e.push({title:"Отклонить",classes:[__C.CLASSES.COLORS.MARGINAL,"RejectRequest"]}),t.status_type_code!==OneOrder.ORDER_STATUSES.IS_PENDING&&t.status_type_code!==OneOrder.ORDER_STATUSES.REJECTED||e.push({title:"Принять заявку",classes:[__C.CLASSES.COLORS.ACCENT,"ApproveRequest"]}),{orderer_avatar:__APP.BUILD.avatars(t.user,{classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]}),order_number:formatTicketNumber(t.number),request_time:t.m_created_at.format(__LOCALE.DATE.TIME_FORMAT),request_date:t.m_created_at.format("D MMMM"),orderer_full_name:t.user.full_name,action_buttons:__APP.BUILD.actionButton(e)}}));return n.length?n.each(function(t){var n=$(this),a=i[t];n.data("request",a),n.on("click.SelectRequestItem",function(t){var i=$(t.target);i.closest(".ApproveRequest").length||i.closest(".RejectRequest").length||e.selectRequestItem(this)}),n.find(".ApproveRequest").on("click.ApproveRequest",function(){e.approveRequest(n)}),n.find(".RejectRequest").on("click.RejectRequest",function(){var t;a.rejectRequest().done(function(){t=e.requestItemBuilder(a),e.$rejected_requests_list.append(t),n.hasClass("-item_selected")&&e.selectRequestItem(t),n.remove()})})}):n=tmpl("event-admin-no-request-items"),n},t.prototype.selectRequestItem=function(t){var e=this,i=t instanceof jQuery?t:$(t),n=i.data("request");e.$wrapper.find(".RequestItem").not(i).removeClass("-item_selected"),i.addClass("-item_selected"),e.$requests_detail.html(tmpl("event-admin-request-detail",{order_number:formatTicketNumber(n.number),orderer_full_name:n.user.full_name,orderer_avatar:__APP.BUILD.avatars(n.user,{classes:[__C.CLASSES.SIZES.X55,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.UNIVERSAL_STATES.SHADOWED]}),registration_fields:__APP.BUILD.registrationFields(n.registration_fields)}))},t.prototype.approveRequest=function(t){var e,i=this,n=t instanceof jQuery?t:$(t),a=n.data("request");a.approveRequest().done(function(){e=i.requestItemBuilder(a),i.$approved_requests_list.append(e),n.hasClass("-item_selected")&&i.selectRequestItem(e),n.remove()})},t.prototype.init=function(){var t=this;bindTabs(this.$wrapper,!1),this.Tabs=this.$wrapper.find(".Tabs").resolveInstance(),this.$wrapper.find(".RequestsListScrollbar").scrollbar(),this.$wrapper.find(".RequestDetailScrollbar").scrollbar(),this.$wrapper.find(".ApproveAllRequests").on("click.ApproveAllRequests",function(){t.$new_requests_list.find(".RequestItem").each(function(){t.approveRequest(this)})}),function(t){var e=t.$wrapper.find(".RequestsPageHeaderWrapper"),i=t.$wrapper.find(".RequestsPageSearch");i.on("keydown",function(t){27===t.keyCode&&i.val("").blur()}).on("input.Search",function(){var e=t[t.current_requests_list+"_requests_fuse"].search($(this).val());t["$"+t.current_requests_list+"_requests_list"].html(t.requestItemBuilder(e))}).on("blur.CloseSearchBar",function(){""===i.val()&&(e.removeClass("-open_search_bar"),t["$"+t.current_requests_list+"_requests_list"].html(t.requestItemBuilder(t.requests[t.current_requests_list+"_requests"])))}),t.$wrapper.find(".RequestsPageSearchButton").on("click.OpenSearchBar",function(){e.hasClass("-open_search_bar")||e.addClass("-open_search_bar"),i.is(":focus")||i.focus()}),t.Tabs.on("tabs:change",function(){i.val("").blur()})}(this),this.Tabs.on("tabs:change",function(){t.current_requests_list=$(this).find(".Tab").filter("."+__C.CLASSES.ACTIVE).data("requests_list_name")})},t.prototype.render=function(){var t=this;this.$wrapper.html(tmpl("event-admin-requests-page",{loader:this.$loader=__APP.BUILD.loaderBlock(),request_detail:tmpl("event-admin-request-detail-no-select")})),this.$requests_detail=this.$wrapper.find(".RequestDetail"),this.requests.fetchAllRequests(this.requests_fields).done(function(){var e;t.requests.sortBy("created_at"),e=tmpl("event-admin-requests-lists",{new_requests:t.requestItemBuilder(t.requests.new_requests),approved_requests:t.requestItemBuilder(t.requests.approved_requests),rejected_requests:t.requestItemBuilder(t.requests.rejected_requests)}),t.$loader.remove(),t.$wrapper.find(".RequestsLists").html(e),t.$wrapper.find(".OrdersTableWrapper").removeClass(__C.CLASSES.STATUS.DISABLED),t.$new_requests_list=e.find(".NewRequestsList"),t.$approved_requests_list=e.find(".ApprovedRequestsList"),t.$rejected_requests_list=e.find(".RejectedRequestsList"),t.init()})},t}()),AdminOrganizationPage=extending(AdminPage,function(){function t(t){AdminPage.apply(this),this.id=t,this.organization=new OneOrganization(this.id),this.with_header_tabs=!0,this.organization_fields=new Fields("privileges")}return t.prototype.fetchData=function(){return this.fetching_data_defer=this.organization.fetchOrganization(this.organization_fields)},t.prototype.renderHeaderTabs=function(){__APP.renderHeaderTabs([{title:"Обзор",page:"/admin/organization/"+this.id+"/overview"},{title:"События",page:"/admin/organization/"+this.id+"/events"},{title:"CRM",page:"/admin/organization/"+this.id+"/crm"},{title:"Настройки",page:"/admin/organization/"+this.id+"/settings"},{title:"Редактирование",page:"/admin/organization/"+this.id+"/edit"}])},t}()),AdminOrganizationCRMPage=extending(AdminOrganizationPage,function(){function t(t){var e=this;AdminOrganizationPage.call(this,t),this.organization_fields=this.organization_fields.add("subscribed_count"),this.subscribers_fields=new Fields("email","accounts_links","interests"),this.organization_subscribers=new OrganizationSubscribersCollection(t),this.CRMTable=null,this.$loader=$(),Object.defineProperty(this,"page_title_obj",{get:function(){return[{title:"Организации",page:"/admin"},e.organization.short_name+" - CRM"]}})}return t.TABLE_COLUMNS=["name","email","accounts","gender","country","city","auth_date","subscription_date","unsubscription_date","organization_page_view","event_page_view","notifications_received","notifications_opened","notifications_hidden","registrations","favored","shared_event","average_check","overall_average_check","spent_on_me","overall_spent","friends","loyalty","solvency"],t.prototype.initCRMTable=function(){var t=this;this.CRMTable=this.$wrapper.find(".CRMTable").eq(0).DataTable({paging:!0,select:{style:"single",selector:"td",className:"-selected",info:!1},columnDefs:[{targets:0,width:350},{targets:1,width:550},{targets:2,width:90},{targets:3,width:60},{targets:range(24,4),width:100,visible:!1,searchable:!1}],fixedColumns:!0,scrollX:"100%",scrollCollapse:!0,dom:'t<"data_tables_pagination"p>',language:{url:__LOCALE.DATATABLES_URL}}),this.$wrapper.find(".CRMTableSearch").on("input",function(){t.CRMTable.search(this.value).draw()})},t.prototype.toggleColumn=function(e){var i=this.CRMTable.column(+e===e?e:t.TABLE_COLUMNS.indexOf(e));i.visible(!i.visible()),this.CRMTable.rows().recalcHeight().columns.adjust().fixedColumns().relayout().draw()},t.prototype.init=function(){this.initCRMTable(),bindDropdown(this.$wrapper)},t.prototype.render=function(){var t=this,e=$();e=e.add(new DropDown("export-formats","Выгрузка",{classes:[__C.CLASSES.SIZES.LOW,__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.DOWNLOAD,__C.CLASSES.COLORS.MARGINAL_PRIMARY,__C.CLASSES.HOOKS.RIPPLE,__C.CLASSES.HOOKS.DROPDOWN_BUTTON]},{width:"self",position:{x:"right",y:5}},{xlsx_href:"/api/v1/statistics/organizations/"+this.organization.id+"/subscribers/export?format=xlsx",html_href:"/api/v1/statistics/organizations/"+this.organization.id+"/subscribers/export?format=html"})),this.$wrapper.html(tmpl("admin-organization-crm-page",{header_buttons:e,loader:this.$loader=__APP.BUILD.overlayLoader()})),this.$wrapper.find(".CRMTableWrapper").addClass(__C.CLASSES.STATUS.DISABLED),this.init(),this.organization_subscribers.fetchAllSubscribers(this.subscribers_fields).done(function(e){var i=tmpl("admin-organization-crm-page-tr",e.map(function(t){return{user_avatar_block:__APP.BUILD.avatarBlocks(t,{entity:__C.ENTITIES.USER,avatar_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]}),email:t.email,accounts:__APP.BUILD.socialLinks(t.accounts_links),gender:function(t){switch(t){case OneUser.GENDER.MALE:return"М";case OneUser.GENDER.FEMALE:return"Ж";default:case OneUser.GENDER.NEUTRAL:return"—"}}(t.gender)}}));i.each(function(t){$(this).data("client",e[t])}),t.CRMTable||t.initCRMTable(),t.CRMTable.rows.add(i).draw();try{t.CRMTable.rows().recalcHeight().columns.adjust().fixedColumns().relayout().draw()}catch(t){__APP.reload()}t.CRMTable.on("deselect",function(){$("body").off("keyup.DeselectCurrent"),AbstractAppInspector.hideCurrent()}),t.CRMTable.on("select",function(t,e,i,n){var a,r;"row"===i&&(a=$(e.row(n).node()),r=a.data(),r.inspector&&r.inspector.is_shown?(r.inspector.hide(),$("body").off("keyup.DeselectCurrent")):(r.inspector instanceof ClientAppInspector||(r.inspector=new ClientAppInspector(r.client),a.data(r)),r.inspector.show(),$("body").off("keyup.DeselectCurrent").on("keyup.DeselectCurrent",function(t){isKeyPressed(t,__C.KEY_CODES.ESC)&&e.row(n).deselect()})))}),t.$wrapper.find(".CRMTableWrapper").removeClass(__C.CLASSES.STATUS.DISABLED),t.$loader.remove()})},t}()),AbstractEditOrganizationPage=extending(Page,function(){function t(){Page.call(this),this.organization=new OneOrganization,this.categories=new CategoriesCollection,this.cities=new CitiesCollection,this.state_name="admin",this.fields=new Fields("description","site_url","default_address","vk_url","privileges","facebook_url","email"),this.adding_is_over=!1}return t.prototype.init=function(){function t(){var t,i=e.$wrapper.find("#add-organization-form"),n=new OrganizationModel,a=i.serializeForm(),r=function(t,e){var i=!0,n=t.find("#edit_event_different_time").prop("checked")?t.find('[class^="TableDay_"]'):t.find(".MainTime");return t.find(":required").not(":disabled").each(function(){var t=$(this),e=t.data("maxlength");(""===t.val()||e&&t.val().length>e)&&(i&&$("body").stop().animate({scrollTop:Math.ceil(t.offset().top-150)},1e3,"swing"),handleErrorField(t),i=!1)}),n.each(function(){var t=$(this);t.find(".StartHours").val()+t.find(".StartMinutes").val()>t.find(".EndHours").val()+t.find(".EndMinutes").val()&&(i&&$("body").stop().animate({scrollTop:Math.ceil(t.offset().top-150)},1e3,"swing"),showNotifier({text:"Начальное время не может быть меньше конечного",status:!1}),i=!1)}),e||t.find(".DataUrl").each(function(){var t=$(this);""===t.val()&&(i&&$("body").stop().animate({scrollTop:Math.ceil(t.closest(".EditEventImgLoadWrap").offset().top-150)},1e3,"swing",function(){showNotifier({text:"Пожалуйста, добавьте обложку организации",status:!1})}),i=!1)}),i}(i,!!a.organization_id),o=e.organization.id?"updateOrganization":"createOrganization";r&&(e.$wrapper.addClass(__C.CLASSES.STATUS.DISABLED),t=__APP.BUILD.overlayLoader(e.$view),n.setData(a),e.organization[o](n,function(){e.adding_is_over=!0;try{sessionStorage.removeItem("organization_info")}catch(t){}$(".SidebarNav").find(".ContinueRegistration").remove(),socket.emit("utils.registrationFinished",{uuid:e.$wrapper.find("#add_organization_organization_registration_uuid").val()}),socket.emit("utils.updateImages"),__APP.changeState("/organization/"+e.organization.id)}).always(function(){e.$wrapper.removeClass(__C.CLASSES.STATUS.DISABLED),t.remove()}))}var e=this;!function(e){bindSelect2(e),bindTabs(e),bindLimitInputSize(e),bindRippleEffect(e),bindFileLoadButton(e),ImgLoader.init(e),e.find("#add_organization_address").placepicker(),e.find("#add_organization_submit").off("click.Submit").on("click.Submit",t)}(this.$wrapper),bindCallModal(this.$wrapper),function(t){e.categories.fetchCategories({},0,function(i){var n=e.$wrapper.find("#add_organization_type");n.html(tmpl("option",i.map(function(t){return{val:t.id,display_name:t.name}}))),initSelect2(n),t&&n.select2("val",t)})}(this.organization.type_id),function(t){var i=e.$wrapper.find("#add_organization_city");e.cities.fetchCities(null,0,"local_name",function(){i.append(tmpl("option",e.cities.map(function(t){return{val:t.id,display_name:t.local_name}}))),initSelect2(i),t&&i.select2("val",t)})}(this.organization.city_id||__APP.USER.selected_city.id)},t.prototype.render=function(){if(!checkRedirect("organization/add","/add/organization"))return null;this.renderRest(),this.init()},t.prototype.renderRest=function(t){},t}()),EditOrganizationPage=extending(AbstractEditOrganizationPage,function(){function t(t){AbstractEditOrganizationPage.call(this),this.page_title="Редактировать организацию",this.organization=new OneOrganization(t),this.adding_is_over=!0}return t.prototype.fetchData=function(){var t=this.cities.fetchCities(null,0,"local_name");return this.organization.id?this.fetching_data_defer=__APP.SERVER.multipleAjax(t,this.organization.fetchOrganization(this.fields)):this.fetching_data_defer=t},t.prototype.renderRest=function(){var t,e=this;if(this.organization.role===OneUser.ROLE.USER)return __APP.changeState("/",!0,!0);this.adding_is_over=!0,t=$.extend(!0,{},this.organization),t.header_text=this.page_title,t.background_img_url&&(t.background_filename=t.background_img_url.split("/").reverse()[0]),t.img_url&&(t.logo_filename=t.img_url.split("/").reverse()[0]),this.$wrapper.html(tmpl("add-organization-page",t)),t.img_url&&toDataUrl(t.img_url,function(t){e.$wrapper.find("#add_organization_img_src").val(t||null)}),t.background_img_url&&toDataUrl(t.background_img_url,function(t){e.$wrapper.find("#add_organization_background_src").val(t||null)})},t}()),AdminOrganizationEditPage=extending(EditOrganizationPage,AdminOrganizationPage,function(){function t(t){var e=this;EditOrganizationPage.call(this,t),AdminOrganizationPage.call(this,t),Object.defineProperty(this,"page_title_obj",{get:function(){return[{title:"Организации",page:"/admin"},e.organization.short_name+" - редактирование"]}})}return t}()),AdminOrganizationEditPage.prototype.renderHeaderTabs=AdminOrganizationPage.prototype.renderHeaderTabs,AdminOrganizationEventsPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.apply(this,arguments),this.block_scroll=!1,this.future_events_data={future:!0,canceled_shown:!0},this.past_events_data={future:!1,canceled_shown:!0,order_by:"-first_event_date"},this.future_events=new EventsWithStatisticsCollection,this.past_events=new EventsWithStatisticsCollection}return t.buildEventRows=function(t,e){var i=tmpl("orgstat-events-row",t.map(function(t){return $.extend({},t,{date:moment.unix(t[e]).format(__LOCALES.ru_RU.DATE.DATE_FORMAT),timestamp:t[e],conversion:Math.round(0==t.view?t.view:100*t.view_detail/t.view)+"%"})}));return bindPageLinks(i),i},t.prototype.render=function(){var e,i,n=this,a=$(window);if(this.organization.role===OneUser.ROLE.USER)return __APP.changeState("/",!0,!0);this.renderHeaderTabs(),__APP.changeTitle([{title:"Организации",page:"/admin"},this.organization.short_name+" - события"]),this.$wrapper.html(tmpl("orgstat-events-page")),this.future_events.fetchOrganizationsEvents(this.organization.id,this.future_events_data,ServerConnection.MAX_ENTITIES_LENGTH,function(){this.length?n.$wrapper.find(".OrgStatFutureEventsWrapper").html(tmpl("orgstat-events-wrapper",{title:"Предстоящие события",rows:t.buildEventRows(n.future_events,"nearest_event_date")})).find("table").tablesort():n.$wrapper.find(".OrgStatFutureEventsWrapper").html(tmpl("orgstat-no-events-wrapper",{title:"Предстоящие события",call_to_action:__APP.BUILD.link({title:"Добавить событие",page:"/add/event/to/"+n.organization.id,classes:[__C.CLASSES.COMPONENT.BUTTON,__C.CLASSES.COLORS.ACCENT]})}))}),this.past_events.fetchOrganizationsEvents(this.organization.id,this.past_events_data,30,function(){this.length&&(e=n.$wrapper.find(".OrgStatPastEventsWrapper"),e.html(tmpl("orgstat-events-wrapper",{title:"Прошедшие события",rows:t.buildEventRows(n.past_events,"first_event_date")})),i=e.find("table").tablesort(),a.on("scroll.uploadEvents",function(){a.height()+a.scrollTop()+200>=$(document).height()&&!n.block_scroll&&(n.block_scroll=!0,n.past_events.fetchOrganizationsEvents(n.organization.id,n.past_events_data,30,function(a){n.block_scroll=!1,a.length?(e.find("tbody").append(t.buildEventRows(a,"first_event_date")),i.refresh()):$(window).off("scroll.uploadEvents")}))}))})},t}()),AdminOrganizationOverviewPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.call(this,t),this.graphics_stats=new OrganizationsStatistics(this.id),this.other_stats=new OrganizationsStatistics(this.id),this.organization_fields=new Fields("description","img_medium_url","default_address","staff","privileges",{events:{length:3,filters:"future=true,is_canceled=false,is_delayed=true",fields:new Fields("organization_short_name","public_at"),order_by:"nearest_event_date"}})}return t.buildStaffBlock=function(t,e,i,n){return i.length?tmpl("orgstat-overview-sidebar-wrapper-title",{title:e}).add(__APP.BUILD.staffAvatarBlocks(t,i,{is_link:!0,entity:__C.ENTITIES.USER,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]},n===OneUser.ROLE.ADMIN)):$()},t.prototype.buildAreaCharts=function(){var t=this;AdminPage.prototype.buildAreaCharts.call(t,{subscribe_unsubscribe:t.graphics_stats.subscribe.map(function(e,i){return{time_value:e.time_value,subscribe:e.value,unsubscribe:t.graphics_stats.unsubscribe[i].value}}),view:t.graphics_stats.view,conversion:t.graphics_stats.conversion})},t.prototype.buildPieChart=function(t,e){var i={chart:{type:"pie",height:200,style:{fontFamily:"inherit",fontSize:"inherit"}},colors:[__C.COLORS.FRANKLIN,__C.COLORS.ACCENT,__C.COLORS.MUTED,__C.COLORS.MUTED_80,__C.COLORS.MUTED_50,__C.COLORS.MUTED_30],tooltip:{pointFormat:"<b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{center:[45,"50%"],allowPointSelect:!0,cursor:"pointer",size:120,dataLabels:{inside:!1,distance:-35,overflow:"none",crop:!1,defer:!1,formatter:function(){return this.percentage>15?Math.round(this.percentage)+"%":null},useHTML:!0,style:{color:"#fff",fontSize:"16px",fontWeight:"300",textShadow:"none",textOutline:"none",textOverflow:"none"},y:-6},showInLegend:!0}},legend:{align:"right",verticalAlign:"top",layout:"vertical",width:100,symbolPadding:15,symbolHeight:0,symbolWidth:0,itemMarginBottom:5,labelFormatter:function(){return'<span style="color: '+this.color+'">'+this.name+"</span>"},useHTML:!0,itemStyle:{cursor:"pointer",fontSize:"14px",fontWeight:"500"},y:12}};t.highcharts($.extend(!0,{},this.highchart_defaults,i,{series:function(t){var e={browser:"Браузер",android:"Аndroid",ios:"iOS",female:"Женщины",male:"Мужчины",other:"Остальные",null:"Не указано"};return[{data:t.map(function(t,i){return{name:t.name?e[t.name]:e[t.gender],y:t.count}})}]}(e)}))},t.prototype.render=function(){function e(t){return $.extend({},t,{is_link:!0,avatar_classes:["-size_40x40","-rounded"]})}var i=this,n={scale:Statistics.SCALES.WEEK,fields:["subscribe","view","fave","conversion"]},a="org_stats_"+this.id+"_data",r="org_stats_"+this.id+"_until",o=moment.unix(sessionStorage.getItem(r)).isAfter(moment());if(!checkRedirect("overview","/admin/organization/"+this.organization.id+"/overview",!0))return null;this.renderHeaderTabs(),__APP.changeTitle([{title:"Организации",page:"/admin"},this.organization.short_name]),this.$wrapper.html(tmpl("orgstat-overview",$.extend(!0,{},this.organization,{avatar_block:__APP.BUILD.avatarBlocks(this.organization,{entity:__C.ENTITIES.ORGANIZATION,block_classes:["-stack"]}),staff_block:t.buildStaffBlock(this.organization.id,"Администраторы",this.organization.admins.map(e),this.organization.role).add(t.buildStaffBlock(this.organization.id,"Модераторы",this.organization.moderators.map(e),this.organization.role)),event_blocks:this.organization.events.length?tmpl("orgstat-overview-sidebar-wrapper",{content:tmpl("orgstat-overview-sidebar-wrapper-title",{title:"Предстоящие события"}).add(tmpl("orgstat-event-block",this.organization.events.map(function(t){var e=[];return t.canceled&&e.push({title:"Отменено"}),t.public_at&&moment.unix(t.public_at).isBefore()&&e.push({title:"Не опубликовано"}),{id:t.id,title:t.title,organization_short_name:t.organization_short_name,day:moment.unix(t.first_event_date).format("D"),month:moment.unix(t.first_event_date).format("MMM"),badges:tmpl("orgstat-event-block-badge",e)}})))}):""}))),o?(this.graphics_stats.setData(JSON.parse(sessionStorage.getItem(a))),this.buildAreaCharts()):(this.$wrapper.find(".OrgStatAreaCharts").children(".AreaChart").append(tmpl("loader")),this.graphics_stats.fetchStatistics(Statistics.SCALES.DAY,moment(__APP.EVENDATE_BEGIN,"DD-MM-YYYY").format(),["view","subscribe","unsubscribe","conversion"],null,function(){sessionStorage.setItem(a,JSON.stringify(i.graphics_stats)),sessionStorage.setItem(r,moment().add(15,"m").unix()),i.buildAreaCharts()})),this.other_stats.fetchStatistics(Statistics.SCALES.OVERALL,!1,["subscribe","view","fave","conversion","audience"],n,function(t){var e={numbers:{},dynamics:{}};$.each(t.dynamics,function(i,n){e.dynamics[i]=n[0].value,e.numbers[i]=t[i][0].value}),i.buildPieChart(i.$wrapper.find(".GenderPieChart"),this.audience.gender),i.buildPieChart(i.$wrapper.find(".DevicePieChart"),this.audience.devices),i.updateScoreboards(i.$wrapper.find(".Scoreboards"),e,{subscribe:"Подписчиков организатора",fave:"Добавлений в избранное",view:"Просмотров организатора",conversion:"Конверсия открытий/подписок"},["subscribe","fave","view","conversion"])}),bindRippleEffect(this.$wrapper),bindPageLinks(this.$wrapper)},t}()),AdminOrganizationPromotionPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.apply(this,arguments)}return t.prototype.render=function(){},t}()),AdminOrganizationSettingsPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.call(this,t),this.organization_fields=new Fields("city","country","default_address","description","brand_color","is_private","email","privileges","staff","site_url",{tariff:{fields:new Fields("till","available_additional_notifications","available_event_publications","available_tickets_selling","available_telegram_bots","available_slack_bots","available_auditory_analytics","available_in_city","price")}})}return t.buildStaffBlock=function(t,e,i,n){return __APP.BUILD.staffAvatarBlocks(t,e,{is_link:!0,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]},n===OneUser.ROLE.ADMIN).add(__APP.BUILD.addUserAvatarBlock(t,i,{avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]}))},t.prototype.updateOrganizationData=function(){return this.organization.updateOrganization(new OrganizationModel(this.organization))},t.prototype.init=function(){var t=this;bindCallModal(this.$wrapper),bindRippleEffect(this.$wrapper),this.$wrapper.find("#org_admin_settings_is_private").on("change",function(){t.organization.is_private=$(this).prop("checked"),t.updateOrganizationData()}),this.$wrapper.find(".SaveLocal").on("click",function(){t.organization.setData($(this).closest(".SaveLocalWrapper").serializeForm()),t.updateOrganizationData()}),this.$view.on("staff:add",function(e,i,n){var a=t.$wrapper.find(".StaffCollection");t.organization.staff.remove(n.id),t.organization.staff.setData(n),a.find(".User"+n.id).remove(),a.filter(function(t,e){return $(e).data("staff_type")===i}).children("."+__C.CLASSES.HOOKS.ADD_STAFF).before(__APP.BUILD.avatarBlocks(n,{is_link:!0,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]})),bindPageLinks(a)}),this.$wrapper.find(".ActivatePayment").on("click",function(){Payment.payForTariff(t.organization.id,function(t){Payment.doPayment(t.uuid,t.sum)})})},t.prototype.render=function(){var e=this;__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED;this.renderHeaderTabs(),__APP.changeTitle([{title:"Организации",page:"/admin"},this.organization.short_name+" - настройки"]),this.$wrapper.html(tmpl("admin-organization-settings-page",$.extend({},this.organization,{admin_avatar_blocks:t.buildStaffBlock(this.organization.id,this.organization.admins,OneUser.ROLE.ADMIN,this.organization.role),moderator_avatar_blocks:t.buildStaffBlock(this.organization.id,this.organization.moderators,OneUser.ROLE.MODERATOR,this.organization.role),private_checkbox:__APP.BUILD.checkbox({id:"org_admin_settings_is_private",name:"is_private",label:"Закрытая организация",attributes:{checked:e.organization.is_private}}),subdomain_radio:__APP.BUILD.radio({id:"org_admin_settings_subdomain_enabled",name:"domains"}),other_domain_radio:__APP.BUILD.radio({id:"org_admin_settings_other_domain_enabled",name:"domains"}),tariff_button:__APP.BUILD.button({title:"Оплатить",classes:[__C.CLASSES.COLORS.ACCENT,__C.CLASSES.HOOKS.RIPPLE,"ActivatePayment"]}),tariff_service_info:e.organization.tariff.is_full?"Оплачен до "+moment.unix(e.organization.tariff.till).calendar(null,{sameDay:"[Сегодня]",nextDay:"[Завтра]",nextWeek:"D MMMM YYYY",lastWeek:"D MMMM YYYY",sameElse:"D MMMM YYYY"}):""}))),this.init()},t.prototype.destroy=function(){this.$view.off("staff:add")},t}()),AdminOrganizationSupportPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.apply(this,arguments)}return t.prototype.render=function(){},t}()),NotFoundPage=extending(Page,function(){function t(){Page.call(this)}return t.prototype.render=function(){__APP.changeTitle("Страница не найдена")},t}()),AddEventPage=extending(AbstractEditEventPage,function(){function t(t){AbstractEditEventPage.call(this),this.page_title="Добавить событие",this.organization_id=t}return t.prototype.preRender=function(){AbstractEditEventPage.prototype.preRender.call(this),this.render_vars.button_text="Опубликовать",this.render_vars.ticket_types=tmpl("edit-event-tickets-row-empty")},t}()),EventPage=extending(Page,function(){function t(t){var e=this,i=["title","description","image_horizontal_url"];Page.call(this),this.event=new OneEvent(t),this.render_vars={cover_width:630,avatars_collection:null,action_buttons:null,event_map:null,event_edit_functions:null,event_additional_info:null,organization_avatar_block:null,event_additional_fields:null,overlay_cap:null},this.calendar=null,i.forEach(function(t){Object.defineProperty(e.render_vars,t,{enumerable:!0,get:function(){return e.event[t]}})}),this.$overlay_cap=$()}return t.fields=new Fields(["image_horizontal_medium_url","image_horizontal_large_url","favored_users_count","is_favorite","description","location","latitude","longitude","is_online","can_edit","is_free","min_price","organization_logo_small_url","organization_short_name","is_same_time","tags","detail_info_url","canceled","public_at","is_registered","registration_locally","registration_available","registration_required","registration_approvement_required","registration_till","registration_limit_count","registration_fields","registration_approved","registered_count","registered","ticketing_locally","ticketing_available"],{dates:{length:0,fields:new Fields("start_time","end_time")},favored:{fields:new Fields("is_friend"),order_by:"-is_friend",length:10},notifications:{fields:new Fields("notification_type","done")},orders:{fields:new Fields("created_at","order_content")},tickets:{fields:new Fields("created_at","number","ticket_type")}}),t.buildNotifications=function(t){var e=moment(),i={},n={},a=0;i[OneNotification.NOTIFICATIN_TYPES.BEFORE_QUARTER_OF_HOUR]={label:"За 15 минут",moment:moment.unix(t.last_event_date).subtract(15,"minutes").unix()},i[OneNotification.NOTIFICATIN_TYPES.BEFORE_THREE_HOURS]={label:"За 3 часа",moment:moment.unix(t.last_event_date).subtract(3,"hours").unix()},i[OneNotification.NOTIFICATIN_TYPES.BEFORE_DAY]={label:"За день",moment:moment.unix(t.last_event_date).subtract(1,"days").unix()},
i[OneNotification.NOTIFICATIN_TYPES.BEFORE_THREE_DAYS]={label:"За 3 дня",moment:moment.unix(t.last_event_date).subtract(3,"days").unix()},i[OneNotification.NOTIFICATIN_TYPES.BEFORE_WEEK]={label:"За неделю",moment:moment.unix(t.last_event_date).subtract(1,"week").unix()};for(var r in t.notifications)t.notifications.hasOwnProperty(r)&&(n[t.notifications[r].notification_type]=t.notifications[r]);return __APP.BUILD.checkbox(Object.keys(i).map(function(r){var o=moment.unix(i[r].moment).isBefore(e),s={id:"event_notify_"+ ++a,classes:["ToggleNotification"],name:"notification_time",label:i[r].label,attributes:{value:r},dataset:{event_id:t.id}};return n[r]&&(o=o||n[r].done||!n[r].uuid,n[r].uuid&&(s.dataset.uuid=n[r].uuid),s.attributes.checked=!0),o&&(s.unit_classes=[__C.CLASSES.STATUS.DISABLED],s.attributes.disabled=!0),s})).each(function(){$(this).on("change",":checkbox",function(){var e=$(this);e.prop("disabled",!0),e.prop("checked")?t.addNotification(e.val(),function(t){e.data("uuid",t.uuid),e.prop("disabled",!1)}):t.deleteNotification(e.data("uuid"),function(){e.data("uuid",void 0),e.prop("disabled",!1)})})})},t.prototype.fetchData=function(){return this.fetching_data_defer=this.event.fetchEvent(t.fields)},t.prototype.init=function(){var t=this;trimAvatarsCollection(t.$wrapper),bindRippleEffect(t.$wrapper),bindDropdown(t.$wrapper),__APP.MODALS.bindCallModal(t.$wrapper),bindCollapsing(t.$wrapper),bindPageLinks(t.$wrapper),t.$wrapper.find(".ToggleNotification").each(function(){var e=$(this);e.on("change",function(){e.prop("disabled",!0),e.prop("checked")?t.event.addNotification(e.val(),function(t){e.data("uuid",t.uuid),e.prop("disabled",!1)}):t.event.deleteNotification(e.data("uuid"),function(){e.data("uuid",void 0),e.prop("disabled",!1)})})}),t.$wrapper.find(".CancelEvent").on("click.CancelEvent",function(){t.event.changeEventStatus(OneEvent.STATUS.CANCEL,function(){t.$wrapper.find(".EventPage").append(t.$overlay_cap)})}),t.$wrapper.find(".ExternalLink").on("click.sendStat",function(){storeStat(t.event.id,__C.STATS.EVENT_ENTITY,__C.STATS.EVENT_OPEN_SITE)}),t.$wrapper.find(".EventMap").on("click.sendStat",function(){storeStat(t.event.id,__C.STATS.EVENT_ENTITY,__C.STATS.EVENT_OPEN_MAP)})},t.prototype.preRender=function(){var e=this,i={is_add_avatar:!0,is_checked:this.event.is_favorite,classes:[__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.RIPPLE],colors:{unchecked:__C.CLASSES.COLORS.NEUTRAL_ACCENT,unchecked_hover:__C.CLASSES.COLORS.NEUTRAL_ACCENT}},n=$();this.event.registration_locally||this.event.ticketing_locally?(i.labels=null,i.classes.push(__C.CLASSES.UNIVERSAL_STATES.EMPTY)):i.classes.push("event_main_action_button"),this.event.can_edit&&(n=__APP.BUILD.button({title:"Вернуть событие",classes:[__C.CLASSES.COLORS.PRIMARY,__C.CLASSES.HOOKS.RIPPLE]}),n.on("click.CancelCancellation",function(){e.event.changeEventStatus(OneEvent.STATUS.BRING_BACK,function(){e.$overlay_cap.detach()})}),bindRippleEffect(n)),this.$overlay_cap=__APP.BUILD.overlayCap($("<p>Организатор отменил событие</p>").add(n)),this.render_vars.avatars_collection=__APP.BUILD.avatarCollection(this.event.favored,6,{dataset:{modal_type:"favors",modal_event_id:this.event.id},classes:[__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.SIZES.SMALL,__C.CLASSES.HOOKS.ADD_AVATAR.COLLECTION,__C.CLASSES.HOOKS.CALL_MODAL,this.event.is_favorite?__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED:""],counter_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.COLORS.MARGINAL,__C.CLASSES.HOOKS.ADD_AVATAR.STATES.CASTABLE]},this.event.favored_users_count),this.render_vars.action_buttons=$(),__APP.USER.isLoggedOut()||(this.render_vars.action_buttons=this.render_vars.action_buttons.add(new DropDown("event-edit-notifications","",{classes:[__C.CLASSES.UNIVERSAL_STATES.EMPTY,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.SIZES.LOW,__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.BELL_O,__C.CLASSES.COLORS.NEUTRAL,__C.CLASSES.HOOKS.RIPPLE,__C.CLASSES.HOOKS.DROPDOWN_BUTTON]},{width:190,position:{x:"center",y:6}},{notifications:t.buildNotifications(this.event)}))),this.render_vars.action_buttons=this.render_vars.action_buttons.add(new AddToFavoriteButton(this.event.id,i)),(this.event.ticketing_locally||this.event.registration_locally)&&(this.render_vars.action_buttons=this.render_vars.action_buttons.add(new OrderButton(this.event,{classes:["event_main_action_button",__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.RIPPLE],colors:{unchecked:__C.CLASSES.COLORS.NEUTRAL_ACCENT,unchecked_hover:__C.CLASSES.COLORS.NEUTRAL_ACCENT}}))),this.event.location&&(this.render_vars.event_map=tmpl("event-map",{location_sanitized:encodeURI(this.event.location)})),this.event.can_edit&&(this.render_vars.event_edit_functions=tmpl("event-edit-functions",this.event)),this.render_vars.event_additional_info=$(),this.event.registration_required&&(this.render_vars.event_additional_info=this.render_vars.event_additional_info.add(tmpl("event-additional-info",{classes:__C.CLASSES.TEXT_COLORS.ACCENT+" "+__C.CLASSES.UNIVERSAL_STATES.UPPERCASE,text:this.event.registration_till?"Регистрация до "+moment.unix(this.event.registration_till).calendar(null,__LOCALES.ru_RU.DATE.CALENDAR_DATE_TIME):"Регистрация обязательна"}))),this.event.is_free||(this.render_vars.event_additional_info=this.render_vars.event_additional_info.add(tmpl("event-additional-info",{classes:__C.CLASSES.TEXT_COLORS.ACCENT,text:"от "+(this.event.min_price?formatCurrency(this.event.min_price):"0")+" руб."}))),this.event.is_online&&(this.render_vars.event_additional_info=this.render_vars.event_additional_info.add(tmpl("event-additional-info",{classes:__C.CLASSES.TEXT_COLORS.ACCENT,text:"Online"}))),this.render_vars.event_additional_fields=$(),this.event.is_same_time?this.render_vars.event_additional_fields=this.render_vars.event_additional_fields.add(tmpl("event-additional-field",{key:"Время",value:displayTimeRange(this.event.dates[0].start_time,this.event.dates[0].end_time)})):this.render_vars.event_additional_fields=this.render_vars.event_additional_fields.add(tmpl("event-date-time",{date_times:tmpl("event-date-time-row",formatDates(this.event.dates,{date:"{D} {MMMMs}",time:"{T}"},this.event.is_same_time))})),this.event.location&&(this.render_vars.event_additional_fields=this.render_vars.event_additional_fields.add(tmpl("event-additional-field",{key:"Место",value:this.event.location}))),this.render_vars.event_additional_fields=this.render_vars.event_additional_fields.add(tmpl("event-additional-field",{key:"Теги",value:__APP.BUILD.tags(this.event.tags)})),this.event.detail_info_url&&(this.render_vars.event_additional_fields=this.render_vars.event_additional_fields.add(tmpl("event-detail-link",{detail_info_url:this.event.detail_info_url}))),this.render_vars.organization_avatar_block=__APP.BUILD.avatarBlocks(this.event.organization,{block_classes:[__C.CLASSES.SIZES.SMALL],is_link:!0,entity:__C.ENTITIES.ORGANIZATION}),this.event.canceled&&(this.render_vars.overlay_cap=this.$overlay_cap)},t.prototype.render=function(){var t=this,e=t.event,i=this.event.nearest_event_date?moment.unix(this.event.nearest_event_date):moment.unix(this.event.first_event_date);__APP.changeTitle(e.title),this.preRender(),this.$wrapper.html(tmpl("event-page",this.render_vars)),this.event.is_same_time&&(this.calendar=new Calendar(this.$wrapper.find(".EventCalendar"),{classes:{wrapper_class:"feed_calendar_wrapper",td_class:"event_calendar_day",table_class:"feed_calendar_table"},selection_type:Calendar.SELECTION_TYPES.MULTI,disable_selection:!0}),this.calendar.init().setMonth(i.format("M"),i.format("YYYY")).selectDays(this.event.dates.map(function(t){return moment.unix(t.event_date).format(__C.DATE_FORMAT)}))),this.init()},t}()),AdminOrganizationsPage=extending(AdminPage,function(){function t(){AdminPage.call(this),this.is_upload_disabled=!1,this.block_scroll=!1,this.my_organizations_fields=new Fields("img_medium_url","subscribed_count","staff"),this.page_title="Организации",this.my_organizations=new OrganizationsCollection}return t.buildMyOrganizationsBlocks=function(t){return tmpl("statistics-overview-organization",t.map(function(t){var e=[{name:OneUser.ROLE.ADMIN,title:"Администраторы",staff:t.admins,plural_name:OneUser.ROLE.ADMIN+"s_block"},{name:OneUser.ROLE.MODERATOR,title:"Модераторы",staff:t.moderators,plural_name:OneUser.ROLE.MODERATOR+"s_block"}];return $.extend(!0,{},t,{subscribers:t.subscribed_count+getUnitsText(t.subscribed_count,__LOCALES.ru_RU.TEXTS.SUBSCRIBERS),buttons:__APP.BUILD.linkButton({title:"Редактировать",classes:[__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.PENCIL,__C.CLASSES.COLORS.NEUTRAL,__C.CLASSES.HOOKS.RIPPLE],page:"/admin/organization/"+t.id+"/edit"},{title:"Создать событие",classes:[__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.PLUS,__C.CLASSES.COLORS.ACCENT,__C.CLASSES.HOOKS.RIPPLE],page:"/add/event/to/"+t.id})},e.reduce(function(e,i){return e[i.plural_name]=__APP.BUILD.avatarCollection(i.staff.map(function(t){return $.extend({},t,{is_link:!0,avatar_classes:["-size_100x100","-rounded"]})}),2,{dataset:{modal_type:"editors",modal_specific_role:i.name,modal_title:i.title,modal_organization_id:t.id},classes:["-size_30x30","-rounded","-shifted","CallModal"],counter_classes:["-size_30x30","-color_marginal_primary"]}),e},{}))}))},t.prototype.fetchData=function(){return this.fetching_data_defer=this.my_organizations.fetchMyOrganizations([OneUser.ROLE.ADMIN,OneUser.ROLE.MODERATOR],this.my_organizations_fields,10,"")},t.prototype.bindOrganizationsEvents=function(t){return trimAvatarsCollection(t),bindPageLinks(t),__APP.MODALS.bindCallModal(t),bindRippleEffect(t),t},t.prototype.init=function(){var e=this;this.bindOrganizationsEvents(this.$wrapper),$(window).on("scroll.uploadOrganizations",function(){var i,n,a;!isScrollRemain(200)||e.is_upload_disabled||e.block_scroll||(e.block_scroll=!0,n=e.$wrapper.find(".StatOverviewOrganizations"),i=__APP.BUILD.loaderBlock(n),e.my_organizations.fetchMyOrganizations([OneUser.ROLE.ADMIN,OneUser.ROLE.MODERATOR],e.my_organizations_fields,10,"",function(r){e.block_scroll=!1,i.remove(),a=t.buildMyOrganizationsBlocks(r),r.length?(n.append(a),e.bindOrganizationsEvents(a)):e.is_upload_disabled=!0}))})},t.prototype.render=function(){if(-1===__APP.USER.id)return __APP.changeState("/feed/actual",!0,!0),null;this.$wrapper.html(tmpl("statistics-overview-wrapper",{organizations:t.buildMyOrganizationsBlocks(this.my_organizations)})),this.init()},t.prototype.destroy=function(){$(window).off("scroll.uploadOrganizations")},t}()),OrderPage=extending(Page,function(){function t(t){var e=this;Page.call(this),this.event=new OneEvent(t),this.event_fields=new Fields("accept_bitcoins","ticketing_locally","ticketing_available","registration_locally","registration_required","registration_available","registration_fields",{ticket_types:{fields:new Fields("is_selling","comment","price","min_count_per_user","max_count_per_user")}}),this.promocode=new OnePromocode(t),this.promocode_fields=new Fields,this.is_promocode_active=!1,this.overall_sum=0,this.render_vars={event_id:t,tickets_selling:null,registration:null,pay_button:null,register_button:null,main_action_button:null,legal_entity_payment_button:null,bitcoin_payment_button:null},Object.defineProperties(this,{page_title:{get:function(){return(e.event.ticketing_locally?"Заказ билетов на событие ":"Регистрация на событие ")+e.event.title}},total_sum:{get:function(){var t=0;return e.is_promocode_active?(t=e.promocode.is_fixed?e.overall_sum-e.promocode.effort:e.overall_sum-e.overall_sum*e.promocode.effort/100,t<=0?0:t):e.overall_sum}}})}return t.prototype.fetchData=function(){return this.fetching_data_defer=this.event.fetchEvent(this.event_fields)},t.buildRegistrationField=function(t){var e={id:"registration_form_"+t.uuid,name:t.uuid,unit_classes:["Registration"+t.type.toCamelCase("_")+"Field"],label:$("<span>"+t.label+"</span>").add(t.required?tmpl("required-star"):$()),required:t.required};switch(t.type){case RegistrationFieldModel.TYPES.SELECT:return function(t,e){return tmpl("form-unit",Builder.normalizeBuildProps({unit_classes:t.unit_classes,label:tmpl("label",{id:t.id,label:t.label}),form_element:__APP.BUILD.select(e.map(function(t){return{display_name:t.value,val:t.uuid||guid()}}),{id:t.id,name:t.name,required:t.required},t.classes)}))}($.extend({},e,{classes:["form_select2","ToSelect2"]}),t.values instanceof Array?t.values:[]);case RegistrationFieldModel.TYPES.SELECT_MULTI:return function(t,e){return tmpl("form-unit",Builder.normalizeBuildProps($.extend(!0,{},t,{unit_classes:t.classes,label:tmpl("label",{id:t.id+"_label",label:t.label}),form_element:__APP.BUILD.checkbox.apply(__APP.BUILD,e.map(function(e){return{id:"registration_field_value_"+(e.uuid||guid()),name:t.name,label:e.value,attributes:{value:e.uuid||guid(),required:t.required}}}))})))}($.extend({},e,{type:"checkbox"}),t.values instanceof Array?t.values:[]);default:return __APP.BUILD.formUnit($.extend({},e,{type:t.type===RegistrationFieldModel.TYPES.EXTENDED_CUSTOM?"textarea":t.type,placeholder:t.label,helptext:function(t){switch(t){case RegistrationFieldModel.TYPES.EMAIL:return"На почту Вам поступит сообщение с подтверждением регистрации";case RegistrationFieldModel.TYPES.FIRST_NAME:return"Используйте настоящее имя для регистрации";case RegistrationFieldModel.TYPES.LAST_NAME:return"Используйте настоящюю фамилию для регистрации";default:return""}}(t.type)}))}},t.prototype.disablePage=function(t){this.$wrapper.find(".OrderFormWrapper").addClass(__C.CLASSES.DISABLED).attr("disabled",!0),this.$wrapper.find(".OrderPage").append(__APP.BUILD.overlayCap(tmpl("order-overlay-cap-content",{message:t,return_button:__APP.BUILD.link({page:"/event/"+this.event.id,title:"Вернуться на страницу события",classes:[__C.CLASSES.COMPONENT.BUTTON,__C.CLASSES.COLORS.PRIMARY]})})))},t.prototype.gatherSendData=function(){return{tickets:this.$wrapper.find(".OrderFields").serializeForm("array").reduce(function(t,e){return+e.value&&t.push({uuid:e.name,count:+e.value}),t},[]),registration_fields:this.$wrapper.find(".RegistrationFields").serializeForm("array").map(function(t){return{uuid:t.name,value:t.value}}),promocode:this.$wrapper.find(".PromocodeInput").val()}},t.prototype.init=function(){function t(t){var e=t.find(".TicketTypeSum"),i=t.find(".QuantityInput").val();i>0?e.removeClass(__C.CLASSES.HIDDEN):e.addClass(__C.CLASSES.HIDDEN),t.find(".TicketTypeSumText").text(formatCurrency(t.data("ticket_type").price*i))}function e(){r.overall_sum=Array.prototype.reduce.call(r.$wrapper.find(".TicketTypeSumText"),function(t,e){return t+parseInt(e.innerHTML.replace(" ",""))},0),r.$wrapper.find(".TicketsOverallSum").text(formatCurrency(r.overall_sum)),r.is_promocode_active&&r.$wrapper.find(".TicketsTotalSum").text(formatCurrency(r.total_sum)),0===r.total_sum?$.contains(r.$wrapper[0],r.render_vars.pay_button[0])&&(r.render_vars.pay_button.after(r.render_vars.register_button),r.render_vars.pay_button.detach(),u=r.render_vars.register_button,d.addClass(__C.CLASSES.HIDDEN)):$.contains(r.$wrapper[0],r.render_vars.register_button[0])&&(r.render_vars.register_button.after(r.render_vars.pay_button),r.render_vars.register_button.detach(),u=r.render_vars.pay_button,d.removeClass(__C.CLASSES.HIDDEN))}function i(t){var e,i=r.$wrapper.find(".OrderForm");return __APP.USER.isLoggedOut()?(new AuthModal(window.location.href).show(),!1):!!isFormValid(i)&&(e=r.gatherSendData(),isFunction(t)?t(e):(u.attr("disabled",!0),r.event.makeOrder(e.tickets,e.registration_fields,e.promocode).always(function(t){return u.removeAttr("disabled"),t}).promise()))}var n,a,r=this,o=parseUri(location),s=this.$wrapper.find(".ActivatePromocode"),l=this.$wrapper.find(".PromocodeInput"),c=this.$wrapper.find(".QuantityInput"),d=this.$wrapper.find(".PayButtons"),_=this.$wrapper.find(".OrderFormFooter"),u=this.render_vars.register_button;this.event.ticketing_locally||_.removeClass(__C.CLASSES.HIDDEN),bindRippleEffect(this.$wrapper),bindControlSwitch(this.$wrapper),initSelect2(this.$wrapper.find(".ToSelect2"),{dropdownCssClass:"form_select2_drop form_select2_drop_no_search"}),s.on("click.ActivatePromocode",function(){var t=r.$wrapper.find(".OrderFormWrapper"),i=l.val();""===i?showNotifier({status:!1,text:"Пожалуйста, введите промокод"}):(t.attr("disabled",!0),r.promocode.fetchPromocodebyCodeName(i,r.promocode_fields,function(){var i=t.find(".PromocodeWrapper");t.removeAttr("disabled"),i.after(tmpl("order-tickets-selling-promocode",{effort:r.promocode.effort+(r.promocode.is_fixed?" ₽":"%")})),i.addClass(__C.CLASSES.HIDDEN),r.is_promocode_active=!0,e()},function(){showNotifier({status:!1,text:"Указанный промокод не существует или более не активен"}),t.removeAttr("disabled"),l.focus().select()}))}),l.on("keypress",function(t){isKeyPressed(t,__C.KEY_CODES.ENTER)&&s.trigger("click.ActivatePromocode")}),this.$wrapper.find(".RegistrationFirstNameField").find("input").val(__APP.USER.first_name),this.$wrapper.find(".RegistrationLastNameField").find("input").val(__APP.USER.last_name),this.$wrapper.find(".RegistrationEmailField").find("input").val(__APP.USER.email),c.on("QuantityInput::change",function(i,n){Array.prototype.reduce.call(c,function(t,e){return t||0!==e.value},!1)?_.removeClass(__C.CLASSES.HIDDEN):_.addClass(__C.CLASSES.HIDDEN),t($(this).closest(".TicketType")),e()}),this.$wrapper.find(".TicketType").each(function(){t($(this))}),e(),o.queryKey.ticket_selected&&(a=this.$wrapper.find(".TicketType").filter(function(){return $(this).data().ticket_type.name===o.queryKey.ticket_selected}),a.length&&a.find(".QuantityInput").resolveInstance().increment()),this.render_vars.pay_button.on("click.MakeOrder",function(){var t,e=o.queryKey.away_to||window.location.origin+"/event/"+r.event.id;__APP.IS_WIDGET?i(function(t){n=r.$wrapper.find(".OrderFormPayload"),n.val(JSON.stringify(Object.assign({redirect_to_payment:!0,callback_url:e},t))),r.$wrapper.find(".OrderForm").submit()}):!1!==(t=i())&&t.done(function(t){Payment.doPayment("order-"+t.order.uuid,t.order.sum,e)})}),this.render_vars.register_button.on("click.Register",function(){var t=i();!1!==t&&t.done(function(t){var e,i=!!o.queryKey.away_to,n=o.queryKey.away_to||"/event/"+r.event.id;i?(e=parseUri(n),window.location=e.wo_query+"?registration=free&"+e.query):(__APP.changeState(n),showNotifier({text:"Регистрация прошла успешно",status:!0}))})}),this.event.ticketing_locally&&this.render_vars.legal_entity_payment_button.on("click.LegalEntityPayment",function(){var t=i();!1!==t&&t.done(function(t){var e=parseUri(location);try{window.localStorage.setItem(r.event.id+"_order_info",JSON.stringify(e.queryKey))}catch(t){}__APP.changeState(e.path+"/"+t.order.uuid+"/from_legal_entity")})}),this.event.accept_bitcoins&&this.render_vars.bitcoin_payment_button.on("click.BitcoinPayment",function(){var t,e=$(this);e.data("modal")?(t=e.data("modal"),t.show()):i().done(function(i){t=new BitcoinModal(r.event,i.order.uuid),e.data("modal",t),t.show()})})},t.prototype.preRender=function(){var e=this;this.event.ticketing_locally&&(this.render_vars.tickets_selling=tmpl("order-tickets-selling",{ticket_types:tmpl("order-ticket-type",this.event.ticket_types.map(function(t){return{name:t.name,ticket_type_uuid:t.uuid,quantity_input:new QuantityInput({name:t.uuid},{min:t.min_count_per_user||0,max:t.max_count_per_user||t.amount||30}),description:t.comment,type_price:formatCurrency(t.price),sum_price:0}})),overall_price:0}),this.render_vars.tickets_selling.find(".TicketType").each(function(t){var i=$(this);i.data("ticket_type",e.event.ticket_types[t]),e.event.ticket_types[t].is_selling||i.attr("disabled",!0)})),this.event.registration_locally&&(this.render_vars.registration=tmpl("order-registration",{registration_fields:$.makeSet(this.event.registration_fields.map(t.buildRegistrationField))})),this.render_vars.pay_button=__APP.BUILD.button({title:"Заплатить через Яндекс",classes:[__C.CLASSES.COLORS.YANDEX,__C.CLASSES.HOOKS.RIPPLE,__C.CLASSES.UNIVERSAL_STATES.NO_UPPERCASE,"MainActionButton",__C.CLASSES.SIZES.WIDE,__C.CLASSES.SIZES.HUGE]}),this.render_vars.register_button=__APP.BUILD.button({title:"Зарегистрироваться",classes:[__C.CLASSES.COLORS.ACCENT,__C.CLASSES.HOOKS.RIPPLE,__C.CLASSES.UNIVERSAL_STATES.NO_UPPERCASE,"MainActionButton",__C.CLASSES.SIZES.WIDE,__C.CLASSES.SIZES.HUGE]}),this.render_vars.main_action_button=this.render_vars.register_button,this.event.ticketing_locally&&(this.render_vars.legal_entity_payment_button=__APP.BUILD.button({title:"Оплатить через юр. лицо",classes:[__C.CLASSES.COLORS.MARGINAL_PRIMARY,__C.CLASSES.TEXT_WEIGHT.LIGHTER,__C.CLASSES.HOOKS.RIPPLE,"LegalEntityPaymentButton",__C.CLASSES.SIZES.WIDE,__C.CLASSES.SIZES.BIG,__C.CLASSES.UNIVERSAL_STATES.NO_UPPERCASE]})),this.event.accept_bitcoins&&(this.render_vars.bitcoin_payment_button=__APP.BUILD.button({title:"Заплатить через Bitcoin",classes:[__C.CLASSES.COLORS.MARGINAL_PRIMARY,__C.CLASSES.TEXT_WEIGHT.LIGHTER,__C.CLASSES.HOOKS.RIPPLE,"BitcoinPaymentButton",__C.CLASSES.SIZES.WIDE,__C.CLASSES.SIZES.BIG,__C.CLASSES.UNIVERSAL_STATES.NO_UPPERCASE]}))},t.prototype.render=function(){if(__APP.USER.isLoggedOut())return new AuthModal(window.location.href,!1).show();this.preRender(),this.$wrapper.html(tmpl("order-page",this.render_vars)),this.event.ticketing_locally?this.event.ticketing_available||this.disablePage("Заказ билетов на событие невозможен"):this.event.registration_locally&&!this.event.registration_available&&this.disablePage("Регистрация на событие не доступно"),this.init()},t}()),LegalEntityPayment=extending(Page,function(){function t(t,e){var i=this;Page.call(this);try{this.order_info=JSON.parse(window.localStorage.getItem(t+"_order_info"))||{}}catch(t){this.order_info={}}this.order=new OneExtendedOrder(t,e),this.order_fields=new Fields("sum"),this.render_vars={event_id:t,order_uuid:e,event_info:null,receivers_form_field:null,company_form_field:null,inn_form_field:null,kpp_form_field:null,real_address_form_field:null,post_address_form_field:null,bank_name_form_field:null,bic_form_field:null,correspondent_account_form_field:null,checking_account_form_field:null,signer_name_form_field:null,signer_position_form_field:null,self_name_form_field:null,self_email_form_field:null,self_phone_form_field:null,back_to_link:null},this.$submit_button=$(),Object.defineProperties(this,{event:{get:function(){return i.order.event}},page_title:{get:function(){return"Оплата участия на событие "+i.event.title+" от юридического лица"}}})}return t.prototype.fetchData=function(){return this.fetching_data_defer=this.order.fetchOrder(this.order_fields)},t.prototype.init=function(){var t=this,e=this.$wrapper.find(".CompanyNameInput"),i=this.$wrapper.find(".InnInput"),n=this.$wrapper.find(".KppInput"),a=this.$wrapper.find(".AddressInput"),r=this.$wrapper.find(".BankNameInput"),o=this.$wrapper.find(".BikInput"),s=this.$wrapper.find(".CorrespondentAccountInput");e.on("input.ToggleCompanyInfo",function(){""!==$(this).val().trim()&&t.$wrapper.find(".CompanyAdditionalInfo").removeClass(__C.CLASSES.HIDDEN)}),e.add(i).suggestions({token:__C.API_TOKENS.DADATA,type:"PARTY",count:5,onSelect:function(t){e.val(t.unrestricted_value).trigger("change"),t.data&&(i.val(t.data.inn).trigger("change"),n.val(t.data.kpp).trigger("change"),t.data.address&&a.val(t.data.address.value).trigger("change"))}}),r.on("input.ToggleBankInfo",function(){""!==$(this).val().trim()&&t.$wrapper.find(".BankAdditionalInfo").removeClass(__C.CLASSES.HIDDEN)}),r.add(o).suggestions({token:__C.API_TOKENS.DADATA,type:"BANK",count:5,onSelect:function(t){r.val(t.unrestricted_value).trigger("change"),t.data&&(o.val(t.data.bic).trigger("change"),s.val(t.data.correspondent_account).trigger("change"))}}),this.$submit_button.on("click.SubmitForm",function(){var e,i=t.$wrapper.find(".LegalEntityPaymentForm");isFormValid(i)&&(e=__APP.BUILD.overlayLoader(t.$wrapper),t.order.makeLegalEntityPayment(i.serializeForm()).done(function(){var n=t.$wrapper.find(".LegalEntityPaymentContract");try{window.localStorage.removeItem(t.event.id+"_order_info")}catch(t){}e.remove(),showNotifier({text:"Договор-счет сформирован, вы можете его открыть, либо скачать",status:!0}),i.attr("disabled",!0),t.$wrapper.find(".LegalEntityPaymentFooter").addClass(__C.CLASSES.HIDDEN),n.removeClass(__C.CLASSES.HIDDEN),scrollTo(n,400)}))})},t.prototype.preRender=function(){this.render_vars.event_info=__APP.BUILD.fields([{name:"Название события:",value:this.event.title},{name:"Дата события:",value:displayDateRange(this.event.first_event_date,this.event.last_event_date)},{name:"Сумма платежа:",value:formatCurrency(this.order.sum)+" руб."}]),this.render_vars.receivers_form_field=__APP.BUILD.formUnit({label:"Перечислите ФИО участников от компании",id:"legal_entity_payment_receivers",name:"participants",type:"textarea",helptext:"По одному участнику на каждой строке",required:!0}),this.render_vars.company_form_field=__APP.BUILD.formUnit({label:"Название компании",id:"legal_entity_payment_company_name",name:"company_name",classes:"CompanyNameInput",placeholder:"Начните вводить чтобы появились предложения",helptext:"Полное наименование организации, включая форму предприятия",required:!0}),this.render_vars.inn_form_field=__APP.BUILD.formUnit({label:"ИНН",id:"legal_entity_payment_inn",name:"company_inn",classes:"InnInput",placeholder:"Попробуйте найти организацию через ИНН",helptext:"10 или 12 знаков в зависимости от организационной формы",required:!0,attributes:{maxlength:12}}),this.render_vars.kpp_form_field=__APP.BUILD.formUnit({label:"КПП",id:"legal_entity_payment_kpp",name:"company_kpp",classes:"KppInput",helptext:"9 знаков, если у вас нет КПП - поставьте прочерк",required:!0,attributes:{maxlength:9}}),this.render_vars.real_address_form_field=__APP.BUILD.formUnit({label:"Юридический адрес",id:"legal_entity_payment_real_address",name:"company_address",classes:"AddressInput",helptext:"Например: 150000, Россия, Москыв, ул. Ленина, д. 108, корп. 1, кв. 8",required:!0}),this.render_vars.bank_name_form_field=__APP.BUILD.formUnit({label:"Наименование банка",id:"legal_entity_payment_bank_name",name:"bank_name",classes:"BankNameInput",placeholder:"Начните вводить чтобы появились предложения",helptext:"Полное наименование банка, включая отделение (если есть)",required:!0}),this.render_vars.bic_form_field=__APP.BUILD.formUnit({label:"БИК",id:"legal_entity_payment_bic",name:"bank_bik",classes:"BikInput",placeholder:"Попробуйте найти банк через БИК",helptext:"9 знаков",required:!0,attributes:{maxlength:9}}),this.render_vars.correspondent_account_form_field=__APP.BUILD.formUnit({label:"Корреспондентский счет",id:"legal_entity_payment_correspondent_account",name:"bank_correspondent_account",classes:"CorrespondentAccountInput",helptext:"20 знаков",required:!0,attributes:{maxlength:20},inputmask:{}}),this.render_vars.checking_account_form_field=__APP.BUILD.formUnit({label:"Расчетный счет",id:"legal_entity_payment_checking_account",name:"bank_payment_account",helptext:"20 знаков",required:!0,attributes:{maxlength:20}}),this.render_vars.signer_name_form_field=__APP.BUILD.formUnit({label:"ФИО подписывающего лица",id:"legal_entity_payment_signer_name",name:"signer_full_name",helptext:"ФИО лица, подписывающего договор (полностью). Например, Иванов Иван Иванович",required:!0}),this.render_vars.signer_position_form_field=__APP.BUILD.formUnit({label:"Должность подписывающего лица",id:"legal_entity_payment_signer_position",name:"signer_position",helptext:"Должность директора или ответственного лица, подписывающего договор",required:!0}),this.render_vars.self_name_form_field=__APP.BUILD.formUnit({label:"Ваши имя и фамилия",id:"legal_entity_payment_self_name",name:"contact_full_name",value:__APP.USER.full_name,required:!0}),this.render_vars.self_email_form_field=__APP.BUILD.formUnit({label:"Ваш e-mail",id:"legal_entity_payment_self_email",name:"contact_email",value:__APP.USER.email,helptext:"На него мы вышлем заполненный договор",required:!0}),this.render_vars.self_phone_form_field=__APP.BUILD.formUnit({label:"Контактный телефон",id:"legal_entity_payment_self_phone",name:"contact_phone_number",helptext:"В формате: +7 (xxx) xxx-xx-xx",required:!0}),this.render_vars.submit_button=this.$submit_button=__APP.BUILD.button({classes:[__C.CLASSES.SIZES.HUGE,__C.CLASSES.COLORS.ACCENT,"LegalEntityPaymentSubmit"],title:"Сформировать договор-счет"}),this.render_vars.back_to_link=__APP.BUILD.link({title:"Назад к событию",page:"/event/{event_id}".format({event_id:this.event.id})})},t.prototype.render=function(){if(empty(this.order_info),__APP.USER.isLoggedOut())return new AuthModal(window.location.href,!1).show();this.preRender(),this.$wrapper.html(tmpl("legal-entity-payment-page",this.render_vars)),this.init()},t}()),OnboardingPage=extending(Page,function(){function t(){Page.apply(this,arguments),this.ajax_data={length:30,offset:0,fields:"img_small_url"},this.state_name="onboarding_page",this.is_upload_disabled=!1,this.block_scroll=!0}return t.prototype.init=function(){bindRippleEffect(this.$wrapper),bindPageLinks(this.$wrapper),this.$wrapper.find(".Link").on("click",function(){$(this).is(".SkipOnboarding")&&cookies.setItem("skip_onboarding",1,moment().add(7,"d")._d),__APP.SIDEBAR.updateSubscriptions()})},t.prototype.bindSubscriptions=function(){this.$wrapper.find(".OnboardingOrgItem").not(".-Handled_OnboardingOrgItem").on("click",function(){var t=$(this);t.hasClass(__C.CLASSES.ACTIVE)?__APP.USER.unsubscribeFromOrganization(t.data("organization_id")):__APP.USER.subscribeToOrganization(t.data("organization_id")),t.toggleClass(__C.CLASSES.ACTIVE)}).addClass("-Handled_OnboardingOrgItem")},t.prototype.render=function(){function t(t){i.detach(),t.length?(e.$wrapper.find(".RecommendationsWrapper").last().append(tmpl("onboarding-recommendation",t)),e.bindSubscriptions(),e.block_scroll=!1):e.is_upload_disabled=!0}var e=this,i=tmpl("loader",{});if(-1===__APP.USER.id)return __APP.changeState("/feed/actual",!0,!0),null;e.$wrapper.html(tmpl("onboarding-main",{})),e.init(),e.$wrapper.find(".RecommendationsWrapper").last().append(i),OrganizationsCollection.fetchRecommendations(e.ajax_data,t),e.$wrapper.find(".RecommendationsScrollbar").scrollbar({onScroll:function(n,a){n.scroll!=n.maxScroll||e.is_upload_disabled||e.block_scroll||(e.block_scroll=!0,e.$wrapper.find(".RecommendationsWrapper").last().append(i),OrganizationsCollection.fetchRecommendations(e.ajax_data,t))}})},t}()),SearchPage=extending(Page,function(){function t(t){Page.call(this),this.page_title="Поиск",this.$search_bar_input=$("#search_bar_input"),this.search_string=decodeURIComponent(t),this.events_ajax_data={length:10,fields:FeedPage.fields.copy(),order_by:"nearest_event_date,-first_event_date"},this.organizations_ajax_data={length:30,fields:new Fields(["subscribed_count","img_small_url"])},this.past_events=!1,this.search_results=new SearchResults(this.search_string)}return t.buildOrganizationItems=function(t){return __APP.BUILD.organizationItems(t,{block_classes:["-show"],avatar_classes:["-size_50x50","-rounded"],counter_classes:[__C.CLASSES.HIDDEN]})},t.buildEventCards=function(t){var e=$();return 0==t.length?e=tmpl("search-no-events",{}):t.forEach(function(t){void 0!=t.nearest_event_date||this.past_events||(e=e.add(tmpl("divider",{title:"Прошедшие события"})),this.past_events=!0),e=e.add(__APP.BUILD.eventCards(t))}),e},t.prototype.fetchData=function(){return this.fetching_data_defer=this.search_results.fetchEventsAndOrganizations(this.events_ajax_data,this.organizations_ajax_data)},t.prototype.init=function(){function e(t){trimAvatarsCollection(t),bindRippleEffect(t),__APP.MODALS.bindCallModal(t),bindPageLinks(t),t.find(".HideEvent").remove()}var i,n=this,a=$(window);i=this.$wrapper.find(".SearchOrganizationsScrollbar").scrollbar({disableBodyScroll:!0,onScroll:function(e){e.scroll==e.maxScroll&&n.search_results.fetchOrganizations(n.organizations_ajax_data,function(e){
e.length?i.append(t.buildOrganizationItems(e)):i.off("scroll.onScroll"),bindPageLinks(i)})}}),a.off("scroll.upload"+n.constructor.name),a.on("scroll.upload"+n.constructor.name,function(){a.height()+a.scrollTop()+200>=$(document).height()&&!n.block_scroll&&(n.block_scroll=!0,n.search_results.fetchEvents(n.events_ajax_data,function(i){var r;i.length?(r=t.buildEventCards(n.search_results.events.last_pushed),n.$wrapper.find(".SearchEvents").append(r),e(r),n.block_scroll=!1):a.off("scroll.upload"+n.constructor.name)}))}),e(this.$wrapper)},t.prototype.render=function(){var e={};$(".TopBarOverlay").addClass("-open_search_bar"),this.$search_bar_input.val(this.search_string),e.events=t.buildEventCards(this.search_results.events),0==this.search_results.organizations.length?e.no_organizations=__C.CLASSES.HIDDEN:e.organizations=t.buildOrganizationItems(this.search_results.organizations),this.$wrapper.append(tmpl("search-wrapper",e)),this.init()},t.prototype.destroy=function(){$(".TopBarOverlay").removeClass("-open_search_bar"),this.$search_bar_input.val("")},t}()),SearchByTagPage=extending(SearchPage,function(){function t(t){SearchPage.call(this,t),this.search_string="#"+decodeURIComponent(t),this.search_results=new SearchResults(this.search_string)}return t}()),AddOrganizationPage=extending(AbstractEditOrganizationPage,function(){function t(){AbstractEditOrganizationPage.call(this),this.page_title="Новая организация",this.adding_is_over=!1}return t.prototype.destroy=function(){var t=this.$wrapper.find("#add-organization-form").serializeForm(),e=$(".SidebarNav");if(!this.adding_is_over){e.find(".ContinueRegistration").length||(e.prepend(__APP.BUILD.link({page:"/add/organization",title:"Продолжить регистрацию",classes:["sidebar_navigation_item","SidebarNavItem","ContinueRegistration"]})),bindPageLinks(e));try{sessionStorage.setItem("organization_info",JSON.stringify({city_id:t.city_id,type_id:t.type_id,name:t.name,short_name:t.short_name,email:t.email,site_url:t.site_url,default_address:t.default_address,description:t.description,facebook_url:t.facebook_url,vk_url:t.vk_url}))}catch(t){}}},t.prototype.renderRest=function(){var t,e;try{e=JSON.parse(sessionStorage.getItem("organization_info")?sessionStorage.getItem("organization_info"):localStorage.getItem("organization_info")),sessionStorage.removeItem("organization_info")}catch(t){e={}}t=$.extend({header_text:this.page_title},e,!0),this.$wrapper.html(tmpl("add-organization-page",t))},t}()),CatalogPage=extending(Page,function(){function t(t,e){Page.apply(this),$.isNumeric(t)&&!e&&(e=t,t=__APP.USER.selected_city.en_name),this.wrapper_tmpl="organizations",this.categories_ajax_data={order_by:"order_position"},this.organizations_ajax_data={fields:["background_small_img_url","img_small_url","is_subscribed","subscribed_count","privileges"],order_by:"-subscribed_count"},this.default_title="Организации",this.selected_city=new OneCity,this.selected_city_name=t||__APP.USER.selected_city.en_name,this.selected_category_id=e,this.cities=new CitiesCollection,this.categories=new CategoriesCollection,this.all_organizations=new OrganizationsCollection}return t.prototype.fetchData=function(){var t=this;return this.fetching_data_defer=this.cities.fetchCities(null,0,"distance,local_name",function(){t.selected_city_name&&(t.selected_city=this.getByName(t.selected_city_name),t.categories_ajax_data.city_id=t.selected_city.id)}).then(function(){return t.categories.fetchCategoriesWithOrganizations(t.categories_ajax_data,t.organizations_ajax_data,0).done(function(){t.all_organizations=t.categories.reduce(function(t,e){return t.setData(e.organizations)},new OrganizationsCollection).sort(function(t,e){return e.subscribed_count-t.subscribed_count})})}).promise()},t.prototype.selectCategory=function(t){this.selected_category_id=t||this.selected_category_id,this.$view.find(".Category").filter('[data-category-id="'+this.selected_category_id+'"]').addClass(__C.CLASSES.ACTIVE),__APP.changeState("/organizations/at/"+this.selected_city_name+"/"+this.selected_category_id,!0),__APP.changeTitle(this.categories.getByID(this.selected_category_id).name)},t.prototype.init=function(){function t(){bindRippleEffect(e.$view),bindPageLinks(e.$view)}var e=this,i=e.$view.find(".Category"),n=e.$view.find("#organizations_cities_select");$(window).on("subscribe.updateCatalog",function(t,i){var n=e.all_organizations.getByID(i);n.is_subscribed=!0,n.subscribed_count++}),$(window).on("unsubscribe.updateCatalog",function(t,i){var n=e.all_organizations.getByID(i);n.is_subscribed=!1,n.subscribed_count--}),t(),e.$view.find(".OrganizationsCategoriesScroll").scrollbar({disableBodyScroll:!0}),initSelect2(n),n.off("change.SelectCity").on("change.SelectCity",function(){var t=e.cities.getByID($(this).val());__APP.USER.selected_city=t,__APP.changeState("/organizations/at/"+t.en_name,!0,!0)}),e.selected_city_name&&n.select2("val",e.cities.getByName(e.selected_city_name).id),e.$view.find(".ShowAllOrganizations").off("click.showAllOrganizations").on("click.showAllOrganizations",function(){i.removeClass(__C.CLASSES.ACTIVE).siblings(".SubcategoryWrap").height(0),e.selected_category_id=void 0,__APP.changeState("/organizations/at/"+e.selected_city_name,!0),__APP.changeTitle(e.default_title),e.$wrapper.html(__APP.BUILD.organizationCard(e.all_organizations)),t()}),i.off("click.selectCategory").on("click.selectCategory",function(){var i=$(this),n=i.data("category-id"),a=i.next(".SubcategoryWrap"),r=!!a.length,o=i.hasClass(__C.CLASSES.ACTIVE);i.parent().find(".Category").not(i).removeClass(__C.CLASSES.ACTIVE).filter(".SubcategoryWrap").height(0),r?(a.height(o?0:a.children().outerHeight()),i.toggleClass(__C.CLASSES.ACTIVE)):o?(e.categories=new CategoriesCollection,e.categories.fetchCategoriesWithOrganizations(e.categories_ajax_data,e.organizations_ajax_data,0,function(){e.render()})):(e.selectCategory(n),e.$wrapper.html(__APP.BUILD.organizationCard(e.categories.getByID(n).organizations)),t())})},t.prototype.render=function(){this.$view.find("#organizations_cities_select").html(tmpl("option",this.cities.map(function(t){return{val:t.id,display_name:t.local_name}}))),this.$view.find(".OrganizationsCategoriesScroll").html(__APP.BUILD.organisationsCategoriesItems(this.categories)),this.$wrapper.html(__APP.BUILD.organizationCard(this.selected_category_id?this.categories.getByID(this.selected_category_id).organizations:this.all_organizations)),"/organizations"!=window.location.pathname&&"/organizations/"!=window.location.pathname||!this.selected_city_name||__APP.changeState("/organizations/at/"+this.selected_city_name,!0),this.selected_category_id?this.selectCategory(this.selected_category_id):__APP.changeTitle(this.default_title),this.init()},t.prototype.destroy=function(){$(window).off("subscribe.updateCatalog unsubscribe.updateCatalog")},t}()),OrganizationPage=extending(Page,function(){function t(t){var e={last_date:"",block_scroll:!1,is_upload_disabled:!1};Page.call(this),this.fields=new Fields("img_small_url","background_medium_img_url","description","site_url","is_subscribed","privileges","default_address","subscribed_count",{subscribed:{fields:"is_friend",order_by:"-is_friend,first_name",length:10}}),this.events_fields=new Fields("image_horizontal_medium_url","favored_users_count","is_favorite","is_registered","registration_available","registration_locally","ticketing_locally","ticketing_available","dates",{favored:{length:5}}),this.event_types={future:$.extend(!0,{},e,{name:"future",scroll_event:"scroll.uploadFutureEvents",sort_date_type:"nearest_event_date"}),past:$.extend(!0,{},e,{name:"past",scroll_event:"scroll.uploadPastEvents",sort_date_type:"last_event_date"}),delayed:$.extend(!0,{},e,{name:"delayed",scroll_event:"scroll.uploadDelayedEvents",sort_date_type:"public_at"}),canceled:$.extend(!0,{},e,{name:"canceled",scroll_event:"scroll.uploadCanceledEvents",sort_date_type:"first_event_date"})},this.current_tab=this.event_types.future.name,this.is_admin=!1,this.future_events=new FutureEventsCollection,this.past_events=new PastEventsCollection,this.delayed_events=new DelayedEventsCollection,this.canceled_events=new CanceledEventsCollection,this.organization=new OneOrganization(t)}return t.prototype.fetchData=function(){var t=this;return this.fetching_data_defer=this.organization.fetchOrganization(this.fields).done(function(e){t.is_admin=t.organization.role!==OneUser.ROLE.USER}).promise()},t.prototype.fetchAndAppendFeed=function(t,e){var i,n,a,r=this;t.is_upload_disabled||t.block_scroll||(i=this.$wrapper.find("."+t.name.capitalize()+"Events"),n=__APP.BUILD.loaderBlock(i),t.block_scroll=!0,r[t.name+"_events"].fetchOrganizationsFeed(r.organization.id,r.events_fields,10,function(o){n.remove(),t.block_scroll=!1,o.length?a=__APP.BUILD.eventBlocks(o,t):(t.is_upload_disabled=!0,a=tmpl("organization-feed-no-event",{text:"Больше событий нет :("})),i.append(a),r.bindFeedEvents(a),isFunction(e)&&e()}))},t.prototype.bindFeedEvents=function(t){bindRippleEffect(t),trimAvatarsCollection(t),bindCallModal(t),bindPageLinks(t)},t.prototype.init=function(){var t=this,e=t.$wrapper.find(".SubscribersScroll");bindTabs(t.$wrapper),bindCallModal(t.$wrapper),t.$wrapper.find(".Tabs").on("tabs:change",function(){t.current_tab=$(this).find(".Tab.-active").data("type")}),t.$wrapper.find(".ExternalPage").on("click.sendStat",function(){storeStat(t.organization.id,__C.STATS.ORGANIZATION_ENTITY,__C.STATS.ORGANIZATION_OPEN_SITE)}),isScrollRemain(1e3)&&t.fetchAndAppendFeed(t.event_types[t.current_tab]),$(window).on("scroll.uploadEvents",function(){isScrollRemain(1e3)&&t.fetchAndAppendFeed(t.event_types[t.current_tab])}),t.organization.subscribed.last_pushed.length&&e.scrollbar({onScroll:function(i){var n,a=!1;t.organization.subscribed.last_pushed.length&&(a=t.organization.subscribed.last_pushed[t.organization.subscribed.last_pushed.length-1].is_friend),i.scroll+200>=i.maxScroll&&!e.block_scroll&&(e.block_scroll=!0,n=__APP.BUILD.loaderBlock(e),t.organization.subscribed.fetchOrganizationSubscribers(t.organization.id,10,{fields:"is_friend",order_by:"-is_friend,first_name"},function(t){t.length?(e.append(__APP.BUILD.subscribers(t,a)),e.block_scroll=!1):e.off("scroll.onScroll"),n.remove(),bindPageLinks(e)}))}})},t.prototype.render=function(){var t=this,e=new OneOrganization(t.organization.id);e.setData(t.organization),__APP.changeTitle(e.short_name),__APP.SIDEBAR.$subscribed_orgs.find('[data-organization_id="'+e.id+'"]').find(".OrganizationCounter").addClass(__C.CLASSES.HIDDEN),t.$wrapper.html(tmpl("organization-wrapper",$.extend(!0,{background_image:e.background_img_url?tmpl("organization-background-image",e):"",avatar_block:__APP.BUILD.avatarBlocks(e,{block_classes:["organization_title_block"],avatar_classes:[__C.CLASSES.SIZES.SMALL,"organization_avatar"],entity:__C.ENTITIES.ORGANIZATION}),subscribe_button:new SubscribeButton(e.id,{is_checked:e.is_subscribed,colors:{checked:__C.CLASSES.COLORS.NEUTRAL,unchecked:__C.CLASSES.COLORS.ACCENT,checked_hover:__C.CLASSES.COLORS.NEUTRAL,unchecked_hover:__C.CLASSES.COLORS.ACCENT},classes:[__C.CLASSES.SIZES.LOW,__C.CLASSES.SIZES.WIDE,__C.CLASSES.HOOKS.RIPPLE]}),has_address:e.default_address?"":__C.CLASSES.HIDDEN,redact_org_button:e.role===OneUser.ROLE.ADMIN?__APP.BUILD.linkButton({title:__LOCALES.ru_RU.TEXTS.BUTTON.EDIT,classes:[__C.CLASSES.SIZES.WIDE,__C.CLASSES.COLORS.NEUTRAL,__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.PENCIL,__C.CLASSES.HOOKS.RIPPLE],page:"/admin/organization/"+e.id+"/edit/"}):"",hidden_for_users:t.is_admin?"":__C.CLASSES.HIDDEN,subscribed_blocks:__APP.BUILD.subscribers(e.subscribed)},e))),t.init(),t.fetchAndAppendFeed(t.event_types.future),t.fetchAndAppendFeed(t.event_types.past),t.is_admin&&(t.fetchAndAppendFeed(t.event_types.delayed),t.fetchAndAppendFeed(t.event_types.canceled))},t}()),MyOrdersPage=extending(Page,function(){function t(){Page.call(this),this.page_title="Мои заказы",this.orders=new MyOrdersCollection,this.fetch_order_fields=new Fields("registration_fields","final_sum","sum",{event:{fields:new Fields("accept_bitcoins","dates","nearest_event_date","is_same_time","location","ticketing_locally")},tickets:{fields:new Fields("ticket_type","created_at","number","order")}}),this.$orders=$(),this.$detail_wrapper=$(),this.$registration_fields_wrapper=$()}return t.orderItemsBuilder=function(e){var i=e instanceof Array?e:[e];return tmpl("my-orders-order-unit",i.map(function(e){return{order_number:formatTicketNumber(e.number),order_datetime:moment.unix(e.created_at).calendar(__LOCALE.DATE.CALENDAR_DATE_TIME),event_title:e.event.title,order_footer:t.buildPayInfo(e)}})).each(function(t){$(this).data("order",i[t])})},t.buildPayInfo=function(t){var e="success",i=localeFromNamespace(t.status_type_code,OneOrder.EXTENDED_ORDER_STATUSES,__LOCALE.TEXTS.TICKET_STATUSES);return OneOrder.isRedStatus(t.status_type_code)?e="error":OneOrder.isYellowStatus(t.status_type_code)&&(e="warning"),null!==t.final_sum&&t.payed_at&&(i="Оплачен "+moment.unix(t.payed_at).format(__LOCALE.DATE.DATE_TIME_FORMAT)+" — "+formatCurrency(t.final_sum)+" руб."),tmpl("my-orders-order-unit-footer",{text:i,color:e})},t.prototype.fetchData=function(){return this.fetching_data_defer=this.orders.fetchAllOrders(this.fetch_order_fields)},t.prototype.init=function(){var e=this,i=parseUri(location),n=$();this.$wrapper.find(".Scroll").scrollbar(),this.$orders.on("click.SelectOrder",function(){var i=$(this),n=i.data("order"),a=AbstractAppInspector.build.tickets(n.tickets);e.$orders.not(i).removeClass("-item_selected"),i.addClass("-item_selected"),e.$detail_wrapper.html(tmpl("my-orders-order-detail-info",{order_number:formatTicketNumber(n.number),pain_info:t.buildPayInfo(n),pay_button:function(t){var e;return t.status_type_code!==OneOrder.ORDER_STATUSES.WAITING_FOR_PAYMENT?"":(e=__APP.BUILD.button({title:"Заплатить через Яндекс",classes:["orders_page_pay_button",__C.CLASSES.COLORS.YANDEX,__C.CLASSES.HOOKS.RIPPLE,"PayButton",__C.CLASSES.SIZES.HUGE,__C.CLASSES.SIZES.WIDE,__C.CLASSES.UNIVERSAL_STATES.NO_UPPERCASE]},{title:"Оплатить через юр. лицо",classes:["orders_page_pay_button",__C.CLASSES.COLORS.MARGINAL_PRIMARY,__C.CLASSES.TEXT_WEIGHT.LIGHTER,__C.CLASSES.HOOKS.RIPPLE,"LegalEntityPaymentButton",__C.CLASSES.SIZES.WIDE,__C.CLASSES.SIZES.BIG,__C.CLASSES.UNIVERSAL_STATES.NO_UPPERCASE]}),t.event.accept_bitcoins&&(e=e.add(__APP.BUILD.button({title:"Заплатить через Bitcoin",classes:["orders_page_pay_button",__C.CLASSES.COLORS.MARGINAL_PRIMARY,__C.CLASSES.TEXT_WEIGHT.LIGHTER,__C.CLASSES.HOOKS.RIPPLE,"BitcoinPaymentButton",__C.CLASSES.SIZES.WIDE,__C.CLASSES.SIZES.BIG,__C.CLASSES.UNIVERSAL_STATES.NO_UPPERCASE]}))),e)}(n),event_title:AbstractAppInspector.build.title("Событие"),event:AbstractAppInspector.build.event(n.event),tickets_title:AbstractAppInspector.build.title("Билеты"),tickets:n.tickets.length?a:"Билетов нет"})),a.on("click.OpenTicket",function(){var t=$(this),e=OneExtendedTicket.createFrom(t.data("ticket"),n.event);t.data("modal")||t.data("modal",new TicketsModal(e)),t.data("modal").show()}),e.$registration_fields_wrapper.html(tmpl("my-orders-order-registration-fields",{registration_fields_title:AbstractAppInspector.build.title("Анкета"),registration_fields:__APP.BUILD.registrationFields(n.registration_fields)})),e.$detail_wrapper.find(".PayButton").on("click.Pay",function(){Payment.doPayment("order-"+n.uuid,n.final_sum)}),e.$detail_wrapper.find(".LegalEntityPaymentButton").on("click.PayByLegalEntity",function(){__APP.changeState("event/"+n.event.id+"/order/"+n.uuid+"/from_legal_entity")}),e.$detail_wrapper.find(".BitcoinPaymentButton").on("click.BitcoinPayment",function(){var t=$(this),e=t.data("modal");e||(e=new BitcoinModal(n.event,n),t.data("modal",e)),e.show()})}),i.queryKey.uuid&&(n=this.$orders.filter(function(){return $(this).data("order").uuid===i.queryKey.uuid}),n.length&&n.trigger("click.SelectOrder"))},t.prototype.render=function(){if(__APP.USER.isLoggedOut())return new AuthModal(window.location.href,!1).show();this.orders.sortBy("created_at"),this.$wrapper.html(tmpl("my-orders-page",{orders:this.$orders=t.orderItemsBuilder(this.orders),order_detail:__APP.BUILD.cap("Выберите заказ, чтобы посмотреть детальную информацию о ней"),order_registration_fields:__APP.BUILD.cap("Выберите заказ, чтобы посмотреть детальную информацию о ней")})),this.$detail_wrapper=this.$wrapper.find(".OrderDetailInfo"),this.$registration_fields_wrapper=this.$wrapper.find(".OrderRegistrationFields"),this.init()},t}()),UserPage=extending(Page,function(){function t(t){Page.apply(this),this.user_id=t,this.user=new OneUser(t),this.events_metadata={last_date:""},this.disable_uploads={events:!1,activities:!1},this.favored_fetch_data={fields:new Fields("image_horizontal_medium_url","favored","favored_users_count","is_favorite","is_registered","registration_locally","registration_available","ticketing_locally","ticketing_available","dates"),order_by:"nearest_event_date,-first_event_date",length:10}}return t.bindEvents=function(t){bindRippleEffect(t),trimAvatarsCollection(t),__APP.MODALS.bindCallModal(t),bindPageLinks(t)},t.prototype.fetchData=function(){return this.user_id!=__APP.USER.id&&"me"!==this.user_id?this.fetching_data_defer=this.user.fetchUser(new Fields("type","is_friend","link","accounts","accounts_links",{friends:{fields:["is_friend"],length:4},favored:this.favored_fetch_data,subscriptions:{fields:["img_small_url"],length:4,order_by:["organization_type_order","organization_type_id"]}})):Page.prototype.fetchData.call(this)},t.prototype.uploadEntities=function(e){var i,n=this,a={activities:{fetch_method:this.user.actions.fetch,fetch_context:this.user.actions,fetch_arguments:[["organization","event","type_code","created_at"],20,"-created_at"],extra_function:function(t){t.forEach(function(t){t.user=n.user})},build_method:__APP.BUILD.activity,build_extra_arguments:[]},events:{fetch_method:this.user.fetchFavored,fetch_context:this.user,fetch_arguments:[this.favored_fetch_data],build_method:__APP.BUILD.eventBlocks,build_extra_arguments:[this.events_metadata]}},r=a[e],o=n.$wrapper.find(".TabsBody").filter('[data-tab_body_type="'+e+'"]');n.disable_uploads[e]||n.block_scroll||(i=__APP.BUILD.loaderBlock(o),n.block_scroll=!0,r.fetch_method.apply(r.fetch_context,r.fetch_arguments).done(function(a){var s;n.block_scroll=!1,i.remove(),a.length?(r.extra_function&&"function"==typeof r.extra_function&&r.extra_function(a),s=r.build_method.apply(__APP.BUILD,[a].concat(r.build_extra_arguments)),o.append(s),t.bindEvents(s)):(o.children().length||o.append(__APP.BUILD.cap("Активности нет")),n.disable_uploads[e]=!0)}))},t.prototype.init=function(){function e(t,e){var i=t.$wrapper.find(".TabsBody").filter("."+__C.CLASSES.ACTIVE).data("tab_body_type"),n=$(window);n.off(Object.values(e).join(" ")),isScrollRemain(1e3)&&t.uploadEntities(i),n.on(e[i],function(){isScrollRemain(1e3)&&t.uploadEntities(i)})}var i=this,n={activities:"scroll.uploadActivities",events:"scroll.uploadEvents"};bindTabs(this.$wrapper),t.bindEvents(this.$wrapper),this.$wrapper.find(".Tabs").on("tabs:change",function(){e(i,n)}),e(this,n)},t.prototype.render=function(){var t,e,i=this;if(this.user_id==__APP.USER.id)return __APP.changeState("/my/profile",!0,!0),null;__APP.changeTitle(this.user.full_name),this.user.actions.forEach(function(t){t.user=i.user}),t=this.user.subscriptions.length?__APP.BUILD.avatarBlocks(this.user.subscriptions.slice(0,4),{is_link:!0,entity:__C.ENTITIES.ORGANIZATION,avatar_classes:[__C.CLASSES.SIZES.X30]}):__APP.BUILD.cap("Нет подписок"),e=this.user.favored.length?__APP.BUILD.eventBlocks(this.user.favored,this.events_metadata):__APP.BUILD.cap("Событий нет"),this.$wrapper.append(tmpl("user-page",{wrapper_classes:"-another_user",tombstone:__APP.BUILD.userTombstones(this.user,{avatar_classes:[__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.UNIVERSAL_STATES.SHADOWED]}),links:__APP.BUILD.socialLinks(this.user.accounts_links,{classes:__C.CLASSES.UNIVERSAL_STATES.ROUNDED}),subscribed_orgs:t,show_all_subscribed_orgs_button:this.user.subscriptions.length?__APP.BUILD.button({classes:[__C.CLASSES.COLORS.NEUTRAL_ACCENT,__C.CLASSES.HOOKS.CALL_MODAL,__C.CLASSES.HOOKS.RIPPLE],dataset:{modal_type:"subscribers_list",modal_entity:this.user},title:"Показать все"}):"",friends_hidden:__C.CLASSES.HIDDEN,favored_event_blocks:e})),this.uploadEntities("activities"),this.init()},t}()),MyProfilePage=extending(UserPage,function(){function t(){UserPage.call(this,__APP.USER.id),this.page_title="Мой профиль",this.favored_fetch_data.fields.push("is_favorite"),this.user=__APP.USER}return t.prototype.fetchData=function(){var t=[];return this.user.favored.length||t.push(this.user.fetchFavored(this.favored_fetch_data)),this.user.friends.length||t.push(this.user.fetchFriends({fields:["is_friend"],length:4})),t.length?this.fetching_data_defer=AsynchronousConnection.multipleAjax.apply(null,t):Page.prototype.fetchData.call(this)},t.prototype.render=function(){var t,e,i,n;__APP.changeTitle("Мой профиль"),this.user.actions.forEach(function(t){t.user=__APP.USER}),e=this.user.subscriptions.length?__APP.BUILD.avatarBlocks(this.user.subscriptions.slice(0,4),{is_link:!0,entity:__C.ENTITIES.ORGANIZATION,avatar_classes:[__C.CLASSES.SIZES.X30]}):__APP.BUILD.cap("Нет подписок"),n=this.user.friends.length?__APP.BUILD.avatarBlocks(this.user.friends.slice(0,4),{is_link:!0,entity:__C.ENTITIES.USER,avatar_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]}):__APP.BUILD.cap("Нет друзей"),i=this.user.favored.length?__APP.BUILD.eventBlocks(this.user.favored,this.events_metadata):__APP.BUILD.cap("Событий нет"),this.$wrapper.append(tmpl("user-page",{wrapper_classes:"-this_user",tombstone:__APP.BUILD.userTombstones(this.user,{avatar_classes:[__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.UNIVERSAL_STATES.SHADOWED]}),links:__APP.BUILD.socialLinks(this.user.accounts_links,{classes:__C.CLASSES.UNIVERSAL_STATES.ROUNDED}),subscribe_button:__APP.BUILD.button({classes:[__C.CLASSES.COLORS.NEUTRAL_ACCENT,__C.CLASSES.HOOKS.RIPPLE,"LogoutButton"],title:"Выйти"}),subscribed_orgs:e,show_all_subscribed_orgs_button:this.user.subscriptions.length?__APP.BUILD.button({classes:[__C.CLASSES.COLORS.NEUTRAL_ACCENT,__C.CLASSES.HOOKS.CALL_MODAL,__C.CLASSES.HOOKS.RIPPLE],dataset:{modal_type:"subscribers_list",modal_entity:this.user},title:"Показать все"}):"",subscribed_users:n,show_all_subscribed_users_button:this.user.friends.length?__APP.BUILD.button({classes:[__C.CLASSES.COLORS.NEUTRAL_ACCENT,__C.CLASSES.HOOKS.CALL_MODAL,__C.CLASSES.HOOKS.RIPPLE],dataset:{modal_type:"friends_list",modal_entity:this.user},title:"Показать все"}):"",favored_event_blocks:i})),this.user.actions.length?(t=__APP.BUILD.activity(this.user.actions),this.$wrapper.find(".TabsBody").filter('[data-tab_body_type="activities"]').append(t),UserPage.bindEvents(t)):this.uploadEntities("activities"),this.$wrapper.find(".LogoutButton").on("click",__APP.USER.logout),this.init()},t}()),MyTicketsPage=extending(Page,function(){function t(){Page.call(this),this.page_title="Мои билеты",this.tickets=new MyTicketsCollection,this.disable_uploads=!1,this.block_scroll=!1,this.fetch_tickets_fields=new Fields("created_at","number","ticket_type","order",{event:{fields:new Fields("dates","is_same_time","image_horizontal_medium_url","location")}}),this.fetch_tickets_quantity=30}return t.prototype.fetchData=function(){return this.fetching_data_defer=this.tickets.fetchTickets(this.fetch_tickets_fields,this.fetch_tickets_quantity)},t.prototype.fetchAndAppendTickets=function(){var t,e=this;e.disable_uploads||e.block_scroll||(t=__APP.BUILD.loaderBlock(e.$wrapper),e.block_scroll=!0,e.tickets.fetchTickets(e.fetch_tickets_fields,e.fetch_tickets_quantity).done(function(i){e.block_scroll=!1,i.length?e.$wrapper.find(".TicketsWrapper").append(__APP.BUILD.ticketCards(i)):e.disable_uploads=!0,t.remove()}))},t.prototype.init=function(){var t=this;bindCallModal(this.$wrapper),isScrollRemain(1e3)&&t.fetchAndAppendTickets(),$(window).on("scroll.uploadTickets",function(){isScrollRemain(1e3)&&t.fetchAndAppendTickets()})},t.prototype.render=function(){if(__APP.USER.isLoggedOut())return __APP.changeState("/",!0,!0),null;this.$wrapper.html(tmpl("my-tickets-wrapper",{tickets:__APP.BUILD.ticketCards(this.tickets)})),this.init()},t}()),TicketPage=extending(Page,function(){function t(){Page.call(this)}return t.prototype.render=function(){this.$view.find(".Print").on("click",function(){window.print()})},t}()),__APP={SERVER:new ServerConnection,EXPORT:new ServerExports,EVENDATE_BEGIN:"15-12-2015",AUTH_URLS:{},TOP_BAR:new AbstractTopBar,SIDEBAR:new AbstractSidebar,USER:new CurrentUser,PREVIOUS_PAGE:new Page,CURRENT_PAGE:new Page,ROUTING:{admin:{organization:{"^([0-9]+)":{add:{event:AddEventPage,"":AddEventPage},edit:AdminOrganizationEditPage,overview:AdminOrganizationOverviewPage,events:AdminOrganizationEventsPage,crm:AdminOrganizationCRMPage,settings:AdminOrganizationSettingsPage,"":AdminOrganizationOverviewPage}},event:{"^([0-9]+)":{overview:AdminEventOverviewPage,orders:AdminEventOrdersPage,requests:AdminEventRequestsPage,check_in:AdminEventCheckInPage,edit:AdminEventEditPage,"":AdminEventOverviewPage}},"":AdminOrganizationsPage},add:{event:{to:{"^([0-9]+)":AddEventPage,"":AddEventPage},"":AddEventPage},organization:AddOrganizationPage},my:{orders:MyOrdersPage,tickets:MyTicketsPage,profile:MyProfilePage,"":MyProfilePage},event:{add_to:{"^([0-9]+)":AddEventPage,"":AddEventPage},add:{to:{"^([0-9]+)":AddEventPage,"":AddEventPage},"":AddEventPage},"^([0-9]+)":{order:{"^([0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12})":{from_legal_entity:LegalEntityPayment},"":OrderPage},edit:EditEventPage,"":EventPage},"":FeedPage},feed:{actual:ActualEventsPage,timeline:TimelineEventsPage,favored:FavoredEventsPage,recommendations:RecommendedEventsPage,friends:FriendsEventsPage,day:{"^([0-9]{4}-[0-9]{2}-[0-9]{2})":DayEventsPage},"":ActualEventsPage},organizations:{at:{"^([0-9]+)":CatalogPage,"^([^/]+)":{"^([0-9]+)":CatalogPage,"":CatalogPage}},"^([0-9]+)":CatalogPage,"":CatalogPage},organization:{add:AddOrganizationPage,"^([0-9]+)":{edit:EditOrganizationPage,"":OrganizationPage},"":CatalogPage},onboarding:OnboardingPage,search:{tag:{"^([^/]+)":SearchByTagPage},"^([^/]+)":SearchPage},friends:MyProfilePage,friend:{"^([0-9]+)":UserPage,"":MyProfilePage},user:{me:MyProfilePage,"^([0-9]+)":UserPage,"":MyProfilePage},ticket:{"^([^/]+)":TicketPage,"":TicketPage},"":ActualEventsPage},MODALS:new Modals,BUILD:new Builder,IS_WIDGET:!1,renderHeaderTabs:function(t){var e=$("#main_header_bottom").find(".HeaderTabsWrapper");t=t instanceof Array?t:[t],t.forEach(function(t){t=Builder.normalizeBuildProps(t),t.classes.push("tab","Tab"),window.location.pathname.contains(t.page)&&t.classes.push(__C.CLASSES.ACTIVE)}),e.html(tmpl("tabs-header",{color:"default",tabs:tmpl("link",t)})),bindTabs(e,!1),bindPageLinks(e)},changeTitle:function(t){var e,i=$();switch("string"==typeof t&&(e=t,t=t.split(" > ")),!0){case t instanceof Array:t.forEach(function(e,n){n&&(i=i.add('<span class="title_chunk fa_icon fa-angle-right -empty"></span>')),"object"==typeof e?(e.toString=Array.isArray(e)?Array.toSpaceSeparatedString:Object.toHtmlDataSet,i=i.add('<a href="'+e.page+'" class="title_chunk link Link">'+e.title+"</a>"),t[n]=e.title):i=i.add('<span class="title_chunk">'+e+"</span>")}),e||(e=t.join(" > "));break;case t instanceof jQuery:i=t,t.each(function(){this.text()&&(e+=this.text()+" ")})}bindPageLinks($("#page_title").html(i)),$("title").text(e||"Evendate")},changeState:function(t,e,i){var n;return History.stateChangeHandled=!0,t?(t=0===t.indexOf("/")?t:"/"+t,n=parseUri(t),e?History.replaceState({parsed_page_uri:n},"",n.path):History.pushState({parsed_page_uri:n},"",n.path),(!e||e&&i)&&__APP.reInit()):console.error("Need to pass page name"),History.stateChangeHandled=!1,!1},reload:function(){return __APP.changeState(location.pathname,!0,!0)},init:function(){var t=$(".SidebarNavItem"),e=window.location.pathname;__APP.CURRENT_PAGE=Page.routeNewPage(e),__APP.CURRENT_PAGE.fetchData(),__APP.CURRENT_PAGE.show(),t.removeClass(__C.CLASSES.ACTIVE).filter(function(){return 0===e.indexOf(this.getAttribute("href"))}).addClass(__C.CLASSES.ACTIVE)},reInit:function(){$(window).off("scroll"),AbstractAppInspector.hideCurrent(),__APP.SERVER.abortAllConnections(),__APP.PREVIOUS_PAGE=__APP.CURRENT_PAGE,__APP.PREVIOUS_PAGE.destroy(),__APP.init()}};__ERRORS=[],__LOCALES={ru_RU:{TEXTS:{BUTTON:{REMOVE_FAVORITE:"Убрать",ADD_FAVORITE:"В избранное",FAVORED:"В избранном",ADD_SUBSCRIPTION:"Подписаться",REMOVE_SUBSCRIPTION:"Отписаться",SUBSCRIBED:"Подписан",EDIT:"Изменить"},SUBSCRIBERS:{NOM:" подписчик",GEN:" подписчика",PLU:" подписчиков"},PEOPLE:{NOM:" человек",GEN:" человека",PLU:" человек"},FAVORED:{NOM:" участник",GEN:" участника",PLU:" участников"},ACTIVITY:{SUBSCRIBE:{MAS:"подписался на организацию",FEM:"подписалась на организацию",NEU:"подписалось на организацию"},UNSUBSCRIBE:{MAS:"отписался от организации",FEM:"отписалась от организации",NEU:"отписалось от организации"},FAVE:{MAS:"добавил в избранное событие",FEM:"добавила в избранное событие",NEU:"добавило в избранное событие"},UNFAVE:{MAS:"удалил из избранного событие",FEM:"удалила из избранного событие",NEU:"удалило из избранного событие"},SHARE:{MAS:"поделился событием",FEM:"поделилась событием",NEU:"поделилось событием"}},TICKET_STATUSES:{USED:"Билет использован",WAITING_PAYMENT_LEGAL_ENTITY:"Ожидает оплаты от юрлица",WAITING_FOR_PAYMENT:"Ожидает оплаты",IS_PENDING:"Ожидает подтверждения",APPROVED:"Подтверждено",PAYED:"Оплачено",WITHOUT_PAYMENT:"Без оплаты",TICKETS_ARE_OVER:"Билеты закончились",RETURNED_BY_ORGANIZATION:"Возврат билета организатором",PAYMENT_CANCELED_AUTO:"Истек срок оплаты",PAYMENT_CANCELED_BY_CLIENT:"Отменен клиентом",RETURNED_BY_CLIENT:"Возврат билета",REJECTED:"Отклонен"}},DATE:{DATE_FORMAT:"DD.MM.YYYY",TIME_FORMAT:"HH:mm",DATE_TIME_FORMAT:"DD.MM.YYYY, HH:mm",MONTH_SHORT_NAMES:["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"],MONTH_NAMES:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],CALENDAR_DATE_TIME:{sameDay:"[Сегодня в] HH:mm",lastDay:"[Вчера в] HH:mm",nextWeek:"D MMMM [в] HH:mm",lastWeek:"D MMMM [в] HH:mm",sameElse:"D MMMM [в] HH:mm"}},DATATABLES_URL:"//cdn.datatables.net/plug-ins/1.10.15/i18n/Russian.json"}},__LOCALE=__LOCALES.ru_RU,Object.seal(__APP),Object.freeze(__APP.SERVER),Object.freeze(__APP.ROUTING),Object.freeze(__APP.BUILD),Object.freeze(__C),Object.freeze(__LOCALES),__LOCALES={ru_RU:{TEXTS:{BUTTON:{REMOVE_FAVORITE:"Убрать",ADD_FAVORITE:"В избранное",FAVORED:"В избранном",ADD_SUBSCRIPTION:"Подписаться",REMOVE_SUBSCRIPTION:"Отписаться",SUBSCRIBED:"Подписан",EDIT:"Изменить"},SUBSCRIBERS:{NOM:" подписчик",GEN:" подписчика",PLU:" подписчиков"},PEOPLE:{NOM:" человек",GEN:" человека",PLU:" человек"},FAVORED:{NOM:" участник",GEN:" участника",PLU:" участников"},ACTIVITY:{SUBSCRIBE:{MAS:"подписался на организацию",FEM:"подписалась на организацию",NEU:"подписалось на организацию"},UNSUBSCRIBE:{MAS:"отписался от организации",FEM:"отписалась от организации",NEU:"отписалось от организации"},FAVE:{MAS:"добавил в избранное событие",FEM:"добавила в избранное событие",NEU:"добавило в избранное событие"},UNFAVE:{MAS:"удалил из избранного событие",FEM:"удалила из избранного событие",NEU:"удалило из избранного событие"},SHARE:{MAS:"поделился событием",FEM:"поделилась событием",NEU:"поделилось событием"}},TICKET_STATUSES:{USED:"Билет использован",WAITING_PAYMENT_LEGAL_ENTITY:"Ожидает оплаты от юрлица",WAITING_FOR_PAYMENT:"Ожидает оплаты",IS_PENDING:"Ожидает подтверждения",APPROVED:"Подтверждено",PAYED:"Оплачено",WITHOUT_PAYMENT:"Без оплаты",TICKETS_ARE_OVER:"Билеты закончились",RETURNED_BY_ORGANIZATION:"Возврат билета организатором",PAYMENT_CANCELED_AUTO:"Истек срок оплаты",PAYMENT_CANCELED_BY_CLIENT:"Отменен клиентом",RETURNED_BY_CLIENT:"Возврат билета",REJECTED:"Отклонен"}},DATE:{DATE_FORMAT:"DD.MM.YYYY",TIME_FORMAT:"HH:mm",
DATE_TIME_FORMAT:"DD.MM.YYYY, HH:mm",MONTH_SHORT_NAMES:["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"],MONTH_NAMES:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],CALENDAR_DATE_TIME:{sameDay:"[Сегодня в] HH:mm",lastDay:"[Вчера в] HH:mm",nextWeek:"D MMMM [в] HH:mm",lastWeek:"D MMMM [в] HH:mm",sameElse:"D MMMM [в] HH:mm"}},DATATABLES_URL:"//cdn.datatables.net/plug-ins/1.10.15/i18n/Russian.json"}},__LOCALE=__LOCALES.ru_RU,Object.freeze(__LOCALES),window.paceOptions={ajax:!1,document:!1,eventLag:!1,elements:{},search_is_active:!1,search_query:null,search_xhr:null},__stats=[],askToSubscribe=null,checkRedirect()&&$(document).ajaxStart(function(){Pace.restart()}).ajaxError(function(t,e,i,n){n&&"Forbidden"===n&&__APP.changeState("/",!0,!0)}).ready(function(){var t,e,i,n=window.OneSignal||[];n.push(["init",{appId:"7471a586-01f3-4eef-b989-c809700a8658",autoRegister:!1,notifyButton:{enable:!1}}]),n.push(function(){n.isPushNotificationsSupported()&&n.isPushNotificationsEnabled(function(t){t||(window.askToSubscribe=function(){n.push(function(){n.on("subscriptionChange",function(t){t&&n.getUserId(function(t){$.ajax({url:"api/v1/users/me/devices",type:"PUT",data:{device_token:t,client_type:"browser",model:navigator.appVersion?navigator.appVersion:null,os_version:navigator.platform?navigator.platform:null},global:!1})})})}),n.push(["registerForPushNotifications"]),event.preventDefault()})})}),void 0!==window.moment&&(moment.locale(navigator.language),moment.updateLocale("ru",{monthsShort:__LOCALES.ru_RU.DATE.MONTH_SHORT_NAMES,calendar:{sameDay:"[Сегодня]",nextDay:"[Завтра]",lastDay:"[Вчера]",nextWeek:"D MMMM",lastWeek:"D MMMM",sameElse:"D MMMM"}})),void 0!==window.Highcharts&&Highcharts.setOptions({lang:{shortMonths:__LOCALES.ru_RU.DATE.MONTH_SHORT_NAMES}}),History.Adapter.bind(window,"statechange",function(){History.stateChangeHandled||__APP.reInit()}),isNotDesktop()&&($(".DownloadAppBand").addClass("-open_band"),$(".CloseDownloadAppBand").one("click",function(){$(".DownloadAppBand").removeClass("-open_band")})),t=__APP.USER.fetchUser(new Fields("email","accounts","accounts_links",{subscriptions:{fields:["img_small_url","subscribed_count","new_events_count","actual_events_count"]}})),e=AsynchronousConnection.dealAjax(AsynchronousConnection.HTTP_METHODS.GET,"/auth.php",{action:"get_urls",mobile:isNotDesktop()}),i=(new CitiesCollection).fetchCities(new Fields("timediff_seconds","distance"),1,"distance"),__APP.SERVER.multipleAjax(t,e,i,function(t,e,i){__APP.USER.selected_city.setData(i[0]),__APP.AUTH_URLS=e,checkRedirect(),__APP.USER.isLoggedOut()?(__APP.TOP_BAR=new TopBarNoAuth,__APP.SIDEBAR=new SidebarNoAuth):(__APP.TOP_BAR=new TopBar,__APP.SIDEBAR=new Sidebar),__APP.TOP_BAR.init(),__APP.SIDEBAR.init(),__APP.init(),bindPageLinks()}),setInterval(function(){if(0!=window.__stats.length){var t=window.__stats;window.__stats=[],$.ajax({url:"/api/v1/statistics/batch",data:JSON.stringify(t),type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",error:function(){window.__stats.concat(t)}})}},5e3)});