function extending(t,e){return e.prototype=$.extend({},t.prototype,e.prototype),e.prototype.constructor=e,Object.defineProperty(e.prototype,"__super",{value:t}),e}function tmpl(t,e,n,i){e=e?e:{};var a={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[1,"<div>","</div>"]};a.tbody=a.tfoot=a.colgroup=a.caption=a.thead,a.th=a.td;var o=function(t){return String(t+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},s=function(t,e){var n={},i={},s=a[(/<([\w:]+)/.exec(t)||["",""])[1].toLowerCase()]||a._default,r=s[0];for($.each(e,function(t,e){"string"==$.type(e)?i[t]=o(e):e instanceof jQuery?e.length&&(n[t]=e,i[t]=e.is("tr")?'<tbody id="JQ_tmpl_'+t+'"></tbody>':'<div id="JQ_tmpl_'+t+'"></div>'):null==e?i[t]="":i[t]=e}),t=$(t?s[1]+t.format(i)+s[2]:""),$.each(n,function(e,n){t.find("#JQ_tmpl_"+e).append(n),n.is("tr")?n.parent("tbody").removeAttr("id"):n.unwrap()});r--;)t=t.children();return t},r=$(),d=$("#tmpl-"+t).html().replace(/(?:\/\*(?:[\s\S]*?)\*\/)|(?:([\s;])+\/\/(?:.*)$)/gim,"").replace(/\\s{2,}|\t|\n|\r/gim,"").trim();return void 0===d&&(console.group("tmpl_error"),console.log("error in "+t),console.log("items",e),console.log("addTo",n),console.log("html_val",d),console.log("inputs",{template_type:t,items:e,addTo:n,direction:i}),console.groupEnd()),r=Array.isArray(e)?$.makeSet(e.map(function(t){return s(d,t)})):s(d,e),null==n||void 0==n?r:("prepend"==i?n.prepend(r):n.append(r),r)}function storeStat(t,e,n){window.__stats=window.__stats?window.__stats:[],window.__stats.push({entity_id:t,entity_type:e,event_type:n})}function getUnitsText(t,e){t=Math.abs(t);var n="";return n=t.toString().indexOf(".")>-1?e.GEN:t%10==1&&t%100!=11?e.NOM:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?e.GEN:e.PLU}function formatDates(t,e,n){function i(t,e,n,i,a){var o,s=["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"],r={d:e,D:e,t:n,T:n,M:i+1,MM:i+1>9?i+1:"0"+(i+1),MMM:__LOCALES.ru_RU.DATE.MONTH_SHORT_NAMES[i].toLocaleLowerCase(),MMMM:__LOCALES.ru_RU.DATE.MONTH_NAMES[i].toLocaleLowerCase(),MMMMs:s[i],Y:a,YY:a.substr(2,2),YYYY:a};return"string"==typeof t?o=t.format(r).capitalize():Array.isArray(t)?o=t.map(function(t){return t.format(r).capitalize()}):t instanceof jQuery?(o=$(),t.each(function(t,e){var n=$(e).clone();n.text(e.innerText.format(r).capitalize()),o=o.add(n)})):(o={},$.each(t,function(t,e){o[t]=e.format(r).capitalize()})),o}var a,o,s,r,d,l,c=!1,u=[],_=t.length-1,f={},p=[];return e||(e={date:"{D} {MMMMs} {YYYY}",time:"{T}"}),"string"==typeof e?c=e.contains(/\{T\}|\{t\}/)&&void 0!==t[0].start_time:(c=void 0!==t[0].start_time,$.each(e,function(){c=c||this.contains(/\{T\}|\{t\}/)})),n?(c&&(d=t[0].end_time?displayTimeRange(t[0].start_time,t[0].end_time):displayTimeRange(t[0].start_time)),t.forEach(function(t,e){a=moment.unix(t.event_date),s=a.year(),r=a.month(),f[s]||(f[s]={}),f[s][r]||(f[s][r]=[]),o?r!==o.month()||o.diff(a,"days")!==-1?(f[o.year()][o.month()].push(u.join("-")),u[0]=a.format("D")):u[1]=a.format("D"):u[0]=a.format("D"),e===_?f[s][r].push(u.join("-")):o=a}),$.each(f,function(t,n){$.each(n,function(n,a){p.push(i(e,a.join(", "),c?d:"",n,t))})})):(t.forEach(function(t,e){a=moment.unix(t.event_date),s=a.year(),r=a.month(),d=t.end_time?displayTimeRange(t.start_time,t.end_time):displayTimeRange(t.start_time),f[s]||(f[s]={}),f[s][r]||(f[s][r]=[]),o?r!==o.month()||o.diff(a,"days")!==-1||l!==d?(f[o.year()][o.month()].push({date:u.join("-"),time:l}),u=[a.format("D")]):u[1]=a.format("D"):u=[a.format("D")],e===_?f[s][r].push({date:u.join("-"),time:d}):(o=a,l=d)}),$.each(f,function(t,n){$.each(n,function(n,a){var o,s=[],r=[];$.each(a,function(t,e){o?e.time!=o?(s.push({date:r.join(", "),time:o}),r=[e.date]):r.push(e.date):r=[e.date],t===a.length-1?s.push({date:r.join(", "),time:e.time}):o=e.time}),$.each(s,function(a,o){p.push(i(e,o.date,c?o.time:"",n,t))})})})),p}function trimSeconds(t){return t=t.split(":"),3==t.length&&(t=t.splice(0,2)),t.join(":")}function displayDateRange(t,e){var n=moment.unix(t),i=moment.unix(e),a=moment();return n.isSame(i,"year")?n.isSame(i,"month")?n.isSame(i,"day")?n.format(n.isSame(a,"year")?"D MMM":"D MMM YYYY"):n.format("D")+"-"+i.format(n.isSame(a,"year")?"D MMM":"D MMM YYYY"):n.format("D MMM")+" - "+i.format(n.isSame(a,"year")?"D MMM":"D MMM YYYY"):n.format("MMM YYYY")+" - "+i.format("MMM YYYY")}function displayTimeRange(t,e){return e?e!=t||"00:00:00"!=t&&"00:00"!=t?trimSeconds(t)+" - "+trimSeconds(e):"Весь день":trimSeconds(t)}function formatCurrency(t,e,n){t=+t||0,e=e||" ",n=n||".";var i=(""+t).split(".")[1],a=t<0?"-":"",o=parseInt(Math.abs(t),10)+"",s=o.length>3?o.length%3:0;return a+(s?o.substr(0,s)+e:"")+o.substr(s).replace(/(\d{3})(?=\d)/g,"$1"+e)+(i?n+i:"")}function bindLimitInputSize(t){t=t?t:$("body"),t.find(".LimitSize").not(".-Handled_LimitSize").each(function(t,e){var n=$(e),i=n.closest(".form_unit"),a=n.data("maxlength"),o=n.siblings(".form_prompt");o.length?o.text(n.val().length+"/"+a):(n.after($("<p>").addClass("form_prompt").text(n.val().length+"/"+a)),o=n.siblings(".form_prompt")),n.on("input",function(){var t=n.val().length;if(n.is("textarea")){var e=n.val().match(/\n/g);t=e?t+e.length:t}t>a?i.addClass("-status_error"):i.hasClass("-status_error")&&i.removeClass("-status_error"),o.text(t+"/"+a)})}).addClass("-Handled_LimitSize")}function initSelect2(t,e){var n={containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"};t.hasClass("-Handled_ToSelect2")&&t.select2("destroy"),e&&$.extend(!0,n,e),t.select2(n).addClass("-Handled_ToSelect2")}function initTimeInput(t){function e(){var t=$(this);"0"==t.val()||""===t.val()?t.val("00"):t.val()<=9&&t.val("0"+parseInt(t.val()))}var n=$(t),i=n.find("input").eq(0),a=n.find("input").eq(1);i.inputmask("Regex",{regex:"([01]?[0-9]|2[0-3])"}).on("keyup",function(){(i.val()>2||"00"==i.val())&&(a.focus(),i.trigger("blur"))}).on("blur",e),a.inputmask("Regex",{regex:"[0-5][0-9]"}).on("blur",e),n.addClass("-Handled_TimeInput")}function trimAvatarsCollection(t){t=t?t:$("body"),t.find(".AvatarsCollection").each(function(){var t=$(this),e=t.find(".avatar"),n=e.length;t.hasClass("-subscribed")&&!t.hasClass("-shift")?t.width(1==n?e.outerWidth()*n:e.outerWidth()*n-6*(n-1)):t.width(1==n?0:e.outerWidth()*(n-1)-6*(n-2)),t.addClass("-trimmed")})}function bindDatePickers(t){t=t?t:$("body"),t.find(".DatePicker").not(".-Handled_DatePicker").each(function(t,e){new DatePicker(e,$(e).data()).init()}).addClass("-Handled_DatePicker")}function bindTimeInput(t){t=t?t:$("body"),t.find(".TimeInput").not(".-Handled_TimeInput").each(function(t,e){initTimeInput(e)}).addClass("-Handled_TimeInput")}function bindTabs(t){t=t?t:$("body"),t.find(".Tabs").not(".-Handled_Tabs").each(function(t,e){var n=$(e),i=n.find(".TabsBodyWrapper"),a=n.find(".Tab"),o=n.find(".TabsBody");a.filter(".-active").length||a.eq(0).addClass(__C.CLASSES.NEW_ACTIVE),o.removeClass(__C.CLASSES.NEW_ACTIVE).eq(a.index(a.filter(".-active"))).addClass(__C.CLASSES.NEW_ACTIVE),i.height(o.filter(".-active").height()),a.on("click",function(){$(this).hasClass(__C.CLASSES.NEW_ACTIVE)||(a.removeClass(__C.CLASSES.NEW_ACTIVE),o.removeClass(__C.CLASSES.NEW_ACTIVE),$(this).addClass(__C.CLASSES.NEW_ACTIVE),o.eq(a.index(this)).addClass(__C.CLASSES.NEW_ACTIVE),i.height(o.filter(".-active").height()),n.trigger("change.tabs"))})}).addClass("-Handled_Tabs")}function bindShareButtons(t){t=t?t:$("body"),t.find(".ShareButton").not(".-Handled_ShareButton").each(function(t,e){var n=$(e);n.on("click",function(){window.open(n.data("href"),n.data("title"),"width=600,height=440,resizable=yes,scrollbars=no,status=no")})}).addClass("-Handled_ShareButton")}function bindSelect2(t){t=t?t:$("body"),t.find(".ToSelect2").not(".-Handled_ToSelect2").each(function(t,e){initSelect2($(e))})}function bindRippleEffect(t){t=t?t:$("body"),t.find(".RippleEffect").not(".-Handled_RippleEffect").on("click.RippleEffect",function(t){var e,n,i,a,o=$(this);0==o.children(".Ripple").length&&o.prepend('<span class="ripple Ripple"></span>'),e=o.children(".Ripple"),e.removeClass("animate"),e.height()||e.width()||(n=Math.max(o.outerWidth(),o.outerHeight()),e.css({height:n,width:n})),i=t.pageX-o.offset().left-e.width()/2,a=t.pageY-o.offset().top-e.height()/2,e.css({top:a+"px",left:i+"px"}).addClass("animate").one("animationend webkitAnimationEnd",function(){e.removeClass("animate")})}).addClass("-Handled_RippleEffect")}function bindDropdown(t){t=t?t:$("body"),t.find(".DropdownButton").not(".-Handled_DropdownButton").each(function(){var t=$(this),e=t.data(),n=$(".DropdownBox").filter('[data-dropdown_id="'+e.dropdown+'"]');if(n.data($.extend({},n.data(),e)),n.closeDropbox=function(){$("body").off("mousedown.CloseDropdown"),$(document).off("keyup.CloseDropdown"),n.removeClass("-show"),t.addClass("-dropdown_active")},e.hasOwnProperty("ddWidth")&&("self"==e.ddWidth?n.width(t.outerWidth()):(isFinite(e.ddWidth)||0===e.ddWidth.search(/^[1-9]\d*%$|^0%$/))&&n.width(e.ddWidth)),e.hasOwnProperty("ddPosX")||e.hasOwnProperty("ddPosY")){var i=t.position();if(e.hasOwnProperty("ddPosX")){var a;"self.center"==e.ddPosX?a=i.left+t.outerWidth()/2-n.outerWidth()/2:"center"==e.ddPosX?a=n.parent().outerWidth()/2-n.outerWidth()/2:isFinite(e.ddPosX)&&(a=e.ddPosX),n.css("left",a)}if(e.hasOwnProperty("ddPosY")){var o;"self.center"==e.ddPosY?o=i.top+t.outerHeight()/2-n.outerHeight()/2:"center"==e.ddPosY?o=n.parent().outerHeight()/2-n.outerHeight()/2:isFinite(e.ddPosY)&&(o=i.top+t.outerHeight()+e.ddPosY),n.css("top",o)}}n.find(".CloseDropdown").on("click.CloseDropdown",n.closeDropbox),t.on("click.Dropdown",function(){n.addClass("-show"),t.addClass("-dropdown_active"),$("body").on("mousedown.CloseDropdown",function(t){$(t.target).closest(".DropdownBox").length||n.closeDropbox()}),$(document).on("keyup.CloseDropdown",function(t){27==t.keyCode&&n.closeDropbox()})})}).addClass("-Handled_DropdownButton")}function bindFileLoadButton(t){t=t?t:$("body"),t.find(".FileLoadButton").not(".-Handled_FileLoadButton").click(function(t){var e=$(this);e.children("input").get(0).click()}).addClass("-Handled_FileLoadButton")}function bindCollapsing(t){t=t?t:$("body"),t.find(".CollapsingButton").each(function(){function t(){n.hasClass("-opened")?(n.height(a),n.on("click.toggleCollapsing",t)):(n.height(i.outerHeight()),n.off("click.toggleCollapsing")),n.toggleClass("-opened")}var e=$(this),n=e.siblings(".CollapsingWrapper"),i=n.children(),a=n.data("defaultHeight")<i.height()?n.data("defaultHeight"):i.height();n.hasClass("-opened")||(n.on("click.toggleCollapsing",t),n.height()<a&&n.height(a)),e.on("click.toggleCollapsing",t)})}function bindPageLinks(t){t=t?t:$("body"),t.find(".Link").not(".-Handled_Link").on("click.pageRender",function(t){var e=$(this);return!!e.hasClass(__C.CLASSES.DISABLED)||void(1==t.which&&(t.preventDefault(),__APP.changeState(e.attr("href"))))}).addClass("-Handled_Link")}function unbindPageLinks(t){t=t?t:$("body"),t.find(".Link").removeClass("-Handled_Link").off("click.pageRender")}function handleErrorField(t){if(!t instanceof jQuery)handleErrorField($(t));else if(t.is(".form_unit")){if(!t.closest("form_unit").hasClass("-status_error")){var e=t.find("input, select, textarea");t.toggleStatus("error").off("input.clear_error change.clear_error").one("input.clear_error change.clear_error",function(){t.off("input.clear_error change.clear_error").toggleStatus("error"),e.off("blur.clear_error")}),e.off("blur.clear_error").one("blur.clear_error",function(){""!==$(this).val()&&t.trigger("input.clear_error")})}}else handleErrorField(t.closest(".form_unit"))}function toDataUrl(t,e){var n=new XMLHttpRequest;n.responseType="blob",n.onload=function(){var t=new FileReader;t.onloadend=function(){e(t.result)},t.readAsDataURL(n.response)},n.open("GET",t),n.send()}function showNotifier(t){$.notify({message:t.text,pos:t.pos?t.pos:"top-right",status:t.status?"success":"danger"})}function isNotDesktop(){var t=!1;return function(e){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0)}(navigator.userAgent||navigator.vendor||window.opera),t}function showSettingsModal(){var t=$("#settings-modal");t.remove(),$.ajax({url:"/api/v1/users/me/settings",type:"GET",success:function(e){t=tmpl("settings-modal",e.data),t.appendTo($("body")).on("shown.bs.modal",function(){e.data.hasOwnProperty("show_to_friends")&&t.find(".show-to-friends").prop("checked",e.data.show_to_friends),e.data.hasOwnProperty("notify_in_browser")&&t.find(".notify-in-browser").prop("checked",e.data.notify_in_browser),t.find(".notify-in-browser").on("change",function(){var t=$(this);t.prop("checked")&&Notify.needsPermission&&Notify.requestPermission(function(){},function(){t.prop("checked",!1),showNotifier({status:!1,text:"Мы не можем включить уведомления в браузере. Вы запретили их для нас :("})})})}).modal(),t.find(".save-settings-btn").off("click").on("click",function(){var e={};t.find("input").each(function(){var t=$(this);e[t.attr("name")]=t.prop("checked")}),Pace.ignore(function(){$.ajax({url:"/api/v1/users/me/settings",type:"PUT",data:e})}),t.modal("hide")})}})}function getFriendsList(t,e){$.ajax({url:"/api/v1/users/friends?page=0&length=500",success:function(n){return 0==n.data.length?($(".no-friends-block").removeClass(__C.CLASSES.HIDDEN),void $(".friends-right-bar, .friends-main-content, .one-friend-profile").addClass(__C.CLASSES.HIDDEN)):(t.find(".friends-list").empty(),t.removeClass(__C.CLASSES.HIDDEN),tmpl("friend-item",n.data,t.find(".friends-list")),t.find(".friends-count").text(n.data.length),bindPageLinks(t),t.height()>window.innerHeight-200&&t.find(".friends-list").slimscroll({height:window.innerHeight-200,width:"100%"}),void(e&&e(n)))}})}function EntityInterface(){}function OneEntity(){}function EntitiesCollection(){}function OneActivity(){this.stat_type_id=0,this.event_id=0,this.event=new OneEvent(this.event_id),this.organization_id=0,this.organization=new OneOrganization(this.organization_id),this.user_id=0,this.user=new OneUser(this.user_id),this.entity="",this.type_code="",this.created_at=0}function ActivitiesCollection(){}function OneCategory(t,e){this.id=t?t:0,this.name="",this.order_position=0,this.organizations=new OrganizationsCollection,t&&e&&(this.loading=!0,this.fetchCategory([],function(){this.loading=!1,$(window).trigger("fetch.OneCategory")}))}function CategoriesCollection(){}function OneDate(){this.event_date="",this.id=0,this.start_time="",this.end_time="",this.event_id=0,this.organization_id=0,this.events_count=0,this.favored_count=0}function DatesCollection(){}function OneEvent(t,e){this.id=t?t:0,this.title="",this.description="",this.location="",this.detail_info_url="",this.can_edit=!1,this.registration_required=!1,this.registration_till="",this.organization_id=0,this.organization_short_name="",this.image_vertical_url="",this.image_horizontal_url="",this.image_horizontal_large_url="",this.organization_logo_small_url="",this.is_free=!1,this.min_price=0,this.first_event_date=null,this.last_event_date=null,this.nearest_event_date=null,this.is_same_time=!1,this.dates=new DatesCollection,this.tags=new TagsCollection,this.notifications=[],this.favored=new UsersCollection,this.favored_users_count=0,this.is_favorite=!1,this.canceled=!1,this.loading=!1,t&&e&&(this.loading=!0,this.fetchEvent([],function(){this.loading=!1,$(window).trigger("fetch.OneEvent")}))}function EventsCollection(){}function ActualEventsCollection(){}function CanceledEventsCollection(){}function DayEventsCollection(t){if(!t)throw Error("DayEventsCollection must have date parameter");this.date=t}function DelayedEventsCollection(){}function OneEventWithStatistics(t,e){OneEvent.apply(this,arguments),this.view=0,this.view_detail=0,this.fave=0,this.unfave=0,this.open_site=0,this.notifications_sent=0}function EventsWithStatisticsCollection(){}function FavoredEventsCollection(){}function FriendsEventsCollection(){}function FutureEventsCollection(){}function PastEventsCollection(){}function RecommendedEventsCollection(){}function TimelineEventsCollection(){}function OneOrganization(t,e){this.id=t||0,this.short_name="",this.description="",this.img_url="",this.img_small_url="",this.background_img_url="",this.background_medium_img_url="",this.type_id=0,this.type_name="",this.site_url="",this.default_address="",this.events=new EventsCollection,this.is_subscribed=!1,this.subscribed_count=0,this.subscribed=new UsersCollection,this.privileges=[],this.role="",this.staff=new UsersCollection,t&&e&&(this.loading=!0,this.fetchOrganization([],function(){this.loading=!1,$(window).trigger("fetch.OneOrganization")}))}function OrganizationsCollection(){}function SearchResults(t){this.query_string=t,this.events=new EventsCollection,this.organizations=new OrganizationsCollection}function Statistics(){this.id=0,this.view=[],this.fave=[],this.unfave=[],this.notifications_sent=[],this.dynamics={view:[],fave:[]}}function EventStatistics(t){Statistics.apply(this),this.id=t,this.open_site=[],this.view_detail=[],this.open_conversion=[],this.fave_conversion=[],this.dynamics.fave_conversion=[],this.dynamics.open_conversion=[]}function OrganizationsStatistics(t){Statistics.apply(this),this.id=t,this.subscribe=[],this.unsubscribe=[],this.conversion=[],this.audience={},this.dynamics.subscribe=[],this.dynamics.conversion=[]}function OneUser(t,e){this.id=t?t:0,this.first_name="",this.last_name="",this.middle_name="",this.gender="",this.avatar_url="",this.type="",this.is_friend=!1,this.is_editor=!1,this.blurred_image_url="",this.link="",this.subscriptions=new OrganizationsCollection,this.accounts=[],t&&e&&(this.loading=!0,this.fetchUser([],function(){this.loading=!1,$(window).trigger("fetch.OneUser")}))}function CurrentUser(){return"object"==typeof CurrentUser.instance?CurrentUser.instance:(OneUser.apply(this,["me"]),void(CurrentUser.instance=this))}function UsersCollection(){}function OneTag(t,e){this.id=t?t:0,this.name="",t&&e&&(this.loading=!0,this.fetchTag(function(){this.loading=!1,$(window).trigger("fetch.OneTag")}))}function TagsCollection(){}function Calendar(t,e){switch(this.options={classes:{wrapper_class:"calendar_wrapper",header_class:"calendar_header",prev_btn_class:"calendar_prev_btn",next_btn_class:"calendar_next_btn",month_name_class:"calendar_month_name",table_class:"calendar_month",thead_class:"calendar_thead",tbody_class:"calendar_tbody",tr_class:"calendar_week",head_tr_class:"calendar_weekdays_row",th_class:"calendar_weekday",td_class:"calendar_day",td_additional_classes:[],td_disabled_class:"-disabled",table_cell_class:"calendar_cell",today_class:"today"},additional_dataset:{},selection_type:Calendar.SELECTION_TYPES.SINGLE,weekday_selection:!1,month_selection:!1,disable_selection:!1,min_date:!1,max_date:!1,locale:"ru",labels:{}},!0){case t instanceof Element:case"string"==typeof t:if(t=$(t),0===t.length)throw new Error("Такого элемента не существует");if(t.length>1)throw new Error("Элементов с заданным аргументов найдено несколько");case t instanceof jQuery:$.extend(!0,this.options,e,t.data()),this.options.min_date!==!1&&this.options.max_date!==!1&&moment(this.options.max_date).diff(this.options.min_date,"days")<=0&&(this.options.max_date=!1),this.options.weekday_selection!==!0&&this.options.month_selection!==!0||(this.options.selection_type=Calendar.SELECTION_TYPES.MULTI),this.selected_days=[],this.selected_weeks={},this.selected_months=[],this.last_action="",this.last_selected_days="",this.now_selected_day="",this.prev_selected_day="",this.formatted_days={},this.$calendar=t,this.current_month=moment(new Date),this._today=moment(new Date);break;default:throw new TypeError("Аргумент должен быть экземпляром jQuery, элементом DOM, либо CSS селектором")}}function DatePicker(t,e){switch(this.options={classes:{},close_on_pick:!0,min_date:!1,max_date:!1,labels:{}},!0){case t instanceof Element:case"string"==typeof t:if(t=$(t),0===t.length)throw new Error("Такого элемента не существует");if(t.length>1)throw new Error("Элементов с заданным аргументов найдено несколько");case t instanceof jQuery:$.extend(!0,this.options,e,t.data()),this.$datepicker=t,this.$datepicker_modal={},this.$input=t.is("input")?t:t.find("input"),this.calendar={},this.prev_selected_day="undefined"!=typeof this.options.selected_day?this.options.selected_day:"",this.selected_day="undefined"!=typeof this.options.selected_day?this.options.selected_day:"",this.formated_selected_day=this.selected_day.toString().split("-").reverse().join(".");break;default:throw new TypeError("Аргумент должен быть экземпляром jQuery, элементом DOM, либо CSS селектором")}}function ActionButton(t,e){var n=this;this.classes=$.extend(!0,{subscribed_state:""},this.classes),this.options=$.extend(!0,this.options,e),this.options.classes=this.options.classes?this.options.classes:[],this.states.forEach(function(t){n.classes[t]=[],!!n.options.icons&&n.classes[t].push(n.options.icons[t]),!!n.options.colors&&n.classes[t].push(n.options.colors[t]),n.classes[t]=n.classes[t].join(" ")}),this.is_subscribed=!!e.is_subscribed,this.is_add_avatar=!!e.is_add_avatar,this.id=t,jQuery.fn.init.call(this,__APP.BUILD.button({classes:(n.is_subscribed?n.options.classes.concat(n.classes.subscribed).concat(n.classes.subscribed_state):n.options.classes.concat(n.classes.subscribe)).concat("fa_icon"),title:n.is_subscribed?n.options.labels.subscribed:n.options.labels.subscribe})),this.initiate()}function AddToFavoriteButton(t,e){this.classes={subscribed_state:"-Favored"},this.options={labels:{subscribe:__LOCALES.ru_RU.TEXTS.BUTTON.ADD_FAVORITE,unsubscribe:__LOCALES.ru_RU.TEXTS.BUTTON.REMOVE_FAVORITE,subscribed:__LOCALES.ru_RU.TEXTS.BUTTON.FAVORED},colors:{subscribe:"-color_neutral_accent",unsubscribe:"-color_accent",subscribed:"-color_accent"},icons:{subscribe:"fa-star-o",unsubscribe:"fa-times",subscribed:"fa-star"}},ActionButton.apply(this,[t,e])}function SubscribeButton(t,e){this.classes={subscribed_state:"-Subscribed"},this.options={labels:{subscribe:__LOCALES.ru_RU.TEXTS.BUTTON.ADD_SUBSCRIPTION,unsubscribe:__LOCALES.ru_RU.TEXTS.BUTTON.REMOVE_SUBSCRIPTION,subscribed:__LOCALES.ru_RU.TEXTS.BUTTON.SUBSCRIBED},colors:{subscribe:"-color_neutral_accent",unsubscribe:"-color_accent",subscribed:"-color_accent"},icons:{subscribe:"fa-plus",unsubscribe:"fa-times",subscribed:"fa-check"}},ActionButton.apply(this,[t,e])}function Page(){this.name=this.constructor.name,this.state_name=this.name,this.page_title="",this.$view=$(".PageView"),this.$wrapper=$(),this.wrapper_tmpl="std",this.is_loading=!1,this.can_render=!1,this.with_header_tabs=!1}function StatisticsPage(){Page.apply(this),this.state_name="statistics",this.SCALES={MINUTE:"minute",HOUR:"hour",DAY:"day",WEEK:"week",MONTH:"month",YEAR:"year",OVERALL:"overall"},this.highchart_defaults={chart:{backgroundColor:null,plotBorderWidth:null,plotShadow:!1,style:{fontFamily:"inherit",fontSize:"inherit"}},title:{text:!1},credits:{enabled:!1}}}function StatisticsOrganizationPage(t){StatisticsPage.apply(this),this.id=t,this.organization=new OneOrganization(this.id),this.with_header_tabs=!0,this.is_loading=!0,this.organization.fetchOrganization(["description","img_medium_url","default_address","staff","privileges","events".appendAjaxData({length:3,future:!0,is_canceled:!0,is_delayed:!0,fields:["organization_short_name","public_at"],order_by:"nearest_event_date"})],Page.triggerRender)}function StatisticsOrganizationAuditoryPage(t){StatisticsOrganizationPage.apply(this,arguments)}function StatisticsOrganizationEventsPage(t){StatisticsOrganizationPage.apply(this,arguments),this.block_scroll=!1,this.future_events=new EventsWithStatisticsCollection,this.past_events=new EventsWithStatisticsCollection,this.organization.fetchOrganization([],Page.triggerRender)}function StatisticsOrganizationOverviewPage(t){StatisticsOrganizationPage.apply(this,arguments),this.graphics_stats=new OrganizationsStatistics(this.id),this.other_stats=new OrganizationsStatistics(this.id),this.is_loading=!0,this.organization.fetchOrganizationWithEvents(["description","img_medium_url","default_address","staff","privileges"],{length:3,future:!0,is_canceled:!0,is_delayed:!0,fields:["organization_short_name","public_at"],order_by:"nearest_event_date"},Page.triggerRender)}function StatisticsOrganizationPromotionPage(t){StatisticsOrganizationPage.apply(this,arguments)}function StatisticsOrganizationSettingsPage(t){StatisticsOrganizationPage.apply(this,arguments)}function StatisticsOrganizationSupportPage(t){StatisticsOrganizationPage.apply(this,arguments)}function StatisticsEventPage(t){StatisticsPage.apply(this,arguments),this.id=t,this.event=new OneEvent(this.id)}function StatisticsEventAuditoryPage(t){StatisticsEventPage.apply(this,arguments)}function StatisticsEventEditPage(t){StatisticsEventPage.apply(this,arguments)}function StatisticsEventOverviewPage(t){StatisticsEventPage.apply(this,arguments),this.graphics_stats=new EventStatistics(this.id),this.scoreboards_stats=new EventStatistics(this.id),this.is_loading=!0,this.event.fetchEvent(["image_horizontal_medium_url","organization_short_name","favored_users_count","is_same_time","dates"],Page.triggerRender)}function StatisticsEventPromotionPage(t){StatisticsEventPage.apply(this,arguments)}function FeedPage(){Page.apply(this),this.fields=["organization_name","organization_short_name","organization_logo_small_url","dates","is_same_time","favored_users_count","is_favorite",'favored{fields:"is_friend",order_by:"-is_friend",length:10}',"registration_required","registration_till","is_free","min_price"],this.events=new EventsCollection,this.next_events_length=20,this.wrapper_tmpl="feed",this.with_header_tabs=!0}function ActualEventsPage(){FeedPage.apply(this),this.events=new ActualEventsCollection,this.page_title="Актуальные события"}function DayEventsPage(t){if(!t)throw Error("DayEventsCollection must have date parameter");FeedPage.apply(this),this.date=t,this.events=new DayEventsCollection(this.date),this.page_title="События на "+moment(this.date).format("D MMMM YYYY")}function FavoredEventsPage(){FeedPage.apply(this),this.events=new FavoredEventsCollection,this.page_title="Избранные события"}function FriendsEventsPage(){FeedPage.apply(this),this.events=new FriendsEventsCollection,this.page_title="События друзей"}function RecommendedEventsPage(){FeedPage.apply(this),this.events=new RecommendedEventsCollection,this.page_title="Рекомендованные события"}function TimelineEventsPage(){FeedPage.apply(this),this.events=new TimelineEventsCollection,this.page_title="События по времени"}function FriendsPage(){Page.apply(this),this.wrapper_tmpl="friends",this.page_title="Друзья"}function OneFriendPage(t){Page.apply(this),this.wrapper_tmpl="friends",this.friend_id=t}function OnboardingPage(){Page.apply(this,arguments),this.ajax_data={length:30,offset:0,fields:"img_small_url"},this.disable_upload=!1,this.block_scroll=!0}function SearchPage(t){Page.apply(this,arguments),this.page_title="Поиск",this.$search_bar_input=$("#search_bar_input"),this.search_string=decodeURIComponent(t),this.events_ajax_data={length:10,fields:["image_horizontal_medium_url","detail_info_url","is_favorite","nearest_event_date","can_edit","location","registration_required","registration_till","is_free","min_price","favored_users_count","organization_name","organization_short_name","organization_logo_small_url","description","favored","is_same_time","tags","dates"],order_by:"nearest_event_date,-first_event_date"},this.organizations_ajax_data={length:30,fields:["subscribed_count","img_small_url"]},this.past_events=!1,this.search_results=new SearchResults(this.search_string),this.is_loading=!0,this.search_results.fetchEventsAndOrganizations(this.events_ajax_data,this.organizations_ajax_data,Page.triggerRender)}function StatisticsOverviewPage(){StatisticsPage.apply(this),this.my_organizations_fields=["img_medium_url","subscribed_count","staff"],this.page_title="Организации",this.is_loading=!0,this.my_organizations=new OrganizationsCollection,this.my_organizations.fetchMyOrganizations("admin",this.my_organizations_fields,10,"",Page.triggerRender)}function RedactEventPage(t){Page.apply(this),this.page_title="Редактирование события",this.is_loading=!1,this.fields=["image_horizontal_large_url",'favored{fields:"is_friend",order_by:"-is_friend",length:10}',"favored_users_count","is_favorite",'notifications{fields:"notification_type,done"}',"description","location","can_edit","registration_required","registration_till","is_free","min_price","organization_logo_small_url","organization_short_name","is_same_time",'dates{length:0,fields:"start_time,end_time"}',"tags","detail_info_url","canceled"],this.event=new OneEvent(t),t&&(this.is_loading=!0,this.event.fetchEvent(this.fields,Page.triggerRender))}function AddEventPage(t){RedactEventPage.apply(this),this.page_title="Добавить событие",this.organization_id=t}function OneEventPage(t){Page.apply(this),this.fields=["image_horizontal_large_url",'favored{fields:"is_friend",order_by:"-is_friend",length:10}',"favored_users_count","is_favorite",'notifications{fields:"notification_type,done"}',"description","location","can_edit","registration_required","registration_till","is_free","min_price","organization_logo_small_url","organization_short_name","is_same_time",'dates{length:0,fields:"start_time,end_time"}',"tags","detail_info_url","canceled"],this.is_loading=!0,this.event=new OneEvent(t),this.event.fetchEvent(this.fields,Page.triggerRender)}function EditOrganizationPage(t){Page.apply(this),this.page_title="Редактировать организацию",this.organization=new OneOrganization(t),this.categories=new CategoriesCollection,this.fields=["description","site_url","default_address","vk_url","facebook_url","email"],t&&(this.is_loading=!0,this.organization.fetchOrganization(this.fields,Page.triggerRender))}function AddOrganizationPage(){EditOrganizationPage.apply(this),this.page_title="Новая организация"}function CatalogPage(t){var e=this;Page.apply(this),this.wrapper_tmpl="organizations",this.categories_ajax_data={
order_by:"order_position"},this.organizations_ajax_data={fields:["background_small_img_url","img_small_url","is_subscribed","subscribed_count","privileges"],order_by:"-subscribed_count"},this.default_title="Организации",this.is_loading=!0,this.selected_category_id=t,this.categories=new CategoriesCollection,this.all_organizations=new OrganizationsCollection,this.categories.fetchCategoriesWithOrganizations(this.categories_ajax_data,this.organizations_ajax_data,0,function(){e.all_organizations=e.categories.reduce(function(t,e){return t.setData(e.organizations)},new OrganizationsCollection).sort(function(t,e){return e.subscribed_count-t.subscribed_count}),Page.triggerRender()})}function OrganizationPage(t){var e=this,n={last_date:"",disable_upload:!1};Page.apply(this,arguments),this.fields=["img_small_url","background_medium_img_url","description","site_url","is_subscribed","privileges","default_address","subscribed_count",'subscribed{fields:"is_friend",order_by:"-is_friend,first_name",length:10}'],this.events_fields=["image_horizontal_medium_url","favored_users_count","is_favorite","favored{length:5}","dates"],this.event_types={future:$.extend(!0,{},n,{name:"future",scroll_event:"scroll.uploadFutureEvents",sort_date_type:"nearest_event_date"}),past:$.extend(!0,{},n,{name:"past",scroll_event:"scroll.uploadPastEvents",sort_date_type:"last_event_date"}),delayed:$.extend(!0,{},n,{name:"delayed",scroll_event:"scroll.uploadDelayedEvents",sort_date_type:"public_at"}),canceled:$.extend(!0,{},n,{name:"canceled",scroll_event:"scroll.uploadCanceledEvents",sort_date_type:"first_event_date"})},this.events_load=0,this.is_loading=!0,this.future_events=new FutureEventsCollection,this.past_events=new PastEventsCollection,this.delayed_events=new DelayedEventsCollection,this.canceled_events=new CanceledEventsCollection,this.organization=new OneOrganization(t),this.organization.fetchOrganization(this.fields,function(t){e.is_admin=e.organization.role!=OneUser.ROLE.USER,e.max_events_load=e.is_admin?4:2,Page.triggerRender()})}Function.prototype.extend=function(t){this.prototype=Object.create(t.prototype),this.prototype.constructor=this,this.prototype.__super=t.prototype,this.prototype.__superCall=function(e){return t.prototype[e]&&"function"==typeof t.prototype[e]?t.prototype[e].call(this,Array.prototype.slice.call(1,arguments)):void console.error('There is no "'+e+'" method in object "'+t.prototype.constructor.name+'"')}},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.contains=function(t){return this.search(t)!==-1},String.prototype.format=function(t){return this.replace(/\{(\w+)\}/g,function(e,n){return null!=t[n]?t[n]:""})},String.prototype.toCamelCase=function(t){return this.split(t?t:" ").map(function(t){return t.capitalize()}).join("")},String.prototype.toUnderscore=function(){return(this.charAt(0).toLowerCase()+this.slice(1)).replace(/([A-Z])/g,function(t){return"_"+t.toLowerCase()})},String.prototype.appendAjaxData=function(t){return t.fields&&t.fields instanceof Array&&(t.fields=t.fields.join(",")),this+JSON.stringify(t)},Object.props=function(t){var e=[];return Object.keys(t).forEach(function(n){"function"!=typeof t[n]&&e.push(n)}),e},Object.methods=function(t){var e=[];return Object.keys(t).forEach(function(n){"function"==typeof t[n]&&e.push(n)}),e},"function"!=typeof Object.values&&(Object.values=function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&t.propertyIsEnumerable(n)&&e.push(t[n]);return e}),Object.toHtmlDataSet=function(){var t=[],e=this;return Object.props(e).forEach(function(n){t.push((0!=n.indexOf("data-")?"data-"+n:n)+'="'+e[n]+'"')}),t.join(" ")},Object.toHtmlAttributes=function(){var t=[],e=this;return Object.props(e).forEach(function(n){t.push(n+'="'+e[n]+'"')}),t.join(" ")},Array.newFrom=function(t,e){var n,i,a=t.slice(0);if(arguments.length>1)for(i=1;i<arguments.length;i++)switch(n=arguments[i],typeof n){case"number":case"string":case"boolean":$.merge(a,[n]);break;case"object":n instanceof Array?$.merge(a,n):$.merge(a,Object.keys(n).map(function(t){return n[t]}));break;default:console.error("")}return a},Array.toSpaceSeparatedString=function(){return this.join(" ")},Array.prototype.clean=function(t){for(var e=0;e<this.length;e++)this[e]==t&&(this.splice(e,1),e--);return this},Math.roundTo=function(t,e){var n=Math.pow(10,e?e:0);return Math.round(t*n)/n},function(t){function e(e){function n(t,e){for(var n,i,a,o=t.split("").reverse(),s=[],r=0,d=Math.ceil(t.length/e);r<d;r++){for(n="",a=0;a<e&&(i=r*e+a,i!==t.length);a++)n+=o[i];s.push(n)}return s}function i(t){var e=t.length-1,n=t[e].split("").reverse().join("");return t[e]=parseInt(n,10).toString().split("").reverse().join(""),t}var a,o,s,r=t(e.elem),d={separator:" ",group_length:3,suffix:"",prefix:""};if(e.elem.nodeType&&e.elem.parentNode){if(a=t.extend(!0,{},d,r.data()),o=Math.floor(e.now),s=o.toString(),s.length>a.group_length){var l=n(s,a.group_length);s=i(l).join(a.separator),s=s.split("").reverse().join("")}r.prop("number",e.now).text(a.prefix+s+a.suffix)}}t.Tween&&t.Tween.propHooks?t.Tween.propHooks.number={set:e}:t.fx.step.number=e}(window.jQuery),$.fn.extend({toggleStatus:function(t){var e=this;if(e.is(".form_unit"))t.split(" ").forEach(function(t){var n=e.find("input, select, textarea, button");"disabled"===t&&(e.hasClass("-status_disabled")?n.removeAttr("disabled"):n.attr("disabled",!0)),e.toggleClass("-status_"+t)});else if(e.is("input, textarea, select, button"))e.closest(".form_unit").toggleStatus(t);else{if(!e.length)throw Error("Argument not found");e.find(".form_unit").toggleStatus(t)}return this},serializeForm:function(t){var e=/^(?:input|select|textarea|keygen)/i,n=/^(?:submit|button|image|reset|file)$/i,i=/^(?:checkbox|radio)$/i,a=/\r?\n/g,o=this.map(function(){var t=$.prop(this,"elements");return t?$.makeArray(t):this});switch(t){case"array":return o.filter(function(){var t=this.type;return this.name&&!$(this).is(":disabled")&&e.test(this.nodeName)&&!n.test(t)&&(this.checked&&"on"!=this.value||"radio"!=t)&&(this.checked&&"on"!=this.value||"on"==this.value||"checkbox"!=t)}).map(function(t,e){var n=$(this).val(),i="";switch(this.type){case"radio":case"checkbox":i="on"==n?this.checked?1:0:n;break;default:i=n.replace(a,"\r\n")}return null==n?null:{name:e.name,value:i}}).get();case"object":default:var s={};return o.filter(function(){var t=this.type;return this.name&&!$(this).is(":disabled")&&e.test(this.nodeName)&&!n.test(t)&&!i.test(t)}).each(function(t,e){var n=$(e),i=e.name,r=n.val();if(o.filter("[name='"+i+"']").length>1&&""!=r)s[i]="undefined"==typeof s[i]?[]:s[i],s[i].push(r?r.replace(a,"\r\n"):r);else if("hidden"===n.attr("type")&&0===r.indexOf("data.")){for(var d=r.split("."),l=n.data(d[1]),c=2;d[c];)l=l[d[c]],c++;s[i]=l}else s[i]=r||0===r?r.replace(a,"\r\n"):null}),o.filter(function(){var t=this.type;return this.name&&!$(this).is(":disabled")&&i.test(t)&&(this.checked&&"on"!=this.value||"on"==this.value&&"checkbox"==t)}).each(function(t,e){var n=e.name,i=e.value;switch(e.type){case"radio":s[n]=i;break;case"checkbox":o.filter("[name='"+n+"']").length>1&&"on"!=i?(s[n]="undefined"==typeof s[n]?[]:s[n],s[n].push(i)):"on"!=i?s[n]=i:s[n]=!!e.checked}}),s}},animateNumber:function(t){for(var e=[t],n=1,i=arguments.length;n<i;n++)e.push(arguments[n]);return this.data(t),this.animate.apply(this,e)},tablesort:function(t){return t||(t={}),Tablesort&&"function"==typeof Tablesort?Tablesort(this.get(0),t):void console.error("Tablesort is not defined")}}),jQuery.makeSet=function(t){return $($.map(t,function(t){return t.get()}))},function(t,e,n){var i={},a={},o=function(e){return"string"==t.type(e)&&(e={message:e}),arguments[1]&&(e=t.extend(e,"string"==t.type(arguments[1])?{status:arguments[1]}:arguments[1])),new r(e).show()},s=function(t,e){if(t)for(var n in a)t===a[n].group&&a[n].close(e);else for(var n in a)a[n].close(e)},r=function(e){this.options=t.extend({},r.defaults,e),this.uuid="ID"+(new Date).getTime()+"RAND"+Math.ceil(1e5*Math.random()),this.element=t(['<div class="uk-notify-message alert-dismissable">','<a class="close">&times;</a>',"<div>"+this.options.message+"</div>","</div>"].join("")).data("notifyMessage",this),this.options.status&&(this.element.addClass("alert alert-"+this.options.status),this.currentstatus=this.options.status),this.group=this.options.group,a[this.uuid]=this,i[this.options.pos]||(i[this.options.pos]=t('<div class="uk-notify uk-notify-'+this.options.pos+'"></div>').appendTo("body").on("click",".uk-notify-message",function(){t(this).data("notifyMessage").close()}))};return t.extend(r.prototype,{uuid:!1,element:!1,timout:!1,currentstatus:"",group:!1,show:function(){if(!this.element.is(":visible")){var t=this;i[this.options.pos].show().prepend(this.element);var e=parseInt(this.element.css("margin-bottom"),10);return this.element.css({opacity:0,"margin-top":-1*this.element.outerHeight(),"margin-bottom":0}).animate({opacity:1,"margin-top":0,"margin-bottom":e},function(){if(t.options.timeout){var e=function(){t.close()};t.timeout=setTimeout(e,t.options.timeout),t.element.hover(function(){clearTimeout(t.timeout)},function(){t.timeout=setTimeout(e,t.options.timeout)})}}),this}},close:function(t){var e=this,n=function(){e.element.remove(),i[e.options.pos].children().length||i[e.options.pos].hide(),delete a[e.uuid]};this.timeout&&clearTimeout(this.timeout),t?n():this.element.animate({opacity:0,"margin-top":-1*this.element.outerHeight(),"margin-bottom":0},function(){n()})},content:function(t){var e=this.element.find(">div");return t?(e.html(t),this):e.html()},status:function(t){return t?(this.element.removeClass("alert alert-"+this.currentstatus).addClass("alert alert-"+t),this.currentstatus=t,this):this.currentstatus}}),r.defaults={message:"",status:"normal",timeout:5e3,group:null,pos:"top-center"},t.notify=o,t.notify.message=r,t.notify.closeAll=s,o}(jQuery,window,document),function(t){t.cookies={getItem:function(t){return t?decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null:null},setItem:function(t,e,n,i,a,o){var s="";if(!t||/^(?:expires|max\-age|path|domain|secure)$/i.test(t))return!1;if(n)switch(n.constructor){case Number:s=n===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+n;break;case String:s="; expires="+n;break;case Date:s="; expires="+n.toUTCString()}return document.cookie=encodeURIComponent(t)+"="+encodeURIComponent(e)+s+(a?"; domain="+a:"")+(i?"; path="+i:"")+(o?"; secure":""),!0},removeItem:function(t,e,n){return!!this.hasItem(t)&&(document.cookie=encodeURIComponent(t)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(n?"; domain="+n:"")+(e?"; path="+e:""),!0)},hasItem:function(t){return!!t&&new RegExp("(?:^|;\\s*)"+encodeURIComponent(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},keys:function(){for(var t=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),e=t.length,n=0;n<e;n++)t[n]=decodeURIComponent(t[n]);return t}}}(window),window.location.hostname.indexOf(".test.evendate.ru")==-1?window.socket=io.connect("https:"==window.location.protocol?":8443":":8080",{secure:"https:"==window.location.protocol}):window.socket=io({path:"/node/socket.io"}),socket.on("auth",function(t){console.log(t),$.ajax({url:"auth.php",type:"POST",data:t,success:function(e){if(yaCounter32442130)switch(t.type){case"vk":yaCounter32442130.reachGoal("VkAuthDone");break;case"facebook":yaCounter32442130.reachGoal("FacebookAuthDone");break;case"google":yaCounter32442130.reachGoal("GoogleAuthDone")}e.status?t.hasOwnProperty("mobile")&&1==t.mobile?window.location.href="/mobileAuthDone.php?token="+t.token+"&email="+t.email:cookies.hasItem("open_add_organization")?window.parent.location="/add/organization":0==t.subscriptions_count?window.parent.location="/onboarding":window.parent.location="/feed":($(".panel-body.loader-demo").text(e.text),$(".panel-heading").hide())}})}),socket.on("log",function(t){console.log(t)}),socket.on("error.retry",function(){$(".panel-body.loader-demo").text("Во время загрузки данных произошла ошибка. Войдите с помощью другой социальной сети или попробуте чуть позже."),$(".panel-heading").hide()}),socket.on("notification",function(t){if(Notify.needsPermission)Notify.isSupported()&&Notify.requestPermission();else{socket.emit("notification.received",{notification_id:t.notification_id});var e=new Notify(t.note.payload.title,{body:t.note.body,icon:t.note.icon,tag:t.note.payload.event_id,timeout:60,notifyClick:function(){$("<a>").attr("href",window.location.origin+"/event.php?id="+t.note.payload.event_id).attr("target","_blank")[0].click(),socket.emit("notification.received",{notification_id:t.notification_id,click_time:moment().format(__C.DATE_FORMAT+" HH:MM:SS")})}});e.show()}}),socket.on("image.getFromURLDone",function(t){t.error?showNotifier({text:t.error,status:!1}):RedactEventPage.handleImgUpload(window.current_load_button,t.data,t.filename)}),socket.on("vk.getGroupsToPostDone",function(t){if(t.error)showNotifier({text:t.error,status:!1});else{var e=t.data.response,n=__APP.CURRENT_PAGE.$wrapper.find("#edit_event_vk_groups");e.length||e[0]?(e.splice(0,1),e.forEach(function(t){n.append(tmpl("option",{val:t.gid,display_name:t.name,data:"data-img='"+t.photo+"'"}))}),initSelect2(n)):__APP.CURRENT_PAGE.$wrapper.find("#edit_event_to_public_vk").toggleStatus("disabled").prop("checked",!1).trigger("change")}}),socket.on("vk.post.error",function(t){console.log(t),showNotifier({text:"Не удалось опубликовать событие в группе vk. Пожалуйста, попробуйте еще раз.",status:!1})}),EntityInterface.prototype.setData=function(t){},OneEntity.prototype.setData=function(t){var e;Array.isArray(t)&&(t=t[0]);for(e in t)this[e]instanceof EntitiesCollection?this[e].setData(t[e]):this[e]=t[e];return this},EntitiesCollection.extend(Array),EntitiesCollection.prototype.collection_of=OneEntity,EntitiesCollection.prototype.setData=function(t){return t=t instanceof Array?t:[t],this.push.apply(this,t),this},EntitiesCollection.prototype.getByID=function(t){for(var e=0;e<this.length;e++)if(this[e].id==t)return this[e];return null},EntitiesCollection.prototype.has=function(t){return this.getByID(t)instanceof OneEntity},EntitiesCollection.prototype.push=function(t){for(var e=0;e<arguments.length;e++)(!arguments[e].id||arguments[e].id&&!this.has(arguments[e].id))&&(this[this.length++]=arguments[e]instanceof this.collection_of?arguments[e]:(new this.collection_of).setData(arguments[e]));return this.length},EntitiesCollection.prototype.remove=function(t){return this.has(t)?this.splice(this.indexOf(this.getByID(t)),1):[]},OneActivity.extend(OneEntity),ActivitiesCollection.extend(EntitiesCollection),ActivitiesCollection.prototype.collection_of=OneActivity,ActivitiesCollection.fetchUserActions=function(t,e,n){return __APP.SERVER.getData("/api/v1/users/"+t+"/actions",e,n)},ActivitiesCollection.fetchFriendsActions=function(t,e){return __APP.SERVER.getData("/api/v1/users/feed",t,e)},ActivitiesCollection.prototype.fetchUserActions=function(t,e,n,i){var a=this,o={fields:t,offset:this.length,length:e};return n&&(o.order_by=n),this.constructor.fetchUserActions(o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},ActivitiesCollection.prototype.fetchFriendsActions=function(t,e,n,i){var a=this,o={fields:t,offset:this.length,length:e};return n&&(o.order_by=n),this.constructor.fetchFriendsActions(o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},OneCategory.extend(OneEntity),OneCategory.fetchCategory=function(t,e,n){return __APP.SERVER.getData("/api/v1/organizations/types",$.extend({},e,{id:t}),n)},OneCategory.prototype.fetchCategory=function(t,e){var n=this;return this.constructor.fetchCategory(n.id,t,function(t){n.setData(t),e&&"function"==typeof e&&e.call(n,t[0])})},CategoriesCollection.extend(EntitiesCollection),CategoriesCollection.prototype.collection_of=OneCategory,CategoriesCollection.fetchCategories=function(t,e){return __APP.SERVER.getData("/api/v1/organizations/types",t,e)},CategoriesCollection.prototype.fetchCategories=function(t,e,n){var i=this,a=$.extend({},t,{offset:this.length,length:e});return this.constructor.fetchCategories(a,function(t){i.setData(t),n&&"function"==typeof n&&n.call(i,t)})},CategoriesCollection.prototype.fetchCategoriesWithOrganizations=function(t,e,n,i){var a=this,o=$.extend({},t,{offset:this.length,length:n}),s="organizations"+JSON.stringify(__APP.SERVER.validateData(e));return o.fields?Array.isArray(o.fields)||(o.fields=o.fields.split(",")):o.fields=[],o.fields.push(s),this.constructor.fetchCategories(o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},OneDate.extend(OneEntity),DatesCollection.prototype.collection_of=OneDate,DatesCollection.extend(EntitiesCollection),DatesCollection.fetchDates=function(t,e){return __APP.SERVER.getData("/api/v1/events/dates",t,e)},OneEvent.extend(OneEntity),OneEvent.STATUS={CANCEL:"cancel",BRING_BACK:"bring_back",HIDE:"hide",SHOW:"show"},OneEvent.fetchEvent=function(t,e,n){return __APP.SERVER.getData("/api/v1/events/"+t,e||Array.isArray(e)&&e.length?{fields:e}:{},n)},OneEvent.createEvent=function(t,e,n){return __APP.SERVER.addData("/api/v1/events/",JSON.stringify(t),!0,e,n)},OneEvent.updateEvent=function(t,e,n,i){return __APP.SERVER.updateData("/api/v1/events/"+t,JSON.stringify(e),n,i)},OneEvent.changeEventStatus=function(t,e,n){var i={};return e=Array.isArray(e)?e:[e],e.forEach(function(t){switch(t){case OneEvent.STATUS.CANCEL:i.canceled=!0;break;case OneEvent.STATUS.BRING_BACK:i.canceled=!1;break;case OneEvent.STATUS.HIDE:i.hidden=!0;break;case OneEvent.STATUS.SHOW:i.hidden=!1}}),__APP.SERVER.updateData("/api/v1/events/"+t+"/status",i,function(){n&&"function"==typeof n&&n.call(self,i)})},OneEvent.addFavored=function(t,e){return __APP.SERVER.addData("/api/v1/events/"+t+"/favorites",{},!1,e)},OneEvent.deleteFavored=function(t,e){return __APP.SERVER.deleteData("/api/v1/events/"+t+"/favorites",{},e)},OneEvent.addEventNotification=function(t,e,n){return __APP.SERVER.addData("/api/v1/events/"+t+"/notifications",{notification_type:e},!1,n)},OneEvent.deleteEventNotification=function(t,e,n){return __APP.SERVER.deleteData("/api/v1/events/"+t+"/notifications/"+e,{},n)},OneEvent.prototype.fetchEvent=function(t,e){var n=this;return this.constructor.fetchEvent(n.id,t,function(t){n.setData(t[0]),e&&"function"==typeof e&&e.call(n,t[0])})},OneEvent.prototype.createEvent=function(t,e,n){var i=this;return this.constructor.createEvent(t,function(n){i.setData(t),i.id=n.event_id,e&&"function"==typeof e&&e.call(i,t)},n)},OneEvent.prototype.updateEvent=function(t,e,n){var i=this;return this.constructor.updateEvent(i.id,t,function(n){i.setData(t),e&&"function"==typeof e&&e.call(i,t)},n)},OneEvent.prototype.changeEventStatus=function(t,e){var n=this;return this.constructor.changeEventStatus(n.id,t,function(t){n.setData(t),e&&"function"==typeof e&&e.call(n,t)})},OneEvent.prototype.addNotification=function(t,e){return this.constructor.addEventNotification(this.id,t,e)},OneEvent.prototype.deleteNotification=function(t,e){return this.constructor.deleteEventNotification(this.id,t,e)},EventsCollection.extend(EntitiesCollection),EventsCollection.prototype.collection_of=OneEvent,EventsCollection.KIND={MY:"my",FAVORED:"favored",RECOMMENDED:"recommended"},EventsCollection.fetchEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/",t,e)},EventsCollection.fetchMyEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/my",t,e)},EventsCollection.fetchFavoredEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/favorites",t,e)},EventsCollection.fetchRecommendedEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/recommendations",t,e)},EventsCollection.fetchOrganizationsEvents=function(t,e,n){return __APP.SERVER.getData("/api/v1/events/",$.extend({},e,{organization_id:t}),n)},EventsCollection.prototype.fetchEvents=function(t,e,n,i){var a=this,o="fetchEvents",s=$.extend({},e,{offset:this.length,length:n});switch(t){default:o="fetchEvents";break;case EventsCollection.KIND.MY:o="fetchMyEvents";break;case EventsCollection.KIND.FAVORED:o="fetchFavoredEvents";break;case EventsCollection.KIND.RECOMMENDED:o="fetchRecommendedEvents"}return this.constructor[o](s,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},EventsCollection.prototype.fetchFeed=function(t,e,n){var i=this,a={fields:t,offset:this.length,length:e};return this.constructor.fetchEvents(a,function(t){i.setData(t),n&&"function"==typeof n&&n.call(i,t)})},EventsCollection.prototype.fetchOrganizationsEvents=function(t,e,n,i){var a=this,o=$.extend({},e,{offset:this.length,length:n});return this.constructor.fetchOrganizationsEvents(t,o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},EventsCollection.prototype.fetchOrganizationsFeed=function(t,e,n,i){var a=this,o={fields:e,offset:this.length,length:n};return this.constructor.fetchOrganizationsEvents(t,o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},ActualEventsCollection.extend(EventsCollection),ActualEventsCollection.fetchEvents=function(t,e){return t.fields=t.fields?Array.isArray(t.fields)?t.fields:t.fields.split(","):[],t.fields.push("actuality"),t.future=!0,t.order_by="-actuality",EventsCollection.fetchMyEvents(t,e)},CanceledEventsCollection.extend(EventsCollection),CanceledEventsCollection.fetchOrganizationsEvents=function(t,e,n){return e.fields=e.fields?Array.isArray(e.fields)?e.fields:e.fields.split(","):[],e.fields.push("updated_at"),e.is_canceled=!0,e.order_by="-updated_at",EventsCollection.fetchOrganizationsEvents(t,e,n)},DayEventsCollection.extend(EventsCollection),DayEventsCollection.fetchEvents=function(t,e,n){return e.future=!1,e.date=t,EventsCollection.fetchMyEvents(e,n)},DayEventsCollection.prototype.fetchFeed=function(t,e,n){var i=this,a={fields:t,offset:this.length,length:e};return this.constructor.fetchEvents(this.date,a,function(t){i.setData(t),n&&"function"==typeof n&&n.call(i,t)})},DelayedEventsCollection.extend(EventsCollection),DelayedEventsCollection.fetchOrganizationsEvents=function(t,e,n){return e.fields=e.fields?Array.isArray(e.fields)?e.fields:e.fields.split(","):[],e.fields.push("public_at"),e.is_delayed=!0,e.is_canceled=!1,e.order_by="public_at",EventsCollection.fetchOrganizationsEvents(t,e,n)},OneEventWithStatistics.extend(OneEvent),EventsWithStatisticsCollection.extend(EventsCollection),EventsWithStatisticsCollection.prototype.collection_of=OneEventWithStatistics,EventsWithStatisticsCollection.fetchEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/",t,e)},EventsWithStatisticsCollection.fetchMyEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/my",t,e)},EventsWithStatisticsCollection.fetchFavoredEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/favorites",t,e)},EventsWithStatisticsCollection.fetchRecommendedEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/recommendations",t,e)},EventsWithStatisticsCollection.fetchOrganizationsEvents=function(t,e,n){return e.statistics=!0,__APP.SERVER.getData("/api/v1/events/",$.extend({},e,{organization_id:t}),n)},FavoredEventsCollection.extend(EventsCollection),FavoredEventsCollection.fetchEvents=function(t,e){return t.future=!0,EventsCollection.fetchFavoredEvents(t,e)},FriendsEventsCollection.extend(EventsCollection),FriendsEventsCollection.fetchEvents=function(t,e){return t.fields=t.fields?Array.isArray(t.fields)?t.fields:t.fields.split(","):[],t.fields.push("favored_friends_count"),t.future=!0,t.order_by="-favored_friends_count",EventsCollection.fetchMyEvents(t,e)},FutureEventsCollection.extend(EventsCollection),FutureEventsCollection.fetchOrganizationsEvents=function(t,e,n){return e.future=!0,e.order_by="nearest_event_date",EventsCollection.fetchOrganizationsEvents(t,e,n)},PastEventsCollection.extend(EventsCollection),PastEventsCollection.fetchOrganizationsEvents=function(t,e,n){return e.till=moment().format(__C.DATE_FORMAT),e.order_by="-last_event_date",EventsCollection.fetchOrganizationsEvents(t,e,n)},RecommendedEventsCollection.extend(EventsCollection),RecommendedEventsCollection.fetchEvents=function(t,e){return t.future=!0,t.order_by="-rating",EventsCollection.fetchRecommendedEvents(t,e)},TimelineEventsCollection.extend(EventsCollection),TimelineEventsCollection.fetchEvents=function(t,e){return t.future=!0,EventsCollection.fetchMyEvents(t,e)},OneOrganization.extend(OneEntity),OneOrganization.fetchOrganization=function(t,e,n){return __APP.SERVER.getData("/api/v1/organizations/"+t,{fields:e},n)},OneOrganization.createOrganization=function(t,e){return __APP.SERVER.addData("/api/v1/organizations/",JSON.stringify(t),!0,e)},OneOrganization.updateOrganization=function(t,e,n){return __APP.SERVER.updateData("/api/v1/organizations/"+t,JSON.stringify(e),n)},OneOrganization.subscribeOrganization=function(t,e){return __APP.SERVER.addData("/api/v1/organizations/"+t+"/subscriptions",{},!1,e)},OneOrganization.unsubscribeOrganization=function(t,e){return __APP.SERVER.deleteData("/api/v1/organizations/"+t+"/subscriptions",{},e)},OneOrganization.prototype.setData=function(t){return OneEntity.prototype.setData.call(this,t),this.role=OneUser.recognizeRole(this.privileges),this},OneOrganization.prototype.fetchOrganization=function(t,e){var n=this;return this.constructor.fetchOrganization(n.id,t,function(t){n.setData(t),e&&"function"==typeof e&&e.call(n,n)})},OneOrganization.prototype.fetchOrganizationWithEvents=function(t,e,n){var i=t;return i=i instanceof Array?i:i.split(","),i.push("events".appendAjaxData(e)),this.fetchOrganization(t,n)},OneOrganization.prototype.createOrganization=function(t,e){var n=this;return OneOrganization.createOrganization(t,function(i){n.setData(t),n.id=i.organization_id,e&&"function"==typeof e&&e.call(n,n)})},OneOrganization.prototype.updateOrganization=function(t,e){var n=this;return OneOrganization.updateOrganization(n.id,t,function(i){n.setData(t),e&&"function"==typeof e&&e.call(n,n)})},OneOrganization.prototype.subscribe=function(t){var e=this;return this.constructor.subscribeOrganization(this.id,function(n){this.is_subscribed=!0,this.subscribed_count++,t&&"function"==typeof t&&t.call(e,n)})},OneOrganization.prototype.unsubscribe=function(t){var e=this;return this.constructor.unsubscribeOrganization(this.id,function(n){this.is_subscribed=!1,this.subscribed_count=this.subscribed_count?this.subscribed_count-1:this.subscribed_count,t&&"function"==typeof t&&t.call(e,n)})},OrganizationsCollection.extend(EntitiesCollection),OrganizationsCollection.prototype.collection_of=OneOrganization,OrganizationsCollection.fetchSubscribedOrganizations=function(t,e){return __APP.SERVER.getData("/api/v1/organizations/subscriptions",t,e)},OrganizationsCollection.fetchMyOrganizations=function(t,e,n){return t=Array.isArray(t)?t.join(","):t,__APP.SERVER.getData("/api/v1/organizations/",$.extend({},e,{roles:t}),n)},OrganizationsCollection.fetchRecommendations=function(t,e){return __APP.SERVER.getData("/api/v1/organizations/recommendations",t,e)},OrganizationsCollection.prototype.fetchSubscribedOrganizations=function(t,e,n,i){var a=this,o={fields:t,offset:this.length,length:e,order_by:n||void 0};return this.constructor.fetchSubscribedOrganizations(o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},OrganizationsCollection.prototype.fetchMyOrganizations=function(t,e,n,i,a){var o=this,s={fields:e,length:n,offset:this.length,order_by:i||void 0};return OrganizationsCollection.fetchMyOrganizations(t,s,function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,t)})},SearchResults.extend(OneEntity),SearchResults.sanitizeQueryVar=function(t){var e={};return 0===t.indexOf("#")?e.tags=t.replace("#",""):e.q=t,e},SearchResults.fetchEventsAndOrganizations=function(t,e,n){return __APP.SERVER.getData("/api/v1/search/",$.extend({},SearchResults.sanitizeQueryVar(t),e),n)},SearchResults.prototype.fetchEvents=function(t,e){var n=this,i={fields:"events"+JSON.stringify($.extend({},__APP.SERVER.validateData(t),{offset:this.events.length}))};return SearchResults.fetchEventsAndOrganizations(n.query_string,i,function(t){n.setData(t),e&&"function"==typeof e&&e.call(n,t.events)})},SearchResults.prototype.fetchOrganizations=function(t,e){var n=this,i={fields:"organizations"+JSON.stringify($.extend({},__APP.SERVER.validateData(t),{offset:this.organizations.length}))};return SearchResults.fetchEventsAndOrganizations(n.query_string,i,function(t){n.setData(t),e&&"function"==typeof e&&e.call(n,t.organizations)})},SearchResults.prototype.fetchEventsAndOrganizations=function(t,e,n){var i=this,a={fields:[]};return t&&a.fields.push("events"+JSON.stringify($.extend({},__APP.SERVER.validateData(t),{offset:this.events.length}))),e&&!SearchResults.sanitizeQueryVar(i.query_string).tags&&a.fields.push("organizations"+JSON.stringify($.extend({},__APP.SERVER.validateData(e),{offset:this.organizations.length}))),SearchResults.fetchEventsAndOrganizations(i.query_string,a,function(t){i.setData(t),n&&"function"==typeof n&&n.call(i,t)})},Statistics.prototype.setData=function(t){return $.extend(!0,this,t instanceof Array?t[0]:t)},Statistics.SCALES={MINUTE:"minute",HOUR:"hour",DAY:"day",WEEK:"week",MONTH:"month",YEAR:"year",OVERALL:"overall"},Statistics.ENTITIES={EVENT:"events",ORGANIZATION:"organizations"},Statistics.fetchStatistics=function(t,e,n,i,a,o,s){var r={scale:n,fields:[]};switch(a instanceof Array?r.fields=r.fields.concat(a):$.each(a,function(t,e){Object.getOwnPropertyNames(e).length?r.fields.push(t+JSON.stringify(e)):r.fields.push(t)}),o&&r.fields.push("dynamics"+JSON.stringify(__APP.SERVER.validateData(o))),typeof i){case"string":i&&(r.since=i);break;case"object":i.since&&(r.since=i.since),i.till&&(r.till=i.till);break;default:case"boolean":}return __APP.SERVER.getData("/api/v1/statistics/"+t+"/"+e,r,s)},Statistics.prototype.fetchStatistics=function(t,e,n,i,a){var o=this;return this.constructor.fetchStatistics(this.id,t,e,n,i,function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,t)})},EventStatistics.extend(Statistics),EventStatistics.fetchStatistics=function(t,e,n,i,a,o){return Statistics.fetchStatistics(Statistics.ENTITIES.EVENT,t,e,n,i,a,o)},OrganizationsStatistics.extend(Statistics),OrganizationsStatistics.fetchStatistics=function(t,e,n,i,a,o){return Statistics.fetchStatistics(Statistics.ENTITIES.ORGANIZATION,t,e,n,i,a,o)},OneUser.extend(OneEntity),OneUser.ACCOUNTS={VK:"vk",FACEBOOK:"facebook",GOOGLE:"google"},OneUser.ROLE={UNAUTH:"unauth",USER:"user",MODERATOR:"moderator",ADMIN:"admin"},Object.defineProperty(OneUser.prototype,"subscriptions_fields",{enumerable:!1,value:["img_small_url","subscribed_count","new_events_count","actual_events_count"]}),OneUser.recognizeRole=function(t){var e=OneUser.ROLE.USER;return t.forEach(function(t){1!=t.role_id&&t.name!=OneUser.ROLE.ADMIN||(e=OneUser.ROLE.ADMIN),2!=t.role_id&&t.name!=OneUser.ROLE.MODERATOR||e===OneUser.ROLE.ADMIN||(e=OneUser.ROLE.MODERATOR)}),e?e:OneUser.ROLE.UNAUTH},OneUser.fetchUser=function(t,e,n){return __APP.SERVER.getData("/api/v1/users/"+t,e||Array.isArray(e)&&e.length?{fields:e}:{},n)},OneUser.prototype.fetchUser=function(t,e){var n=this;return OneUser.fetchUser(n.id,t,function(t){n.setData(t),e&&"function"==typeof e&&e.call(n,t[0])})},OneUser.prototype.fetchUserWithSubscriptions=function(t,e,n){var i=this;return t="string"==typeof t?t.split(","):t?t:[],e?(e.fields=e.fields.join(","),t.push("subscriptions"+JSON.stringify($.extend({},e,{offset:i.subscriptions.length})))):t.push("subscriptions"+JSON.stringify({fields:i.subscriptions_fields.join(","),offset:i.subscriptions.length})),OneUser.fetchUser(i.id,t,function(t){i.setData(t),n&&"function"==typeof n&&n.call(i,t[0])})},CurrentUser.extend(OneUser),CurrentUser.prototype.logout=function(){return $.ajax({url:"/index.php",data:{logout:!0},complete:function(){
window.location="/"}})},CurrentUser.prototype.subscribeToOrganization=function(t,e){var n=this;return n.subscriptions.has(t)?(console.warn("Current user is already subscribed to this organization"),null):(OneOrganization.fetchOrganization(t,n.subscriptions_fields,function(t){n.subscriptions.push(t[0]),e&&"function"==typeof e&&e.call(n,t)}),OneOrganization.subscribeOrganization(t))},CurrentUser.prototype.unsubscribeFromOrganization=function(t,e){var n=this;return n.subscriptions.has(t)?OneOrganization.unsubscribeOrganization(t,function(){n.subscriptions.remove(t),e&&"function"==typeof e&&e.call(n,t)}):(console.warn("Current user isn`t subscribed to this organization"),null)},CurrentUser.prototype.fetchUserWithSubscriptions=function(t,e,n){var i=this;return e=$.extend({fields:i.subscriptions_fields},e,{offset:i.subscriptions.length}),OneUser.fetchUser(i.id,t,function(t){t=t[0],OrganizationsCollection.fetchSubscribedOrganizations(e,function(e){t.subscriptions=e,i.setData(t),n&&"function"==typeof n&&n.call(i,t)})})},UsersCollection.extend(EntitiesCollection),UsersCollection.prototype.collection_of=OneUser,UsersCollection.getSpecificStaff=function(t,e,n){var i=[];return e.forEach(function(e){e.role==t&&i.push($.extend(!0,{name:e.first_name+" "+e.last_name},e,n))}),i},UsersCollection.fetchUsers=function(t,e){return __APP.SERVER.getData("/api/v1/users/",t,e)},UsersCollection.fetchFriends=function(t,e){return __APP.SERVER.getData("/api/v1/users/friends/",t,e)},UsersCollection.fetchEventFavorites=function(t,e,n){return __APP.SERVER.getData("/api/v1/events/"+t,{fields:"favored".appendAjaxData(__APP.SERVER.validateData(e))},function(t){e.length&&e.offset&&(e.offset+=e.length),n&&"function"==typeof n&&n(t[0].favored)})},UsersCollection.fetchOrganizationSubscribers=function(t,e,n){return __APP.SERVER.getData("/api/v1/organizations/"+t,{fields:"subscribed".appendAjaxData(__APP.SERVER.validateData(e))},function(t){e.length&&e.offset&&(e.offset+=e.length),n&&"function"==typeof n&&n(t[0].subscribed)})},UsersCollection.fetchOrganizationStaff=function(t,e,n){return __APP.SERVER.getData("/api/v1/organizations/"+t+"/staff/",e,n)},UsersCollection.prototype.getSpecificStaff=function(t,e){var n=[];return this.forEach(function(i){i.role==t&&n.push($.extend(!0,{name:i.first_name+" "+i.last_name},i,e))}),n},UsersCollection.prototype.fetchUsers=function(t,e,n){var i=this,a=$.extend(t,{offset:this.length,length:e});return UsersCollection.fetchUsers(a,function(t){i.setData(t),n&&"function"==typeof n&&n.call(i,t)})},UsersCollection.prototype.fetchFriends=function(t,e,n,i){var a=this,o={fields:t,offset:this.length,length:e};return n&&(o.order_by=n),UsersCollection.fetchFriends(o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},UsersCollection.prototype.fetchEventFavorites=function(t,e,n,i){var a=this,o=$.extend({},n,{offset:this.length,length:e});return UsersCollection.fetchEventFavorites(t,o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},UsersCollection.prototype.fetchOrganizationSubscribers=function(t,e,n,i){var a=this,o=$.extend({},n,{offset:this.length,length:e});return this.constructor.fetchOrganizationSubscribers(t,o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},UsersCollection.prototype.fetchOrganizationStaff=function(t,e,n,i){var a=this,o=$.extend({},n,{offset:this.length,length:e});return UsersCollection.fetchOrganizationStaff(t,o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},OneTag.extend(OneEntity),OneTag.fetchTag=function(t,e){return __APP.SERVER.getData("/api/v1/tags/"+t,{},e)},OneTag.prototype.fetchTag=function(t){var e=this;return this.constructor.fetchTag(e.id,function(n){e.setData(n[0]),t&&"function"==typeof t&&t.call(e,n[0])})},TagsCollection.extend(EntitiesCollection),TagsCollection.prototype.collection_of=OneTag,TagsCollection.fetchTags=function(t,e){return __APP.SERVER.getData("/api/v1/tags/",t,e)},TagsCollection.prototype.fetchTags=function(t,e){var n=this;return this.constructor.fetchTags(t,function(t){n.setData(t),e&&"function"==typeof e&&e.call(n,t)})},Calendar.SELECTION_TYPES={SINGLE:"single",MULTI:"multi"},Calendar.prototype.setMonth=function(t,e){switch(t){case"prev":this.current_month=this.current_month.add(-1,"months");break;case"next":this.current_month=this.current_month.add(1,"months");break;case"current":this.current_month=moment(new Date);break;default:this.current_month=e?this.current_month.set({year:e,month:t-1}):this.current_month.month(t-1)}return this.renderTable(),this.$calendar.trigger("month-changed"),this},Calendar.prototype.destroyTable=function(){return this.$calendar.find("."+this.options.classes.th_class).removeClass(__C.CLASSES.NEW_ACTIVE).off("click"),this.$calendar.find(".MonthName").removeClass(__C.CLASSES.NEW_ACTIVE).off("click"),this.$calendar.find(".CalendarTableBody").remove(),this},Calendar.prototype.setMonthName=function(){return this.$calendar.find(".MonthName").data("month",this.current_month.month()).text(this.current_month.format("MMMM YYYY").capitalize()),this},Calendar.prototype.buildTable=function(){var t,e,n=this.$calendar.find(".CalendarTable"),i=this.current_month.daysInMonth(),a=this.current_month.date(1).day(),o=this.current_month.date(i).day(),s=[],r=[],d=[];for(var l in this.options.additional_dataset)this.options.additional_dataset.hasOwnProperty(l)&&d.push("data-"+l+"="+this.options.additional_dataset[l]);for(var c=1;c<=i;c++)this.current_month.date(c),t=this.current_month.format(__C.DATE_FORMAT),e=moment(t),r=[this.options.classes.table_cell_class,this.options.classes.td_class,"Day_"+t,"DayOfWeek_"+this.current_month.day(),"DayOfMonth_"+this.current_month.month()].concat(this.options.classes.td_additional_classes),(this.options.min_date===!1||e.diff(this.options.min_date,"d")>=0)&&(this.options.max_date===!1||e.diff(this.options.max_date,"d")<=0)||r.push(this.options.classes.td_disabled_class),this.current_month.format(__C.DATE_FORMAT)==this._today.format(__C.DATE_FORMAT)&&r.push(this.options.classes.today_class),s.push(tmpl("calendar-div",{td_classes:r.join(" "),number:this.current_month.date(),day_number:this.current_month.day(),date:this.current_month.format(__C.DATE_FORMAT),date_text:this.current_month.format("DD MMMM YYYY"),dataset:d.join(" ")}));var u=this.current_month.clone();if(1!=a){u.add(-1,"months"),u.date(u.daysInMonth());do t=u.format(__C.DATE_FORMAT),e=moment(t),r=[this.options.classes.table_cell_class,this.options.classes.td_class,"Day_"+t,"DayOfWeek_"+u.day(),"DayOfMonth_"+u.month(),"not_this_month"].concat(this.options.classes.td_additional_classes),(this.options.min_date===!1||e.diff(this.options.min_date,"d")>=0)&&(this.options.max_date===!1||e.diff(this.options.max_date,"d")<=0)||r.push(this.options.classes.td_disabled_class),s.unshift(tmpl("calendar-div",{td_classes:r.join(" "),number:u.date(),day_number:u.day(),date:u.format(__C.DATE_FORMAT),date_text:u.format("DD MMMM YYYY"),dataset:d.join(" ")})),u.add(-1,"days");while(0!=u.day())}if(0!=o){u=this.current_month.clone();do u.add(1,"days"),t=u.format(__C.DATE_FORMAT),e=moment(t),r=[this.options.classes.table_cell_class,this.options.classes.td_class,"Day_"+t,"DayOfWeek_"+u.day(),"DayOfMonth_"+u.month(),"not_this_month"].concat(this.options.classes.td_additional_classes),(this.options.min_date===!1||e.diff(this.options.min_date,"d")>=0)&&(this.options.max_date===!1||e.diff(this.options.max_date,"d")<=0)||r.push(this.options.classes.td_disabled_class),s.push(tmpl("calendar-div",{td_classes:r.join(" "),number:u.date(),day_number:u.day(),date:u.format(__C.DATE_FORMAT),date_text:u.format("DD MMMM YYYY"),dataset:d.join(" ")}));while(0!=u.day())}for(var _=$("<tbody>").addClass("CalendarTableBody"),f=0,p=0,h=[tmpl("calendar-row",{tr_class:this.options.classes.tr_class})],g=0;g<s.length;g++)7==f&&(h.push(tmpl("calendar-row",{tr_class:this.options.classes.tr_class})),f=0,p++),h[p].append(s[g]),f++;return h.forEach(function(t){_.append(t)}),n.append(_),this},Calendar.prototype.renderTable=function(){if(this.destroyTable().buildTable().activateSelectedDays().setMonthName(),!this.options.disable_selection){switch(this.options.selection_type){case Calendar.SELECTION_TYPES.MULTI:this.bindDragSelection();break;case Calendar.SELECTION_TYPES.SINGLE:this.bindDaySelection()}this.options.weekday_selection===!0&&this.bindWeekdaySelection(),this.options.month_selection===!0&&this.bindMonthSelection()}return this},Calendar.prototype.selectToday=function(){return this.$calendar.find("."+this.options.classes.td_class+"."+this.options.classes.today_class).addClass(__C.CLASSES.NEW_ACTIVE),this},Calendar.prototype.formatDays=function(){var t={"январь":"января","февраль":"февраля","март":"марта","апрель":"апреля","май":"мая","июнь":"июня","июль":"июля","август":"августа","сентябрь":"сентября","октябрь":"октября","ноябрь":"ноября","декабрь":"декабря"},e=moment(this.now_selected_day),n=e.month(),i=e.month(n),a=i.daysInMonth(),o=i.date(1);for("undefined"==typeof this.formatted_days[n]&&(this.formatted_days[n]={},this.formatted_days[n].selected_days=[],this.formatted_days[n].month_name=t[e.format("MMMM")]),this.formatted_days[n].selected_days.push(e.format(__C.DATE_FORMAT)),this.formatted_days[n].text="";a;)console.log(this.formatted_days[n].selected_days),this.formatted_days[n].selected_days.indexOf(o.format(__C.DATE_FORMAT))!==-1&&(this.formatted_days[n].text+=""+o.format("D")),o=o.add(1,"d"),a--;return console.log(this.formatted_days[n].text),this},Calendar.prototype.selectDays=function(t){function e(t){switch(n.options.selection_type){case Calendar.SELECTION_TYPES.MULTI:n.selected_days.indexOf(t)===-1&&(n.selected_days.push(t),n.selected_days.sort());break;default:case Calendar.SELECTION_TYPES.SINGLE:n.$calendar.find("."+n.options.classes.td_class+"."+__C.CLASSES.NEW_ACTIVE).removeClass(__C.CLASSES.NEW_ACTIVE),n.selected_days=[t]}n.$calendar.find(".Day_"+t).addClass(__C.CLASSES.NEW_ACTIVE)}var n=this;if(Array.isArray(t)){var i=[];t.forEach(function(t){(n.options.min_date===!1||moment(t).diff(n.options.min_date)>=0)&&(n.options.max_date===!1||moment(t).diff(n.options.max_date)<=0)?e(t):i.push(t)}),i.forEach(function(e){t.splice(t.indexOf(e),1)})}else(n.options.min_date===!1||moment(t).diff(n.options.min_date)>=0)&&(n.options.max_date===!1||moment(t).diff(n.options.max_date)<=0)?(e(t),t=[t]):t=[];return t.length&&(n.last_action="select",n.last_selected_days=t,n.$calendar.trigger("days-changed")),this},Calendar.prototype.deselectDays=function(t){function e(t){var e,i=n.$calendar.find(".Day_"+t),a=n.$calendar.find(".Week_"+i.data("weekday")),o=n.$calendar.find(".MonthName"),s=n.current_month.format("YYYY"),r=n.current_month.format("MM"),d=n.current_month.format("YYYY.MM");n.selected_days.splice(n.selected_days.indexOf(t),1),n.selected_days.sort(),n.selected_months.indexOf(d)!==-1&&(o.removeClass(__C.CLASSES.NEW_ACTIVE),n.selected_months.splice(n.selected_months.indexOf(d),1)),"undefined"!=typeof n.selected_weeks[s]&&"undefined"!=typeof n.selected_weeks[s][r]&&(e=n.selected_weeks[s][r].indexOf(i.data("weekday")),e!==-1&&(a.removeClass(__C.CLASSES.NEW_ACTIVE),n.selected_weeks[s][r].splice(e,1))),n.$calendar.find(".Day_"+t).removeClass(__C.CLASSES.NEW_ACTIVE)}var n=this;return this.options.selection_type===Calendar.SELECTION_TYPES.MULTI&&(Array.isArray(t)?t.forEach(function(t){e(t)}):e(t),n.last_action="deselect",n.last_selected_days=t,n.$calendar.trigger("days-changed")),this},Calendar.prototype.selectWeek=function(t){var e,n=this,i=n.$calendar.find(".Week_"+t),a=n.$calendar.find(".DayOfWeek_"+t).not(".not_this_month"),o=n.current_month.format("YYYY"),s=n.current_month.format("MM"),r=[];return a.each(function(t){r.push(a.eq(t).data("date"))}),"undefined"==typeof n.selected_weeks[o]&&(n.selected_weeks[o]={}),"undefined"==typeof n.selected_weeks[o][s]&&(n.selected_weeks[o][s]=[]),e=n.selected_weeks[o][s].indexOf(t),e===-1?(i.addClass(__C.CLASSES.NEW_ACTIVE),n.selectDays(r),n.selected_weeks[o][s].push(t)):(i.removeClass(__C.CLASSES.NEW_ACTIVE),n.deselectDays(r),n.selected_weeks[o][s].splice(e,1)),this},Calendar.prototype.selectMonth=function(t){var e=this,n=e.$calendar.find(".MonthName"),i=e.$calendar.find(".DayOfMonth_"+t),a=e.current_month.format("YYYY.MM"),o=e.selected_months.indexOf(a),s=[];return i.each(function(t){s.push(i.eq(t).data("date"))}),o===-1?(n.addClass(__C.CLASSES.NEW_ACTIVE),e.selectDays(s),e.selected_months.push(a)):(n.removeClass(__C.CLASSES.NEW_ACTIVE),e.deselectDays(s),e.selected_months.splice(o,1)),this},Calendar.prototype.bindMonthArrows=function(){var t=this;return this.$calendar.find(".NextMonth").on("click",function(){t.setMonth("next")}),this.$calendar.find(".PrevMonth").on("click",function(){t.setMonth("prev")}),this},Calendar.prototype.bindDaySelection=function(){var t=this,e=t.$calendar.find("."+this.options.classes.td_class),n=e.not("."+this.options.classes.td_disabled_class);return e.off("click.bindDaySelection"),n.on("click.bindDaySelection",function(){t.options.selection_type===Calendar.SELECTION_TYPES.MULTI&&$(this).hasClass(__C.CLASSES.NEW_ACTIVE)?t.deselectDays($(this).data("date")):t.selectDays($(this).data("date"))}),this},Calendar.prototype.bindWeekdaySelection=function(){var t=this,e=t.$calendar.find("."+this.options.classes.th_class);return e.on("click",function(){t.selectWeek($(this).data("weekday"))}),this},Calendar.prototype.bindMonthSelection=function(){var t=this,e=t.$calendar.find(".MonthName");return e.on("click",function(){t.selectMonth($(this).data("month"))}),this},Calendar.prototype.bindDragSelection=function(){function t(t){t=t.is("."+n.options.classes.td_class)?t:t.closest("."+n.options.classes.td_class),t.not("."+n.options.classes.td_disabled_class).length&&(t.hasClass(__C.CLASSES.NEW_ACTIVE)?n.deselectDays(t.data("date")):n.selectDays(t.data("date")))}function e(){n.$calendar.find("."+n.options.classes.td_class).off("mouseenter.DragSelection")}var n=this;return n.$calendar.off("mousedown.RangeSelection").on("mousedown.RangeSelection",function(e){t($(e.target)),n.$calendar.find("."+n.options.classes.td_class).not("."+n.options.classes.td_disabled_class).on("mouseenter.DragSelection",function(e){e.preventDefault(),t($(e.target))})}).on("mouseup",e).on("mouseleave",e),this};Calendar.prototype.activateSelectedDays=function(){var t=this,e=t.current_month.format("YYYY"),n=t.current_month.format("MM");return t.selected_days.forEach(function(e){t.$calendar.find(".Day_"+e).addClass(__C.CLASSES.NEW_ACTIVE)}),t.selected_months.indexOf(e+"."+n)!==-1&&t.$calendar.find(".MonthName").addClass(__C.CLASSES.NEW_ACTIVE),"undefined"!=typeof t.selected_weeks[e]&&"undefined"!=typeof t.selected_weeks[e][n]&&t.selected_weeks[e][n].forEach(function(e){t.$calendar.find(".Week_"+e).addClass(__C.CLASSES.NEW_ACTIVE)}),this};Calendar.prototype.setDaysWithEvents=function(){var t=this,e={since:t.current_month.startOf("month").format(__C.DATE_FORMAT),till:t.current_month.endOf("month").format(__C.DATE_FORMAT),length:500,my:!0,unique:!0};return t.$calendar.find(".feed_calendar_td").removeClass("Controller has_favorites").addClass(__C.CLASSES.NEW_DISABLED),DatesCollection.fetchDates(e,function(e){e.forEach(function(e){var n=t.$calendar.find(".Day_"+moment.unix(e.event_date).format(__C.DATE_FORMAT));n.html(tmpl("link",{title:n.children().text(),classes:n.children().get(0).classList,page:"/feed/day/"+n.data("date")})).addClass(e.favorites_count>0?"has_favorites":"").removeClass(__C.CLASSES.NEW_DISABLED)}),t.bindDaySelection(),bindPageLinks(t.$calendar)}),this},Calendar.prototype.init=function(){return this.$calendar.empty().append(tmpl("calendar",this.options.classes)),this.options.weekday_selection&&this.$calendar.addClass("-weekday_selection"),this.options.month_selection&&this.$calendar.addClass("-month_selection"),this.$calendar.data("calendar",this),this.$calendar.data("days",this.selected_days),this.$calendar.data("options",this.options),this.bindMonthArrows().renderTable(),this},DatePicker.prototype.init=function(){return this.bindOpener().$datepicker.data("datepicker",this),this.$datepicker.addClass("-unselectable -Handled_DatePicker"),this},DatePicker.prototype.bindOpener=function(){function t(){e.$input.is(":disabled")?e.$datepicker.one("click",t):e.openDialog()}var e=this;return this.$datepicker.one("click",t),this},DatePicker.prototype.openDialog=function(){var t=this;return this.$datepicker.after(tmpl("datepicker",{})),this.$datepicker_modal=this.$datepicker.siblings(".date_picker"),this.calendar=new Calendar(this.$datepicker_modal.children(".DatePickerCalendar"),{min_date:this.options.min_date,max_date:this.options.max_date}),this.calendar.init(),this.calendar.$calendar.on("days-changed",function(){t.prev_selected_day=t.selected_day,t.selected_day=t.calendar.selected_days.toString(),t.formated_selected_day=t.calendar.selected_days.toString().split("-").reverse().join("."),t.$datepicker.is("input")||t.$datepicker.find("label").text(t.formated_selected_day),t.$input.val(t.selected_day).trigger("change"),t.options.close_on_pick&&t.destroy(),t.$datepicker.trigger("date-picked")}),this.bindCloseDialog(),this},DatePicker.prototype.bindCloseDialog=function(){var t=this;return $(document).off("click.checkOnClick").on("click.checkOnClick",function(e){t.checkOnClick(e)}).off("keydown.checkOnKeyDown").on("keydown.checkOnKeyDown",function(e){t.checkOnKeyDown(e)}),this},DatePicker.prototype.checkOnClick=function(t){var e=$(t.target);(0===e.closest(this.$datepicker_modal).length&&0===e.closest(this.$datepicker).length||e.closest(".SubmitDatePicker").length)&&this.destroy()},DatePicker.prototype.checkOnKeyDown=function(t){var e=this;9!==t.keyCode&&13!==t.keyCode&&27!==t.keyCode||e.destroy()},DatePicker.prototype.destroy=function(){return $(document).off("click.checkOnClick").off("keydown.checkOnKeyDown"),this.$datepicker_modal.remove(),delete this.calendar,this.bindOpener().$datepicker.data("datepicker",""),this},ActionButton.extend(jQuery),ActionButton.prototype.states=["subscribe","unsubscribe","subscribed"],ActionButton.prototype.pushStack=function(t){var e=jQuery.merge(this.get(0)==t?new this.constructor(this.id,this.is_subscribed,this.options):$(),t);return e.prevObject=this,e.context=this.context,e},ActionButton.prototype.addAvatar=function(){var t=this.closest(".AddAvatarWrapper"),e=t.find(".AvatarsCollection"),n=t.find(".FavoredCount"),i=e.find(".avatar"),a=i.length;if(e.data("max_amount")>=a)e.hasClass("-subscribed")?(e.removeClass("-subscribed"),e.width(1==a?0:i.outerWidth()*(a-1)-6*(a-2))):(e.addClass("-subscribed"),e.width(i.outerWidth()*a-6*(a-1)));else{if(n.length){var o=parseInt(n.text());e.hasClass("-subscribed")?(n.text(o-1),o-1<=0&&n.parent().addClass("-cast")):(n.text(o+1),n.parent().removeClass("-cast"))}e.toggleClass("-shift -subscribed")}},ActionButton.prototype.bindHoverEffects=function(){var t=this;this.off("mouseenter.hoverSubscribed mouseleave.hoverSubscribed").on("mouseenter.hoverSubscribed",function(){t.removeClass(t.classes.subscribed).addClass(t.classes.unsubscribe),t.children(".Text").text(t.options.labels.unsubscribe)}).on("mouseleave.hoverSubscribed",function(){t.removeClass(t.classes.unsubscribe).addClass(t.classes.subscribed),t.children(".Text").text(t.options.labels.subscribed)})},ActionButton.prototype.onClick=function(){},ActionButton.prototype.bindClick=function(){var t=this;this.on("click.subscribe",function(){__APP.USER.id===-1?(new AuthModal).show():(t.onClick(),t.is_add_avatar&&t.addAvatar(),window.askToSubscribe instanceof Function&&window.askToSubscribe())})},ActionButton.prototype.afterSubscribe=function(){this.removeClass([this.classes.subscribe,this.classes.subscribed].join(" ")),this.addClass([this.classes.subscribed_state,this.classes.unsubscribe].join(" ")),this.children(".Text").text(this.options.labels.unsubscribe),this.is_subscribed=!0,this.bindHoverEffects()},ActionButton.prototype.afterUnsubscribe=function(){this.removeClass([this.classes.subscribed_state,this.classes.unsubscribe,this.classes.subscribed].join(" ")),this.addClass(this.classes.subscribe),this.children(".Text").text(this.options.labels.subscribe),this.is_subscribed=!1,this.off("mouseenter.hoverSubscribed mouseleave.hoverSubscribed")},ActionButton.prototype.initiate=function(){this.is_subscribed&&this.bindHoverEffects(),this.bindClick()},AddToFavoriteButton.extend(ActionButton),AddToFavoriteButton.prototype.onClick=function(){var t=this;t.is_subscribed?OneEvent.deleteFavored(t.id,function(){t.afterUnsubscribe()}):OneEvent.addFavored(t.id,function(){t.afterSubscribe()})},SubscribeButton.extend(ActionButton),SubscribeButton.prototype.onClick=function(){var t=this;t.is_subscribed?__APP.USER.unsubscribeFromOrganization(t.id,function(){t.afterUnsubscribe(),$(window).trigger("unsubscribe",[t.id])}):__APP.USER.subscribeToOrganization(t.id,function(){t.afterSubscribe(),$(window).trigger("subscribe",[t.id])})},AbstractModal=function(){function t(t){this.id=0,this.title=t.title,this.type=t.type?t.type:"Std",this.content=t.content,this.modal=__APP.BUILD.modal(t),__APP.MODALS.pushModal(this)}return t.prototype.__show=function(){var t=this;__APP.MODALS.modal_wrapper.append(this.modal),$("body").addClass("-open_modal"),__APP.MODALS.hideCurrent(),__APP.MODALS.active_modal=this,this.modal.addClass("-faded").removeClass(__C.CLASSES.NEW_HIDDEN),__APP.MODALS.modal_destroyer.adjustHeight(this.modal.height()),this.modal.trigger("modal.show"),setTimeout(function(){t.modal.removeClass("-faded")},200),__APP.MODALS.modal_destroyer.off("click.CloseModal").on("click.CloseModal",function(){$(this).off("click.CloseModal"),__APP.MODALS.hideCurrent()}),this.modal.find(".CloseModal").off("click.CloseModal").on("click.CloseModal",function(){__APP.MODALS.hideCurrent()}),$(document).off("keyup.CloseModal").on("keyup.CloseModal",function(t){27==t.keyCode&&($(this).off("keyup.CloseModal"),__APP.MODALS.hideCurrent())})},t.prototype.__hide=function(){var t=this;__APP.MODALS.modal_destroyer.off("click.CloseModal"),$(document).off("keyup.CloseModal"),__APP.MODALS.active_modal=void 0,this.modal.find(".CloseModal").off("click.CloseModal"),this.modal.addClass("-faded"),setTimeout(function(){t.modal.addClass(__C.CLASSES.NEW_HIDDEN),t.modal.trigger("modal.close")},200)},t.prototype.show=function(){this.__show()},t.prototype.hide=function(){this.__hide()},t.prototype.destroy=function(){this.hide(),__APP.MODALS.modal_wrapper.trigger("modal.beforeDestroy"),this.modal.remove();for(var t in __APP.MODALS.collection)__APP.MODALS.collection[t]==this&&delete __APP.MODALS.collection[t];__APP.MODALS.modal_wrapper.trigger("modal.afterDestroy")},t}(),AbstractUsersModal=extending(AbstractModal,function(){function t(e,n){if(AbstractModal.call(this,{content:"",title:n,type:this.constructor.name,content_classes:["ModalContent"]}),this.entity_id=e,this.entities_length=30,this.disable_upload=!1,this.users=new UsersCollection,this.is_first=!0,this.content=this.modal.find(".ModalContent"),this.constructor===t)throw new Error("Can't instantiate abstract class!")}return t.prototype.show=function(){var t=this;__APP.MODALS.modal_wrapper.data("block_scroll",!1),__APP.MODALS.modal_wrapper.on("scroll.uploadUsers",function(){t.disable_upload||__APP.MODALS.modal_wrapper.height()+__APP.MODALS.modal_wrapper.scrollTop()>=t.modal.height()&&(__APP.MODALS.modal_wrapper.data("block_scroll")||(__APP.MODALS.modal_wrapper.data("block_scroll",!0),t.uploadUsers(function(){__APP.MODALS.modal_wrapper.data("block_scroll",!1),__APP.MODALS.modal_destroyer.adjustHeight(t.modal.height())})))}),this.users.length?AbstractModal.prototype.show.call(t):t.uploadUsers(function(){AbstractModal.prototype.show.call(t)})},t.prototype.hide=function(){__APP.MODALS.modal_wrapper.data("block_scroll",!1).off("scroll.uploadUsers"),__APP.MODALS.hideCurrent()},t.prototype.uploadUsers=function(t){},t.prototype.buildUsers=function(t,e){var n=$(),i=!1,a=this;return"undefined"!=typeof e&&(i="true"==e.find(".UserTombstone").eq(-1).data("is_friend")),t.forEach(function(t,e){(a.is_first&&!e||i!=t.is_friend)&&(n=n.add(tmpl("modal-users-divider",{label:t.is_friend?"Друзья":"Все"})),i=t.is_friend),n=n.add(__APP.BUILD.userTombstones(t,{tombstone_classes:["UserTombstone"],is_link:!0,dataset:{is_friend:t.is_friend}}))}),e.append(n),n},t.prototype.afterUpload=function(t){var e,n=this;t.length?(e=this.buildUsers(t,this.content),this.content.append(e),this.is_first=!1,this.entities_length=10,__APP.MODALS.modal_destroyer.adjustHeight(this.modal.height()),bindPageLinks(this.modal),e.on("click.hideModal",function(){n.hide()})):this.disable_upload=!0},t}()),AuthModal=extending(AbstractModal,function(){function t(){return"object"==typeof t.instance?t.instance:(AbstractModal.call(this,{type:"AuthModal",content:tmpl("modal-auth-content",{heading:"Войдите через социальную сеть, чтобы совершить это действие"}),classes:["-size_tiny"],content_classes:["-align_center"]}),this.modal.find(".AuthButton").each(function(){$(this).on("click",function(t){var e=$(this).data("auth_network");yaCounter32442130.reachGoal(e.toUpperCase()+"AuthStart"),isNotDesktop()?window.location.href=__APP.AUTH_URLS[e]:window.open(__APP.AUTH_URLS[e],e.toUpperCase()+"_AUTH_WINDOW","status=1,toolbar=0,menubar=0&height=500,width=700"),t.preventDefault()})}),bindRippleEffect(this.modal),void(t.instance=this))}return t}()),CropperModal=extending(AbstractModal,function(){function t(t,e){if(!t)throw Error("To initiate cropper you need to pass image source (image_src)");e="object"==typeof e?e:{},AbstractModal.call(this,{content:tmpl("modal-cropper-content",{image_src:this.image_src}),type:"CropperModal",classes:["-size_wide"],content_classes:["-no_padding","img_holder"],footer:tmpl("modal-footer",{footer_buttons:$().add(tmpl("button",{classes:"-color_primary CropButton RippleEffect",title:"Кадрировать"})).add(tmpl("button",{classes:"-color_default DestroyCropButton RippleEffect",title:"Отмена"}))})}),this.image_src=t,this.cropper=this.modal.find(".Cropper"),this.crop_button=this.modal.find(".CropButton"),this.destroy_crop_button=this.modal.find(".DestroyCropButton"),this.options=$.extend({viewMode:1,responsive:!1,scalable:!1,zoomable:!1,zoomOnWheel:!1},e)}return t.prototype.show=function(){var t=this;t.cropper.on("load",function(){t.cropper.cropper(t.options)}).attr("src",t.image_src),t.__show(),t.modal.on("modal.beforeDestroy",function(){t.cropper.cropper("destroy"),t.crop_button.off("click.Crop"),t.destroy_crop_button.off("click.DestroyCrop")}),t.crop_button.off("click.Crop").on("click.Crop",function(){t.crop(),__APP.MODALS.hideCurrent()}),t.destroy_crop_button.off("click.DestroyCrop").on("click.DestroyCrop",function(){__APP.MODALS.hideCurrent()})},t.prototype.crop=function(){var t=this;t.initer.trigger("crop",[t.cropper.cropper("getCroppedCanvas").toDataURL(),t.cropper.cropper("getData")])},t}()),EditorsModal=extending(AbstractUsersModal,function(){function t(t,e,n){AbstractUsersModal.apply(this,[t,e?e:"Редакторы"]),this.ajax_data={order_by:"role,first_name"},n&&(this.ajax_data.roles=n)}return t.prototype.uploadUsers=function(t){var e=this;this.users.fetchOrganizationStaff(this.entity_id,this.entities_length,this.ajax_data,function(n){e.afterUpload(n),t&&"function"==typeof t&&t(n)})},t.prototype.buildUsers=function(t,e){var n=$(),i=!1,a={admin:"Администраторы",moderator:"Модераторы"},o=this;return"undefined"!=typeof e&&(i=e.find(".UserTombstone").last().data("role")),t.forEach(function(t,e){(o.is_first&&!e||i!=t.role)&&(n=n.add(tmpl("modal-users-divider",{label:a[t.role]})),i=t.role),n=n.add(__APP.BUILD.userTombstones(t,{tombstone_classes:["UserTombstone"],is_link:!0,dataset:{role:t.role}}))}),e.append(n),n},t}()),FavoredModal=extending(AbstractUsersModal,function(){function t(t,e){if(!t)throw Error("To open favored modal you need to pass event_id");AbstractUsersModal.apply(this,[t,e?e:"Добавили в избранное"]),this.ajax_data={fields:["is_friend"],order_by:"-is_friend,first_name"}}return t.prototype.uploadUsers=function(t){var e=this;this.users.fetchEventFavorites(this.entity_id,this.entities_length,this.ajax_data,function(n){e.afterUpload(n),t&&"function"==typeof t&&t(n)})},t}()),MapModal=extending(AbstractModal,function(){function t(t,e){if(!t)throw Error("To initiate map you need to pass location (location)");AbstractModal.call(this,{content:tmpl("modal-map-content",{location:t}),type:"MapModal",classes:["-size_wide"],content_classes:["-no_padding"]}),this.location=t}return t}()),MediaModal=extending(AbstractModal,function(){function t(t,e){if(!t)throw Error("To open media you need to pass media source (src)");"image"==e&&(this.content=tmpl("modal-image-media-content",{src:t})),AbstractModal.call(this,{content:this.content,type:"MediaModal",classes:["-size_responsive"],content_classes:["img_holder","-no_padding","ModalContent"]}),this.src=t,this.format=e?e:"image",this.modal.on("modal.show",function(){__APP.MODALS.modal_wrapper.addClass("-blackened")}),this.modal.on("modal.close",function(){__APP.MODALS.modal_wrapper.removeClass("-blackened")})}return t.prototype.show=function(){var t=this;t.modal.find("img").on("load",function(){__APP.MODALS.modal_destroyer.adjustHeight(t.modal.height())}),t.__show()},t}()),StdModal=extending(AbstractModal,function(){function t(t,e){AbstractModal.call(this,{content:e,title:t,type:"",content_classes:[],footer:__APP.BUILD.button({classes:["-color_primary","CloseModal","RippleEffect"],title:"OK"})})}return t}()),SubscribersModal=extending(AbstractUsersModal,function(){function t(t,e){if(!t)throw Error("To open favored modal you need to pass organization_id");AbstractUsersModal.apply(this,[t,e?e:"Подписались"]),this.entity_id=t,this.ajax_data={fields:["is_friend"],order_by:"-is_friend,first_name"}}return t.prototype.uploadUsers=function(t){var e=this;this.users.fetchOrganizationSubscribers(this.entity_id,this.entities_length,this.ajax_data,function(n){e.afterUpload(n),t&&"function"==typeof t&&t(n)})},t}()),AbstractSidebar=function(){function t(){this.$sidebar=$("#main_sidebar"),this.$subscribed_orgs=$(".SidebarOrganizationsList")}return t.prototype.init=function(){this.$sidebar.find(".SidebarNav").addClass("-items_"+this.$sidebar.find(".SidebarNavItem").not(".-hidden").length),(window.innerHeight>800?this.$sidebar.find(".SidebarOrganizationsScroll"):this.$sidebar.find(".SidebarScroll")).scrollbar({disableBodyScroll:!0})},t.prototype.updateSubscriptions=function(){},t}(),Sidebar=extending(AbstractSidebar,function(){function t(){AbstractSidebar.call(this)}return t.prototype.init=function(){var t=this;t.updateSubscriptions(),$(window).on("subscribe unsubscribe",function(){t.updateSubscriptions()}),AbstractSidebar.prototype.init.call(this)},t.prototype.updateSubscriptions=function(){var t=this.$subscribed_orgs,e=0,n=$.map(t.children(),function(t){return $(t).data("organization_id")}),i=__APP.USER.subscriptions.filter(function(t){return n.indexOf(t.id)===-1}),a=n.filter(function(t){return!__APP.USER.subscriptions.has(t)});i.length&&(__APP.BUILD.organizationItems(i,{block_classes:["animated"],avatar_classes:["-size_30x30"]})[t.length?"prependTo":"appendTo"](t).each(function(t,n){setTimeout(function(){$(n).addClass("-show")},e+=100)}),bindPageLinks(t)),a.length&&a.forEach(function(e){var n=t.find('.organization_item[data-organization_id="'+e+'"]').removeClass("-show");setTimeout(function(){n.remove()},500)})},t}()),SidebarNoAuth=extending(AbstractSidebar,function(){function t(){AbstractSidebar.call(this)}return t.prototype.init=function(){this.$sidebar.find(".SidebarOrganizationsScroll").addClass(__C.CLASSES.NEW_HIDDEN),AbstractSidebar.prototype.init.call(this)},t}()),AbstractTopBar=function(){function t(){this.$main_header=$("#main_header")}return t.prototype.init=function(){this.$main_header.find("#search_bar_input").on("keypress",function(t){13==t.which&&__APP.changeState("/search/"+encodeURIComponent(this.value))}),bindRippleEffect(this.$main_header),bindPageLinks(this.$main_header)},t}(),TopBar=extending(AbstractTopBar,function(){function t(){
AbstractTopBar.call(this)}return t.prototype.init=function(){this.$main_header.find("#user_bar").on("click.openUserBar",function(){var t=$(this),e=$(document);t.addClass("-open"),e.on("click.closeUserBar",function(n){$(n.target).parents("#user_bar").length||(e.off("click.closeUserBar"),t.removeClass("-open"))})}),this.$main_header.find(".LogoutButton").on("click",__APP.USER.logout),this.$main_header.find(".OpenSettingsButton").on("click",showSettingsModal),AbstractTopBar.prototype.init.call(this)},t}()),TopBarNoAuth=extending(AbstractTopBar,function(){function t(){AbstractTopBar.call(this)}return t.prototype.init=function(){this.$main_header.find(".LoginButton").on("click",function(){(new AuthModal).show()}),AbstractTopBar.prototype.init.call(this)},t}()),Object.defineProperty(Page,"PAGES",{value:{add:{event:{to:{"^([0-9]+)":AddEventPage,"":AddEventPage},"":AddEventPage},organization:AddOrganizationPage},event:{add_to:{"^([0-9]+)":AddEventPage,"":AddEventPage},add:AddEventPage,"^([0-9]+)":{edit:RedactEventPage,"":OneEventPage},"":FeedPage},feed:{actual:ActualEventsPage,timeline:TimelineEventsPage,favored:FavoredEventsPage,recommendations:RecommendedEventsPage,friends:FriendsEventsPage,day:{"^([0-9]{4}-[0-9]{2}-[0-9]{2})":DayEventsPage},"":FeedPage},organizations:{"^([0-9]+)":CatalogPage,"":CatalogPage},organization:{add:AddOrganizationPage,"^([0-9]+)":{edit:EditOrganizationPage,"":OrganizationPage},"":CatalogPage},onboarding:OnboardingPage,search:{"^([^/]+)":SearchPage},friends:FriendsPage,friend:{"^([0-9]+)":OneFriendPage,"":FriendsPage},statistics:{organization:{"^([0-9]+)":{overview:StatisticsOrganizationOverviewPage,events:StatisticsOrganizationEventsPage,"":StatisticsOrganizationOverviewPage}},event:{"^([0-9]+)":StatisticsEventOverviewPage},"":StatisticsOverviewPage}}}),Page.routeNewPage=function(t){var e,n,i,a=decodeURIComponent(t).split("/").splice(1),o=Page.PAGES,s=[];for(e=0;e<a.length;e++)if(o.hasOwnProperty(a[e])){if(!(e<a.length-1)){i=o[a[e]];break}o=o[a[e]]}else for(n in o)if(0===n.indexOf("^")&&new RegExp(n).test(a[e])){s.push(a[e]),e<a.length-1?o=o[n]:i=o[n];break}return i=i?i:o,i=i.prototype instanceof Page?i:i[""],new(Function.prototype.bind.apply(i,[null].concat(s)))},Page.triggerRender=function(){$(window).trigger("page_load")},Page.prototype.show=function(){var t=this,e=$("#main_header"),n=__APP.PREVIOUS_PAGE.wrapper_tmpl!==t.wrapper_tmpl,i=n?"$view":"$wrapper",a=__APP.PREVIOUS_PAGE[i].length?__APP.PREVIOUS_PAGE[i]:n?$(".PageView"):$(".PageView").find(".Content"),o=$(window);t.page_title&&__APP.changeTitle(t.page_title),a.addClass("-faded"),__APP.CURRENT_JQXHR&&1==__APP.CURRENT_JQXHR.status&&__APP.CURRENT_JQXHR.abort(),o.on("page_render",function(){t.can_render&&!t.is_loading&&(o.off("page_render"),$(window).scrollTop(0),t.render(),bindPageLinks(),setTimeout(function(){t[i].removeClass("-faded")},200))}),o.one("page_load",function(){t.is_loading=!1,t.can_render&&o.trigger("page_render")}),setTimeout(function(){a.addClass(__C.CLASSES.NEW_HIDDEN),t.with_header_tabs?e.addClass("-with_tabs"):e.removeClass("-with_tabs"),$("body").removeClass(function(t,e){return(e.match(/(^|\s)-state_\S+/g)||[]).join(" ")}).addClass("-state_"+t.state_name.toUnderscore()),n&&t.$view.html(tmpl(t.wrapper_tmpl+"-wrapper",{})),t.$wrapper=t.$view.find(".Content"),t.$wrapper.empty(),t.$view.removeClass(__C.CLASSES.NEW_HIDDEN),t.$wrapper.removeClass(__C.CLASSES.NEW_HIDDEN),t[i].addClass("-faded"),t.can_render=!0,t.is_loading||o.trigger("page_render")},200)},Page.prototype.render=function(){},Page.prototype.destroy=function(){},StatisticsPage.extend(Page),StatisticsPage.prototype.areaChartSeriesNormalize=function(t){function e(t,e,n){return{name:a[e],data:t.map(function(t,e){return[moment.unix(t.time_value).valueOf(),t[n]]})}}var n={open_conversion:{with:"open_site",to:"view"},fave_conversion:{with:"fave",to:"open_site"},conversion:{with:"subscribe",to:"view"}},i={subscribe_unsubscribe:{subscribe:"subscribe",unsubscribe:"unsubscribe"}},a={notifications_sent:"Отправлено уведомлений",view:"Просмотры",view_detail:"Открытий страницы события из ленты Evendate",conversion:"Конверсия",subscribe:"Подписалось",unsubscribe:"Отписалось",open_site:"Открытий страницы события",open_conversion:"Конверсия просмотра события в ленте к открытию страницы события",fave:"Кол-во пользователей, которые добавили событие в избранное",fave_conversion:"Конверсия открытия страницы события к добавлениям в избранное"},o={showInLegend:!1,lineWidth:0,fillOpacity:0,states:{hover:{enabled:!1}}},s={};return $.each(t,function(t,a){s[t]=[],n.hasOwnProperty(t)?(s[t].push($.extend(!0,{tooltip:{valueSuffix:" %"}},e(a,t,"value"))),$.each(n[t],function(n,i){s[t].push($.extend(!0,{},o,e(a,i,n)))})):i.hasOwnProperty(t)?$.each(i[t],function(n,i){s[t].push(e(a,i,n))}):s[t].push(e(a,t,"value"))}),s},StatisticsPage.prototype.buildAreaCharts=function(t,e){var n=this,i=n.areaChartSeriesNormalize(t),a={notifications_sent:{title:"Отправлено уведомлений пользователям",wrapper_class:"NotificationsSentAreaChart"},view:{title:"Просмотры",wrapper_class:"ViewAreaChart"},view_detail:{title:"Открытий страницы события",wrapper_class:"ViewDetailAreaChart"},open_site:{title:"Открытий страницы события из ленты Evendate",wrapper_class:"OpenSiteAreaChart"},open_conversion:{title:"Конверсия просмотров/открытий",wrapper_class:"OpenConversionsAreaChart"},fave:{title:"Добавлений в избранное",wrapper_class:"FaveAreaChart"},fave_conversion:{title:"Конверсия открытий/добавлений в избранное",wrapper_class:"FaveConversionsAreaChart"},subscribe_unsubscribe:{title:"Подписчики",wrapper_class:"SubscriberAreaChart"},conversion:{title:"Конверсия просмотров/подписок",wrapper_class:"ConversionAreaChart"}},o=[["rgba(35, 215, 146, 0.18)","rgba(101, 101, 101, 0.6)","rgba(101, 101, 101, 0.6)"],["rgba(35, 215, 146, 0.09)","rgba(101, 101, 101, 0.6)","rgba(101, 101, 101, 0.6)"]],s=$.extend(!0,{},n.highchart_defaults,{chart:{type:"areaspline",plotBackgroundColor:"#fcfcfc",plotBorderColor:"#ebebeb",plotBorderWidth:1},colors:[__C.COLORS.FRANKLIN,__C.COLORS.MUTED_80,__C.COLORS.ACCENT,__C.COLORS.MUTED,__C.COLORS.MUTED_50,__C.COLORS.MUTED_30],title:{align:"left",margin:20},legend:{enabled:!0,align:"left",itemStyle:{color:__C.COLORS.TEXT,cursor:"pointer",fontSize:"14px",fontWeight:"500",y:0},itemMarginTop:24,itemMarginBottom:5,symbolHeight:18,symbolWidth:18,symbolRadius:9,itemDistance:42,x:30},plotOptions:{series:{states:{hover:{lineWidth:2}}},areaspline:{fillOpacity:.5,marker:{enabled:!1,symbol:"circle",radius:2,states:{hover:{enabled:!0}}},dataGrouping:{dateTimeLabelFormats:{millisecond:["%b %e, %H:%M:%S.%L","%b %e, %H:%M:%S.%L","-%H:%M:%S.%L"],second:["%b %e, %H:%M:%S","%b %e, %H:%M:%S","-%H:%M:%S"],minute:["%b %e, %H:%M","%b %e, %H:%M","-%H:%M"],hour:["%b %e, %H:%M","%b %e, %H:%M","-%H:%M"],day:["%b %e, %Y","%b %e","-%b %e, %Y"],week:["%b %e, %Y","%b %e","-%b %e, %Y"],month:["%B %Y","%B","-%B %Y"],year:["%Y","%Y","-%Y"]}}}},tooltip:{headerFormat:"<b>{point.key}</b><br/>",positioner:function(t,e){return{x:this.chart.plotLeft,y:this.chart.plotTop}},shadow:!1,shape:"square",valueDecimals:0,xDateFormat:"%e %b %Y",shared:!0},scrollbar:{enabled:!1},navigator:{outlineColor:"#ebebeb",outlineWidth:1,maskInside:!1,maskFill:"rgba(245, 245, 245, 0.66)",handles:{backgroundColor:"#9fa7b6",borderColor:"#fff"},xAxis:{gridLineWidth:0,labels:{align:"left",reserveSpace:!0,style:{color:"#888"},x:0,y:null}}},rangeSelector:{buttonTheme:{width:null,height:22,fill:"none",stroke:"none",r:14,style:{color:__C.COLORS.MUTED_80,fontSize:"13px",fontWeight:"400",textTransform:"uppercase",dominantBaseline:"middle"},states:{hover:{fill:__C.COLORS.MUTED_50,style:{color:"#fff"}},select:{fill:__C.COLORS.MUTED_80,style:{color:"#fff",fontWeight:"400"}}}},buttons:[{type:"day",count:7,text:"   Неделя   "},{type:"month",count:1,text:"   Месяц   "},{type:"year",count:1,text:"   Год   "},{type:"all",text:"   Все время   "}],allButtonsEnabled:!0,selected:2,labelStyle:{display:"none"},inputEnabled:!1},xAxis:{gridLineWidth:1,gridLineDashStyle:"dash",type:"datetime",showEmpty:!1,tickPosition:"inside",dateTimeLabelFormats:{minute:"%H:%M",hour:"%H:%M",day:"%e %b",week:"%e %b",month:"%b %y",year:"%Y"}},yAxis:{allowDecimals:!1,floor:0,min:0,gridLineDashStyle:"dash",opposite:!1,title:{text:!1}}},e);$.each(i,function(t){var e={title:{text:a[t].title}};e.series=i[t].map(function(t,e){return 0!==t.fillOpacity?$.extend(!0,{},t,{fillColor:{linearGradient:{x1:0,x2:0,y1:0,y2:1},stops:o.map(function(t,n){return[n,t[e]]})}}):t}),"conversion"!=t&&"open_conversion"!=t&&"fave_conversion"!=t||(e.yAxis={max:100,labels:{format:"{value}%"}}),n.$wrapper.find("."+a[t].wrapper_class).highcharts("StockChart",$.extend(!0,{},s,e))})},StatisticsPage.prototype.updateScoreboards=function(t,e,n,i,a){var o=!!e.dynamics;i||(i=Object.keys(n)),i.forEach(function(i){var s,r="Scoreboard"+i.toCamelCase("_"),d=t.find("."+r);switch(i){case"conversion":case"open_conversion":case"fave_conversion":s="%"}d.length||(d=tmpl(o?"scoreboard-with-dynamics":"scoreboard",{type:r,title:n[i],size:a?"-size_"+a:"-size_normal",number:0+s,dynamic_by_week:0+s},t)),void 0!==e.numbers[i]&&d.find(".ScoreboardNumber").animateNumber({number:Math.round(e.numbers[i]),suffix:s},2e3,"easeOutSine"),o&&void 0!==e.dynamics[i]&&d.find(".ScoreboardDynamic").animateNumber({number:Math.round(e.dynamics[i]),prefix:0==e.dynamics[i]?void 0:e.dynamics[i]>0?"+":"-",suffix:s},2e3,"easeOutSine").siblings("label").removeClass("fa-caret-up -color_franklin fa-caret-down -color_bubblegum").addClass(0==e.dynamics[i]?"":e.dynamics[i]>0?"fa-caret-up -color_franklin":"fa-caret-down -color_bubblegum")})},StatisticsOrganizationPage.extend(StatisticsPage),StatisticsOrganizationPage.prototype.renderHeaderTabs=function(){__APP.renderHeaderTabs([{title:"Обзор",page:"/statistics/organization/"+this.id+"/overview"},{title:"События",page:"/statistics/organization/"+this.id+"/events"}])},StatisticsOrganizationAuditoryPage.extend(StatisticsOrganizationPage),StatisticsOrganizationAuditoryPage.prototype.render=function(){},StatisticsOrganizationEventsPage.extend(StatisticsOrganizationPage),StatisticsOrganizationEventsPage.buildEventRows=function(t,e){var n=tmpl("orgstat-events-row",t.map(function(t){return $.extend({},t,{date:moment.unix(t[e]).format(__LOCALES.ru_RU.DATE.DATE_FORMAT),timestamp:t[e],conversion:Math.round(t.view?100*t.view_detail/t.view:0)+"%"})}));return bindPageLinks(n),n},StatisticsOrganizationEventsPage.prototype.render=function(){var t,e,n=this,i=$(window);return __APP.USER.id===-1?(__APP.changeState("/feed/actual",!0,!0),null):(this.renderHeaderTabs(),__APP.changeTitle([{title:"Организации",page:"/statistics"},this.organization.short_name+" - события"]),this.$wrapper.html(tmpl("orgstat-events-page")),this.future_events.fetchOrganizationsEvents(this.organization.id,{future:!0,canceled_shown:!0},0,function(){this.length&&n.$wrapper.find(".OrgStatFutureEventsWrapper").html(tmpl("orgstat-events-wrapper",{title:"Предстоящие события",rows:StatisticsOrganizationEventsPage.buildEventRows(n.future_events,"nearest_event_date")})).find("table").tablesort()}),void this.past_events.fetchOrganizationsEvents(this.organization.id,{canceled_shown:!0,order_by:"-first_event_date"},30,function(){this.length&&(t=n.$wrapper.find(".OrgStatPastEventsWrapper"),t.html(tmpl("orgstat-events-wrapper",{title:"Прошедшие события",rows:StatisticsOrganizationEventsPage.buildEventRows(n.past_events,"first_event_date")})),e=t.find("table").tablesort(),i.on("scroll.uploadEvents",function(){i.height()+i.scrollTop()+200>=$(document).height()&&!n.block_scroll&&(n.block_scroll=!0,__APP.CURRENT_JQXHR=n.past_events.fetchOrganizationsEvents(n.organization.id,{canceled_shown:!0},30,function(i){n.block_scroll=!1,i.length?(t.find("tbody").append(StatisticsOrganizationEventsPage.buildEventRows(i,"first_event_date")),e.refresh()):$(window).off("scroll.uploadEvents")}))}))}))},StatisticsOrganizationOverviewPage.extend(StatisticsOrganizationPage),StatisticsOrganizationOverviewPage.buildStaffBlock=function(t,e){return e.length?tmpl("orgstat-staff-block",{title:t,avatars:__APP.BUILD.avatarBlocks(e)}):tmpl("orgstat-staff-block",{hidden:__C.CLASSES.NEW_HIDDEN})},StatisticsOrganizationOverviewPage.prototype.buildAreaCharts=function(){var t=this;StatisticsPage.prototype.buildAreaCharts.call(t,{subscribe_unsubscribe:t.graphics_stats.subscribe.map(function(e,n){return{time_value:e.time_value,subscribe:e.value,unsubscribe:t.graphics_stats.unsubscribe[n].value}}),view:t.graphics_stats.view,conversion:t.graphics_stats.conversion})},StatisticsOrganizationOverviewPage.prototype.buildPieChart=function(t,e){function n(t){var e={browser:"Браузер",android:"Аndroid",ios:"iOS",female:"Женщины",male:"Мужчины",other:"Остальные",null:"Не указано"};return[{data:t.map(function(t,n){return{name:t.name?e[t.name]:e[t.gender],y:t.count}})}]}var i={chart:{type:"pie",height:200,style:{fontFamily:"inherit",fontSize:"inherit"}},colors:[__C.COLORS.FRANKLIN,__C.COLORS.ACCENT,__C.COLORS.MUTED,__C.COLORS.MUTED_80,__C.COLORS.MUTED_50,__C.COLORS.MUTED_30],tooltip:{pointFormat:"<b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{center:[45,"50%"],allowPointSelect:!0,cursor:"pointer",size:120,dataLabels:{distance:-35,defer:!1,formatter:function(){return this.percentage>15?Math.round(this.percentage)+"%":null},style:{color:"#fff",fontSize:"20px",fontWeight:"300",textShadow:"none"},y:-6},showInLegend:!0}},legend:{align:"right",verticalAlign:"top",layout:"vertical",width:100,symbolHeight:0,symbolWidth:0,itemMarginBottom:5,labelFormatter:function(){return'<span style="color: '+this.color+'">'+this.name+"</span>"},itemStyle:{cursor:"pointer",fontSize:"14px",fontWeight:"500"},y:12}};t.highcharts($.extend(!0,{},this.highchart_defaults,i,{series:n(e)}))},StatisticsOrganizationOverviewPage.prototype.render=function(){var t=this,e={scale:Statistics.SCALES.WEEK,fields:["subscribe","view","fave","conversion"]},n={is_link:!0,avatar_classes:["-size_40x40","-rounded"]},i="org_stats_"+this.id+"_data",a="org_stats_"+this.id+"_until",o=moment.unix(window.sessionStorage.getItem(a)).isAfter(moment());return __APP.USER.id===-1?(__APP.changeState("/feed/actual",!0,!0),null):(window.location.pathname.contains("overview")||__APP.changeState(window.location.pathname+"/overview",!0),this.renderHeaderTabs(),__APP.changeTitle([{title:"Организации",page:"/statistics"},this.organization.short_name]),this.$wrapper.html(tmpl("orgstat-overview",$.extend(!0,{},this.organization,{staff_block:StatisticsOrganizationOverviewPage.buildStaffBlock("Администраторы",this.organization.staff.getSpecificStaff(OneUser.ROLE.ADMIN,n)).add(StatisticsOrganizationOverviewPage.buildStaffBlock("Модераторы",this.organization.staff.getSpecificStaff(OneUser.ROLE.MODERATOR,n))),event_blocks:tmpl("orgstat-event-block",this.organization.events.map(function(t){var e=[];return t.canceled&&e.push({title:"Отменено"}),t.public_at&&moment.unix(t.public_at).isBefore()&&e.push({title:"Не опубликовано"}),{id:t.id,title:t.title,organization_short_name:t.organization_short_name,day:moment.unix(t.first_event_date).format("D"),month:moment.unix(t.first_event_date).format("MMM"),badges:tmpl("orgstat-event-block-badge",e)}}))}))),o?(this.graphics_stats.setData(JSON.parse(window.sessionStorage.getItem(i))),this.buildAreaCharts()):(this.$wrapper.find(".OrgStatAreaCharts").children(".AreaChart").append(tmpl("loader")),this.graphics_stats.fetchStatistics(Statistics.SCALES.DAY,moment(__APP.EVENDATE_BEGIN,"DD-MM-YYYY").format(),["view","subscribe","unsubscribe","conversion"],null,function(){window.sessionStorage.setItem(i,JSON.stringify(t.graphics_stats)),window.sessionStorage.setItem(a,moment().add(15,"m").unix()),t.buildAreaCharts()})),this.other_stats.fetchStatistics(Statistics.SCALES.OVERALL,!1,["subscribe","view","fave","conversion","audience"],e,function(e){var n={numbers:{},dynamics:{}};$.each(e.dynamics,function(t,i){n.dynamics[t]=i[0].value,n.numbers[t]=e[t][0].value}),t.buildPieChart(t.$wrapper.find(".GenderPieChart"),this.audience.gender),t.buildPieChart(t.$wrapper.find(".DevicePieChart"),this.audience.devices),t.updateScoreboards(t.$wrapper.find(".Scoreboards"),n,{subscribe:"Подписчиков организатора",fave:"Добавлений в избранное",view:"Просмотров организатора",conversion:"Конверсия открытий/подписок"},["subscribe","fave","view","conversion"])}),bindRippleEffect(this.$wrapper),void bindPageLinks(this.$wrapper))},StatisticsOrganizationPromotionPage.extend(StatisticsOrganizationPage),StatisticsOrganizationPromotionPage.prototype.render=function(){},StatisticsOrganizationSettingsPage.extend(StatisticsOrganizationPage),StatisticsOrganizationSettingsPage.prototype.render=function(){},StatisticsOrganizationSupportPage.extend(StatisticsOrganizationPage),StatisticsOrganizationSupportPage.prototype.render=function(){},StatisticsEventPage.extend(StatisticsPage),StatisticsEventAuditoryPage.extend(StatisticsEventPage),StatisticsEventAuditoryPage.prototype.render=function(){},StatisticsEventEditPage.extend(StatisticsEventPage),StatisticsEventEditPage.prototype.render=function(){},StatisticsEventOverviewPage.extend(StatisticsEventPage),StatisticsEventOverviewPage.prototype.render=function(){var t=this;return __APP.USER.id===-1?(__APP.changeState("/feed/actual",!0,!0),null):(__APP.changeTitle([{title:"Организации",page:"/statistics"},{title:this.event.organization_short_name,page:"/statistics/organization/"+this.event.organization_id},this.event.title]),this.$wrapper.html(tmpl("eventstat-overview",$.extend(!0,{},this.event,{dates_block:tmpl("eventstat-overview-datetime",{date:displayDateRange(this.event.first_event_date,this.event.last_event_date),time:this.event.is_same_time?displayTimeRange(this.event.dates[0].start_time,this.event.dates[0].end_time):"Разное время"})}))),this.$wrapper.find(".EventStatAreaCharts").children(".AreaChart").html(tmpl("loader")),this.scoreboards_stats.fetchStatistics(Statistics.SCALES.OVERALL,!1,["notifications_sent","view","fave","view_detail","fave_conversion","open_conversion"],null,function(e){var n={numbers:{}};$.each(e,function(t,e){n.numbers[t]=e[0].value}),t.updateScoreboards(t.$wrapper.find(".EventstatsScoreboards"),n,{fave:"Добавлений в избранное",view:"Просмотров события"},["fave","view"]),t.updateScoreboards(t.$wrapper.find(".EventstatsBigScoreboards"),n,{notifications_sent:"Уведомлений отправлено",view:"Просмотров",view_detail:"Открытий",open_conversion:"Конверсия открытий",fave:"Добавлений",fave_conversion:"Конверсия добавлений"},["notifications_sent","view","view_detail","open_conversion","fave","fave_conversion"],"big")}),this.graphics_stats.fetchStatistics(Statistics.SCALES.DAY,moment(__APP.EVENDATE_BEGIN,"DD-MM-YYYY").format(),["notifications_sent","view","fave","view_detail","fave_conversion","open_conversion"],null,function(e){t.buildAreaCharts(e,{rangeSelector:{selected:1}})}),__APP.MODALS.bindCallModal(t.$wrapper),void bindPageLinks(t.$wrapper))},StatisticsEventPromotionPage.extend(StatisticsEventPage),StatisticsEventPromotionPage.prototype.render=function(){},FeedPage.extend(Page),FeedPage.prototype.bindFeedEvents=function(t){trimAvatarsCollection(t),bindRippleEffect(t),bindDropdown(t),__APP.MODALS.bindCallModal(t),bindPageLinks(t),t.find(".HideEvent").not(".-Handled_HideEvent").each(function(){var t=$(this),e=t.parents(".FeedEvent"),n=t.data("event-id");t.on("click",function(){e.addClass("-cancel"),OneEvent.changeEventStatus(n,OneEvent.STATUS.HIDE,function(){e.after(tmpl("button",{classes:"-color_neutral ReturnEvent",title:"Вернуть событие",dataset:'data-event-id="'+n+'"'})),e.siblings(".ReturnEvent").not(".-Handled_ReturnEvent").on("click",function(){var t=$(this);OneEvent.changeEventStatus(n,OneEvent.STATUS.SHOW,function(){t.remove(),e.removeClass("-cancel")})}).addClass("-Handled_ReturnEvent")})})}).addClass("-Handled_HideEvent")},FeedPage.prototype.addNoEventsBlock=function(){var t=tmpl("feed-no-event",{text:"Как насчет того, чтобы подписаться на организации?",button:__APP.BUILD.link({title:"Перейти к каталогу",classes:["button","-color_neutral_accent","RippleEffect"],page:"/organizations"})},this.$wrapper);bindPageLinks(t),bindRippleEffect(t)},FeedPage.prototype.appendEvents=function(t){var e=this;return e.block_scroll=!0,e.events.fetchFeed(this.fields,this.next_events_length,function(n){var i=__APP.BUILD.feedEventCards(n);e.block_scroll=!1,i.length?(e.$wrapper.append(i),e.bindFeedEvents(i),t&&"function"==typeof t&&t(i)):(e.addNoEventsBlock(),$(window).off("scroll.upload"+e.constructor.name))})},FeedPage.prototype.initFeedCalendar=function(){var t=this,e=t.events.date,n=new Calendar(t.$view.find(".FeedCalendar"),{classes:{wrapper_class:"feed_calendar_wrapper",table_class:"feed_calendar_table",thead_class:"feed_calendar_thead",tbody_class:"feed_calendar_tbody",th_class:"feed_calendar_th",td_class:"feed_calendar_td",td_disabled:__C.CLASSES.NEW_DISABLED}});n.init(),e&&n.setMonth(e.split("-")[1],e.split("-")[0]).selectDays(e),n.setDaysWithEvents(),n.$calendar.on("month-changed",function(){bindPageLinks(n.$calendar),n.setDaysWithEvents()})},FeedPage.prototype.render=function(){var t=this,e=$(window);if(__APP.PREVIOUS_PAGE instanceof FeedPage||t.initFeedCalendar(),__APP.USER.id===-1){if(__APP.renderHeaderTabs([{title:"Актуальные",page:"/feed/actual"},{title:"По времени",page:"/feed/timeline"}]),"/feed/favored"==window.location.pathname||"/feed/recommendations"==window.location.pathname)return __APP.changeState("/feed/actual",!0,!0),null}else __APP.renderHeaderTabs([{title:"Актуальные",page:"/feed/actual"},{title:"По времени",page:"/feed/timeline"},{title:"Избранные",page:"/feed/favored"},{title:"Рекомендованные",page:"/feed/recommendations"}]);return"/feed/"!=window.location.pathname&&"/feed"!=window.location.pathname&&window.location.pathname.contains("feed")?(e.off("scroll"),void(__APP.CURRENT_JQXHR=t.appendEvents(function(){e.on("scroll.upload"+t.constructor.name,function(){e.height()+e.scrollTop()+200>=$(document).height()&&!t.block_scroll&&(__APP.CURRENT_JQXHR=t.appendEvents())})}))):(__APP.changeState("/feed/actual",!0,!0),null)},ActualEventsPage.extend(FeedPage),DayEventsPage.extend(FeedPage),FavoredEventsPage.extend(FeedPage),FriendsEventsPage.extend(FeedPage),RecommendedEventsPage.extend(FeedPage),TimelineEventsPage.extend(FeedPage),FriendsPage.extend(Page),FriendsPage.prototype.render=function(){function t(){0==n&&e.find(".friend-events-block").remove(),$.ajax({url:'/api/v1/users/feed?fields=entity,created_at,user,type_code,event{fields:"organization_logo_small_url,image_square_vertical_url,organization_short_name"},organization{fields:"subscribed_count,img_medium_url"}&&order_by=-created_at&length=10&offset='+10*n++,success:function(t){var n={};t.data.forEach(function(t){var e=moment.unix(t.created_at),i=t[t.entity],a=[t.entity,t.stat_type_id,t.user.id,e.format("DD.MM")].join("-");0==n.hasOwnProperty(a)&&(n[a]={user:t.user,entity:t.entity,type_code:t.type_code,date:e.format(__C.DATE_FORMAT)==moment().format(__C.DATE_FORMAT)?"Сегодня":e.format("DD.MM"),action_name:__C.ACTION_NAMES[t.type_code][0],first_name:t.user.first_name,friend_id:t.user.id,avatar_url:t.user.avatar_url,last_name:t.user.last_name,entities:[]}),n[a].entities.push(i)}),$.each(n,function(t,e){var n=tmpl("friends-feed-card",e),i=e.entity==__C.ENTITIES.EVENT?"friends-feed-event":"friends-feed-organization";e.entities.forEach(function(t){n.append(tmpl(i,t))}),a.before(n)}),a.removeClass(__C.CLASSES.HIDDEN).find(".btn").removeClass(__C.CLASSES.DISABLED),bindPageLinks(e)}})}var e=this.$view,n=0;if(__APP.USER.id===-1)__APP.changeState("/feed/");else{var i=(e.find(".friends-main-content").removeClass(__C.CLASSES.HIDDEN),e.find(".friends-right-bar")),a=e.find(".load-more-btn").addClass(__C.CLASSES.HIDDEN);e.find(".one-friend-main-content").addClass(__C.CLASSES.HIDDEN);getFriendsList(i,function(t){}),a.find(".btn").on("click",t),t()}},OneFriendPage.extend(Page),OneFriendPage.prototype.render=function(){function t(){var o=i.find(".load-more-btn");0==a&&i.find(".friend-events-block").remove(),$.ajax({url:"/api/v1/users/"+n+'/actions?fields=entity,created_at,user,type_code,event{fields:"organization_logo_small_url,image_square_vertical_url,organization_short_name"},organization{fields:"subscribed_count,img_medium_url"}&&order_by=-created_at&length=10&offset='+10*a++,success:function(n){var i=!1;0==n.data.length&&1!=a||n.data.length<10&&n.data.length>0?(o.addClass(__C.CLASSES.HIDDEN),i=!0):0==n.data.length&&1==a&&(o.before(tmpl("no-activity",{})),o.addClass(__C.CLASSES.HIDDEN),i=!0);var s={};n.data.forEach(function(t){var e=moment.unix(t.created_at),n=t[t.entity],i=[t.entity,t.stat_type_id,t.user.id,e.format("DD.MM")].join("-");0==s.hasOwnProperty(i)&&(s[i]={user:t.user,entity:t.entity,type_code:t.type_code,date:e.format(__C.DATE_FORMAT)==moment().format(__C.DATE_FORMAT)?"Сегодня":e.format("DD.MM"),action_name:__C.ACTION_NAMES[t.type_code][0].capitalize(),first_name:t.user.first_name,avatar_url:t.user.avatar_url,friend_id:t.user.id,last_name:t.user.last_name,entities:[]}),s[i].entities.push(n)}),$.each(s,function(t,e){var n=tmpl("friends-feed-card-short",e),i=e.entity==__C.ENTITIES.EVENT?"friends-feed-event":"friends-feed-organization";e.entities.forEach(function(t){n.append(tmpl(i,t))}),o.before(n)}),i||o.removeClass(__C.CLASSES.HIDDEN).find(".btn").removeClass(__C.CLASSES.DISABLED),o.off("click").on("click",t),bindPageLinks(e)}})}var e=this.$view,n=this.friend_id,i=e.find(".one-friend-main-content"),a=0;__APP.USER.id===-1?(e.find(".friends-right-bar").remove(),e.find(".back-to-friends-list").remove()):getFriendsList(e.find(".friends-right-bar"),function(){$(".friend-item.friend-"+n).addClass(__C.CLASSES.ACTIVE).siblings().removeClass(__C.CLASSES.ACTIVE)}),e.find(".friends-main-content").addClass(__C.CLASSES.HIDDEN),i.removeClass(__C.CLASSES.HIDDEN).empty(),$.ajax({url:"/api/v1/users/"+n+"?fields=subscriptions",success:function(n){i.append(tmpl("friends-page-header",n.data[0])),__APP.changeTitle(n.data[0].first_name+" "+n.data[0].last_name),i.find(".friend-user-link").on("click",function(){window.open(n.data[0].link,"_blank")}),0==n.data[0].subscriptions.length?tmpl("no-subscriptions",{},i.find(".one-friend-subscriptions")):tmpl("friends-subscription",n.data[0].subscriptions,i.find(".one-friend-subscriptions")),i.find(".friend-subscription-block").each(function(t){var e=$(this);setTimeout(function(){e.fadeIn(300)},40*t+500)}),i.find(".user-btn").on("click",function(){var t=$(this);t.addClass(__C.CLASSES.ACTIVE),t.siblings().removeClass(__C.CLASSES.ACTIVE),i.find("."+t.data("tab")).removeClass(__C.CLASSES.HIDDEN).siblings().addClass(__C.CLASSES.HIDDEN)}),__APP.USER.id===-1?e.find(".back-to-friends-list").remove():e.find(".back-to-friends-list").on("click",function(){__APP.changeState("/friends")}),t()}})},OnboardingPage.extend(Page),OnboardingPage.prototype.init=function(){bindRippleEffect(this.$wrapper),bindPageLinks(this.$wrapper),this.$wrapper.find(".Link").on("click",function(){$(this).is(".SkipOnboarding")&&cookies.setItem("skip_onboarding",1,moment().add(7,"d")._d),__APP.SIDEBAR.updateSubscriptions()})},OnboardingPage.prototype.bindSubscriptions=function(){this.$wrapper.find(".OnboardingOrgItem").not(".-Handled_OnboardingOrgItem").on("click",function(){var t=$(this);t.hasClass(__C.CLASSES.NEW_ACTIVE)?__APP.USER.unsubscribeFromOrganization(t.data("organization_id")):__APP.USER.subscribeToOrganization(t.data("organization_id")),t.toggleClass(__C.CLASSES.NEW_ACTIVE)}).addClass("-Handled_OnboardingOrgItem")},OnboardingPage.prototype.render=function(){function t(t){n.detach(),t.length?(e.$wrapper.find(".RecommendationsWrapper").last().append(tmpl("onboarding-recommendation",t)),e.bindSubscriptions(),e.block_scroll=!1):e.disable_upload=!0}var e=this,n=tmpl("loader",{});return __APP.USER.id===-1?(__APP.changeState("/feed/actual",!0,!0),null):(e.$wrapper.html(tmpl("onboarding-main",{})),e.init(),e.$wrapper.find(".RecommendationsWrapper").last().append(n),OrganizationsCollection.fetchRecommendations(e.ajax_data,t),void e.$wrapper.find(".RecommendationsScrollbar").scrollbar({onScroll:function(i,a){i.scroll!=i.maxScroll||e.disable_upload||e.block_scroll||(e.block_scroll=!0,e.$wrapper.find(".RecommendationsWrapper").last().append(n),OrganizationsCollection.fetchRecommendations(e.ajax_data,t))}}))},SearchPage.extend(Page),SearchPage.buildOrganizationItems=function(t){return __APP.BUILD.organizationItems(t,{block_classes:["-show"],avatar_classes:["-size_50x50","-rounded"],counter_classes:[__C.CLASSES.NEW_HIDDEN]})},SearchPage.buildEventCards=function(t){var e=$();return 0==t.length?e=tmpl("search-no-events",{}):t.forEach(function(t){void 0!=t.nearest_event_date||this.past_events||(e=e.add(tmpl("divider",{title:"Прошедшие события"})),this.past_events=!0),e=e.add(__APP.BUILD.feedEventCards(t))}),e},SearchPage.prototype.init=function(){function t(t){trimAvatarsCollection(t),bindRippleEffect(t),__APP.MODALS.bindCallModal(t),bindPageLinks(t),t.find(".HideEvent").addClass(__C.CLASSES.NEW_HIDDEN)}var e,n=this,i=$(window);e=this.$wrapper.find(".SearchOrganizationsScrollbar").scrollbar({disableBodyScroll:!0,onScroll:function(t){t.scroll==t.maxScroll&&n.search_results.fetchOrganizations(n.organizations_ajax_data,function(t){t.length?e.append(SearchPage.buildOrganizationItems(t)):e.off("scroll.onScroll"),bindPageLinks(e)})}}),i.off("scroll.upload"+n.constructor.name),i.on("scroll.upload"+n.constructor.name,function(){i.height()+i.scrollTop()+200>=$(document).height()&&!n.block_scroll&&(n.block_scroll=!0,__APP.CURRENT_JQXHR=n.search_results.fetchEvents(n.events_ajax_data,function(e){var a;e.length?(a=SearchPage.buildEventCards(e),t(a),n.$wrapper.find(".SearchEvents").append(a),n.block_scroll=!1):i.off("scroll.upload"+n.constructor.name)}))}),t(this.$wrapper)},SearchPage.prototype.render=function(){var t={};this.$search_bar_input.val(this.search_string),t.events=SearchPage.buildEventCards(this.search_results.events),0==this.search_results.organizations.length?t.no_organizations=__C.CLASSES.NEW_HIDDEN:t.organizations=SearchPage.buildOrganizationItems(this.search_results.organizations),this.$wrapper.append(tmpl("search-wrapper",t)),this.init()},StatisticsOverviewPage.extend(StatisticsPage),StatisticsOverviewPage.buildMyOrganizationsBlocks=function(t){return tmpl("statistics-overview-organization",t.map(function(t){var e=2,n={is_link:!0,avatar_classes:["-size_100x100","-rounded"]},i=[{name:OneUser.ROLE.ADMIN,title:"Администраторы",staff:UsersCollection.getSpecificStaff(OneUser.ROLE.ADMIN,t.staff,n),plural_name:OneUser.ROLE.ADMIN+"s"},{name:OneUser.ROLE.MODERATOR,title:"Модераторы",staff:UsersCollection.getSpecificStaff(OneUser.ROLE.MODERATOR,t.staff,n),plural_name:OneUser.ROLE.MODERATOR+"s"}],a={classes:["-size_30x30","-rounded","CallModal"],dataset:{modal_type:"editors",modal_organization_id:t.id}};return i.forEach(function(n){t[n.plural_name]=__APP.BUILD.avatarCollection(n.staff,e,$.extend(!0,{},a,{dataset:{modal_specific_role:n.name,modal_title:n.title}})),t[n.plural_name+"_plus_count"]=n.staff.length-e,t[n.plural_name+"_plus_count_hidden"]=t[n.plural_name+"_plus_count"]<=0?"-cast":""}),$.extend(!0,{},t,{subscribers:t.subscribed_count+getUnitsText(t.subscribed_count,__LOCALES.ru_RU.TEXTS.SUBSCRIBERS),buttons:__APP.BUILD.link({title:"Редактировать",classes:["button","fa_icon","fa-pencil","-color_neutral","RippleEffect"],page:"/organization/"+t.id+"/edit"},{title:"Создать событие",classes:["button","fa_icon","fa-plus","-color_accent","RippleEffect"],page:"/add/event/to/"+t.id})})}))},StatisticsOverviewPage.prototype.bindOrganizationsEvents=function(t){return trimAvatarsCollection(t),bindPageLinks(t),__APP.MODALS.bindCallModal(t),bindRippleEffect(t),t},StatisticsOverviewPage.prototype.bindUploadOnScroll=function(){var t=this,e=$(window),n=function(){e.height()+e.scrollTop()+200>=$(document).height()&&!t.disable_upload&&(e.off("scroll.uploadOrganizations"),t.my_organizations.fetchMyOrganizations("admin",t.my_organizations_fields,10,"",function(i){
var a=StatisticsOverviewPage.buildMyOrganizationsBlocks(i);i.length?(t.$wrapper.find(".StatOverviewOrganizations").append(a),t.bindOrganizationsEvents(a),e.on("scroll.uploadOrganizations",n)):t.disable_upload=!0}))};t.disable_upload||e.on("scroll.uploadOrganizations",n)},StatisticsOverviewPage.prototype.init=function(){this.bindOrganizationsEvents(this.$wrapper),this.bindUploadOnScroll()},StatisticsOverviewPage.prototype.render=function(){return __APP.USER.id===-1?(__APP.changeState("/feed/actual",!0,!0),null):(this.$wrapper.html(tmpl("statistics-overview-wrapper",{organizations:StatisticsOverviewPage.buildMyOrganizationsBlocks(this.my_organizations)})),void this.init())},StatisticsOverviewPage.prototype.destroy=function(){$(window).off("scroll.uploadOrganizations")},RedactEventPage.extend(Page),RedactEventPage.handleImgUpload=function(t,e,n){var i=t.closest(".EditEventImgLoadWrap"),a=i.find(".EditEventImgPreview"),o=i.find(".FileNameText"),s=i.find(".FileName"),r=i.find(".DataUrl"),d=i.find(".CallModal");a.attr("src",e),o.html("Загружен файл:<br>"+n),s.val(n),d.data("source_img",e).on("crop",function(t,e,n){a.attr("src",e),d.data("crop_data",n),r.val("data.source").data("source",a.attr("src")).trigger("change")}).trigger("click.CallModal")},RedactEventPage.prototype.formatVKPost=function(){var t=this,e=t.$wrapper.find("#edit_event_vk_post"),n=t.$wrapper.find("#edit_event_title"),i=t.$wrapper.find(".EventDatesCalendar").data("calendar"),a=t.$wrapper.find("#edit_event_placepicker"),o=t.$wrapper.find("#edit_event_description"),s=t.$wrapper.find("#edit_event_free"),r=t.$wrapper.find("#edit_event_min_price"),d=t.$wrapper.find("#edit_event_registration_required"),l=t.$wrapper.find(".RegistrationTill"),c=t.$wrapper.find(".EventTags"),u=[],_=t.$wrapper.find("#edit_event_url"),f="";if(f+=n.val()?n.val()+"\n\n":"",i.selected_days&&(f+=i.selected_days.length>1?"Дата начала: ":"Начало: ",f+=moment(i.selected_days[0]).format("D MMMM YYYY"),1==i.selected_days.length)){var p=t.$wrapper.find(".MainTime").find("input");f+=p.eq(0).val()?" в "+parseInt(p.eq(0).val()):"",f+=p.eq(1).val()?":"+p.eq(1).val():""}if(d.prop("checked")){var h=l.find("input");h.eq(0).val()?(f+=" (регистрация заканчивается: "+moment(h.eq(0).val()).format("D MMMM YYYY"),f+=h.eq(1).val()?" в "+parseInt(h.eq(1).val()):"",f+=h.eq(2).val()?":"+h.eq(2).val():"",f+=")\n"):f+="\n"}else f+="\n";f+=a.val()?a.val()+"\n\n":"",f+=o.val()?o.val()+"\n\n":"",s.prop("checked")||(f+=r.val()?"Цена от "+r.val()+"\n\n":""),c.find(".select2-search-choice").each(function(t,e){u.push("#"+$(e).text().trim())}),f+=u?u.join(" ")+"\n\n":"",_.val()?f+=_.val():t.event.id&&(f+="https://evendate.ru/event/"+t.event.id),e.val(f)},RedactEventPage.prototype.toggleVkImg=function(){var t=this,e=t.$wrapper.find("#edit_event_vk_publication").find(".EditEventImgLoadWrap"),n=e.children().eq(0),i=e.children().eq(1);n.hasClass("-hidden")?(i.find(".LoadImg").off("change.ToggleVkImg"),i.find(".Text").text("Изменить")):(i.find(".LoadImg").off("change.ToggleVkImg").one("change.ToggleVkImg",function(){t.toggleVkImg()}),i.find(".Text").text("Добавить картинку")),n.toggleClass("-hidden"),i.toggleClass("-align_center")},RedactEventPage.prototype.init=function(){function t(){function t(){i.find("#edit_event_to_public_vk").prop("checked")&&socket.emit("vk.post",{guid:a.vk_group,event_id:e.event.id,message:a.vk_post,image:{base64:a.vk_image_src,filename:a.vk_image_filename},link:a.detail_info_url}),__APP.changeState("/event/"+e.event.id)}function n(){e.$wrapper.removeClass("-faded")}var i=e.$wrapper.find("#edit-event-form"),a={event_id:null,title:null,image_horizontal:null,organization_id:null,location:null,description:null,detail_info_url:null,different_time:null,dates:null,tags:null,registration_required:null,registration_till:null,is_free:null,min_price:null,delayed_publication:null,public_at:null,filenames:{horizontal:null}},o=i.serializeForm(),s=o.tags?o.tags.split(","):null,r=!!e.event.id,d=!0,l=i.find("#edit_event_different_time").prop("checked")?i.find('[class^="TableDay_"]'):i.find(".MainTime");if(i.find(":required").not(":disabled").each(function(){var t=$(this),e=t.data("maxlength");(""===t.val()||e&&t.val().length>e)&&(d&&$("body").stop().animate({scrollTop:Math.ceil(t.offset().top-150)},1e3,"swing"),handleErrorField(t),d=!1)}),l.each(function(){var t=$(this),e=t.find(".StartHours").val()+t.find(".StartMinutes").val(),n=t.find(".EndHours").val()+t.find(".EndMinutes").val();e>n&&(d&&$("body").stop().animate({scrollTop:Math.ceil(t.offset().top-150)},1e3,"swing"),showNotifier({text:"Начальное время не может быть меньше конечного",status:!1}),d=!1)}),r||i.find(".DataUrl").each(function(){var t=$(this);""===t.val()&&(d&&$("body").stop().animate({scrollTop:Math.ceil(t.closest(".EditEventImgLoadWrap").offset().top-150)},1e3,"swing",function(){showNotifier({text:"Пожалуйста, добавьте к событию обложку",status:!1})}),d=!1)}),d){if($.extend(!0,a,o),a.tags=s,a.filenames={horizontal:a.filename_horizontal},a.registration_required&&(a.registration_till=""+a.registration_till_date+"T"+a.registration_till_time_hours+":"+a.registration_till_time_minutes+":00"),a.delayed_publication&&(a.public_at=""+a.public_at_date+"T"+a.public_at_time_hours+":"+a.public_at_time_minutes+":00"),a.dates=[],a.different_time){var c=$(".SelectedDaysRows").children();c.each(function(){var t=$(this);a.dates.push({event_date:t.find(".DatePicker").data("selected_day"),start_time:t.find(".StartHours").val()+":"+t.find(".StartMinutes").val(),end_time:t.find(".EndHours").val()+":"+t.find(".EndMinutes").val()})})}else{var u=$(".EventDatesCalendar").data("calendar"),_=$(".MainTime"),f=_.find(".StartHours").val()+":"+_.find(".StartMinutes").val(),p=_.find(".EndHours").val()+":"+_.find(".EndMinutes").val();u.selected_days.forEach(function(t){a.dates.push({event_date:t,start_time:f,end_time:p})})}e.$wrapper.addClass("-faded");try{r?e.event.updateEvent(a,t,n):e.event.createEvent(a,t,n)}catch(t){e.$wrapper.removeClass("-faded"),console.error(t)}}}var e=this;bindDatePickers(e.$wrapper),bindTimeInput(e.$wrapper),bindSelect2(e.$wrapper),bindTabs(e.$wrapper),__APP.MODALS.bindCallModal(e.$wrapper),bindLimitInputSize(e.$wrapper),bindRippleEffect(e.$wrapper),bindFileLoadButton(e.$wrapper),function(){$(".LoadByURLButton").not("-Handled_LoadByURLButton").on("click",function(){var t=$(this),e=$("#"+t.data("load_input"));t.data("url",e.val()),window.current_load_button=t,socket.emit("image.getFromURL",e.val()),window.paceOptions={catchupTime:1e4,maxProgressPerFrame:1,ghostTime:Number.MAX_SAFE_INTEGER,checkInterval:{checkInterval:1e4},eventLag:{minSamples:1,sampleCount:3e7,lagThreshold:.1}},Pace.restart()}).addClass("-Handled_LoadByURLButton")}(),function(){function t(t){t.find(".RemoveRow").not(".-Handled_RemoveRow").each(function(t,e){$(e).on("click",function(){d.deselectDays($(this).closest("tr").data("date"))}).addClass("-Handled_RemoveRow")})}function n(){l={},d.selected_days.forEach(function(t,e,n){var i=moment(t);"undefined"==typeof l[i.month()]&&(l[i.month()]={},l[i.month()].selected_days=[],l[i.month()].month_name=c[i.format("MMMM")]),l[i.month()].selected_days.push(i.date())}),s.empty().removeClass("hidden"),Object.keys(l).length?$.each(l,function(t,e){s.append($("<p>").text(e.selected_days.join(", ")+" "+e.month_name))}):s.html("<p>Даты не выбраны</p>")}function i(t,e){t.sort(function(t,e){var n=$(t).data("date"),i=$(e).data("date");return n>i?1:n<i?-1:0}),t.detach().appendTo(e)}function a(e){var n=$();Array.isArray(e)?e.forEach(function(t){n=n.add(tmpl("selected-table-day",{date:t,formatted_date:t.split("-").reverse().join(".")}))}):n=tmpl("selected-table-day",{date:e,formatted_date:e.split("-").reverse().join(".")}),bindDatePickers(n),bindTimeInput(n),t(n),u=u.add(n),n.find(".DatePicker").each(function(){var t=$(this).data("datepicker");t.$datepicker.on("date-picked",function(){d.deselectDays(t.prev_selected_day).selectDays(t.selected_day),i(u,r)})}),i(u,r)}function o(){if("select"===d.last_action)a(d.last_selected_days);else if("deselect"===d.last_action)if(Array.isArray(d.last_selected_days)){var t=[];d.last_selected_days.forEach(function(e){t.push(".TableDay_"+e)}),u.detach(t.join(", ")),u=u.not(t.join(", "))}else u.detach(".TableDay_"+d.last_selected_days),u=u.not(".TableDay_"+d.last_selected_days);i(u,r)}var s=e.$wrapper.find(".EventSelectedDaysText"),r=e.$wrapper.find(".SelectedDaysRows"),d=new Calendar(".EventDatesCalendar",{weekday_selection:!0,month_selection:!0,min_date:moment().format(__C.DATE_FORMAT)}),l={},c={"январь":"января","февраль":"февраля","март":"марта","апрель":"апреля","май":"мая","июнь":"июня","июль":"июля","август":"августа","сентябрь":"сентября","октябрь":"октября","ноябрь":"ноября","декабрь":"декабря"},u=$();d.init(),d.$calendar.on("days-changed.displayFormattedText",n),e.$wrapper.find("#edit_event_different_time").on("change",function(){var t=e.$wrapper.find("#edit_event_selected_days_wrapper"),n=t.children();$(this).prop("checked")?(a(d.selected_days),t.height(n.height()).one("transitionend",function(){t.css({height:"auto",overflow:"visible"})}),d.$calendar.on("days-changed.buildTable",o)):(t.css({height:n.height(),overflow:"hidden"}).height(0),u.remove(),d.$calendar.off("days-changed.buildTable")),e.$wrapper.find(".MainTime").toggleStatus("disabled")});var _=e.$wrapper.find(".AddDayToTable").data("datepicker");_.$datepicker.on("date-picked",function(){d.selectDays(_.selected_day)})}(),function(t){OrganizationsCollection.fetchMyOrganizations(["admin","moderator"],{fields:["default_address"]},function(n){var i,a=$(".EditEventOrganizations"),o=$(),s=e.$wrapper.find(".EditEventDefaultAddress"),r=a.find("#edit_event_organization");n.forEach(function(e){e.id==t&&(i=e.default_address),o=o.add(tmpl("option",{val:e.id,data:"data-image-url='"+e.img_url+"' data-default-address='"+e.default_address+"'",display_name:e.name}))}),r.append(o).select2({containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}).on("change",function(){s.data("default_address",$(this).children(":selected").data("default-address"))}),t?(r.select2("val",t),s.data("default_address",i)):s.data("default_address",n[0].default_address),o.length>1?a.removeClass("-hidden"):a.addClass("-hidden")})}(e.event.organization_id),function(){__APP.USER.accounts.indexOf("vk")!==-1?(socket.emit("vk.getGroupsToPost",__APP.USER.id),e.$wrapper.find("#edit_event_title,#edit_event_placepicker,#edit_event_description,#edit_event_free,#edit_event_min_price,#edit_event_registration_required,#edit_event_url,.EventTags").add(".RegistrationTill input").add(".MainTime input").on("change.FormatVkPost",function(){e.formatVKPost()}),e.$wrapper.find(".EventDatesCalendar").data("calendar").$calendar.on("days-changed.FormatVkPost",function(){e.formatVKPost()})):e.$wrapper.find("#edit_event_to_public_vk").toggleStatus("disabled")}(),e.$wrapper.find(".Placepicker").placepicker(),e.$wrapper.find(".EventTags").select2({tags:!0,width:"100%",placeholder:"Выберите до 5 тегов",maximumSelectionLength:5,maximumSelectionSize:5,tokenSeparators:[",",";"],multiple:!0,createSearchChoice:function(t,e){if(0===$(e).filter(function(){return 0===this.text.localeCompare(t)}).length)return{id:t,text:t}},ajax:{url:"/api/v1/tags/",dataType:"JSON",data:function(t,e){return{name:t}},results:function(t){var e=[];return t.data.forEach(function(t){t.text=t.name,e.push(t)}),{results:e}}},containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}),e.$wrapper.find(".EditEventDefaultAddress").off("click.defaultAddress").on("click.defaultAddress",function(){var t=$(this);t.closest(".form_group").find("input").val(t.data("default_address"))}),e.$wrapper.find("#edit_event_delayed_publication").off("change.DelayedPublication").on("change.DelayedPublication",function(){e.$wrapper.find(".DelayedPublication").toggleStatus("disabled")}),e.$wrapper.find("#edit_event_registration_required").off("change.RequireRegistration").on("change.RequireRegistration",function(){e.$wrapper.find(".RegistrationTill").toggleStatus("disabled")}),e.$wrapper.find("#edit_event_free").off("change.FreeEvent").on("change.FreeEvent",function(){e.$wrapper.find(".MinPrice").toggleStatus("disabled")}),e.$wrapper.find(".MinPrice").find("input").inputmask({alias:"numeric",autoGroup:!1,digits:2,digitsOptional:!0,placeholder:"0",rightAlign:!1}),e.$wrapper.find(".LoadImg").off("change.LoadImg").on("change.LoadImg",function(t){var e,n=$(t.target),i=t.target.files;if(0==i.length)return!1;for(var a,o=0;a=i[o];o++)e=new FileReader,a.type.match("image.*")&&(e.onload=function(t){return function(e){RedactEventPage.handleImgUpload(n,e.target.result,t.name)}}(a),e.readAsDataURL(a))}),e.$wrapper.find("#edit_event_to_public_vk").off("change.PublicVK").on("change.PublicVK",function(){var t=e.$wrapper.find("#edit_event_vk_publication"),n=t.children();$(this).prop("checked")?t.height(n.height()):t.height(0),t.toggleStatus("disabled"),n.find(".DeleteImg").off("click.DeleteImg").on("click.DeleteImg",function(){$(this).closest(".EditEventImgLoadWrap").find("input").val("").end().find("img").attr("src",""),e.toggleVkImg()})}),e.$wrapper.find("#edit_event_submit").off("click.Submit").on("click.Submit",t)},RedactEventPage.prototype.render=function(){function t(t,e){var n=t.find(".EventDatesCalendar").data("calendar"),i=t.find(".SelectedDaysRows"),a=[];e.forEach(function(t){t.event_date=moment.unix(t.event_date).format("YYYY-MM-DD"),a.push(t.event_date)}),n.selectDays(a),e.forEach(function(t){var e=i.find(".TableDay_"+t.event_date),n=t.start_time.split(":"),a=t.end_time?t.end_time.split(":"):[];e.find(".StartHours").val(n[0]),e.find(".StartMinutes").val(n[1]),a.length&&(e.find(".EndHours").val(a[0]),e.find(".EndMinutes").val(a[1]))})}function e(t,e){var n=[];e.forEach(function(t){n.push({id:parseInt(t.id),text:t.name})}),t.find("#event_tags").select2("data",n)}function n(){var t=i.$wrapper.find("#edit_event_vk_publication");i.$wrapper.find("#edit_event_image_horizontal_src").on("change.CopyToVkImg",function(){var t=$(this).closest(".EditEventImgLoadWrap"),e=i.$wrapper.find("#edit_event_vk_publication"),n=e.find(".EditEventImgPreview"),a=e.find(".CallModal"),o=e.find("#edit_event_vk_image_src"),s=t.find(".CallModal"),r=$(this).data("source");i.$wrapper.find(".edit_event_vk_right_block").hasClass("-align_center")||i.toggleVkImg(),o.val("data.source").data("source",r),n.attr("src",r),e.find("#edit_event_vk_image_filename").val(i.$wrapper.find("#edit_event_image_horizontal_filename").val()),a.data("crop_data",s.data("crop_data")).data("source_img",s.data("source_img")).on("crop",function(t,e,i){n.attr("src",e),a.data("crop_data",i),o.data("source",n.attr("src")).trigger("change")})}),t.find(".FileLoadButton, .CallModal, .DeleteImg").on("click.OffCopying",function(){i.$wrapper.find("#edit_event_image_horizontal_src").off("change.CopyToVkImg")})}var i=this,a=!!i.event.id,o={event_id:i.event.id?i.event.id:void 0,public_at_data_label:"Дата",registration_till_data_label:"Дата",current_date:moment().format(__C.DATE_FORMAT),tomorrow_date:moment().add(1,"d").format(__C.DATE_FORMAT)};if(__APP.USER.id===-1)return __APP.changeState("/feed/actual",!0,!0),null;if(window.location.pathname.contains("event/add"))return this.organization_id?__APP.changeState("/add/event/to/"+this.organization_id,!0,!0):__APP.changeState("/add/event",!0,!0),null;if(a){if(o.header_text="Редактирование события",o.button_text="Сохранить",null!==i.event.public_at){var s=moment(i.event.public_at);o.public_at_data=s.format("YYYY-MM-DD"),o.public_at_data_label=s.format("DD.MM.YYYY"),o.public_at_time_hours=s.format("HH"),o.public_at_time_minutes=s.format("mm")}if(i.event.registration_required){var r=moment.unix(i.event.registration_till);o.registration_till_data=r.format("YYYY-MM-DD"),o.registration_till_data_label=r.format("DD.MM.YYYY"),o.registration_till_time_hours=r.format("HH"),o.registration_till_time_minutes=r.format("mm")}if(i.event.image_horizontal_url&&(o.image_horizontal_filename=i.event.image_horizontal_url.split("/").reverse()[0],o.vk_image_url=i.event.image_horizontal_url,o.vk_image_filename=o.image_horizontal_filename),i.event.vk_image_url&&(o.vk_image_url=i.event.vk_image_url,o.vk_image_filename=i.event.vk_image_url.split("/").reverse()[0]),o=$.extend(!0,{},i.event,o),i.$wrapper.html(tmpl("edit-event-page",o)),i.init(),i.event.is_same_time){var d=i.$wrapper.find(".MainTime"),l=i.event.dates[0].start_time.split(":"),c=i.event.dates[0].end_time?i.event.dates[0].end_time.split(":"):[];d.find(".StartHours").val(l[0]),d.find(".StartMinutes").val(l[1]),c.length&&(d.find(".EndHours").val(c[0]),d.find(".EndMinutes").val(c[1]))}else i.$wrapper.find("#edit_event_different_time").prop("checked",!0).trigger("change");t(i.$wrapper,i.event.dates),e(i.$wrapper,i.event.tags),i.event.image_horizontal_url&&(toDataUrl(i.event.image_horizontal_url,function(t){i.$wrapper.find("#edit_event_image_horizontal_src").val(t?t:null)}),i.$wrapper.find(".CallModal").removeClass("-hidden").on("crop",function(t,e,n){var i=$(this),a=i.closest(".EditEventImgLoadWrap"),o=a.find(".EditEventImgPreview"),s=a.find(".DataUrl");s.val("data.source").data("source",o.attr("src")).trigger("change"),o.attr("src",e),i.data("crop_data",n)})),o.vk_image_url?toDataUrl(o.vk_image_url,function(t){i.$wrapper.find("#edit_event_vk_image_src").val(t?t:null)}):i.toggleVkImg(),i.event.is_free||(i.$wrapper.find("#edit_event_free").prop("checked",!1).trigger("change"),i.$wrapper.find("#edit_event_min_price").val(i.event.min_price)),i.event.registration_required&&i.$wrapper.find("#edit_event_registration_required").prop("checked",!0).trigger("change"),null!==i.event.public_at&&i.$wrapper.find("#edit_event_delayed_publication").prop("checked",!0).trigger("change"),i.formatVKPost()}else o.header_text="Новое событие",o.button_text="Опубликовать",i.$wrapper.html(tmpl("edit-event-page",o)),i.init(),i.toggleVkImg(),n()},AddEventPage.extend(RedactEventPage),OneEventPage.extend(Page),OneEventPage.buildNotifications=function(t,e,n){var i=moment(),a={"notification-before-quarter-of-hour":{label:"За 15 минут",moment:moment.unix(n).subtract(15,"minutes").unix()},"notification-before-three-hours":{label:"За 3 часа",moment:moment.unix(n).subtract(3,"hours").unix()},"notification-before-day":{label:"За день",moment:moment.unix(n).subtract(1,"days").unix()},"notification-before-three-days":{label:"За 3 дня",moment:moment.unix(n).subtract(3,"days").unix()},"notification-before-week":{label:"За неделю",moment:moment.unix(n).subtract(1,"week").unix()}},o=$(),s={},r=0;for(var d in t)t.hasOwnProperty(d)&&(s[t[d].notification_type]=t[d]);for(var l in a)if(a.hasOwnProperty(l)){var c=moment.unix(a[l].moment).isBefore(i),u={id:"event_notify_"+ ++r,classes:["ToggleNotification"],name:"notification_time",label:a[l].label,attributes:{value:l},dataset:{event_id:e}};s[l]&&(c=c||s[l].done||!s[l].uuid,s[l].uuid&&(u.dataset.uuid=s[l].uuid),u.attributes.checked=!0),c&&(u.unit_classes=["-status_disabled"],u.attributes.disabled=!0),o=o.add(__APP.BUILD.checkbox(u))}return o},OneEventPage.prototype.init=function(){var t=this;trimAvatarsCollection(t.$wrapper),bindRippleEffect(t.$wrapper),bindDropdown(t.$wrapper),__APP.MODALS.bindCallModal(t.$wrapper),bindCollapsing(t.$wrapper),bindPageLinks(t.$wrapper),t.$wrapper.find(".ToggleNotification").each(function(){var e=$(this);e.on("change",function(){e.prop("disabled",!0),e.prop("checked")?t.event.addNotification(e.val(),function(t){e.data("uuid",t.uuid),e.prop("disabled",!1)}):t.event.deleteNotification(e.data("uuid"),function(){e.data("uuid",void 0),e.prop("disabled",!1)})})}),t.$wrapper.find(".CancelEvent").on("click.CancelEvent",function(){t.event.changeEventStatus(OneEvent.STATUS.CANCEL,function(){t.$wrapper.find(".event_canceled_cap").removeClass("-hidden")})}),t.$wrapper.find(".CancelCancellation").on("click.CancelCancellation",function(){t.event.changeEventStatus(OneEvent.STATUS.BRING_BACK,function(){t.$wrapper.find(".event_canceled_cap").addClass("-hidden")})}),t.$wrapper.find(".ExternalLink").on("click.sendStat",function(){storeStat(t.event.id,__C.STATS.EVENT_ENTITY,__C.STATS.EVENT_OPEN_SITE)}),t.$wrapper.find(".EventMap").on("click.sendStat",function(){storeStat(t.event.id,__C.STATS.EVENT_ENTITY,__C.STATS.EVENT_OPEN_MAP)})},OneEventPage.prototype.render=function(){var t=this,e=__APP.BUILD.avatars(t.event.favored,6),n=[],i=e.length<=6?0:t.event.favored_users_count-6,a=$();if(__APP.changeTitle(t.event.title),t.event.is_favorite&&(n.push("-subscribed"),e.length>4&&n.push("-shift")),a=t.event.is_same_time?a.add(tmpl("event-additional-info",{key:"Время",value:displayTimeRange(t.event.dates[0].start_time,t.event.dates[0].end_time)})):a.add(tmpl("event-date-time",{date_times:tmpl("event-date-time-row",formatDates(t.event.dates,{date:"{D} {MMMMs}",time:"{T}"},t.event.is_same_time))})),a=a.add(tmpl("event-additional-info",{key:"Место",value:t.event.location})),a=a.add(tmpl("event-additional-info",{key:"Теги",value:__APP.BUILD.tags(t.event.tags)})),t.event.detail_info_url&&(a=a.add(tmpl("event-detail-link",{detail_info_url:t.event.detail_info_url}))),t.$wrapper.html(tmpl("event-page",$.extend({},t.event,{add_to_favorite_button:new AddToFavoriteButton(t.event.id,{is_add_avatar:!0,is_subscribed:t.event.is_favorite,classes:["event_favourite_button","-size_low","-rounded","RippleEffect"]}),subscribers:e,avatars_collection_classes:n.join(" "),favored_users_show:i?"":"-cast",favored_users_count:i,notifications:OneEventPage.buildNotifications(t.event.notifications,t.event.id,t.event.last_event_date),location_sanitized:encodeURI(t.event.location),event_edit_functions:t.event.can_edit?tmpl("event-edit-functions",t.event):"",event_registration_information:t.event.registration_required?tmpl("event-registration-info",{registration_till:moment.unix(t.event.registration_till).format("D MMMM")}):"",event_price_information:t.event.is_free?"":tmpl("event-price-info",{min_price:t.event.min_price?formatCurrency(t.event.min_price):"0"}),canceled:t.event.canceled?"":"-hidden",event_additional_fields:a,cancel_cancellation:t.event.can_edit?tmpl("button",{classes:"-color_primary RippleEffect CancelCancellation",title:"Вернуть событие"}):""}))),t.event.is_same_time){var o=t.event.nearest_event_date?moment.unix(t.event.nearest_event_date):moment.unix(t.event.first_event_date);t.calendar=new Calendar(t.$wrapper.find(".EventCalendar"),{classes:{wrapper_class:"feed_calendar_wrapper",td_class:"event_calendar_day"},selection_type:Calendar.SELECTION_TYPES.MULTI,disable_selection:!0}),t.calendar.init().setMonth(o.format("M"),o.format("YYYY")).selectDays(t.event.dates.map(function(t){return moment.unix(t.event_date).format(__C.DATE_FORMAT)}))}__APP.USER.id===-1&&$(".DropdownButton, .DropdownBox").remove(),t.init()},EditOrganizationPage.extend(Page),EditOrganizationPage.prototype.render=function(){function t(t){function e(t){t.find(".LoadByURLButton").not("-Handled_LoadByURLButton").on("click",function(){var t=$(this),e=$("#"+t.data("load_input"));t.data("url",e.val()),window.current_load_button=t,socket.emit("image.getFromURL",e.val()),window.paceOptions={catchupTime:1e4,maxProgressPerFrame:1,ghostTime:Number.MAX_SAFE_INTEGER,checkInterval:{checkInterval:1e4},eventLag:{minSamples:1,sampleCount:3e7,lagThreshold:.1}},Pace.restart()}).addClass("-Handled_LoadByURLButton")}function i(t,e,n){var i=t.closest(".EditEventImgLoadWrap"),a=i.find(".EditEventImgPreview"),o=i.find(".FileNameText"),s=i.find(".FileName"),r=i.find(".DataUrl"),d=i.find(".CallModal");a.attr("src",e),o.html("Загружен файл:<br>"+n),s.val(n),d.data("source_img",e).on("crop",function(t,e,n){a.attr("src",e),d.data("crop_data",n),r.val("data.source").data("source",a.attr("src")).trigger("change")}).trigger("click.CallModal")}bindSelect2(t),bindTabs(t),bindLimitInputSize(t),bindRippleEffect(t),bindFileLoadButton(t),e(t),t.find(".LoadImg").off("change.LoadImg").on("change.LoadImg",function(t){var e=$(t.target),n=t.target.files;if(0==n.length)return!1;for(var a,o=0;a=n[o];o++){var s=new FileReader;a.type.match("image.*")&&(s.onload=function(t){return function(n){i(e,n.target.result,t.name)}}(a),s.readAsDataURL(a))}}),t.find("#add_organization_submit").off("click.Submit").on("click.Submit",n)}function e(t){o.categories.fetchCategories({},0,function(e){var n=s.find(".EditEventOrganizations"),i=$(),a=n.find("#add_organization_type");e.forEach(function(t){i=i.add(tmpl("option",{val:t.id,display_name:t.name}))}),a.append(i).select2({containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}),t&&a.select2("val",t),i.length>1?n.removeClass("-hidden"):n.addClass("-hidden")})}function n(){function t(t,e){var n=!0,i=t.find("#edit_event_different_time").prop("checked")?t.find('[class^="TableDay_"]'):t.find(".MainTime");return t.find(":required").not(":disabled").each(function(){var t=$(this),e=t.data("maxlength");(""===t.val()||e&&t.val().length>e)&&(n&&$("body").stop().animate({scrollTop:Math.ceil(t.offset().top-150)},1e3,"swing"),handleErrorField(t),n=!1)}),i.each(function(){var t=$(this),e=t.find(".StartHours").val()+t.find(".StartMinutes").val(),i=t.find(".EndHours").val()+t.find(".EndMinutes").val();e>i&&(n&&$("body").stop().animate({scrollTop:Math.ceil(t.offset().top-150)},1e3,"swing"),showNotifier({text:"Начальное время не может быть меньше конечного",status:!1}),n=!1)}),e||t.find(".DataUrl").each(function(){var t=$(this);""===t.val()&&(n&&$("body").stop().animate({scrollTop:Math.ceil(t.closest(".EditEventImgLoadWrap").offset().top-150)},1e3,"swing",function(){showNotifier({text:"Пожалуйста, добавьте обложку организации",status:!1})}),n=!1)}),n}function e(){socket.on("utils.updateImagesDone",function(){window.location.href="/organization/"+o.organization.id}),socket.emit("utils.updateImages")}var n=s.find("#add-organization-form"),i={organization_id:null,name:null,short_name:null,type_id:null,background_filename:null,logo_filename:null,default_address:null,location:null,description:null,site_url:null,vk_url:null,facebook_url:null,email:null,filenames:{background:null,logo:null}},a=n.serializeForm(),r=t(n,!!a.organization_id);r&&($.extend(!0,i,a),i.filenames={background:i.background_filename,logo:i.logo_filename},o.organization.id?o.organization.updateOrganization(i,e):o.organization.createOrganization(i,e))}var i,a,o=this,s=this.$view,r=this.$wrapper,d=this.organization.id;if(__APP.USER.id===-1)return __APP.changeState("/feed/actual",!0,!0),null;if(window.location.pathname.contains("organization/add"))return __APP.changeState("/add/organization",!0,!0),null;if(d)i=$.extend(!0,{},this.organization),i.header_text="Редактирование организации",i.background_img_url&&(i.background_filename=i.background_img_url.split("/").reverse()[0]),i.img_url&&(i.logo_filename=i.img_url.split("/").reverse()[0]),$.extend(!0,i,i),r.html(tmpl("add-organization-page",i)),t(s),e(i.type_id),i.background_img_url&&i.img_url&&s.find(".CallModal").removeClass("-hidden").on("crop",function(t,e,n){var i=$(this),a=i.closest(".EditEventImgLoadWrap"),o=a.find(".EditEventImgPreview"),s=a.find(".DataUrl");s.val("data.source").data("source",o.attr("src")).trigger("change"),o.attr("src",e),i.data("crop_data",n)}),__APP.MODALS.bindCallModal(s),i.img_url&&toDataUrl(i.img_url,function(t){s.find("#add_organization_img_src").val(t?t:null)}),i.background_img_url&&toDataUrl(i.background_img_url,function(t){s.find("#add_organization_background_src").val(t?t:null)});else{try{a=JSON.parse(window.localStorage.getItem("organization_info"))}catch(t){a={}}i=$.extend({header_text:"Новый организатор"},a,!0),cookies.removeItem("open_add_organization","/"),window.localStorage.removeItem("organization_info"),r.html(tmpl("add-organization-page",i)),t(s),__APP.MODALS.bindCallModal(s),e()}},AddOrganizationPage.extend(EditOrganizationPage),CatalogPage.extend(Page),CatalogPage.prototype.selectCategory=function(t){this.selected_category_id=t?t:this.selected_category_id,this.$view.find(".Category").filter('[data-category-id="'+this.selected_category_id+'"]').addClass(__C.CLASSES.NEW_ACTIVE),__APP.changeState("/organizations/"+this.selected_category_id,!0),__APP.changeTitle(this.categories.getByID(this.selected_category_id).name)},CatalogPage.prototype.init=function(){function t(){bindRippleEffect(e.$view),bindPageLinks(e.$view)}var e=this,n=e.$view.find(".Category");$(window).on("subscribe.updateCatalog",function(t,n){var i=e.all_organizations.getByID(n);i.is_subscribed=!0,i.subscribed_count++}),$(window).on("unsubscribe.updateCatalog",function(t,n){var i=e.all_organizations.getByID(n);i.is_subscribed=!1,i.subscribed_count--}),t(),e.$view.find(".OrganizationsCategoriesScroll").scrollbar({disableBodyScroll:!0}),e.$view.find(".ShowAllOrganizations").on("click.showAllOrganizations",function(){n.removeClass(__C.CLASSES.NEW_ACTIVE).siblings(".SubcategoryWrap").height(0),e.selected_category_id=void 0,__APP.changeState("/organizations",!0),__APP.changeTitle(e.default_title),e.$wrapper.html(__APP.BUILD.organizationCard(e.all_organizations)),t()}),n.on("click.selectCategory",function(){var n=$(this),i=n.data("category-id"),a=n.next(".SubcategoryWrap"),o=!!a.length,s=n.hasClass(__C.CLASSES.NEW_ACTIVE);n.parent().find(".Category").not(n).removeClass(__C.CLASSES.NEW_ACTIVE).filter(".SubcategoryWrap").height(0),o?(a.height(s?0:a.children().outerHeight()),n.toggleClass(__C.CLASSES.NEW_ACTIVE)):s?(e.categories=new CategoriesCollection,e.categories.fetchCategoriesWithOrganizations(e.categories_ajax_data,e.organizations_ajax_data,0,function(){e.render()})):(e.selectCategory(i),e.$wrapper.html(__APP.BUILD.organizationCard(e.categories.getByID(i).organizations)),t())})},CatalogPage.prototype.render=function(){this.$view.find(".OrganizationsCategoriesScroll").html(__APP.BUILD.organisationsCategoriesItems(this.categories)),this.$wrapper.html(__APP.BUILD.organizationCard(this.selected_category_id?this.categories.getByID(this.selected_category_id).organizations:this.all_organizations)),this.selected_category_id?this.selectCategory(this.selected_category_id):__APP.changeTitle(this.default_title),this.init()},CatalogPage.prototype.destroy=function(){$(window).off("subscribe.updateCatalog unsubscribe.updateCatalog")},OrganizationPage.extend(Page),OrganizationPage.prototype.appendEvents=function(t,e){var n,i=this.$wrapper.find("."+t.name.capitalize()+"Events");return e.length?n=__APP.BUILD.organizationFeedEvents(e,t):(t.disable_upload=!0,$(window).off(t.scroll_event),n=tmpl("organization-feed-no-event",{text:"Больше событий нет :("})),i.append(n),i.hasClass(__C.CLASSES.NEW_ACTIVE)&&i.parent().height(i.height()),n},OrganizationPage.prototype.bindUploadEventsOnScroll=function(t){var e=this,n=$(window),i=function(){n.height()+n.scrollTop()+200>=$(document).height()&&!t.disable_upload&&(n.off(t.scroll_event),e[t.name+"_events"].fetchOrganizationsFeed(e.organization.id,e.events_fields,10,function(a){e.bindFeedEvents(e.appendEvents(t,a)),n.on(t.scroll_event,i)}))};t.disable_upload||n.on(t.scroll_event,i)},OrganizationPage.prototype.bindFeedEvents=function(t){bindRippleEffect(t),trimAvatarsCollection(t),__APP.MODALS.bindCallModal(t),bindPageLinks(t)},OrganizationPage.prototype.init=function(){var t,e=this;bindTabs(e.$wrapper),e.bindFeedEvents(e.$wrapper),__APP.MODALS.bindCallModal(e.$wrapper),e.$wrapper.find(".Tabs").on("change.tabs",function(){var t=[];$.each(e.event_types,function(){t.push(this.scroll_event)}),$(window).off(t.join(" ")),e.bindUploadEventsOnScroll(e.event_types[$(this).find(".Tab.-active").data("type")])}),e.$wrapper.find(".ExternalPage").on("click.sendStat",function(){storeStat(e.organization.id,__C.STATS.ORGANIZATION_ENTITY,__C.STATS.ORGANIZATION_OPEN_SITE)}),t=e.$wrapper.find(".SubscribersScroll").scrollbar({disableBodyScroll:!0,onScroll:function(n){n.scroll==n.maxScroll&&e.organization.subscribed.fetchOrganizationSubscribers(e.organization.id,10,{fields:"is_friend",order_by:"-is_friend,first_name"},function(n){n.length?t.append(__APP.BUILD.subscribers(n,e.organization.subscribed[e.organization.subscribed.length-1].is_friend)):t.off("scroll.onScroll"),
bindPageLinks(t)})}})},OrganizationPage.prototype.render=function(){var t=this;__APP.changeTitle(t.organization.short_name),$(".SidebarOrganizationsList").find('[data-organization_id="'+t.organization.id+'"]').find(".OrganizationCounter").addClass("-hidden"),t.$wrapper.html(tmpl("organization-wrapper",$.extend(!0,{background_image:t.organization.background_img_url?tmpl("organization-background-image",t.organization):"",subscribe_button:new SubscribeButton(t.organization.id,{is_subscribed:t.organization.is_subscribed,colors:{subscribe:"-color_accent",unsubscribe:"-color_neutral",subscribed:"-color_neutral"},classes:["-size_low","-fill","RippleEffect"]}),has_address:t.organization.default_address?"":"-hidden",redact_org_button:t.organization.role==OneUser.ROLE.ADMIN?__APP.BUILD.link({title:"Изменить",classes:["button","-fill","-color_neutral","fa_icon","fa-pencil","RippleEffect"],page:"organization/"+t.organization.id+"/edit/"}):"",hidden_for_users:t.is_admin?"":"-hidden",subscribed_blocks:__APP.BUILD.subscribers(t.organization.subscribed)},t.organization))),t.$wrapper.on("events_load.FutureEvents events_load.PastEvents events_load.DelayedEvents events_load.CanceledEvents",function(e){"FutureEvents"==e.namespace&&(t.init(),t.bindUploadEventsOnScroll(t.event_types.future)),t.bindFeedEvents(t.$wrapper.find("."+e.namespace)),++t.events_load==t.max_events_load&&t.$wrapper.off("events_load")}),t.future_events.fetchOrganizationsFeed(t.organization.id,t.events_fields,10,function(e){t.appendEvents(t.event_types.future,e),t.$wrapper.trigger("events_load.FutureEvents")}),t.past_events.fetchOrganizationsFeed(t.organization.id,t.events_fields,10,function(e){t.appendEvents(t.event_types.past,e),t.$wrapper.trigger("events_load.PastEvents")}),t.is_admin&&(t.delayed_events.fetchOrganizationsFeed(t.organization.id,t.events_fields,10,function(e){t.appendEvents(t.event_types.delayed,e),t.$wrapper.trigger("events_load.DelayedEvents")}),t.canceled_events.fetchOrganizationsFeed(t.organization.id,t.events_fields,10,function(e){t.appendEvents(t.event_types.canceled,e),t.$wrapper.trigger("events_load.CanceledEvents")}))},__APP={SERVER:{AJAX_METHOD:{GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE"},dealAjax:function(t,e,n,i,a,o){var s=this;return $.ajax({url:e,data:n,method:t,contentType:i||"application/x-www-form-urlencoded; charset=UTF-8",success:function(t){__APP.SERVER.ajaxHandler(t,function(t,e){a&&"function"==typeof a&&a.call(s,t)},__APP.SERVER.ajaxErrorHandler)},error:o})},getData:function(t,e,n,i){var a=this;return __APP.SERVER.dealAjax(__APP.SERVER.AJAX_METHOD.GET,t,__APP.SERVER.validateData(e),"application/json",function(t){void 0!=e.length&&void 0!=e.offset&&(e.offset+=e.length),n&&"function"==typeof n&&n.call(a,t)},i)},updateData:function(t,e,n,i){return __APP.SERVER.dealAjax(__APP.SERVER.AJAX_METHOD.PUT,t,e,"application/json",n,i)},addData:function(t,e,n,i,a){return n?__APP.SERVER.dealAjax(__APP.SERVER.AJAX_METHOD.POST,t,e,"application/json",i,a):__APP.SERVER.dealAjax(__APP.SERVER.AJAX_METHOD.POST,t,e,"application/x-www-form-urlencoded; charset=UTF-8",i,a)},deleteData:function(t,e,n,i){return __APP.SERVER.dealAjax(__APP.SERVER.AJAX_METHOD.DELETE,t,e,"application/json",n,i)},validateData:function(t){return t.fields&&Array.isArray(t.fields)&&(t.order_by&&(t.order_by instanceof Array?t.order_by:t.order_by.split(",")).forEach(function(e){t.fields.indexOf(e.trim().replace("-",""))===-1&&t.fields.push(e.trim().replace("-",""))}),t.fields.length?t.fields=t.fields.join(","):t.fields=void 0),t},ajaxHandler:function(t,e,n){n="undefined"!=typeof n?n:function(){console.log(t),showNotifier({text:"Упс, что-то пошло не так",status:!1})},e="function"!=typeof e?function(){}:e;try{t.status?e(t.data,t.text):n(t)}catch(t){n(t)}},ajaxErrorHandler:function(t,e,n,i){var a,o=Array.prototype.slice.call(arguments),s={};4==o.length?(a=["event","jqxhr","settings","thrownError"],o.forEach(function(t,e){s[a[e]]=t})):1==o.length?s=o[0]:o.forEach(function(t,e){s[e]=t}),console.groupCollapsed("AJAX error"),s.thrownError&&console.log("Thrown error:",s.thrownError),s.event&&s.event.type&&console.log("Error type:",s.event.type),s.event&&s.event.text&&console.log("Description:",s.event.text),s.jqxhr&&s.jqxhr.responseJSON&&s.jqxhr.responseJSON.text&&(console.log("Response:",s.jqxhr.responseJSON.text),showNotifier({text:s.jqxhr.responseJSON.text,status:!1})),s.settings&&(console.log("URL:",s.settings.url),console.log("Method:",s.settings.type)),s.stack?(console.log("Thrown error:",s.name),console.log("Description:",s.message),console.log("Error stacktrace:",s.stack)):console.error("Error stacktrace:"),console.groupEnd(),window.errors_array||(window.errors_array=[]),window.errors_array.push(s)}},EVENDATE_BEGIN:"15-12-2015",AUTH_URLS:{},TOP_BAR:new AbstractTopBar,SIDEBAR:new AbstractSidebar,USER:new CurrentUser,PREVIOUS_PAGE:new Page,CURRENT_PAGE:new Page,CURRENT_JQXHR:{},MODALS:{last_id:0,collection:{},active_modal:void 0,modal_destroyer:$.extend({adjustHeight:function(t){var e=$(window).height(),n=t+200;this.height(n>e?n:e)}},$(".modal_destroyer")),modal_wrapper:$(".modal_wrapper"),pushModal:function(t){t.id=++__APP.MODALS.last_id,__APP.MODALS.collection[t.id]=t;var e=Object.keys(__APP.MODALS.collection);e.length>5&&__APP.MODALS.collection[e[0]].destroy()},hideCurrent:function(){void 0!==__APP.MODALS.active_modal&&(__APP.MODALS.active_modal.__hide(),$("body").removeClass("-open_modal"))},bindCallModal:function($parent){$parent=$parent?$parent:$("body"),$parent.find(".CallModal").not(".-Handled_CallModal").each(function(){var $this=$(this),title=$this.data("modal_title"),modal,modal_id,modal_type=$this.data("modal_type");$this.on("click.CallModal",function(){if(modal_id=$this.data("modal_id"),__APP.MODALS.collection.hasOwnProperty(modal_id))__APP.MODALS.collection[modal_id].show();else{switch(modal_type){case"favors":modal=new FavoredModal($this.data("modal_event_id"),title);break;case"subscribers":modal=new SubscribersModal($this.data("modal_organization_id"),title);break;case"editors":modal=new EditorsModal($this.data("modal_organization_id"),title,$this.data("modal_specific_role"));break;case"map":modal=new MapModal($this.data("modal_map_location"),title);break;case"media":var type=$this.data("modal_media_type"),url=$this.data("modal_media_url");if(!url)if($this.is("img"))url=$this.attr("src"),type="image";else if($this.is("video"))type="video";else{var str=$this.css("background-image");"none"!==str&&(url=str.indexOf('"')!=-1?str.slice(str.indexOf('"')+1,str.indexOf('"',str.indexOf('"')+1)):str.slice(str.indexOf("(")+1,str.indexOf(")")),type="image")}modal=new MediaModal(url,type);break;case"cropper":modal=new CropperModal($this.data("source_img"),{aspectRatio:eval($this.data("aspect_ratio"))}),modal.modal.one("modal.close",function(){$this.removeClass("-hidden").off("click.CallModal").on("click.CallModal",function(){modal_id=$this.data("modal_id"),__APP.MODALS.collection.hasOwnProperty(modal_id)?__APP.MODALS.collection[modal_id].image_src==$this.data("source_img")?__APP.MODALS.collection[modal_id].show():(__APP.MODALS.collection[modal_id].destroy(),modal=new CropperModal($this.data("source_img"),{aspectRatio:eval($this.data("aspect_ratio"))}),$this.data("modal_id",modal.id),modal.initer=$this,modal.show()):(modal=new CropperModal($this.data("source_img"),{data:$this.data("crop_data"),aspectRatio:eval($this.data("aspect_ratio"))}),$this.data("modal_id",modal.id),modal.initer=$this,modal.show())})});break;default:modal=new StdModal(title,$this.data("modal_content"))}$this.data("modal_id",modal.id),modal.initer=$this,modal.show()}})}).addClass("-Handled_CallModal")}},BUILD:{normalizeBuildProps:function(t,e,n,i){return t=t?t:{},e?e.push("classes"):e=["classes"],n?n.push("dataset"):n=["dataset"],i?i.push("attributes"):i=["attributes"],e.forEach(function(e){t[e]=t[e]?"string"==typeof t[e]?t[e].split(" "):t[e]:[],t[e].toString=Array.toSpaceSeparatedString}),n.forEach(function(e){t[e]=t[e]?t[e]:{},t[e].toString=Array.isArray(t[e])?Array.toSpaceSeparatedString:Object.toHtmlDataSet}),i.forEach(function(e){t[e]=t[e]?t[e]:{},t[e].toString=Array.isArray(t[e])?Array.toSpaceSeparatedString:Object.toHtmlAttributes}),t},button:function(t){return tmpl("button",[].map.call(arguments,function(t){return __APP.BUILD.normalizeBuildProps(t)}))},link:function(t){return tmpl("link",[].map.call(arguments,function(t){return __APP.BUILD.normalizeBuildProps(t)}))},radioCheckbox:function(t,e){if("checkbox"==t||"radio"==t)return e=__APP.BUILD.normalizeBuildProps(e,["unit_classes"]),e.classes.indexOf("form_checkbox")==-1&&e.classes.indexOf("form_radio")==-1&&e.classes.unshift("form_"+t),e.unit_classes.unshift("form_unit"),tmpl("radio-checkbox",$.extend(e,{type:t}));throw Error('Принимаемый аргумент type может быть либо "radio" либо "checkbox", придурок')},radio:function(t){return __APP.BUILD.radioCheckbox("radio",t)},checkbox:function(t){return __APP.BUILD.radioCheckbox("checkbox",t)},tags:function(t,e){function n(t){return $.extend(!0,{},{name:t.name.toLowerCase(),page:"/search/"+encodeURIComponent("#"+t.name.toLowerCase())},e)}return e=__APP.BUILD.normalizeBuildProps(e),t instanceof Array?tmpl("tag",t.map(n)):tmpl("tag",n(t))},userTombstones:function(t,e){function n(t){e.is_link?(e.html_tag="a",e.tombstone_classes.push("link Link"),e.attributes.href="/friend/"+t.id):e.html_tag="div",$.extend(!0,t,{name:[t.first_name,t.last_name].join(" "),size:"70x70"},e)}return e=__APP.BUILD.normalizeBuildProps(e,["avatar_classes","tombstone_classes"]),t instanceof Array?t.forEach(n):n(t),tmpl("user-tombstone",t)},avatarBlocks:function(t){function e(t){t=__APP.BUILD.normalizeBuildProps(t,["avatar_classes","block_classes"]),t.is_link?(t.html_tag="a",t.block_classes.push("link Link"),t.attributes.href="/friend/"+t.id):t.html_tag="div"}return Array.isArray(t)?t.forEach(e):e(t),tmpl("avatar-block",t)},avatars:function(t,e){var n=$();return n=n.add(tmpl("subscriber-avatar",__APP.USER)),t.forEach(function(t){t.id!=__APP.USER.id&&n.length<=e&&(n=n.add(tmpl("subscriber-avatar",t)))}),n},avatarCollection:function(t,e,n){var i=__APP.BUILD.normalizeBuildProps(n);return i.avatars=tmpl("subscriber-avatar",__APP.USER),t.forEach(function(t){t.id!=__APP.USER.id&&i.avatars.length<=e&&(i.avatars=i.avatars.add(tmpl("subscriber-avatar",t)))}),tmpl("avatars-collection",i)},organizationItems:function(t,e){t=t instanceof Array?t:[t];var n=t.map(function(t){return t.counter_classes=t.new_events_count?[]:[__C.CLASSES.NEW_HIDDEN],t});return e?tmpl("organization-item",n.map(function(t){return $.extend(!0,{},t,__APP.BUILD.normalizeBuildProps(e,["avatar_classes","block_classes","counter_classes"]))})):tmpl("organization-item",n)},organizationCard:function(t){return tmpl("organization-card",t.map(function(t){return $.extend(!0,{},t,{background_image:t.background_small_img_url||t.background_img_url?__APP.BUILD.link({page:"/organization/"+t.id,classes:["organization_unit_background"],attributes:{style:"background-image: url('"+(t.background_small_img_url||t.background_img_url)+"')"}}):"",subscribe_button:new SubscribeButton(t.id,{is_subscribed:t.is_subscribed,colors:{subscribe:"-color_marginal_accent"},icons:null,classes:["-size_low","RippleEffect"]}),subscribed_text:t.subscribed_count+getUnitsText(t.subscribed_count,__LOCALES.ru_RU.TEXTS.SUBSCRIBERS),redact_org_button:t.role===OneUser.ROLE.UNAUTH||t.role===OneUser.ROLE.USER?"":__APP.BUILD.link({classes:["button","-size_low","-color_marginal_primary","fa_icon","fa-pencil","-empty","RippleEffect"],page:"organization/"+t.id+"/edit"})})}))},organizationFeedEvents:function(t,e){return tmpl("organization-feed-event",t.map(function(t){var n=moment.unix(t[e.sort_date_type]),i=__APP.BUILD.avatars(t.favored,4),a=i.length<=4?0:t.favored_users_count-4,o=e.last_date!=n.format(__C.DATE_FORMAT);return e.last_date=n.format(__C.DATE_FORMAT),$.extend({},t,{divider:o?tmpl("divider",{title:n.calendar().capitalize()}):"",add_to_favorite_button:new AddToFavoriteButton(t.id,{is_add_avatar:!0,is_subscribed:t.is_favorite,classes:["-size_low","-size_wide","-rounded","AddToFavorites","RippleEffect"]}),subscribers:i,date:n.format(__C.DATE_FORMAT),avatars_collection_classes:t.is_favorite?i.length>4?"-subscribed -shift":"-subscribed":"",favored_users_count:a,favored_users_show:a?"":"-cast",time:t.dates.reduce(function(t,e){return moment.unix(e.event_date).format(__C.DATE_FORMAT)==n.format(__C.DATE_FORMAT)&&t.push(displayTimeRange(e.start_time,e.end_time)),t},[]).join("; ")})}))},organisationsCategoriesItems:function(t){return t instanceof Array||(t=[t]),tmpl("organization-category",t.map(function(t){var e,n=!0,i=[];return t.organizations&&t.organizations.new_events_count?n?(e=t.organizations.reduce(function(t,e){return t+e.new_events_count},0),i=e?["counter"]:["counter",__C.CLASSES.NEW_HIDDEN]):i=["fa_icon","fa-angle-down","-empty"]:(e="",i=[__C.CLASSES.NEW_HIDDEN]),{category_id:t.id,category_name:t.name,order_position:t.order_position,aside_classes:i,new_events_count:n?"+"+e:""}}))},subscribers:function(t,e){return tmpl("subscriber",t.map(function(t,n){var i="undefined"==typeof e||e!=t.is_friend;return e=t.is_friend,$.extend({divider:i?tmpl("subscriber-divider",{label:t.is_friend?"Друзья":"Все подписчики"}):"",avatar_block:__APP.BUILD.avatarBlocks({avatar_classes:["-size_40x40","-rounded","-bordered"],name:[t.first_name,t.last_name].join(" "),avatar_url:t.avatar_url}),name:[t.first_name,t.last_name].join(" ")},t)}))},feedEventCards:function(t){var e;return t=t instanceof Array?t:[t],e=tmpl("feed-event",t.map(function(t){var e=__APP.BUILD.avatars(t.favored,4),n=[],i=e.length<=4?0:t.favored_users_count-4,a=[];return t.is_favorite&&(n.push("-subscribed"),e.length>4&&n.push("-shift")),a.push({text:displayDateRange(t.dates[0].event_date,t.dates[t.dates.length-1].event_date)+(t.is_same_time?", "+displayTimeRange(t.dates[0].start_time,t.dates[0].end_time):"")}),t.registration_required&&a.push({text:"Регистрация до "+moment.unix(t.registration_till).calendar().capitalize()}),t.is_free?a.push({text:"Бесплатно"}):a.push({text:"Цена от "+(t.min_price?formatCurrency(t.min_price):0)+" руб."}),$.extend(!0,{add_to_favorite_button:new AddToFavoriteButton(t.id,{is_add_avatar:!0,is_subscribed:t.is_favorite,classes:["-size_low","-size_wide","-rounded","RippleEffect"]}),subscribers:e,avatars_collection_classes:n.join(" "),favored_users_show:i?"":"-cast",favored_users_count:i,feed_event_infos:tmpl("feed-event-info",a)},t)})),t.forEach(function(t,n){e.eq(n).appear(function(){storeStat(t.id,__C.STATS.EVENT_ENTITY,__C.STATS.EVENT_VIEW)},{accY:100})}),__APP.USER.id===-1&&e.find(".HideEvent").remove(),e},modal:function(t){var e;t=__APP.BUILD.normalizeBuildProps(t,["content_classes"]);var n={modal_type:t.type,modal_content:t.content,modal_classes:t.classes,modal_content_classes:t.content_classes};return t.header?n.modal_header=t.header:t.title?n.modal_header=tmpl("modal-header",{title:t.title,close_button:__APP.BUILD.button({classes:["-color_default","-empty","-modal_destroyer","CloseModal","RippleEffect"],title:"×"})}):n.header="",t.footer?n.modal_footer=t.footer:t.footer_buttons?n.modal_footer=tmpl("modal-footer",{footer_buttons:t.footer_buttons}):n.modal_footer="",e=tmpl("modal",n),t.width&&e.width(t.width),e}},renderHeaderTabs:function(t){var e=$("#main_header_bottom").find(".HeaderTabsWrapper");t=t instanceof Array?t:[t],t.forEach(function(t){t=__APP.BUILD.normalizeBuildProps(t),t.classes.push("tab","Tab"),window.location.pathname.contains(t.page)&&t.classes.push(__C.CLASSES.NEW_ACTIVE)}),e.html(tmpl("tabs-header",{color:"default",tabs:tmpl("link",t)})),bindTabs(e),bindPageLinks(e)},changeTitle:function(t){var e,n=$();switch("string"==typeof t&&(e=t,t=t.split(" > ")),!0){case t instanceof Array:t.forEach(function(e,i){i&&(n=n.add('<span class="title_chunk fa_icon fa-angle-right -empty"></span>')),"object"==typeof e?(e.toString=Array.isArray(e)?Array.toSpaceSeparatedString:Object.toHtmlDataSet,n=n.add('<a href="'+e.page+'" class="title_chunk link Link">'+e.title+"</a>"),t[i]=e.title):n=n.add('<span class="title_chunk">'+e+"</span>")}),e||(e=t.join(" > "));break;case t instanceof jQuery:n=t,t.each(function(){this.text()&&(e+=this.text()+" ")})}bindPageLinks($("#page_title").html(n)),$("title").text(e?"Evendate. "+e:"Evendate")},changeState:function(t,e,n){t?(t=0==t.indexOf("/")?t:"/"+t,e?History.replaceState({_index:History.getCurrentIndex()},"",t):History.pushState({_index:History.getCurrentIndex()},"",t),(!e||e&&n)&&__APP.reInit()):console.error("Need to pass page name")},init:function(){var t=$(".SidebarNavItem");__APP.CURRENT_PAGE=Page.routeNewPage(window.location.pathname),__APP.CURRENT_PAGE.show(),t.removeClass(__C.CLASSES.NEW_ACTIVE).filter(function(){return 0===window.location.pathname.indexOf(this.getAttribute("href"))}).addClass(__C.CLASSES.NEW_ACTIVE)},reInit:function(){$(window).off("scroll"),unbindPageLinks(),__APP.PREVIOUS_PAGE=__APP.CURRENT_PAGE,__APP.PREVIOUS_PAGE.destroy(),__APP.init(),__APP.CURRENT_PAGE instanceof SearchPage||$("#search_bar_input").val("")}},__C={CLASSES:{ACTIVE:"active",NEW_ACTIVE:"-active",DISABLED:"disabled",NEW_DISABLED:"-disabled",HIDDEN:"hidden",NEW_HIDDEN:"-hidden"},DATE_FORMAT:"YYYY-MM-DD",COLORS:{PRIMARY:"#2e3b50",MUTED:"#3e4d66",MUTED_80:"#657184",MUTED_50:"#9fa6b3",MUTED_30:"#c5c9d1",TEXT:"#4a4a4a",ACCENT:"#f82969",ACCENT_ALT:"#ff5f9e",FRANKLIN:"#28be84",FRANKLIN_ALT:"#23d792"},STATS:{EVENT_VIEW:"view",EVENT_VIEW_DETAIL:"view_detail",EVENT_OPEN_SITE:"open_site",EVENT_OPEN_MAP:"open_map",ORGANIZATION_OPEN_SITE:"open_site",EVENT_ENTITY:"event",ORGANIZATION_ENTITY:"organization"},ACTION_NAMES:{fave:["добавил(а) в избранное"],unfave:["удалил(а) из избранного"],subscribe:["добавил(а) подписки"],unsubscribe:["удалил(а) подписки"]},ENTITIES:{EVENT:"event",ORGANIZATION:"organization"}},__LOCALES={ru_RU:{TEXTS:{BUTTON:{REMOVE_FAVORITE:"Убрать",ADD_FAVORITE:"В избранное",FAVORED:"В избранном",ADD_SUBSCRIPTION:"Подписаться",REMOVE_SUBSCRIPTION:"Отписаться",SUBSCRIBED:"Подписан"},SUBSCRIBERS:{NOM:" подписчик",GEN:" подписчика",PLU:" подписчиков"},PEOPLE:{NOM:" человек",GEN:" человека",PLU:" человек"},FAVORED:{NOM:" участник",GEN:" участника",PLU:" участников"}},DATE:{DATE_FORMAT:"DD.MM.YYYY",MONTH_SHORT_NAMES:["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"],MONTH_NAMES:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]}}},window.paceOptions={ajax:!1,document:!1,eventLag:!1,elements:{},search_is_active:!1,search_query:null,search_xhr:null},__stats=[],askToSubscribe=null,$(document).ajaxStart(function(){Pace.restart()}).ajaxError(function(t,e,n,i){i&&"abort"==i||__APP.SERVER.ajaxErrorHandler(t,e,n,i)}).ready(function(){var t=window.OneSignal||[];t.push(["init",{appId:"7471a586-01f3-4eef-b989-c809700a8658",autoRegister:!1,notifyButton:{enable:!1}}]),t.push(function(){t.isPushNotificationsSupported()&&t.isPushNotificationsEnabled(function(e){e||(window.askToSubscribe=function(){t.push(function(){t.on("subscriptionChange",function(e){e&&t.getUserId(function(t){$.ajax({url:"api/v1/users/me/devices",type:"PUT",data:{device_token:t,client_type:"browser",model:navigator.appVersion?navigator.appVersion:null,os_version:navigator.platform?navigator.platform:null},global:!1})})})}),t.push(["registerForPushNotifications"]),event.preventDefault()})})}),void 0!=window.moment&&(moment.locale(navigator.language),moment.tz.setDefault("Europe/Moscow"),moment.updateLocale("ru",{monthsShort:__LOCALES.ru_RU.DATE.MONTH_SHORT_NAMES,calendar:{sameDay:"[Сегодня]",nextDay:"[Завтра]",lastDay:"[Вчера]",nextWeek:"dddd",lastWeek:"D MMMM",sameElse:"D MMMM"}})),void 0!=window.Highcharts&&Highcharts.setOptions({lang:{shortMonths:__LOCALES.ru_RU.DATE.MONTH_SHORT_NAMES}}),History.Adapter.bind(window,"statechange",function(){History.getCurrentIndex()-1!==History.getState().data._index&&__APP.reInit()}),__APP.USER.fetchUserWithSubscriptions([],void 0,function(){this.id===-1?(__APP.TOP_BAR=new TopBarNoAuth,__APP.SIDEBAR=new SidebarNoAuth):(__APP.TOP_BAR=new TopBar,__APP.SIDEBAR=new Sidebar),__APP.SERVER.getData("/auth.php",{action:"get_urls",mobile:isNotDesktop()},function(t){__APP.AUTH_URLS=t,__APP.TOP_BAR.init(),__APP.SIDEBAR.init(),__APP.init()}),bindPageLinks()}),setInterval(function(){if(0!=window.__stats.length){var t=window.__stats;window.__stats=[],$.ajax({url:"/api/v1/statistics/batch",data:JSON.stringify(t),type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",error:function(){window.__stats.concat(t)}})}},5e3)});