function extending(){var t=Array.prototype.pop.call(arguments),e=Array.prototype.slice.call(arguments);return e.forEach(function(e){t.prototype=$.extend(Object.create(e.prototype),t.prototype)}),t.prototype.constructor=t,t}function extendingJQuery(t){return t.prototype=$.extend(Object.create(jQuery.prototype),t.prototype),t.prototype.constructor=t,t.prototype.pushStack=function(t){var e=jQuery.merge(this.get(0)==t?new this.constructor:$(),t);return e.prevObject=this,e.context=this.context,e},t}function tmpl(t,e,i,n){function a(t){return String(t+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function o(t,e){var i={},n={},o=c[(/<([\w:]+)/.exec(t)||["",""])[1].toLowerCase()]||c._default,s=o[0];for($.each(e,function(t,e){"string"==$.type(e)?n[t]=a(e):e instanceof jQuery?e.length&&(i[t]=e,e.is("tr")?n[t]='<tbody id="JQ_tmpl_'+t+'"></tbody>':e.is("span")?n[t]='<span id="JQ_tmpl_'+t+'"></span>':e.is("option")?n[t]='<optgroup id="JQ_tmpl_'+t+'"></optgroup>':n[t]='<div id="JQ_tmpl_'+t+'"></div>'):null==e?n[t]="":n[t]=e}),t=$(t?o[1]+t.format(n)+o[2]:""),$.each(i,function(e,i){t.find("#JQ_tmpl_"+e).append(i),i.is("tr")?i.parent("tbody").removeAttr("id"):i.unwrap()});s--;)t=t.children();return t}e=e?e:{},i=i instanceof Element?$(i):i;var s,r=$("#tmpl-"+t),c={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[1,"<div>","</div>"]},l=$();return c.tbody=c.tfoot=c.colgroup=c.caption=c.thead,c.th=c.td,r.length?(s=r.html().replace(/(?:\/\*(?:[\s\S]*?)\*\/)|(?:([\s;])+\/\/(?:.*)$)/gim,"").replace(/\\s{2,}|\t|\n|\r/gim,"").trim(),l=Array.isArray(e)?$.makeSet(e.map(function(t){return o(s,t)})):o(s,e),null==i?l:("prepend"===n?i.prepend(l):i.append(l),l)):(console.group("tmpl_error"),console.log("error in "+t),console.log("items",e),console.log("addTo",i),console.log("inputs",{template_type:t,items:e,addTo:i,direction:n}),console.groupEnd(),$())}function parseUri(t,e){var i={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},n=i.parser[i.strictMode?"strict":"loose"].exec(t),a={},o=14;for(e&&$.extend(i,e);o--;)a[i.key[o]]=n[o]||"";return a[i.q.name]={},a[i.key[12]].replace(i.q.parser,function(t,e,n){e&&(a[i.q.name][e]=n)}),Object.defineProperties(a,{wo_query:{get:function(){return a[i.key[1]]+"://"+a[i.key[6]]+a[i.key[9]]}}}),a}function storeStat(t,e,i){window.__stats=window.__stats?window.__stats:[],window.__stats.push({entity_id:t,entity_type:e,event_type:i})}function getUnitsText(t,e){t=Math.abs(t);var i="";return i=t.toString().indexOf(".")>-1?e.GEN:t%10==1&&t%100!=11?e.NOM:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?e.GEN:e.PLU}function getGenderText(t,e){if("string"==typeof e)return e;switch(t){default:case OneUser.GENDER.MALE:return e.MAS;case OneUser.GENDER.FEMALE:return e.FEM;case OneUser.GENDER.NEUTRAL:return e.NEU}}function formatDates(t,e,i){function n(t,e,i,n,a){var o,s=["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"],r={d:e,D:e,t:i,T:i,M:n+1,MM:n+1>9?n+1:"0"+(n+1),MMM:__LOCALES.ru_RU.DATE.MONTH_SHORT_NAMES[n].toLocaleLowerCase(),MMMM:__LOCALES.ru_RU.DATE.MONTH_NAMES[n].toLocaleLowerCase(),MMMMs:s[n],Y:a,YY:a.substr(2,2),YYYY:a};return"string"==typeof t?o=t.format(r).capitalize():Array.isArray(t)?o=t.map(function(t){return t.format(r).capitalize()}):t instanceof jQuery?(o=$(),t.each(function(t,e){var i=$(e).clone();i.text(e.innerText.format(r).capitalize()),o=o.add(i)})):(o={},$.each(t,function(t,e){o[t]=e.format(r).capitalize()})),o}var a,o,s,r,c,l,d=!1,_=[],u=t.length-1,h={},f=[];return e||(e={date:"{D} {MMMMs} {YYYY}",time:"{T}"}),"string"==typeof e?d=e.contains(/\{T\}|\{t\}/)&&void 0!==t[0].start_time:(d=void 0!==t[0].start_time,$.each(e,function(){d=d||this.contains(/\{T\}|\{t\}/)})),i?(d&&(c=t[0].end_time?displayTimeRange(t[0].start_time,t[0].end_time):displayTimeRange(t[0].start_time)),t.forEach(function(t,e){a=moment.unix(t.event_date),s=a.year(),r=a.month(),h[s]||(h[s]={}),h[s][r]||(h[s][r]=[]),o?r!==o.month()||o.diff(a,"days")!==-1?(h[o.year()][o.month()].push(_.join("-")),_[0]=a.format("D")):_[1]=a.format("D"):_[0]=a.format("D"),e===u?h[s][r].push(_.join("-")):o=a}),$.each(h,function(t,i){$.each(i,function(i,a){f.push(n(e,a.join(", "),d?c:"",i,t))})})):(t.forEach(function(t,e){a=moment.unix(t.event_date),s=a.year(),r=a.month(),c=t.end_time?displayTimeRange(t.start_time,t.end_time):displayTimeRange(t.start_time),h[s]||(h[s]={}),h[s][r]||(h[s][r]=[]),o?r!==o.month()||o.diff(a,"days")!==-1||l!==c?(h[o.year()][o.month()].push({date:_.join("-"),time:l}),_=[a.format("D")]):_[1]=a.format("D"):_=[a.format("D")],e===u?h[s][r].push({date:_.join("-"),time:c}):(o=a,l=c)}),$.each(h,function(t,i){$.each(i,function(i,a){var o,s=[],r=[];$.each(a,function(t,e){o?e.time!=o?(s.push({date:r.join(", "),time:o}),r=[e.date]):r.push(e.date):r=[e.date],t===a.length-1?s.push({date:r.join(", "),time:e.time}):o=e.time}),$.each(s,function(a,o){f.push(n(e,o.date,d?o.time:"",i,t))})})})),f}function trimSeconds(t){return t=t.split(":"),3==t.length&&(t=t.splice(0,2)),t.join(":")}function displayDateRange(t,e){var i=moment.unix(t),n=moment.unix(e),a=moment();return i.isSame(n,"year")?i.isSame(n,"month")?i.isSame(n,"day")?i.format(i.isSame(a,"year")?"D MMM":"D MMM YYYY"):i.format("D")+"-"+n.format(i.isSame(a,"year")?"D MMM":"D MMM YYYY"):i.format("D MMM")+" - "+n.format(i.isSame(a,"year")?"D MMM":"D MMM YYYY"):i.format("MMM YYYY")+" - "+n.format("MMM YYYY")}function displayTimeRange(t,e){return e?e!=t||"00:00:00"!=t&&"00:00"!=t?trimSeconds(t)+" - "+trimSeconds(e):"Весь день":trimSeconds(t)}function formatCurrency(t,e,i,n,a){t=+t||0,e=e||" ",i=i||".";var o=(""+t).split(".")[1],s=t<0?"-":"",r=parseInt(Math.abs(t),10)+"",c=r.length>3?r.length%3:0;return""+(n?n+e:"")+s+(c?r.substr(0,c)+e:"")+r.substr(c).replace(/(\d{3})(?=\d)/g,"$1"+e)+(o?i+o:"")+(a?e+a:"")}function formatTicketNumber(t){return(""+t).replace(/(\d{3})/g,"$1 ").trim()}function guid(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}function isFormValid(t){t=t instanceof Element?$(t):t;var e=!0,i=t.find("input, textarea");return t[0].checkValidity()||i.each(function(t,i){(i.required&&(""===i.value.trim()||!i.checkValidity())||""!==i.value.trim()&&!i.checkValidity())&&(handleErrorField(i),e=!1)}),e}function getFilenameFromURL(t){return t?t.split("\\").pop().split("/").pop():""}function isBase64(t){return t.contains(";base64,")}function isFunction(t){return t&&"function"==typeof t}function range(t,e,i){var n=[];for(e=e?e:0,i=i?i:1;e!==t;e+=i)n.push(e);return n}function localeFromNamespace(t,e,i){for(var n in e)if(e.hasOwnProperty(n)&&e[n]===t)return i[n];return""}function outerAjax(t,e,i){e=e||{};var n;return e.fields instanceof Fields&&(e.fields=e.fields.toString()),n=$.ajax({url:t,data:e,method:"GET",contentType:i||"application/x-www-form-urlencoded; charset=UTF-8"}),n.then(function(t,e,i){return t}).promise()}function bindLimitInputSize(t){t=t?t:$("body"),t.find(".LimitSize").not(".-Handled_LimitSize").each(function(t,e){var i=$(e),n=i.closest(".form_unit"),a=i.data("maxlength"),o=i.siblings(".form_prompt");o.length?o.text(i.val().length+"/"+a):(i.after($("<p>").addClass("form_prompt").text(i.val().length+"/"+a)),o=i.siblings(".form_prompt")),i.on("input",function(){var t=i.val().length;if(i.is("textarea")){var e=i.val().match(/\n/g);t=e?t+e.length:t}t>a?n.addClass("-status_error"):n.hasClass("-status_error")&&n.removeClass("-status_error"),o.text(t+"/"+a)})}).addClass("-Handled_LimitSize")}function initSelect2(t,e){var i={containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"};t.hasClass("-Handled_ToSelect2")&&t.select2("destroy"),e&&$.extend(!0,i,e),t.select2(i).addClass("-Handled_ToSelect2")}function initTimeInput(t){function e(){var t=$(this);"0"==t.val()||""===t.val()?t.val("00"):t.val()<=9&&t.val("0"+parseInt(t.val()))}var i=$(t),n=i.find("input").eq(0),a=i.find("input").eq(1);n.inputmask("Regex",{regex:"([01]?[0-9]|2[0-3])"}).on("keyup",function(){(n.val()>2||"00"==n.val())&&(a.focus(),n.trigger("blur"))}).on("blur",e),a.inputmask("Regex",{regex:"[0-5][0-9]"}).on("blur",e),i.addClass("-Handled_TimeInput")}function trimAvatarsCollection(t){t=t?t:$("body"),t.find(".AvatarsCollection").each(function(){var t=$(this),e=t.hasClass("-shifted"),i=t.hasClass("-subscribed"),n=t.find(".avatar"),a=n.outerWidth(),o=n.length,s=6;(i||e)&&o<t.data("max_amount")?t.width(1===o?a*o:a*o-s*(o-1)):t.width(1===o?0:a*(o-1)-s*(o-2)),t.addClass("-trimmed")})}function bindDatePickers(t){t=t?t:$("body"),t.find(".DatePicker").not(".-Handled_DatePicker").each(function(t,e){new DatePicker(e,$(e).data()).init()}).addClass("-Handled_DatePicker")}function bindTimeInput(t){t=t?t:$("body"),t.find(".TimeInput").not(".-Handled_TimeInput").each(function(t,e){initTimeInput(e)}).addClass("-Handled_TimeInput")}function bindTabs(t){t=t?t:$("body"),t.find(".Tabs").not(".-Handled_Tabs").each(function(t,e){var i,n,a,o,s=$(e),r=s.data("tabs_id"),c=!!s.data("focus_on_change"),l=new MutationObserver(function(t){var e,i;t.forEach(function(t){i=$(t.target),e=i.parents(".TabsBody"),e=i.hasClass("TabsBody")?e.add(i):e,e.each(function(t,e){var i=$(e);i.hasClass(__C.CLASSES.ACTIVE)&&(s.addClass("-in_progress"),i.parent().height(i.outerHeight()))})})});r?(i=s.find('.TabsBodyWrapper[data-tabs_id="'+r+'"]'),n=i.children(".TabsBody"),a=s.find('.HeaderTabs[data-tabs_id="'+r+'"]'),o=a.children(".Tab")):(i=s.find(".TabsBodyWrapper:first"),n=i.children(".TabsBody"),a=s.find(".HeaderTabs:first"),o=a.children(".Tab")),Object.defineProperties(s,{currentTabsIndex:{get:function(){return o.index(o.filter("."+__C.CLASSES.ACTIVE))}},tabsCount:{get:function(){return o.length}}}),s.setToTab=function(t){var e=o.eq(t),i=n.eq(t);e.length&&!e.hasClass(__C.CLASSES.ACTIVE)&&(o.removeClass(__C.CLASSES.ACTIVE),n.removeClass(__C.CLASSES.ACTIVE),e.addClass(__C.CLASSES.ACTIVE),i.addClass(__C.CLASSES.ACTIVE),s.trigger("change.tabs"),c&&scrollTo(i,400))},s.nextTab=function(){s.setToTab(s.currentTabsIndex+1)},s.prevTab=function(){s.setToTab(s.currentTabsIndex-1)},o.filter("."+__C.CLASSES.ACTIVE).length||o.eq(0).addClass(__C.CLASSES.ACTIVE),n.removeClass(__C.CLASSES.ACTIVE).eq(s.currentTabsIndex).addClass(__C.CLASSES.ACTIVE),i.height(n.filter("."+__C.CLASSES.ACTIVE).outerHeight()),i.on("transitionend webkitTransitionEnd",function(){s.removeClass("-in_progress"),s.trigger("progress_end")}),n.each(function(t,e){l.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]})}),o.on("click",function(){s.setToTab(o.index(this))}),s.data("instance",s)}).addClass("-Handled_Tabs")}function bindShareButtons(t){t=t?t:$("body"),t.find(".ShareButton").not(".-Handled_ShareButton").each(function(t,e){var i=$(e);i.on("click",function(){window.open(i.data("href"),i.data("title"),"width=600,height=440,resizable=yes,scrollbars=no,status=no")})}).addClass("-Handled_ShareButton")}function bindSelect2(t){t=t?t:$("body"),t.find(".ToSelect2").not(".-Handled_ToSelect2").each(function(t,e){initSelect2($(e))}).addClass("-Handled_ToSelect2")}function bindRippleEffect(t){t=t?t:$("body"),t.find(".RippleEffect").not(".-Handled_RippleEffect").on("click.RippleEffect",function(t){var e,i,n,a,o=$(this);0==o.children(".Ripple").length&&o.prepend('<span class="ripple Ripple"></span>'),e=o.children(".Ripple"),e.removeClass("animate"),e.height()||e.width()||(i=Math.max(o.outerWidth(),o.outerHeight()),e.css({height:i,width:i})),n=t.pageX-o.offset().left-e.width()/2,a=t.pageY-o.offset().top-e.height()/2,e.css({top:a+"px",left:n+"px"}).addClass("animate"),setTimeout(function(){e.removeClass("animate")},650)}).addClass("-Handled_RippleEffect")}function bindDropdown(t){t=t?t:$("body"),t.find(".DropdownButton").not(".-Handled_DropdownButton").each(function(){var t=$(this),e=t.data(),i=$(".DropdownBox").filter('[data-dropdown_id="'+e.dropdown+'"]');if(i.data($.extend({},i.data(),e)),i.closeDropbox=function(){$("body").off("mousedown.CloseDropdown"),$(document).off("keyup.CloseDropdown"),i.removeClass("-show"),t.addClass("-dropdown_active")},e.hasOwnProperty("ddWidth")&&("self"==e.ddWidth?i.width(t.outerWidth()):(isFinite(e.ddWidth)||0===e.ddWidth.search(/^[1-9]\d*%$|^0%$/))&&i.width(e.ddWidth)),e.hasOwnProperty("ddPosX")||e.hasOwnProperty("ddPosY")){var n=t.position();if(e.hasOwnProperty("ddPosX")){var a;"self.center"==e.ddPosX?a=n.left+t.outerWidth()/2-i.outerWidth()/2:"center"==e.ddPosX?a=i.parent().outerWidth()/2-i.outerWidth()/2:isFinite(e.ddPosX)&&(a=e.ddPosX),i.css("left",a)}if(e.hasOwnProperty("ddPosY")){var o;"self.center"==e.ddPosY?o=n.top+t.outerHeight()/2-i.outerHeight()/2:"center"==e.ddPosY?o=i.parent().outerHeight()/2-i.outerHeight()/2:isFinite(e.ddPosY)&&(o=n.top+t.outerHeight()+e.ddPosY),i.css("top",o)}}i.find(".CloseDropdown").on("click.CloseDropdown",i.closeDropbox),t.on("click.Dropdown",function(){i.addClass("-show"),t.addClass("-dropdown_active"),$("body").on("mousedown.CloseDropdown",function(t){$(t.target).closest(".DropdownBox").length||i.closeDropbox()}),$(document).on("keyup.CloseDropdown",function(t){27==t.keyCode&&i.closeDropbox()})})}).addClass("-Handled_DropdownButton")}function bindFileLoadButton(t){t=t?t:$("body"),t.find(".FileLoadButton").not(".-Handled_FileLoadButton").click(function(t){var e=$(this);e.children("input").get(0).click()}).addClass("-Handled_FileLoadButton")}function bindCollapsing(t){t=t?t:$("body"),t.find(".Collapsing").not(".-Handled_Collapsing").each(function(){function t(){n.addClass("-in_progress"),r.hasClass(__C.CLASSES.ACTIVE)?n.height(i):n.height(a.outerHeight()),n.toggleClass("-opened"),r.toggleClass(__C.CLASSES.ACTIVE)}function e(){"change"===s&&o.prop("checked",!o.prop("checked"))}var i,n,a,o,s,r=$(this),c=r.data("collapsing_id"),l=new MutationObserver(function(t){var e,i;t.forEach(function(t){i=$(t.target),e=i.parents(".CollapsingContent"),e=i.hasClass("CollapsingContent")?e.add(i):e,e.each(function(t,e){var i=$(e),n=i.parent();n.hasClass("-opened")&&n.addClass("-in_progress").height(i.outerHeight())})})});c?(n=r.find('.CollapsingWrapper[data-collapsing_id="'+c+'"]'),o=r.find('.CollapsingTrigger[data-collapsing_id="'+c+'"]')):(n=r.find(".CollapsingWrapper:first"),o=r.find(".CollapsingTrigger:first")),a=n.children(".CollapsingContent"),s=o.is(":checkbox")||o.is(":radio")?"change":"click",n.hasClass("-fading")?(i=r.data("defaultHeight")<a.height()?r.data("defaultHeight"):a.height(),!r.hasClass(__C.CLASSES.ACTIVE)&&n.height()<i&&n.height(i)):i=r.data("defaultHeight")?r.data("defaultHeight"):0,r.openCollapsing=function(){r.hasClass(__C.CLASSES.ACTIVE)||(e(),t())},r.closeCollapsing=function(){r.hasClass(__C.CLASSES.ACTIVE)&&(e(),t())},o.on(s+".toggleCollapsing",function(){t()}),n.on("click",function(){r.openCollapsing()}).on("transitionend webkitTransitionEnd",function(){n.removeClass("-in_progress")}),l.observe(n.get(0),{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]}),r.data("instance",r)}).addClass("Handled_Collapsing")}function bindControlSwitch(t){t=t?t:$("body"),t.find(".Switch").not(".-Handled_Switch").each(function(e,i){var n=$(i),a=n.data("switch_id"),o=t.find('.Switching[data-switch_id="'+a+'"]');n.on("change.Switch",function(){o.is("fieldset")?o.prop("disabled",!o.prop("disabled")):o.toggleStatus("disabled")})}).addClass("-Handled_Switch")}function bindCallModal(t){return t=t?t:$("body"),t.find("."+__C.CLASSES.HOOKS.CALL_MODAL).not("."+__C.CLASSES.HOOKS.HANDLED+__C.CLASSES.HOOKS.CALL_MODAL).each(function(){var t=$(this);t.on("click.CallModal",function(){var t=$(this),e=t.data(),i=e.modal_title,n=e.modal,a=e.modal_type;if(!n){switch(a){case __C.MODAL_TYPES.FAVORS:n=new FavoredModal(e.modal_event_id,i);break;case __C.MODAL_TYPES.SUBSCRIBERS:n=new SubscribersModal(e.modal_organization_id,i);break;case __C.MODAL_TYPES.EDITORS:n=new EditorsModal(e.modal_organization_id,i,e.modal_specific_role);break;case __C.MODAL_TYPES.MAP:n=new MapModal(e.modal_map_location,i);break;case __C.MODAL_TYPES.MEDIA:var o=e.modal_media_type,s=e.modal_media_url;if(!s)if(t.is("img"))s=t.attr("src"),o="image";else if(t.is("video"))o="video";else{var r=t.css("background-image");"none"!==r&&(s=r.indexOf('"')!=-1?r.slice(r.indexOf('"')+1,r.indexOf('"',r.indexOf('"')+1)):r.slice(r.indexOf("(")+1,r.indexOf(")")),o="image")}n=new MediaModal(parseUri(s).wo_query,o);break;case __C.MODAL_TYPES.CROPPER:n=new CropperModal(e.source_img,e);break;case __C.MODAL_TYPES.FRIENDS_LIST:n=new FriendsListModal(e.modal_entity);break;case __C.MODAL_TYPES.SUBSCRIBERS_LIST:n=new SubscriptionsListModal(e.modal_entity);break;case __C.MODAL_TYPES.TICKET:n=new TicketsModal(e.tickets||e.ticket_uuid);break;case __C.MODAL_TYPES.ADD_STAFF:n=new AddStaffModal(e.modal_org_id,e.modal_role);break;default:n=new StdModal(i,e.modal_content,e.modal_style)}t.data("modal",n)}n.show()})}).addClass(__C.CLASSES.HOOKS.HANDLED+__C.CLASSES.HOOKS.CALL_MODAL)}function bindPageLinks(t){t=t?t:$("body");var e=t.is(".Link")?t:t.find(".Link");return e.not(".-Handled_Link").on("click.pageRender",function(t){var e=$(this);return!e.hasClass(__C.CLASSES.DISABLED)&&void(1===t.which&&(t.preventDefault(),__APP.changeState(e.attr("href"))))}).addClass("-Handled_Link")}function handleErrorField(t){var e;return t instanceof jQuery?t.is(".form_unit")?(t.closest(".form_unit").hasClass("-status_error")||(e=t.find("input, select, textarea"),t.addClass("-status_error").off("input.ClearError change.ClearError").one("input.ClearError change.ClearError",function(){t.off("input.ClearError change.ClearError").removeClass("-status_error"),e.off("blur.ClearError")}),e.off("blur.ClearError").one("blur.ClearError",function(){""!==$(this).val().trim()&&t.trigger("input.ClearError")})),t):t.closest(".form_unit").length?handleErrorField(t.closest(".form_unit")):t:handleErrorField($(t))}function toDataUrl(t,e){var i=new XMLHttpRequest;i.responseType="blob",i.onload=function(){var t=new FileReader;t.onloadend=function(){e(t.result)},t.readAsDataURL(i.response)},i.open("GET",t),i.send()}function showNotifier(t){$.notify({message:t.text,pos:t.pos?t.pos:"top-right",status:t.status?"success":"danger"})}function isNotDesktop(){var t=!1;return function(e){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0)}(navigator.userAgent||navigator.vendor||window.opera),t}function scrollTo(t,e,i){var n;return n=t instanceof jQuery?t.offset().top-150:t-150,!i||i instanceof Function||(i=function(){}),$("body").stop().animate({scrollTop:Math.ceil(n)},{duration:e?e:400,easing:"swing",complete:i}),n}function isScrollRemain(t){return t=t?t:200,$(window).height()+$(window).scrollTop()+ +t>=$(document).height()}function setDefaultValue(t,e){return t="undefined"==typeof t?e:t}function checkRedirect(t,e,i){var n=window.location.pathname;return t&&i^n.contains(t)?__APP.changeState(e,!0,!0):__APP.USER.isLoggedOut()&&n.contains("/admin")?__APP.changeState("/",!0,!0):!n.contains("/statistics")||__APP.changeState(n.replace("statistics","admin"),!0,!0)}__C={CLASSES:{MATERIAL:"material",FLOATING_MATERIAL:"material -floating_material",IMG_HOLDER:"img_holder",TEXT_COLORS:{ACCENT:"-text_color_accent"},COLORS:{ACCENT:"-color_accent",PRIMARY:"-color_primary",DEFAULT:"-color_default",NEUTRAL:"-color_neutral",NEUTRAL_ACCENT:"-color_neutral_accent",MARGINAL:"-color_marginal",MARGINAL_ACCENT:"-color_marginal_accent",MARGINAL_PRIMARY:"-color_marginal_primary",MARGINAL_FRANKLIN:"-color_marginal_franklin",MARGINAL_BUBBLEGUM:"-color_marginal_bubble_gum"},ALIGN:{LEFT:"-align_left",CENTER:"-align_center",RIGHT:"-align_right"},UNIVERSAL_STATES:{EMPTY:"-empty",ROUNDED:"-rounded",SHADOWED:"-shadowed",BORDERED:"-bordered",TRANSFORM_UPPERCASE:"-transform_uppercase"},STATUS:{SUCCESS:"-status_success",WARNING:"-status_warning",PENDING:"-status_pending",ERROR:"-status_error",DISABLED:"-status_disabled"},SIZES:{X30:"-size_30x30",X40:"-size_40x40",X50:"-size_50x50",X55:"-size_55x55",LOW:"-size_low",WIDE:"-size_wide",SMALL:"-size_small"},MODAL_STATES:{FIXED:"-fixed",NO_PADDING:"-no_padding",SIZE:{WIDE:"-size_wide",NARROW:"-size_narrow",TINY:"-size_tiny",RESPONSIVE:"-size_responsive"}},HOOKS:{HANDLED:"-Handled_",RIPPLE:"RippleEffect",ADD_STAFF:"AddStaff",ADD_TO_FAVORITES:"AddToFavorites",TEXT:"Text",CALL_MODAL:"CallModal",CLOSE_MODAL:"CloseModal",DROPDOWN_BUTTON:"DropdownButton",ADD_AVATAR:{ANCESTOR:"AddAvatarWrapper",COLLECTION:"AvatarsCollection",QUANTITY:"FavoredCount",STATES:{CAST:"-cast",CASTABLE:"-castable",SHIFT:"-shift",SHIFTED:"-shifted"}}},ACTIVE:"-active",DISABLED:"-disabled",HIDDEN:"-hidden",SHOW:"-show",ICONS:{STAR:"fa-star",STAR_O:"fa-star-o",BELL_O:"fa-bell-o",TIMES:"fa-times",PLUS:"fa-plus",MINUS:"fa-minus",CHECK:"fa-check",PENCIL:"fa-pencil",EYE:"fa-eye",EYE_CLOSE:"fa-eye-slash",TICKET:"fa-ticket"},ICON_CLASS:"fa_icon"},SOCICON_CLASSES:{vk:"fa-vk",google:"fa-google-plus",facebook:"fa-facebook-official"},DATE_FORMAT:"YYYY-MM-DD",MODAL_TYPES:{FAVORS:"favors",SUBSCRIBERS:"subscribers",EDITORS:"editors",MAP:"map",MEDIA:"media",CROPPER:"cropper",FRIENDS_LIST:"friends_list",SUBSCRIBERS_LIST:"subscribers_list",TICKET:"tickets",ADD_STAFF:"add_staff"},COLORS:{PRIMARY:"#2e3b50",MUTED:"#3e4d66",MUTED_80:"#657184",MUTED_50:"#9fa6b3",MUTED_30:"#c5c9d1",TEXT:"#4a4a4a",ACCENT:"#f82969",ACCENT_ALT:"#ff5f9e",FRANKLIN:"#28be84",FRANKLIN_ALT:"#23d792"},STATS:{EVENT_VIEW:"view",EVENT_VIEW_DETAIL:"view_detail",EVENT_OPEN_SITE:"open_site",EVENT_OPEN_MAP:"open_map",ORGANIZATION_OPEN_SITE:"open_site",EVENT_ENTITY:"event",ORGANIZATION_ENTITY:"organization"},ENTITIES:{USER:"user",EVENT:"event",ORGANIZATION:"organization"},DEFERRED_STATES:{PENDING:"pending",RESOLVED:"resolved",REJECTED:"rejected"}},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.contains=function(t){return this.search(t)!==-1},String.prototype.format=function(t){return this.replace(/\{(\w+)\}/g,function(e,i){return null!=t[i]?t[i]:""})},String.prototype.toCamelCase=function(t){return this.split(t?t:" ").map(function(t){return t.capitalize()}).join("")},String.prototype.toUnderscore=function(){return(this.charAt(0).toLowerCase()+this.slice(1)).replace(/([A-Z])/g,function(t){return"_"+t.toLowerCase()})},String.prototype.appendAjaxData=function(t){return t.fields&&t.fields instanceof Array&&(t.fields=t.fields.join(",")),this+JSON.stringify(t)},Object.props=function(t){return Object.keys(t).filter(function(e){return"function"!=typeof t[e]})},Object.getProps=function(t){var e={};return $.each(t,function(t,i){"function"!=typeof i&&(e[t]=i)}),e},Object.methods=function(t){var e=[];return Object.keys(t).forEach(function(i){"function"==typeof t[i]&&e.push(i)}),e},"function"!=typeof Object.values&&(Object.values=function(t){var e=[];for(var i in t)t.hasOwnProperty(i)&&t.propertyIsEnumerable(i)&&e.push(t[i]);return e}),Object.toHtmlDataSet=function(){var t=[],e=this;return Object.props(e).forEach(function(i){t.push((0!=i.indexOf("data-")?"data-"+i:i)+'="'+e[i]+'"')}),t.join(" ")},Object.toHtmlAttributes=function(){var t=[],e=this;return Object.props(e).forEach(function(i){t.push(i+'="'+e[i]+'"')}),t.join(" ")},Array.newFrom=function(t,e){var i,n,a=t.slice(0);if(arguments.length>1)for(n=1;n<arguments.length;n++)switch(i=arguments[n],typeof i){case"number":case"string":case"boolean":$.merge(a,[i]);break;case"object":i instanceof Array?$.merge(a,i):$.merge(a,Object.keys(i).map(function(t){return i[t]}));break;default:console.error("")}return a},Array.toSpaceSeparatedString=function(){return this.join(" ")},Array.prototype.clean=function(t){for(var e=0;e<this.length;e++)this[e]==t&&(this.splice(e,1),e--);return this},Array.prototype.merge=function(t){var e=Array.prototype.slice.call(arguments),i={},n=[],a=0,o=0;for(e.unshift(this),a=0;a<e.length;a++)for(o=0;o<e[a].length;o++)i[e[a][o]]!==!0&&(n[n.length]=e[a][o],i[e[a][o]]=!0);return n},Array.prototype.contains=function(t){return this.indexOf(t)!==-1},[].includes||(Array.prototype.includes=function(t){"use strict";var e=Object(this),i=parseInt(e.length)||0;if(0===i)return!1;var n,a=parseInt(arguments[1])||0;for(a>=0?n=a:(n=i+a,n<0&&(n=0));n<i;){var o=e[n];if(t===o||t!==t&&o!==o)return!0;n++}return!1}),Math.roundTo=function(t,e){var i=Math.pow(10,e?e:0);return Math.round(t*i)/i},function(t){function e(e){function i(t,e){for(var i,n,a,o=t.split("").reverse(),s=[],r=0,c=Math.ceil(t.length/e);r<c;r++){for(i="",a=0;a<e&&(n=r*e+a,n!==t.length);a++)i+=o[n];s.push(i)}return s}function n(t){var e=t.length-1,i=t[e].split("").reverse().join("");return t[e]=parseInt(i,10).toString().split("").reverse().join(""),t}var a,o,s,r=t(e.elem),c={separator:" ",group_length:3,suffix:"",prefix:""};if(e.elem.nodeType&&e.elem.parentNode){if(a=t.extend(!0,{},c,r.data()),o=Math.floor(e.now),s=o.toString(),s.length>a.group_length){var l=i(s,a.group_length);s=n(l).join(a.separator),s=s.split("").reverse().join("")}r.prop("number",e.now).text(a.prefix+s+a.suffix)}}t.Tween&&t.Tween.propHooks?t.Tween.propHooks.number={set:e}:t.fx.step.number=e}(window.jQuery),$.fn.extend({toggleStatus:function(t){var e=this;return e.is(".form_unit")?t.split(" ").forEach(function(t){var i=e.find("input, select, textarea, button");"disabled"===t&&(e.hasClass("-status_disabled")?i.removeAttr("disabled"):i.attr("disabled",!0)),e.toggleClass("-status_"+t)}):e.is("input, textarea, select, button")?e.closest(".form_unit").toggleStatus(t):e.length&&e.find(".form_unit").toggleStatus(t),this},serializeForm:function(t){var e=/^(?:input|select|textarea|keygen)/i,i=/^(?:submit|button|image|reset|file)$/i,n=/^(?:checkbox|radio)$/i,a=/\r?\n/g,o=this.map(function(){var t=$.prop(this,"elements");return t?$.makeArray(t):this});switch(t){case"array":return o.filter(function(){var t=this.type;return this.name&&!$(this).is(":disabled")&&e.test(this.nodeName)&&!i.test(t)&&(this.checked&&"on"!=this.value||"radio"!=t)&&(this.checked&&"on"!=this.value||"on"==this.value||"checkbox"!=t)}).map(function(t,e){var i=$(this).val(),n="";switch(this.type){case"radio":case"checkbox":n="on"==i?this.checked?1:0:i;break;default:n=i.replace(a,"\r\n")}return null==i?null:{name:e.name,value:n}}).get();case"object":default:var s={};return o.filter(function(){var t=this.type;return this.name&&!$(this).is(":disabled")&&e.test(this.nodeName)&&!i.test(t)&&!n.test(t)}).each(function(t,e){var i=$(e),n=e.name,r=i.val();if(o.filter("[name='"+n+"']").length>1&&""!=r)s[n]="undefined"==typeof s[n]?[]:s[n],s[n].push(r?r.replace(a,"\r\n"):r);else if("hidden"===i.attr("type")&&0===r.indexOf("data.")){for(var c=r.split("."),l=i.data(c[1]),d=2;c[d];)l=l[c[d]],d++;s[n]=l}else s[n]=r||0===r?r.replace(a,"\r\n"):null}),o.filter(function(){var t=this.type;return this.name&&!$(this).is(":disabled")&&n.test(t)&&(this.checked&&"on"!=this.value||"on"==this.value&&"checkbox"==t)}).each(function(t,e){var i=e.name,n=e.value;switch(e.type){case"radio":s[i]=n;break;case"checkbox":o.filter("[name='"+i+"']").length>1&&"on"!=n?(s[i]="undefined"==typeof s[i]?[]:s[i],s[i].push(n)):"on"!=n?s[i]=n:s[i]=!!e.checked}}),s}},animateNumber:function(t){for(var e=[t],i=1,n=arguments.length;i<n;i++)e.push(arguments[i]);return this.data(t),this.animate.apply(this,e)},tablesort:function(t){t=setDefaultValue(t,{});var e,i=this.get(0),n=null;return Tablesort&&"function"==typeof Tablesort?(n=new Tablesort(i,t),e=new MutationObserver(function(){n.refresh()}),e.observe(i,{attributes:!0,childList:!0}),this.data({tablesort_instance:n,mutation_observer_instance:e})):console.error("Tablesort is not defined"),n},resolveInstance:function(){var t=this.data("instance");return t?t:this},outerHTML:function(){var t="";return this.each(function(e,i){t+=i.outerHTML}),t}}),jQuery.makeSet=function(t){return $($.map(t,function(t){return t.get()}))},function(t,e,i){var n={},a={},o=function(e){return"string"==t.type(e)&&(e={message:e}),arguments[1]&&(e=t.extend(e,"string"==t.type(arguments[1])?{status:arguments[1]}:arguments[1])),new r(e).show()},s=function(t,e){if(t)for(var i in a)t===a[i].group&&a[i].close(e);else for(var i in a)a[i].close(e)},r=function(e){this.options=t.extend({},r.defaults,e),this.uuid="ID"+(new Date).getTime()+"RAND"+Math.ceil(1e5*Math.random()),this.element=t(['<div class="uk-notify-message alert-dismissable">','<a class="close">&times;</a>',"<div>"+this.options.message+"</div>","</div>"].join("")).data("notifyMessage",this),this.options.status&&(this.element.addClass("alert alert-"+this.options.status),this.currentstatus=this.options.status),this.group=this.options.group,a[this.uuid]=this,n[this.options.pos]||(n[this.options.pos]=t('<div class="uk-notify uk-notify-'+this.options.pos+'"></div>').appendTo("body").on("click",".uk-notify-message",function(){t(this).data("notifyMessage").close()}))};return t.extend(r.prototype,{uuid:!1,element:!1,timout:!1,currentstatus:"",group:!1,show:function(){if(!this.element.is(":visible")){var t=this;n[this.options.pos].show().prepend(this.element);var e=parseInt(this.element.css("margin-bottom"),10);return this.element.css({opacity:0,"margin-top":-1*this.element.outerHeight(),"margin-bottom":0}).animate({opacity:1,"margin-top":0,"margin-bottom":e},function(){if(t.options.timeout){var e=function(){t.close()};t.timeout=setTimeout(e,t.options.timeout),t.element.hover(function(){clearTimeout(t.timeout)},function(){t.timeout=setTimeout(e,t.options.timeout)})}}),this}},close:function(t){var e=this,i=function(){e.element.remove(),n[e.options.pos].children().length||n[e.options.pos].hide(),
delete a[e.uuid]};this.timeout&&clearTimeout(this.timeout),t?i():this.element.animate({opacity:0,"margin-top":-1*this.element.outerHeight(),"margin-bottom":0},function(){i()})},content:function(t){var e=this.element.find(">div");return t?(e.html(t),this):e.html()},status:function(t){return t?(this.element.removeClass("alert alert-"+this.currentstatus).addClass("alert alert-"+t),this.currentstatus=t,this):this.currentstatus}}),r.defaults={message:"",status:"normal",timeout:5e3,group:null,pos:"top-center"},t.notify=o,t.notify.message=r,t.notify.closeAll=s,o}(jQuery,window,document),function(t){t.cookies={getItem:function(t){return t?decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null:null},setItem:function(t,e,i,n,a,o){var s="";if(!t||/^(?:expires|max\-age|path|domain|secure)$/i.test(t))return!1;if(i)switch(i.constructor){case Number:s=i===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+i;break;case String:s="; expires="+i;break;case Date:s="; expires="+i.toUTCString()}return document.cookie=encodeURIComponent(t)+"="+encodeURIComponent(e)+s+(a?"; domain="+a:"")+(n?"; path="+n:"")+(o?"; secure":""),!0},removeItem:function(t,e,i){return!!this.hasItem(t)&&(document.cookie=encodeURIComponent(t)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(i?"; domain="+i:"")+(e?"; path="+e:""),!0)},hasItem:function(t){return!!t&&new RegExp("(?:^|;\\s*)"+encodeURIComponent(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},keys:function(){for(var t=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),e=t.length,i=0;i<e;i++)t[i]=decodeURIComponent(t[i]);return t}}}(window),window.location.hostname.indexOf(".test.evendate.ru")==-1?window.socket=io.connect("https:"==window.location.protocol?":8443":":8080",{secure:"https:"==window.location.protocol}):window.socket=io({path:"/node/socket.io"}),socket.on("auth",function(t){var e;$.ajax({url:"auth.php",type:"POST",data:t,success:function(i){if(yaCounter32442130)switch(t.type){case"vk":yaCounter32442130.reachGoal("VkAuthDone");break;case"facebook":yaCounter32442130.reachGoal("FacebookAuthDone");break;case"google":yaCounter32442130.reachGoal("GoogleAuthDone")}if(i.status){var n=searchToObject();if(n.redirect_to)window.location.href=n.redirect_to;else if(t.hasOwnProperty("mobile")&&1==t.mobile)window.location.href="/mobileAuthDone.php?token="+t.token+"&email="+t.email;else{try{e=sessionStorage.getItem("organization_info")}catch(t){e=""}e?window.parent.location="/add/organization":0==t.subscriptions_count?window.parent.location="/onboarding":window.parent.location="/"}}else $(".panel-body.loader-demo").text(i.text),$(".panel-heading").hide()}})}),socket.on("log",function(t){console.log(t)}),socket.on("error.retry",function(){$(".panel-body.loader-demo").text("Во время загрузки данных произошла ошибка. Войдите с помощью другой социальной сети или попробуте чуть позже."),$(".panel-heading").hide()}),socket.on("notification",function(t){if(Notify.needsPermission)Notify.isSupported()&&Notify.requestPermission();else{socket.emit("notification.received",{notification_id:t.notification_id});var e=new Notify(t.note.payload.title,{body:t.note.body,icon:t.note.icon,tag:t.note.payload.event_id,timeout:60,notifyClick:function(){$("<a>").attr("href",window.location.origin+"/event.php?id="+t.note.payload.event_id).attr("target","_blank")[0].click(),socket.emit("notification.received",{notification_id:t.notification_id,click_time:moment().format(__C.DATE_FORMAT+" HH:MM:SS")})}});e.show()}}),socket.on("image.getFromURLDone",function(t){t.error?showNotifier({text:t.error,status:!1}):ImgLoader.handleImgUpload(ImgLoader.current_load_context,t.data,t.filename)}),socket.on("vk.getGroupsToPostDone",function(t){if(t.error)showNotifier({text:t.error,status:!1});else{var e=t.data.response,i=__APP.CURRENT_PAGE.$wrapper.find("#edit_event_vk_groups");e.length||e[0]?(e.splice(0,1),e.forEach(function(t){i.append(tmpl("option",{val:t.gid,display_name:t.name,data:"data-img='"+t.photo+"'"}))}),initSelect2(i)):__APP.CURRENT_PAGE.$wrapper.find("#edit_event_to_public_vk").toggleStatus("disabled").prop("checked",!1).trigger("change")}}),socket.on("vk.post.error",function(t){console.log(t),showNotifier({text:"Не удалось опубликовать событие в группе vk. Пожалуйста, попробуйте еще раз.",status:!1})}),EntityInterface=function(){function t(){}return t.prototype.setData=function(t){},t}(),Fields=function(){function t(t){this.add.apply(this,arguments)}function e(e){var i={};return e instanceof Array||(e=e.replace(/\s+/g,"").match(/(\w+\{[^}]+}|\w+)/g)),e.forEach(function(e){var n=e.split("{"),a={};n.length>1&&(a=JSON.parse("{"+n[1].replace(/(\w+):/g,function(t,e){return'"'+e+'":'})),a.fields&&(a.fields=new(Function.prototype.bind.apply(t,[null].concat(a.fields.split(","))))),a.order_by&&(a.order_by=a.order_by.split(","))),i[n[0]]=a}),i}var i=function(){function e(t){var e;for(e in t)this[e]=t[e]}return Object.defineProperties(e.prototype,{toString:{value:function(){var e=this,i=Object.props(this),n={};return 0===i.length?"":(i.forEach(function(i){n[i]=e[i]instanceof Array||e[i]instanceof t?e[i].toString():e[i]}),JSON.stringify(n))}},merge:{value:function(t){return $.extend(this,t)}}}),e}();return Object.defineProperty(t.prototype,"toString",{value:function(){var t=this,e=Object.props(this);if(0!==e.length)return e.map(function(e){return e+t[e]}).join(",")}}),t.parseFields=function(i){return i instanceof t?i.copy():new t(e(i))},t.prototype.get=function(t){return this.has(t)?this[t]:null},t.prototype.push=t.prototype.add=function(){var t,e=Array.prototype.splice.call(arguments,0),n={};e.forEach(function(t){"string"==typeof t?n[t]={}:t instanceof Array?t.forEach(function(t){n[t]={}}):t instanceof Object&&Object.props(t).forEach(function(e){n[e]=t[e]})});for(t in n)this.has(t)?this[t].merge(n[t]):this[t]=new i(n[t]);return this},t.prototype.pull=function(t){var e=this.get(t);return this.delete(t),e},t.prototype.has=function(t){return"undefined"!=typeof this[t]},t.prototype.delete=function(t){return!!this.has(t)&&delete this[t]},t.prototype.copy=function(){return new t(this)},t}(),OneEntity=function(){function t(){}return t.prototype.ID_PROP_NAME="id",t.prototype.setData=function(e){var i;Array.isArray(e)&&(e=e[0]);for(i in e)e.hasOwnProperty(i)&&this.hasOwnProperty(i)&&((this[i]instanceof EntitiesCollection||this[i]instanceof t)&&null!=e[i]?this[i].setData(e[i]):this[i]=e[i]);return this},t}(),EntitiesCollection=extending(Array,function(){function t(){Object.defineProperties(this,{__lookup:{value:{},writable:!0,enumerable:!1,configurable:!1},last_pushed:{value:[]}})}return t.prototype.collection_of=OneEntity,t.prototype.setData=function(t){return t=t instanceof Array?t:[t],this.push.apply(this,t),this},t.prototype.getByID=function(t){return this.__lookup.hasOwnProperty(t)?this.__lookup[t]:null},t.prototype.has=function(t){return this.getByID(t)instanceof OneEntity},t.prototype.push=function(t){var e,i=this.collection_of.prototype.ID_PROP_NAME,n=arguments;this.last_pushed.splice(0);for(var a=0,o=n[a];a<n.length;o=n[++a])(!o[i]||o[i]&&!this.has(o[i]))&&(e=o instanceof this.collection_of?o:(new this.collection_of).setData(o),this.last_pushed.push(e),this[this.length++]=e,e[i]&&(this.__lookup[e[i]]=e),this.createAdditionalLookup(e));return this.length},t.prototype.createAdditionalLookup=function(){},t.prototype.getArrayCopy=function(){return this.map(function(t){return t})},t.prototype.remove=function(t){return this.has(t)?(delete this.__lookup[t],this.splice(this.indexOf(this.getByID(t)),1)):[]},t.prototype.empty=function(){return this.last_pushed.splice(0,this.last_pushed.length),this.__lookup={},this.splice(0,this.length),this},t}()),OrganizationModel=extending(OneEntity,function(){function t(t){this.organization_id=null,this.name=null,this.short_name=null,this.description=null,this.site_url=null,this.default_address=null,this.vk_url=null,this.facebook_url=null,this.type_id=null,this.background=null,this.background_filename=null,this.logo=null,this.logo_filename=null,this.detail_info_url=null,this.email=null,this.city_id=null,this.country_id=null,this.is_private=null,t&&e(this,t)}function e(t,e){var i;for(i in e)if(e.hasOwnProperty(i))if(t.hasOwnProperty(i))t[i]=e[i];else switch(i){case"background_img_url":isBase64(e[i])&&(t.background=e[i]);break;case"img_url":isBase64(e[i])&&(t.logo=e[i]);break;case"city":t.city_id=e[i]instanceof OneCity?e[i].id:e[i];break;case"country":t.country_id=e[i].id}return t}return t.prototype.setData=function(t){return e(this,t)},t.prototype.toString=function(){return JSON.stringify(this)},t}()),TariffModel=extending(OneEntity,function(){function t(t){var e=this;this.tariff_id=null,this.name=null,this.since=null,this.till=null,this.available_additional_notifications=null,this.available_event_publications=null,this.available_tickets_selling=null,this.available_telegram_bots=null,this.available_slack_bots=null,this.available_auditory_analytics=null,this.available_in_city=null,this.price=null,Object.defineProperty(this,"is_full",{get:function(){return 0!==e.price}}),t&&setData(this,t)}return t}()),DateModel=extending(OneEntity,function(){function t(){this.event_date="",this.start_time="",this.end_time=""}return t}()),DateModelsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=DateModel,t}()),RegistrationFieldModel=extending(OneEntity,function(){function t(){this.uuid=null,this.type=null,this.label=null,this.required=!1}return t.TYPES={EMAIL:"email",FIRST_NAME:"first_name",LAST_NAME:"last_name",PHONE_NUMBER:"phone_number",ADDITIONAL_TEXT:"additional_text",CUSTOM:"custom",EXTENDED_CUSTOM:"extended_custom"},t.DEFAULT_LABEL={EMAIL:"E-mail",FIRST_NAME:"Имя",LAST_NAME:"Фамилия",PHONE_NUMBER:"Номер телефона",ADDITIONAL_TEXT:"Дополнительное текстовое поле",CUSTOM:"Дополнительное текстовое поле",EXTENDED_CUSTOM:"Дополнительное текстовое поле"},t.isCustomField=function(e){switch(e.type){case t.TYPES.EMAIL:case t.TYPES.FIRST_NAME:case t.TYPES.LAST_NAME:case t.TYPES.PHONE_NUMBER:return!1;default:case t.TYPES.CUSTOM:case t.TYPES.EXTENDED_CUSTOM:case t.TYPES.ADDITIONAL_TEXT:return!0}},t.prototype.setData=function(t){var e;Array.isArray(t)&&(t=t[0]);for(e in t)t.hasOwnProperty(e)&&this.hasOwnProperty(e)&&(this[e]=t[e]);return this},t}()),RegistrationFieldModelsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=RegistrationFieldModel,t.prototype.push=function(t){var e=this,i=Array.prototype.slice.call(arguments),n=[RegistrationFieldModel.TYPES.FIRST_NAME,RegistrationFieldModel.TYPES.LAST_NAME,RegistrationFieldModel.TYPES.EMAIL,RegistrationFieldModel.TYPES.PHONE_NUMBER,RegistrationFieldModel.TYPES.ADDITIONAL_TEXT,RegistrationFieldModel.TYPES.CUSTOM,RegistrationFieldModel.TYPES.EXTENDED_CUSTOM];return this.last_pushed.splice(0),n.forEach(function(t){i.forEach(function(i){i.type==t&&e.last_pushed.push(e[e.length++]=i instanceof e.collection_of?i:(new e.collection_of).setData(i))})}),this.length},t}()),OneAbstractActivity=extending(OneEntity,function(){function t(){this.stat_type_id=0,this.user_id=0,this.user=new OneUser(this.user_id),this.entity="",this.type_code="",this.created_at=0}return t.TYPES={SUBSCRIBE:"subscribe",FAVE:"fave",UNSUBSCRIBE:"unsubscribe",UNFAVE:"unfave",SHARE_VK:"share_vk",SHARE_FB:"share_fb",SHARE_TW:"share_tw"},Object.freeze(t.TYPES),t.TYPES_INDEX={subscribe:"SUBSCRIBE",fave:"FAVE",unsubscribe:"UNSUBSCRIBE",unfave:"UNFAVE",share_vk:"SHARE",share_fb:"SHARE",share_tw:"SHARE"},Object.freeze(t.TYPES_INDEX),t}()),OneEventActivity=extending(OneAbstractActivity,function(){function t(){OneAbstractActivity.call(this),this.event_id=0,this.event=new OneEvent(this.event_id)}return t}()),OneOrganizationActivity=extending(OneAbstractActivity,function(){function t(){OneAbstractActivity.call(this),this.organization_id=0,this.organization=new OneOrganization(this.organization_id)}return t}()),UsersActivitiesCollection=extending(EntitiesCollection,function(){function t(t){EntitiesCollection.call(this),Object.defineProperty(this,"user_id",{value:t})}return Object.defineProperty(t.prototype,"collection_of",{value:OneAbstractActivity}),t.setDefaultData=function(t){return"string"==typeof t.fields?t.fields=t.fields.split(","):t.fields instanceof Array||(t.fields=[]),t.fields=t.fields.merge(["created_at","type_code","event","organization"]),t.order_by=setDefaultValue(t.order_by,"-created_at"),t.length=setDefaultValue(t.length,20),t},t.prototype.push=function(t){for(var e=0;e<arguments.length;e++)arguments[e]instanceof this.collection_of?this[this.length]=arguments[e]:void 0!=arguments[e].event_id?this[this.length]=(new OneEventActivity).setData(arguments[e]):void 0!=arguments[e].organization_id&&(this[this.length]=(new OneOrganizationActivity).setData(arguments[e])),this.length++;return this.length},t.fetch=function(e,i,n){return i=t.setDefaultData(i),__APP.SERVER.getData("/api/v1/users/"+e+"/actions",i,n)},t.prototype.fetch=function(t,e,i,n){var a=this,o={fields:t,offset:this.length,length:e};return i&&(o.order_by=i),this.constructor.fetch(this.user_id,o).then(function(t){return a.setData(t),(new a.constructor).setData(t)})},t}()),OneCategory=extending(OneEntity,function(){function t(t,e){this.id=setDefaultValue(t,0),this.name=null,this.order_position=null,this.organizations=new OrganizationsCollection,this.loading=!1,t&&e&&(this.loading=!0,this.fetchCategory([],function(){this.loading=!1,$(window).trigger("fetch.OneCategory")}))}return t.fetchCategory=function(t,e,i){return __APP.SERVER.getData("/api/v1/organizations/types",$.extend({},e,{id:t}),i)},t.prototype.fetchCategory=function(t,e){var i=this;return this.constructor.fetchCategory(i.id,{fields:t},function(t){i.setData(t),e&&"function"==typeof e&&e.call(i,t[0])})},t}()),CategoriesCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneCategory,t.fetchCategories=function(t,e){return __APP.SERVER.getData("/api/v1/organizations/types",t,e)},t.prototype.fetchCategories=function(t,e,i){var n=this,a=$.extend({},t,{offset:this.length,length:e});return this.constructor.fetchCategories(a,function(t){n.setData(t),i&&"function"==typeof i&&i.call(n,t)})},t.prototype.fetchCategoriesWithOrganizations=function(t,e,i,n){var a=this,o=$.extend({},t,{offset:this.length,length:i}),s="organizations"+JSON.stringify(__APP.SERVER.validateData(e));return o.fields?Array.isArray(o.fields)||(o.fields=o.fields.split(",")):o.fields=[],o.fields.push(s),this.constructor.fetchCategories(o,function(t){a.setData(t),n&&"function"==typeof n&&n.call(a,t)})},t}()),OneCity=extending(OneEntity,function(){function t(t){this.id=setDefaultValue(t,0),this.en_name=null,this.country_id=null,this.local_name=null,this.organization_type=new CategoriesCollection,this.timediff_seconds=null}return t}()),CitiesCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneCity,t.fetchCities=function(t,e){return __APP.SERVER.getData("/api/v1/organizations/cities",t,e)},t.prototype.getByName=function(t){for(var e=0;e<this.length;e++)if(this[e].en_name==t)return this[e];return null},t.prototype.has=function(t){return($.isNumeric(t)?this.getByID(t):this.getByName(t))instanceof OneEntity},t.prototype.fetchCities=function(e,i,n,a){var o=this;return t.fetchCities({fields:e||void 0,offset:this.length,length:i||void 0,order_by:n||void 0},function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,o.last_pushed)})},t}()),OneDate=extending(DateModel,function(){function t(){DateModel.call(this),this.id=0,this.event_id=0,this.organization_id=0,this.events_count=0,this.favored_count=0}return t}()),DatesCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneDate,t.fetchDates=function(t,e){return __APP.SERVER.getData("/api/v1/events/dates",t,e)},t}()),OneEvent=extending(OneEntity,function(){function t(t,e){this.id=t?t:0,this.title=null,this.description=null,this.location=null,this.latitude=null,this.longitude=null,this.is_online=null,this.detail_info_url=null,this.orders=new OrdersCollection(t),this.orders_count=null,this.ticketing_locally=null,this.tickets=new EventsTicketsCollection(t),this.ticket_types=new TicketTypesCollection(t),this.registration_locally=null,this.registration_available=null,this.registration_required=null,this.registration_limit_count=null,this.registration_till=null,this.registration_approve_status=null,this.registration_approvement_required=null,this.is_registered=null,this.registered_count=null,this.registered_users=new UsersCollection,this.registration_fields=new RegistrationFieldModelsCollection,this.organization_id=null,this.organization_short_name=null,this.organization_logo_large_url=null,this.organization_logo_medium_url=null,this.organization_logo_small_url=null,this.image_vertical_url=null,this.image_horizontal_url=null,this.image_horizontal_large_url=null,this.image_horizontal_medium_url=null,this.image_horizontal_small_url=null,this.is_free=null,this.min_price=null,this.dates=new DatesCollection,this.is_same_time=null,this.first_event_date=null,this.last_event_date=null,this.nearest_event_date=null,this.tags=new TagsCollection,this.notifications=[],this.favored=new UsersCollection,this.favored_users_count=null,this.favored_friends_count=null,this.is_favorite=null,this.public_at=null,this.canceled=null,this.can_edit=null,this.actuality=null,this.creator_id=null,this.created_at=null,this.updated_at=null,this.loading=!1,t&&e&&(this.loading=!0,this.fetchEvent(void 0,function(){this.loading=!1,$(window).trigger("fetch.OneEvent")}))}return t.STATUS={CANCEL:"cancel",BRING_BACK:"bring_back",HIDE:"hide",SHOW:"show"},t.fetchEvent=function(t,e,i){return __APP.SERVER.getData("/api/v1/events/"+t,{fields:new Fields(e)},i)},t.createEvent=function(t,e,i){return __APP.SERVER.addData("/api/v1/events/",t,!0,e,i)},t.updateEvent=function(t,e,i,n){return __APP.SERVER.updateData("/api/v1/events/"+t,e,!0,i,n)},t.changeEventStatus=function(e,i,n){var a={};return i=Array.isArray(i)?i:[i],i.forEach(function(e){switch(e){case t.STATUS.CANCEL:a.canceled=!0;break;case t.STATUS.BRING_BACK:a.canceled=!1;break;case t.STATUS.HIDE:a.hidden=!0;break;case t.STATUS.SHOW:a.hidden=!1}}),__APP.SERVER.updateData("/api/v1/events/"+e+"/status",a,!1,function(){n&&"function"==typeof n&&n.call(self,a)})},t.addFavored=function(t,e){return __APP.SERVER.addData("/api/v1/events/"+t+"/favorites",{},!1,e)},t.deleteFavored=function(t,e){return __APP.SERVER.deleteData("/api/v1/events/"+t+"/favorites",{},e)},t.addEventNotification=function(t,e,i){return __APP.SERVER.addData("/api/v1/events/"+t+"/notifications",{notification_type:e},!1,i)},t.deleteEventNotification=function(t,e,i){return __APP.SERVER.deleteData("/api/v1/events/"+t+"/notifications/"+e,{},i)},t.registerToEvent=function(t,e,i){return __APP.SERVER.addData("/api/v1/events/"+t+"/orders",{registration_fields:e,tickets:[{uuid:null,count:1}]},!0,i)},t.prototype.fetchEvent=function(e,i){var n=this;return t.fetchEvent(n.id,e,function(t){n.setData(t[0]),i&&"function"==typeof i&&i.call(n,t[0])})},t.prototype.createEvent=function(t,e,i){var n=this;return this.constructor.createEvent(t,function(i){n.setData(t),n.id=i.event_id,e&&"function"==typeof e&&e.call(n,t)},i)},t.prototype.updateEvent=function(t,e,i){var n=this;return this.constructor.updateEvent(n.id,t,function(i){n.setData(t),e&&"function"==typeof e&&e.call(n,t)},i)},t.prototype.changeEventStatus=function(t,e){var i=this;return this.constructor.changeEventStatus(i.id,t,function(t){i.setData(t),e&&"function"==typeof e&&e.call(i,t)})},t.prototype.addNotification=function(t,e){return this.constructor.addEventNotification(this.id,t,e)},t.prototype.deleteNotification=function(t,e){return this.constructor.deleteEventNotification(this.id,t,e)},t.prototype.registerToEvent=function(t,e){return this.constructor.registerToEvent(this.id,t,e)},t}()),EventsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneEvent,t.KIND={MY:"my",FAVORED:"favored",RECOMMENDED:"recommended"},t.fetchEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/",t,e)},t.fetchMyEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/my",t,e)},t.fetchFavoredEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/favorites",t,e)},t.fetchRecommendedEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/recommendations",t,e)},t.fetchOrganizationsEvents=function(t,e,i){return __APP.SERVER.getData("/api/v1/events/",$.extend({},e,{organization_id:t}),i)},t.prototype.fetchEvents=function(e,i,n,a){var o=this,s="fetchEvents",r=$.extend({},i,{offset:this.length,length:n});switch(e){default:s="fetchEvents";break;case t.KIND.MY:s="fetchMyEvents";break;case t.KIND.FAVORED:s="fetchFavoredEvents";break;case t.KIND.RECOMMENDED:s="fetchRecommendedEvents"}return this.constructor[s](r,function(t){o.setData(t),isFunction(a)&&a.call(o,o.last_pushed)})},t.prototype.fetchFeed=function(t,e,i,n){var a=this,o=$.extend({fields:t,offset:this.length,length:e},i);return this.constructor.fetchEvents(o,function(t){a.setData(t),isFunction(n)&&n.call(a,a.last_pushed)})},t.prototype.fetchOrganizationsEvents=function(t,e,i,n){var a=this,o=$.extend({},e,{offset:this.length,length:i});return this.constructor.fetchOrganizationsEvents(t,o,function(t){a.setData(t),n&&"function"==typeof n&&n.call(a,a.last_pushed)})},t.prototype.fetchOrganizationsFeed=function(t,e,i,n){var a=this,o={fields:e,offset:this.length,length:i};return this.constructor.fetchOrganizationsEvents(t,o,function(t){a.setData(t),n&&"function"==typeof n&&n.call(a,a.last_pushed)})},t}()),ActualEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchEvents=function(t,e){return t.fields=t.fields?"string"==typeof t.fields?t.fields.split(","):t.fields:[],t.fields.push("actuality"),t.future=!0,t.order_by="-actuality",EventsCollection.fetchMyEvents(t,e)},t}()),CanceledEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchOrganizationsEvents=function(t,e,i){return e.fields=e.fields?"string"==typeof e.fields?e.fields.split(","):e.fields:[],e.fields.push("updated_at"),e.is_canceled=!0,e.order_by="-updated_at",EventsCollection.fetchOrganizationsEvents(t,e,i)},t}()),DayEventsCollection=extending(EventsCollection,function(){function t(t){if(!t)throw Error("DayEventsCollection must have date parameter");EventsCollection.call(this),this.date=t}return t.fetchEvents=function(t,e,i){return e.date=t,EventsCollection.fetchMyEvents(e,i)},t.prototype.fetchFeed=function(t,e,i,n){var a=this,o=$.extend({fields:t,offset:this.length,length:e},i);return this.constructor.fetchEvents(this.date,o,function(t){a.setData(t),isFunction(n)&&n.call(a,t)})},t}()),DelayedEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchOrganizationsEvents=function(t,e,i){return e.fields=e.fields?"string"==typeof e.fields?e.fields.split(","):e.fields:[],e.fields.push("public_at"),e.is_delayed=!0,e.is_canceled=!1,e.order_by="public_at",EventsCollection.fetchOrganizationsEvents(t,e,i)},t}()),OneEventWithStatistics=extending(OneEvent,function(){function t(t,e){OneEvent.apply(this,arguments),this.view=0,this.view_detail=0,this.fave=0,this.unfave=0,this.open_site=0,this.notifications_sent=0}return t}()),EventsWithStatisticsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.prototype.collection_of=OneEventWithStatistics,t.fetchEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/",t,e)},t.fetchMyEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/my",t,e)},t.fetchFavoredEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/favorites",t,e)},t.fetchRecommendedEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/recommendations",t,e)},t.fetchOrganizationsEvents=function(t,e,i){return e.statistics=!0,__APP.SERVER.getData("/api/v1/events/",$.extend({},e,{organization_id:t}),i)},t}()),FavoredEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchEvents=function(t,e){return t.future=!0,EventsCollection.fetchFavoredEvents(t,e)},t}()),FriendsEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchEvents=function(t,e){return t.fields=t.fields?"string"==typeof t.fields?t.fields.split(","):t.fields:[],t.fields.push("favored_friends_count"),t.future=!0,t.order_by="-favored_friends_count",EventsCollection.fetchMyEvents(t,e)},t}()),FutureEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchOrganizationsEvents=function(t,e,i){return e.future=!0,e.order_by="nearest_event_date",EventsCollection.fetchOrganizationsEvents(t,e,i)},t}()),PastEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchOrganizationsEvents=function(t,e,i){return e.till=moment().format(__C.DATE_FORMAT),e.order_by="-last_event_date",EventsCollection.fetchOrganizationsEvents(t,e,i)},t}()),RecommendedEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchEvents=function(t,e){return t.future=!0,t.order_by="-rating",EventsCollection.fetchRecommendedEvents(t,e)},t}()),TimelineEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchEvents=function(t,e){return t.future=!0,EventsCollection.fetchMyEvents(t,e)},t}()),OneOrder=extending(OneEntity,function(){function t(e,i){var n=this;this.uuid=setDefaultValue(i,0),this.event_id=setDefaultValue(e,0),this.number=null,this.order_content=null,this.is_canceled=null,this.status_id=null,this.status_type_code=null,this.created_at=null,this.updated_at=null,this.payed_at=null,this.canceled_at=null,this.tickets=new EventsTicketsCollection,this.registration_fields=new RegistrationFieldsCollection,this.user_id=null,this.user=new OneUser,Object.defineProperty(this,"status_name",{get:function(){return localeFromNamespace(n.status_type_code,t.EXTENDED_ORDER_STATUSES,__LOCALES.ru_RU.TEXTS.TICKET_STATUSES)}})}return t.prototype.ID_PROP_NAME="uuid",t.ORDER_STATUSES={WAITING_FOR_PAYMENT:"waiting_for_payment",IS_PENDING:"is_pending",APPROVED:"approved",PAYED:"payed",WITHOUT_PAYMENT:"without_payment",RETURNED_BY_ORGANIZATION:"returned_by_organization",RETURNED_BY_CLIENT:"returned_by_client",REJECTED:"rejected"},t.EXTENDED_ORDER_STATUSES=$.extend({PAYMENT_CANCELED_AUTO:"payment_canceled_auto",PAYMENT_CANCELED_BY_CLIENT:"payment_canceled_by_client"},t.ORDER_STATUSES),t.fetchOrder=function(t,e,i,n){return __APP.SERVER.getData("/api/v1/events/"+t+"/orders/"+e,{fields:i},n)},t.prototype.fetchOrder=function(e,i){var n=this;return t.fetchOrder(this.event_id,this.uuid,e,function(t){n.setData(t),i&&"function"==typeof i&&i.call(n,t)})},t}()),AbstractOrdersCollection=extending(EntitiesCollection,function(){function t(t){EntitiesCollection.call(this),this.event_id=setDefaultValue(t,0)}return t.prototype.collection_of=OneOrder,t.fetchOrders=function(t,e,i){return $.promise()},t.prototype.fetchOrders=function(t,e,i,n){var a=this;return this.constructor.fetchOrders(this.event_id,{fields:t||void 0,offset:this.length,length:e||void 0,order_by:i||void 0},function(t){a.setData(t),isFunction(n)&&n.call(a,a.last_pushed)})},t.prototype.fetchAllOrders=function(t,e,i,n){var a=this,o=[],s=Math.ceil(t/100);return this.empty(),__APP.SERVER.multipleAjax.apply(__APP.SERVER,new Array(s).fill(!0).map(function(t,n){return a.constructor.fetchOrders(a.event_id,{fields:e||void 0,offset:100*n,order_by:i||void 0}).then(function(t){return o=o.concat(t),t})})).then(function(){return a.setData(o),isFunction(n)&&n.call(a,a.last_pushed),a.last_pushed})},t}()),EventOrdersCollection=extending(AbstractOrdersCollection,function(){function t(t){AbstractOrdersCollection.call(this,t)}return t.fetchOrders=function(t,e,i){return __APP.SERVER.getData("/api/v1/statistics/events/"+t+"/orders",e,i)},t}()),OrdersCollection=extending(AbstractOrdersCollection,function(){function t(t){AbstractOrdersCollection.call(this,t)}return t.fetchOrders=function(t,e,i){return __APP.SERVER.getData("/api/v1/events/"+t+"/orders",e,i)},t}()),OneOrganization=extending(OneEntity,function(){function t(t,e){var i=this;this.id=t||0,this.name=null,this.short_name=null,this.description=null,this.img_url=null,this.img_small_url=null,this.img_medium_url=null,this.background_img_url=null,this.background_small_img_url=null,this.background_medium_img_url=null,this.type_id=null,this.type_name=null,this.site_url=null,this.default_address=null,this.events=new EventsCollection,this.subscription_id=null,this.is_subscribed=null,this.subscribed_count=null,this.subscribed=new UsersCollection,this.privileges=[],this.is_private=null,this.brand_color=null,this.tariff=new TariffModel,this.city=new OneCity,this.country=null,this.email=null,this.staff=new UsersCollection,this.status=null,this.is_new=null,this.new_events_count=null,this.actual_events_count=null,this.vk_url=null,this.facebook_url=null,Object.defineProperties(this,{role:{get:function(){return OneUser.recognizeRole(i.privileges)}},admins:{get:function(){return i.staff.getSpecificStaff(OneUser.ROLE.ADMIN)}},moderators:{get:function(){return i.staff.getSpecificStaff(OneUser.ROLE.MODERATOR)}}}),this.loading=!1,t&&e&&(this.loading=!0,this.fetchOrganization([],function(){this.loading=!1,$(window).trigger("fetch.OneOrganization")}))}return t.fetchOrganization=function(t,e,i){return __APP.SERVER.getData("/api/v1/organizations/"+t,{fields:e},i)},t.createOrganization=function(t,e,i){return __APP.SERVER.addData("/api/v1/organizations/",t,!0,e,i)},t.updateOrganization=function(t,e,i,n){return __APP.SERVER.updateData("/api/v1/organizations/"+t,e,!0,i,n)},t.addStaff=function(t,e,i,n){return __APP.SERVER.addData("/api/v1/organizations/"+t+"/staff",{user_id:e,role:i},!1,n)},t.removeStaff=function(t,e,i,n){return __APP.SERVER.deleteData("/api/v1/organizations/"+t+"/staff",{user_id:e,role:i},n)},t.subscribeOrganization=function(t,e){return __APP.SERVER.addData("/api/v1/organizations/"+t+"/subscriptions",{},!1,e)},t.unsubscribeOrganization=function(t,e){return __APP.SERVER.deleteData("/api/v1/organizations/"+t+"/subscriptions",{},e)},t.prototype.fetchOrganization=function(e,i){var n=this;return t.fetchOrganization(n.id,e,function(t){n.setData(t),i&&"function"==typeof i&&i.call(n,n)})},t.prototype.createOrganization=function(e,i,n){var a=this;return t.createOrganization(e,function(t){a.setData(e),a.id=t.organization_id,i&&"function"==typeof i&&i.call(a,a)},n)},t.prototype.updateOrganization=function(e,i,n){var a=this;return t.updateOrganization(a.id,e,function(t){a.setData(e),i&&"function"==typeof i&&i.call(a,a)},n)},t.prototype.subscribe=function(t){var e=this;return this.constructor.subscribeOrganization(this.id,function(i){this.is_subscribed=!0,this.subscribed_count++,t&&"function"==typeof t&&t.call(e,i)})},t.prototype.unsubscribe=function(t){var e=this;return this.constructor.unsubscribeOrganization(this.id,function(i){this.is_subscribed=!1,this.subscribed_count=this.subscribed_count?this.subscribed_count-1:this.subscribed_count,t&&"function"==typeof t&&t.call(e,i)})},t.prototype.addStaff=function(e,i,n){var a=this,o=new OneUser(e);return __APP.SERVER.multipleAjax(t.addStaff(this.id,e,i),o.fetchUser(new Fields)).done(function(t,e){a.staff.setData(o),n&&"function"==typeof n&&n.call(a,o);
}).promise()},t.prototype.removeStaff=function(e,i,n){var a=this;return t.removeStaff(this.id,e,i,function(){n&&"function"==typeof n&&n.call(a,a.staff.remove(e))})},t}()),OrganizationsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneOrganization,t.fetchSubscribedOrganizations=function(t,e){return __APP.SERVER.getData("/api/v1/organizations/subscriptions",t,e)},t.fetchMyOrganizations=function(t,e,i){return t=Array.isArray(t)?t.join(","):t,__APP.SERVER.getData("/api/v1/organizations/",$.extend({},e,{roles:t}),i)},t.fetchRecommendations=function(t,e){return __APP.SERVER.getData("/api/v1/organizations/recommendations",t,e)},t.prototype.fetchSubscribedOrganizations=function(t,e,i,n){var a=this,o={fields:t,offset:this.length,length:e,order_by:i||void 0};return this.constructor.fetchSubscribedOrganizations(o,function(t){a.setData(t),n&&"function"==typeof n&&n.call(a,t)})},t.prototype.fetchMyOrganizations=function(e,i,n,a,o){var s=this,r={fields:i,length:n,offset:this.length,order_by:a||void 0};return t.fetchMyOrganizations(e,r,function(t){s.setData(t),isFunction(o)&&o.call(s,s.last_pushed)})},t}()),RegistrationField=extending(OneEntity,function(){function t(){var t=this;this.form_field_uuid=null,this.form_field_label=null,this.form_field_type=null,this.form_field_type_id=null,this.form_field_required=null,this.value=null,this.created_at=null,this.updated_at=null,Object.defineProperties(this,{uuid:{get:function(){return t.form_field_uuid},set:function(e){return t.form_field_uuid=e}},label:{get:function(){return t.form_field_label},set:function(e){return t.form_field_label=e}},type:{get:function(){return t.form_field_type},set:function(e){return t.form_field_type=e}},required:{get:function(){return t.form_field_required},set:function(e){return t.form_field_required=e}}})}return t.prototype.ID_PROP_NAME="form_field_uuid",t.TYPES=RegistrationFieldModel.TYPES,t.DEFAULT_LABEL=RegistrationFieldModel.DEFAULT_LABEL,t.isCustomField=RegistrationFieldModel.isCustomField,t}()),RegistrationFieldsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this),Object.defineProperties(this,{__types:{value:{},writable:!0,enumerable:!1,configurable:!1}});for(var t in RegistrationFieldModel.TYPES)RegistrationFieldModel.TYPES.hasOwnProperty(t)&&(this.__types[RegistrationFieldModel.TYPES[t]]=[]);Object.freeze(this.__types)}return t.prototype.collection_of=RegistrationField,t.prototype.createAdditionalLookup=function(t){t instanceof RegistrationField&&this.__types[t.type].push(t)},t}()),SearchResults=extending(OneEntity,function(){function t(t){this.query_string=t,this.events=new EventsCollection,this.organizations=new OrganizationsCollection}return t.sanitizeQueryVar=function(t){var e={};return 0===t.indexOf("#")?e.tags=t.replace("#",""):e.q=t,e},t.fetchEventsAndOrganizations=function(e,i,n){return __APP.SERVER.getData("/api/v1/search/",$.extend({},t.sanitizeQueryVar(e),i),n)},t.prototype.fetchEvents=function(e,i){var n=this,a={fields:"events"+JSON.stringify($.extend({},__APP.SERVER.validateData(e),{offset:this.events.length}))};return t.fetchEventsAndOrganizations(n.query_string,a,function(t){n.setData(t),i&&"function"==typeof i&&i.call(n,t.events)})},t.prototype.fetchOrganizations=function(e,i){var n=this,a={fields:"organizations"+JSON.stringify($.extend({},__APP.SERVER.validateData(e),{offset:this.organizations.length}))};return t.fetchEventsAndOrganizations(n.query_string,a,function(t){n.setData(t),i&&"function"==typeof i&&i.call(n,t.organizations)})},t.prototype.fetchEventsAndOrganizations=function(e,i,n){var a=this,o={fields:new Fields};return e&&o.fields.push({events:$.extend({},__APP.SERVER.validateData(e),{offset:this.events.length})}),i&&!t.sanitizeQueryVar(a.query_string).tags&&o.fields.push({organizations:$.extend({},__APP.SERVER.validateData(i),{offset:this.organizations.length})}),t.fetchEventsAndOrganizations(a.query_string,o,function(t){a.setData(t),n&&"function"==typeof n&&n.call(a,t)})},t}()),Statistics=function(){function t(){this.id=0,this.entity=null,this.view=[],this.fave=[],this.unfave=[],this.notifications_sent=[],this.dynamics={view:[],fave:[]}}return t.prototype.setData=function(t){return $.extend(!0,this,t instanceof Array?t[0]:t)},t.SCALES={MINUTE:"minute",HOUR:"hour",DAY:"day",WEEK:"week",MONTH:"month",YEAR:"year",OVERALL:"overall"},t.ENTITIES={EVENT:"events",ORGANIZATION:"organizations"},t.fetchStatistics=function(t,e,i,n,a,o,s){var r={scale:i,fields:[]};switch(a instanceof Array?r.fields=r.fields.concat(a):$.each(a,function(t,e){Object.getOwnPropertyNames(e).length?r.fields.push(t+JSON.stringify(e)):r.fields.push(t)}),o&&r.fields.push("dynamics"+JSON.stringify(__APP.SERVER.validateData(o))),typeof n){case"string":n&&(r.since=n);break;case"object":n.since&&(r.since=n.since),n.till&&(r.till=n.till);break;default:case"boolean":}return __APP.SERVER.getData("/api/v1/statistics/"+t+"/"+e,r,s)},t.prototype.fetchStatistics=function(e,i,n,a,o){var s=this;return t.fetchStatistics(this.entity,this.id,e,i,n,a,function(t){s.setData(t),o&&"function"==typeof o&&o.call(s,t)})},t}(),EventStatistics=extending(Statistics,function(){function t(t){Statistics.apply(this),this.id=t,this.entity=Statistics.ENTITIES.EVENT,this.open_site=[],this.view_detail=[],this.open_conversion=[],this.fave_conversion=[],this.dynamics.fave_conversion=[],this.dynamics.open_conversion=[]}return t}()),OrganizationsStatistics=extending(Statistics,function(){function t(t){Statistics.apply(this),this.id=t,this.entity=Statistics.ENTITIES.ORGANIZATION,this.subscribe=[],this.unsubscribe=[],this.conversion=[],this.audience={},this.dynamics.subscribe=[],this.dynamics.conversion=[]}return t}()),OneTicket=extending(OneEntity,function(){function t(t,e){this.uuid=setDefaultValue(e,0),this.event_id=setDefaultValue(t,0),this.user_id=null,this.type_code=null,this.ticket_type_uuid=null,this.ticket_order_uuid=null,this.status=null,this.checkout=null,this.price=null,this.number=null,this.ticket_type=new OneTicketType,this.order=new OneOrder,this.user=new OneUser,this.created_at=null}return t.prototype.ID_PROP_NAME="uuid",t.fetchTicket=function(t,e,i,n){return __APP.SERVER.getData("/api/v1/events/"+t+"/tickets/"+e,{fields:i},n)},t.check=function(t,e,i){return __APP.SERVER.updateData("/api/v1/statistics/events/"+t+"/tickets/"+e,{checkout:!0},!1,i)},t.uncheck=function(t,e,i){return __APP.SERVER.updateData("/api/v1/statistics/events/"+t+"/tickets/"+e,{checkout:!1},!1,i)},t.prototype.fetchTicket=function(e,i){var n=this;return t.fetchTicket(this.event_id,this.uuid,e,function(t){n.setData(t),i&&"function"==typeof i&&i.call(n,t)})},t.prototype.check=function(e){var i=this;return t.check(this.event_id,this.uuid,function(){i.checkout=!0,e&&"function"==typeof e&&e.call(i,i)})},t.prototype.uncheck=function(e){var i=this;return t.uncheck(this.event_id,this.uuid,function(){i.checkout=!1,e&&"function"==typeof e&&e.call(i,i)})},t}()),EventsTicketsCollection=extending(EntitiesCollection,function(){function t(t){EntitiesCollection.call(this),Object.defineProperty(this,"event_id",{value:setDefaultValue(t,0)})}return t.prototype.collection_of=OneTicket,t.fetchTickets=function(t,e,i){return __APP.SERVER.getData("/api/v1/events/"+t+"/tickets",e,i)},t.prototype.fetchTickets=function(e,i,n,a){var o=this;return t.fetchTickets(this.event_id,{fields:e||void 0,offset:this.length,length:i||void 0,order_by:n||void 0},function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,o.last_pushed)})},t}()),AdminEventsTicketsCollection=extending(EventsTicketsCollection,function(){function t(t){EventsTicketsCollection.call(this,t)}return t.fetchTickets=function(t,e,i){return e=e?e:{},__APP.SERVER.getData("/api/v1/statistics/events/"+t+"/tickets",e,i)},t.prototype.fetchTickets=function(e,i,n,a){var o=this;return t.fetchTickets(this.event_id,{fields:e||void 0,offset:this.length,length:i||void 0,order_by:n||void 0},function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,o.last_pushed)})},t}()),SearchAdminEventsTicketsCollection=extending(AdminEventsTicketsCollection,function(){function t(t,e){AdminEventsTicketsCollection.call(this,e),this.query_string=t}return t.fetchTickets=function(t,e,i,n){return i=i?i:{},$.isNumeric(t)?i.number=t:i.user_name=t,AdminEventsTicketsCollection.fetchTickets(e,i,n)},t.prototype.fetchTickets=function(e,i,n,a){var o=this;return t.fetchTickets(this.query_string,this.event_id,{fields:e||void 0,offset:this.length,length:i||void 0,order_by:n||void 0},function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,o.last_pushed)})},t}()),OneTag=extending(OneEntity,function(){function t(t,e){this.id=t?t:0,this.name="",t&&e&&(this.loading=!0,this.fetchTag(function(){this.loading=!1,$(window).trigger("fetch.OneTag")}))}return t.fetchTag=function(t,e){return __APP.SERVER.getData("/api/v1/tags/"+t,{},e)},t.prototype.fetchTag=function(t){var e=this;return this.constructor.fetchTag(e.id,function(i){e.setData(i[0]),t&&"function"==typeof t&&t.call(e,i[0])})},t}()),TagsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneTag,t.fetchTags=function(t,e){return __APP.SERVER.getData("/api/v1/tags/",t,e)},t.prototype.fetchTags=function(t,e){var i=this;return this.constructor.fetchTags(t,function(t){i.setData(t),e&&"function"==typeof e&&e.call(i,t)})},t}()),OneExtendedTicket=extending(OneTicket,function(){function t(e,i){var n=this;OneTicket.call(this,e,i),this.event=new OneEvent(e),Object.defineProperties(this,{status_name:{get:function(){return localeFromNamespace(n.order.status_type_code,t.TICKET_STATUSES,__LOCALES.ru_RU.TEXTS.TICKET_STATUSES)}},status_type_code:{get:function(){return n.order.status_type_code}}})}return t.prototype.ID_PROP_NAME="uuid",t.TICKET_STATUSES=$.extend({USED:"used"},OneOrder.EXTENDED_ORDER_STATUSES),t.extractTicketFromData=function(t){return t.map(function(t){var e=1===t.tickets.length?t.tickets.shift():t.tickets,i=e.order,n=e.ticket_type;return!i&&t.orders&&(i=t.orders.reduce(function(t,i){return t?t:i.uuid===e.ticket_order_uuid&&i},!1)),!n&&t.ticket_types&&(n=t.ticket_types.reduce(function(t,i){return t?t:i.uuid===e.ticket_type_uuid&&i},!1)),$.extend(e,{event:t,order:i,ticket_type:n})})},t.extractTicketFromEvent=function(e){var i=new OneEvent,n=new t(e.id);return i.setData(e),n.setData($.extend(i.tickets[0],{event:i,event_id:i.id,order:i.orders.getByID(i.tickets[0].ticket_order_uuid)})),n},t.fetchTicket=function(t,e,i,n){var a;return i=Fields.parseFields(i),a=$.extend(!0,{},i.pull("event"),{fields:new Fields({tickets:{filters:"uuid="+e,fields:i}})}),__APP.SERVER.getData("/api/v1/events/"+t,a,n)},t.prototype.fetchTicket=function(e,i){var n=this;return t.fetchTicket(this.event_id,this.uuid,e,function(e){var a=t.extractTicketFromData(e);n.setData(a),i&&"function"==typeof i&&i.call(n,a)})},t}()),ExtendedTicketsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneExtendedTicket,t.convertTicketFieldsToEventAjaxData=function(t){t=t?Fields.parseFields(t):new Fields;var e,i={};return t.has("event")&&(i=t.pull("event")),e=new Fields({tickets:{fields:t}}),i.fields?(i.fields=Fields.parseFields(i.fields),i.fields.push(e)):i.fields=e,i},t.extractTicketsFromEvent=function(e){var i=new OneEvent,n=new t;return i.setData(e),n.setData(i.tickets.map(function(t){return $.extend({},t,{event_id:i.id,event:i})})),n},t}()),EventsExtendedTicketsCollection=extending(ExtendedTicketsCollection,function(){function t(t){ExtendedTicketsCollection.call(this),Object.defineProperty(this,"event_id",{value:t})}return t.fetchTickets=function(t,e,i){return OneEvent.fetchEvent(t,ExtendedTicketsCollection.convertTicketFieldsToEventAjaxData(e).fields,i)},t.prototype.fetchTickets=function(e,i,n,a){var o=this;return t.fetchTickets(this.event_id,e).then(function(t){return o.setData(ExtendedTicketsCollection.extractTicketsFromEvent(t)),a&&"function"==typeof a&&a.call(o,o.last_pushed),o.last_pushed})},t}()),MyTicketsCollection=extending(ExtendedTicketsCollection,function(){function t(){ExtendedTicketsCollection.call(this)}return t.fetchTickets=function(t,e){t=t?t:{};var i=ExtendedTicketsCollection.convertTicketFieldsToEventAjaxData(t.fields);return __APP.SERVER.getData("/api/v1/events",$.extend(i,{length:t.length,offset:t.offset,registered:!0}),e)},t.prototype.fetchTickets=function(e,i,n,a){var o=this;return t.fetchTickets({fields:e||void 0,offset:this.length,length:i||void 0,order_by:n||void 0}).then(function(t){return o.setData(t.map(ExtendedTicketsCollection.extractTicketsFromEvent).reduce(function(t,e){return t.push.apply(t,e),t},[])),a&&"function"==typeof a&&a.call(o,o.last_pushed),o.last_pushed})},t}()),OneTicketType=extending(OneEntity,function(){function t(t,e){this.uuid=setDefaultValue(e,0),this.event_id=setDefaultValue(t,0),this.type_code=null,this.name=null,this.comment=null,this.price=null,this.sell_start_date=null,this.sell_end_date=null,this.start_after_ticket_type_uuid=null,this.amount=null,this.min_count_per_user=null,this.max_count_per_user=null,this.promocode=null,this.promocode_effort=null}return t.prototype.ID_PROP_NAME="uuid",t.fetchTicketType=function(t,e,i,n){return __APP.SERVER.getData("/api/v1/events/"+t+"/ticket_types/"+e,{fields:i},n)},t.prototype.fetchOrder=function(e,i){var n=this;return t.fetchTicketType(this.event_id,this.uuid,e,function(t){n.setData(t),i&&"function"==typeof i&&i.call(n,t)})},t}()),TicketTypesCollection=extending(EntitiesCollection,function(){function t(t){EntitiesCollection.call(this),this.event_id=setDefaultValue(t,0)}return t.prototype.collection_of=OneTicketType,t.fetchTicketTypes=function(t,e,i){return __APP.SERVER.getData("/api/v1/events/"+t+"/ticket_types",e,i)},t.prototype.fetchTicketTypes=function(e,i,n,a){var o=this;return t.fetchTicketTypes(this.event_id,{fields:e||void 0,offset:this.length,length:i||void 0,order_by:n||void 0},function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,o.last_pushed)})},t}()),OneUser=extending(OneEntity,function(){function t(t){var e=this;this.id=setDefaultValue(t,0),this.first_name=null,this.last_name=null,this.middle_name=null,this.gender=null,this.email=null,this.avatar_url=null,this.blurred_image_url=null,this.link=null,this.type=null,this.role=null,this.is_friend=null,this.is_editor=null,this.accounts=[],this.accounts_links={},this.vk_uid=null,this.google_uid=null,this.facebook_uid=null,this.subscriptions=new OrganizationsCollection,this.favored=new FavoredEventsCollection,this.actions=new UsersActivitiesCollection(t),Object.defineProperty(this,"full_name",{enumerable:!0,get:function(){return e.first_name+" "+e.last_name}})}return t.prototype.subscriptions_fields=["img_small_url","subscribed_count","new_events_count","actual_events_count"],Object.freeze(t.prototype.subscriptions_fields),t.ROLE={UNAUTH:"unauth",USER:"user",MODERATOR:"moderator",ADMIN:"admin"},Object.freeze(t.ROLE),t.GENDER={MALE:"male",FEMALE:"female",NEUTRAL:"neutral"},Object.freeze(t.GENDER),t.ACCOUNTS={VK:"vk",GOOGLE:"google",FACEBOOK:"facebook"},Object.freeze(t.ACCOUNTS),t.fetchUser=function(t,e,i){return __APP.SERVER.getData("/api/v1/users/"+t,{fields:e},i)},t.fetchFavored=function(t,e,i){return __APP.SERVER.getData("/api/v1/users/"+t+"/favorites",e,i)},t.fetchSubscriptions=function(t,e,i){return __APP.SERVER.getData("/api/v1/users/"+t+"/subscriptions",e,i)},t.fetchUserActivity=function(t,e,i){return UsersActivitiesCollection.fetch(t,{fields:e},i)},t.recognizeRole=function(e){var i=t.ROLE.USER;return e.forEach(function(e){1!=e.role_id&&e.name!=t.ROLE.ADMIN||(i=t.ROLE.ADMIN),2!=e.role_id&&e.name!=t.ROLE.MODERATOR||i===t.ROLE.ADMIN||(i=t.ROLE.MODERATOR)}),i?i:t.ROLE.UNAUTH},t.prototype.fetchUser=function(e,i){var n=this;return e=setDefaultValue(e,[]),t.fetchUser(n.id,e,function(t){t=t instanceof Array?t[0]:t,n.setData(t),i&&"function"==typeof i&&i.call(n,t)})},t.prototype.fetchFavored=function(e,i){var n=this;return e.offset=this.favored.length,t.fetchFavored(n.id,e).done(function(t){n.favored.setData(t),i&&"function"==typeof i&&i.call(n,n.favored.last_pushed)}).promise()},t.prototype.fetchSubscriptions=function(e,i){var n=this;return e.offset=this.subscriptions.length,t.fetchSubscriptions(n.id,e).done(function(t){n.subscriptions.setData(t),i&&"function"==typeof i&&i.call(n,n.subscriptions.last_pushed)}).promise()},t}()),CurrentUser=extending(OneUser,function(){function t(){return"object"==typeof t.instance?t.instance:(OneUser.call(this,"me"),this.selected_city=new OneCity,this.friends=new UsersCollection,this.friends_activities=new e,void(t.instance=this))}var e=extending(UsersActivitiesCollection,function(){function t(){}return t.fetch=function(t,e){return t=UsersActivitiesCollection.setDefaultData(t),t.fields=t.fields.merge(["user"]),__APP.SERVER.getData("/api/v1/users/feed",t,e)},t}());return t.fetchFriends=function(t,e){return __APP.SERVER.getData("/api/v1/users/friends",t,e)},t.prototype.fetchUser=function(t,e){var i=this,n=OneUser.fetchUser("me",t),a=function(t){t=t instanceof Array?t[0]:t,i.setData(t),e&&"function"==typeof e&&e.call(i,t)};return t=setDefaultValue(t,[]),t.hasOwnProperty("friends")?__APP.SERVER.multipleAjax(n,this.fetchFriends(t.friends)).done(function(t,e){t=t instanceof Array?t[0]:t,t.friends=e,a(t)}).promise():n.done(a).promise()},t.prototype.fetchFriends=function(e,i){var n=this;return e=$.extend(e,{offset:n.friends.length}),t.fetchFriends(e,function(t){n.friends.setData(t),i&&"function"==typeof i&&i.call(n,n.friends.last_pushed)})},t.prototype.logout=function(){return $.ajax({url:"/index.php",data:{logout:!0},complete:function(){window.location="/"}})},t.prototype.isLoggedOut=function(){return this.id===-1},t.prototype.subscribeToOrganization=function(t,e){var i=this;return i.subscriptions.has(t)?(console.warn("Current user is already subscribed to this organization"),null):(OneOrganization.fetchOrganization(t,i.subscriptions_fields,function(t){i.subscriptions.push(t[0]),e&&"function"==typeof e&&e.call(i,t)}),OneOrganization.subscribeOrganization(t))},t.prototype.unsubscribeFromOrganization=function(t,e){var i=this;return i.subscriptions.has(t)?OneOrganization.unsubscribeOrganization(t,function(){i.subscriptions.remove(t),e&&"function"==typeof e&&e.call(i,t)}):(console.warn("Current user isn`t subscribed to this organization"),null)},t}()),UsersCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneUser,t.getSpecificStaff=function(t,e){return e.filter(function(e){return e.role===t})},t.fetchUsers=function(t,e){return __APP.SERVER.getData("/api/v1/users/",t,e)},t.fetchEventFavorites=function(t,e,i){return __APP.SERVER.getData("/api/v1/events/"+t,{fields:"favored".appendAjaxData(__APP.SERVER.validateData(e))},function(t){e.length&&e.offset&&(e.offset+=e.length),i&&"function"==typeof i&&i(t[0].favored)})},t.fetchOrganizationSubscribers=function(t,e,i){return __APP.SERVER.getData("/api/v1/organizations/"+t,{fields:"subscribed".appendAjaxData(__APP.SERVER.validateData(e))},function(t){e.length&&e.offset&&(e.offset+=e.length),i&&"function"==typeof i&&i(t[0].subscribed)})},t.fetchOrganizationStaff=function(t,e,i){return __APP.SERVER.getData("/api/v1/organizations/"+t+"/staff/",e,i)},t.prototype.getSpecificStaff=function(e){return t.getSpecificStaff(e,this)},t.prototype.fetchUsers=function(e,i,n){var a=this,o=$.extend(e,{offset:this.length,length:i});return t.fetchUsers(o,function(t){a.setData(t),n&&"function"==typeof n&&n.call(a,t)})},t.prototype.fetchEventFavorites=function(e,i,n,a){var o=this,s=$.extend({},n,{offset:this.length,length:i});return t.fetchEventFavorites(e,s,function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,t)})},t.prototype.fetchOrganizationSubscribers=function(t,e,i,n){var a=this,o=$.extend({},i,{offset:this.length,length:e});return this.constructor.fetchOrganizationSubscribers(t,o,function(t){a.setData(t),n&&"function"==typeof n&&n.call(a,t)})},t.prototype.fetchOrganizationStaff=function(e,i,n,a){var o=this,s=$.extend({},n,{offset:this.length,length:i});return t.fetchOrganizationStaff(e,s,function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,t)})},t}()),OrganizationSubscribersCollection=extending(UsersCollection,function(){function t(t){UsersCollection.call(this),Object.defineProperty(this,"organization_id",{value:t})}return t.fetchSubscribers=function(t,e,i){return e=e?e:{},__APP.SERVER.getData("/api/v1/organizations/"+t,{fields:new Fields({subscribed:e})},function(t){isFunction(i)&&i(t[0].subscribed)}).then(function(t){return t[0].subscribed})},t.prototype.fetchSubscribers=function(e,i,n,a){var o=this;return t.fetchSubscribers(this.organization_id,{fields:e||void 0,offset:this.length||void 0,length:i||void 0,order_by:n||void 0},function(t){o.setData(t),isFunction(a)&&a.call(o,o.last_pushed)}).then(function(){return o.last_pushed})},t.prototype.fetchAllSubscribers=function(e,i,n,a){var o=this,s=[],r=Math.ceil(e/100);return this.empty(),__APP.SERVER.multipleAjax.apply(__APP.SERVER,new Array(r).fill(!0).map(function(e,a){return t.fetchSubscribers(o.organization_id,{fields:i||void 0,offset:100*a,order_by:n||void 0}).then(function(t){return s=s.concat(t),t})})).then(function(){return o.setData(s),isFunction(a)&&a.call(o,o.last_pushed),o.last_pushed})},t}()),Calendar=function(){function t(e,i){if(this.options={classes:{wrapper_class:"calendar_wrapper",header_class:"calendar_header",prev_btn_class:"calendar_prev_btn",next_btn_class:"calendar_next_btn",month_name_class:"calendar_month_name",table_class:"calendar_month",thead_class:"calendar_thead",tbody_class:"calendar_tbody",tr_class:"calendar_week",head_tr_class:"calendar_weekdays_row",th_class:"calendar_weekday",td_class:"calendar_day",td_additional_classes:[],td_disabled_class:"-disabled",table_cell_class:"calendar_cell",today_class:"today"},additional_dataset:{},selection_type:t.SELECTION_TYPES.SINGLE,weekday_selection:!1,month_selection:!1,disable_selection:!1,min_date:!1,max_date:!1,locale:"ru",labels:{}},e instanceof Element||"string"==typeof e){if(e=$(e),0===e.length)throw new Error("Такого элемента не существует");if(e.length>1)throw new Error("Элементов с заданным аргументов найдено несколько")}if(!(e instanceof jQuery))throw new TypeError("Аргумент должен быть экземпляром jQuery, элементом DOM, либо CSS селектором");$.extend(!0,this.options,i,e.data()),this.options.min_date!==!1&&this.options.max_date!==!1&&moment(this.options.max_date).diff(this.options.min_date,"days")<=0&&(this.options.max_date=!1),this.options.weekday_selection!==!0&&this.options.month_selection!==!0||(this.options.selection_type=t.SELECTION_TYPES.MULTI),this.selected_days=[],this.selected_weeks={},this.selected_months=[],this.last_action="",this.last_selected_days="",this.now_selected_day="",this.prev_selected_day="",this.formatted_days={},this.$calendar=e,this.current_month=moment(new Date),this._today=moment(new Date)}return t.SELECTION_TYPES={SINGLE:"single",MULTI:"multi"},t.prototype.flush=function(){this.selected_days=[],this.selected_weeks={},this.selected_months=[],this.last_action="",this.last_selected_days="",this.now_selected_day="",this.prev_selected_day="",this.formatted_days={},this.destroyTable()},t.prototype.setMonth=function(t,e){switch(t){case"prev":this.current_month=this.current_month.add(-1,"months");break;case"next":this.current_month=this.current_month.add(1,"months");break;case"current":this.current_month=moment(new Date);break;default:this.current_month=e?this.current_month.set({year:e,month:t-1}):this.current_month.month(t-1)}return this.renderTable(),this.$calendar.trigger("month-changed"),this},t.prototype.destroyTable=function(){return this.$calendar.find("."+this.options.classes.th_class).removeClass(__C.CLASSES.ACTIVE).off("click"),this.$calendar.find(".MonthName").removeClass(__C.CLASSES.ACTIVE).off("click"),this.$calendar.find(".CalendarTableBody").remove(),this},t.prototype.setMonthName=function(){return this.$calendar.find(".MonthName").data("month",this.current_month.month()).text(this.current_month.format("MMMM YYYY").capitalize()),this},t.prototype.buildTable=function(){var t,e,i=this.$calendar.find(".CalendarTable"),n=this.current_month.daysInMonth(),a=this.current_month.date(1).day(),o=this.current_month.date(n).day(),s=[],r=[],c=[];for(var l in this.options.additional_dataset)this.options.additional_dataset.hasOwnProperty(l)&&c.push("data-"+l+"="+this.options.additional_dataset[l]);for(var d=1;d<=n;d++)this.current_month.date(d),t=this.current_month.format(__C.DATE_FORMAT),e=moment(t),r=[this.options.classes.table_cell_class,this.options.classes.td_class,"Day_"+t,"DayOfWeek_"+this.current_month.day(),"DayOfMonth_"+this.current_month.month()].concat(this.options.classes.td_additional_classes),(this.options.min_date===!1||e.diff(this.options.min_date,"d")>=0)&&(this.options.max_date===!1||e.diff(this.options.max_date,"d")<=0)||r.push(this.options.classes.td_disabled_class),this.current_month.format(__C.DATE_FORMAT)==this._today.format(__C.DATE_FORMAT)&&r.push(this.options.classes.today_class),s.push(tmpl("calendar-div",{td_classes:r.join(" "),number:this.current_month.date(),day_number:this.current_month.day(),date:this.current_month.format(__C.DATE_FORMAT),date_text:this.current_month.format("DD MMMM YYYY"),dataset:c.join(" ")}));var _=this.current_month.clone();if(1!=a){_.add(-1,"months"),_.date(_.daysInMonth());do t=_.format(__C.DATE_FORMAT),e=moment(t),r=[this.options.classes.table_cell_class,this.options.classes.td_class,"Day_"+t,"DayOfWeek_"+_.day(),"DayOfMonth_"+_.month(),"not_this_month"].concat(this.options.classes.td_additional_classes),(this.options.min_date===!1||e.diff(this.options.min_date,"d")>=0)&&(this.options.max_date===!1||e.diff(this.options.max_date,"d")<=0)||r.push(this.options.classes.td_disabled_class),s.unshift(tmpl("calendar-div",{td_classes:r.join(" "),number:_.date(),day_number:_.day(),date:_.format(__C.DATE_FORMAT),date_text:_.format("DD MMMM YYYY"),dataset:c.join(" ")})),_.add(-1,"days");while(0!=_.day())}if(0!=o){_=this.current_month.clone();do _.add(1,"days"),t=_.format(__C.DATE_FORMAT),e=moment(t),r=[this.options.classes.table_cell_class,this.options.classes.td_class,"Day_"+t,"DayOfWeek_"+_.day(),"DayOfMonth_"+_.month(),"not_this_month"].concat(this.options.classes.td_additional_classes),(this.options.min_date===!1||e.diff(this.options.min_date,"d")>=0)&&(this.options.max_date===!1||e.diff(this.options.max_date,"d")<=0)||r.push(this.options.classes.td_disabled_class),s.push(tmpl("calendar-div",{td_classes:r.join(" "),number:_.date(),day_number:_.day(),date:_.format(__C.DATE_FORMAT),date_text:_.format("DD MMMM YYYY"),dataset:c.join(" ")}));while(0!=_.day())}for(var u=$("<tbody>").addClass("CalendarTableBody"),h=0,f=0,p=[tmpl("calendar-row",{tr_class:this.options.classes.tr_class})],S=0;S<s.length;S++)7==h&&(p.push(tmpl("calendar-row",{tr_class:this.options.classes.tr_class})),h=0,f++),p[f].append(s[S]),h++;return p.forEach(function(t){u.append(t)}),i.append(u),this},t.prototype.renderTable=function(){if(this.destroyTable().buildTable().activateSelectedDays().setMonthName(),!this.options.disable_selection){switch(this.options.selection_type){case t.SELECTION_TYPES.MULTI:this.bindDragSelection();break;case t.SELECTION_TYPES.SINGLE:this.bindDaySelection()}this.options.weekday_selection===!0&&this.bindWeekdaySelection(),this.options.month_selection===!0&&this.bindMonthSelection()}return this},t.prototype.selectToday=function(){return this.$calendar.find("."+this.options.classes.td_class+"."+this.options.classes.today_class).addClass(__C.CLASSES.ACTIVE),this},t.prototype.formatDays=function(){var t={"январь":"января","февраль":"февраля","март":"марта","апрель":"апреля","май":"мая","июнь":"июня","июль":"июля","август":"августа","сентябрь":"сентября","октябрь":"октября","ноябрь":"ноября","декабрь":"декабря"},e=moment(this.now_selected_day),i=e.month(),n=e.month(i),a=n.daysInMonth(),o=n.date(1);for("undefined"==typeof this.formatted_days[i]&&(this.formatted_days[i]={},this.formatted_days[i].selected_days=[],this.formatted_days[i].month_name=t[e.format("MMMM")]),this.formatted_days[i].selected_days.push(e.format(__C.DATE_FORMAT)),this.formatted_days[i].text="";a;)console.log(this.formatted_days[i].selected_days),this.formatted_days[i].selected_days.indexOf(o.format(__C.DATE_FORMAT))!==-1&&(this.formatted_days[i].text+=""+o.format("D")),o=o.add(1,"d"),a--;return console.log(this.formatted_days[i].text),this},t.prototype.selectDays=function(e){function i(e){switch(n.options.selection_type){case t.SELECTION_TYPES.MULTI:n.selected_days.indexOf(e)===-1&&(n.selected_days.push(e),n.selected_days.sort());break;default:case t.SELECTION_TYPES.SINGLE:n.$calendar.find("."+n.options.classes.td_class+"."+__C.CLASSES.ACTIVE).removeClass(__C.CLASSES.ACTIVE),n.selected_days=[e]}n.$calendar.find(".Day_"+e).addClass(__C.CLASSES.ACTIVE)}var n=this;if(Array.isArray(e)){var a=[];e.forEach(function(t){(n.options.min_date===!1||moment(t).diff(n.options.min_date)>=0)&&(n.options.max_date===!1||moment(t).diff(n.options.max_date)<=0)?i(t):a.push(t)}),a.forEach(function(t){e.splice(e.indexOf(t),1)})}else(n.options.min_date===!1||moment(e).diff(n.options.min_date)>=0)&&(n.options.max_date===!1||moment(e).diff(n.options.max_date)<=0)?(i(e),e=[e]):e=[];return e.length&&(n.last_action="select",n.last_selected_days=e,n.$calendar.trigger("days-changed")),this},t.prototype.deselectDays=function(e){function i(t){var e,i=n.$calendar.find(".Day_"+t),a=n.$calendar.find(".Week_"+i.data("weekday")),o=n.$calendar.find(".MonthName"),s=n.current_month.format("YYYY"),r=n.current_month.format("MM"),c=n.current_month.format("YYYY.MM");n.selected_days.splice(n.selected_days.indexOf(t),1),n.selected_days.sort(),n.selected_months.indexOf(c)!==-1&&(o.removeClass(__C.CLASSES.ACTIVE),n.selected_months.splice(n.selected_months.indexOf(c),1)),"undefined"!=typeof n.selected_weeks[s]&&"undefined"!=typeof n.selected_weeks[s][r]&&(e=n.selected_weeks[s][r].indexOf(i.data("weekday")),e!==-1&&(a.removeClass(__C.CLASSES.ACTIVE),n.selected_weeks[s][r].splice(e,1))),n.$calendar.find(".Day_"+t).removeClass(__C.CLASSES.ACTIVE)}var n=this;return this.options.selection_type===t.SELECTION_TYPES.MULTI&&(Array.isArray(e)?e.forEach(function(t){i(t)}):i(e),n.last_action="deselect",n.last_selected_days=e,n.$calendar.trigger("days-changed")),this},t.prototype.selectWeek=function(t){var e,i=this,n=i.$calendar.find(".Week_"+t),a=i.$calendar.find(".DayOfWeek_"+t).not(".not_this_month"),o=i.current_month.format("YYYY"),s=i.current_month.format("MM"),r=[];return a.each(function(t){r.push(a.eq(t).data("date"))}),"undefined"==typeof i.selected_weeks[o]&&(i.selected_weeks[o]={}),"undefined"==typeof i.selected_weeks[o][s]&&(i.selected_weeks[o][s]=[]),e=i.selected_weeks[o][s].indexOf(t),e===-1?(n.addClass(__C.CLASSES.ACTIVE),i.selectDays(r),i.selected_weeks[o][s].push(t)):(n.removeClass(__C.CLASSES.ACTIVE),i.deselectDays(r),i.selected_weeks[o][s].splice(e,1)),this},t.prototype.selectMonth=function(t){var e=this,i=e.$calendar.find(".MonthName"),n=e.$calendar.find(".DayOfMonth_"+t),a=e.current_month.format("YYYY.MM"),o=e.selected_months.indexOf(a),s=[];return n.each(function(t){s.push(n.eq(t).data("date"))}),o===-1?(i.addClass(__C.CLASSES.ACTIVE),e.selectDays(s),e.selected_months.push(a)):(i.removeClass(__C.CLASSES.ACTIVE),e.deselectDays(s),e.selected_months.splice(o,1)),this},t.prototype.bindMonthArrows=function(){var t=this;return this.$calendar.find(".NextMonth").off("click.NextMonth").on("click.NextMonth",function(){t.setMonth("next")}),this.$calendar.find(".PrevMonth").off("click.PrevMonth").on("click.PrevMonth",function(){t.setMonth("prev")}),this},t.prototype.bindDaySelection=function(){var e=this,i=e.$calendar.find("."+this.options.classes.td_class),n=i.not("."+this.options.classes.td_disabled_class);return i.off("click.bindDaySelection"),
n.on("click.bindDaySelection",function(){e.options.selection_type===t.SELECTION_TYPES.MULTI&&$(this).hasClass(__C.CLASSES.ACTIVE)?e.deselectDays($(this).data("date")):e.selectDays($(this).data("date"))}),this},t.prototype.bindWeekdaySelection=function(){var t=this,e=t.$calendar.find("."+this.options.classes.th_class);return e.on("click",function(){t.selectWeek($(this).data("weekday"))}),this},t.prototype.bindMonthSelection=function(){var t=this,e=t.$calendar.find(".MonthName");return e.on("click",function(){t.selectMonth($(this).data("month"))}),this},t.prototype.bindDragSelection=function(){function t(t){t=t.is("."+i.options.classes.td_class)?t:t.closest("."+i.options.classes.td_class),t.not("."+i.options.classes.td_disabled_class).length&&(t.hasClass(__C.CLASSES.ACTIVE)?i.deselectDays(t.data("date")):i.selectDays(t.data("date")))}function e(){i.$calendar.find("."+i.options.classes.td_class).off("mouseenter.DragSelection")}var i=this;return i.$calendar.off("mousedown.RangeSelection").on("mousedown.RangeSelection",function(e){t($(e.target)),i.$calendar.find("."+i.options.classes.td_class).not("."+i.options.classes.td_disabled_class).on("mouseenter.DragSelection",function(e){e.preventDefault(),t($(e.target))})}).on("mouseup",e).on("mouseleave",e),this},t.prototype.activateSelectedDays=function(){var t=this,e=t.current_month.format("YYYY"),i=t.current_month.format("MM");return t.selected_days.forEach(function(e){t.$calendar.find(".Day_"+e).addClass(__C.CLASSES.ACTIVE)}),t.selected_months.indexOf(e+"."+i)!==-1&&t.$calendar.find(".MonthName").addClass(__C.CLASSES.ACTIVE),"undefined"!=typeof t.selected_weeks[e]&&"undefined"!=typeof t.selected_weeks[e][i]&&t.selected_weeks[e][i].forEach(function(e){t.$calendar.find(".Week_"+e).addClass(__C.CLASSES.ACTIVE)}),this},t.prototype.setDaysWithEvents=function(){var t=this,e={since:t.current_month.startOf("month").format(__C.DATE_FORMAT),till:t.current_month.endOf("month").format(__C.DATE_FORMAT),length:500,my:!0,unique:!0};return t.$calendar.find(".feed_calendar_td").removeClass("Controller has_favorites").addClass(__C.CLASSES.DISABLED),DatesCollection.fetchDates(e,function(e){e.forEach(function(e){var i=t.$calendar.find(".Day_"+moment.unix(e.event_date).format(__C.DATE_FORMAT));i.html(tmpl("link",{title:i.children().text(),classes:i.children().get(0).classList,page:"/feed/day/"+i.data("date")})).addClass(e.favorites_count>0?"has_favorites":"").removeClass(__C.CLASSES.DISABLED)}),t.bindDaySelection(),bindPageLinks(t.$calendar)}),this},t.prototype.init=function(){return this.$calendar.empty().append(tmpl("calendar",this.options.classes)),this.options.weekday_selection&&this.$calendar.addClass("-weekday_selection"),this.options.month_selection&&this.$calendar.addClass("-month_selection"),this.$calendar.data("calendar",this),this.$calendar.data("instance",this),this.$calendar.data("days",this.selected_days),this.$calendar.data("options",this.options),this.bindMonthArrows().renderTable(),this},t}(),DatePicker=function(){function t(t,e){if(this.options={classes:{},close_on_pick:!0,min_date:!1,max_date:!1,labels:{}},t instanceof Element||"string"==typeof t){if(t=$(t),0===t.length)throw new Error("Такого элемента не существует");if(t.length>1)throw new Error("Элементов с заданным аргументов найдено несколько")}if(!(t instanceof jQuery))throw new TypeError("Аргумент должен быть экземпляром jQuery, элементом DOM, либо CSS селектором");$.extend(!0,this.options,e,t.data()),this.$datepicker=t,this.$datepicker_modal=tmpl("datepicker",{}),this.$input=t.is("input")?t:t.find("input"),this.calendar=new Calendar(this.$datepicker_modal.children(".DatePickerCalendar"),{min_date:this.options.min_date,max_date:this.options.max_date}),this.prev_selected_day="undefined"!=typeof this.options.selected_day?this.options.selected_day:"",this.selected_day="undefined"!=typeof this.options.selected_day?this.options.selected_day:"",this.formated_selected_day=this.selected_day.toString().split("-").reverse().join(".")}return t.prototype.init=function(){var t=this;return this.bindOpener().$datepicker.data("datepicker",this).data("instance",this),this.$datepicker.addClass("-unselectable -Handled_DatePicker"),this.calendar.init().$calendar.on("days-changed",function(){t.prev_selected_day=t.selected_day,t.selected_day=t.calendar.selected_days.toString(),t.formated_selected_day=t.calendar.selected_days.toString().split("-").reverse().join("."),t.$datepicker.is("input")||t.$datepicker.find("label").text(t.formated_selected_day),t.$input.val(t.selected_day).trigger("change"),t.options.close_on_pick&&t.closeDialog(),t.$datepicker.trigger("date-picked")}),this},t.prototype.bindOpener=function(){function t(){e.$input.is(":disabled")?e.$datepicker.one("click",t):e.openDialog()}var e=this;return this.$datepicker.one("click",t),this},t.prototype.openDialog=function(){var t=this.$datepicker.offset();return $("body").append(this.$datepicker_modal),this.$datepicker_modal.css({top:t.top+this.$datepicker.outerHeight()+2,left:t.left+this.$datepicker.width()-this.$datepicker_modal.width(),maxWidth:this.$datepicker.width()}),this.calendar.renderTable(),this.bindCloseDialog(),this},t.prototype.bindCloseDialog=function(){var t=this;return $(document).off("click.checkOnClick").on("click.checkOnClick",function(e){var i=$(e.target);(0===i.closest(t.$datepicker_modal).length&&0===i.closest(t.$datepicker).length||i.closest(".SubmitDatePicker").length)&&t.closeDialog()}).off("keydown.checkOnKeyDown").on("keydown.checkOnKeyDown",function(e){9!==e.keyCode&&13!==e.keyCode&&27!==e.keyCode||t.closeDialog()}),this},t.prototype.closeDialog=function(){return $(document).off("click.checkOnClick").off("keydown.checkOnKeyDown"),this.$datepicker_modal.detach(),this.calendar.flush(),this.bindOpener(),this},t.prototype.destroy=function(){return this.closeDialog().$datepicker.data("datepicker",""),this},t}(),ImgLoader=function(){function ImgLoader(){}return ImgLoader.current_load_context=null,ImgLoader.init=function(t){t=t?t:$("body"),t.find(".ImgLoadWrap").each(function(){var t=$(this),e=t.find(".ImgSrc"),i=t.find(".ImgPreview");e.off("change.CroppedPreview").on("change.CroppedPreview",function(){i.attr("src",this.value)}),i.attr("src")&&t.find(".CropperButton").removeClass(__C.CLASSES.HIDDEN),t.find(".LoadImg").off("change.LoadImg").on("change.LoadImg",function(e){var i,n=e.target.files;if(0==n.length)return!1;for(var a,o=0;a=n[o];o++)i=new FileReader,i.onload=function(e){return function(i){var n=i.target.result;ImgLoader.handleImgUpload(t,n,e.name)}}(a),i.readAsDataURL(a)}),t.find(".LoadByURLButton").not("-Handled_LoadByURLButton").on("click.LoadByURL",function(){ImgLoader.current_load_context=t,socket.emit("image.getFromURL",t.find(".LoadByURLAddress").val()),Pace.restart()}).addClass("-Handled_LoadByURLButton"),t.find(".CropperButton").off("click.CallCropper").on("click.CallCropper",function(){ImgLoader.callImgCropper(t,t.data("src")?t.data("src"):e.val())})})},ImgLoader.callImgCropper=function($context,source){var $parent=$context.closest(".ImgLoadWrap"),$img_source=$parent.find(".ImgSrc"),cropper_modal=$parent.data("modal");return cropper_modal&&cropper_modal.image_src!=source&&cropper_modal.destroy(),cropper_modal&&cropper_modal.image_src==source||($parent.data("src",source),cropper_modal=new CropperModal(source,{aspectRatio:eval($parent.data("aspect_ratio"))}),$parent.data("modal",cropper_modal)),cropper_modal.show(),cropper_modal.modal.on("crop",function(t,e){$img_source.val(e).trigger("change")}),cropper_modal},ImgLoader.handleImgUpload=function(t,e,i){var n=t.closest(".ImgLoadWrap");n.data("src",e),n.find(".FileName").val(i),n.find(".CropperButton").removeClass(__C.CLASSES.HIDDEN),ImgLoader.callImgCropper(n,e)},ImgLoader}(),ProgressBar=extendingJQuery(function(){function t(i,n){var a={};Object.keys(t.STRINGS).forEach(function(e){null!=i[e]&&(a[t.STRINGS[e]]=i[e])}),jQuery.fn.init.call(this,tmpl("progress-bar",$.extend(!0,Builder.normalizeBuildProps(n),{dataset:a}))),this.options=n,this.$strip=this.find(".ProgressBarComplete"),this.data($.extend({instance:this},n.dataset)),null!=i.NUMBER&&null!=i.OVERALL?e(this.$strip,i.NUMBER/i.OVERALL*100):null!=i.PERCENTAGE&&e(this.$strip,i.PERCENTAGE)}function e(t,e){t.width(Math.roundTo(e,3)+($.isNumeric(e)?"%":""))}return t.STRINGS={NUMBER:"abs_number",OVERALL:"abs_of",PERCENTAGE:"percentage"},t.prototype.set=function(i){var n=this.data();$.isNumeric(i)?(this.attr("data-"+t.STRINGS.NUMBER,i),this.data(t.STRINGS.NUMBER,i),e(this.$strip,i/n[t.STRINGS.OVERALL]*100)):(n[t.STRINGS.NUMBER]&&n[t.STRINGS.OVERALL]?(this.attr("data-"+t.STRINGS.NUMBER,n[t.STRINGS.NUMBER]=n[t.STRINGS.OVERALL]*parseFloat(i)/100),this.data(t.STRINGS.NUMBER,n[t.STRINGS.NUMBER])):(this.attr("data-"+t.STRINGS.PERCENTAGE,n[t.STRINGS.PERCENTAGE]=parseFloat(i)),this.data(t.STRINGS.PERCENTAGE,n[t.STRINGS.PERCENTAGE])),e(this.$strip,i))},t.prototype.setMax=function(i){var n=this.data();this.attr("data-"+t.STRINGS.OVERALL,i),this.data(t.STRINGS.OVERALL,i),e(this.$strip,n[t.STRINGS.NUMBER]/i*100)},t}()),ActionButton=extendingJQuery(function(){function t(e){e=e?e:{};var i=this;this.options=$.extend(!0,{classes:[],icons:null,colors:null,labels:null},this.options,e),this.has_icon=!e.hasOwnProperty("has_icon")||!!e.has_icon,this.is_checked=!!e.is_checked,this.is_add_avatar=!!e.is_add_avatar,this.has_icon?this.options.classes.push(this.icon_class):this.options.icons={},this.options.icons=this.options.icons?this.options.icons:{},this.options.colors=this.options.colors?this.options.colors:{},this.options.labels=this.options.labels?this.options.labels:{},this.classes={},$.each(t.STATES,function(t,e){i.classes[e]=[].concat(i.options.icons?i.options.icons[e]:[]).concat(i.options.colors?i.options.colors[e]:[]).join(" ")}),jQuery.fn.init.call(this,__APP.BUILD.button(this.is_checked?{classes:this.options.classes.concat(this.classes[t.STATES.CHECKED]).concat(this.checked_state_class?this.checked_state_class:[]),title:this.options.labels[t.STATES.CHECKED]}:{classes:this.options.classes.concat(this.classes[t.STATES.UNCHECKED]),title:this.options.labels[t.STATES.UNCHECKED]})),this.data("instance",this),this.initiate()}function e(t){var e=t.closest("."+__C.CLASSES.HOOKS.ADD_AVATAR.ANCESTOR),i=e.find("."+__C.CLASSES.HOOKS.ADD_AVATAR.COLLECTION),n=e.find("."+__C.CLASSES.HOOKS.ADD_AVATAR.QUANTITY),a=i.find(".avatar"),o=a.length;if(i.data("max_amount")>=o)i.hasClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED)?(i.removeClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED),i.width(1==o?0:a.outerWidth()*(o-1)-6*(o-2))):(i.addClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED),i.width(a.outerWidth()*o-6*(o-1)));else{if(n.length){var s=parseInt(n.text());i.hasClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED)?(n.text(s-1),s-1<=0&&n.parent().addClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.CAST)):(n.text(s+1),n.parent().removeClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.CAST))}i.toggleClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFT+" "+__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED)}}return t.STATES={CHECKED:"checked",UNCHECKED:"unchecked",CHECKED_HOVER:"checked_hover",UNCHECKED_HOVER:"unchecked_hover"},t.prototype.checked_state_class="",t.prototype.icon_class=__C.CLASSES.ICON_CLASS,t.prototype.onClick=function(){},t.prototype.afterCheck=function(){var e=this.is(":hover");this.is_checked=!0,this.removeClass("".concat(this.classes[t.STATES.UNCHECKED_HOVER]," ",this.classes[t.STATES.UNCHECKED])).addClass("".concat(this.classes[e?t.STATES.CHECKED_HOVER:t.STATES.CHECKED]," ",this.checked_state_class)).children("."+__C.CLASSES.HOOKS.TEXT).text(this.options.labels[e?t.STATES.CHECKED_HOVER:t.STATES.CHECKED])},t.prototype.afterUncheck=function(){var e=this.is(":hover");this.is_checked=!1,this.removeClass("".concat(this.classes[t.STATES.CHECKED_HOVER]," ",this.classes[t.STATES.CHECKED]," ",this.checked_state_class)).addClass("".concat(this.classes[e?t.STATES.UNCHECKED_HOVER:t.STATES.UNCHECKED])).children("."+__C.CLASSES.HOOKS.TEXT).text(this.options.labels[e?t.STATES.UNCHECKED_HOVER:t.STATES.UNCHECKED])},t.prototype.initiate=function(){var i=this;this.on("mouseenter.HoverActionButton",function(){i.removeClass(i.classes[i.is_checked?t.STATES.CHECKED:t.STATES.UNCHECKED]).addClass(i.classes[i.is_checked?t.STATES.CHECKED_HOVER:t.STATES.UNCHECKED_HOVER]),i.children("."+__C.CLASSES.HOOKS.TEXT).text(i.options.labels[i.is_checked?t.STATES.CHECKED_HOVER:t.STATES.UNCHECKED_HOVER])}).on("mouseleave.LeaveActionButton",function(){i.removeClass(i.classes[i.is_checked?t.STATES.CHECKED_HOVER:t.STATES.UNCHECKED_HOVER]).addClass(i.classes[i.is_checked?t.STATES.CHECKED:t.STATES.UNCHECKED]),i.children("."+__C.CLASSES.HOOKS.TEXT).text(i.options.labels[i.is_checked?t.STATES.CHECKED:t.STATES.UNCHECKED])}).on("click.Action",function(){return __APP.USER.isLoggedOut()?i instanceof SubscribeButton?(cookies.setItem("auth_command","subscribe_to"),cookies.setItem("auth_entity_id",i.org_id),new AuthModal(location.origin+"/organization/"+i.org_id).show()):(i instanceof AddToFavoriteButton?(cookies.setItem("auth_command","add_to_favorite"),cookies.setItem("auth_entity_id",i.event_id)):(cookies.removeItem("auth_command"),cookies.removeItem("auth_entity_id")),new AuthModal(location.origin+"/event/"+i.event_id).show()):(i.onClick(),i.is_add_avatar&&e(i),void(window.askToSubscribe instanceof Function&&window.askToSubscribe()))})},t}()),AddToFavoriteButton=extending(ActionButton,function(){function t(t,e){this.options={labels:{checked:__LOCALES.ru_RU.TEXTS.BUTTON.FAVORED,unchecked:__LOCALES.ru_RU.TEXTS.BUTTON.ADD_FAVORITE,checked_hover:__LOCALES.ru_RU.TEXTS.BUTTON.REMOVE_FAVORITE,unchecked_hover:__LOCALES.ru_RU.TEXTS.BUTTON.ADD_FAVORITE},colors:{checked:__C.CLASSES.COLORS.ACCENT,unchecked:__C.CLASSES.COLORS.MARGINAL_ACCENT,checked_hover:__C.CLASSES.COLORS.ACCENT,unchecked_hover:__C.CLASSES.COLORS.MARGINAL_ACCENT},icons:{checked:__C.CLASSES.ICONS.STAR,unchecked:__C.CLASSES.ICONS.STAR_O,checked_hover:__C.CLASSES.ICONS.TIMES,unchecked_hover:__C.CLASSES.ICONS.STAR_O}},this.event_id=t,ActionButton.call(this,e)}return t.prototype.checked_state_class="-Favored",t.prototype.onClick=function(){var t=this;this.is_checked?OneEvent.deleteFavored(this.event_id,function(){t.afterUncheck()}):OneEvent.addFavored(this.event_id,function(){t.afterCheck()})},t}()),RegisterButton=extending(ActionButton,function(){function t(t,e){this.options={labels:{checked:"Зарегистрирован",unchecked:"Регистрация",checked_hover:"Открыть билеты",unchecked_hover:"Регистрация"},colors:{checked:__C.CLASSES.COLORS.ACCENT,unchecked:__C.CLASSES.COLORS.MARGINAL_ACCENT,checked_hover:__C.CLASSES.COLORS.ACCENT,unchecked_hover:__C.CLASSES.COLORS.MARGINAL_ACCENT},icons:{checked:__C.CLASSES.ICONS.CHECK,unchecked:__C.CLASSES.ICONS.PENCIL,checked_hover:__C.CLASSES.ICONS.TICKET,unchecked_hover:__C.CLASSES.ICONS.PENCIL}},this.event=t,this.modal=null,e.is_checked=t.is_registered,ActionButton.call(this,e)}return t.prototype.checked_state_class="-Registered",t.prototype.onClick=function(){function t(t,e){t.show(),t.modal.one("registration:success",function(){t.event.is_registered=!0,e.afterCheck()})}var e,i,n=this,a=["created_at","number","ticket_type","order"],o=["dates","is_same_time","image_horizontal_medium_url","location"];return this.event.registration_available||this.event.is_registered?void(this.event.is_registered?this.modal&&this.modal instanceof TicketsModal?this.modal.show():(this.event.tickets.length?(e=new EventsExtendedTicketsCollection(this.event.id),i=e.fetchTickets(new Fields(a,{event:{fields:new Fields(o)}}))):i=this.event.fetchEvent(new Fields(o,{tickets:{fields:new Fields(a)}})).done(function(){return e=ExtendedTicketsCollection.extractTicketsFromEvent(n.event)}),i.done(function(){n.modal=new TicketsModal(e),n.modal.show()})):this.modal&&this.modal instanceof RegistrationModal?t(this.modal,this):this.event.registration_fields.length?(this.modal=new RegistrationModal(this.event),t(this.modal,this)):this.event.fetchEvent(new Fields("registration_fields")).done(function(){n.modal=new RegistrationModal(n.event),t(n.modal,n)})):(this.off("click.RippleEffect").addClass(__C.CLASSES.HOOKS.HANDLED+__C.CLASSES.HOOKS.RIPPLE),!1)},t.prototype.initiate=function(){this.event.registration_available||this.event.is_registered?ActionButton.prototype.initiate.call(this):this.attr("disabled",!0)},t}()),SubscribeButton=extending(ActionButton,function(){function t(t,e){this.options={labels:{checked:__LOCALES.ru_RU.TEXTS.BUTTON.SUBSCRIBED,unchecked:__LOCALES.ru_RU.TEXTS.BUTTON.ADD_SUBSCRIPTION,checked_hover:__LOCALES.ru_RU.TEXTS.BUTTON.REMOVE_SUBSCRIPTION,unchecked_hover:__LOCALES.ru_RU.TEXTS.BUTTON.ADD_SUBSCRIPTION},colors:{checked:__C.CLASSES.COLORS.ACCENT,unchecked:__C.CLASSES.COLORS.NEUTRAL_ACCENT,checked_hover:__C.CLASSES.COLORS.ACCENT,unchecked_hover:__C.CLASSES.COLORS.NEUTRAL_ACCENT},icons:{checked:__C.CLASSES.ICONS.CHECK,unchecked:__C.CLASSES.ICONS.PLUS,checked_hover:__C.CLASSES.ICONS.TIMES,unchecked_hover:__C.CLASSES.ICONS.PLUS}},this.org_id=t,ActionButton.call(this,e)}return t.prototype.checked_state_class="-Subscribed",t.prototype.onClick=function(){var t=this;t.is_checked?__APP.USER.unsubscribeFromOrganization(t.org_id,function(){t.afterUncheck(),$(window).trigger("unsubscribe",[t.org_id])}):__APP.USER.subscribeToOrganization(t.org_id,function(){t.afterCheck(),$(window).trigger("subscribe",[t.org_id])})},t}()),ModalsCollection=extending(Array,function(){function t(t){this.max_length=t,Object.defineProperty(this,"last_id",{value:0,writable:!0,enumerable:!1,configurable:!1})}return t.prototype.push=function(t){return t instanceof AbstractModal&&(t.id=++this.last_id,this[this.length++]=t,this.length>this.max_length&&this.shift().destroy()),this.length},t}()),Modals=function(){function t(){return"object"==typeof t.instance?t.instance:(this.collection=new ModalsCollection(5),this.active_modal=null,this.modal_wrapper=$(".modal_wrapper"),this.modal_destroyer=new e($(".modal_destroyer")),void(t.instance=this))}var e=extendingJQuery(function(){function t(t){jQuery.fn.init.call(this,t),this.on("click.CloseModal",function(){AbstractModal.hideCurrent()})}return t.prototype.adjustHeight=function(t){var e=$(window).height(),i=t;return this.height(i>e?i:e)},t}());return t.prototype.bindCallModal=bindCallModal,t}(),AbstractModal=function(){function t(e){this.id=0,this.title="",this.type=this.constructor.name,this.style=e?e:t.STYLES.NONE,this.modal=$(),this.content_wrapper=$(),this.content="",this.scrollTop=0,this.wrapper_is_scrollable=!1,this.content_is_scrollable=!1,this.is_upload_disabled=!1,this.is_rendered=!1,this.is_inited=!1,this.is_shown=!1,__APP.MODALS.collection.push(this)}return t.prototype.modal_wrapper=(new Modals).modal_wrapper,Object.defineProperty(t.prototype,"block_scroll",{get:function(){return t.prototype.modal_wrapper.data("block_scroll")},set:function(e){return t.prototype.modal_wrapper.data("block_scroll",e)}}),t.hideCurrent=function(){__APP.MODALS.active_modal&&__APP.MODALS.active_modal.hide()},t.STYLES={NONE:0,OK_ONLY:1,OK_CANCEL:2,ABORT_RETRY_IGNORE:3,YES_NO_CANCEL:4,YES_NO:5,RETRY_CANCEL:6,CRITICAL:10,QUESTION:11,EXCLAMATION:12,INFORMATION:13},Object.freeze(t.STYLES),t.prototype.__render=function(e){var i;switch(this.style){case t.STYLES.OK_ONLY:i=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.PRIMARY,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"OK"});break;case t.STYLES.OK_CANCEL:i=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.PRIMARY,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"OK"},{classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Отмена"});break;case t.STYLES.ABORT_RETRY_IGNORE:i=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.MARGINAL_BUBBLEGUM,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Прервать"},{classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Повтор"},{classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Пропустить"});break;case t.STYLES.YES_NO_CANCEL:i=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.MARGINAL_FRANKLIN,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Да"},{classes:[__C.CLASSES.COLORS.MARGINAL_BUBBLEGUM,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Нет"},{classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Отмена"});break;case t.STYLES.YES_NO:i=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.MARGINAL_FRANKLIN,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Да"},{classes:[__C.CLASSES.COLORS.MARGINAL_BUBBLEGUM,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Нет"});break;case t.STYLES.RETRY_CANCEL:i=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Повтор"},{classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Отмена"})}return this.modal=__APP.BUILD.modal($.extend({type:this.type,title:this.title,content:this.content,footer_buttons:i},e)),this.content_wrapper=this.modal.find(".ModalContent"),this.is_rendered=!0,this.content||(this.content=this.content_wrapper.children()),this},t.prototype.__init=function(){function e(t){t.is_upload_disabled||t.block_scroll||(t.block_scroll=!0,t.onScrollToBottom(function(){t.block_scroll=!1,t.adjustDestroyerHeight()}))}var i=this;return this.is_rendered?(this.modal.find(".CloseModal").on("click.CloseModal",function(){t.hideCurrent()}),$(document).on("keyup.CloseModal",function(e){27==e.keyCode&&($(this).off("keyup.CloseModal"),t.hideCurrent())}),this.wrapper_is_scrollable&&this.onScrollToBottom!=t.prototype.onScrollToBottom&&this.modal_wrapper.on("scroll",function(){i.modal_wrapper.height()+i.modal_wrapper.scrollTop()>=i.modal.height()&&e(i)}),this.content_is_scrollable&&(this.content.scrollbar({onScroll:this.onScrollToBottom!=t.prototype.onScrollToBottom?function(t){t.scroll==t.maxScroll&&e(i)}:void 0}),this.modal.on("modal:disappear",function(){i.content.scrollTop(0)})),this.is_inited=!0,this):(console.error("Modal has not been rendered yet"),this)},t.prototype.__show=function(){var e=this;return this.is_rendered?(t.hideCurrent(),$("body").addClass("-open_modal"),__APP.MODALS.active_modal=this,this.modal_wrapper.append(this.modal.addClass("-faded").removeClass(__C.CLASSES.HIDDEN)),this.adjustDestroyerHeight(),this.modal.trigger("modal:show"),setTimeout(function(){e.modal.removeClass("-faded"),e.modal_wrapper.scrollTop(e.scrollTop),e.modal.trigger("modal:appear"),e.is_shown=!0},200),this.is_inited||this.init(),this):this.render().show()},t.prototype.__hide=function(){var t=this;return this.scrollTop=this.modal_wrapper.scrollTop(),$(document).off("keyup.CloseModal"),$("body").removeClass("-open_modal"),__APP.MODALS.active_modal=void 0,this.modal.addClass("-faded"),this.modal.trigger("modal:disappear"),setTimeout(function(){t.modal.addClass(__C.CLASSES.HIDDEN).trigger("modal:close"),t.is_shown=!1},200),this},t.prototype.onScrollToBottom=function(t){return t.call(this),this},t.prototype.adjustDestroyerHeight=function(){return __APP.MODALS.modal_destroyer.adjustHeight(this.modal.outerHeight(!0)),this},t.prototype.render=function(t){return this.__render($.extend({classes:[__C.CLASSES.FLOATING_MATERIAL]},t))},t.prototype.init=function(){return this.__init()},t.prototype.show=function(){return this.__show()},t.prototype.hide=function(){return this.__hide()},t.prototype.destroyNested=function(){return this},t.prototype.destroy=function(){var t=__APP.MODALS.collection.indexOf(this);return this.hide(),__APP.MODALS.modal_wrapper.trigger("modal.beforeDestroy"),this.destroyNested(),this.modal.remove(),t!=-1&&__APP.MODALS.collection.splice(t,1),__APP.MODALS.modal_wrapper.trigger("modal.afterDestroy"),this},t}(),AddStaffModal=extending(AbstractModal,function(){function t(t,e){AbstractModal.call(this),this.org_id=t,this.organization=new OneOrganization(this.org_id),this.role=e}return t.prototype.render=function(){return this.content=tmpl("modal-add-staff-content",{modal_id:this.id,org_id:this.org_id,role:this.role}),this.__render({width:380,classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.SIZE.TINY],content_classes:[__C.CLASSES.ALIGN.CENTER]}),this},t.prototype.init=function(){function t(t){return __APP.BUILD.avatarBlocks(t,{avatar_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]}).outerHTML()}var e=this,i=this.content.find(".SearchByName");return bindRippleEffect(this.content),i.select2({width:"100%",placeholder:i.attr("placeholder"),ajax:{url:"/api/v1/users/",dataType:"JSON",data:function(t,e,i){return{name:t}},results:function(e,i,n){var a=new UsersCollection;return a.setData(e.data),{results:a,text:t}}},dropdownCssClass:"form_select2_drop",formatResult:t,formatSelection:t}),this.content.find(".AddStaff").on("click",function(){var t=$(this).closest("form").serializeForm();e.organization.addStaff(t.user_id,t.role,function(i){__APP.CURRENT_PAGE.$view.trigger("staff:add",[t.role,i]),e.hide()})}),this},t}()),AuthModal=extending(AbstractModal,function(){function t(t){AbstractModal.call(this),this.content=tmpl("modal-auth-content",{heading:"Войдите через социальную сеть, чтобы совершить это действие"}),this.redirect_to=t}return t.prototype.render=function(){return this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.SIZE.TINY],content_classes:[__C.CLASSES.ALIGN.CENTER]}),this},t.prototype.init=function(){var t=this;return this.modal.find(".AuthButton").each(function(){$(this).on("click",function(e){var i=$(this).data("auth_network");yaCounter32442130&&yaCounter32442130.reachGoal(i.toUpperCase()+"AuthStart");try{window.localStorage.setItem("redirect_to",encodeURIComponent(t.redirect_to))}catch(t){}isNotDesktop()?window.location.href=__APP.AUTH_URLS[i]:window.open(__APP.AUTH_URLS[i],i.toUpperCase()+"_AUTH_WINDOW","status=1,toolbar=0,menubar=0&height=500,width=700"),e.preventDefault()})}),bindRippleEffect(this.modal),this},t}()),CityChooseModal=extending(AbstractModal,function(){function t(t){AbstractModal.call(this,AbstractModal.STYLES.OK_ONLY),this.cities=t,this.title="Выбор города"}return t.prototype.show=function(){var t=this;return this.cities?(this.__show(),this):(this.cities=new CitiesCollection,this.cities.fetchCities("timediff_seconds",0,"distance,local_name",function(){t.__show()}),this)},t.prototype.render=function(){return this.content=tmpl("modal-city-choose-content",{cities:tmpl("option",this.cities.map(function(t){return{val:t.id,display_name:t.local_name}}))}),this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL],width:400}),this},t.prototype.init=function(){return this.content.find("#city_choose_modal_select").select2({containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}).select2("val",1),this.__init(),this},t.prototype.hide=function(){__APP.USER.selected_city=this.cities.getByID(this.content.find("#city_choose_modal_select").val());try{localStorage.setItem("selected_city",JSON.stringify(__APP.USER.selected_city))}catch(t){}return this.__hide(),__APP.reload(),this},t}()),CropperModal=extending(AbstractModal,function(){function t(t,e){if(AbstractModal.call(this),!t)throw Error("To initiate cropper you need to pass image source (image_src)");e="object"==typeof e?e:{},this.image_src=t,this.content=tmpl("modal-cropper-content",{image_src:this.image_src}),this.options=$.extend({viewMode:1,responsive:!1,scalable:!1,zoomable:!1,zoomOnWheel:!1},e)}return t.prototype.render=function(){var t=this,e=this.content;return this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.SIZE.WIDE],content_classes:[__C.CLASSES.MODAL_STATES.NO_PADDING,__C.CLASSES.IMG_HOLDER],footer_buttons:tmpl("button",[{classes:[__C.CLASSES.COLORS.PRIMARY,"CropButton",__C.CLASSES.HOOKS.RIPPLE].join(" "),title:"Кадрировать"},{classes:[__C.CLASSES.COLORS.DEFAULT,"DestroyCropButton",__C.CLASSES.HOOKS.RIPPLE].join(" "),title:"Отмена"}])}),e.on("load",function(){e.cropper(t.options)}).attr("src",this.image_src),this},t.prototype.init=function(){var t=this;return this.modal.find(".CropButton").on("click.Crop",function(){t.crop(),t.hide()}),this.modal.find(".DestroyCropButton").on("click.DestroyCrop",function(){t.hide()}),this},t.prototype.destroyNested=function(){return this.content.cropper("destroy"),this.modal.find(".CropButton").off("click.Crop"),this.modal.find(".DestroyCropButton").off("click.DestroyCrop"),this},t.prototype.crop=function(){return this.modal.trigger("crop",[this.content.cropper("getCroppedCanvas").toDataURL()]),this},t}()),MapModal=extending(AbstractModal,function(){function t(t){if(AbstractModal.call(this),!t)throw Error("To initiate map you need to pass location (location)");this.location=t}return t.prototype.render=function(){return this.content=tmpl("modal-map-content",{iframe_height:$(window).height()-200,location:this.location}),this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.SIZE.WIDE],content_classes:[__C.CLASSES.MODAL_STATES.NO_PADDING]}),this},t.prototype.show=function(){var t=this,e=$(window);return e.on("resize.changeMapHeight",function(){t.content.height(e.height()-200),t.adjustDestroyerHeight()}),this.__show(),this},t.prototype.hide=function(){return $(window).off("resize.changeMapHeight"),this.__hide(),this},t}()),MediaModal=extending(AbstractModal,function(){function t(t,e){if(AbstractModal.call(this),!t)throw Error("To open media you need to pass media source (src)");"image"===e&&(this.content=tmpl("modal-image-media-content",{src:t})),this.src=t,this.format=e?e:"image"}return t.prototype.render=function(){return this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.SIZE.RESPONSIVE],content_classes:[__C.CLASSES.IMG_HOLDER,__C.CLASSES.MODAL_STATES.NO_PADDING]}),this},t.prototype.show=function(){var t=this;return this.content.on("load",function(){t.adjustDestroyerHeight()}),this.__show(),this},t}()),StdModal=extending(AbstractModal,function(){function t(t,e,i){AbstractModal.call(this,i),this.title=t,this.content=e}return t.STYLES=AbstractModal.STYLES,Object.freeze(t.STYLES),t}()),TicketsModal=extending(AbstractModal,function(){function t(t){if(AbstractModal.call(this),t instanceof ExtendedTicketsCollection)this.tickets=t;else{if(!(t instanceof Array||t instanceof OneExtendedTicket))throw Error("Constructor needs instance of OneExtendedTicket class to create new instance of TicketsModal");this.tickets=new ExtendedTicketsCollection,this.tickets.setData(t)}}return t.prototype.render=function(){var t=this;return this.content=tmpl("modal-ticket-content",Builder.normalizeTicketProps(this.tickets).map(function(e,i){var n=t.tickets[i].order.payed_at||t.tickets[i].created_at;return e.cover_width=450,e.card_classes.push("-ticket_extended",__C.CLASSES.FLOATING_MATERIAL),$.extend(e,{cover_height:253,number_formatted:formatTicketNumber(t.tickets[i].number),payed_at_formatted:(t.tickets[i].order.payed_at?"Куплен ":"Приобретен ")+moment.unix(n).format(__LOCALES.ru_RU.DATE.DATE_TIME_FORMAT),price_formatted:+t.tickets[i].price?formatCurrency(t.tickets[i].price," ",".","","руб."):"Бесплатно"})})),this.__render({content_classes:[__C.CLASSES.MODAL_STATES.NO_PADDING]}),this},t}()),AbstractListModal=extending(AbstractModal,function(){function t(t){AbstractModal.call(this),this.content=tmpl("modal-list-content"),this.entity=t,this.entities=new EntitiesCollection,this.content_is_scrollable=!0}return t.prototype.render=function(){return this.__render({width:384,height:"calc(100% - 140px)",classes:["material","-floating","-fixed"],content_classes:["list_modal_content"]
}),this},t.prototype.uploadEntities=function(){return $.Deferred.resolve().promise()},t.prototype.buildEntities=function(t){return $()},t.prototype.show=function(){var t=this;return this.content.children().length?(this.__show(),this):(this.render(),this.content.append(this.buildEntities(this.entities)),this.entities.length<5?this.uploadEntities().done(function(){t.__show()}):this.__show(),this)},t.prototype.onScrollToBottom=function(t){var e=this,i=__APP.BUILD.loaderBlock(this.content);return this.uploadEntities().fail(function(){e.block_scroll=!1}).done(function(){i.remove(),t.call(e)}),this},t}()),FriendsListModal=extending(AbstractListModal,function(){function t(e){return"object"==typeof t.instance?t.instance:(AbstractListModal.call(this,e),this.title="Подписки на пользователей",this.entities=this.entity.friends,void(t.instance=this))}return t.prototype.uploadEntities=function(){var t=this;return __APP.USER.fetchFriends({length:20}).done(function(e){e.length?t.content.append(t.buildEntities(e)):t.is_upload_disabled=!0}).promise()},t.prototype.buildEntities=function(t){var e=__APP.BUILD.avatarBlocks(t,{is_link:!0,entity:__C.ENTITIES.USER,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]});return bindPageLinks(e),e},t}()),SubscriptionsListModal=extending(AbstractListModal,function(){function t(t){AbstractListModal.call(this,t),this.title="Подписки на организации",this.entities=this.entity.subscriptions}return t.prototype.uploadEntities=function(){var t=this;return this.entity.fetchSubscriptions({length:20}).done(function(e){e.length?t.content.append(t.buildEntities(e)):t.is_upload_disabled=!0}).promise()},t.prototype.buildEntities=function(t){var e=__APP.BUILD.avatarBlocks(t,{is_link:!0,entity:__C.ENTITIES.ORGANIZATION,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]});return bindPageLinks(e),e},t}()),PreviewRegistrationModal=extending(AbstractModal,function(){function t(t){AbstractModal.call(this),this.event=t,this.title="Регистрация"}return t.prototype.render=function(){var t=this;return this.__render({classes:["material","-floating"],width:400,content:tmpl("modal-registration-content",{modal_id:this.id,required_star:tmpl("required-star"),event_title:this.event.title,fields:$.makeSet(this.event.registration_fields.map(t.buildRegistrationField.bind(t)))})}),this},t.prototype.init=function(){return this.content.find(".RegisterButton").prop("disabled",!0),this.__init(),this},t.prototype.buildRegistrationField=function(t){return __APP.BUILD.formInput({id:"registration_form_"+this.id+"_"+t.uuid,type:t.type===RegistrationFieldModel.TYPES.EXTENDED_CUSTOM?"textarea":t.type,name:t.uuid,classes:["Registration"+t.type.toCamelCase("_")+"Field"],label:$("<span>"+t.label+"</span>").add(t.required?tmpl("required-star"):$()),placeholder:t.label,required:t.required,helptext:function(t){switch(t){case RegistrationFieldModel.TYPES.EMAIL:return"На почту Вам поступит сообщение с подтверждением регистрации";case RegistrationFieldModel.TYPES.FIRST_NAME:return"Используйте настоящее имя для регистрации";case RegistrationFieldModel.TYPES.LAST_NAME:return"Используйте настоящюю фамилию для регистрации";default:return""}}(t.type)})},t}()),RegistrationModal=extending(PreviewRegistrationModal,function(){function t(t){PreviewRegistrationModal.call(this,t)}return t.prototype.init=function(){var t=this;return this.content.find(".RegisterButton").on("click.Register",function(){var e=$(this),i=e.closest(".RegistrationModalForm");e.attr("disabled",!0),isFormValid(i)?OneEvent.registerToEvent(t.event.id,i.serializeForm("array").map(function(t){return{uuid:t.name,value:t.value}})).always(function(){e.removeAttr("disabled")}).done(function(){t.modal.trigger("registration:success"),t.hide()}):e.removeAttr("disabled")}),this.content.find(".RegistrationFirstNameField").val(__APP.USER.first_name),this.content.find(".RegistrationLastNameField").val(__APP.USER.last_name),this.content.find(".RegistrationEmailField").val(__APP.USER.email),bindRippleEffect(this.content),this.__init(),this},t}()),AbstractUsersModal=extending(AbstractModal,function(){function t(e,i){if(AbstractModal.call(this),this.title=i,this.entity_id=e,this.entities_length=30,this.is_upload_disabled=!1,this.users=new UsersCollection,this.is_first=!0,this.wrapper_is_scrollable=!0,this.constructor===t)throw new Error("Can't instantiate abstract class!")}return t.prototype.show=function(){var t=this;return this.block_scroll=!1,this.users.length?(this.__show(),this):(this.render({width:"60%"}),this.uploadUsers(function(){t.__show()}),this)},t.prototype.init=function(){return bindPageLinks(this.modal),this.__init(),this},t.prototype.onScrollToBottom=function(t){var e=this;return this.uploadUsers(function(){t.call(e)}),this},t.prototype.hide=function(){return this.block_scroll=!1,this.modal_wrapper.off("scroll.uploadUsers"),this.__hide(),this},t.prototype.uploadUsers=function(t){},t.prototype.buildUsers=function(t){var e=$(),i="true"==this.content_wrapper.find(".UserTombstone").eq(-1).data("is_friend"),n=this;return t.forEach(function(t,a){(n.is_first&&!a||i!=t.is_friend)&&(e=e.add(tmpl("modal-users-divider",{label:t.is_friend?"Друзья":"Все"})),i=t.is_friend),e=e.add(__APP.BUILD.userTombstones(t,{tombstone_classes:["UserTombstone"],is_link:!0,dataset:{is_friend:t.is_friend}}))}),e},t.prototype.afterUpload=function(t){var e,i=this;t.length?(e=this.buildUsers(t),this.content_wrapper.append(e),this.is_first=!1,this.entities_length=10,this.adjustDestroyerHeight(),bindPageLinks(e),e.on("click.hideModal",function(){i.hide()})):this.is_upload_disabled=!0},t}()),EditorsModal=extending(AbstractUsersModal,function(){function t(t,e,i){AbstractUsersModal.call(this,t,e?e:"Редакторы"),this.ajax_data={order_by:"role,first_name"},i&&(this.ajax_data.roles=i)}return t.prototype.uploadUsers=function(t){var e=this;return this.users.fetchOrganizationStaff(this.entity_id,this.entities_length,this.ajax_data,function(i){e.afterUpload(i),t&&"function"==typeof t&&t(i)})},t.prototype.buildUsers=function(t){var e=$(),i=this.content_wrapper.find(".UserTombstone").last().data("role"),n={admin:"Администраторы",moderator:"Модераторы"},a=this;return t.forEach(function(t,o){(a.is_first&&!o||i!=t.role)&&(e=e.add(tmpl("modal-users-divider",{label:n[t.role]})),i=t.role),e=e.add(__APP.BUILD.userTombstones(t,{tombstone_classes:["UserTombstone"],is_link:!0,dataset:{role:t.role}}))}),e},t}()),FavoredModal=extending(AbstractUsersModal,function(){function t(t,e){if(!t)throw Error("To open favored modal you need to pass event_id");AbstractUsersModal.call(this,t,e?e:"Добавили в избранное"),this.ajax_data={fields:["is_friend"],order_by:"-is_friend,first_name"}}return t.prototype.uploadUsers=function(t){var e=this;return this.users.fetchEventFavorites(this.entity_id,this.entities_length,this.ajax_data,function(i){e.afterUpload(i),t&&"function"==typeof t&&t(i)})},t}()),SubscribersModal=extending(AbstractUsersModal,function(){function t(t,e){if(!t)throw Error("To open favored modal you need to pass organization_id");AbstractUsersModal.apply(this,[t,e?e:"Подписались"]),this.entity_id=t,this.ajax_data={fields:["is_friend"],order_by:"-is_friend,first_name"}}return t.prototype.uploadUsers=function(t){var e=this;return this.users.fetchOrganizationSubscribers(this.entity_id,this.entities_length,this.ajax_data,function(i){e.afterUpload(i),t&&"function"==typeof t&&t(i)})},t}()),Builder=function(){function t(){return"object"==typeof t.instance?t.instance:void(t.instance=this)}return t.normalizeBuildProps=function(t,e,i,n){return t=t?t:{},e?e.push("classes"):e=["classes"],i?i.push("dataset"):i=["dataset"],n?n.push("attributes"):n=["attributes"],e.forEach(function(e){t[e]=t[e]?"string"==typeof t[e]?t[e].split(" "):t[e]:[],t[e].toString=Array.toSpaceSeparatedString}),i.forEach(function(e){t[e]=t[e]?t[e]:{},t[e].toString=Array.isArray(t[e])?Array.toSpaceSeparatedString:Object.toHtmlDataSet}),n.forEach(function(e){t[e]=t[e]?t[e]:{},t[e].toString=Array.isArray(t[e])?Array.toSpaceSeparatedString:Object.toHtmlAttributes}),t},t.prototype.button=function(){var e=Array.prototype.slice.call(arguments);return tmpl("button",e.map(function(e){return t.normalizeBuildProps(e)})).each(function(t,i){e[t].dataset&&$(i).data(e[t].dataset)})},t.prototype.input=function(e,i,n){return tmpl("input",t.normalizeBuildProps({classes:i,attributes:e,dataset:n})).each(function(t,e){n&&$(e).data(n)})},t.prototype.textarea=function(e,i,n,a){return tmpl("textarea",t.normalizeBuildProps({value:n,classes:i,attributes:e,dataset:a})).each(function(t,e){a&&$(e).data(a)})},t.prototype.link=function(e){return bindPageLinks(tmpl("link",[].map.call(arguments,function(e){return t.normalizeBuildProps(e)})))},t.prototype.radioCheckbox=function(e,i){if("checkbox"==e||"radio"==e)return i=t.normalizeBuildProps(i,["unit_classes"]),i.classes.indexOf("form_checkbox")==-1&&i.classes.indexOf("form_radio")==-1&&i.classes.unshift("form_"+e),i.unit_classes.unshift("form_unit"),i.attributes.checked||delete i.attributes.checked,i.attributes.tabindex=i.attributes.tabindex?i.attributes.tabindex:-1,tmpl("radio-checkbox",$.extend(i,{type:e}));throw Error('Принимаемый аргумент type может быть либо "radio" либо "checkbox", придурок')},t.prototype.radio=function(t){var e=this;return $.makeSet([].map.call(arguments,function(t){return e.radioCheckbox("radio",t)}))},t.prototype.checkbox=function(t){var e=this;return $.makeSet([].map.call(arguments,function(t){return e.radioCheckbox("checkbox",t)}))},t.prototype.radioGroup=function(e){var i,n=this,a=$.extend({},t.normalizeBuildProps(e));return a.units instanceof jQuery||(a.units=n.radio.apply(n,a.units.map(function(t){var e=$.extend(t,{name:a.name});return e.id||(e.id=guid()),e}))),i=tmpl("radio-group",a),i.data(e.dataset),i},t.prototype.formHelpText=function(e,i,n){return tmpl("form-helptext",t.normalizeBuildProps({text:e,dataset:i,attributes:n}))},t.prototype.formInput=function(e){var i=this,n=["hidden","text","search","tel","url","email","password","date","time","number","range","color","checkbox","radio","file","submit","image","reset","button"];return $.makeSet(Array.prototype.map.call(arguments,function(e){switch(e.type){case"radio":return i.radio(e);case"checkbox":return i.checkbox(e);default:return tmpl("form-unit",t.normalizeBuildProps($.extend(!0,{},e,{form_element:"textarea"===e.type?i.textarea($.extend({},e.attributes,{id:e.id,name:e.name||void 0,required:e.required||void 0,placeholder:e.placeholder,tabindex:e.tabindex}),e.classes?["form_textarea"].concat(e.classes):["form_textarea"],e.value,e.dataset):i.input($.extend({},e.attributes,{id:e.id,type:e.type&&n.indexOf(e.type)!==-1?e.type:"text",name:e.name||void 0,value:e.value||void 0,required:e.required||void 0,placeholder:e.placeholder,tabindex:e.tabindex}),e.classes?["form_input"].concat(e.classes):["form_input"],e.dataset),helptext:i.formHelpText(e.helptext,e.helptext_dataset,e.helptext_attributes)}),["unit_classes","label_classes"]))}}))},t.prototype.cap=function(e,i){return i||(i={}),i=t.normalizeBuildProps(i),tmpl("cap",$.extend({message:e},i))},t.prototype.tags=function(e,i){function n(t){return $.extend(!0,{},{name:t.name.toLowerCase(),page:"/search/"+encodeURIComponent("#"+t.name.toLowerCase())},i)}return i=t.normalizeBuildProps(i),e instanceof Array?tmpl("tag",e.map(n)):tmpl("tag",n(e))},t.prototype.orderStatusBlock=function(t){return tmpl("order-status",{name:localeFromNamespace(t,OneOrder.EXTENDED_ORDER_STATUSES,__LOCALE.TEXTS.TICKET_STATUSES),status:function(t){switch(t){case OneOrder.EXTENDED_ORDER_STATUSES.PAYED:case OneOrder.EXTENDED_ORDER_STATUSES.APPROVED:case OneOrder.EXTENDED_ORDER_STATUSES.WITHOUT_PAYMENT:return"success";case OneOrder.EXTENDED_ORDER_STATUSES.IS_PENDING:case OneOrder.EXTENDED_ORDER_STATUSES.WAITING_FOR_PAYMENT:return"warning";case OneOrder.EXTENDED_ORDER_STATUSES.REJECTED:case OneOrder.EXTENDED_ORDER_STATUSES.RETURNED_BY_CLIENT:case OneOrder.EXTENDED_ORDER_STATUSES.PAYMENT_CANCELED_AUTO:case OneOrder.EXTENDED_ORDER_STATUSES.RETURNED_BY_ORGANIZATION:case OneOrder.EXTENDED_ORDER_STATUSES.PAYMENT_CANCELED_BY_CLIENT:return"error"}}(t)})},t.prototype.loaderBlock=function(t,e){return tmpl("loader-block",{loader:tmpl("loader")},t,e)},t.prototype.overlayLoader=function(t,e){return tmpl("loader-block",{classes:"-loader_overlay",loader:tmpl("loader")},t,e)},t.prototype.socialLinks=function(e,i){var n=[],a={VK:"vk",GOOGLE:"google-plus",FACEBOOK:"facebook-official"};return $.each(OneUser.ACCOUNTS,function(o,s){var r={slug:s,icon_slug:a[o]};e.hasOwnProperty(s)?(r.html_tag="a",r.attributes={href:e[s],target:"_blank"}):r.html_tag="span",n.push(t.normalizeBuildProps($.extend(r,i)))}),tmpl("user-social-links-wrapper",{links:tmpl("user-social-link",n)})},t.prototype.userTombstones=function(e,i){var n=this;return i=t.normalizeBuildProps(i,["avatar_classes","tombstone_classes"]),i.avatar_classes.push("-rounded"),i.avatar_classes.push("-size_"+(i.size?i.size:"70x70")),i.is_link?(i.html_tag="a",i.tombstone_classes.push("link Link")):i.html_tag="div",tmpl("user-tombstone",(e instanceof Array?e:[e]).map(function(t){return i.is_link&&(i.attributes.href="/user/"+t.id),$.extend(!0,{},t,{avatar:n.avatars(t,{classes:i.avatar_classes}),name:t.full_name?t.full_name:[t.first_name,t.last_name].join(" ")},i)}))},t.prototype.avatarBlocks=function(e,i){var n=this;return i=t.normalizeBuildProps(i,["avatar_classes","block_classes"]),i.is_link?(i.html_tag="a",i.block_classes.push("link","Link")):i.html_tag="div",tmpl("avatar-block",(e instanceof Array?e:[e]).map(function(t){var e,a;return i.entity&&i.entity===__C.ENTITIES.USER||t instanceof OneUser||t.first_name?(e=t.full_name?t.full_name:t.first_name+" "+t.last_name,a="/user/"+t.id):(e=t.short_name?t.short_name:t.name,a="/organization/"+t.id),$.extend(!0,{id:t.id,avatar:n.avatars(t,{classes:i.avatar_classes}),attributes:{href:a},name:e},i)}))},t.prototype.staffAvatarBlocks=function(t,e,i,n){var a=this;return tmpl("staff-avatar-block",e.map(function(t){return{avatar_block:a.avatarBlocks(t,i),can_edit:n?"-can_edit":""}})).each(function(t,n){var a={user:e[t]};i&&i.dataset&&$.extend(a,i.dataset),$(n).data(a)}).find(".RemoveStaff").on("click.RemoveStaff",function(){var e=$(this).closest(".StaffAvatarBlock"),i=e.data("user"),n=tmpl("staff-avatar-block-removing",{username:[i.first_name,i.last_name].join(" ")});OneOrganization.removeStaff(t,i.id,i.role).done(function(){e.after(n),e.detach(),n.find(".ReturnStaff").on("click",function(){OneOrganization.addStaff(t,i.id,i.role).done(function(){n.after(e),n.remove()})})})}).end()},t.prototype.addUserAvatarBlock=function(e,i,n){var a;switch(n=t.normalizeBuildProps(n,["avatar_classes","block_classes"]),n.block_classes.push("link",__C.CLASSES.HOOKS.ADD_STAFF,__C.CLASSES.HOOKS.CALL_MODAL),i){case OneUser.ROLE.ADMIN:a="Добавить администратора";break;case OneUser.ROLE.MODERATOR:a="Добавить модератора"}return tmpl("avatar-block",$.extend({html_tag:"div",name:a,avatar:tmpl("avatar",{classes:n.avatar_classes,avatar_url:window.location.origin+"/app/img/add_user.svg"})},n)).data({modal_type:"add_staff",modal_org_id:e,modal_role:i})},t.prototype.avatars=function(e,i){function n(t){return $.extend(!0,{avatar_url:t.avatar_url,name:t.full_name?t.full_name:t.first_name+" "+t.last_name},i)}function a(t){return $.extend(!0,{avatar_url:t.img_small_url?t.img_small_url:t.img_url,name:t.short_name?t.short_name:t.name},i)}var o,s=function(){},r=[];if(!(!e||e instanceof Array&&!e.length)){switch(i=t.normalizeBuildProps(i),!0){case e instanceof OneUser:case e instanceof UsersCollection:s=n;break;case e instanceof OneOrganization:case e instanceof OrganizationsCollection:s=a;break;default:r=e instanceof Array?e:[e],s=r[0].avatar_url?n:a}return o=e instanceof Array?e:[e],tmpl("avatar",o.map(s))}},t.prototype.avatarCollection=function(e,i,n,a){var o=t.normalizeBuildProps(n,["counter_classes"]),s=i;return o.dataset.max_amount=i,o.classes.push("-max_"+i),o.avatars=this.avatars(__APP.USER).add(this.avatars(e.filter(function(t){return __APP.USER.id!=t.id&&!(s--<=0)}))),o.more_avatars_count=(a?a:e.length)-i,o.more_avatars_count<=0&&o.counter_classes.push("-cast"),tmpl("avatars-collection",o)},t.prototype.activity=function(e,i){var n=this instanceof t?this:new t,a={};return a[OneAbstractActivity.TYPES.SUBSCRIBE]="plus",a[OneAbstractActivity.TYPES.FAVE]="star",a[OneAbstractActivity.TYPES.UNSUBSCRIBE]=a[OneAbstractActivity.TYPES.UNFAVE]="minus",i=t.normalizeBuildProps(i,["avatar_classes"]),i.avatar_classes.push(__C.CLASSES.SIZES.X50,__C.CLASSES.UNIVERSAL_STATES.ROUNDED),tmpl("activity-block",(e instanceof Array?e:[e]).map(function(t){var e={},o=__LOCALES.ru_RU.TEXTS.ACTIVITY[OneAbstractActivity.TYPES_INDEX[t.type_code]];switch(!0){case t instanceof OneOrganizationActivity:e={entity:"organization",img_url:t.organization.img_small_url?t.organization.img_small_url:t.organization.img_url,entity_url:"/organization/"+t.organization.id,hero_text:t.organization.short_name};break;case t instanceof OneEventActivity:e={entity:"event",img_url:t.event.image_horizontal_small_url?t.event.image_horizontal_small_url:t.event.image_horizontal_url,entity_url:"/event/"+t.event.id,hero_text:t.event.title}}return $.extend(e,{creator_avatar:n.avatars(t.user,{classes:i.avatar_classes,is_link:i.avatar_is_link,badge:tmpl("avatar-badge",{icon_class:a[t.type_code]})}),type_code:t.type_code,additional_info:getGenderText(t.user.gender,o),creator_url:"/user/"+t.user.id,creator_name:t.user.full_name?t.user.full_name:t.user.first_name+" "+t.user.last_name,date:moment.unix(t.created_at).calendar(null,__LOCALES.ru_RU.DATE.CALENDAR_DATE_TIME)})}))},t.prototype.organizationItems=function(e,i){e=e instanceof Array?e:[e];var n=this,a=e.map(function(t){return t.counter_classes=t.new_events_count?[]:[__C.CLASSES.HIDDEN],t});return tmpl("organization-item",a.map(function(e){return $.extend(!0,{avatar_block:n.avatarBlocks(e,{entity:__C.ENTITIES.ORGANIZATION,avatar_classes:[__C.CLASSES.SIZES.X30]})},e,t.normalizeBuildProps(i,["avatar_classes","block_classes","counter_classes"]))}))},t.prototype.organizationCard=function(t){var e=this;return tmpl("organization-card",t.map(function(t){return $.extend(!0,{},t,{background_image:t.background_small_img_url||t.background_img_url?e.link({page:"/organization/"+t.id,classes:["organization_unit_background"],attributes:{style:"background-image: url("+(t.background_small_img_url||t.background_img_url)+")"}}):"",avatar:e.avatars(t,{classes:["organization_unit_avatar",__C.CLASSES.SIZES.X55,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.SHADOWED]}),subscribe_button:new SubscribeButton(t.id,{is_checked:t.is_subscribed,colors:{unchecked:__C.CLASSES.COLORS.MARGINAL_ACCENT,unchecked_hover:__C.CLASSES.COLORS.MARGINAL_ACCENT},has_icons:!1,classes:[__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.RIPPLE]}),subscribed_text:t.subscribed_count+getUnitsText(t.subscribed_count,__LOCALES.ru_RU.TEXTS.SUBSCRIBERS),redact_org_button:t.role===OneUser.ROLE.UNAUTH||t.role===OneUser.ROLE.USER?"":e.link({classes:["button",__C.CLASSES.SIZES.LOW,__C.CLASSES.COLORS.MARGINAL_PRIMARY,__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.PENCIL,__C.CLASSES.UNIVERSAL_STATES.EMPTY,__C.CLASSES.HOOKS.RIPPLE],page:"/admin/organization/"+t.id+"/edit"})})}))},t.prototype.eventBlocks=function(t,e){var i=this;return tmpl("event-block",t.map(function(t){var n=e.sort_date_type?e.sort_date_type:"nearest_event_date",a=moment.unix(t[n]?t[n]:t.first_event_date),o=e.last_date!=a.format(__C.DATE_FORMAT),s=[__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.SIZES.SMALL,__C.CLASSES.HOOKS.ADD_AVATAR.COLLECTION,__C.CLASSES.HOOKS.CALL_MODAL],r=$();return t.is_favorite&&s.push(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED),null!=t.is_favorite&&(t.registration_locally||t.ticketing_locally?(r=r.add(new AddToFavoriteButton(t.id,{is_add_avatar:!0,is_checked:t.is_favorite,classes:[__C.CLASSES.UNIVERSAL_STATES.EMPTY,__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.ADD_TO_FAVORITES,__C.CLASSES.HOOKS.RIPPLE],labels:null})),t.ticketing_locally||(r=r.add(new RegisterButton(t,{classes:["event_block_main_action_button",__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.ADD_TO_FAVORITES,__C.CLASSES.HOOKS.RIPPLE]})))):r=new AddToFavoriteButton(t.id,{is_add_avatar:!0,is_checked:t.is_favorite,classes:["event_block_main_action_button",__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.ADD_TO_FAVORITES,__C.CLASSES.HOOKS.RIPPLE]})),e.last_date=a.format(__C.DATE_FORMAT),$.extend({},t,{cover_width:550,divider:o?tmpl("divider",{title:a.calendar().capitalize()}):"",action_buttons:r,date:a.format(__C.DATE_FORMAT),avatars_collection:i.avatarCollection(t.favored,3,{dataset:{modal_type:"favors",modal_event_id:t.id},classes:s,counter_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.COLORS.MARGINAL,__C.CLASSES.HOOKS.ADD_AVATAR.STATES.CASTABLE]},t.favored_users_count),time:t.dates.reduce(function(t,e){return moment.unix(e.event_date).format(__C.DATE_FORMAT)==a.format(__C.DATE_FORMAT)&&t.push(displayTimeRange(e.start_time,e.end_time)),t},[]).join("; ")})}))},t.prototype.organisationsCategoriesItems=function(t){return t instanceof Array||(t=[t]),tmpl("organization-category",t.map(function(t){var e,i=!0,n=[];return t.organizations&&t.organizations.new_events_count?i?(e=t.organizations.reduce(function(t,e){return t+e.new_events_count},0),n=e?["counter"]:["counter",__C.CLASSES.HIDDEN]):n=["fa_icon","fa-angle-down","-empty"]:(e="",n=[__C.CLASSES.HIDDEN]),{category_id:t.id,category_name:t.name,order_position:t.order_position,aside_classes:n,new_events_count:i?"+"+e:""}}))},t.prototype.subscribers=function(t,e){var i=this;return tmpl("subscriber",t.map(function(t,n){var a="undefined"==typeof e||e!==t.is_friend;return e=t.is_friend,{divider:a?tmpl("subscriber-divider",{label:t.is_friend?"Друзья":"Все подписчики"}):"",avatar_block:i.avatarBlocks(t,{is_link:!0,entity:__C.ENTITIES.USER,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.UNIVERSAL_STATES.SHADOWED],block_classes:["subscriber"]})}}))},t.prototype.eventCards=function(t){var e,i=this,n=t instanceof Array?t:[t];return e=tmpl("event-card",n.map(function(t){var e,n=405,a=[__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.SIZES.SMALL,__C.CLASSES.HOOKS.ADD_AVATAR.COLLECTION,__C.CLASSES.HOOKS.CALL_MODAL],o=[],s=new OneOrganization(t.organization_id),r=$();return s.setData({short_name:t.organization_short_name,img_url:t.organization_logo_small_url}),t.registration_locally||t.ticketing_locally?(r=new AddToFavoriteButton(t.id,{is_add_avatar:!0,is_checked:t.is_favorite,classes:["feed_event_header_button",__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.EMPTY],labels:null,icons:{checked_hover:__C.CLASSES.ICONS.STAR},colors:{checked:__C.CLASSES.TEXT_COLORS.ACCENT,unchecked:"",checked_hover:__C.CLASSES.TEXT_COLORS.ACCENT,unchecked_hover:""}}),t.ticketing_locally||(e=new RegisterButton(t,{classes:[__C.CLASSES.SIZES.LOW,__C.CLASSES.SIZES.WIDE,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.RIPPLE]}))):e=new AddToFavoriteButton(t.id,{is_add_avatar:!0,is_checked:t.is_favorite,classes:[__C.CLASSES.SIZES.LOW,__C.CLASSES.SIZES.WIDE,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.RIPPLE]}),r=r.add(i.button({classes:["feed_event_header_button","feed_event_header_button_hide_event",__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.EMPTY,"HideEvent"],dataset:{"event-id":t.id},title:"×"})),t.is_favorite&&a.push(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED),o.push({text:displayDateRange(t.dates[0].event_date,t.dates[t.dates.length-1].event_date)+(t.is_same_time?", "+displayTimeRange(t.dates[0].start_time,t.dates[0].end_time):"")}),t.registration_required&&t.registration_till&&o.push({text:"Регистрация до "+moment.unix(t.registration_till).calendar().capitalize()}),t.is_free?o.push({text:"Бесплатно"}):o.push({text:"Цена от "+(t.min_price?formatCurrency(t.min_price):0)+" руб."}),$.extend(!0,{cover_width:n,organization_avatar_block:i.avatarBlocks(s,{block_classes:[__C.CLASSES.SIZES.SMALL],is_link:!0,entity:__C.ENTITIES.ORGANIZATION}),action_button:e,avatars_collection:i.avatarCollection(t.favored,4,{dataset:{modal_type:"favors",modal_event_id:t.id},classes:a,counter_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.COLORS.MARGINAL_PRIMARY,__C.CLASSES.HOOKS.ADD_AVATAR.STATES.CASTABLE]},t.favored_users_count),feed_event_infos:tmpl("event-card-info",o),header_buttons:r},t)})),n.forEach(function(t,i){e.eq(i).appear(function(){storeStat(t.id,__C.STATS.EVENT_ENTITY,__C.STATS.EVENT_VIEW)},{accY:100})}),__APP.USER.isLoggedOut()&&e.find(".HideEvent").remove(),e},t.normalizeTicketProps=function(e){return(e instanceof Array?e:[e]).map(function(e){var i,n=t.normalizeBuildProps({card_classes:[],title:e.event.title,location:e.event.location,status_name:e.status_name,status_type_code:e.status_type_code,ticket_type_name:e.ticket_type.name,image_horizontal_url:e.event.image_horizontal_url,image_horizontal_large_url:e.event.image_horizontal_large_url||e.event.image_horizontal_url,image_horizontal_medium_url:e.event.image_horizontal_medium_url},["card_classes"]);switch(n.status_type_code){case OneExtendedTicket.TICKET_STATUSES.PAYED:case OneExtendedTicket.TICKET_STATUSES.APPROVED:case OneExtendedTicket.TICKET_STATUSES.WITHOUT_PAYMENT:n.card_classes.push(__C.CLASSES.STATUS.SUCCESS);break;case OneExtendedTicket.TICKET_STATUSES.IS_PENDING:case OneExtendedTicket.TICKET_STATUSES.WAITING_FOR_PAYMENT:n.card_classes.push(__C.CLASSES.STATUS.PENDING);break;case OneExtendedTicket.TICKET_STATUSES.REJECTED:case OneExtendedTicket.TICKET_STATUSES.RETURNED_BY_CLIENT:case OneExtendedTicket.TICKET_STATUSES.RETURNED_BY_ORGANIZATION:n.card_classes.push(__C.CLASSES.STATUS.ERROR)}switch(n.status_type_code){case OneExtendedTicket.TICKET_STATUSES.IS_PENDING:case OneExtendedTicket.TICKET_STATUSES.WAITING_FOR_PAYMENT:case OneExtendedTicket.TICKET_STATUSES.RETURNED_BY_ORGANIZATION:case OneExtendedTicket.TICKET_STATUSES.RETURNED_BY_CLIENT:case OneExtendedTicket.TICKET_STATUSES.REJECTED:n.card_classes.push(__C.CLASSES.STATUS.DISABLED);break;default:n.card_classes.push(__C.CLASSES.HOOKS.CALL_MODAL)}return e.event.is_same_time?(i=e.event.dates[0],n.formatted_dates=displayDateRange(i.event_date,e.event.dates[e.event.dates.length-1].event_date)+", "+displayTimeRange(i.start_time,i.end_time)):(i=e.event.nearest_event_date,n.formatted_dates=displayDateRange(i,i)),n})},t.prototype.ticketCards=function(e){return tmpl("ticket-card",t.normalizeTicketProps(e).map(function(t){return t.cover_width=260,t})).each(function(t,i){$(i).data({modal_type:__C.MODAL_TYPES.TICKET,tickets:e[t]})})},t.prototype.modal=function(e){var i,n=t.normalizeBuildProps(e,["content_classes"]),a={modal_header:"",modal_type:n.type,modal_content:n.content,modal_classes:n.classes,modal_content_classes:n.content_classes,modal_footer:""};return n.header?a.modal_header=n.header:n.title&&(a.modal_header=tmpl("modal-header",{title:n.title,close_button:this.button({classes:[__C.CLASSES.UNIVERSAL_STATES.EMPTY,"-modal_destroyer",__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"×"})})),n.footer?a.modal_footer=n.footer:n.footer_buttons&&(a.modal_footer=tmpl("modal-footer",{footer_buttons:n.footer_buttons})),i=tmpl("modal",a),n.width&&i.width(n.width),n.height&&i.height(n.height),i},t}(),AppInspectorComponents=function(){function t(){return"object"==typeof t.instance?t.instance:void(t.instance=this)}return t.prototype.avatarBlock=function(t){return bindPageLinks(__APP.BUILD.avatarBlocks(t,{is_link:!0,entity:__C.ENTITIES.USER,avatar_classes:[__C.CLASSES.SIZES.X50,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]}))},t.prototype.title=function(t){return tmpl("app-inspector-title",{title:t})},t.prototype.tickets=function(t){var e;return e=arguments.length>1?[].slice.call(arguments):t instanceof Array?t:[t],tmpl("app-inspector-ticket",e.map(function(t){return{fields:tmpl("app-inspector-fields-wrapper",[{classes:"-columns_2",fields:tmpl("app-inspector-field",[{name:"Номер",value:formatTicketNumber(t.number)},{name:"Цена",value:t.price?t.price:"Бесплатно"}])},{classes:"-field_big",fields:tmpl("app-inspector-field",{name:"Название",value:t.ticket_type.name})}]),footer:t.checkout?tmpl("app-inspector-ticket-footer"):""}}))},t.prototype.registrationFields=function(t){if(t instanceof RegistrationField)t=[t];else if(!(t instanceof Array))throw TypeError("Component builder accepts only RegistrationFieldsCollection, RegistrationField or array of RegistrationField object types");var e=$(),i=[],n=[RegistrationField.TYPES.EMAIL,RegistrationField.TYPES.PHONE_NUMBER,RegistrationField.TYPES.ADDITIONAL_TEXT,RegistrationField.TYPES.CUSTOM,RegistrationField.TYPES.EXTENDED_CUSTOM];return(t.__types[RegistrationField.TYPES.FIRST_NAME].length||t.__types[RegistrationField.TYPES.LAST_NAME].length)&&(t.__types[RegistrationField.TYPES.LAST_NAME].length&&i.push({name:"Фамилия",value:t.__types[RegistrationField.TYPES.LAST_NAME][0].value}),t.__types[RegistrationField.TYPES.FIRST_NAME].length&&i.push({name:"Имя",value:t.__types[RegistrationField.TYPES.FIRST_NAME][0].value}),e=e.add(tmpl("app-inspector-fields-wrapper",{classes:2===i.length?"-columns_2":"",fields:tmpl("app-inspector-field",i)}))),e.add(tmpl("app-inspector-field",n.reduce(function(e,i){return i===RegistrationField.TYPES.FIRST_NAME||i===RegistrationField.TYPES.LAST_NAME?e:e.concat(t.__types[i].map(function(t){return{name:t.label||RegistrationField.DEFAULT_LABEL[i],value:t.value||"—"}}))},[])))},t.prototype.event=function(t){return bindPageLinks(tmpl("app-inspector-event",t))},t}(),AbstractAppInspector=extendingJQuery(function(){function t(){var e=this;this.id=t.collection.push(this)-1,this.title=setDefaultValue(this.title,null),this.$content=setDefaultValue(this.$content,$()),this.is_shown=!1,this.is_rendered=!1,jQuery.fn.init.call(this,tmpl("app-inspector",{id:this.id,title:this.title,content:this.$content})),this.find(".AppInspectorRemoveButton").on("click.CloseInspector",function(){e.hide()})}return t.$wrapper=$(".AppInspectorsWrapper"),t.collection=[],t.currentInspector=null,t.build=new AppInspectorComponents,t.hideCurrent=function(){t.currentInspector&&t.currentInspector.hide()},t.destroyAll=function(){t.collection.forEach(function(t){t.destroy()})},t.prototype.render=function(){t.$wrapper.append(this),this.is_rendered=this,this.find(".AppInspectorScroll").scrollbar()},t.prototype.show=function(){var e=this;t.currentInspector&&t.currentInspector.hide(),this.is_rendered||this.render(),setTimeout(function(){e.addClass(__C.CLASSES.SHOW)},100),t.currentInspector=this,this.is_shown=!0},t.prototype.hide=function(){this.removeClass(__C.CLASSES.SHOW),t.currentInspector=null,this.is_shown=!1},t.prototype.destroy=function(){this.is_shown&&this.hide(),t.collection.splice(this.id,1),this.is_rendered=!1,this.remove()},Object.seal(t),t}()),OrderAppInspector=extending(AbstractAppInspector,function(){function t(t,e){this.order=t,this.event=e,this.title="Заказ "+formatTicketNumber(this.order.number),this.$content=tmpl("order-app-inspector",{orderer:AbstractAppInspector.build.avatarBlock(this.order.user),status_block:__APP.BUILD.orderStatusBlock(this.order.status_type_code),tickets_title:AbstractAppInspector.build.title("Билеты"),tickets:AbstractAppInspector.build.tickets(this.order.tickets),registration_form_title:AbstractAppInspector.build.title("Анкета регистрации"),registration_fields:AbstractAppInspector.build.registrationFields(this.order.registration_fields),event_title:AbstractAppInspector.build.title("Событие"),event:AbstractAppInspector.build.event(this.event)}),AbstractAppInspector.call(this)}return t}()),AbstractSidebar=function(){function t(){this.$sidebar=$("#main_sidebar"),this.$subscribed_orgs=$(".SidebarOrganizationsList");
}return t.prototype.init=function(){this.$sidebar.find(".SidebarNav").addClass("-items_"+this.$sidebar.find(".SidebarNavItem").not(".-hidden").length),this.$sidebar.find(".SidebarScroll").scrollbar({disableBodyScroll:!0})},t.prototype.updateSubscriptions=function(){},t}(),Sidebar=extending(AbstractSidebar,function(){function t(){AbstractSidebar.call(this)}return t.prototype.init=function(){var t=this;t.updateSubscriptions(),$(window).on("subscribe unsubscribe",function(){t.updateSubscriptions()}),AbstractSidebar.prototype.init.call(this)},t.prototype.updateSubscriptions=function(){var t=this.$subscribed_orgs,e=0,i=$.map(t.children(),function(t){return $(t).data("organization_id")}),n=__APP.USER.subscriptions.filter(function(t){return i.indexOf(t.id)===-1}),a=i.filter(function(t){return!__APP.USER.subscriptions.has(t)});n.length&&(__APP.BUILD.organizationItems(n,{block_classes:["animated"],avatar_classes:["-size_30x30"]})[t.length?"prependTo":"appendTo"](t).each(function(t,i){setTimeout(function(){$(i).addClass("-show")},e+=100)}),bindPageLinks(t)),a.length&&a.forEach(function(e){var i=t.find('.organization_item[data-organization_id="'+e+'"]').removeClass("-show");setTimeout(function(){i.remove()},500)})},t}()),SidebarNoAuth=extending(AbstractSidebar,function(){function t(){AbstractSidebar.call(this)}return t.prototype.init=function(){this.$sidebar.find(".SidebarOrganizationsScroll").addClass(__C.CLASSES.HIDDEN),AbstractSidebar.prototype.init.call(this)},t}()),AbstractTopBar=function(){function t(){this.$main_header=$("#main_header")}return t.prototype.init=function(){var t=this.$main_header.find(".TopBarOverlay"),e=t.find(".TopBarSearchButton"),i=t.find(".TopBarSearchInput");e.on("click.OpenSearchBar",function(){t.hasClass("-open_search_bar")?__APP.changeState("/search/"+encodeURIComponent(i.val())):(t.addClass("-open_search_bar"),i.focus())}),i.on("keypress",function(t){13===t.which&&__APP.changeState("/search/"+encodeURIComponent(i.val()))}).on("keydown",function(e){27===e.keyCode&&(t.removeClass("-open_search_bar"),i.val(""))}).on("blur",function(){""===i.val()&&t.removeClass("-open_search_bar")}),this.$main_header.find(".SidebarBurger").add($(".MainSectionCap")).on("click",function(){$("body").toggleClass("-open_sidebar")}),bindRippleEffect(this.$main_header),bindPageLinks(this.$main_header)},t}(),TopBar=extending(AbstractTopBar,function(){function t(){AbstractTopBar.call(this)}return t.prototype.init=function(){AbstractTopBar.prototype.init.call(this)},t}()),TopBarNoAuth=extending(AbstractTopBar,function(){function t(){AbstractTopBar.call(this)}return t.prototype.init=function(){this.$main_header.find(".LoginButton").on("click",function(){cookies.removeItem("auth_command"),cookies.removeItem("auth_entity_id"),new AuthModal(location.href).show()}),AbstractTopBar.prototype.init.call(this)},t}()),Page=function(){function t(){this.name=this.constructor.name,this.state_name=this.name,this.page_title=setDefaultValue(this.page_title,""),this.page_title_obj=setDefaultValue(this.page_title_obj,""),this.$view=setDefaultValue(this.$view,$(".PageView")),this.$wrapper=setDefaultValue(this.$wrapper,$()),this.wrapper_tmpl=setDefaultValue(this.wrapper_tmpl,"std"),this.with_header_tabs=setDefaultValue(this.with_header_tabs,!1),this.rendering_defer=$.Deferred(),this.fetching_data_defer=$.Deferred()}return t.routeNewPage=function(e){var i,n=decodeURIComponent(e).split("/"),a=[];return i=n.reduce(function(t,e){return e?t.hasOwnProperty(e)?t[e]:Object.keys(t).reduce(function(i,n){return!i&&0===n.indexOf("^")&&new RegExp(n).test(e)?(a.push(e),t[n]):i},!1):t},__APP.ROUTING),i=i.prototype instanceof t?i:i[""]&&i[""].prototype instanceof t?i[""]:NotFoundPage,new(Function.prototype.bind.apply(i,[null].concat(a)))},t.prototype.show=function(){var t=this,e=$("#main_header"),i=__APP.PREVIOUS_PAGE.wrapper_tmpl!==t.wrapper_tmpl,n=i?"$view":"$wrapper",a=__APP.PREVIOUS_PAGE[n].length?__APP.PREVIOUS_PAGE[n]:i?$(".PageView"):$(".PageView").find(".Content");a.addClass("-faded"),setTimeout(function(){a.addClass(__C.CLASSES.HIDDEN),t.with_header_tabs?e.addClass("-with_tabs"):e.removeClass("-with_tabs"),$("body").removeClass(function(t,e){return(e.match(/(^|\s)-state_\S+/g)||[]).join(" ")}).addClass("-state_"+t.state_name.toUnderscore()),i&&t.$view.html(tmpl(t.wrapper_tmpl+"-wrapper",{})),t.$wrapper=t.$view.find(".Content"),t.$wrapper.empty(),t.$view.removeClass(__C.CLASSES.HIDDEN),t.$wrapper.removeClass(__C.CLASSES.HIDDEN),t[n].addClass("-faded"),t.rendering_defer.resolve()},200),$.when(t.rendering_defer,t.fetching_data_defer).done(function(){(t.page_title_obj||t.page_title)&&__APP.changeTitle(t.page_title_obj?t.page_title_obj:t.page_title),t.renderHeaderTabs(),$(window).scrollTop(0),t.render(),bindPageLinks(),setTimeout(function(){t[n].removeClass("-faded")},200)})},t.prototype.renderHeaderTabs=function(){},t.prototype.fetchData=function(){return this.fetching_data_defer.resolve().promise()},t.prototype.render=function(){},t.prototype.destroy=function(){},t}(),AdminPage=extending(Page,function(){function t(){Page.apply(this),this.state_name="admin",this.SCALES={MINUTE:"minute",HOUR:"hour",DAY:"day",WEEK:"week",MONTH:"month",YEAR:"year",OVERALL:"overall"},this.highchart_defaults={chart:{backgroundColor:null,plotBorderWidth:null,plotShadow:!1,style:{fontFamily:"inherit",fontSize:"inherit"}},title:{text:!1},credits:{enabled:!1}}}return t.prototype.areaChartSeriesNormalize=function(t){function e(t,e,i){return{name:a[e],data:t.map(function(t,e){return[moment.unix(t.time_value).valueOf(),t[i]]})}}var i={open_conversion:{with:"open_site",to:"view"},fave_conversion:{with:"fave",to:"open_site"},conversion:{with:"subscribe",to:"view"}},n={subscribe_unsubscribe:{subscribe:"subscribe",unsubscribe:"unsubscribe"}},a={notifications_sent:"Отправлено уведомлений",view:"Просмотры",view_detail:"Открытий страницы события из ленты Evendate",conversion:"Конверсия",subscribe:"Подписалось",unsubscribe:"Отписалось",open_site:"Открытий страницы события",open_conversion:"Конверсия просмотра события в ленте к открытию страницы события",fave:"Кол-во пользователей, которые добавили событие в избранное",fave_conversion:"Конверсия открытия страницы события к добавлениям в избранное"},o={showInLegend:!1,lineWidth:0,fillOpacity:0,states:{hover:{enabled:!1}}},s={};return $.each(t,function(t,a){s[t]=[],i.hasOwnProperty(t)?(s[t].push($.extend(!0,{tooltip:{valueSuffix:" %"}},e(a,t,"value"))),$.each(i[t],function(i,n){s[t].push($.extend(!0,{},o,e(a,n,i)))})):n.hasOwnProperty(t)?$.each(n[t],function(i,n){s[t].push(e(a,n,i))}):s[t].push(e(a,t,"value"))}),s},t.prototype.buildAreaCharts=function(t,e){var i=this,n=i.areaChartSeriesNormalize(t),a={notifications_sent:{title:"Отправлено уведомлений пользователям",wrapper_class:"NotificationsSentAreaChart"},view:{title:"Просмотры",wrapper_class:"ViewAreaChart"},view_detail:{title:"Открытий страницы события",wrapper_class:"ViewDetailAreaChart"},open_site:{title:"Открытий страницы события из ленты Evendate",wrapper_class:"OpenSiteAreaChart"},open_conversion:{title:"Конверсия просмотров/открытий",wrapper_class:"OpenConversionsAreaChart"},fave:{title:"Добавлений в избранное",wrapper_class:"FaveAreaChart"},fave_conversion:{title:"Конверсия открытий/добавлений в избранное",wrapper_class:"FaveConversionsAreaChart"},subscribe_unsubscribe:{title:"Подписчики",wrapper_class:"SubscriberAreaChart"},conversion:{title:"Конверсия просмотров/подписок",wrapper_class:"ConversionAreaChart"}},o=[["rgba(35, 215, 146, 0.18)","rgba(101, 101, 101, 0.6)","rgba(101, 101, 101, 0.6)"],["rgba(35, 215, 146, 0.09)","rgba(101, 101, 101, 0.6)","rgba(101, 101, 101, 0.6)"]],s=$.extend(!0,{},i.highchart_defaults,{chart:{type:"areaspline",plotBackgroundColor:"#fcfcfc",plotBorderColor:"#ebebeb",plotBorderWidth:1},colors:[__C.COLORS.FRANKLIN,__C.COLORS.MUTED_80,__C.COLORS.ACCENT,__C.COLORS.MUTED,__C.COLORS.MUTED_50,__C.COLORS.MUTED_30],title:{align:"left",margin:20},legend:{enabled:!0,align:"left",itemStyle:{color:__C.COLORS.TEXT,cursor:"pointer",fontSize:"14px",fontWeight:"500",y:0},itemMarginTop:24,itemMarginBottom:5,symbolHeight:18,symbolWidth:18,symbolRadius:9,itemDistance:42,x:30},plotOptions:{series:{states:{hover:{lineWidth:2}}},areaspline:{fillOpacity:.5,marker:{enabled:!1,symbol:"circle",radius:2,states:{hover:{enabled:!0}}},dataGrouping:{dateTimeLabelFormats:{millisecond:["%b %e, %H:%M:%S.%L","%b %e, %H:%M:%S.%L","-%H:%M:%S.%L"],second:["%b %e, %H:%M:%S","%b %e, %H:%M:%S","-%H:%M:%S"],minute:["%b %e, %H:%M","%b %e, %H:%M","-%H:%M"],hour:["%b %e, %H:%M","%b %e, %H:%M","-%H:%M"],day:["%b %e, %Y","%b %e","-%b %e, %Y"],week:["%b %e, %Y","%b %e","-%b %e, %Y"],month:["%B %Y","%B","-%B %Y"],year:["%Y","%Y","-%Y"]}}}},tooltip:{headerFormat:"<b>{point.key}</b><br/>",positioner:function(t,e){return{x:this.chart.plotLeft,y:this.chart.plotTop}},shadow:!1,shape:"square",valueDecimals:0,xDateFormat:"%e %b %Y",shared:!0},scrollbar:{enabled:!1},navigator:{outlineColor:"#ebebeb",outlineWidth:1,maskInside:!1,maskFill:"rgba(245, 245, 245, 0.66)",handles:{backgroundColor:"#9fa7b6",borderColor:"#fff"},xAxis:{gridLineWidth:0,labels:{align:"left",reserveSpace:!0,style:{color:"#888"},x:0,y:null}}},rangeSelector:{buttonTheme:{width:null,height:22,fill:"none",stroke:"none",r:14,style:{color:__C.COLORS.MUTED_80,fontSize:"13px",fontWeight:"400",textTransform:"uppercase",dominantBaseline:"middle"},states:{hover:{fill:__C.COLORS.MUTED_50,style:{color:"#fff"}},select:{fill:__C.COLORS.MUTED_80,style:{color:"#fff",fontWeight:"400"}}}},buttons:[{type:"day",count:7,text:"   Неделя   "},{type:"month",count:1,text:"   Месяц   "},{type:"year",count:1,text:"   Год   "},{type:"all",text:"   Все время   "}],allButtonsEnabled:!0,selected:2,labelStyle:{display:"none"},inputEnabled:!1},xAxis:{gridLineWidth:1,gridLineDashStyle:"dash",type:"datetime",showEmpty:!1,tickPosition:"inside",dateTimeLabelFormats:{minute:"%H:%M",hour:"%H:%M",day:"%e %b",week:"%e %b",month:"%b %y",year:"%Y"}},yAxis:{allowDecimals:!1,floor:0,min:0,gridLineDashStyle:"dash",opposite:!1,title:{text:!1}}},e);$.each(n,function(t){var e={title:{text:a[t].title}};e.series=n[t].map(function(t,e){return 0!==t.fillOpacity?$.extend(!0,{},t,{fillColor:{linearGradient:{x1:0,x2:0,y1:0,y2:1},stops:o.map(function(t,i){return[i,t[e]]})}}):t}),"conversion"!=t&&"open_conversion"!=t&&"fave_conversion"!=t||(e.yAxis={max:100,labels:{format:"{value}%"}}),i.$wrapper.find("."+a[t].wrapper_class).highcharts("StockChart",$.extend(!0,{},s,e))})},t.prototype.updateScoreboards=function(t,e,i,n,a){var o=!!e.dynamics;n||(n=Object.keys(i)),n.forEach(function(n){var s,r="Scoreboard"+n.toCamelCase("_"),c=t.find("."+r);switch(n){case"conversion":case"open_conversion":case"fave_conversion":s="%"}c.length||(c=tmpl(o?"scoreboard-with-dynamics":"scoreboard",{type:r,title:i[n],size:a?"-size_"+a:"-size_normal",number:0+s,dynamic_by_week:0+s},t)),void 0!==e.numbers[n]&&c.find(".ScoreboardNumber").animateNumber({number:Math.round(e.numbers[n]),suffix:s},2e3,"easeOutSine"),o&&void 0!==e.dynamics[n]&&c.find(".ScoreboardDynamic").animateNumber({number:Math.round(e.dynamics[n]),prefix:0==e.dynamics[n]?void 0:e.dynamics[n]>0?"+":"-",suffix:s},2e3,"easeOutSine").siblings("label").removeClass("fa-caret-up -text_color_franklin fa-caret-down -text_color_bubblegum").addClass(0==e.dynamics[n]?"":e.dynamics[n]>0?"fa-caret-up -text_color_franklin":"fa-caret-down -text_color_bubblegum")})},t}()),AdminEventPage=extending(AdminPage,function(){function t(t){AdminPage.call(this),this.id=t,this.event=new OneEvent(this.id),this.event_fields=new Fields("organization_short_name","ticketing_locally","registration_locally"),this.with_header_tabs=!0}return t.prototype.fetchData=function(){return this.fetching_data_defer=this.event.fetchEvent(this.event_fields)},t.prototype.renderHeaderTabs=function(){var t=[];t.push({title:"Обзор",page:"/admin/event/"+this.id+"/overview"}),(this.event.registration_locally||this.event.ticketing_locally)&&(t.push({title:"Контроль входа",page:"/admin/event/"+this.id+"/check_in"}),t.push({title:"Заказы",page:"/admin/event/"+this.id+"/orders"})),t.push({title:"Редактирование",page:"/admin/event/"+this.id+"/edit"}),__APP.renderHeaderTabs(t)},t}()),AdminEventAuditoryPage=extending(AdminEventPage,function(){function t(t){AdminEventPage.apply(this,arguments)}return t.prototype.render=function(){},t}()),AdminEventCheckInPage=extending(AdminEventPage,function(){function t(i){var n=this;AdminEventPage.call(this,i),this.current_checkin_state=t.STATES.AWAITING,this.tickets_fields=new Fields("user","ticket_type","event_id"),this.tickets=new e(i),this.searching_tickets=new SearchAdminEventsTicketsCollection("",i),this.is_searching_state=!1,this.is_fetching=!1,this.progress_bar=new ProgressBar({NUMBER:this.tickets.checked.length,OVERALL:this.tickets.length},{classes:["-with_label"]}),this.table_body=$(),Object.defineProperties(this,{page_title_obj:{get:function(){return[{title:"Организации",page:"/admin"},{title:n.event.organization_short_name,page:"/admin/organization/"+n.event.organization_id},n.event.title+" - контроль входа"]}},is_awaiting_state:{get:function(){return n.current_checkin_state===t.STATES.AWAITING}}})}var e=extending(AdminEventsTicketsCollection,function(){function t(t){var e=this;AdminEventsTicketsCollection.call(this,t),Object.defineProperties(this,{awaiting:{get:function(){return e.filter(function(t){return!t.checkout})}},new_awaiting:{get:function(){return e.last_pushed.filter(function(t){return!t.checkout})}},checked:{get:function(){return e.filter(function(t){return t.checkout})}},new_checked:{get:function(){return e.last_pushed.filter(function(t){return t.checkout})}}})}return t}());return t.STATES={AWAITING:"awaiting",CHECKED:"checked"},t.ACTION_TEXTS={AWAITING_NORMAL:"Ожидает подтверждения",AWAITING_HOVER:"Подтвердить вход",CHECKED_NORMAL:"Подтверждён",CHECKED_HOVER:"Отменить подтверждение"},t.prototype.fetchData=function(){return this.fetching_data_defer=__APP.SERVER.multipleAjax(AdminEventPage.prototype.fetchData.call(this),this.tickets.fetchTickets(this.tickets_fields,0,"created_at"))},t.prototype.buildTableRows=function(e,i){e=e?e instanceof Array?e:[e]:[];var n,a=this;return e.length?(n=tmpl("event-admin-check-in-row",e.map(function(e){return{ticket_id:e.uuid,number:e.number,full_name:e.user.full_name,avatar_block:__APP.BUILD.avatarBlocks(e.user,{entity:__C.ENTITIES.USER,avatar_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]}),ticket_type:e.ticket_type.name,state_modificator:"-ticket_status_"+(e.checkout?t.STATES.CHECKED:t.STATES.AWAITING),status_text:e.checkout?t.ACTION_TEXTS.CHECKED_NORMAL:t.ACTION_TEXTS.AWAITING_NORMAL,action_text:e.checkout?t.ACTION_TEXTS.CHECKED_HOVER:t.ACTION_TEXTS.AWAITING_HOVER}})),n.find(".CheckoutTicket").not(".-Handled_CheckoutTicket").on("click",function(){var e=a.tickets.getByID($(this).closest(".Ticket").data("ticket_uuid"));OneTicket[e.checkout?"uncheck":"check"](e.event_id,e.uuid,function(){a.changeTicketState(e,e.checkout?t.STATES.AWAITING:t.STATES.CHECKED)})}).addClass("-Handled_CheckoutTicket"),n):tmpl("event-admin-check-in-row-no-tickets",{text:i?i:"Нет билетов"})},t.prototype.changeTicketState=function(e,i){var n;this.is_searching_state?(n=this.table_body.find(".Ticket_"+e.uuid),n.toggleClass(Object.values(t.STATES).map(function(t){return"-ticket_status_"+t}).join(" ")),n.find(".StatusText").text(t.ACTION_TEXTS[e.checkout?"AWAITING_NORMAL":"CHECKED_NORMAL"]),n.find(".CheckoutTicket").text(t.ACTION_TEXTS[e.checkout?"AWAITING_HOVER":"CHECKED_HOVER"])):e.checkout!==this.is_awaiting_state&&(i===(this.is_awaiting_state?t.STATES.AWAITING:t.STATES.CHECKED)?this.table_body.append(this.buildTableRows(e)):this.table_body.find(".Ticket_"+e.uuid).remove()),(e.checkout&&i===t.STATES.AWAITING||!e.checkout&&i===t.STATES.CHECKED)&&(e.checkout=!e.checkout,this.progress_bar.set(this.tickets.checked.length)),this.is_searching_state||this.tickets[this.current_checkin_state].length||this.table_body.html(this.buildTableRows([]))},t.prototype.initSearch=function(){var t=this;this.is_searching_state=!0,this.$wrapper.find(".RadioGroup").find("input").prop("checked",!1),this.$wrapper.find(".ClearSearch").one("click",function(){t.$wrapper.find(".SearchTickets").val(""),t.deInitSearch()}),$(window).on("keydown.deInitSearch",function(e){27===e.keyCode&&t.deInitSearch()})},t.prototype.deInitSearch=function(){this.is_searching_state=!1,$(window).off("keydown.deInitSearch"),this.$wrapper.find("#event_admin_check_in_type_"+this.current_checkin_state).prop("checked",!0),this.table_body.html(this.buildTableRows(this.tickets[this.current_checkin_state]))},t.prototype.init=function(){var t=this;this.$wrapper.find(".RadioGroup").on("change",function(e){t.current_checkin_state=$(e.target).val(),t.table_body.html(t.buildTableRows(t.tickets[t.current_checkin_state]))}),this.$wrapper.find(".SearchTickets").on("input",function(e){var i=$(e.target).val();t.is_searching_state||t.initSearch(),__APP.SERVER.abortAllConnections(),""===i?t.deInitSearch():(t.searching_tickets=new SearchAdminEventsTicketsCollection(i,t.event.id),t.fetching_data_defer=t.searching_tickets.fetchTickets(t.tickets_fields,0,"created_at",function(){t.table_body.html(t.buildTableRows(this.last_pushed))}))})},t.prototype.loadRest=function(){var t=this;return this.tickets.fetchTickets(this.tickets_fields,0,"created_at",function(){this.last_pushed.length&&(t.progress_bar.setMax(t.tickets.length),t.progress_bar.set(t.tickets.checked.length),t.table_body.append(t.buildTableRows(this["new_"+t.current_checkin_state])),t.fetching_data_defer=t.loadRest())})},t.prototype.render=function(){this.progress_bar.setMax(this.tickets.length),this.progress_bar.set(this.tickets.checked.length),this.$wrapper.html(tmpl("event-admin-check-in-page",{radio_group:__APP.BUILD.radioGroup({name:"check_in_type",units:[{id:"event_admin_check_in_type_awaiting",label:"Ожидают",attributes:{value:t.STATES.AWAITING,checked:!0}},{id:"event_admin_check_in_type_checked",label:"Проверенные",attributes:{value:t.STATES.CHECKED}}]}),progress_bar:this.progress_bar,rows:this.buildTableRows(this.tickets.awaiting)})),this.table_body=this.$wrapper.find(".CheckInTable").children("tbody"),this.fetching_data_defer=this.loadRest(),this.init()},t}()),AbstractEditEventPage=extending(Page,function(){function t(){Page.call(this),this.event=new OneEvent,this.state_name="admin",this.organization_id=null}return t.lastRegistrationCustomFieldId=0,t.buildRegistrationCustomField=function(e){e=e?e instanceof Array?e:[e]:[{}];var i;return i=tmpl("edit-event-registration-custom-field",e.filter(function(e){return!!RegistrationFieldModel.isCustomField(e)&&(e.id=e.id?e.id:t.lastRegistrationCustomFieldId++,!0)})),e.forEach(function(t){t.required&&i.find("#edit_event_registration_"+t.id+"_custom_field_required").prop("checked",!0),t.type&&i.find("#edit_event_registration_"+t.id+"_custom_field_"+t.type+"_type").prop("checked",!0)}),i.find(".RemoveRegistrationCustomField").on("click.RemoveRegistrationCustomField",function(){$(this).closest(".RegistrationCustomField").remove()}),i.find(".RegistrationCustomFieldLabel, .RegistrationCustomFieldType").on("change.RemoveRegistrationFieldUUID",function(){$(this).closest(".RegistrationCustomField").find(".RegistrationCustomFieldUUID").val("")}),i},t.prototype.init=function(){function e(t){t.is("input")?t.inputmask({alias:"numeric",autoGroup:!1,digits:2,digitsOptional:!0,allowPlus:!1,allowMinus:!1,rightAlign:!1}):(t=t.find("input"),t.length&&e(t))}var i=this,n=i.$wrapper.find(".EditEventPageTabs"),a=i.$wrapper.find(".edit_event_buttons").children(),o=a.filter("#edit_event_next_page"),s=a.filter("#edit_event_prev_page"),r=a.filter("#edit_event_submit");bindDatePickers(i.$wrapper),bindTimeInput(i.$wrapper),bindSelect2(i.$wrapper),bindTabs(i.$wrapper),bindControlSwitch(i.$wrapper),bindCallModal(i.$wrapper),bindLimitInputSize(i.$wrapper),bindRippleEffect(i.$wrapper),bindFileLoadButton(i.$wrapper),ImgLoader.init(i.$wrapper),function(){function t(t){t.find(".RemoveRow").not(".-Handled_RemoveRow").each(function(t,e){$(e).on("click",function(){c.deselectDays($(this).closest("tr").data("date"))}).addClass("-Handled_RemoveRow")})}function e(){d={},c.selected_days.forEach(function(t,e,i){var n=moment(t);"undefined"==typeof d[n.month()]&&(d[n.month()]={},d[n.month()].selected_days=[],d[n.month()].month_name=_[n.format("MMMM")]),d[n.month()].selected_days.push(n.date())}),s.empty().removeClass("hidden"),Object.keys(d).length?$.each(d,function(t,e){s.append($("<p>").text(e.selected_days.join(", ")+" "+e.month_name))}):s.html("<p>Даты не выбраны</p>")}function n(t,e){t.sort(function(t,e){var i=$(t).data("date"),n=$(e).data("date");return i>n?1:i<n?-1:0}),t.detach().appendTo(e)}function a(e){var i=$(),a=moment().format(__C.DATE_FORMAT);Array.isArray(e)?e.forEach(function(t){i=i.add(tmpl("selected-table-day",{date:t,formatted_date:t.split("-").reverse().join("."),today:a}))}):i=tmpl("selected-table-day",{date:e,formatted_date:e.split("-").reverse().join("."),today:a}),bindDatePickers(i),bindTimeInput(i),t(i),u=u.add(i),i.find(".DatePicker").each(function(){var t=$(this).data("datepicker");t.$datepicker.on("date-picked",function(){c.deselectDays(t.prev_selected_day).selectDays(t.selected_day),n(u,r)})}),n(u,r)}function o(){if("select"===c.last_action)a(c.last_selected_days);else if("deselect"===c.last_action)if(Array.isArray(c.last_selected_days)){var t=[];c.last_selected_days.forEach(function(e){t.push(".TableDay_"+e)}),u.remove(t.join(", ")),u=u.not(t.join(", "))}else u.remove(".TableDay_"+c.last_selected_days),u=u.not(".TableDay_"+c.last_selected_days);n(u,r)}var s=i.$wrapper.find(".EventSelectedDaysText"),r=i.$wrapper.find(".SelectedDaysRows"),c=new Calendar(".EventDatesCalendar",{weekday_selection:!0,month_selection:!0,min_date:moment().format(__C.DATE_FORMAT)}),l=i.$wrapper.find(".AddDayToTable").data("datepicker"),d={},_={"январь":"января","февраль":"февраля","март":"марта","апрель":"апреля","май":"мая","июнь":"июня","июль":"июля","август":"августа","сентябрь":"сентября","октябрь":"октября","ноябрь":"ноября","декабрь":"декабря"},u=$();c.init(),a(c.selected_days),i.$wrapper.find(".SelectedDaysRows").toggleStatus("disabled"),c.$calendar.on("days-changed.displayFormattedText",e),c.$calendar.on("days-changed.buildTable",o),l.$datepicker.on("date-picked",function(){c.selectDays(l.selected_day)})}(),function(t){OrganizationsCollection.fetchMyOrganizations(["admin","moderator"],{fields:["default_address"]},function(e){var n,a=$(".EditEventOrganizations"),o=$(),s=i.$wrapper.find(".EditEventDefaultAddress"),r=a.find("#edit_event_organization");return e.forEach(function(e){e.id==t&&(n=e.default_address),o=o.add(tmpl("option",{val:e.id,data:"data-image-url='"+e.img_url+"' data-default-address='"+e.default_address+"'",display_name:e.name}))}),t&&!n?__APP.changeState("/",!0,!0):(r.append(o).select2({containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}).on("change",function(){s.data("default_address",$(this).children(":selected").data("default-address"))}),t?(r.select2("val",t),s.data("default_address",n)):s.data("default_address",e[0].default_address),void(o.length>1?a.removeClass("-hidden"):a.addClass("-hidden")))})}(i.event.organization_id),bindCollapsing(i.$wrapper),n=n.resolveInstance(),i.$wrapper.find(".Placepicker").placepicker(),i.$wrapper.find(".EventTags").select2({tags:!0,width:"100%",placeholder:"Выберите до 5 тегов",maximumSelectionLength:5,maximumSelectionSize:5,tokenSeparators:[",",";"],multiple:!0,createSearchChoice:function(t,e){if(0===$(e).filter(function(){return 0===this.text.localeCompare(t)}).length)return{id:t,text:t}},ajax:{url:"/api/v1/tags/",dataType:"JSON",data:function(t,e){return{name:t}},results:function(t){var e=[];return t.data.forEach(function(t){t.text=t.name,e.push(t)}),{results:e}}},containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}),i.$wrapper.find(".EditEventDefaultAddress").off("click.defaultAddress").on("click.defaultAddress",function(){var t=$(this);t.closest(".form_group").find("input").val(t.data("default_address")).trigger("input")}),i.$wrapper.find("#edit_event_is_online").off("change.OnlineEvent").on("change.OnlineEvent",function(){i.$wrapper.find("#edit_event_placepicker").prop("required",!$(this).prop("checked"))}),i.$wrapper.find("#edit_event_free").off("change.FreeEvent").on("change.FreeEvent",function(){i.$wrapper.find(".MinPrice").toggleStatus("disabled")}),e(i.$wrapper.find(".MinPrice")),e(i.$wrapper.find("#edit_event_registration_limit_count")),i.$wrapper.find(".AddRegistrationCustomField").off("click.AddRegistrationCustomField").on("click.AddRegistrationCustomField",function(){t.buildRegistrationCustomField().insertBefore($(this))}),i.$wrapper.find(".RegistrationPreview").on("click.RegistrationPreview",function(){var t,e=$(this).closest("form").serializeForm(),i=new OneEvent;e.registration_fields=(new RegistrationFieldModelsCollection).setData(e.registration_fields.sort().map(function(t){return{uuid:guid(),type:e["registration_"+t+"_field_type"],label:e["registration_"+t+"_field_label"]||RegistrationFieldModel.DEFAULT_LABEL[e["registration_"+t+"_field_type"].toUpperCase()],required:e["registration_"+t+"_field_required"]}})),i.setData(e),t=new PreviewRegistrationModal(i),t.show()}),n.on("change.tabs",function(){0===n.currentTabsIndex?s.addClass(__C.CLASSES.HIDDEN):s.removeClass(__C.CLASSES.HIDDEN),n.currentTabsIndex===n.tabsCount-1?(o.addClass(__C.CLASSES.HIDDEN),r.removeClass(__C.CLASSES.HIDDEN)):(o.removeClass(__C.CLASSES.HIDDEN),r.addClass(__C.CLASSES.HIDDEN))}),o.off("click.nextPage").on("click.nextPage",function(){n.nextTab()}),s.off("click.nextPage").on("click.prevPage",function(){n.prevTab()}),r.off("click.Submit").on("click.Submit",function(){function t(){i.$wrapper.removeClass(__C.CLASSES.STATUS.DISABLED),d.remove(),__APP.changeState("/event/"+i.event.id)}function e(t){i.$wrapper.removeClass(__C.CLASSES.STATUS.DISABLED),d.remove(),console.error(t),console.log({MainCalendar:s,send_data:n,form_data:c})}var n,a,o=i.$wrapper.find("#edit-event-form"),s=i.$wrapper.find(".EventDatesCalendar").resolveInstance(),r=o.find("input.EventTags"),c=o.serializeForm(),l=!!i.event.id,d=$();if(a=function(t,e){function i(t,e,i){var n,a;return e&&(n=t.parents(".TabsBody:last"),a=n.closest(".Tabs").resolveInstance(),a.setToTab(a.find(".TabsBodyWrapper:first").children().index(n)),scrollTo(t,400,function(){showNotifier({text:i,status:!1})})),handleErrorField(t),!1}var n=!0,a=t.find("#edit_event_different_time").prop("checked")?t.find('[class^="TableDay_"]'):t.find(".MainTime");return t.find(":required").not(t.find(":disabled")).each(function(){var t=$(this);""===t.val().trim()?n=i(t,n,"Заполните все обязательные поля"):t.hasClass("LimitSize")&&t.val().trim().length>t.data("maxlength")&&(n=i(t,n,"Количество символов превышает установленное значение"))}),e.selected_days.length||(n=i(e.$calendar,n,"Выберите даты для события")),a.each(function(){var t=$(this),e=t.find(".StartHours, .StartMinutes, .EndHours, .EndMinutes"),a=t.find(".StartHours").val().trim()+t.find(".StartMinutes").val().trim(),o=t.find(".EndHours").val().trim()+t.find(".EndMinutes").val().trim();e.each(function(){var t=$(this);""===t.val().trim()&&(n=i(t,n,"Заполните время события"))}),n&&a>o&&(n=i(t,n,"Начальное время не может быть позже конечного"))}),""===r.val().trim()&&(n=i(r.siblings(".EventTags"),n,"Необходимо выбрать хотя бы один тэг")),!c.registration_limit_by_quantity||c.registration_fields&&c.registration_fields.length||(n=i(t.find("#edit_event_registration_fields"),n,"Должно быть выбрано хотя бы одно поле регистрации в анкете")),l||t.find(".DataUrl").each(function(){var t=$(this);""===t.val().trim()&&(n=i(t.closest(".ImgLoadWrap"),n,"Пожалуйста, добавьте к событию обложку"))}),n}(o,s)){i.$wrapper.addClass(__C.CLASSES.STATUS.DISABLED),d=__APP.BUILD.overlayLoader(i.$view);try{n={event_id:parseInt(c.event_id)?parseInt(c.event_id):null,title:c.title.trim(),organization_id:c.organization_id,description:c.description.trim(),is_online:c.is_online,location:c.location&&c.location.trim()?c.location.trim():null,detail_info_url:c.detail_info_url?c.detail_info_url.trim():null,image_horizontal:c.image_horizontal,filenames:{horizontal:c.filename_horizontal},is_free:c.is_free,min_price:c.is_free?null:c.min_price},n.registration_required=c.registration_required,c.registration_required&&(c.registration_limit_by_date&&(n.registration_till=moment(c.registration_till_date+"T"+c.registration_till_time_hours+":"+c.registration_till_time_minutes+":00").tz("UTC").format()),c.registration_limit_by_quantity&&(n.registration_locally=!0,n.registration_limit_count=c.registration_limit_count),c.registration_fields&&c.registration_fields.length&&(n.registration_locally=!0,n.registration_fields=(new RegistrationFieldModelsCollection).setData(c.registration_fields.map(function(t){var e=new RegistrationFieldModel;return e.required=c["registration_"+t+"_field_required"],c["registration_"+t+"_field_uuid"]&&(e.uuid=c["registration_"+t+"_field_uuid"]),c["registration_"+t+"_field_type"]&&(e.type=c["registration_"+t+"_field_type"]),c["registration_"+t+"_field_label"]&&(e.label=c["registration_"+t+"_field_label"].trim()),e})).getArrayCopy())),c.tags&&(n.tags=c.tags.split(",")),n.delayed_publication=c.delayed_publication,c.delayed_publication&&(n.public_at=moment(c.public_at_date+"T"+c.public_at_time_hours+":"+c.public_at_time_minutes+":00").tz("UTC").format()),n.different_time=c.different_time,n.dates=new DateModelsCollection,c.different_time?i.$wrapper.find(".SelectedDaysRows").children().each(function(t,e){var i=$(e);n.dates.push((new DateModel).setData({event_date:i.find(".DatePicker").data("selected_day"),start_time:i.find(".StartHours").val()+":"+i.find(".StartMinutes").val(),end_time:i.find(".EndHours").val()+":"+i.find(".EndMinutes").val()}))}):s.selected_days.forEach(function(t){n.dates.push((new DateModel).setData({event_date:t,start_time:c.start_hours+":"+c.start_minutes,end_time:c.end_hours+":"+c.end_minutes}))}),n.dates=n.dates.getArrayCopy(),l?i.event.updateEvent(n,t,e):i.event.createEvent(n,t,e)}catch(t){e(t)}}})},t.prototype.render=function(){var e=this,i=!!e.event.id,n=$.extend(!0,{},Object.getProps(e.event),{event_id:e.event.id?e.event.id:void 0,public_at_data_label:"Дата",current_date:moment().format(__C.DATE_FORMAT),tomorrow_date:moment().add(1,"d").format(__C.DATE_FORMAT),button_text:i?"Сохранить":"Опубликовать"}),a={registration_limit_count:e.event.registration_limit_count,registration_till_display_date:"Дата",tomorrow_date:n.tomorrow_date,predefined_field:tmpl("edit-event-registration-predefined-field",[{id:t.lastRegistrationCustomFieldId++,type:"email",name:"E-mail",description:"Текстовое поле для ввода адреса электронной почты"},{id:t.lastRegistrationCustomFieldId++,type:"first_name",name:"Имя",description:"Текстовое поле для ввода имени"},{id:t.lastRegistrationCustomFieldId++,type:"last_name",name:"Фамилия",description:"Текстовое поле для ввода фамилии"},{id:t.lastRegistrationCustomFieldId++,type:"phone_number",name:"Номер телефона",description:"Текстовое поля для ввода номера телефона"}])};if(!checkRedirect("event/add",this.organization_id?"/add/event/to/"+this.organization_id:"/add/event"))return null;if(e.event.registration_required&&e.event.registration_till){var o=moment.unix(e.event.registration_till);a=$.extend(a,{registration_till_display_date:o.format(__LOCALES.ru_RU.DATE.DATE_FORMAT),registration_till_date:o.format(__C.DATE_FORMAT),registration_till_time_hours:o.format("HH"),registration_till_time_minutes:o.format("mm")})}if(null!=e.event.public_at){var s=moment.unix(e.event.public_at);n.public_at_data=s.format("YYYY-MM-DD"),n.public_at_data_label=s.format("DD.MM.YYYY"),n.public_at_time_hours=s.format("HH"),n.public_at_time_minutes=s.format("mm")}e.$wrapper.html(tmpl("edit-event-page",$.extend(n,{date_picker:tmpl("edit-event-datepicker",{today:n.current_date
}),cover_picker:tmpl("edit-event-cover-picker",{image_horizontal_url:e.event.image_horizontal_url,image_horizontal_filename:getFilenameFromURL(e.event.image_horizontal_url)}),registration:tmpl("edit-event-registration",a)}))),e.init(),null!=n.public_at&&e.$wrapper.find("#edit_event_delayed_publication").prop("checked",!0).trigger("change"),this.renderRest(n)},t.prototype.renderRest=function(t){},t}()),EditEventPage=extending(AbstractEditEventPage,function(){function t(t){AbstractEditEventPage.call(this),this.page_title="Редактирование события",this.event=new OneEvent(t)}return t.prototype.fetchData=function(){return this.fetching_data_defer=this.event.fetchEvent(EventPage.fields)},t.prototype.renderRest=function(t){var e=this;!function(t,i,n){var a,o=t.find(".EventDatesCalendar").data("calendar"),s=i[0].start_time.split(":"),r=i[0].end_time?i[0].end_time.split(":"):[],c=t.find(".SelectedDaysRows"),l=[];n?(a=t.find(".MainTime"),a.find(".StartHours").val(s[0]),a.find(".StartMinutes").val(s[1]),r.length&&(a.find(".EndHours").val(r[0]),a.find(".EndMinutes").val(r[1]))):e.$wrapper.find("#edit_event_different_time").prop("checked",!0).trigger("change"),i.forEach(function(t){t.event_date=moment.unix(t.event_date).format("YYYY-MM-DD"),l.push(t.event_date)}),o.selectDays(l),i.forEach(function(t){var e=c.find(".TableDay_"+t.event_date),i=t.start_time.split(":"),n=t.end_time?t.end_time.split(":"):[];e.find(".StartHours").val(i[0]),e.find(".StartMinutes").val(i[1]),n.length&&(e.find(".EndHours").val(n[0]),e.find(".EndMinutes").val(n[1]))})}(e.$wrapper,e.event.dates,e.event.is_same_time),function(t,e){var i=[];e.forEach(function(t){i.push({id:parseInt(t.id),text:t.name})}),t.find("#event_tags").select2("data",i)}(e.$wrapper,e.event.tags),e.event.image_horizontal_url&&toDataUrl(e.event.image_horizontal_url,function(t){e.$wrapper.find("#edit_event_image_horizontal_source").val(t?t:null)}),e.event.is_free||(e.$wrapper.find("#edit_event_free").prop("checked",!1).trigger("change"),e.$wrapper.find("#edit_event_min_price").val(e.event.min_price)),e.event.registration_required&&(e.$wrapper.find("#edit_event_registration_required").prop("checked",!0).trigger("change"),e.event.registration_till&&e.$wrapper.find("#edit_event_registration_limit_by_date").prop("checked",!0).trigger("change"),e.event.registration_limit_count&&e.$wrapper.find("#edit_event_registration_limit_by_quantity").prop("checked",!0).trigger("change"),t.registration_fields&&t.registration_fields.length&&e.$wrapper.find(".AddRegistrationCustomField").before(AbstractEditEventPage.buildRegistrationCustomField(t.registration_fields.filter(function(t){var i=RegistrationFieldModel.isCustomField(t);return i||(e.$wrapper.find("#edit_event_registration_"+t.type+"_field_uuid").val(t.uuid),e.$wrapper.find("#edit_event_registration_"+t.type+"_field_enable").prop("checked",!0).trigger("change"),t.required&&e.$wrapper.find("#edit_event_registration_"+t.type+"_field_required").prop("checked",!0)),i})))),null==t.public_at&&e.$wrapper.find("#edit_event_delayed_publication").toggleStatus("disabled")},t}()),AdminEventEditPage=extending(EditEventPage,AdminEventPage,function(){function t(t){var e=this;EditEventPage.call(this,t),AdminEventPage.call(this,t),this.event_fields.add(EventPage.fields),Object.defineProperty(this,"page_title_obj",{get:function(){return[{title:"Организации",page:"/admin"},{title:e.event.organization_short_name,page:"/admin/organization/"+e.event.organization_id},e.event.title+" - редактирование"]}})}return t}()),AdminEventEditPage.prototype.renderHeaderTabs=AdminEventPage.prototype.renderHeaderTabs,AdminEventOrdersPage=extending(AdminEventPage,function(){function t(t){var e=this;AdminEventPage.call(this,t),this.orders=new EventOrdersCollection(t),this.orders_fields=new Fields("created_at","registration_fields",{user:{},tickets:{fields:new Fields("ticket_type")}}),this.event_fields.add("orders_count"),this.$loader=$(),this.ordersTable=null,Object.defineProperties(this,{page_title_obj:{get:function(){return[{title:"Организации",page:"/admin"},{title:e.event.organization_short_name,page:"/admin/organization/"+e.event.organization_id},e.event.title+" - заказы"]}}})}return t.prototype.initOrdersTable=function(){var t=this;this.ordersTable=this.$wrapper.find(".OrdersTable").eq(0).DataTable({paging:!0,columnDefs:[],dom:'<"data_tables_pagination"p>t<"data_tables_pagination"p>',language:{url:__LOCALE.DATATABLES_URL}}),this.$wrapper.find(".OrdersTableSearch").on("input",function(){t.ordersTable.search(this.value).draw()})},t.prototype.render=function(){var t=this;this.$wrapper.html(tmpl("admin-event-orders-page",{loader:this.$loader=__APP.BUILD.overlayLoader()})),this.orders.fetchAllOrders(this.event.orders_count,this.orders_fields).done(function(){var e=tmpl("admin-event-orders-page-tr",t.orders.map(function(t){return{uuid:t.uuid,number:formatTicketNumber(t.number),status:__APP.BUILD.orderStatusBlock(t.status_type_code),orderer:t.user.full_name,email:t.user.email,buy_time:moment.unix(t.created_at).format(__LOCALE.DATE.DATE_TIME_FORMAT)}}));e.find(".DataTableRowExpand").on("click.ExpandRow",function(){var e,i,n,a=$(this),o=a.closest("tr"),s=t.ordersTable.row(o);s.child.isShown()||(s.child(tmpl("admin-event-orders-page-table-child-row",{ticket_rows:tmpl("admin-event-orders-page-ticket-row",t.orders.getByID(o.data("order_uuid")).tickets.map(function(t){return $.extend({},t,{number:formatTicketNumber(t.number),ticket_type_name:t.ticket_type.name,price:t.price?t.price:"Бесплатно",used:t.checkout?"Билет использован":""})}))})).show(),o.addClass("-has_child")),e=s.child(),i=e.find(".CollapsingWrapper"),n=e.find(".CollapsingContent"),i.height()?i.height(0).removeClass("-opened"):i.height(n.outerHeight()).addClass("-opened"),a.toggleClass([__C.CLASSES.ACTIVE,__C.CLASSES.ICONS.PLUS,__C.CLASSES.ICONS.MINUS].join(" "))}),e.on("click.SelectRow",function(i){var n=$(this),a=n.data();$(i.target).hasClass("DataTableRowExpand")||(a.inspector&&a.inspector.is_shown?a.inspector.hide():(a.inspector instanceof OrderAppInspector||(a.inspector=new OrderAppInspector(t.orders.getByID(n.data("order_uuid")),t.event),n.data(a)),a.inspector.show()),e.not(n).removeClass("-selected"),n.toggleClass("-selected"))}),t.ordersTable||t.initOrdersTable(),t.ordersTable.rows.add(e).draw(),t.$loader.remove(),t.$wrapper.find(".OrdersTableWrapper").removeClass(__C.CLASSES.STATUS.DISABLED)})},t}()),AdminEventOverviewPage=extending(AdminEventPage,function(){function t(t){AdminEventPage.apply(this,arguments),this.graphics_stats=new EventStatistics(this.id),this.scoreboards_stats=new EventStatistics(this.id),this.event_fields.add(new Fields("favored_users_count","is_same_time","dates"))}return t.prototype.render=function(){var t=this;return this.renderHeaderTabs(),__APP.changeTitle([{title:"Организации",page:"/admin"},{title:this.event.organization_short_name,page:"/admin/organization/"+this.event.organization_id},this.event.title]),checkRedirect("overview","/admin/event/"+this.event.id+"/overview",!0)?(this.$wrapper.html(tmpl("eventstat-overview",$.extend(!0,{},this.event,{cover_width:280,dates_block:tmpl("eventstat-overview-datetime",{date:displayDateRange(this.event.first_event_date,this.event.last_event_date),time:this.event.is_same_time?displayTimeRange(this.event.dates[0].start_time,this.event.dates[0].end_time):"Разное время"})}))),this.$wrapper.find(".EventStatAreaCharts").children(".AreaChart").html(tmpl("loader")),this.scoreboards_stats.fetchStatistics(Statistics.SCALES.OVERALL,!1,["notifications_sent","view","fave","view_detail","fave_conversion","open_conversion"],null,function(e){var i={numbers:{}};$.each(e,function(t,e){i.numbers[t]=e[0].value}),t.updateScoreboards(t.$wrapper.find(".EventstatsScoreboards"),i,{fave:"Добавлений в избранное",view:"Просмотров события"},["fave","view"]),t.updateScoreboards(t.$wrapper.find(".EventstatsBigScoreboards"),i,{notifications_sent:"Уведомлений отправлено",view:"Просмотров",view_detail:"Открытий",open_conversion:"Конверсия открытий",fave:"Добавлений",fave_conversion:"Конверсия добавлений"},["notifications_sent","view","view_detail","open_conversion","fave","fave_conversion"],"big")}),this.graphics_stats.fetchStatistics(Statistics.SCALES.DAY,moment(__APP.EVENDATE_BEGIN,"DD-MM-YYYY").format(),["notifications_sent","view","fave","view_detail","fave_conversion","open_conversion"],null,function(e){t.buildAreaCharts(e,{rangeSelector:{selected:1}})}),__APP.MODALS.bindCallModal(t.$wrapper),void bindPageLinks(t.$wrapper)):null},t}()),AdminEventPromotionPage=extending(AdminEventPage,function(){function t(t){AdminEventPage.apply(this,arguments)}return t.prototype.render=function(){},t}()),AdminOrganizationPage=extending(AdminPage,function(){function t(t){AdminPage.apply(this),this.id=t,this.organization=new OneOrganization(this.id),this.with_header_tabs=!0,this.organization_fields=new Fields("privileges")}return t.prototype.fetchData=function(){return this.fetching_data_defer=this.organization.fetchOrganization(this.organization_fields)},t.prototype.renderHeaderTabs=function(){__APP.renderHeaderTabs([{title:"Обзор",page:"/admin/organization/"+this.id+"/overview"},{title:"События",page:"/admin/organization/"+this.id+"/events"},{title:"CRM",page:"/admin/organization/"+this.id+"/crm"},{title:"Настройки",page:"/admin/organization/"+this.id+"/settings"},{title:"Редактирование",page:"/admin/organization/"+this.id+"/edit"}])},t}()),AdminOrganizationCRMPage=extending(AdminOrganizationPage,function(){function t(t){var e=this;AdminOrganizationPage.call(this,t),this.organization_fields=this.organization_fields.add("subscribed_count"),this.subscribers_fields=new Fields("email","accounts_links"),this.organization_subscribers=new OrganizationSubscribersCollection(t),this.CRMTable=null,this.$loader=$(),Object.defineProperty(this,"page_title_obj",{get:function(){return[{title:"Организации",page:"/admin"},e.organization.short_name+" - CRM"]}})}return t.TABLE_COLUMNS=["name","email","accounts","gender","country","city","auth_date","subscription_date","unsubscription_date","organization_page_view","event_page_view","notifications_received","notifications_opened","notifications_hidden","registrations","favored","shared_event","average_check","overall_average_check","spent_on_me","overall_spent","friends","loyalty","solvency"],t.prototype.initCRMTable=function(){var t=this;this.CRMTable=this.$wrapper.find(".CRMTable").eq(0).DataTable({paging:!0,columnDefs:[{targets:0,width:350},{targets:1,width:550},{targets:2,width:90},{targets:3,width:60},{targets:range(24,4),width:100,visible:!1,searchable:!1}],fixedColumns:!0,scrollX:"100%",scrollCollapse:!0,dom:'<"data_tables_pagination"p>t<"data_tables_pagination"p>',language:{url:__LOCALE.DATATABLES_URL}}),this.$wrapper.find(".CRMTableSearch").on("input",function(){t.CRMTable.search(this.value).draw()})},t.prototype.toggleColumn=function(e){var i=this.CRMTable.column(+e===e?e:t.TABLE_COLUMNS.indexOf(e));i.visible(!i.visible()),this.CRMTable.rows().recalcHeight().columns.adjust().fixedColumns().relayout().draw()},t.prototype.init=function(){this.initCRMTable()},t.prototype.render=function(){var t=this;this.$wrapper.html(tmpl("admin-organization-crm-page",{loader:this.$loader=__APP.BUILD.overlayLoader()})),this.$wrapper.find(".CRMTableWrapper").addClass(__C.CLASSES.STATUS.DISABLED),this.init(),this.organization_subscribers.fetchAllSubscribers(this.organization.subscribed_count,this.subscribers_fields).done(function(e){var i=tmpl("admin-organization-crm-page-tr",e.map(function(t){return{name:__APP.BUILD.link({title:t.full_name,page:"/user/"+t.id}),email:t.email,accounts:__APP.BUILD.socialLinks(t.accounts_links),gender:function(t){switch(t){case OneUser.GENDER.MALE:return"М";case OneUser.GENDER.FEMALE:return"Ж";default:case OneUser.GENDER.NEUTRAL:return"—"}}(t.gender)}}));t.CRMTable||t.initCRMTable(),t.CRMTable.rows.add(i).draw();try{t.CRMTable.rows().recalcHeight().columns.adjust().fixedColumns().relayout().draw()}catch(t){__APP.reload()}t.$wrapper.find(".CRMTableWrapper").removeClass(__C.CLASSES.STATUS.DISABLED),t.$loader.remove()})},t}()),AbstractEditOrganizationPage=extending(Page,function(){function t(){Page.call(this),this.organization=new OneOrganization,this.categories=new CategoriesCollection,this.cities=new CitiesCollection,this.state_name="admin",this.fields=new Fields("description","site_url","default_address","vk_url","privileges","facebook_url","email"),this.adding_is_over=!1}return t.prototype.init=function(){function t(t){bindSelect2(t),bindTabs(t),bindLimitInputSize(t),bindRippleEffect(t),bindFileLoadButton(t),ImgLoader.init(t),t.find("#add_organization_address").placepicker(),t.find("#add_organization_submit").off("click.Submit").on("click.Submit",n)}function e(t){var e=a.$wrapper.find("#add_organization_city");a.cities.fetchCities(null,0,"local_name",function(){e.append(tmpl("option",a.cities.map(function(t){return{val:t.id,display_name:t.local_name}}))).select2({containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}),t&&e.select2("val",t)})}function i(t){a.categories.fetchCategories({},0,function(e){var i=a.$wrapper.find("#add_organization_type");i.html(tmpl("option",e.map(function(t){return{val:t.id,display_name:t.name}}))).select2({containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}),t&&i.select2("val",t)})}function n(){function t(t,e){var i=!0,n=t.find("#edit_event_different_time").prop("checked")?t.find('[class^="TableDay_"]'):t.find(".MainTime");return t.find(":required").not(":disabled").each(function(){var t=$(this),e=t.data("maxlength");(""===t.val()||e&&t.val().length>e)&&(i&&$("body").stop().animate({scrollTop:Math.ceil(t.offset().top-150)},1e3,"swing"),handleErrorField(t),i=!1)}),n.each(function(){var t=$(this),e=t.find(".StartHours").val()+t.find(".StartMinutes").val(),n=t.find(".EndHours").val()+t.find(".EndMinutes").val();e>n&&(i&&$("body").stop().animate({scrollTop:Math.ceil(t.offset().top-150)},1e3,"swing"),showNotifier({text:"Начальное время не может быть меньше конечного",status:!1}),i=!1)}),e||t.find(".DataUrl").each(function(){var t=$(this);""===t.val()&&(i&&$("body").stop().animate({scrollTop:Math.ceil(t.closest(".EditEventImgLoadWrap").offset().top-150)},1e3,"swing",function(){showNotifier({text:"Пожалуйста, добавьте обложку организации",status:!1})}),i=!1)}),i}var e,i=a.$wrapper.find("#add-organization-form"),n=new OrganizationModel,o=i.serializeForm(),s=t(i,!!o.organization_id),r=a.organization.id?"updateOrganization":"createOrganization";s&&(a.$wrapper.addClass(__C.CLASSES.STATUS.DISABLED),e=__APP.BUILD.overlayLoader(a.$view),n.setData(o),a.organization[r](n,function(){a.adding_is_over=!0;try{sessionStorage.removeItem("organization_info")}catch(t){}$(".SidebarNav").find(".ContinueRegistration").remove(),socket.emit("utils.registrationFinished",{uuid:a.$wrapper.find("#add_organization_organization_registration_uuid").val()}),socket.emit("utils.updateImages"),a.$wrapper.removeClass(__C.CLASSES.STATUS.DISABLED),e.remove(),__APP.changeState("/organization/"+a.organization.id)},function(){a.$wrapper.removeClass(__C.CLASSES.STATUS.DISABLED),e.remove()}))}var a=this;t(this.$wrapper),bindCallModal(this.$wrapper),i(this.organization.type_id),e(this.organization.city_id||__APP.USER.selected_city.id)},t.prototype.render=function(){return checkRedirect("organization/add","/add/organization")?(this.renderRest(),void this.init()):null},t.prototype.renderRest=function(t){},t}()),EditOrganizationPage=extending(AbstractEditOrganizationPage,function(){function t(t){AbstractEditOrganizationPage.call(this),this.page_title="Редактировать организацию",this.organization=new OneOrganization(t),this.adding_is_over=!0}return t.prototype.fetchData=function(){var t=this.cities.fetchCities(null,0,"local_name");return this.organization.id?this.fetching_data_defer=__APP.SERVER.multipleAjax(t,this.organization.fetchOrganization(this.fields)):this.fetching_data_defer=t},t.prototype.renderRest=function(){var t,e=this;return this.organization.role===OneUser.ROLE.USER?__APP.changeState("/",!0,!0):(this.adding_is_over=!0,t=$.extend(!0,{},this.organization),t.header_text=this.page_title,t.background_img_url&&(t.background_filename=t.background_img_url.split("/").reverse()[0]),t.img_url&&(t.logo_filename=t.img_url.split("/").reverse()[0]),this.$wrapper.html(tmpl("add-organization-page",t)),t.img_url&&toDataUrl(t.img_url,function(t){e.$wrapper.find("#add_organization_img_src").val(t?t:null)}),void(t.background_img_url&&toDataUrl(t.background_img_url,function(t){e.$wrapper.find("#add_organization_background_src").val(t?t:null)})))},t}()),AdminOrganizationEditPage=extending(EditOrganizationPage,AdminOrganizationPage,function(){function t(t){var e=this;EditOrganizationPage.call(this,t),AdminOrganizationPage.call(this,t),Object.defineProperty(this,"page_title_obj",{get:function(){return[{title:"Организации",page:"/admin"},e.organization.short_name+" - редактирование"]}})}return t}()),AdminOrganizationEditPage.prototype.renderHeaderTabs=AdminOrganizationPage.prototype.renderHeaderTabs,AdminOrganizationEventsPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.apply(this,arguments),this.block_scroll=!1,this.future_events_data={future:!0,canceled_shown:!0},this.past_events_data={future:!1,canceled_shown:!0,order_by:"-first_event_date"},this.future_events=new EventsWithStatisticsCollection,this.past_events=new EventsWithStatisticsCollection}return t.buildEventRows=function(t,e){var i=tmpl("orgstat-events-row",t.map(function(t){return $.extend({},t,{date:moment.unix(t[e]).format(__LOCALES.ru_RU.DATE.DATE_FORMAT),timestamp:t[e],conversion:Math.round(0==t.view?t.view:100*t.view_detail/t.view)+"%"})}));return bindPageLinks(i),i},t.prototype.render=function(){var e,i,n=this,a=$(window);return this.organization.role===OneUser.ROLE.USER?__APP.changeState("/",!0,!0):(this.renderHeaderTabs(),__APP.changeTitle([{title:"Организации",page:"/admin"},this.organization.short_name+" - события"]),this.$wrapper.html(tmpl("orgstat-events-page")),this.future_events.fetchOrganizationsEvents(this.organization.id,this.future_events_data,0,function(){this.length&&n.$wrapper.find(".OrgStatFutureEventsWrapper").html(tmpl("orgstat-events-wrapper",{title:"Предстоящие события",rows:t.buildEventRows(n.future_events,"nearest_event_date")})).find("table").tablesort()}),void this.past_events.fetchOrganizationsEvents(this.organization.id,this.past_events_data,30,function(){this.length&&(e=n.$wrapper.find(".OrgStatPastEventsWrapper"),e.html(tmpl("orgstat-events-wrapper",{title:"Прошедшие события",rows:t.buildEventRows(n.past_events,"first_event_date")})),i=e.find("table").tablesort(),a.on("scroll.uploadEvents",function(){a.height()+a.scrollTop()+200>=$(document).height()&&!n.block_scroll&&(n.block_scroll=!0,n.past_events.fetchOrganizationsEvents(n.organization.id,n.past_events_data,30,function(a){n.block_scroll=!1,a.length?(e.find("tbody").append(t.buildEventRows(a,"first_event_date")),i.refresh()):$(window).off("scroll.uploadEvents")}))}))}))},t}()),AdminOrganizationOverviewPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.call(this,t),this.graphics_stats=new OrganizationsStatistics(this.id),this.other_stats=new OrganizationsStatistics(this.id),this.organization_fields=new Fields("description","img_medium_url","default_address","staff","privileges",{events:{length:3,filters:"future=true,is_canceled=false,is_delayed=true",fields:new Fields("organization_short_name","public_at"),order_by:"nearest_event_date"}})}return t.buildStaffBlock=function(t,e,i,n){return i.length?tmpl("orgstat-overview-sidebar-wrapper-title",{title:e}).add(__APP.BUILD.staffAvatarBlocks(t,i,{is_link:!0,entity:__C.ENTITIES.USER,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]},n===OneUser.ROLE.ADMIN)):$()},t.prototype.buildAreaCharts=function(){var t=this;AdminPage.prototype.buildAreaCharts.call(t,{subscribe_unsubscribe:t.graphics_stats.subscribe.map(function(e,i){return{time_value:e.time_value,subscribe:e.value,unsubscribe:t.graphics_stats.unsubscribe[i].value}}),view:t.graphics_stats.view,conversion:t.graphics_stats.conversion})},t.prototype.buildPieChart=function(t,e){function i(t){var e={browser:"Браузер",android:"Аndroid",ios:"iOS",female:"Женщины",male:"Мужчины",other:"Остальные",null:"Не указано"};return[{data:t.map(function(t,i){return{name:t.name?e[t.name]:e[t.gender],y:t.count}})}]}var n={chart:{type:"pie",height:200,style:{fontFamily:"inherit",fontSize:"inherit"}},colors:[__C.COLORS.FRANKLIN,__C.COLORS.ACCENT,__C.COLORS.MUTED,__C.COLORS.MUTED_80,__C.COLORS.MUTED_50,__C.COLORS.MUTED_30],tooltip:{pointFormat:"<b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{center:[45,"50%"],allowPointSelect:!0,cursor:"pointer",size:120,dataLabels:{distance:-35,defer:!1,formatter:function(){return this.percentage>15?Math.round(this.percentage)+"%":null},style:{color:"#fff",fontSize:"20px",fontWeight:"300",textShadow:"none"},y:-6},showInLegend:!0}},legend:{align:"right",verticalAlign:"top",layout:"vertical",width:100,symbolHeight:0,symbolWidth:0,itemMarginBottom:5,labelFormatter:function(){return'<span style="color: '+this.color+'">'+this.name+"</span>"},itemStyle:{cursor:"pointer",fontSize:"14px",fontWeight:"500"},y:12}};t.highcharts($.extend(!0,{},this.highchart_defaults,n,{series:i(e)}))},t.prototype.render=function(){function e(t){return $.extend({},t,{is_link:!0,avatar_classes:["-size_40x40","-rounded"]})}var i=this,n={scale:Statistics.SCALES.WEEK,fields:["subscribe","view","fave","conversion"]},a="org_stats_"+this.id+"_data",o="org_stats_"+this.id+"_until",s=moment.unix(sessionStorage.getItem(o)).isAfter(moment());return checkRedirect("overview","/admin/organization/"+this.organization.id+"/overview",!0)?(this.renderHeaderTabs(),__APP.changeTitle([{title:"Организации",page:"/admin"},this.organization.short_name]),this.$wrapper.html(tmpl("orgstat-overview",$.extend(!0,{},this.organization,{avatar_block:__APP.BUILD.avatarBlocks(this.organization,{entity:__C.ENTITIES.ORGANIZATION,block_classes:["-stack"]}),staff_block:t.buildStaffBlock(this.organization.id,"Администраторы",this.organization.admins.map(e),this.organization.role).add(t.buildStaffBlock(this.organization.id,"Модераторы",this.organization.moderators.map(e),this.organization.role)),event_blocks:this.organization.events.length?tmpl("orgstat-overview-sidebar-wrapper",{content:tmpl("orgstat-overview-sidebar-wrapper-title",{title:"Предстоящие события"}).add(tmpl("orgstat-event-block",this.organization.events.map(function(t){var e=[];return t.canceled&&e.push({title:"Отменено"}),t.public_at&&moment.unix(t.public_at).isBefore()&&e.push({title:"Не опубликовано"}),{id:t.id,title:t.title,organization_short_name:t.organization_short_name,day:moment.unix(t.first_event_date).format("D"),month:moment.unix(t.first_event_date).format("MMM"),badges:tmpl("orgstat-event-block-badge",e)}})))}):""}))),s?(this.graphics_stats.setData(JSON.parse(sessionStorage.getItem(a))),this.buildAreaCharts()):(this.$wrapper.find(".OrgStatAreaCharts").children(".AreaChart").append(tmpl("loader")),this.graphics_stats.fetchStatistics(Statistics.SCALES.DAY,moment(__APP.EVENDATE_BEGIN,"DD-MM-YYYY").format(),["view","subscribe","unsubscribe","conversion"],null,function(){sessionStorage.setItem(a,JSON.stringify(i.graphics_stats)),sessionStorage.setItem(o,moment().add(15,"m").unix()),i.buildAreaCharts()})),this.other_stats.fetchStatistics(Statistics.SCALES.OVERALL,!1,["subscribe","view","fave","conversion","audience"],n,function(t){var e={numbers:{},dynamics:{}};$.each(t.dynamics,function(i,n){e.dynamics[i]=n[0].value,e.numbers[i]=t[i][0].value}),i.buildPieChart(i.$wrapper.find(".GenderPieChart"),this.audience.gender),i.buildPieChart(i.$wrapper.find(".DevicePieChart"),this.audience.devices),i.updateScoreboards(i.$wrapper.find(".Scoreboards"),e,{subscribe:"Подписчиков организатора",fave:"Добавлений в избранное",view:"Просмотров организатора",conversion:"Конверсия открытий/подписок"},["subscribe","fave","view","conversion"])}),bindRippleEffect(this.$wrapper),void bindPageLinks(this.$wrapper)):null},t}()),AdminOrganizationPromotionPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.apply(this,arguments)}return t.prototype.render=function(){},t}()),AdminOrganizationSettingsPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.call(this,t),this.organization_fields=new Fields("city","country","default_address","description","brand_color","is_private","email","privileges","staff","site_url",{tariff:{fields:new Fields("till","available_additional_notifications","available_event_publications","available_tickets_selling","available_telegram_bots","available_slack_bots","available_auditory_analytics","available_in_city","price")}})}return t.buildStaffBlock=function(t,e,i,n){return __APP.BUILD.staffAvatarBlocks(t,e,{is_link:!0,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]},n===OneUser.ROLE.ADMIN).add(__APP.BUILD.addUserAvatarBlock(t,i,{avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]}))},t.prototype.updateOrganizationData=function(){return this.organization.updateOrganization(new OrganizationModel(this.organization))},t.prototype.init=function(){var t=this;bindCallModal(this.$wrapper),bindRippleEffect(this.$wrapper),this.$wrapper.find("#org_admin_settings_is_private").on("change",function(){t.organization.is_private=$(this).prop("checked"),t.updateOrganizationData()}),this.$wrapper.find(".SaveLocal").on("click",function(){t.organization.setData($(this).closest(".SaveLocalWrapper").serializeForm()),t.updateOrganizationData()}),this.$view.on("staff:add",function(e,i,n){var a=t.$wrapper.find(".StaffCollection");t.organization.staff.remove(n.id),t.organization.staff.setData(n),a.find(".User"+n.id).remove(),a.filter(function(t,e){return $(e).data("staff_type")===i}).children("."+__C.CLASSES.HOOKS.ADD_STAFF).before(__APP.BUILD.avatarBlocks(n,{is_link:!0,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]})),bindPageLinks(a)}),this.$wrapper.find(".ActivatePayment").on("click",function(){__APP.SERVER.addData("/api/v1/payments/organizations/",{organization_id:t.organization.id},!1,function(e){tmpl("admin-organization-payment-form",{customer_id:__APP.USER.full_name,cps_email:__APP.USER.email,callback_url:location.href,payment_uuid:e.uuid,sum:e.sum},t.$wrapper).submit().remove()})})},t.prototype.render=function(){var e=this;({is_link:!0,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]});this.renderHeaderTabs(),__APP.changeTitle([{title:"Организации",page:"/admin"},this.organization.short_name+" - настройки"]),this.$wrapper.html(tmpl("admin-organization-settings-page",$.extend({},this.organization,{admin_avatar_blocks:t.buildStaffBlock(this.organization.id,this.organization.admins,OneUser.ROLE.ADMIN,this.organization.role),moderator_avatar_blocks:t.buildStaffBlock(this.organization.id,this.organization.moderators,OneUser.ROLE.MODERATOR,this.organization.role),private_checkbox:__APP.BUILD.checkbox({id:"org_admin_settings_is_private",name:"is_private",label:"Закрытая организация",attributes:{checked:e.organization.is_private}}),subdomain_radio:__APP.BUILD.radio({id:"org_admin_settings_subdomain_enabled",name:"domains"}),other_domain_radio:__APP.BUILD.radio({id:"org_admin_settings_other_domain_enabled",name:"domains"}),tariff_button:__APP.BUILD.button({title:"Оплатить",classes:[__C.CLASSES.COLORS.ACCENT,__C.CLASSES.HOOKS.RIPPLE,"ActivatePayment"]}),tariff_service_info:e.organization.tariff.is_full?"Оплачен до "+moment.unix(e.organization.tariff.till).calendar(null,{sameDay:"[Сегодня]",nextDay:"[Завтра]",nextWeek:"D MMMM YYYY",lastWeek:"D MMMM YYYY",sameElse:"D MMMM YYYY"}):""}))),this.init()},t.prototype.destroy=function(){this.$view.off("staff:add")},t}()),AdminOrganizationSupportPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.apply(this,arguments)}return t.prototype.render=function(){},t}()),FeedPage=extending(Page,function(){function t(){Page.call(this),this.fields=new Fields("organization_short_name","organization_logo_small_url","dates","is_same_time","favored_users_count","is_favorite","is_registered","ticketing_locally","registration_locally","registration_available","registration_required","registration_till","registration_limit_count","is_free","min_price",{favored:{fields:"is_friend",order_by:"-is_friend",length:5}}),this.events=new EventsCollection,this.next_events_length=10,this.cities=new CitiesCollection,this.wrapper_tmpl="feed",this.with_header_tabs=!0}return t.prototype.bindFeedEvents=function(t){trimAvatarsCollection(t),bindRippleEffect(t),bindDropdown(t),__APP.MODALS.bindCallModal(t),bindPageLinks(t),t.find(".HideEvent").not(".-Handled_HideEvent").each(function(){var t=$(this),e=t.parents(".FeedEvent"),i=t.data("event-id");t.on("click",function(){e.addClass("-cancel"),OneEvent.changeEventStatus(i,OneEvent.STATUS.HIDE,function(){e.after(tmpl("button",{classes:"-color_neutral ReturnEvent",title:"Вернуть событие",dataset:'data-event-id="'+i+'"'})),e.siblings(".ReturnEvent").not(".-Handled_ReturnEvent").on("click",function(){var t=$(this);OneEvent.changeEventStatus(i,OneEvent.STATUS.SHOW,function(){t.remove(),e.removeClass("-cancel")})}).addClass("-Handled_ReturnEvent")})})}).addClass("-Handled_HideEvent")},t.prototype.addNoEventsBlock=function(){var t=tmpl("feed-no-event",{text:"Как насчет того, чтобы подписаться на организации?",button:__APP.BUILD.link({title:"Перейти к каталогу",classes:["button","-color_neutral_accent","RippleEffect"],page:"/organizations"})},this.$wrapper);bindPageLinks(t),bindRippleEffect(t)},t.prototype.appendEvents=function(t){var e=this,i=__APP.BUILD.loaderBlock(e.$wrapper);return e.block_scroll=!0,e.events.fetchFeed(this.fields,this.next_events_length,{city_id:__APP.USER.selected_city.id},function(n){var a=__APP.BUILD.eventCards(e.events.last_pushed);e.block_scroll=!1,a.length?(e.$wrapper.append(a),e.bindFeedEvents(a),isFunction(t)&&t(a)):(e.addNoEventsBlock(),$(window).off("scroll.upload"+e.constructor.name)),i.remove()})},t.prototype.initFeedCalendar=function(){var t=this,e=t.events.date,i=new Calendar(t.$view.find(".FeedCalendar"),{classes:{wrapper_class:"feed_calendar_wrapper",table_class:"feed_calendar_table",thead_class:"feed_calendar_thead",tbody_class:"feed_calendar_tbody",th_class:"feed_calendar_th",td_class:"feed_calendar_td",td_disabled:__C.CLASSES.DISABLED}});i.init(),e&&i.setMonth(e.split("-")[1],e.split("-")[0]).selectDays(e),i.setDaysWithEvents(),i.$calendar.on("month-changed",function(){bindPageLinks(i.$calendar),i.setDaysWithEvents()})},t.prototype.initCitySelect=function(){var t=this;t.cities.fetchCities(null,0,"distance,local_name").done(function(){t.$view.find(".FeedCitiesSelect").html(tmpl("option",t.cities.map(function(t){return{val:t.id,display_name:t.local_name}}))).select2({containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}).select2("val",__APP.USER.selected_city.id).off("change.SelectCity").on("change.SelectCity",function(){__APP.USER.selected_city=t.cities.getByID($(this).val()),__APP.reload()})})},t.prototype.render=function(){var e=this,i=$(window);if(__APP.PREVIOUS_PAGE instanceof t||(e.initFeedCalendar(),e.initCitySelect()),__APP.USER.isLoggedOut()){if(__APP.renderHeaderTabs([{title:"Актуальные",page:"/feed/actual"},{title:"По времени",page:"/feed/timeline"}]),e.$view.find(".BecomeOrg").on("click",function(t){return cookies.removeItem("auth_command"),cookies.removeItem("auth_entity_id"),new AuthModal(location.origin+"/add/organization").show(),!1}),"/feed/favored"===window.location.pathname||"/feed/recommendations"===window.location.pathname)return __APP.changeState("/feed/actual",!0,!0),null}else __APP.renderHeaderTabs([{title:"Актуальные",page:"/feed/actual"},{title:"По времени",page:"/feed/timeline"
},{title:"Избранные",page:"/feed/favored"},{title:"Рекомендованные",page:"/feed/recommendations"}]);i.off("scroll"),e.appendEvents(function(){isScrollRemain(1e3)&&e.appendEvents(),i.on("scroll.upload"+e.constructor.name,function(){isScrollRemain(1e3)&&!e.block_scroll&&e.appendEvents()})})},t}()),ActualEventsPage=extending(FeedPage,function(){function t(){FeedPage.apply(this),this.events=new ActualEventsCollection,this.page_title="Актуальные события"}return t}()),DayEventsPage=extending(FeedPage,function(){function t(t){if(!t)throw Error("DayEventsCollection must have date parameter");FeedPage.apply(this),this.date=t,this.events=new DayEventsCollection(this.date),this.page_title="События на "+moment(this.date).format("D MMMM YYYY")}return t}()),FavoredEventsPage=extending(FeedPage,function(){function t(){FeedPage.apply(this),this.events=new FavoredEventsCollection,this.page_title="Избранные события"}return t}()),FriendsEventsPage=extending(FeedPage,function(){function t(){FeedPage.apply(this),this.events=new FriendsEventsCollection,this.page_title="События друзей"}return t}()),RecommendedEventsPage=extending(FeedPage,function(){function t(){FeedPage.apply(this),this.events=new RecommendedEventsCollection,this.page_title="Рекомендованные события"}return t}()),TimelineEventsPage=extending(FeedPage,function(){function t(){FeedPage.apply(this),this.events=new TimelineEventsCollection,this.page_title="События по времени"}return t}()),NotFoundPage=extending(Page,function(){function t(){Page.call(this)}return t.prototype.render=function(){__APP.changeTitle("Страница не найдена")},t}()),AdminOrganizationsPage=extending(AdminPage,function(){function t(){AdminPage.call(this),this.is_upload_disabled=!1,this.block_scroll=!1,this.my_organizations_fields=new Fields("img_medium_url","subscribed_count","staff"),this.page_title="Организации",this.my_organizations=new OrganizationsCollection}return t.buildMyOrganizationsBlocks=function(t){return tmpl("statistics-overview-organization",t.map(function(t){var e=2,i=[{name:OneUser.ROLE.ADMIN,title:"Администраторы",staff:t.admins,plural_name:OneUser.ROLE.ADMIN+"s_block"},{name:OneUser.ROLE.MODERATOR,title:"Модераторы",staff:t.moderators,plural_name:OneUser.ROLE.MODERATOR+"s_block"}];return $.extend(!0,{},t,{subscribers:t.subscribed_count+getUnitsText(t.subscribed_count,__LOCALES.ru_RU.TEXTS.SUBSCRIBERS),buttons:__APP.BUILD.link({title:"Редактировать",classes:["button","fa_icon","fa-pencil","-color_neutral","RippleEffect"],page:"/admin/organization/"+t.id+"/edit"},{title:"Создать событие",classes:["button","fa_icon","fa-plus","-color_accent","RippleEffect"],page:"/add/event/to/"+t.id})},i.reduce(function(i,n){return i[n.plural_name]=__APP.BUILD.avatarCollection(n.staff.map(function(t){return $.extend({},t,{is_link:!0,avatar_classes:["-size_100x100","-rounded"]})}),e,{dataset:{modal_type:"editors",modal_specific_role:n.name,modal_title:n.title,modal_organization_id:t.id},classes:["-size_30x30","-rounded","-shifted","CallModal"],counter_classes:["-size_30x30","-color_marginal_primary"]}),i},{}))}))},t.prototype.fetchData=function(){return this.fetching_data_defer=this.my_organizations.fetchMyOrganizations([OneUser.ROLE.ADMIN,OneUser.ROLE.MODERATOR],this.my_organizations_fields,10,"")},t.prototype.bindOrganizationsEvents=function(t){return trimAvatarsCollection(t),bindPageLinks(t),__APP.MODALS.bindCallModal(t),bindRippleEffect(t),t},t.prototype.init=function(){var e=this;this.bindOrganizationsEvents(this.$wrapper),$(window).on("scroll.uploadOrganizations",function(){var i,n,a;!isScrollRemain(200)||e.is_upload_disabled||e.block_scroll||(e.block_scroll=!0,n=e.$wrapper.find(".StatOverviewOrganizations"),i=__APP.BUILD.loaderBlock(n),e.my_organizations.fetchMyOrganizations([OneUser.ROLE.ADMIN,OneUser.ROLE.MODERATOR],e.my_organizations_fields,10,"",function(o){e.block_scroll=!1,i.remove(),a=t.buildMyOrganizationsBlocks(o),o.length?(n.append(a),e.bindOrganizationsEvents(a)):e.is_upload_disabled=!0}))})},t.prototype.render=function(){return __APP.USER.id===-1?(__APP.changeState("/feed/actual",!0,!0),null):(this.$wrapper.html(tmpl("statistics-overview-wrapper",{organizations:t.buildMyOrganizationsBlocks(this.my_organizations)})),void this.init())},t.prototype.destroy=function(){$(window).off("scroll.uploadOrganizations")},t}()),OnboardingPage=extending(Page,function(){function t(){Page.apply(this,arguments),this.ajax_data={length:30,offset:0,fields:"img_small_url"},this.state_name="onboarding_page",this.is_upload_disabled=!1,this.block_scroll=!0}return t.prototype.init=function(){bindRippleEffect(this.$wrapper),bindPageLinks(this.$wrapper),this.$wrapper.find(".Link").on("click",function(){$(this).is(".SkipOnboarding")&&cookies.setItem("skip_onboarding",1,moment().add(7,"d")._d),__APP.SIDEBAR.updateSubscriptions()})},t.prototype.bindSubscriptions=function(){this.$wrapper.find(".OnboardingOrgItem").not(".-Handled_OnboardingOrgItem").on("click",function(){var t=$(this);t.hasClass(__C.CLASSES.ACTIVE)?__APP.USER.unsubscribeFromOrganization(t.data("organization_id")):__APP.USER.subscribeToOrganization(t.data("organization_id")),t.toggleClass(__C.CLASSES.ACTIVE)}).addClass("-Handled_OnboardingOrgItem")},t.prototype.render=function(){function t(t){i.detach(),t.length?(e.$wrapper.find(".RecommendationsWrapper").last().append(tmpl("onboarding-recommendation",t)),e.bindSubscriptions(),e.block_scroll=!1):e.is_upload_disabled=!0}var e=this,i=tmpl("loader",{});return __APP.USER.id===-1?(__APP.changeState("/feed/actual",!0,!0),null):(e.$wrapper.html(tmpl("onboarding-main",{})),e.init(),e.$wrapper.find(".RecommendationsWrapper").last().append(i),OrganizationsCollection.fetchRecommendations(e.ajax_data,t),void e.$wrapper.find(".RecommendationsScrollbar").scrollbar({onScroll:function(n,a){n.scroll!=n.maxScroll||e.is_upload_disabled||e.block_scroll||(e.block_scroll=!0,e.$wrapper.find(".RecommendationsWrapper").last().append(i),OrganizationsCollection.fetchRecommendations(e.ajax_data,t))}}))},t}()),AddEventPage=extending(AbstractEditEventPage,function(){function t(t){AbstractEditEventPage.call(this),this.page_title="Добавить событие",this.organization_id=t}return t}()),EventPage=extending(Page,function(){function t(t){Page.apply(this),this.event=new OneEvent(t)}return t.fields=new Fields(["image_horizontal_medium_url","image_horizontal_large_url","favored_users_count","is_favorite","description","location","latitude","longitude","is_online","can_edit","is_free","min_price","organization_logo_small_url","organization_short_name","is_same_time","tags","detail_info_url","canceled","public_at","is_registered","registration_required","registration_approvement_required","registration_till","registration_limit_count","registration_locally","registration_fields","registration_available","registration_approved","registered_count","registered"],{dates:{length:0,fields:new Fields("start_time","end_time")},favored:{fields:new Fields("is_friend"),order_by:"-is_friend",length:10},notifications:{fields:new Fields("notification_type","done")},orders:{fields:new Fields("created_at")},tickets:new Fields("created_at","number","ticket_type")}),t.buildNotifications=function(t,e,i){var n=moment(),a={"notification-before-quarter-of-hour":{label:"За 15 минут",moment:moment.unix(i).subtract(15,"minutes").unix()},"notification-before-three-hours":{label:"За 3 часа",moment:moment.unix(i).subtract(3,"hours").unix()},"notification-before-day":{label:"За день",moment:moment.unix(i).subtract(1,"days").unix()},"notification-before-three-days":{label:"За 3 дня",moment:moment.unix(i).subtract(3,"days").unix()},"notification-before-week":{label:"За неделю",moment:moment.unix(i).subtract(1,"week").unix()}},o=$(),s={},r=0;for(var c in t)t.hasOwnProperty(c)&&(s[t[c].notification_type]=t[c]);for(var l in a)if(a.hasOwnProperty(l)){var d=moment.unix(a[l].moment).isBefore(n),_={id:"event_notify_"+ ++r,classes:["ToggleNotification"],name:"notification_time",label:a[l].label,attributes:{value:l},dataset:{event_id:e}};s[l]&&(d=d||s[l].done||!s[l].uuid,s[l].uuid&&(_.dataset.uuid=s[l].uuid),_.attributes.checked=!0),d&&(_.unit_classes=["-status_disabled"],_.attributes.disabled=!0),o=o.add(__APP.BUILD.checkbox(_))}return o},t.prototype.fetchData=function(){return this.fetching_data_defer=this.event.fetchEvent(t.fields)},t.prototype.init=function(){var t=this;trimAvatarsCollection(t.$wrapper),bindRippleEffect(t.$wrapper),bindDropdown(t.$wrapper),__APP.MODALS.bindCallModal(t.$wrapper),bindCollapsing(t.$wrapper),bindPageLinks(t.$wrapper),t.$wrapper.find(".ToggleNotification").each(function(){var e=$(this);e.on("change",function(){e.prop("disabled",!0),e.prop("checked")?t.event.addNotification(e.val(),function(t){e.data("uuid",t.uuid),e.prop("disabled",!1)}):t.event.deleteNotification(e.data("uuid"),function(){e.data("uuid",void 0),e.prop("disabled",!1)})})}),t.$wrapper.find(".CancelEvent").on("click.CancelEvent",function(){t.event.changeEventStatus(OneEvent.STATUS.CANCEL,function(){t.$wrapper.find(".event_canceled_cap").removeClass(__C.CLASSES.HIDDEN)})}),t.$wrapper.find(".CancelCancellation").on("click.CancelCancellation",function(){t.event.changeEventStatus(OneEvent.STATUS.BRING_BACK,function(){t.$wrapper.find(".event_canceled_cap").addClass(__C.CLASSES.HIDDEN)})}),t.$wrapper.find(".ExternalLink").on("click.sendStat",function(){storeStat(t.event.id,__C.STATS.EVENT_ENTITY,__C.STATS.EVENT_OPEN_SITE)}),t.$wrapper.find(".EventMap").on("click.sendStat",function(){storeStat(t.event.id,__C.STATS.EVENT_ENTITY,__C.STATS.EVENT_OPEN_MAP)})},t.prototype.render=function(){var e=this,i=630,n=e.event,a=[__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.SIZES.SMALL,__C.CLASSES.HOOKS.ADD_AVATAR.COLLECTION,__C.CLASSES.HOOKS.CALL_MODAL],o=__APP.BUILD.button({classes:[__C.CLASSES.UNIVERSAL_STATES.EMPTY,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.SIZES.LOW,__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.BELL_O,__C.CLASSES.COLORS.NEUTRAL,__C.CLASSES.HOOKS.RIPPLE,__C.CLASSES.HOOKS.DROPDOWN_BUTTON],dataset:{dropdown:"edit_notification",ddWidth:190,ddPosX:"self.center",ddPosY:6}}),s=$(),r=$(),c=new OneOrganization(n.organization_id);if(c.setData({short_name:n.organization_short_name,img_url:n.organization_logo_small_url}),__APP.changeTitle(n.title),n.is_favorite&&a.push(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED),n.registration_locally||n.ticketing_locally?(o=o.add(new AddToFavoriteButton(n.id,{is_add_avatar:!0,is_checked:n.is_favorite,classes:[__C.CLASSES.UNIVERSAL_STATES.EMPTY,__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.RIPPLE],labels:null,colors:{unchecked:__C.CLASSES.COLORS.NEUTRAL_ACCENT,unchecked_hover:__C.CLASSES.COLORS.NEUTRAL_ACCENT}})),n.ticketing_locally||(o=o.add(new RegisterButton(n,{classes:["event_main_action_button",__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.RIPPLE],colors:{unchecked:__C.CLASSES.COLORS.NEUTRAL_ACCENT,unchecked_hover:__C.CLASSES.COLORS.NEUTRAL_ACCENT}})))):o=o.add(new AddToFavoriteButton(n.id,{is_add_avatar:!0,is_checked:n.is_favorite,classes:["event_main_action_button",__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.RIPPLE],colors:{unchecked:__C.CLASSES.COLORS.NEUTRAL_ACCENT,unchecked_hover:__C.CLASSES.COLORS.NEUTRAL_ACCENT}})),n.registration_required&&(r=r.add(tmpl("event-additional-info",{classes:__C.CLASSES.TEXT_COLORS.ACCENT+" "+__C.CLASSES.UNIVERSAL_STATES.TRANSFORM_UPPERCASE,text:n.registration_till?"Регистрация до "+moment.unix(n.registration_till).calendar(null,__LOCALES.ru_RU.DATE.CALENDAR_DATE_TIME):"Регистрация обязательна"}))),n.is_free||(r=r.add(tmpl("event-additional-info",{classes:__C.CLASSES.TEXT_COLORS.ACCENT,text:"от "+(n.min_price?formatCurrency(n.min_price):"0")+" руб."}))),n.is_online&&(r=r.add(tmpl("event-additional-info",{classes:__C.CLASSES.TEXT_COLORS.ACCENT,text:"Online"}))),s=n.is_same_time?s.add(tmpl("event-additional-field",{key:"Время",value:displayTimeRange(n.dates[0].start_time,n.dates[0].end_time)})):s.add(tmpl("event-date-time",{date_times:tmpl("event-date-time-row",formatDates(n.dates,{date:"{D} {MMMMs}",time:"{T}"},n.is_same_time))})),n.location&&(s=s.add(tmpl("event-additional-field",{key:"Место",value:n.location}))),s=s.add(tmpl("event-additional-field",{key:"Теги",value:__APP.BUILD.tags(n.tags)})),n.detail_info_url&&(s=s.add(tmpl("event-detail-link",{detail_info_url:n.detail_info_url}))),e.$wrapper.html(tmpl("event-page",$.extend({},n,{cover_width:i,action_buttons:o,avatars_collection:__APP.BUILD.avatarCollection(n.favored,6,{dataset:{modal_type:"favors",modal_event_id:n.id},classes:a,counter_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.COLORS.MARGINAL,__C.CLASSES.HOOKS.ADD_AVATAR.STATES.CASTABLE]},n.favored_users_count),notifications:t.buildNotifications(n.notifications,n.id,n.last_event_date),event_map:n.location?tmpl("event-map",{location_sanitized:encodeURI(n.location)}):"",event_edit_functions:n.can_edit?tmpl("event-edit-functions",n):"",event_additional_info:r,canceled:n.canceled?"":__C.CLASSES.HIDDEN,organization_avatar_block:__APP.BUILD.avatarBlocks(c,{block_classes:[__C.CLASSES.SIZES.SMALL],is_link:!0,entity:__C.ENTITIES.ORGANIZATION}),event_additional_fields:s,cancel_cancellation:n.can_edit?tmpl("button",{classes:__C.CLASSES.COLORS.PRIMARY+" "+__C.CLASSES.HOOKS.RIPPLE+" CancelCancellation",title:"Вернуть событие"}):""}))),n.is_same_time){var l=n.nearest_event_date?moment.unix(n.nearest_event_date):moment.unix(n.first_event_date);e.calendar=new Calendar(e.$wrapper.find(".EventCalendar"),{classes:{wrapper_class:"feed_calendar_wrapper",td_class:"event_calendar_day",table_class:"feed_calendar_table"},selection_type:Calendar.SELECTION_TYPES.MULTI,disable_selection:!0}),e.calendar.init().setMonth(l.format("M"),l.format("YYYY")).selectDays(n.dates.map(function(t){return moment.unix(t.event_date).format(__C.DATE_FORMAT)}))}__APP.USER.id===-1&&$(".DropdownButton, .DropdownBox").remove(),e.init()},t}()),AddOrganizationPage=extending(AbstractEditOrganizationPage,function(){function t(){AbstractEditOrganizationPage.call(this),this.page_title="Новая организация",this.adding_is_over=!1}return t.prototype.destroy=function(){var t=this.$wrapper.find("#add-organization-form").serializeForm(),e=$(".SidebarNav");if(!this.adding_is_over){e.find(".ContinueRegistration").length||(e.prepend(__APP.BUILD.link({page:"/add/organization",title:"Продолжить регистрацию",classes:["sidebar_navigation_item","SidebarNavItem","ContinueRegistration"]})),bindPageLinks(e));try{sessionStorage.setItem("organization_info",JSON.stringify({city_id:t.city_id,type_id:t.type_id,name:t.name,short_name:t.short_name,email:t.email,site_url:t.site_url,default_address:t.default_address,description:t.description,facebook_url:t.facebook_url,vk_url:t.vk_url}))}catch(t){}}},t.prototype.renderRest=function(){var t,e;try{e=JSON.parse(sessionStorage.getItem("organization_info")?sessionStorage.getItem("organization_info"):localStorage.getItem("organization_info")),sessionStorage.removeItem("organization_info")}catch(t){e={}}t=$.extend({header_text:this.page_title},e,!0),this.$wrapper.html(tmpl("add-organization-page",t))},t}()),CatalogPage=extending(Page,function(){function t(t,e){Page.apply(this),$.isNumeric(t)&&!e&&(e=t,t=__APP.USER.selected_city.en_name),this.wrapper_tmpl="organizations",this.categories_ajax_data={order_by:"order_position"},this.organizations_ajax_data={fields:["background_small_img_url","img_small_url","is_subscribed","subscribed_count","privileges"],order_by:"-subscribed_count"},this.default_title="Организации",this.selected_city=new OneCity,this.selected_city_name=t||__APP.USER.selected_city.en_name,this.selected_category_id=e,this.cities=new CitiesCollection,this.categories=new CategoriesCollection,this.all_organizations=new OrganizationsCollection}return t.prototype.fetchData=function(){var t=this;return this.fetching_data_defer=this.cities.fetchCities(null,0,"distance,local_name",function(){t.selected_city_name&&(t.selected_city=this.getByName(t.selected_city_name),t.categories_ajax_data.city_id=t.selected_city.id)}).then(function(){return t.categories.fetchCategoriesWithOrganizations(t.categories_ajax_data,t.organizations_ajax_data,0).done(function(){t.all_organizations=t.categories.reduce(function(t,e){return t.setData(e.organizations)},new OrganizationsCollection).sort(function(t,e){return e.subscribed_count-t.subscribed_count})})}).promise()},t.prototype.selectCategory=function(t){this.selected_category_id=t?t:this.selected_category_id,this.$view.find(".Category").filter('[data-category-id="'+this.selected_category_id+'"]').addClass(__C.CLASSES.ACTIVE),__APP.changeState("/organizations/at/"+this.selected_city_name+"/"+this.selected_category_id,!0),__APP.changeTitle(this.categories.getByID(this.selected_category_id).name)},t.prototype.init=function(){function t(){bindRippleEffect(e.$view),bindPageLinks(e.$view)}var e=this,i=e.$view.find(".Category"),n=e.$view.find("#organizations_cities_select");$(window).on("subscribe.updateCatalog",function(t,i){var n=e.all_organizations.getByID(i);n.is_subscribed=!0,n.subscribed_count++}),$(window).on("unsubscribe.updateCatalog",function(t,i){var n=e.all_organizations.getByID(i);n.is_subscribed=!1,n.subscribed_count--}),t(),e.$view.find(".OrganizationsCategoriesScroll").scrollbar({disableBodyScroll:!0}),n.select2({containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}).off("change.SelectCity").on("change.SelectCity",function(){var t=e.cities.getByID($(this).val());__APP.USER.selected_city=t,__APP.changeState("/organizations/at/"+t.en_name,!0,!0)}),e.selected_city_name&&n.select2("val",e.cities.getByName(e.selected_city_name).id),e.$view.find(".ShowAllOrganizations").off("click.showAllOrganizations").on("click.showAllOrganizations",function(){i.removeClass(__C.CLASSES.ACTIVE).siblings(".SubcategoryWrap").height(0),e.selected_category_id=void 0,__APP.changeState("/organizations/at/"+e.selected_city_name,!0),__APP.changeTitle(e.default_title),e.$wrapper.html(__APP.BUILD.organizationCard(e.all_organizations)),t()}),i.off("click.selectCategory").on("click.selectCategory",function(){var i=$(this),n=i.data("category-id"),a=i.next(".SubcategoryWrap"),o=!!a.length,s=i.hasClass(__C.CLASSES.ACTIVE);i.parent().find(".Category").not(i).removeClass(__C.CLASSES.ACTIVE).filter(".SubcategoryWrap").height(0),o?(a.height(s?0:a.children().outerHeight()),i.toggleClass(__C.CLASSES.ACTIVE)):s?(e.categories=new CategoriesCollection,e.categories.fetchCategoriesWithOrganizations(e.categories_ajax_data,e.organizations_ajax_data,0,function(){e.render()})):(e.selectCategory(n),e.$wrapper.html(__APP.BUILD.organizationCard(e.categories.getByID(n).organizations)),t())})},t.prototype.render=function(){this.$view.find("#organizations_cities_select").html(tmpl("option",this.cities.map(function(t){return{val:t.id,display_name:t.local_name}}))),this.$view.find(".OrganizationsCategoriesScroll").html(__APP.BUILD.organisationsCategoriesItems(this.categories)),this.$wrapper.html(__APP.BUILD.organizationCard(this.selected_category_id?this.categories.getByID(this.selected_category_id).organizations:this.all_organizations)),"/organizations"!=window.location.pathname&&"/organizations/"!=window.location.pathname||!this.selected_city_name||__APP.changeState("/organizations/at/"+this.selected_city_name,!0),this.selected_category_id?this.selectCategory(this.selected_category_id):__APP.changeTitle(this.default_title),this.init()},t.prototype.destroy=function(){$(window).off("subscribe.updateCatalog unsubscribe.updateCatalog")},t}()),OrganizationPage=extending(Page,function(){function t(t){var e={last_date:"",block_scroll:!1,is_upload_disabled:!1};Page.call(this),this.fields=new Fields("img_small_url","background_medium_img_url","description","site_url","is_subscribed","privileges","default_address","subscribed_count",{subscribed:{fields:"is_friend",order_by:"-is_friend,first_name",length:10}}),this.events_fields=new Fields("image_horizontal_medium_url","favored_users_count","is_favorite","is_registered","registration_available","registration_locally","ticketing_locally","dates",{favored:{length:5}}),this.event_types={future:$.extend(!0,{},e,{name:"future",scroll_event:"scroll.uploadFutureEvents",sort_date_type:"nearest_event_date"}),past:$.extend(!0,{},e,{name:"past",scroll_event:"scroll.uploadPastEvents",sort_date_type:"last_event_date"}),delayed:$.extend(!0,{},e,{name:"delayed",scroll_event:"scroll.uploadDelayedEvents",sort_date_type:"public_at"}),canceled:$.extend(!0,{},e,{name:"canceled",scroll_event:"scroll.uploadCanceledEvents",sort_date_type:"first_event_date"})},this.current_tab=this.event_types.future.name,this.is_admin=!1,this.future_events=new FutureEventsCollection,this.past_events=new PastEventsCollection,this.delayed_events=new DelayedEventsCollection,this.canceled_events=new CanceledEventsCollection,this.organization=new OneOrganization(t)}return t.prototype.fetchData=function(){var t=this;return this.fetching_data_defer=this.organization.fetchOrganization(this.fields).done(function(e){t.is_admin=t.organization.role!==OneUser.ROLE.USER}).promise()},t.prototype.fetchAndAppendFeed=function(t,e){var i,n,a,o=this;t.is_upload_disabled||t.block_scroll||(i=this.$wrapper.find("."+t.name.capitalize()+"Events"),n=__APP.BUILD.loaderBlock(i),t.block_scroll=!0,o[t.name+"_events"].fetchOrganizationsFeed(o.organization.id,o.events_fields,10,function(s){n.remove(),t.block_scroll=!1,s.length?a=__APP.BUILD.eventBlocks(s,t):(t.is_upload_disabled=!0,a=tmpl("organization-feed-no-event",{text:"Больше событий нет :("})),i.append(a),o.bindFeedEvents(a),isFunction(e)&&e()}))},t.prototype.bindFeedEvents=function(t){bindRippleEffect(t),trimAvatarsCollection(t),bindCallModal(t),bindPageLinks(t)},t.prototype.init=function(){var t=this,e=t.$wrapper.find(".SubscribersScroll");bindTabs(t.$wrapper),bindCallModal(t.$wrapper),t.$wrapper.find(".Tabs").on("change.tabs",function(){t.current_tab=$(this).find(".Tab.-active").data("type")}),t.$wrapper.find(".ExternalPage").on("click.sendStat",function(){storeStat(t.organization.id,__C.STATS.ORGANIZATION_ENTITY,__C.STATS.ORGANIZATION_OPEN_SITE)}),isScrollRemain(1e3)&&t.fetchAndAppendFeed(t.event_types[t.current_tab]),$(window).on("scroll.uploadEvents",function(){isScrollRemain(1e3)&&t.fetchAndAppendFeed(t.event_types[t.current_tab])}),t.organization.subscribed.last_pushed.length&&e.scrollbar({disableBodyScroll:!0,onScroll:function(i){var n,a=t.organization.subscribed.last_pushed[t.organization.subscribed.last_pushed.length-1].is_friend;i.scroll+200>=i.maxScroll&&!e.block_scroll&&(e.block_scroll=!0,n=__APP.BUILD.loaderBlock(e),t.organization.subscribed.fetchOrganizationSubscribers(t.organization.id,10,{fields:"is_friend",order_by:"-is_friend,first_name"},function(t){t.length?(e.append(__APP.BUILD.subscribers(t,a)),e.block_scroll=!1):e.off("scroll.onScroll"),n.remove(),bindPageLinks(e)}))}})},t.prototype.render=function(){var t=this,e=new OneOrganization(t.organization.id);e.setData(t.organization),__APP.changeTitle(e.short_name),__APP.SIDEBAR.$subscribed_orgs.find('[data-organization_id="'+e.id+'"]').find(".OrganizationCounter").addClass(__C.CLASSES.HIDDEN),t.$wrapper.html(tmpl("organization-wrapper",$.extend(!0,{background_image:e.background_img_url?tmpl("organization-background-image",e):"",avatar_block:__APP.BUILD.avatarBlocks(e,{block_classes:["organization_title_block"],avatar_classes:[__C.CLASSES.SIZES.SMALL,"organization_avatar"],entity:__C.ENTITIES.ORGANIZATION}),subscribe_button:new SubscribeButton(e.id,{is_checked:e.is_subscribed,colors:{checked:__C.CLASSES.COLORS.NEUTRAL,unchecked:__C.CLASSES.COLORS.ACCENT,checked_hover:__C.CLASSES.COLORS.NEUTRAL,unchecked_hover:__C.CLASSES.COLORS.ACCENT},classes:[__C.CLASSES.SIZES.LOW,__C.CLASSES.SIZES.WIDE,__C.CLASSES.HOOKS.RIPPLE]}),has_address:e.default_address?"":__C.CLASSES.HIDDEN,redact_org_button:e.role===OneUser.ROLE.ADMIN?__APP.BUILD.link({title:__LOCALES.ru_RU.TEXTS.BUTTON.EDIT,classes:["button",__C.CLASSES.SIZES.WIDE,__C.CLASSES.COLORS.NEUTRAL,__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.PENCIL,__C.CLASSES.HOOKS.RIPPLE],page:"/admin/organization/"+e.id+"/edit/"}):"",hidden_for_users:t.is_admin?"":__C.CLASSES.HIDDEN,subscribed_blocks:__APP.BUILD.subscribers(e.subscribed)},e))),t.init(),t.fetchAndAppendFeed(t.event_types.future),t.fetchAndAppendFeed(t.event_types.past),t.is_admin&&(t.fetchAndAppendFeed(t.event_types.delayed),t.fetchAndAppendFeed(t.event_types.canceled))},t}()),SearchPage=extending(Page,function(){function t(t){Page.apply(this,arguments),this.page_title="Поиск",this.$search_bar_input=$("#search_bar_input"),this.search_string=decodeURIComponent(t),this.events_ajax_data={length:10,fields:new Fields("image_horizontal_medium_url","detail_info_url","nearest_event_date","can_edit","location","is_favorite","is_registered","registration_available","registration_locally","registration_required","registration_till","ticketing_locally","is_free","min_price","favored_users_count","organization_name","organization_short_name","organization_logo_small_url","description","favored","is_same_time","tags","dates"),order_by:"nearest_event_date,-first_event_date"},this.organizations_ajax_data={length:30,fields:new Fields(["subscribed_count","img_small_url"])},this.past_events=!1,this.search_results=new SearchResults(this.search_string)}return t.buildOrganizationItems=function(t){return __APP.BUILD.organizationItems(t,{block_classes:["-show"],avatar_classes:["-size_50x50","-rounded"],counter_classes:[__C.CLASSES.HIDDEN]})},t.buildEventCards=function(t){var e=$();return 0==t.length?e=tmpl("search-no-events",{}):t.forEach(function(t){void 0!=t.nearest_event_date||this.past_events||(e=e.add(tmpl("divider",{title:"Прошедшие события"})),this.past_events=!0),e=e.add(__APP.BUILD.eventCards(t))}),e},t.prototype.fetchData=function(){return this.fetching_data_defer=this.search_results.fetchEventsAndOrganizations(this.events_ajax_data,this.organizations_ajax_data)},t.prototype.init=function(){function e(t){trimAvatarsCollection(t),bindRippleEffect(t),__APP.MODALS.bindCallModal(t),bindPageLinks(t),t.find(".HideEvent").remove()}var i,n=this,a=$(window);i=this.$wrapper.find(".SearchOrganizationsScrollbar").scrollbar({disableBodyScroll:!0,onScroll:function(e){e.scroll==e.maxScroll&&n.search_results.fetchOrganizations(n.organizations_ajax_data,function(e){e.length?i.append(t.buildOrganizationItems(e)):i.off("scroll.onScroll"),bindPageLinks(i)})}}),a.off("scroll.upload"+n.constructor.name),a.on("scroll.upload"+n.constructor.name,function(){a.height()+a.scrollTop()+200>=$(document).height()&&!n.block_scroll&&(n.block_scroll=!0,n.search_results.fetchEvents(n.events_ajax_data,function(i){var o;i.length?(o=t.buildEventCards(n.search_results.events.last_pushed),n.$wrapper.find(".SearchEvents").append(o),e(o),n.block_scroll=!1):a.off("scroll.upload"+n.constructor.name)}))}),e(this.$wrapper)},t.prototype.render=function(){var e={};$(".TopBarOverlay").addClass("-open_search_bar"),this.$search_bar_input.val(this.search_string),e.events=t.buildEventCards(this.search_results.events),0==this.search_results.organizations.length?e.no_organizations=__C.CLASSES.HIDDEN:e.organizations=t.buildOrganizationItems(this.search_results.organizations),this.$wrapper.append(tmpl("search-wrapper",e)),this.init()},t.prototype.destroy=function(){$(".TopBarOverlay").removeClass("-open_search_bar"),this.$search_bar_input.val("")},t}()),UserPage=extending(Page,function(){function t(t){Page.apply(this),this.user_id=t,this.user=new OneUser(t),this.events_metadata={last_date:""},this.disable_uploads={events:!1,activities:!1},this.favored_fetch_data={fields:new Fields("image_horizontal_medium_url","favored","favored_users_count","is_favorite","is_registered","registration_available","registration_locally","ticketing_locally","dates"),order_by:"nearest_event_date,-first_event_date",length:10}}return t.bindEvents=function(t){bindRippleEffect(t),trimAvatarsCollection(t),__APP.MODALS.bindCallModal(t),bindPageLinks(t)},t.prototype.fetchData=function(){return this.user_id!=__APP.USER.id&&"me"!==this.user_id?this.fetching_data_defer=this.user.fetchUser(new Fields("type","is_friend","link","accounts","accounts_links",{friends:{fields:["is_friend"],length:4},favored:this.favored_fetch_data,subscriptions:{fields:["img_small_url"],length:4,order_by:["organization_type_order","organization_type_id"]}})):Page.prototype.fetchData.call(this)},t.prototype.uploadEntities=function(e){var i,n=this,a={activities:{fetch_method:this.user.actions.fetch,fetch_context:this.user.actions,fetch_arguments:[["organization","event","type_code","created_at"],20,"-created_at"],extra_function:function(t){t.forEach(function(t){t.user=n.user})},build_method:__APP.BUILD.activity,build_extra_arguments:[]},events:{fetch_method:this.user.fetchFavored,fetch_context:this.user,fetch_arguments:[this.favored_fetch_data],build_method:__APP.BUILD.eventBlocks,build_extra_arguments:[this.events_metadata]}},o=a[e],s=n.$wrapper.find(".TabsBody").filter('[data-tab_body_type="'+e+'"]');n.disable_uploads[e]||n.block_scroll||(i=__APP.BUILD.loaderBlock(s),n.block_scroll=!0,o.fetch_method.apply(o.fetch_context,o.fetch_arguments).done(function(a){var r;n.block_scroll=!1,i.remove(),a.length?(o.extra_function&&"function"==typeof o.extra_function&&o.extra_function(a),r=o.build_method.apply(__APP.BUILD,[a].concat(o.build_extra_arguments)),s.append(r),t.bindEvents(r)):(s.children().length||s.append(__APP.BUILD.cap("Активности нет")),n.disable_uploads[e]=!0)}))},t.prototype.init=function(){function e(t,e){var i=t.$wrapper.find(".TabsBody").filter("."+__C.CLASSES.ACTIVE).data("tab_body_type"),n=$(window);n.off(Object.values(e).join(" ")),isScrollRemain(1e3)&&t.uploadEntities(i),n.on(e[i],function(){isScrollRemain(1e3)&&t.uploadEntities(i)})}var i=this,n={activities:"scroll.uploadActivities",events:"scroll.uploadEvents"};bindTabs(this.$wrapper),t.bindEvents(this.$wrapper),this.$wrapper.find(".Tabs").on("change.tabs",function(){e(i,n)}),e(this,n)},t.prototype.render=function(){var t,e,i=this;return this.user_id==__APP.USER.id?(__APP.changeState("/my/profile",!0,!0),null):(__APP.changeTitle(this.user.full_name),this.user.actions.forEach(function(t){t.user=i.user}),t=this.user.subscriptions.length?__APP.BUILD.avatarBlocks(this.user.subscriptions.slice(0,4),{is_link:!0,entity:__C.ENTITIES.ORGANIZATION,avatar_classes:[__C.CLASSES.SIZES.X30]}):__APP.BUILD.cap("Нет подписок"),e=this.user.favored.length?__APP.BUILD.eventBlocks(this.user.favored,this.events_metadata):__APP.BUILD.cap("Событий нет"),this.$wrapper.append(tmpl("user-page",{wrapper_classes:"-another_user",tombstone:__APP.BUILD.userTombstones(this.user,{avatar_classes:[__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.UNIVERSAL_STATES.SHADOWED]}),links:__APP.BUILD.socialLinks(this.user.accounts_links,{classes:__C.CLASSES.UNIVERSAL_STATES.ROUNDED}),subscribed_orgs:t,show_all_subscribed_orgs_button:this.user.subscriptions.length?__APP.BUILD.button({classes:[__C.CLASSES.COLORS.NEUTRAL_ACCENT,__C.CLASSES.HOOKS.CALL_MODAL,__C.CLASSES.HOOKS.RIPPLE],dataset:{modal_type:"subscribers_list",modal_entity:this.user},title:"Показать все"}):"",friends_hidden:__C.CLASSES.HIDDEN,favored_event_blocks:e})),this.uploadEntities("activities"),void this.init())},t}()),MyProfilePage=extending(UserPage,function(){function t(){UserPage.call(this,__APP.USER.id),this.page_title="Мой профиль",this.favored_fetch_data.fields.push("is_favorite"),this.user=__APP.USER}return t.prototype.fetchData=function(){return this.user.favored.length?Page.prototype.fetchData.call(this):this.fetching_data_defer=this.user.fetchFavored(this.favored_fetch_data)},t.prototype.render=function(){var t,e,i,n;__APP.changeTitle("Мой профиль"),this.user.actions.forEach(function(t){t.user=__APP.USER}),e=this.user.subscriptions.length?__APP.BUILD.avatarBlocks(this.user.subscriptions.slice(0,4),{is_link:!0,
entity:__C.ENTITIES.ORGANIZATION,avatar_classes:[__C.CLASSES.SIZES.X30]}):__APP.BUILD.cap("Нет подписок"),n=this.user.friends.length?__APP.BUILD.avatarBlocks(this.user.friends.slice(0,4),{is_link:!0,entity:__C.ENTITIES.USER,avatar_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]}):__APP.BUILD.cap("Нет друзей"),i=this.user.favored.length?__APP.BUILD.eventBlocks(this.user.favored,this.events_metadata):__APP.BUILD.cap("Событий нет"),this.$wrapper.append(tmpl("user-page",{wrapper_classes:"-this_user",tombstone:__APP.BUILD.userTombstones(this.user,{avatar_classes:[__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.UNIVERSAL_STATES.SHADOWED]}),links:__APP.BUILD.socialLinks(this.user.accounts_links,{classes:__C.CLASSES.UNIVERSAL_STATES.ROUNDED}),subscribe_button:__APP.BUILD.button({classes:[__C.CLASSES.COLORS.NEUTRAL_ACCENT,__C.CLASSES.HOOKS.RIPPLE,"LogoutButton"],title:"Выйти"}),subscribed_orgs:e,show_all_subscribed_orgs_button:this.user.subscriptions.length?__APP.BUILD.button({classes:[__C.CLASSES.COLORS.NEUTRAL_ACCENT,__C.CLASSES.HOOKS.CALL_MODAL,__C.CLASSES.HOOKS.RIPPLE],dataset:{modal_type:"subscribers_list",modal_entity:this.user},title:"Показать все"}):"",subscribed_users:n,show_all_subscribed_users_button:this.user.friends.length?__APP.BUILD.button({classes:[__C.CLASSES.COLORS.NEUTRAL_ACCENT,__C.CLASSES.HOOKS.CALL_MODAL,__C.CLASSES.HOOKS.RIPPLE],dataset:{modal_type:"friends_list",modal_entity:this.user},title:"Показать все"}):"",favored_event_blocks:i})),this.user.actions.length?(t=__APP.BUILD.activity(this.user.actions),this.$wrapper.find(".TabsBody").filter('[data-tab_body_type="activities"]').append(t),UserPage.bindEvents(t)):this.uploadEntities("activities"),this.$wrapper.find(".LogoutButton").on("click",__APP.USER.logout),this.init()},t}()),MyTicketsPage=extending(Page,function(){function t(){Page.call(this),this.page_title="Мои билеты",this.tickets=new MyTicketsCollection,this.disable_uploads=!1,this.block_scroll=!1,this.fetch_tickets_fields=new Fields("created_at","number","ticket_type","order",{event:{fields:new Fields("dates","is_same_time","image_horizontal_medium_url","location")}}),this.fetch_tickets_quantity=30}return t.prototype.fetchData=function(){return this.fetching_data_defer=this.tickets.fetchTickets(this.fetch_tickets_fields,this.fetch_tickets_quantity)},t.prototype.fetchAndAppendTickets=function(){var t,e=this;e.disable_uploads||e.block_scroll||(t=__APP.BUILD.loaderBlock(e.$wrapper),e.block_scroll=!0,e.tickets.fetchTickets(e.fetch_tickets_fields,e.fetch_tickets_quantity).done(function(i){e.block_scroll=!1,i.length?e.$wrapper.find(".TicketsWrapper").append(__APP.BUILD.ticketCards(i)):e.disable_uploads=!0,t.remove()}))},t.prototype.init=function(){var t=this;bindCallModal(this.$wrapper),isScrollRemain(1e3)&&t.fetchAndAppendTickets(),$(window).on("scroll.uploadTickets",function(){isScrollRemain(1e3)&&t.fetchAndAppendTickets()})},t.prototype.render=function(){return __APP.USER.isLoggedOut()?(__APP.changeState("/",!0,!0),null):(this.$wrapper.html(tmpl("my-tickets-wrapper",{tickets:__APP.BUILD.ticketCards(this.tickets)})),void this.init())},t}()),ServerConnection=function(){function t(){return"object"==typeof t.instance?t.instance:(this.current_connections=[],void(t.instance=this))}function e(t,e,i){i="undefined"!=typeof i?i:function(){console.log(t),showNotifier({text:"Упс, что-то пошло не так",status:!1})},e="function"!=typeof e?function(){}:e;try{t.status?e(t.data,t.text):i(t)}catch(t){i(t)}}return t.HTTP_METHODS={GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE"},Object.freeze(t.HTTP_METHODS),t.ajaxErrorHandler=function(t,e,i,n){var a,o=Array.prototype.slice.call(arguments),s={};4==o.length?(a=["event","jqxhr","settings","thrownError"],o.forEach(function(t,e){s[a[e]]=t})):1==o.length?s=o[0]:o.forEach(function(t,e){s[e]=t}),console.groupCollapsed("AJAX error"),s.thrownError&&console.log("Thrown error:",s.thrownError),s.event&&s.event.type&&console.log("Error type:",s.event.type),s.event&&s.event.text&&console.log("Description:",s.event.text),s.jqxhr&&s.jqxhr.responseJSON&&s.jqxhr.responseJSON.text&&(console.log("Response:",s.jqxhr.responseJSON.text),showNotifier({text:s.jqxhr.responseJSON.text,status:!1})),s.settings&&(console.log("URL:",s.settings.url),console.log("Method:",s.settings.type)),s.stack?(console.log("Thrown error:",s.name),console.log("Description:",s.message),console.log("Error stacktrace:",s.stack)):console.error("Error stacktrace:"),console.groupEnd(),window.errors_array||(window.errors_array=[]),window.errors_array.push(s)},t.prototype.dealAjax=function(i,n,a,o,s,r){a=a||{};var c;return a.fields instanceof Fields&&(a.fields=a.fields.toString()),c=$.ajax({url:n,data:a,method:i,contentType:o||"application/x-www-form-urlencoded; charset=UTF-8"}),this.current_connections.push(c),c.fail(r).then(function(i,n,a){return e(i,function(t,e){isFunction(s)&&s(t)},t.ajaxErrorHandler),i.data}).promise()},t.prototype.multipleAjax=function(){var t,e=arguments[arguments.length-1]instanceof Function,i=e?Array.prototype.splice.call(arguments,0,arguments.length-1):Array.prototype.slice.call(arguments);return t=$.when.apply($,i),e&&t.done(Array.prototype.shift.call(arguments)),t.promise()},t.prototype.getData=function(e,i,n,a){return this.dealAjax(t.HTTP_METHODS.GET,e,this.validateData(i),"application/json",function(t){void 0!=i.length&&void 0!=i.offset&&(i.offset+=i.length),n&&"function"==typeof n&&n(t)},a)},t.prototype.updateData=function(e,i,n,a,o){return n?this.dealAjax(t.HTTP_METHODS.PUT,e,JSON.stringify(i),"application/json",a,o):this.dealAjax(t.HTTP_METHODS.PUT,e,i,"application/x-www-form-urlencoded; charset=UTF-8",a,o)},t.prototype.addData=function(e,i,n,a,o){return n?this.dealAjax(t.HTTP_METHODS.POST,e,JSON.stringify(i),"application/json",a,o):this.dealAjax(t.HTTP_METHODS.POST,e,i,"application/x-www-form-urlencoded; charset=UTF-8",a,o)},t.prototype.deleteData=function(e,i,n,a){return this.dealAjax(t.HTTP_METHODS.DELETE,e+"?"+$.param(i),{},"application/json",n,a)},t.prototype.validateData=function(t){t=t||{};var e=[];return t.order_by&&(e="string"==typeof t.order_by?t.order_by.split(","):t.order_by,e=e.map(function(t){return t.trim().replace("-","")}),t.order_by instanceof Array&&(t.order_by=t.order_by.join(","))),t.fields?t.fields instanceof Array?t.fields=t.fields.merge(e):t.fields instanceof Fields&&e.length&&e.forEach(function(e){t.fields.add(e)}):t.fields=e,t.fields=(t.fields=t.fields.toString())?t.fields:void 0,t},t.prototype.abortAllConnections=function(){for(var t;this.current_connections.length;)t=this.current_connections.pop(),200===t.state&&"pending"!==t.state()||t.abort()},t}(),__APP={SERVER:new ServerConnection,EVENDATE_BEGIN:"15-12-2015",AUTH_URLS:{},TOP_BAR:new AbstractTopBar,SIDEBAR:new AbstractSidebar,USER:new CurrentUser,PREVIOUS_PAGE:new Page,CURRENT_PAGE:new Page,ROUTING:{admin:{organization:{"^([0-9]+)":{add:{event:AddEventPage,"":AddEventPage},edit:AdminOrganizationEditPage,overview:AdminOrganizationOverviewPage,events:AdminOrganizationEventsPage,crm:AdminOrganizationCRMPage,settings:AdminOrganizationSettingsPage,"":AdminOrganizationOverviewPage}},event:{"^([0-9]+)":{overview:AdminEventOverviewPage,orders:AdminEventOrdersPage,check_in:AdminEventCheckInPage,edit:AdminEventEditPage,"":AdminEventOverviewPage}},"":AdminOrganizationsPage},add:{event:{to:{"^([0-9]+)":AddEventPage,"":AddEventPage},"":AddEventPage},organization:AddOrganizationPage},my:{tickets:MyTicketsPage,profile:MyProfilePage,"":MyProfilePage},event:{add_to:{"^([0-9]+)":AddEventPage,"":AddEventPage},add:{to:{"^([0-9]+)":AddEventPage,"":AddEventPage},"":AddEventPage},"^([0-9]+)":{edit:EditEventPage,"":EventPage},"":FeedPage},feed:{actual:ActualEventsPage,timeline:TimelineEventsPage,favored:FavoredEventsPage,recommendations:RecommendedEventsPage,friends:FriendsEventsPage,day:{"^([0-9]{4}-[0-9]{2}-[0-9]{2})":DayEventsPage},"":ActualEventsPage},organizations:{at:{"^([0-9]+)":CatalogPage,"^([^/]+)":{"^([0-9]+)":CatalogPage,"":CatalogPage}},"^([0-9]+)":CatalogPage,"":CatalogPage},organization:{add:AddOrganizationPage,"^([0-9]+)":{edit:EditOrganizationPage,"":OrganizationPage},"":CatalogPage},onboarding:OnboardingPage,search:{"^([^/]+)":SearchPage},friends:MyProfilePage,friend:{"^([0-9]+)":UserPage,"":MyProfilePage},user:{me:MyProfilePage,"^([0-9]+)":UserPage,"":MyProfilePage},"":ActualEventsPage},MODALS:new Modals,BUILD:new Builder,renderHeaderTabs:function(t){var e=$("#main_header_bottom").find(".HeaderTabsWrapper");t=t instanceof Array?t:[t],t.forEach(function(t){t=Builder.normalizeBuildProps(t),t.classes.push("tab","Tab"),window.location.pathname.contains(t.page)&&t.classes.push(__C.CLASSES.ACTIVE)}),e.html(tmpl("tabs-header",{color:"default",tabs:tmpl("link",t)})),bindTabs(e),bindPageLinks(e)},changeTitle:function(t){var e,i=$();switch("string"==typeof t&&(e=t,t=t.split(" > ")),!0){case t instanceof Array:t.forEach(function(e,n){n&&(i=i.add('<span class="title_chunk fa_icon fa-angle-right -empty"></span>')),"object"==typeof e?(e.toString=Array.isArray(e)?Array.toSpaceSeparatedString:Object.toHtmlDataSet,i=i.add('<a href="'+e.page+'" class="title_chunk link Link">'+e.title+"</a>"),t[n]=e.title):i=i.add('<span class="title_chunk">'+e+"</span>")}),e||(e=t.join(" > "));break;case t instanceof jQuery:i=t,t.each(function(){this.text()&&(e+=this.text()+" ")})}bindPageLinks($("#page_title").html(i)),$("title").text(e?e:"Evendate")},changeState:function(t,e,i){return History.stateChangeHandled=!0,t?(t=0===t.indexOf("/")?t:"/"+t,e?History.replaceState({_index:History.getCurrentIndex()},"",t):History.pushState({_index:History.getCurrentIndex()},"",t),(!e||e&&i)&&__APP.reInit()):console.error("Need to pass page name"),History.stateChangeHandled=!1,!1},reload:function(){return __APP.changeState(location.pathname,!0,!0)},init:function(){var t=$(".SidebarNavItem"),e=window.location.pathname;__APP.CURRENT_PAGE=Page.routeNewPage(e),__APP.CURRENT_PAGE.fetchData(),__APP.CURRENT_PAGE.show(),t.removeClass(__C.CLASSES.ACTIVE).filter(function(){return 0===e.indexOf(this.getAttribute("href"))}).addClass(__C.CLASSES.ACTIVE)},reInit:function(){$(window).off("scroll"),AbstractAppInspector.hideCurrent(),__APP.SERVER.abortAllConnections(),__APP.PREVIOUS_PAGE=__APP.CURRENT_PAGE,__APP.PREVIOUS_PAGE.destroy(),__APP.init()}},__ERRORS=[],__LOCALES={ru_RU:{TEXTS:{BUTTON:{REMOVE_FAVORITE:"Убрать",ADD_FAVORITE:"В избранное",FAVORED:"В избранном",ADD_SUBSCRIPTION:"Подписаться",REMOVE_SUBSCRIPTION:"Отписаться",SUBSCRIBED:"Подписан",EDIT:"Изменить"},SUBSCRIBERS:{NOM:" подписчик",GEN:" подписчика",PLU:" подписчиков"},PEOPLE:{NOM:" человек",GEN:" человека",PLU:" человек"},FAVORED:{NOM:" участник",GEN:" участника",PLU:" участников"},ACTIVITY:{SUBSCRIBE:{MAS:"подписался на организацию",FEM:"подписалась на организацию",NEU:"подписалось на организацию"},UNSUBSCRIBE:{MAS:"отписался от организации",FEM:"отписалась от организации",NEU:"отписалось от организации"},FAVE:{MAS:"добавил в избранное событие",FEM:"добавила в избранное событие",NEU:"добавило в избранное событие"},UNFAVE:{MAS:"удалил из избранного событие",FEM:"удалила из избранного событие",NEU:"удалило из избранного событие"},SHARE:{MAS:"поделился событием",FEM:"поделилась событием",NEU:"поделилось событием"}},TICKET_STATUSES:{USED:"Билет использован",WAITING_FOR_PAYMENT:"Ожидает оплаты",IS_PENDING:"Ожидает подтверждения",APPROVED:"Подтверждено",PAYED:"Оплачено",WITHOUT_PAYMENT:"Без оплаты",TICKETS_ARE_OVER:"Билеты закончились",RETURNED_BY_ORGANIZATION:"Возврат билета организатором",PAYMENT_CANCELED_AUTO:"Отмена транзакции",PAYMENT_CANCELED_BY_CLIENT:"Отменено клиентом",RETURNED_BY_CLIENT:"Возврат билета",REJECTED:"Отклонено"}},DATE:{DATE_FORMAT:"DD.MM.YYYY",TIME_FORMAT:"HH:mm",DATE_TIME_FORMAT:"DD.MM.YYYY HH:mm",MONTH_SHORT_NAMES:["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"],MONTH_NAMES:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],CALENDAR_DATE_TIME:{sameDay:"[Сегодня в] HH:mm",lastDay:"[Вчера в] HH:mm",nextWeek:"D MMMM [в] HH:mm",lastWeek:"D MMMM [в] HH:mm",sameElse:"D MMMM [в] HH:mm"}},DATATABLES_URL:"//cdn.datatables.net/plug-ins/1.10.15/i18n/Russian.json"}},__LOCALE=__LOCALES.ru_RU,Object.seal(__APP),Object.freeze(__APP.SERVER),Object.freeze(__APP.ROUTING),Object.freeze(__APP.BUILD),Object.freeze(__C),Object.freeze(__LOCALES),window.paceOptions={ajax:!1,document:!1,eventLag:!1,elements:{},search_is_active:!1,search_query:null,search_xhr:null},__stats=[],askToSubscribe=null,checkRedirect()&&$(document).ajaxStart(function(){Pace.restart()}).ajaxError(function(t,e,i,n){n&&"Forbidden"===n?__APP.changeState("/",!0,!0):n&&"abort"===n||ServerConnection.ajaxErrorHandler(t,e,i,n)}).ready(function(){var t,e,i,n=window.OneSignal||[];n.push(["init",{appId:"7471a586-01f3-4eef-b989-c809700a8658",autoRegister:!1,notifyButton:{enable:!1}}]),n.push(function(){n.isPushNotificationsSupported()&&n.isPushNotificationsEnabled(function(t){t||(window.askToSubscribe=function(){n.push(function(){n.on("subscriptionChange",function(t){t&&n.getUserId(function(t){$.ajax({url:"api/v1/users/me/devices",type:"PUT",data:{device_token:t,client_type:"browser",model:navigator.appVersion?navigator.appVersion:null,os_version:navigator.platform?navigator.platform:null},global:!1})})})}),n.push(["registerForPushNotifications"]),event.preventDefault()})})}),void 0!==window.moment&&(moment.locale(navigator.language),moment.updateLocale("ru",{monthsShort:__LOCALES.ru_RU.DATE.MONTH_SHORT_NAMES,calendar:{sameDay:"[Сегодня]",nextDay:"[Завтра]",lastDay:"[Вчера]",nextWeek:"D MMMM",lastWeek:"D MMMM",sameElse:"D MMMM"}})),void 0!==window.Highcharts&&Highcharts.setOptions({lang:{shortMonths:__LOCALES.ru_RU.DATE.MONTH_SHORT_NAMES}}),History.Adapter.bind(window,"statechange",function(){History.stateChangeHandled||__APP.reInit()}),isNotDesktop()&&($(".DownloadAppBand").addClass("-open_band"),$(".CloseDownloadAppBand").one("click",function(){$(".DownloadAppBand").removeClass("-open_band")})),t=__APP.USER.fetchUser(new Fields("email","accounts","accounts_links",{friends:{fields:["is_friend"],length:4},subscriptions:{fields:["img_small_url","subscribed_count","new_events_count","actual_events_count"]}})),e=__APP.SERVER.getData("/auth.php",{action:"get_urls",mobile:isNotDesktop()}),i=(new CitiesCollection).fetchCities(new Fields("timediff_seconds","distance"),1,"distance"),__APP.SERVER.multipleAjax(t,e,i,function(t,e,i){__APP.USER.selected_city.setData(i[0]),__APP.AUTH_URLS=e,checkRedirect(),__APP.USER.isLoggedOut()?(__APP.TOP_BAR=new TopBarNoAuth,__APP.SIDEBAR=new SidebarNoAuth):(__APP.TOP_BAR=new TopBar,__APP.SIDEBAR=new Sidebar),__APP.TOP_BAR.init(),__APP.SIDEBAR.init(),__APP.init(),bindPageLinks()}),setInterval(function(){if(0!=window.__stats.length){var t=window.__stats;window.__stats=[],$.ajax({url:"/api/v1/statistics/batch",data:JSON.stringify(t),type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",error:function(){window.__stats.concat(t)}})}},5e3)});