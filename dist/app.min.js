function extending(t,e){return e.prototype=$.extend(Object.create(t.prototype),e.prototype),e.prototype.constructor=e,Object.defineProperty(e.prototype,"__super",{value:t}),e.prototype.uber=function(n,i){var a;return a=e.prototype[n],a==this[n]&&(a=t.prototype[n]),a.apply(this,Array.prototype.slice.apply(arguments,[1]))},e}function extendingJQuery(t){return t=extending(jQuery,t),t.prototype.pushStack=function(t){var e=jQuery.merge(this.get(0)==t?new this.constructor:$(),t);return e.prevObject=this,e.context=this.context,e},t}function tmpl(t,e,n,i){function a(t){return String(t+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function o(t,e){var n={},i={},o=l[(/<([\w:]+)/.exec(t)||["",""])[1].toLowerCase()]||l._default,s=o[0];for($.each(e,function(t,e){"string"==$.type(e)?i[t]=a(e):e instanceof jQuery?e.length&&(n[t]=e,e.is("tr")?i[t]='<tbody id="JQ_tmpl_'+t+'"></tbody>':e.is("span")?i[t]='<span id="JQ_tmpl_'+t+'"></span>':e.is("option")?i[t]='<optgroup id="JQ_tmpl_'+t+'"></optgroup>':i[t]='<div id="JQ_tmpl_'+t+'"></div>'):null==e?i[t]="":i[t]=e}),t=$(t?o[1]+t.format(i)+o[2]:""),$.each(n,function(e,n){t.find("#JQ_tmpl_"+e).append(n),n.is("tr")?n.parent("tbody").removeAttr("id"):n.unwrap()});s--;)t=t.children();return t}e=e?e:{};var s,r=$("#tmpl-"+t),l={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[1,"<div>","</div>"]},c=$();return l.tbody=l.tfoot=l.colgroup=l.caption=l.thead,l.th=l.td,r.length?(s=r.html().replace(/(?:\/\*(?:[\s\S]*?)\*\/)|(?:([\s;])+\/\/(?:.*)$)/gim,"").replace(/\\s{2,}|\t|\n|\r/gim,"").trim(),c=Array.isArray(e)?$.makeSet(e.map(function(t){return o(s,t)})):o(s,e),null==n||void 0==n?c:("prepend"==i?n.prepend(c):n.append(c),c)):(console.group("tmpl_error"),console.log("error in "+t),console.log("items",e),console.log("addTo",n),console.log("inputs",{template_type:t,items:e,addTo:n,direction:i}),console.groupEnd(),$())}function storeStat(t,e,n){window.__stats=window.__stats?window.__stats:[],window.__stats.push({entity_id:t,entity_type:e,event_type:n})}function getUnitsText(t,e){t=Math.abs(t);var n="";return n=t.toString().indexOf(".")>-1?e.GEN:t%10==1&&t%100!=11?e.NOM:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?e.GEN:e.PLU}function getGenderText(t,e){if("string"==typeof e)return e;switch(t){default:case OneUser.GENDER.MALE:return e.MAS;case OneUser.GENDER.FEMALE:return e.FEM;case OneUser.GENDER.NEUTRAL:return e.NEU}}function formatDates(t,e,n){function i(t,e,n,i,a){var o,s=["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"],r={d:e,D:e,t:n,T:n,M:i+1,MM:i+1>9?i+1:"0"+(i+1),MMM:__LOCALES.ru_RU.DATE.MONTH_SHORT_NAMES[i].toLocaleLowerCase(),MMMM:__LOCALES.ru_RU.DATE.MONTH_NAMES[i].toLocaleLowerCase(),MMMMs:s[i],Y:a,YY:a.substr(2,2),YYYY:a};return"string"==typeof t?o=t.format(r).capitalize():Array.isArray(t)?o=t.map(function(t){return t.format(r).capitalize()}):t instanceof jQuery?(o=$(),t.each(function(t,e){var n=$(e).clone();n.text(e.innerText.format(r).capitalize()),o=o.add(n)})):(o={},$.each(t,function(t,e){o[t]=e.format(r).capitalize()})),o}var a,o,s,r,l,c,d=!1,_=[],u=t.length-1,f={},h=[];return e||(e={date:"{D} {MMMMs} {YYYY}",time:"{T}"}),"string"==typeof e?d=e.contains(/\{T\}|\{t\}/)&&void 0!==t[0].start_time:(d=void 0!==t[0].start_time,$.each(e,function(){d=d||this.contains(/\{T\}|\{t\}/)})),n?(d&&(l=t[0].end_time?displayTimeRange(t[0].start_time,t[0].end_time):displayTimeRange(t[0].start_time)),t.forEach(function(t,e){a=moment.unix(t.event_date),s=a.year(),r=a.month(),f[s]||(f[s]={}),f[s][r]||(f[s][r]=[]),o?r!==o.month()||o.diff(a,"days")!==-1?(f[o.year()][o.month()].push(_.join("-")),_[0]=a.format("D")):_[1]=a.format("D"):_[0]=a.format("D"),e===u?f[s][r].push(_.join("-")):o=a}),$.each(f,function(t,n){$.each(n,function(n,a){h.push(i(e,a.join(", "),d?l:"",n,t))})})):(t.forEach(function(t,e){a=moment.unix(t.event_date),s=a.year(),r=a.month(),l=t.end_time?displayTimeRange(t.start_time,t.end_time):displayTimeRange(t.start_time),f[s]||(f[s]={}),f[s][r]||(f[s][r]=[]),o?r!==o.month()||o.diff(a,"days")!==-1||c!==l?(f[o.year()][o.month()].push({date:_.join("-"),time:c}),_=[a.format("D")]):_[1]=a.format("D"):_=[a.format("D")],e===u?f[s][r].push({date:_.join("-"),time:l}):(o=a,c=l)}),$.each(f,function(t,n){$.each(n,function(n,a){var o,s=[],r=[];$.each(a,function(t,e){o?e.time!=o?(s.push({date:r.join(", "),time:o}),r=[e.date]):r.push(e.date):r=[e.date],t===a.length-1?s.push({date:r.join(", "),time:e.time}):o=e.time}),$.each(s,function(a,o){h.push(i(e,o.date,d?o.time:"",n,t))})})})),h}function trimSeconds(t){return t=t.split(":"),3==t.length&&(t=t.splice(0,2)),t.join(":")}function displayDateRange(t,e){var n=moment.unix(t),i=moment.unix(e),a=moment();return n.isSame(i,"year")?n.isSame(i,"month")?n.isSame(i,"day")?n.format(n.isSame(a,"year")?"D MMM":"D MMM YYYY"):n.format("D")+"-"+i.format(n.isSame(a,"year")?"D MMM":"D MMM YYYY"):n.format("D MMM")+" - "+i.format(n.isSame(a,"year")?"D MMM":"D MMM YYYY"):n.format("MMM YYYY")+" - "+i.format("MMM YYYY")}function displayTimeRange(t,e){return e?e!=t||"00:00:00"!=t&&"00:00"!=t?trimSeconds(t)+" - "+trimSeconds(e):"Весь день":trimSeconds(t)}function formatCurrency(t,e,n,i,a){t=+t||0,e=e||" ",n=n||".";var o=(""+t).split(".")[1],s=t<0?"-":"",r=parseInt(Math.abs(t),10)+"",l=r.length>3?r.length%3:0;return""+(i?i+e:"")+s+(l?r.substr(0,l)+e:"")+r.substr(l).replace(/(\d{3})(?=\d)/g,"$1"+e)+(o?n+o:"")+(a?e+a:"")}function formatTicketNumber(t){return(""+t).replace(/(\d{3})/g,"$1 ").trim()}function guid(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}function isFormValid(t){t=t instanceof Element?$(t):t;var e=!0,n=t.find("input, textarea");return t[0].checkValidity()||n.each(function(t,n){(n.required&&(""===n.value.trim()||!n.checkValidity())||""!==n.value.trim()&&!n.checkValidity())&&(handleErrorField(n),e=!1)}),e}function getFilenameFromURL(t){return t.split("\\").pop().split("/").pop()}function isBase64(t){return t.contains(";base64,")}function outerAjax(t,e,n){e=e||{};var i;return e.fields instanceof Fields&&(e.fields=e.fields.toString()),i=$.ajax({url:t,data:e,method:"GET",contentType:n||"application/x-www-form-urlencoded; charset=UTF-8"}),i.then(function(t,e,n){return t}).promise()}function bindLimitInputSize(t){t=t?t:$("body"),t.find(".LimitSize").not(".-Handled_LimitSize").each(function(t,e){var n=$(e),i=n.closest(".form_unit"),a=n.data("maxlength"),o=n.siblings(".form_prompt");o.length?o.text(n.val().length+"/"+a):(n.after($("<p>").addClass("form_prompt").text(n.val().length+"/"+a)),o=n.siblings(".form_prompt")),n.on("input",function(){var t=n.val().length;if(n.is("textarea")){var e=n.val().match(/\n/g);t=e?t+e.length:t}t>a?i.addClass("-status_error"):i.hasClass("-status_error")&&i.removeClass("-status_error"),o.text(t+"/"+a)})}).addClass("-Handled_LimitSize")}function initSelect2(t,e){var n={containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"};t.hasClass("-Handled_ToSelect2")&&t.select2("destroy"),e&&$.extend(!0,n,e),t.select2(n).addClass("-Handled_ToSelect2")}function initTimeInput(t){function e(){var t=$(this);"0"==t.val()||""===t.val()?t.val("00"):t.val()<=9&&t.val("0"+parseInt(t.val()))}var n=$(t),i=n.find("input").eq(0),a=n.find("input").eq(1);i.inputmask("Regex",{regex:"([01]?[0-9]|2[0-3])"}).on("keyup",function(){(i.val()>2||"00"==i.val())&&(a.focus(),i.trigger("blur"))}).on("blur",e),a.inputmask("Regex",{regex:"[0-5][0-9]"}).on("blur",e),n.addClass("-Handled_TimeInput")}function trimAvatarsCollection(t){t=t?t:$("body"),t.find(".AvatarsCollection").each(function(){var t=$(this),e=t.find(".avatar"),n=e.length;(t.hasClass("-subscribed")||t.hasClass("-shifted"))&&n<t.data("max_amount")?t.width(1==n?e.outerWidth()*n:e.outerWidth()*n-6*(n-1)):t.width(1==n?0:e.outerWidth()*(n-1)-6*(n-2)),t.addClass("-trimmed")})}function bindDatePickers(t){t=t?t:$("body"),t.find(".DatePicker").not(".-Handled_DatePicker").each(function(t,e){new DatePicker(e,$(e).data()).init()}).addClass("-Handled_DatePicker")}function bindTimeInput(t){t=t?t:$("body"),t.find(".TimeInput").not(".-Handled_TimeInput").each(function(t,e){initTimeInput(e)}).addClass("-Handled_TimeInput")}function bindTabs(t){t=t?t:$("body"),t.find(".Tabs").not(".-Handled_Tabs").each(function(t,e){var n,i,a,o,s=$(e),r=s.data("tabs_id"),l=!!s.data("focus_on_change"),c=new MutationObserver(function(t){var e,n;t.forEach(function(t){n=$(t.target),e=n.parents(".TabsBody"),e=n.hasClass("TabsBody")?e.add(n):e,e.each(function(t,e){var n=$(e);n.hasClass(__C.CLASSES.ACTIVE)&&(s.addClass("-in_progress"),n.parent().height(n.outerHeight()))})})});r?(n=s.find('.TabsBodyWrapper[data-tabs_id="'+r+'"]'),i=n.children(".TabsBody"),a=s.find('.HeaderTabs[data-tabs_id="'+r+'"]'),o=a.children(".Tab")):(n=s.find(".TabsBodyWrapper:first"),i=n.children(".TabsBody"),a=s.find(".HeaderTabs:first"),o=a.children(".Tab")),Object.defineProperties(s,{currentTabsIndex:{get:function(){return o.index(o.filter("."+__C.CLASSES.ACTIVE))}},tabsCount:{get:function(){return o.length}}}),s.setToTab=function(t){var e=o.eq(t),n=i.eq(t);e.length&&!e.hasClass(__C.CLASSES.ACTIVE)&&(o.removeClass(__C.CLASSES.ACTIVE),i.removeClass(__C.CLASSES.ACTIVE),e.addClass(__C.CLASSES.ACTIVE),n.addClass(__C.CLASSES.ACTIVE),s.trigger("change.tabs"),l&&scrollTo(n,400))},s.nextTab=function(){s.setToTab(s.currentTabsIndex+1)},s.prevTab=function(){s.setToTab(s.currentTabsIndex-1)},o.filter("."+__C.CLASSES.ACTIVE).length||o.eq(0).addClass(__C.CLASSES.ACTIVE),i.removeClass(__C.CLASSES.ACTIVE).eq(s.currentTabsIndex).addClass(__C.CLASSES.ACTIVE),n.height(i.filter("."+__C.CLASSES.ACTIVE).outerHeight()),n.on("transitionend webkitTransitionEnd",function(){s.removeClass("-in_progress"),s.trigger("progress_end")}),i.each(function(t,e){c.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]})}),o.on("click",function(){s.setToTab(o.index(this))}),s.data("instance",s)}).addClass("-Handled_Tabs")}function bindShareButtons(t){t=t?t:$("body"),t.find(".ShareButton").not(".-Handled_ShareButton").each(function(t,e){var n=$(e);n.on("click",function(){window.open(n.data("href"),n.data("title"),"width=600,height=440,resizable=yes,scrollbars=no,status=no")})}).addClass("-Handled_ShareButton")}function bindSelect2(t){t=t?t:$("body"),t.find(".ToSelect2").not(".-Handled_ToSelect2").each(function(t,e){initSelect2($(e))}).addClass("-Handled_ToSelect2")}function bindRippleEffect(t){t=t?t:$("body"),t.find(".RippleEffect").not(".-Handled_RippleEffect").on("click.RippleEffect",function(t){var e,n,i,a,o=$(this);0==o.children(".Ripple").length&&o.prepend('<span class="ripple Ripple"></span>'),e=o.children(".Ripple"),e.removeClass("animate"),e.height()||e.width()||(n=Math.max(o.outerWidth(),o.outerHeight()),e.css({height:n,width:n})),i=t.pageX-o.offset().left-e.width()/2,a=t.pageY-o.offset().top-e.height()/2,e.css({top:a+"px",left:i+"px"}).addClass("animate"),setTimeout(function(){e.removeClass("animate")},650)}).addClass("-Handled_RippleEffect")}function bindDropdown(t){t=t?t:$("body"),t.find(".DropdownButton").not(".-Handled_DropdownButton").each(function(){var t=$(this),e=t.data(),n=$(".DropdownBox").filter('[data-dropdown_id="'+e.dropdown+'"]');if(n.data($.extend({},n.data(),e)),n.closeDropbox=function(){$("body").off("mousedown.CloseDropdown"),$(document).off("keyup.CloseDropdown"),n.removeClass("-show"),t.addClass("-dropdown_active")},e.hasOwnProperty("ddWidth")&&("self"==e.ddWidth?n.width(t.outerWidth()):(isFinite(e.ddWidth)||0===e.ddWidth.search(/^[1-9]\d*%$|^0%$/))&&n.width(e.ddWidth)),e.hasOwnProperty("ddPosX")||e.hasOwnProperty("ddPosY")){var i=t.position();if(e.hasOwnProperty("ddPosX")){var a;"self.center"==e.ddPosX?a=i.left+t.outerWidth()/2-n.outerWidth()/2:"center"==e.ddPosX?a=n.parent().outerWidth()/2-n.outerWidth()/2:isFinite(e.ddPosX)&&(a=e.ddPosX),n.css("left",a)}if(e.hasOwnProperty("ddPosY")){var o;"self.center"==e.ddPosY?o=i.top+t.outerHeight()/2-n.outerHeight()/2:"center"==e.ddPosY?o=n.parent().outerHeight()/2-n.outerHeight()/2:isFinite(e.ddPosY)&&(o=i.top+t.outerHeight()+e.ddPosY),n.css("top",o)}}n.find(".CloseDropdown").on("click.CloseDropdown",n.closeDropbox),t.on("click.Dropdown",function(){n.addClass("-show"),t.addClass("-dropdown_active"),$("body").on("mousedown.CloseDropdown",function(t){$(t.target).closest(".DropdownBox").length||n.closeDropbox()}),$(document).on("keyup.CloseDropdown",function(t){27==t.keyCode&&n.closeDropbox()})})}).addClass("-Handled_DropdownButton")}function bindFileLoadButton(t){t=t?t:$("body"),t.find(".FileLoadButton").not(".-Handled_FileLoadButton").click(function(t){var e=$(this);e.children("input").get(0).click()}).addClass("-Handled_FileLoadButton")}function bindCollapsing(t){t=t?t:$("body"),t.find(".Collapsing").not(".-Handled_Collapsing").each(function(){function t(){i.addClass("-in_progress"),r.hasClass(__C.CLASSES.ACTIVE)?i.height(n):i.height(a.outerHeight()),i.toggleClass("-opened"),r.toggleClass(__C.CLASSES.ACTIVE)}function e(){"change"===s&&o.prop("checked",!o.prop("checked"))}var n,i,a,o,s,r=$(this),l=r.data("collapsing_id"),c=new MutationObserver(function(t){var e,n;t.forEach(function(t){n=$(t.target),e=n.parents(".CollapsingContent"),e=n.hasClass("CollapsingContent")?e.add(n):e,e.each(function(t,e){var n=$(e),i=n.parent();i.hasClass("-opened")&&i.addClass("-in_progress").height(n.outerHeight())})})});l?(i=r.find('.CollapsingWrapper[data-collapsing_id="'+l+'"]'),o=r.find('.CollapsingTrigger[data-collapsing_id="'+l+'"]')):(i=r.find(".CollapsingWrapper:first"),o=r.find(".CollapsingTrigger:first")),a=i.children(".CollapsingContent"),s=o.is(":checkbox")||o.is(":radio")?"change":"click",i.hasClass("-fading")?(n=r.data("defaultHeight")<a.height()?r.data("defaultHeight"):a.height(),!r.hasClass(__C.CLASSES.ACTIVE)&&i.height()<n&&i.height(n)):n=r.data("defaultHeight")?r.data("defaultHeight"):0,r.openCollapsing=function(){r.hasClass(__C.CLASSES.ACTIVE)||(e(),t())},r.closeCollapsing=function(){r.hasClass(__C.CLASSES.ACTIVE)&&(e(),t())},o.on(s+".toggleCollapsing",function(){t()}),i.on("click",function(){r.openCollapsing()}).on("transitionend webkitTransitionEnd",function(){i.removeClass("-in_progress")}),c.observe(i.get(0),{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]}),r.data("instance",r)}).addClass("Handled_Collapsing")}function bindControlSwitch(t){t=t?t:$("body"),t.find(".Switch").not(".-Handled_Switch").each(function(e,n){var i=$(n),a=i.data("switch_id"),o=t.find('.Switching[data-switch_id="'+a+'"]');i.on("change.Switch",function(){o.is("fieldset")?o.prop("disabled",!o.prop("disabled")):o.toggleStatus("disabled")})}).addClass("-Handled_Switch")}function bindCallModal(t){return t=t?t:$("body"),t.find("."+__C.CLASSES.HOOKS.CALL_MODAL).not("."+__C.CLASSES.HOOKS.HANDLED+__C.CLASSES.HOOKS.CALL_MODAL).each(function(){var t=$(this);t.on("click.CallModal",function(){var t=$(this),e=t.data(),n=e.modal_title,i=e.modal,a=e.modal_type;if(!i){switch(a){case __C.MODAL_TYPES.FAVORS:i=new FavoredModal(e.modal_event_id,n);break;case __C.MODAL_TYPES.SUBSCRIBERS:i=new SubscribersModal(e.modal_organization_id,n);break;case __C.MODAL_TYPES.EDITORS:i=new EditorsModal(e.modal_organization_id,n,e.modal_specific_role);break;case __C.MODAL_TYPES.MAP:i=new MapModal(e.modal_map_location,n);break;case __C.MODAL_TYPES.MEDIA:var o=e.modal_media_type,s=e.modal_media_url;if(!s)if(t.is("img"))s=t.attr("src"),o="image";else if(t.is("video"))o="video";else{var r=t.css("background-image");"none"!==r&&(s=r.indexOf('"')!=-1?r.slice(r.indexOf('"')+1,r.indexOf('"',r.indexOf('"')+1)):r.slice(r.indexOf("(")+1,r.indexOf(")")),o="image")}i=new MediaModal(s,o);break;case __C.MODAL_TYPES.CROPPER:i=new CropperModal(e.source_img,e);break;case __C.MODAL_TYPES.FRIENDS_LIST:i=new FriendsListModal(e.modal_entity);break;case __C.MODAL_TYPES.SUBSCRIBERS_LIST:i=new SubscriptionsListModal(e.modal_entity);break;case __C.MODAL_TYPES.TICKET:i=new TicketsModal(e.tickets||e.ticket_uuid);break;case __C.MODAL_TYPES.ADD_STAFF:i=new AddStaffModal(e.modal_org_id,e.modal_role);break;default:i=new StdModal(n,e.modal_content,e.modal_style)}t.data("modal",i)}i.show()})}).addClass(__C.CLASSES.HOOKS.HANDLED+__C.CLASSES.HOOKS.CALL_MODAL)}function bindPageLinks(t){t=t?t:$("body"),t.find(".Link").not(".-Handled_Link").on("click.pageRender",function(t){var e=$(this);return!e.hasClass(__C.CLASSES.DISABLED)&&void(1==t.which&&(t.preventDefault(),__APP.changeState(e.attr("href"))))}).addClass("-Handled_Link")}function handleErrorField(t){var e;return t instanceof jQuery?t.is(".form_unit")?(t.closest(".form_unit").hasClass("-status_error")||(e=t.find("input, select, textarea"),t.addClass("-status_error").off("input.ClearError change.ClearError").one("input.ClearError change.ClearError",function(){t.off("input.ClearError change.ClearError").removeClass("-status_error"),e.off("blur.ClearError")}),e.off("blur.ClearError").one("blur.ClearError",function(){""!==$(this).val().trim()&&t.trigger("input.ClearError")})),t):t.closest(".form_unit").length?handleErrorField(t.closest(".form_unit")):t:handleErrorField($(t))}function toDataUrl(t,e){var n=new XMLHttpRequest;n.responseType="blob",n.onload=function(){var t=new FileReader;t.onloadend=function(){e(t.result)},t.readAsDataURL(n.response)},n.open("GET",t),n.send()}function showNotifier(t){$.notify({message:t.text,pos:t.pos?t.pos:"top-right",status:t.status?"success":"danger"})}function isNotDesktop(){var t=!1;return function(e){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0)}(navigator.userAgent||navigator.vendor||window.opera),t}function scrollTo(t,e,n){var i;return i=t instanceof jQuery?t.offset().top-150:t-150,!n||n instanceof Function||(n=function(){}),$("body").stop().animate({scrollTop:Math.ceil(i)},{duration:e?e:400,easing:"swing",complete:n}),i}function isScrollRemain(t){return $(window).height()+$(window).scrollTop()+ +t>=$(document).height()}function setDefaultValue(t,e){return t="undefined"==typeof t?e:t}function showSettingsModal(){var t=$("#settings-modal");t.remove(),$.ajax({url:"/api/v1/users/me/settings",type:"GET",success:function(e){t=tmpl("settings-modal",e.data),t.appendTo($("body")).on("shown.bs.modal",function(){e.data.hasOwnProperty("show_to_friends")&&t.find(".show-to-friends").prop("checked",e.data.show_to_friends),e.data.hasOwnProperty("notify_in_browser")&&t.find(".notify-in-browser").prop("checked",e.data.notify_in_browser),t.find(".notify-in-browser").on("change",function(){var t=$(this);t.prop("checked")&&Notify.needsPermission&&Notify.requestPermission(function(){},function(){t.prop("checked",!1),showNotifier({status:!1,text:"Мы не можем включить уведомления в браузере. Вы запретили их для нас :("})})})}).modal(),t.find(".save-settings-btn").off("click").on("click",function(){var e={};t.find("input").each(function(){var t=$(this);e[t.attr("name")]=t.prop("checked")}),Pace.ignore(function(){$.ajax({url:"/api/v1/users/me/settings",type:"PUT",data:e})}),t.modal("hide")})}})}function checkRedirects(t){return __APP.USER.isLoggedOut()&&t.contains("/admin")?__APP.changeState("/",!0,!0):!!t.contains("/statistics")&&__APP.changeState(t.replace("statistics","admin"),!0,!0)}__C={CLASSES:{MATERIAL:"material",FLOATING_MATERIAL:"material -floating_material",IMG_HOLDER:"img_holder",TEXT_COLORS:{ACCENT:"-text_color_accent"},COLORS:{ACCENT:"-color_accent",PRIMARY:"-color_primary",DEFAULT:"-color_default",NEUTRAL:"-color_neutral",NEUTRAL_ACCENT:"-color_neutral_accent",MARGINAL:"-color_marginal",MARGINAL_ACCENT:"-color_marginal_accent",MARGINAL_PRIMARY:"-color_marginal_primary",MARGINAL_FRANKLIN:"-color_marginal_franklin",MARGINAL_BUBBLEGUM:"-color_marginal_bubble_gum"},ALIGN:{LEFT:"-align_left",CENTER:"-align_center",RIGHT:"-align_right"},UNIVERSAL_STATES:{EMPTY:"-empty",ROUNDED:"-rounded",SHADOWED:"-shadowed",BORDERED:"-bordered",TRANSFORM_UPPERCASE:"-transform_uppercase"},STATUS:{SUCCESS:"-status_success",WARNING:"-status_warning",PENDING:"-status_pending",ERROR:"-status_error",DISABLED:"-status_disabled"},SIZES:{X30:"-size_30x30",X40:"-size_40x40",X50:"-size_50x50",X55:"-size_55x55",LOW:"-size_low",WIDE:"-size_wide",SMALL:"-size_small"},MODAL_STATES:{FIXED:"-fixed",NO_PADDING:"-no_padding",SIZE:{WIDE:"-size_wide",NARROW:"-size_narrow",TINY:"-size_tiny",RESPONSIVE:"-size_responsive"}},HOOKS:{HANDLED:"-Handled_",RIPPLE:"RippleEffect",ADD_STAFF:"AddStaff",ADD_TO_FAVORITES:"AddToFavorites",TEXT:"Text",CALL_MODAL:"CallModal",CLOSE_MODAL:"CloseModal",DROPDOWN_BUTTON:"DropdownButton",ADD_AVATAR:{ANCESTOR:"AddAvatarWrapper",COLLECTION:"AvatarsCollection",QUANTITY:"FavoredCount",STATES:{CAST:"-cast",CASTABLE:"-castable",SHIFT:"-shift",SHIFTED:"-shifted"}}},ACTIVE:"-active",DISABLED:"-disabled",HIDDEN:"-hidden",ICONS:{STAR:"fa-star",STAR_O:"fa-star-o",BELL_O:"fa-bell-o",TIMES:"fa-times",PLUS:"fa-plus",CHECK:"fa-check",PENCIL:"fa-pencil",EYE:"fa-eye",EYE_CLOSE:"fa-eye-slash",TICKET:"fa-ticket"},ICON_CLASS:"fa_icon"},DATE_FORMAT:"YYYY-MM-DD",MODAL_TYPES:{FAVORS:"favors",SUBSCRIBERS:"subscribers",EDITORS:"editors",MAP:"map",MEDIA:"media",CROPPER:"cropper",FRIENDS_LIST:"friends_list",SUBSCRIBERS_LIST:"subscribers_list",TICKET:"tickets",ADD_STAFF:"add_staff"},COLORS:{PRIMARY:"#2e3b50",MUTED:"#3e4d66",MUTED_80:"#657184",MUTED_50:"#9fa6b3",MUTED_30:"#c5c9d1",TEXT:"#4a4a4a",ACCENT:"#f82969",ACCENT_ALT:"#ff5f9e",FRANKLIN:"#28be84",FRANKLIN_ALT:"#23d792"},STATS:{EVENT_VIEW:"view",EVENT_VIEW_DETAIL:"view_detail",EVENT_OPEN_SITE:"open_site",EVENT_OPEN_MAP:"open_map",ORGANIZATION_OPEN_SITE:"open_site",EVENT_ENTITY:"event",ORGANIZATION_ENTITY:"organization"},ENTITIES:{USER:"user",EVENT:"event",ORGANIZATION:"organization"},DEFERRED_STATES:{PENDING:"pending",RESOLVED:"resolved",REJECTED:"rejected"}},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.contains=function(t){return this.search(t)!==-1},String.prototype.format=function(t){return this.replace(/\{(\w+)\}/g,function(e,n){return null!=t[n]?t[n]:""})},String.prototype.toCamelCase=function(t){return this.split(t?t:" ").map(function(t){return t.capitalize()}).join("")},String.prototype.toUnderscore=function(){return(this.charAt(0).toLowerCase()+this.slice(1)).replace(/([A-Z])/g,function(t){return"_"+t.toLowerCase()})},String.prototype.appendAjaxData=function(t){return t.fields&&t.fields instanceof Array&&(t.fields=t.fields.join(",")),this+JSON.stringify(t)},Object.props=function(t){return Object.keys(t).filter(function(e){return"function"!=typeof t[e]})},Object.getProps=function(t){var e={};return $.each(t,function(t,n){"function"!=typeof n&&(e[t]=n)}),e},Object.methods=function(t){var e=[];return Object.keys(t).forEach(function(n){"function"==typeof t[n]&&e.push(n)}),e},"function"!=typeof Object.values&&(Object.values=function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&t.propertyIsEnumerable(n)&&e.push(t[n]);return e}),Object.toHtmlDataSet=function(){var t=[],e=this;return Object.props(e).forEach(function(n){t.push((0!=n.indexOf("data-")?"data-"+n:n)+'="'+e[n]+'"')}),t.join(" ")},Object.toHtmlAttributes=function(){var t=[],e=this;return Object.props(e).forEach(function(n){t.push(n+'="'+e[n]+'"')}),t.join(" ")},Array.newFrom=function(t,e){var n,i,a=t.slice(0);if(arguments.length>1)for(i=1;i<arguments.length;i++)switch(n=arguments[i],typeof n){case"number":case"string":case"boolean":$.merge(a,[n]);break;case"object":n instanceof Array?$.merge(a,n):$.merge(a,Object.keys(n).map(function(t){return n[t]}));break;default:console.error("")}return a},Array.toSpaceSeparatedString=function(){return this.join(" ")},Array.prototype.clean=function(t){for(var e=0;e<this.length;e++)this[e]==t&&(this.splice(e,1),e--);return this},Array.prototype.merge=function(t){var e=Array.prototype.slice.call(arguments),n={},i=[],a=0,o=0;for(e.unshift(this),a=0;a<e.length;a++)for(o=0;o<e[a].length;o++)n[e[a][o]]!==!0&&(i[i.length]=e[a][o],n[e[a][o]]=!0);return i},Array.prototype.contains=function(t){return this.indexOf(t)!==-1},[].includes||(Array.prototype.includes=function(t){"use strict";var e=Object(this),n=parseInt(e.length)||0;if(0===n)return!1;var i,a=parseInt(arguments[1])||0;for(a>=0?i=a:(i=n+a,i<0&&(i=0));i<n;){var o=e[i];if(t===o||t!==t&&o!==o)return!0;i++}return!1}),Math.roundTo=function(t,e){var n=Math.pow(10,e?e:0);return Math.round(t*n)/n},function(t){function e(e){function n(t,e){for(var n,i,a,o=t.split("").reverse(),s=[],r=0,l=Math.ceil(t.length/e);r<l;r++){for(n="",a=0;a<e&&(i=r*e+a,i!==t.length);a++)n+=o[i];s.push(n)}return s}function i(t){var e=t.length-1,n=t[e].split("").reverse().join("");return t[e]=parseInt(n,10).toString().split("").reverse().join(""),t}var a,o,s,r=t(e.elem),l={separator:" ",group_length:3,suffix:"",prefix:""};if(e.elem.nodeType&&e.elem.parentNode){if(a=t.extend(!0,{},l,r.data()),o=Math.floor(e.now),s=o.toString(),s.length>a.group_length){var c=n(s,a.group_length);s=i(c).join(a.separator),s=s.split("").reverse().join("")}r.prop("number",e.now).text(a.prefix+s+a.suffix)}}t.Tween&&t.Tween.propHooks?t.Tween.propHooks.number={set:e}:t.fx.step.number=e}(window.jQuery),$.fn.extend({toggleStatus:function(t){var e=this;return e.is(".form_unit")?t.split(" ").forEach(function(t){var n=e.find("input, select, textarea, button");"disabled"===t&&(e.hasClass("-status_disabled")?n.removeAttr("disabled"):n.attr("disabled",!0)),e.toggleClass("-status_"+t)}):e.is("input, textarea, select, button")?e.closest(".form_unit").toggleStatus(t):e.length&&e.find(".form_unit").toggleStatus(t),this},serializeForm:function(t){var e=/^(?:input|select|textarea|keygen)/i,n=/^(?:submit|button|image|reset|file)$/i,i=/^(?:checkbox|radio)$/i,a=/\r?\n/g,o=this.map(function(){var t=$.prop(this,"elements");return t?$.makeArray(t):this});switch(t){case"array":return o.filter(function(){var t=this.type;return this.name&&!$(this).is(":disabled")&&e.test(this.nodeName)&&!n.test(t)&&(this.checked&&"on"!=this.value||"radio"!=t)&&(this.checked&&"on"!=this.value||"on"==this.value||"checkbox"!=t)}).map(function(t,e){var n=$(this).val(),i="";switch(this.type){case"radio":case"checkbox":i="on"==n?this.checked?1:0:n;break;default:i=n.replace(a,"\r\n")}return null==n?null:{name:e.name,value:i}}).get();case"object":default:var s={};return o.filter(function(){var t=this.type;return this.name&&!$(this).is(":disabled")&&e.test(this.nodeName)&&!n.test(t)&&!i.test(t)}).each(function(t,e){var n=$(e),i=e.name,r=n.val();if(o.filter("[name='"+i+"']").length>1&&""!=r)s[i]="undefined"==typeof s[i]?[]:s[i],s[i].push(r?r.replace(a,"\r\n"):r);else if("hidden"===n.attr("type")&&0===r.indexOf("data.")){for(var l=r.split("."),c=n.data(l[1]),d=2;l[d];)c=c[l[d]],d++;s[i]=c}else s[i]=r||0===r?r.replace(a,"\r\n"):null}),o.filter(function(){var t=this.type;return this.name&&!$(this).is(":disabled")&&i.test(t)&&(this.checked&&"on"!=this.value||"on"==this.value&&"checkbox"==t)}).each(function(t,e){var n=e.name,i=e.value;switch(e.type){case"radio":s[n]=i;break;case"checkbox":o.filter("[name='"+n+"']").length>1&&"on"!=i?(s[n]="undefined"==typeof s[n]?[]:s[n],s[n].push(i)):"on"!=i?s[n]=i:s[n]=!!e.checked}}),s}},animateNumber:function(t){for(var e=[t],n=1,i=arguments.length;n<i;n++)e.push(arguments[n]);return this.data(t),this.animate.apply(this,e)},tablesort:function(t){return t||(t={}),Tablesort&&"function"==typeof Tablesort?Tablesort(this.get(0),t):void console.error("Tablesort is not defined")},resolveInstance:function(){var t=this.data("instance");return t?t:this},outerHTML:function(){var t="";return this.each(function(e,n){t+=n.outerHTML}),t}}),jQuery.makeSet=function(t){return $($.map(t,function(t){return t.get()}))},function(t,e,n){var i={},a={},o=function(e){return"string"==t.type(e)&&(e={message:e}),arguments[1]&&(e=t.extend(e,"string"==t.type(arguments[1])?{status:arguments[1]}:arguments[1])),new r(e).show()},s=function(t,e){if(t)for(var n in a)t===a[n].group&&a[n].close(e);else for(var n in a)a[n].close(e)},r=function(e){this.options=t.extend({},r.defaults,e),this.uuid="ID"+(new Date).getTime()+"RAND"+Math.ceil(1e5*Math.random()),this.element=t(['<div class="uk-notify-message alert-dismissable">','<a class="close">&times;</a>',"<div>"+this.options.message+"</div>","</div>"].join("")).data("notifyMessage",this),this.options.status&&(this.element.addClass("alert alert-"+this.options.status),this.currentstatus=this.options.status),this.group=this.options.group,a[this.uuid]=this,i[this.options.pos]||(i[this.options.pos]=t('<div class="uk-notify uk-notify-'+this.options.pos+'"></div>').appendTo("body").on("click",".uk-notify-message",function(){t(this).data("notifyMessage").close()}))};return t.extend(r.prototype,{uuid:!1,element:!1,timout:!1,currentstatus:"",group:!1,show:function(){if(!this.element.is(":visible")){var t=this;i[this.options.pos].show().prepend(this.element);var e=parseInt(this.element.css("margin-bottom"),10);return this.element.css({opacity:0,"margin-top":-1*this.element.outerHeight(),"margin-bottom":0}).animate({opacity:1,"margin-top":0,"margin-bottom":e},function(){if(t.options.timeout){var e=function(){t.close()};t.timeout=setTimeout(e,t.options.timeout),t.element.hover(function(){clearTimeout(t.timeout)},function(){t.timeout=setTimeout(e,t.options.timeout)})}}),this}},close:function(t){var e=this,n=function(){e.element.remove(),i[e.options.pos].children().length||i[e.options.pos].hide(),delete a[e.uuid]};this.timeout&&clearTimeout(this.timeout),t?n():this.element.animate({opacity:0,"margin-top":-1*this.element.outerHeight(),"margin-bottom":0},function(){n()})},content:function(t){var e=this.element.find(">div");return t?(e.html(t),this):e.html()},status:function(t){return t?(this.element.removeClass("alert alert-"+this.currentstatus).addClass("alert alert-"+t),this.currentstatus=t,this):this.currentstatus}}),r.defaults={message:"",status:"normal",timeout:5e3,group:null,pos:"top-center"},t.notify=o,t.notify.message=r,t.notify.closeAll=s,
o}(jQuery,window,document),function(t){t.cookies={getItem:function(t){return t?decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null:null},setItem:function(t,e,n,i,a,o){var s="";if(!t||/^(?:expires|max\-age|path|domain|secure)$/i.test(t))return!1;if(n)switch(n.constructor){case Number:s=n===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+n;break;case String:s="; expires="+n;break;case Date:s="; expires="+n.toUTCString()}return document.cookie=encodeURIComponent(t)+"="+encodeURIComponent(e)+s+(a?"; domain="+a:"")+(i?"; path="+i:"")+(o?"; secure":""),!0},removeItem:function(t,e,n){return!!this.hasItem(t)&&(document.cookie=encodeURIComponent(t)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(n?"; domain="+n:"")+(e?"; path="+e:""),!0)},hasItem:function(t){return!!t&&new RegExp("(?:^|;\\s*)"+encodeURIComponent(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},keys:function(){for(var t=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),e=t.length,n=0;n<e;n++)t[n]=decodeURIComponent(t[n]);return t}}}(window),window.location.hostname.indexOf(".test.evendate.ru")==-1?window.socket=io.connect("https:"==window.location.protocol?":8443":":8080",{secure:"https:"==window.location.protocol}):window.socket=io({path:"/node/socket.io"}),socket.on("auth",function(t){var e;$.ajax({url:"auth.php",type:"POST",data:t,success:function(n){if(yaCounter32442130)switch(t.type){case"vk":yaCounter32442130.reachGoal("VkAuthDone");break;case"facebook":yaCounter32442130.reachGoal("FacebookAuthDone");break;case"google":yaCounter32442130.reachGoal("GoogleAuthDone")}if(n.status){var i=searchToObject();if(i.redirect_to)window.location.href=i.redirect_to;else if(t.hasOwnProperty("mobile")&&1==t.mobile)window.location.href="/mobileAuthDone.php?token="+t.token+"&email="+t.email;else{try{e=sessionStorage.getItem("organization_info")}catch(t){e=""}e?window.parent.location="/add/organization":0==t.subscriptions_count?window.parent.location="/onboarding":window.parent.location="/"}}else $(".panel-body.loader-demo").text(n.text),$(".panel-heading").hide()}})}),socket.on("log",function(t){console.log(t)}),socket.on("error.retry",function(){$(".panel-body.loader-demo").text("Во время загрузки данных произошла ошибка. Войдите с помощью другой социальной сети или попробуте чуть позже."),$(".panel-heading").hide()}),socket.on("notification",function(t){if(Notify.needsPermission)Notify.isSupported()&&Notify.requestPermission();else{socket.emit("notification.received",{notification_id:t.notification_id});var e=new Notify(t.note.payload.title,{body:t.note.body,icon:t.note.icon,tag:t.note.payload.event_id,timeout:60,notifyClick:function(){$("<a>").attr("href",window.location.origin+"/event.php?id="+t.note.payload.event_id).attr("target","_blank")[0].click(),socket.emit("notification.received",{notification_id:t.notification_id,click_time:moment().format(__C.DATE_FORMAT+" HH:MM:SS")})}});e.show()}}),socket.on("image.getFromURLDone",function(t){t.error?showNotifier({text:t.error,status:!1}):ImgLoader.handleImgUpload(ImgLoader.current_load_context,t.data,t.filename)}),socket.on("vk.getGroupsToPostDone",function(t){if(t.error)showNotifier({text:t.error,status:!1});else{var e=t.data.response,n=__APP.CURRENT_PAGE.$wrapper.find("#edit_event_vk_groups");e.length||e[0]?(e.splice(0,1),e.forEach(function(t){n.append(tmpl("option",{val:t.gid,display_name:t.name,data:"data-img='"+t.photo+"'"}))}),initSelect2(n)):__APP.CURRENT_PAGE.$wrapper.find("#edit_event_to_public_vk").toggleStatus("disabled").prop("checked",!1).trigger("change")}}),socket.on("vk.post.error",function(t){console.log(t),showNotifier({text:"Не удалось опубликовать событие в группе vk. Пожалуйста, попробуйте еще раз.",status:!1})}),EntityInterface=function(){function t(){}return t.prototype.setData=function(t){},t}(),Fields=function(){function t(t){this.add.apply(this,arguments)}function e(e){var n={};return e instanceof Array||(e=e.replace(/\s+/g,"").match(/(\w+\{[^}]+}|\w+)/g)),e.forEach(function(e){var i=e.split("{"),a={};i.length>1&&(a=JSON.parse("{"+i[1].replace(/(\w+):/g,function(t,e){return'"'+e+'":'})),a.fields&&(a.fields=new(Function.prototype.bind.apply(t,[null].concat(a.fields.split(","))))),a.order_by&&(a.order_by=a.order_by.split(","))),n[i[0]]=a}),n}var n=function(){function e(t){var e;for(e in t)this[e]=t[e]}return Object.defineProperties(e.prototype,{toString:{value:function(){var e=this,n=Object.props(this),i={};return 0===n.length?"":(n.forEach(function(n){i[n]=e[n]instanceof Array||e[n]instanceof t?e[n].toString():e[n]}),JSON.stringify(i))}},merge:{value:function(t){return $.extend(this,t)}}}),e}();return Object.defineProperty(t.prototype,"toString",{value:function(){var t=this,e=Object.props(this);if(0!==e.length)return e.map(function(e){return e+t[e]}).join(",")}}),t.parseFields=function(n){return n instanceof t?n.copy():new t(e(n))},t.prototype.get=function(t){return this.has(t)?this[t]:null},t.prototype.push=t.prototype.add=function(){var t,e=Array.prototype.splice.call(arguments,0),i={};e.forEach(function(t){"string"==typeof t?i[t]={}:t instanceof Array?t.forEach(function(t){i[t]={}}):t instanceof Object&&Object.props(t).forEach(function(e){i[e]=t[e]})});for(t in i)this.has(t)?this[t].merge(i[t]):this[t]=new n(i[t]);return this},t.prototype.pull=function(t){var e=this.get(t);return this.delete(t),e},t.prototype.has=function(t){return"undefined"!=typeof this[t]},t.prototype.delete=function(t){return!!this.has(t)&&delete this[t]},t.prototype.copy=function(){return new t(this)},t}(),OneEntity=function(){function t(){}return t.prototype.setData=function(e){var n;Array.isArray(e)&&(e=e[0]);for(n in e)e.hasOwnProperty(n)&&this.hasOwnProperty(n)&&((this[n]instanceof EntitiesCollection||this[n]instanceof t)&&null!=e[n]?this[n].setData(e[n]):this[n]=e[n]);return this},t}(),EntitiesCollection=extending(Array,function(){function t(){Object.defineProperty(this,"__lookup",{value:{},writable:!0,enumerable:!1,configurable:!1}),Object.defineProperty(this,"last_pushed",{value:[],writable:!0,enumerable:!1,configurable:!1})}return t.prototype.collection_of=OneEntity,t.prototype.setData=function(t){return t=t instanceof Array?t:[t],this.push.apply(this,t),this},t.prototype.getByID=function(t){return this.__lookup.hasOwnProperty(t)?this.__lookup[t]:null},t.prototype.has=function(t){return this.getByID(t)instanceof OneEntity},t.prototype.push=function(t){var e;this.last_pushed=[];for(var n=0;n<arguments.length;n++)(!arguments[n].id||arguments[n].id&&!this.has(arguments[n].id))&&(e=arguments[n]instanceof this.collection_of?arguments[n]:(new this.collection_of).setData(arguments[n]),this.last_pushed.push(e),this[this.length++]=e,arguments[n].id&&(this.__lookup[arguments[n].id]=e));return this.length},t.prototype.getArrayCopy=function(){return this.map(function(t){return t})},t.prototype.remove=function(t){return this.has(t)?(delete this.__lookup[t],this.splice(this.indexOf(this.getByID(t)),1)):[]},t}()),OrganizationModel=extending(OneEntity,function(){function t(t){this.organization_id=null,this.name=null,this.short_name=null,this.description=null,this.site_url=null,this.default_address=null,this.vk_url=null,this.facebook_url=null,this.type_id=null,this.background=null,this.background_filename=null,this.logo=null,this.logo_filename=null,this.detail_info_url=null,this.email=null,this.city_id=null,this.country_id=null,this.is_private=null,t&&e(this,t)}function e(t,e){var n;for(n in e)if(e.hasOwnProperty(n))if(t.hasOwnProperty(n))t[n]=e[n];else switch(n){case"background_img_url":isBase64(e[n])&&(t.background=e[n]);break;case"img_url":isBase64(e[n])&&(t.logo=e[n]);break;case"city":t.city_id=e[n]instanceof OneCity?e[n].id:e[n];break;case"country":t.country_id=e[n].id}return t}return t.prototype.setData=function(t){return e(this,t)},t.prototype.toString=function(){return JSON.stringify(this)},t}()),DateModel=extending(OneEntity,function(){function t(){this.event_date="",this.start_time="",this.end_time=""}return t}()),DateModelsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=DateModel,t}()),RegistrationFieldModel=extending(OneEntity,function(){function t(){this.uuid=null,this.type=null,this.label=null,this.required=!1}return t.TYPES={EMAIL:"email",FIRST_NAME:"first_name",LAST_NAME:"last_name",PHONE_NUMBER:"phone_number",ADDITIONAL_TEXT:"additional_text",CUSTOM:"custom",EXTENDED_CUSTOM:"extended_custom"},t.DEFAULT_LABEL={EMAIL:"E-mail",FIRST_NAME:"Имя",LAST_NAME:"Фамилия",PHONE_NUMBER:"Номер телефона",ADDITIONAL_TEXT:"Дополнительное текстовое поле",CUSTOM:"Дополнительное текстовое поле",EXTENDED_CUSTOM:"Дополнительное текстовое поле"},t.isCustomField=function(e){switch(e.type){case t.TYPES.EMAIL:case t.TYPES.FIRST_NAME:case t.TYPES.LAST_NAME:case t.TYPES.PHONE_NUMBER:return!1;default:case t.TYPES.CUSTOM:case t.TYPES.EXTENDED_CUSTOM:case t.TYPES.ADDITIONAL_TEXT:return!0}},t.prototype.setData=function(t){var e;Array.isArray(t)&&(t=t[0]);for(e in t)t.hasOwnProperty(e)&&this.hasOwnProperty(e)&&(this[e]=t[e]);return this},t}()),RegistrationFieldsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=RegistrationFieldModel,t.prototype.push=function(t){var e=this,n=Array.prototype.slice.call(arguments),i=[RegistrationFieldModel.TYPES.FIRST_NAME,RegistrationFieldModel.TYPES.LAST_NAME,RegistrationFieldModel.TYPES.EMAIL,RegistrationFieldModel.TYPES.PHONE_NUMBER,RegistrationFieldModel.TYPES.ADDITIONAL_TEXT,RegistrationFieldModel.TYPES.CUSTOM,RegistrationFieldModel.TYPES.EXTENDED_CUSTOM];return this.last_pushed=[],i.forEach(function(t){n.forEach(function(n){n.type==t&&e.last_pushed.push(e[e.length++]=n instanceof e.collection_of?n:(new e.collection_of).setData(n))})}),this.length},t}()),OneAbstractActivity=extending(OneEntity,function(){function t(){this.stat_type_id=0,this.user_id=0,this.user=new OneUser(this.user_id),this.entity="",this.type_code="",this.created_at=0}return t.TYPES={SUBSCRIBE:"subscribe",FAVE:"fave",UNSUBSCRIBE:"unsubscribe",UNFAVE:"unfave",SHARE_VK:"share_vk",SHARE_FB:"share_fb",SHARE_TW:"share_tw"},Object.freeze(t.TYPES),t.TYPES_INDEX={subscribe:"SUBSCRIBE",fave:"FAVE",unsubscribe:"UNSUBSCRIBE",unfave:"UNFAVE",share_vk:"SHARE",share_fb:"SHARE",share_tw:"SHARE"},Object.freeze(t.TYPES_INDEX),t}()),OneEventActivity=extending(OneAbstractActivity,function(){function t(){OneAbstractActivity.call(this),this.event_id=0,this.event=new OneEvent(this.event_id)}return t}()),OneOrganizationActivity=extending(OneAbstractActivity,function(){function t(){OneAbstractActivity.call(this),this.organization_id=0,this.organization=new OneOrganization(this.organization_id)}return t}()),UsersActivitiesCollection=extending(EntitiesCollection,function(){function t(t){EntitiesCollection.call(this),Object.defineProperty(this,"user_id",{value:t})}return Object.defineProperty(t.prototype,"collection_of",{value:OneAbstractActivity}),t.setDefaultData=function(t){return"string"==typeof t.fields?t.fields=t.fields.split(","):t.fields instanceof Array||(t.fields=[]),t.fields=t.fields.merge(["created_at","type_code","event","organization"]),t.order_by=setDefaultValue(t.order_by,"-created_at"),t.length=setDefaultValue(t.length,20),t},t.prototype.push=function(t){for(var e=0;e<arguments.length;e++)arguments[e]instanceof this.collection_of?this[this.length]=arguments[e]:void 0!=arguments[e].event_id?this[this.length]=(new OneEventActivity).setData(arguments[e]):void 0!=arguments[e].organization_id&&(this[this.length]=(new OneOrganizationActivity).setData(arguments[e])),this.length++;return this.length},t.fetch=function(e,n,i){return n=t.setDefaultData(n),__APP.SERVER.getData("/api/v1/users/"+e+"/actions",n,i)},t.prototype.fetch=function(t,e,n,i){var a=this,o={fields:t,offset:this.length,length:e};return n&&(o.order_by=n),this.constructor.fetch(this.user_id,o).then(function(t){return a.setData(t),(new a.constructor).setData(t)})},t}()),OneCategory=extending(OneEntity,function(){function t(t,e){this.id=setDefaultValue(t,0),this.name=null,this.order_position=null,this.organizations=new OrganizationsCollection,this.loading=!1,t&&e&&(this.loading=!0,this.fetchCategory([],function(){this.loading=!1,$(window).trigger("fetch.OneCategory")}))}return t.fetchCategory=function(t,e,n){return __APP.SERVER.getData("/api/v1/organizations/types",$.extend({},e,{id:t}),n)},t.prototype.fetchCategory=function(t,e){var n=this;return this.constructor.fetchCategory(n.id,{fields:t},function(t){n.setData(t),e&&"function"==typeof e&&e.call(n,t[0])})},t}()),CategoriesCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneCategory,t.fetchCategories=function(t,e){return __APP.SERVER.getData("/api/v1/organizations/types",t,e)},t.prototype.fetchCategories=function(t,e,n){var i=this,a=$.extend({},t,{offset:this.length,length:e});return this.constructor.fetchCategories(a,function(t){i.setData(t),n&&"function"==typeof n&&n.call(i,t)})},t.prototype.fetchCategoriesWithOrganizations=function(t,e,n,i){var a=this,o=$.extend({},t,{offset:this.length,length:n}),s="organizations"+JSON.stringify(__APP.SERVER.validateData(e));return o.fields?Array.isArray(o.fields)||(o.fields=o.fields.split(",")):o.fields=[],o.fields.push(s),this.constructor.fetchCategories(o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},t}()),OneCity=extending(OneEntity,function(){function t(t){this.id=setDefaultValue(t,0),this.en_name=null,this.country_id=null,this.local_name=null,this.organization_type=new CategoriesCollection,this.timediff_seconds=null}return t}()),CitiesCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneCity,t.fetchCities=function(t,e){return __APP.SERVER.getData("/api/v1/organizations/cities",t,e)},t.prototype.getByName=function(t){for(var e=0;e<this.length;e++)if(this[e].en_name==t)return this[e];return null},t.prototype.has=function(t){return($.isNumeric(t)?this.getByID(t):this.getByName(t))instanceof OneEntity},t.prototype.fetchCities=function(e,n,i,a){var o=this;return t.fetchCities({fields:e||void 0,offset:this.length,length:n||void 0,order_by:i||void 0},function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,o.last_pushed)})},t}()),OneDate=extending(DateModel,function(){function t(){DateModel.call(this),this.id=0,this.event_id=0,this.organization_id=0,this.events_count=0,this.favored_count=0}return t}()),DatesCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneDate,t.fetchDates=function(t,e){return __APP.SERVER.getData("/api/v1/events/dates",t,e)},t}()),OneEvent=extending(OneEntity,function(){function t(t,e){this.id=t?t:0,this.title=null,this.description=null,this.location=null,this.latitude=null,this.longitude=null,this.is_online=null,this.detail_info_url=null,this.orders=new OrdersCollection(t),this.ticketing_locally=null,this.tickets=new EventsTicketsCollection(t),this.ticket_types=new TicketTypesCollection(t),this.registration_locally=null,this.registration_available=null,this.registration_required=null,this.registration_limit_count=null,this.registration_till=null,this.registration_approve_status=null,this.registration_approvement_required=null,this.is_registered=null,this.registered_count=null,this.registered_users=new UsersCollection,this.registration_fields=new RegistrationFieldsCollection,this.organization_id=null,this.organization_short_name=null,this.organization_logo_large_url=null,this.organization_logo_medium_url=null,this.organization_logo_small_url=null,this.image_vertical_url=null,this.image_horizontal_url=null,this.image_horizontal_large_url=null,this.image_horizontal_medium_url=null,this.image_horizontal_small_url=null,this.is_free=null,this.min_price=null,this.dates=new DatesCollection,this.is_same_time=null,this.first_event_date=null,this.last_event_date=null,this.nearest_event_date=null,this.tags=new TagsCollection,this.notifications=[],this.favored=new UsersCollection,this.favored_users_count=null,this.favored_friends_count=null,this.is_favorite=null,this.public_at=null,this.canceled=null,this.can_edit=null,this.actuality=null,this.creator_id=null,this.created_at=null,this.updated_at=null,this.loading=!1,t&&e&&(this.loading=!0,this.fetchEvent(void 0,function(){this.loading=!1,$(window).trigger("fetch.OneEvent")}))}return t.STATUS={CANCEL:"cancel",BRING_BACK:"bring_back",HIDE:"hide",SHOW:"show"},t.fetchEvent=function(t,e,n){return __APP.SERVER.getData("/api/v1/events/"+t,{fields:new Fields(e)},n)},t.createEvent=function(t,e,n){return __APP.SERVER.addData("/api/v1/events/",t,!0,e,n)},t.updateEvent=function(t,e,n,i){return __APP.SERVER.updateData("/api/v1/events/"+t,e,!0,n,i)},t.changeEventStatus=function(e,n,i){var a={};return n=Array.isArray(n)?n:[n],n.forEach(function(e){switch(e){case t.STATUS.CANCEL:a.canceled=!0;break;case t.STATUS.BRING_BACK:a.canceled=!1;break;case t.STATUS.HIDE:a.hidden=!0;break;case t.STATUS.SHOW:a.hidden=!1}}),__APP.SERVER.updateData("/api/v1/events/"+e+"/status",a,!1,function(){i&&"function"==typeof i&&i.call(self,a)})},t.addFavored=function(t,e){return __APP.SERVER.addData("/api/v1/events/"+t+"/favorites",{},!1,e)},t.deleteFavored=function(t,e){return __APP.SERVER.deleteData("/api/v1/events/"+t+"/favorites",{},e)},t.addEventNotification=function(t,e,n){return __APP.SERVER.addData("/api/v1/events/"+t+"/notifications",{notification_type:e},!1,n)},t.deleteEventNotification=function(t,e,n){return __APP.SERVER.deleteData("/api/v1/events/"+t+"/notifications/"+e,{},n)},t.registerToEvent=function(t,e,n){return __APP.SERVER.addData("/api/v1/events/"+t+"/orders",{registration_fields:e,tickets:[{uuid:null,count:1}]},!0,n)},t.prototype.fetchEvent=function(e,n){var i=this;return t.fetchEvent(i.id,e,function(t){i.setData(t[0]),n&&"function"==typeof n&&n.call(i,t[0])})},t.prototype.createEvent=function(t,e,n){var i=this;return this.constructor.createEvent(t,function(n){i.setData(t),i.id=n.event_id,e&&"function"==typeof e&&e.call(i,t)},n)},t.prototype.updateEvent=function(t,e,n){var i=this;return this.constructor.updateEvent(i.id,t,function(n){i.setData(t),e&&"function"==typeof e&&e.call(i,t)},n)},t.prototype.changeEventStatus=function(t,e){var n=this;return this.constructor.changeEventStatus(n.id,t,function(t){n.setData(t),e&&"function"==typeof e&&e.call(n,t)})},t.prototype.addNotification=function(t,e){return this.constructor.addEventNotification(this.id,t,e)},t.prototype.deleteNotification=function(t,e){return this.constructor.deleteEventNotification(this.id,t,e)},t.prototype.registerToEvent=function(t,e){return this.constructor.registerToEvent(this.id,t,e)},t}()),EventsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneEvent,t.KIND={MY:"my",FAVORED:"favored",RECOMMENDED:"recommended"},t.fetchEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/",t,e)},t.fetchMyEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/my",t,e)},t.fetchFavoredEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/favorites",t,e)},t.fetchRecommendedEvents=function(t,e){return __APP.SERVER.getData("/api/v1/events/recommendations",t,e)},t.fetchOrganizationsEvents=function(t,e,n){return __APP.SERVER.getData("/api/v1/events/",$.extend({},e,{organization_id:t}),n)},t.prototype.fetchEvents=function(e,n,i,a){var o=this,s="fetchEvents",r=$.extend({},n,{offset:this.length,length:i});switch(e){default:s="fetchEvents";break;case t.KIND.MY:s="fetchMyEvents";break;case t.KIND.FAVORED:s="fetchFavoredEvents";break;case t.KIND.RECOMMENDED:s="fetchRecommendedEvents"}return this.constructor[s](r,function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,o.last_pushed)})},t.prototype.fetchFeed=function(t,e,n){var i=this,a={fields:t,offset:this.length,length:e};return this.constructor.fetchEvents(a,function(t){i.setData(t),n&&"function"==typeof n&&n.call(i,i.last_pushed)})},t.prototype.fetchOrganizationsEvents=function(t,e,n,i){var a=this,o=$.extend({},e,{offset:this.length,length:n});return this.constructor.fetchOrganizationsEvents(t,o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,a.last_pushed)})},t.prototype.fetchOrganizationsFeed=function(t,e,n,i){var a=this,o={fields:e,offset:this.length,length:n};return this.constructor.fetchOrganizationsEvents(t,o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,a.last_pushed)})},t}()),ActualEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchEvents=function(t,e){return t.fields=t.fields?"string"==typeof t.fields?t.fields.split(","):t.fields:[],t.fields.push("actuality"),t.future=!0,t.order_by="-actuality",EventsCollection.fetchMyEvents(t,e)},t}()),CanceledEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchOrganizationsEvents=function(t,e,n){return e.fields=e.fields?"string"==typeof e.fields?e.fields.split(","):e.fields:[],e.fields.push("updated_at"),e.is_canceled=!0,e.order_by="-updated_at",EventsCollection.fetchOrganizationsEvents(t,e,n)},t}()),DayEventsCollection=extending(EventsCollection,function(){function t(t){if(!t)throw Error("DayEventsCollection must have date parameter");EventsCollection.call(this),this.date=t}return t.fetchEvents=function(t,e,n){return e.date=t,EventsCollection.fetchMyEvents(e,n)},t.prototype.fetchFeed=function(t,e,n){var i=this,a={fields:t,offset:this.length,length:e};return this.constructor.fetchEvents(this.date,a,function(t){i.setData(t),n&&"function"==typeof n&&n.call(i,t)})},t}()),DelayedEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchOrganizationsEvents=function(t,e,n){return e.fields=e.fields?"string"==typeof e.fields?e.fields.split(","):e.fields:[],e.fields.push("public_at"),e.is_delayed=!0,e.is_canceled=!1,e.order_by="public_at",EventsCollection.fetchOrganizationsEvents(t,e,n)},t}()),OneEventWithStatistics=extending(OneEvent,function(){function t(t,e){OneEvent.apply(this,arguments),this.view=0,this.view_detail=0,this.fave=0,this.unfave=0,this.open_site=0,this.notifications_sent=0}return t}()),EventsWithStatisticsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.prototype.collection_of=OneEventWithStatistics,t.fetchEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/",t,e)},t.fetchMyEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/my",t,e)},t.fetchFavoredEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/favorites",t,e)},t.fetchRecommendedEvents=function(t,e){return t.statistics=!0,__APP.SERVER.getData("/api/v1/events/recommendations",t,e)},t.fetchOrganizationsEvents=function(t,e,n){return e.statistics=!0,__APP.SERVER.getData("/api/v1/events/",$.extend({},e,{organization_id:t}),n)},t}()),FavoredEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchEvents=function(t,e){return t.future=!0,EventsCollection.fetchFavoredEvents(t,e)},t}()),FriendsEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchEvents=function(t,e){return t.fields=t.fields?"string"==typeof t.fields?t.fields.split(","):t.fields:[],t.fields.push("favored_friends_count"),t.future=!0,t.order_by="-favored_friends_count",EventsCollection.fetchMyEvents(t,e)},t}()),FutureEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchOrganizationsEvents=function(t,e,n){return e.future=!0,e.order_by="nearest_event_date",EventsCollection.fetchOrganizationsEvents(t,e,n)},t}()),PastEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchOrganizationsEvents=function(t,e,n){return e.till=moment().format(__C.DATE_FORMAT),e.order_by="-last_event_date",EventsCollection.fetchOrganizationsEvents(t,e,n)},t}()),RecommendedEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchEvents=function(t,e){return t.future=!0,t.order_by="-rating",EventsCollection.fetchRecommendedEvents(t,e)},t}()),TimelineEventsCollection=extending(EventsCollection,function(){function t(){EventsCollection.call(this)}return t.fetchEvents=function(t,e){return t.future=!0,EventsCollection.fetchMyEvents(t,e)},t}()),OneOrder=extending(OneEntity,function(){function t(e,n){var i=this;this.uuid=setDefaultValue(n,0),this.event_id=setDefaultValue(e,0),this.order_content=null,this.is_canceled=null,this.status_id=null,this.status_type_code=null,this.created_at=null,this.updated_at=null,this.payed_at=null,this.canceled_at=null,this.tickets=new EventsTicketsCollection,this.user_id=null,this.user=new OneUser,Object.defineProperty(this,"status_name",{get:function(){for(var e in t.EXTENDED_ORDER_STATUSES)if(t.EXTENDED_ORDER_STATUSES.hasOwnProperty(e)&&t.EXTENDED_ORDER_STATUSES[e]===i.status_type_code)return __LOCALES.ru_RU.TEXTS.TICKET_STATUSES[e]}})}return t.ORDER_STATUSES={WAITING_FOR_PAYMENT:"waiting_for_payment",IS_PENDING:"is_pending",APPROVED:"approved",PAYED:"payed",WITHOUT_PAYMENT:"without_payment",RETURNED_BY_ORGANIZATION:"returned_by_organization",RETURNED_BY_CLIENT:"returned_by_client",REJECTED:"rejected"},t.EXTENDED_ORDER_STATUSES=$.extend({PAYMENT_CANCELED_AUTO:"payment_canceled_auto",PAYMENT_CANCELED_BY_CLIENT:"payment_canceled_by_client"},t.ORDER_STATUSES),t.fetchOrder=function(t,e,n,i){return __APP.SERVER.getData("/api/v1/events/"+t+"/orders/"+e,{fields:n},i)},t.prototype.fetchOrder=function(e,n){var i=this;return t.fetchOrder(this.event_id,this.uuid,e,function(t){i.setData(t),n&&"function"==typeof n&&n.call(i,t)})},t}()),OrdersCollection=extending(EntitiesCollection,function(){function t(t){EntitiesCollection.call(this),this.event_id=setDefaultValue(t,0)}return t.prototype.collection_of=OneOrder,t.prototype.getByUUID=function(t){var e=this.filter(function(e){return e.uuid===t});return e.shift()},t.fetchOrders=function(t,e,n){return __APP.SERVER.getData("/api/v1/events/"+t+"/orders",e,n)},t.prototype.fetchOrders=function(e,n,i,a){var o=this;return t.fetchOrders(this.event_id,{fields:e||void 0,offset:this.length,length:n||void 0,order_by:i||void 0},function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,o.last_pushed)})},t}()),SearchResults=extending(OneEntity,function(){function t(t){this.query_string=t,this.events=new EventsCollection,this.organizations=new OrganizationsCollection}return t.sanitizeQueryVar=function(t){var e={};return 0===t.indexOf("#")?e.tags=t.replace("#",""):e.q=t,e},t.fetchEventsAndOrganizations=function(e,n,i){return __APP.SERVER.getData("/api/v1/search/",$.extend({},t.sanitizeQueryVar(e),n),i)},t.prototype.fetchEvents=function(e,n){var i=this,a={fields:"events"+JSON.stringify($.extend({},__APP.SERVER.validateData(e),{offset:this.events.length}))};return t.fetchEventsAndOrganizations(i.query_string,a,function(t){i.setData(t),n&&"function"==typeof n&&n.call(i,t.events)})},t.prototype.fetchOrganizations=function(e,n){var i=this,a={fields:"organizations"+JSON.stringify($.extend({},__APP.SERVER.validateData(e),{offset:this.organizations.length}))};return t.fetchEventsAndOrganizations(i.query_string,a,function(t){i.setData(t),n&&"function"==typeof n&&n.call(i,t.organizations)})},t.prototype.fetchEventsAndOrganizations=function(e,n,i){var a=this,o={fields:new Fields};return e&&o.fields.push({events:$.extend({},__APP.SERVER.validateData(e),{offset:this.events.length})}),n&&!t.sanitizeQueryVar(a.query_string).tags&&o.fields.push({organizations:$.extend({},__APP.SERVER.validateData(n),{offset:this.organizations.length})}),t.fetchEventsAndOrganizations(a.query_string,o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},t}()),OneOrganization=extending(OneEntity,function(){function t(t,e){var n=this;this.id=t||0,this.name=null,this.short_name=null,this.description=null,this.img_url=null,this.img_small_url=null,this.img_medium_url=null,this.background_img_url=null,this.background_small_img_url=null,this.background_medium_img_url=null,this.type_id=null,this.type_name=null,this.site_url=null,this.default_address=null,this.events=new EventsCollection,this.subscription_id=null,this.is_subscribed=null,this.subscribed_count=null,this.subscribed=new UsersCollection,this.privileges=[],this.is_private=null,this.brand_color=null,this.city=new OneCity,this.country=null,this.email=null,this.staff=new UsersCollection,this.status=null,this.is_new=null,this.new_events_count=null,this.actual_events_count=null,this.vk_url=null,this.facebook_url=null,Object.defineProperties(this,{role:{get:function(){return OneUser.recognizeRole(n.privileges)}},admins:{get:function(){return n.staff.getSpecificStaff(OneUser.ROLE.ADMIN)}},moderators:{get:function(){return n.staff.getSpecificStaff(OneUser.ROLE.MODERATOR)}}}),this.loading=!1,t&&e&&(this.loading=!0,this.fetchOrganization([],function(){this.loading=!1,$(window).trigger("fetch.OneOrganization")}))}return t.fetchOrganization=function(t,e,n){return __APP.SERVER.getData("/api/v1/organizations/"+t,{fields:e},n)},t.createOrganization=function(t,e){return __APP.SERVER.addData("/api/v1/organizations/",t,!0,e)},t.updateOrganization=function(t,e,n){return __APP.SERVER.updateData("/api/v1/organizations/"+t,e,!0,n)},t.addStaff=function(t,e,n,i){return __APP.SERVER.addData("/api/v1/organizations/"+t+"/staff",{user_id:e,role:n},!1,i)},t.removeStaff=function(t,e,n,i){return __APP.SERVER.deleteData("/api/v1/organizations/"+t+"/staff",{user_id:e,role:n},i)},t.subscribeOrganization=function(t,e){return __APP.SERVER.addData("/api/v1/organizations/"+t+"/subscriptions",{},!1,e)},t.unsubscribeOrganization=function(t,e){return __APP.SERVER.deleteData("/api/v1/organizations/"+t+"/subscriptions",{},e)},t.prototype.fetchOrganization=function(t,e){var n=this;return this.constructor.fetchOrganization(n.id,t,function(t){n.setData(t),e&&"function"==typeof e&&e.call(n,n)})},t.prototype.fetchOrganizationWithEvents=function(t,e,n){var i=t;return i=i instanceof Array?i:i.split(","),i.push("events".appendAjaxData(e)),this.fetchOrganization(t,n)},t.prototype.createOrganization=function(e,n){var i=this;return t.createOrganization(e,function(t){i.setData(e),i.id=t.organization_id,n&&"function"==typeof n&&n.call(i,i)})},t.prototype.updateOrganization=function(e,n){var i=this;return t.updateOrganization(i.id,e,function(t){i.setData(e),n&&"function"==typeof n&&n.call(i,i)})},t.prototype.subscribe=function(t){var e=this;return this.constructor.subscribeOrganization(this.id,function(n){this.is_subscribed=!0,this.subscribed_count++,t&&"function"==typeof t&&t.call(e,n)})},t.prototype.unsubscribe=function(t){var e=this;return this.constructor.unsubscribeOrganization(this.id,function(n){this.is_subscribed=!1,this.subscribed_count=this.subscribed_count?this.subscribed_count-1:this.subscribed_count,t&&"function"==typeof t&&t.call(e,n)})},t.prototype.addStaff=function(e,n,i){var a=this,o=new OneUser(e);return __APP.SERVER.multipleAjax(t.addStaff(this.id,e,n),o.fetchUser(new Fields)).done(function(t,e){a.staff.setData(o),i&&"function"==typeof i&&i.call(a,o)}).promise()},t.prototype.removeStaff=function(e,n,i){var a=this;return t.removeStaff(this.id,e,n,function(){i&&"function"==typeof i&&i.call(a,a.staff.remove(e))})},t}()),OrganizationsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneOrganization,t.fetchSubscribedOrganizations=function(t,e){return __APP.SERVER.getData("/api/v1/organizations/subscriptions",t,e);
},t.fetchMyOrganizations=function(t,e,n){return t=Array.isArray(t)?t.join(","):t,__APP.SERVER.getData("/api/v1/organizations/",$.extend({},e,{roles:t}),n)},t.fetchRecommendations=function(t,e){return __APP.SERVER.getData("/api/v1/organizations/recommendations",t,e)},t.prototype.fetchSubscribedOrganizations=function(t,e,n,i){var a=this,o={fields:t,offset:this.length,length:e,order_by:n||void 0};return this.constructor.fetchSubscribedOrganizations(o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},t.prototype.fetchMyOrganizations=function(e,n,i,a,o){var s=this,r={fields:n,length:i,offset:this.length,order_by:a||void 0};return t.fetchMyOrganizations(e,r,function(t){s.setData(t),o&&"function"==typeof o&&o.call(s,t)})},t}()),Statistics=function(){function t(){this.id=0,this.entity=null,this.view=[],this.fave=[],this.unfave=[],this.notifications_sent=[],this.dynamics={view:[],fave:[]}}return t.prototype.setData=function(t){return $.extend(!0,this,t instanceof Array?t[0]:t)},t.SCALES={MINUTE:"minute",HOUR:"hour",DAY:"day",WEEK:"week",MONTH:"month",YEAR:"year",OVERALL:"overall"},t.ENTITIES={EVENT:"events",ORGANIZATION:"organizations"},t.fetchStatistics=function(t,e,n,i,a,o,s){var r={scale:n,fields:[]};switch(a instanceof Array?r.fields=r.fields.concat(a):$.each(a,function(t,e){Object.getOwnPropertyNames(e).length?r.fields.push(t+JSON.stringify(e)):r.fields.push(t)}),o&&r.fields.push("dynamics"+JSON.stringify(__APP.SERVER.validateData(o))),typeof i){case"string":i&&(r.since=i);break;case"object":i.since&&(r.since=i.since),i.till&&(r.till=i.till);break;default:case"boolean":}return __APP.SERVER.getData("/api/v1/statistics/"+t+"/"+e,r,s)},t.prototype.fetchStatistics=function(e,n,i,a,o){var s=this;return t.fetchStatistics(this.entity,this.id,e,n,i,a,function(t){s.setData(t),o&&"function"==typeof o&&o.call(s,t)})},t}(),EventStatistics=extending(Statistics,function(){function t(t){Statistics.apply(this),this.id=t,this.entity=Statistics.ENTITIES.EVENT,this.open_site=[],this.view_detail=[],this.open_conversion=[],this.fave_conversion=[],this.dynamics.fave_conversion=[],this.dynamics.open_conversion=[]}return t}()),OrganizationsStatistics=extending(Statistics,function(){function t(t){Statistics.apply(this),this.id=t,this.entity=Statistics.ENTITIES.ORGANIZATION,this.subscribe=[],this.unsubscribe=[],this.conversion=[],this.audience={},this.dynamics.subscribe=[],this.dynamics.conversion=[]}return t}()),OneTag=extending(OneEntity,function(){function t(t,e){this.id=t?t:0,this.name="",t&&e&&(this.loading=!0,this.fetchTag(function(){this.loading=!1,$(window).trigger("fetch.OneTag")}))}return t.fetchTag=function(t,e){return __APP.SERVER.getData("/api/v1/tags/"+t,{},e)},t.prototype.fetchTag=function(t){var e=this;return this.constructor.fetchTag(e.id,function(n){e.setData(n[0]),t&&"function"==typeof t&&t.call(e,n[0])})},t}()),TagsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneTag,t.fetchTags=function(t,e){return __APP.SERVER.getData("/api/v1/tags/",t,e)},t.prototype.fetchTags=function(t,e){var n=this;return this.constructor.fetchTags(t,function(t){n.setData(t),e&&"function"==typeof e&&e.call(n,t)})},t}()),OneTicket=extending(OneEntity,function(){function t(t,e){this.uuid=setDefaultValue(e,0),this.event_id=setDefaultValue(t,0),this.user_id=null,this.type_code=null,this.ticket_type_uuid=null,this.ticket_order_uuid=null,this.status=null,this.checked_out=null,this.price=null,this.number=null,this.ticket_type=new OneTicketType,this.order=new OneOrder,this.user=new OneUser,this.created_at=null}return t.fetchTicket=function(t,e,n,i){return __APP.SERVER.getData("/api/v1/events/"+t+"/tickets/"+e,{fields:n},i)},t.prototype.fetchTicket=function(e,n){var i=this;return t.fetchTicket(this.event_id,this.uuid,e,function(t){i.setData(t),n&&"function"==typeof n&&n.call(i,t)})},t}()),EventsTicketsCollection=extending(EntitiesCollection,function(){function t(t){EntitiesCollection.call(this),this.event_id=setDefaultValue(t,0)}return t.prototype.collection_of=OneTicket,t.fetchTickets=function(t,e,n){return __APP.SERVER.getData("/api/v1/events/"+t+"/tickets",e,n)},t.prototype.fetchTickets=function(e,n,i,a){var o=this;return t.fetchTickets(this.event_id,{fields:e||void 0,offset:this.length,length:n||void 0,order_by:i||void 0},function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,o.last_pushed)})},t}()),OneExtendedTicket=extending(OneTicket,function(){function t(e,n){var i=this;OneTicket.call(this,e,n),this.event=new OneEvent(e),Object.defineProperties(this,{status_name:{get:function(){for(var e in t.TICKET_STATUSES)if(t.TICKET_STATUSES.hasOwnProperty(e)&&t.TICKET_STATUSES[e]===i.order.status_type_code)return __LOCALES.ru_RU.TEXTS.TICKET_STATUSES[e];return""}},status_type_code:{get:function(){return i.order.status_type_code}}})}return t.TICKET_STATUSES=$.extend({USED:"used"},OneOrder.EXTENDED_ORDER_STATUSES),t.extractTicketFromData=function(t){return t.map(function(t){var e=1===t.tickets.length?t.tickets.shift():t.tickets,n=e.order,i=e.ticket_type;return!n&&t.orders&&(n=t.orders.reduce(function(t,n){return t?t:n.uuid===e.ticket_order_uuid&&n},!1)),!i&&t.ticket_types&&(i=t.ticket_types.reduce(function(t,n){return t?t:n.uuid===e.ticket_type_uuid&&n},!1)),$.extend(e,{event:t,order:n,ticket_type:i})})},t.extractTicketFromEvent=function(e){var n=new OneEvent,i=new t(e.id);return n.setData(e),i.setData($.extend(n.tickets[0],{event:n,event_id:n.id,order:n.orders.getByUUID(n.tickets[0].ticket_order_uuid)})),i},t.fetchTicket=function(t,e,n,i){var a;return n=Fields.parseFields(n),a=$.extend(!0,{},n.pull("event"),{fields:new Fields({tickets:{filters:"uuid="+e,fields:n}})}),__APP.SERVER.getData("/api/v1/events/"+t,a,i)},t.prototype.fetchTicket=function(e,n){var i=this;return t.fetchTicket(this.event_id,this.uuid,e,function(e){var a=t.extractTicketFromData(e);i.setData(a),n&&"function"==typeof n&&n.call(i,a)})},t}()),ExtendedTicketsCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneExtendedTicket,t.extractTicketsFromEvent=function(e){var n=new OneEvent,i=new t;return n.setData(e),i.setData(n.tickets.map(function(t){return $.extend({},t,{event_id:n.id,event:n})})),i},t}()),MyTicketsCollection=extending(ExtendedTicketsCollection,function(){function t(){ExtendedTicketsCollection.call(this)}return t.fetchTickets=function(t,e){t=t?t:{};var n,i={};return t.fields&&(t.fields=Fields.parseFields(t.fields),t.fields.has("event")&&(i=t.fields.pull("event"))),i.length=t.length,i.offset=t.offset,t.length=0,t.offset=void 0,n=new Fields({tickets:t}),i.fields?(i.fields=Fields.parseFields(i.fields),i.fields.push(n)):i.fields=n,i.registered=!0,__APP.SERVER.getData("/api/v1/events",i,e)},t.prototype.fetchTickets=function(e,n,i,a){var o=this;return t.fetchTickets({fields:e||void 0,offset:this.length,length:n||void 0,order_by:i||void 0}).then(function(t){return o.setData(OneExtendedTicket.extractTicketFromData(t)),a&&"function"==typeof a&&a.call(o,o.last_pushed),o.last_pushed})},t}()),OneTicketType=extending(OneEntity,function(){function t(t,e){this.uuid=setDefaultValue(e,0),this.event_id=setDefaultValue(t,0),this.type_code=null,this.name=null,this.comment=null,this.price=null,this.sell_start_date=null,this.sell_end_date=null,this.start_after_ticket_type_uuid=null,this.amount=null,this.min_count_per_user=null,this.max_count_per_user=null,this.promocode=null,this.promocode_effort=null}return t.fetchTicketType=function(t,e,n,i){return __APP.SERVER.getData("/api/v1/events/"+t+"/ticket_types/"+e,{fields:n},i)},t.prototype.fetchOrder=function(e,n){var i=this;return t.fetchTicketType(this.event_id,this.uuid,e,function(t){i.setData(t),n&&"function"==typeof n&&n.call(i,t)})},t}()),TicketTypesCollection=extending(EntitiesCollection,function(){function t(t){EntitiesCollection.call(this),this.event_id=setDefaultValue(t,0)}return t.prototype.collection_of=OneTicketType,t.fetchTicketTypes=function(t,e,n){return __APP.SERVER.getData("/api/v1/events/"+t+"/ticket_types",e,n)},t.prototype.fetchTicketTypes=function(e,n,i,a){var o=this;return t.fetchTicketTypes(this.event_id,{fields:e||void 0,offset:this.length,length:n||void 0,order_by:i||void 0},function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,o.last_pushed)})},t}()),OneUser=extending(OneEntity,function(){function t(t){var e=this;this.id=setDefaultValue(t,0),this.first_name=null,this.last_name=null,this.middle_name=null,this.gender=null,this.avatar_url=null,this.blurred_image_url=null,this.link=null,this.type=null,this.role=null,this.is_friend=null,this.is_editor=null,this.accounts=[],this.accounts_links={},this.vk_uid=null,this.google_uid=null,this.facebook_uid=null,this.subscriptions=new OrganizationsCollection,this.favored=new FavoredEventsCollection,this.actions=new UsersActivitiesCollection(t),Object.defineProperty(this,"full_name",{enumerable:!0,get:function(){return e.first_name+" "+e.last_name}})}return t.prototype.subscriptions_fields=["img_small_url","subscribed_count","new_events_count","actual_events_count"],Object.freeze(t.prototype.subscriptions_fields),t.ROLE={UNAUTH:"unauth",USER:"user",MODERATOR:"moderator",ADMIN:"admin"},Object.freeze(t.ROLE),t.GENDER={MALE:"male",FEMALE:"female",NEUTRAL:"neutral"},Object.freeze(t.GENDER),t.ACCOUNTS={VK:"vk",GOOGLE:"google",FACEBOOK:"facebook"},Object.freeze(t.ACCOUNTS),t.fetchUser=function(t,e,n){return __APP.SERVER.getData("/api/v1/users/"+t,{fields:e},n)},t.fetchFavored=function(t,e,n){return __APP.SERVER.getData("/api/v1/users/"+t+"/favorites",e,n)},t.fetchSubscriptions=function(t,e,n){return __APP.SERVER.getData("/api/v1/users/"+t+"/subscriptions",e,n)},t.fetchUserActivity=function(t,e,n){return UsersActivitiesCollection.fetch(t,{fields:e},n)},t.recognizeRole=function(e){var n=t.ROLE.USER;return e.forEach(function(e){1!=e.role_id&&e.name!=t.ROLE.ADMIN||(n=t.ROLE.ADMIN),2!=e.role_id&&e.name!=t.ROLE.MODERATOR||n===t.ROLE.ADMIN||(n=t.ROLE.MODERATOR)}),n?n:t.ROLE.UNAUTH},t.prototype.fetchUser=function(e,n){var i=this;return e=setDefaultValue(e,[]),t.fetchUser(i.id,e,function(t){t=t instanceof Array?t[0]:t,i.setData(t),n&&"function"==typeof n&&n.call(i,t)})},t.prototype.fetchFavored=function(e,n){var i=this;return e.offset=this.favored.length,t.fetchFavored(i.id,e).done(function(t){i.favored.setData(t),n&&"function"==typeof n&&n.call(i,i.favored.last_pushed)}).promise()},t.prototype.fetchSubscriptions=function(e,n){var i=this;return e.offset=this.subscriptions.length,t.fetchSubscriptions(i.id,e).done(function(t){i.subscriptions.setData(t),n&&"function"==typeof n&&n.call(i,i.subscriptions.last_pushed)}).promise()},t}()),CurrentUser=extending(OneUser,function(){function t(){return"object"==typeof t.instance?t.instance:(OneUser.call(this,"me"),this.selected_city=new OneCity,this.friends=new UsersCollection,this.friends_activities=new e,void(t.instance=this))}var e=extending(UsersActivitiesCollection,function(){function t(){}return t.fetch=function(t,e){return t=UsersActivitiesCollection.setDefaultData(t),t.fields=t.fields.merge(["user"]),__APP.SERVER.getData("/api/v1/users/feed",t,e)},t}());return t.fetchFriends=function(t,e){return __APP.SERVER.getData("/api/v1/users/friends",t,e)},t.prototype.fetchUser=function(t,e){var n=this,i=OneUser.fetchUser("me",t),a=function(t){t=t instanceof Array?t[0]:t,n.setData(t),e&&"function"==typeof e&&e.call(n,t)};return t=setDefaultValue(t,[]),t.hasOwnProperty("friends")?__APP.SERVER.multipleAjax(i,this.fetchFriends(t.friends)).done(function(t,e){t=t instanceof Array?t[0]:t,t.friends=e,a(t)}).promise():i.done(a).promise()},t.prototype.fetchFriends=function(e,n){var i=this;return e=$.extend(e,{offset:i.friends.length}),t.fetchFriends(e,function(t){i.friends.setData(t),n&&"function"==typeof n&&n.call(i,i.friends.last_pushed)})},t.prototype.logout=function(){return $.ajax({url:"/index.php",data:{logout:!0},complete:function(){window.location="/"}})},t.prototype.isLoggedOut=function(){return this.id===-1},t.prototype.subscribeToOrganization=function(t,e){var n=this;return n.subscriptions.has(t)?(console.warn("Current user is already subscribed to this organization"),null):(OneOrganization.fetchOrganization(t,n.subscriptions_fields,function(t){n.subscriptions.push(t[0]),e&&"function"==typeof e&&e.call(n,t)}),OneOrganization.subscribeOrganization(t))},t.prototype.unsubscribeFromOrganization=function(t,e){var n=this;return n.subscriptions.has(t)?OneOrganization.unsubscribeOrganization(t,function(){n.subscriptions.remove(t),e&&"function"==typeof e&&e.call(n,t)}):(console.warn("Current user isn`t subscribed to this organization"),null)},t}()),UsersCollection=extending(EntitiesCollection,function(){function t(){EntitiesCollection.call(this)}return t.prototype.collection_of=OneUser,t.getSpecificStaff=function(t,e){return e.filter(function(e){return e.role===t})},t.fetchUsers=function(t,e){return __APP.SERVER.getData("/api/v1/users/",t,e)},t.fetchEventFavorites=function(t,e,n){return __APP.SERVER.getData("/api/v1/events/"+t,{fields:"favored".appendAjaxData(__APP.SERVER.validateData(e))},function(t){e.length&&e.offset&&(e.offset+=e.length),n&&"function"==typeof n&&n(t[0].favored)})},t.fetchOrganizationSubscribers=function(t,e,n){return __APP.SERVER.getData("/api/v1/organizations/"+t,{fields:"subscribed".appendAjaxData(__APP.SERVER.validateData(e))},function(t){e.length&&e.offset&&(e.offset+=e.length),n&&"function"==typeof n&&n(t[0].subscribed)})},t.fetchOrganizationStaff=function(t,e,n){return __APP.SERVER.getData("/api/v1/organizations/"+t+"/staff/",e,n)},t.prototype.getSpecificStaff=function(e){return t.getSpecificStaff(e,this)},t.prototype.fetchUsers=function(e,n,i){var a=this,o=$.extend(e,{offset:this.length,length:n});return t.fetchUsers(o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},t.prototype.fetchEventFavorites=function(e,n,i,a){var o=this,s=$.extend({},i,{offset:this.length,length:n});return t.fetchEventFavorites(e,s,function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,t)})},t.prototype.fetchOrganizationSubscribers=function(t,e,n,i){var a=this,o=$.extend({},n,{offset:this.length,length:e});return this.constructor.fetchOrganizationSubscribers(t,o,function(t){a.setData(t),i&&"function"==typeof i&&i.call(a,t)})},t.prototype.fetchOrganizationStaff=function(e,n,i,a){var o=this,s=$.extend({},i,{offset:this.length,length:n});return t.fetchOrganizationStaff(e,s,function(t){o.setData(t),a&&"function"==typeof a&&a.call(o,t)})},t}()),Calendar=function(){function t(e,n){if(this.options={classes:{wrapper_class:"calendar_wrapper",header_class:"calendar_header",prev_btn_class:"calendar_prev_btn",next_btn_class:"calendar_next_btn",month_name_class:"calendar_month_name",table_class:"calendar_month",thead_class:"calendar_thead",tbody_class:"calendar_tbody",tr_class:"calendar_week",head_tr_class:"calendar_weekdays_row",th_class:"calendar_weekday",td_class:"calendar_day",td_additional_classes:[],td_disabled_class:"-disabled",table_cell_class:"calendar_cell",today_class:"today"},additional_dataset:{},selection_type:t.SELECTION_TYPES.SINGLE,weekday_selection:!1,month_selection:!1,disable_selection:!1,min_date:!1,max_date:!1,locale:"ru",labels:{}},e instanceof Element||"string"==typeof e){if(e=$(e),0===e.length)throw new Error("Такого элемента не существует");if(e.length>1)throw new Error("Элементов с заданным аргументов найдено несколько")}if(!(e instanceof jQuery))throw new TypeError("Аргумент должен быть экземпляром jQuery, элементом DOM, либо CSS селектором");$.extend(!0,this.options,n,e.data()),this.options.min_date!==!1&&this.options.max_date!==!1&&moment(this.options.max_date).diff(this.options.min_date,"days")<=0&&(this.options.max_date=!1),this.options.weekday_selection!==!0&&this.options.month_selection!==!0||(this.options.selection_type=t.SELECTION_TYPES.MULTI),this.selected_days=[],this.selected_weeks={},this.selected_months=[],this.last_action="",this.last_selected_days="",this.now_selected_day="",this.prev_selected_day="",this.formatted_days={},this.$calendar=e,this.current_month=moment(new Date),this._today=moment(new Date)}return t.SELECTION_TYPES={SINGLE:"single",MULTI:"multi"},t.prototype.flush=function(){this.selected_days=[],this.selected_weeks={},this.selected_months=[],this.last_action="",this.last_selected_days="",this.now_selected_day="",this.prev_selected_day="",this.formatted_days={},this.destroyTable()},t.prototype.setMonth=function(t,e){switch(t){case"prev":this.current_month=this.current_month.add(-1,"months");break;case"next":this.current_month=this.current_month.add(1,"months");break;case"current":this.current_month=moment(new Date);break;default:this.current_month=e?this.current_month.set({year:e,month:t-1}):this.current_month.month(t-1)}return this.renderTable(),this.$calendar.trigger("month-changed"),this},t.prototype.destroyTable=function(){return this.$calendar.find("."+this.options.classes.th_class).removeClass(__C.CLASSES.ACTIVE).off("click"),this.$calendar.find(".MonthName").removeClass(__C.CLASSES.ACTIVE).off("click"),this.$calendar.find(".CalendarTableBody").remove(),this},t.prototype.setMonthName=function(){return this.$calendar.find(".MonthName").data("month",this.current_month.month()).text(this.current_month.format("MMMM YYYY").capitalize()),this},t.prototype.buildTable=function(){var t,e,n=this.$calendar.find(".CalendarTable"),i=this.current_month.daysInMonth(),a=this.current_month.date(1).day(),o=this.current_month.date(i).day(),s=[],r=[],l=[];for(var c in this.options.additional_dataset)this.options.additional_dataset.hasOwnProperty(c)&&l.push("data-"+c+"="+this.options.additional_dataset[c]);for(var d=1;d<=i;d++)this.current_month.date(d),t=this.current_month.format(__C.DATE_FORMAT),e=moment(t),r=[this.options.classes.table_cell_class,this.options.classes.td_class,"Day_"+t,"DayOfWeek_"+this.current_month.day(),"DayOfMonth_"+this.current_month.month()].concat(this.options.classes.td_additional_classes),(this.options.min_date===!1||e.diff(this.options.min_date,"d")>=0)&&(this.options.max_date===!1||e.diff(this.options.max_date,"d")<=0)||r.push(this.options.classes.td_disabled_class),this.current_month.format(__C.DATE_FORMAT)==this._today.format(__C.DATE_FORMAT)&&r.push(this.options.classes.today_class),s.push(tmpl("calendar-div",{td_classes:r.join(" "),number:this.current_month.date(),day_number:this.current_month.day(),date:this.current_month.format(__C.DATE_FORMAT),date_text:this.current_month.format("DD MMMM YYYY"),dataset:l.join(" ")}));var _=this.current_month.clone();if(1!=a){_.add(-1,"months"),_.date(_.daysInMonth());do t=_.format(__C.DATE_FORMAT),e=moment(t),r=[this.options.classes.table_cell_class,this.options.classes.td_class,"Day_"+t,"DayOfWeek_"+_.day(),"DayOfMonth_"+_.month(),"not_this_month"].concat(this.options.classes.td_additional_classes),(this.options.min_date===!1||e.diff(this.options.min_date,"d")>=0)&&(this.options.max_date===!1||e.diff(this.options.max_date,"d")<=0)||r.push(this.options.classes.td_disabled_class),s.unshift(tmpl("calendar-div",{td_classes:r.join(" "),number:_.date(),day_number:_.day(),date:_.format(__C.DATE_FORMAT),date_text:_.format("DD MMMM YYYY"),dataset:l.join(" ")})),_.add(-1,"days");while(0!=_.day())}if(0!=o){_=this.current_month.clone();do _.add(1,"days"),t=_.format(__C.DATE_FORMAT),e=moment(t),r=[this.options.classes.table_cell_class,this.options.classes.td_class,"Day_"+t,"DayOfWeek_"+_.day(),"DayOfMonth_"+_.month(),"not_this_month"].concat(this.options.classes.td_additional_classes),(this.options.min_date===!1||e.diff(this.options.min_date,"d")>=0)&&(this.options.max_date===!1||e.diff(this.options.max_date,"d")<=0)||r.push(this.options.classes.td_disabled_class),s.push(tmpl("calendar-div",{td_classes:r.join(" "),number:_.date(),day_number:_.day(),date:_.format(__C.DATE_FORMAT),date_text:_.format("DD MMMM YYYY"),dataset:l.join(" ")}));while(0!=_.day())}for(var u=$("<tbody>").addClass("CalendarTableBody"),f=0,h=0,p=[tmpl("calendar-row",{tr_class:this.options.classes.tr_class})],S=0;S<s.length;S++)7==f&&(p.push(tmpl("calendar-row",{tr_class:this.options.classes.tr_class})),f=0,h++),p[h].append(s[S]),f++;return p.forEach(function(t){u.append(t)}),n.append(u),this},t.prototype.renderTable=function(){if(this.destroyTable().buildTable().activateSelectedDays().setMonthName(),!this.options.disable_selection){switch(this.options.selection_type){case t.SELECTION_TYPES.MULTI:this.bindDragSelection();break;case t.SELECTION_TYPES.SINGLE:this.bindDaySelection()}this.options.weekday_selection===!0&&this.bindWeekdaySelection(),this.options.month_selection===!0&&this.bindMonthSelection()}return this},t.prototype.selectToday=function(){return this.$calendar.find("."+this.options.classes.td_class+"."+this.options.classes.today_class).addClass(__C.CLASSES.ACTIVE),this},t.prototype.formatDays=function(){var t={"январь":"января","февраль":"февраля","март":"марта","апрель":"апреля","май":"мая","июнь":"июня","июль":"июля","август":"августа","сентябрь":"сентября","октябрь":"октября","ноябрь":"ноября","декабрь":"декабря"},e=moment(this.now_selected_day),n=e.month(),i=e.month(n),a=i.daysInMonth(),o=i.date(1);for("undefined"==typeof this.formatted_days[n]&&(this.formatted_days[n]={},this.formatted_days[n].selected_days=[],this.formatted_days[n].month_name=t[e.format("MMMM")]),this.formatted_days[n].selected_days.push(e.format(__C.DATE_FORMAT)),this.formatted_days[n].text="";a;)console.log(this.formatted_days[n].selected_days),this.formatted_days[n].selected_days.indexOf(o.format(__C.DATE_FORMAT))!==-1&&(this.formatted_days[n].text+=""+o.format("D")),o=o.add(1,"d"),a--;return console.log(this.formatted_days[n].text),this},t.prototype.selectDays=function(e){function n(e){switch(i.options.selection_type){case t.SELECTION_TYPES.MULTI:i.selected_days.indexOf(e)===-1&&(i.selected_days.push(e),i.selected_days.sort());break;default:case t.SELECTION_TYPES.SINGLE:i.$calendar.find("."+i.options.classes.td_class+"."+__C.CLASSES.ACTIVE).removeClass(__C.CLASSES.ACTIVE),i.selected_days=[e]}i.$calendar.find(".Day_"+e).addClass(__C.CLASSES.ACTIVE)}var i=this;if(Array.isArray(e)){var a=[];e.forEach(function(t){(i.options.min_date===!1||moment(t).diff(i.options.min_date)>=0)&&(i.options.max_date===!1||moment(t).diff(i.options.max_date)<=0)?n(t):a.push(t)}),a.forEach(function(t){e.splice(e.indexOf(t),1)})}else(i.options.min_date===!1||moment(e).diff(i.options.min_date)>=0)&&(i.options.max_date===!1||moment(e).diff(i.options.max_date)<=0)?(n(e),e=[e]):e=[];return e.length&&(i.last_action="select",i.last_selected_days=e,i.$calendar.trigger("days-changed")),this},t.prototype.deselectDays=function(e){function n(t){var e,n=i.$calendar.find(".Day_"+t),a=i.$calendar.find(".Week_"+n.data("weekday")),o=i.$calendar.find(".MonthName"),s=i.current_month.format("YYYY"),r=i.current_month.format("MM"),l=i.current_month.format("YYYY.MM");i.selected_days.splice(i.selected_days.indexOf(t),1),i.selected_days.sort(),i.selected_months.indexOf(l)!==-1&&(o.removeClass(__C.CLASSES.ACTIVE),i.selected_months.splice(i.selected_months.indexOf(l),1)),"undefined"!=typeof i.selected_weeks[s]&&"undefined"!=typeof i.selected_weeks[s][r]&&(e=i.selected_weeks[s][r].indexOf(n.data("weekday")),e!==-1&&(a.removeClass(__C.CLASSES.ACTIVE),i.selected_weeks[s][r].splice(e,1))),i.$calendar.find(".Day_"+t).removeClass(__C.CLASSES.ACTIVE)}var i=this;return this.options.selection_type===t.SELECTION_TYPES.MULTI&&(Array.isArray(e)?e.forEach(function(t){n(t)}):n(e),i.last_action="deselect",i.last_selected_days=e,i.$calendar.trigger("days-changed")),this},t.prototype.selectWeek=function(t){var e,n=this,i=n.$calendar.find(".Week_"+t),a=n.$calendar.find(".DayOfWeek_"+t).not(".not_this_month"),o=n.current_month.format("YYYY"),s=n.current_month.format("MM"),r=[];return a.each(function(t){r.push(a.eq(t).data("date"))}),"undefined"==typeof n.selected_weeks[o]&&(n.selected_weeks[o]={}),"undefined"==typeof n.selected_weeks[o][s]&&(n.selected_weeks[o][s]=[]),e=n.selected_weeks[o][s].indexOf(t),e===-1?(i.addClass(__C.CLASSES.ACTIVE),n.selectDays(r),n.selected_weeks[o][s].push(t)):(i.removeClass(__C.CLASSES.ACTIVE),n.deselectDays(r),n.selected_weeks[o][s].splice(e,1)),this},t.prototype.selectMonth=function(t){var e=this,n=e.$calendar.find(".MonthName"),i=e.$calendar.find(".DayOfMonth_"+t),a=e.current_month.format("YYYY.MM"),o=e.selected_months.indexOf(a),s=[];return i.each(function(t){s.push(i.eq(t).data("date"))}),o===-1?(n.addClass(__C.CLASSES.ACTIVE),e.selectDays(s),e.selected_months.push(a)):(n.removeClass(__C.CLASSES.ACTIVE),e.deselectDays(s),e.selected_months.splice(o,1)),this},t.prototype.bindMonthArrows=function(){var t=this;return this.$calendar.find(".NextMonth").off("click.NextMonth").on("click.NextMonth",function(){t.setMonth("next")}),this.$calendar.find(".PrevMonth").off("click.PrevMonth").on("click.PrevMonth",function(){t.setMonth("prev")}),this},t.prototype.bindDaySelection=function(){var e=this,n=e.$calendar.find("."+this.options.classes.td_class),i=n.not("."+this.options.classes.td_disabled_class);return n.off("click.bindDaySelection"),i.on("click.bindDaySelection",function(){e.options.selection_type===t.SELECTION_TYPES.MULTI&&$(this).hasClass(__C.CLASSES.ACTIVE)?e.deselectDays($(this).data("date")):e.selectDays($(this).data("date"))}),this},t.prototype.bindWeekdaySelection=function(){var t=this,e=t.$calendar.find("."+this.options.classes.th_class);return e.on("click",function(){t.selectWeek($(this).data("weekday"))}),this},t.prototype.bindMonthSelection=function(){var t=this,e=t.$calendar.find(".MonthName");return e.on("click",function(){t.selectMonth($(this).data("month"))}),this},t.prototype.bindDragSelection=function(){function t(t){t=t.is("."+n.options.classes.td_class)?t:t.closest("."+n.options.classes.td_class),t.not("."+n.options.classes.td_disabled_class).length&&(t.hasClass(__C.CLASSES.ACTIVE)?n.deselectDays(t.data("date")):n.selectDays(t.data("date")))}function e(){n.$calendar.find("."+n.options.classes.td_class).off("mouseenter.DragSelection")}var n=this;return n.$calendar.off("mousedown.RangeSelection").on("mousedown.RangeSelection",function(e){t($(e.target)),n.$calendar.find("."+n.options.classes.td_class).not("."+n.options.classes.td_disabled_class).on("mouseenter.DragSelection",function(e){e.preventDefault(),t($(e.target))})}).on("mouseup",e).on("mouseleave",e),this},t.prototype.activateSelectedDays=function(){var t=this,e=t.current_month.format("YYYY"),n=t.current_month.format("MM");return t.selected_days.forEach(function(e){t.$calendar.find(".Day_"+e).addClass(__C.CLASSES.ACTIVE)}),t.selected_months.indexOf(e+"."+n)!==-1&&t.$calendar.find(".MonthName").addClass(__C.CLASSES.ACTIVE),"undefined"!=typeof t.selected_weeks[e]&&"undefined"!=typeof t.selected_weeks[e][n]&&t.selected_weeks[e][n].forEach(function(e){t.$calendar.find(".Week_"+e).addClass(__C.CLASSES.ACTIVE)}),this},t.prototype.setDaysWithEvents=function(){var t=this,e={since:t.current_month.startOf("month").format(__C.DATE_FORMAT),till:t.current_month.endOf("month").format(__C.DATE_FORMAT),length:500,my:!0,unique:!0};return t.$calendar.find(".feed_calendar_td").removeClass("Controller has_favorites").addClass(__C.CLASSES.DISABLED),DatesCollection.fetchDates(e,function(e){e.forEach(function(e){var n=t.$calendar.find(".Day_"+moment.unix(e.event_date).format(__C.DATE_FORMAT));n.html(tmpl("link",{title:n.children().text(),classes:n.children().get(0).classList,page:"/feed/day/"+n.data("date")})).addClass(e.favorites_count>0?"has_favorites":"").removeClass(__C.CLASSES.DISABLED)}),t.bindDaySelection(),bindPageLinks(t.$calendar)}),this},t.prototype.init=function(){return this.$calendar.empty().append(tmpl("calendar",this.options.classes)),this.options.weekday_selection&&this.$calendar.addClass("-weekday_selection"),this.options.month_selection&&this.$calendar.addClass("-month_selection"),this.$calendar.data("calendar",this),this.$calendar.data("instance",this),this.$calendar.data("days",this.selected_days),this.$calendar.data("options",this.options),this.bindMonthArrows().renderTable(),this},t}(),DatePicker=function(){function t(t,e){if(this.options={classes:{},close_on_pick:!0,min_date:!1,max_date:!1,labels:{}},t instanceof Element||"string"==typeof t){if(t=$(t),0===t.length)throw new Error("Такого элемента не существует");if(t.length>1)throw new Error("Элементов с заданным аргументов найдено несколько")}if(!(t instanceof jQuery))throw new TypeError("Аргумент должен быть экземпляром jQuery, элементом DOM, либо CSS селектором");$.extend(!0,this.options,e,t.data()),this.$datepicker=t,this.$datepicker_modal=tmpl("datepicker",{}),this.$input=t.is("input")?t:t.find("input"),this.calendar=new Calendar(this.$datepicker_modal.children(".DatePickerCalendar"),{min_date:this.options.min_date,max_date:this.options.max_date}),this.prev_selected_day="undefined"!=typeof this.options.selected_day?this.options.selected_day:"",this.selected_day="undefined"!=typeof this.options.selected_day?this.options.selected_day:"",this.formated_selected_day=this.selected_day.toString().split("-").reverse().join(".")}return t.prototype.init=function(){var t=this;return this.bindOpener().$datepicker.data("datepicker",this).data("instance",this),this.$datepicker.addClass("-unselectable -Handled_DatePicker"),this.calendar.init().$calendar.on("days-changed",function(){t.prev_selected_day=t.selected_day,t.selected_day=t.calendar.selected_days.toString(),t.formated_selected_day=t.calendar.selected_days.toString().split("-").reverse().join("."),t.$datepicker.is("input")||t.$datepicker.find("label").text(t.formated_selected_day),t.$input.val(t.selected_day).trigger("change"),t.options.close_on_pick&&t.closeDialog(),t.$datepicker.trigger("date-picked")}),this},t.prototype.bindOpener=function(){function t(){e.$input.is(":disabled")?e.$datepicker.one("click",t):e.openDialog()}var e=this;return this.$datepicker.one("click",t),this},t.prototype.openDialog=function(){var t=this.$datepicker.offset();return $("body").append(this.$datepicker_modal),this.$datepicker_modal.css({top:t.top+this.$datepicker.outerHeight()+2,left:t.left+this.$datepicker.width()-this.$datepicker_modal.width(),maxWidth:this.$datepicker.width()}),this.calendar.renderTable(),this.bindCloseDialog(),this},t.prototype.bindCloseDialog=function(){var t=this;return $(document).off("click.checkOnClick").on("click.checkOnClick",function(e){var n=$(e.target);(0===n.closest(t.$datepicker_modal).length&&0===n.closest(t.$datepicker).length||n.closest(".SubmitDatePicker").length)&&t.closeDialog()}).off("keydown.checkOnKeyDown").on("keydown.checkOnKeyDown",function(e){9!==e.keyCode&&13!==e.keyCode&&27!==e.keyCode||t.closeDialog()}),this},t.prototype.closeDialog=function(){return $(document).off("click.checkOnClick").off("keydown.checkOnKeyDown"),this.$datepicker_modal.detach(),this.calendar.flush(),this.bindOpener(),this},t.prototype.destroy=function(){return this.closeDialog().$datepicker.data("datepicker",""),this},t}(),ImgLoader=function(){function ImgLoader(){}return ImgLoader.current_load_context=null,ImgLoader.init=function(t){t=t?t:$("body"),t.find(".ImgLoadWrap").each(function(){var t=$(this),e=t.find(".ImgSrc"),n=t.find(".ImgPreview");e.off("change.CroppedPreview").on("change.CroppedPreview",function(){n.attr("src",this.value)}),n.attr("src")&&t.find(".CropperButton").removeClass(__C.CLASSES.HIDDEN),t.find(".LoadImg").off("change.LoadImg").on("change.LoadImg",function(e){var n,i=e.target.files;if(0==i.length)return!1;for(var a,o=0;a=i[o];o++)n=new FileReader,n.onload=function(e){return function(n){var i=n.target.result;ImgLoader.handleImgUpload(t,i,e.name)}}(a),n.readAsDataURL(a)}),t.find(".LoadByURLButton").not("-Handled_LoadByURLButton").on("click.LoadByURL",function(){ImgLoader.current_load_context=t,socket.emit("image.getFromURL",t.find(".LoadByURLAddress").val()),Pace.restart()}).addClass("-Handled_LoadByURLButton"),t.find(".CropperButton").off("click.CallCropper").on("click.CallCropper",function(){
ImgLoader.callImgCropper(t,t.data("src")?t.data("src"):e.val())})})},ImgLoader.callImgCropper=function($context,source){var $parent=$context.closest(".ImgLoadWrap"),$img_source=$parent.find(".ImgSrc"),cropper_modal=$parent.data("modal");return cropper_modal&&cropper_modal.image_src!=source&&cropper_modal.destroy(),cropper_modal&&cropper_modal.image_src==source||($parent.data("src",source),cropper_modal=new CropperModal(source,{aspectRatio:eval($parent.data("aspect_ratio"))}),$parent.data("modal",cropper_modal)),cropper_modal.show(),cropper_modal.modal.on("crop",function(t,e){$img_source.val(e).trigger("change")}),cropper_modal},ImgLoader.handleImgUpload=function(t,e,n){var i=t.closest(".ImgLoadWrap");i.data("src",e),i.find(".FileName").val(n),i.find(".CropperButton").removeClass(__C.CLASSES.HIDDEN),ImgLoader.callImgCropper(i,e)},ImgLoader}(),ActionButton=extendingJQuery(function(){function t(e){e=e?e:{};var n=this;this.options=$.extend(!0,{classes:[],icons:null,colors:null,labels:null},this.options,e),this.has_icon=!e.hasOwnProperty("has_icon")||!!e.has_icon,this.is_checked=!!e.is_checked,this.is_add_avatar=!!e.is_add_avatar,this.has_icon?this.options.classes.push(this.icon_class):this.options.icons={},this.options.icons=this.options.icons?this.options.icons:{},this.options.colors=this.options.colors?this.options.colors:{},this.options.labels=this.options.labels?this.options.labels:{},this.classes={},$.each(t.STATES,function(t,e){n.classes[e]=[].concat(n.options.icons?n.options.icons[e]:[]).concat(n.options.colors?n.options.colors[e]:[]).join(" ")}),jQuery.fn.init.call(this,__APP.BUILD.button(this.is_checked?{classes:this.options.classes.concat(this.classes[t.STATES.CHECKED]).concat(this.checked_state_class?this.checked_state_class:[]),title:this.options.labels[t.STATES.CHECKED]}:{classes:this.options.classes.concat(this.classes[t.STATES.UNCHECKED]),title:this.options.labels[t.STATES.UNCHECKED]})),this.data("instance",this),this.initiate()}function e(t){var e=t.closest("."+__C.CLASSES.HOOKS.ADD_AVATAR.ANCESTOR),n=e.find("."+__C.CLASSES.HOOKS.ADD_AVATAR.COLLECTION),i=e.find("."+__C.CLASSES.HOOKS.ADD_AVATAR.QUANTITY),a=n.find(".avatar"),o=a.length;if(n.data("max_amount")>=o)n.hasClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED)?(n.removeClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED),n.width(1==o?0:a.outerWidth()*(o-1)-6*(o-2))):(n.addClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED),n.width(a.outerWidth()*o-6*(o-1)));else{if(i.length){var s=parseInt(i.text());n.hasClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED)?(i.text(s-1),s-1<=0&&i.parent().addClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.CAST)):(i.text(s+1),i.parent().removeClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.CAST))}n.toggleClass(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFT+" "+__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED)}}return t.STATES={CHECKED:"checked",UNCHECKED:"unchecked",CHECKED_HOVER:"checked_hover",UNCHECKED_HOVER:"unchecked_hover"},t.prototype.checked_state_class="",t.prototype.icon_class=__C.CLASSES.ICON_CLASS,t.prototype.onClick=function(){},t.prototype.afterCheck=function(){var e=this.is(":hover");this.is_checked=!0,this.removeClass("".concat(this.classes[t.STATES.UNCHECKED_HOVER]," ",this.classes[t.STATES.UNCHECKED])).addClass("".concat(this.classes[e?t.STATES.CHECKED_HOVER:t.STATES.CHECKED]," ",this.checked_state_class)).children("."+__C.CLASSES.HOOKS.TEXT).text(this.options.labels[e?t.STATES.CHECKED_HOVER:t.STATES.CHECKED])},t.prototype.afterUncheck=function(){var e=this.is(":hover");this.is_checked=!1,this.removeClass("".concat(this.classes[t.STATES.CHECKED_HOVER]," ",this.classes[t.STATES.CHECKED]," ",this.checked_state_class)).addClass("".concat(this.classes[e?t.STATES.UNCHECKED_HOVER:t.STATES.UNCHECKED])).children("."+__C.CLASSES.HOOKS.TEXT).text(this.options.labels[e?t.STATES.UNCHECKED_HOVER:t.STATES.UNCHECKED])},t.prototype.initiate=function(){var n=this;this.on("mouseenter.HoverActionButton",function(){n.removeClass(n.classes[n.is_checked?t.STATES.CHECKED:t.STATES.UNCHECKED]).addClass(n.classes[n.is_checked?t.STATES.CHECKED_HOVER:t.STATES.UNCHECKED_HOVER]),n.children("."+__C.CLASSES.HOOKS.TEXT).text(n.options.labels[n.is_checked?t.STATES.CHECKED_HOVER:t.STATES.UNCHECKED_HOVER])}).on("mouseleave.LeaveActionButton",function(){n.removeClass(n.classes[n.is_checked?t.STATES.CHECKED_HOVER:t.STATES.UNCHECKED_HOVER]).addClass(n.classes[n.is_checked?t.STATES.CHECKED:t.STATES.UNCHECKED]),n.children("."+__C.CLASSES.HOOKS.TEXT).text(n.options.labels[n.is_checked?t.STATES.CHECKED:t.STATES.UNCHECKED])}).on("click.Action",function(){return __APP.USER.isLoggedOut()?n instanceof SubscribeButton?(cookies.setItem("auth_command","subscribe_to"),cookies.setItem("auth_entity_id",n.org_id),new AuthModal(location.origin+"/organization/"+n.org_id).show()):(n instanceof AddToFavoriteButton?(cookies.setItem("auth_command","add_to_favorite"),cookies.setItem("auth_entity_id",n.event_id)):(cookies.removeItem("auth_command"),cookies.removeItem("auth_entity_id")),new AuthModal(location.origin+"/event/"+n.event_id).show()):(n.onClick(),n.is_add_avatar&&e(n),void(window.askToSubscribe instanceof Function&&window.askToSubscribe()))})},t}()),AddToFavoriteButton=extending(ActionButton,function(){function t(t,e){this.options={labels:{checked:__LOCALES.ru_RU.TEXTS.BUTTON.FAVORED,unchecked:__LOCALES.ru_RU.TEXTS.BUTTON.ADD_FAVORITE,checked_hover:__LOCALES.ru_RU.TEXTS.BUTTON.REMOVE_FAVORITE,unchecked_hover:__LOCALES.ru_RU.TEXTS.BUTTON.ADD_FAVORITE},colors:{checked:__C.CLASSES.COLORS.ACCENT,unchecked:__C.CLASSES.COLORS.MARGINAL_ACCENT,checked_hover:__C.CLASSES.COLORS.ACCENT,unchecked_hover:__C.CLASSES.COLORS.MARGINAL_ACCENT},icons:{checked:__C.CLASSES.ICONS.STAR,unchecked:__C.CLASSES.ICONS.STAR_O,checked_hover:__C.CLASSES.ICONS.TIMES,unchecked_hover:__C.CLASSES.ICONS.STAR_O}},this.event_id=t,ActionButton.call(this,e)}return t.prototype.checked_state_class="-Favored",t.prototype.onClick=function(){var t=this;this.is_checked?OneEvent.deleteFavored(this.event_id,function(){t.afterUncheck()}):OneEvent.addFavored(this.event_id,function(){t.afterCheck()})},t}()),RegisterButton=extending(ActionButton,function(){function t(t,e){this.options={labels:{checked:"Зарегистрирован",unchecked:"Регистрация",checked_hover:"Открыть билеты",unchecked_hover:"Регистрация"},colors:{checked:__C.CLASSES.COLORS.ACCENT,unchecked:__C.CLASSES.COLORS.MARGINAL_ACCENT,checked_hover:__C.CLASSES.COLORS.ACCENT,unchecked_hover:__C.CLASSES.COLORS.MARGINAL_ACCENT},icons:{checked:__C.CLASSES.ICONS.CHECK,unchecked:__C.CLASSES.ICONS.PENCIL,checked_hover:__C.CLASSES.ICONS.TICKET,unchecked_hover:__C.CLASSES.ICONS.PENCIL}},this.event=t,this.modal=null,e.is_checked=t.is_registered,ActionButton.call(this,e)}return t.prototype.checked_state_class="-Registered",t.prototype.onClick=function(){function t(t,e){t.show(),t.modal.one("registration:success",function(){t.event.is_registered=!0,e.afterCheck()})}var e,n,i=this;return this.event.registration_available||this.event.is_registered?void(this.event.is_registered?this.modal&&this.modal instanceof TicketsModal?this.modal.show():(this.event.tickets.length?(e=OneExtendedTicket.extractTicketFromEvent(this.event),n=e.fetchTicket(new Fields("created_at","number","ticket_type","order",{event:{fields:new Fields("dates","is_same_time","image_horizontal_medium_url","location")}}))):n=this.event.fetchEvent(new Fields("dates","is_same_time","image_horizontal_medium_url","location",{tickets:{fields:new Fields("created_at","number","ticket_type","order")}})).done(function(){return e=OneExtendedTicket.extractTicketFromEvent(i.event)}),n.done(function(){i.modal=new TicketsModal(e),i.modal.show()})):this.modal&&this.modal instanceof RegistrationModal?t(this.modal,this):this.event.registration_fields.length?(this.modal=new RegistrationModal(this.event),t(this.modal,this)):this.event.fetchEvent(new Fields("registration_fields")).done(function(){i.modal=new RegistrationModal(i.event),t(i.modal,i)})):(this.off("click.RippleEffect").addClass(__C.CLASSES.HOOKS.HANDLED+__C.CLASSES.HOOKS.RIPPLE),!1)},t.prototype.initiate=function(){this.event.registration_available||this.event.is_registered?ActionButton.prototype.initiate.call(this):this.attr("disabled",!0)},t}()),SubscribeButton=extending(ActionButton,function(){function t(t,e){this.options={labels:{checked:__LOCALES.ru_RU.TEXTS.BUTTON.SUBSCRIBED,unchecked:__LOCALES.ru_RU.TEXTS.BUTTON.ADD_SUBSCRIPTION,checked_hover:__LOCALES.ru_RU.TEXTS.BUTTON.REMOVE_SUBSCRIPTION,unchecked_hover:__LOCALES.ru_RU.TEXTS.BUTTON.ADD_SUBSCRIPTION},colors:{checked:__C.CLASSES.COLORS.ACCENT,unchecked:__C.CLASSES.COLORS.NEUTRAL_ACCENT,checked_hover:__C.CLASSES.COLORS.ACCENT,unchecked_hover:__C.CLASSES.COLORS.NEUTRAL_ACCENT},icons:{checked:__C.CLASSES.ICONS.CHECK,unchecked:__C.CLASSES.ICONS.PLUS,checked_hover:__C.CLASSES.ICONS.TIMES,unchecked_hover:__C.CLASSES.ICONS.PLUS}},this.org_id=t,ActionButton.call(this,e)}return t.prototype.checked_state_class="-Subscribed",t.prototype.onClick=function(){var t=this;t.is_checked?__APP.USER.unsubscribeFromOrganization(t.org_id,function(){t.afterUncheck(),$(window).trigger("unsubscribe",[t.org_id])}):__APP.USER.subscribeToOrganization(t.org_id,function(){t.afterCheck(),$(window).trigger("subscribe",[t.org_id])})},t}()),ModalsCollection=extending(Array,function(){function t(t){this.max_length=t,Object.defineProperty(this,"last_id",{value:0,writable:!0,enumerable:!1,configurable:!1})}return t.prototype.push=function(t){return t instanceof AbstractModal&&(t.id=++this.last_id,this[this.length++]=t,this.length>this.max_length&&this.shift().destroy()),this.length},t}()),Modals=function(){function t(){return"object"==typeof t.instance?t.instance:(this.collection=new ModalsCollection(5),this.active_modal=null,this.modal_wrapper=$(".modal_wrapper"),this.modal_destroyer=new e($(".modal_destroyer")),void(t.instance=this))}var e=extendingJQuery(function(){function t(t){jQuery.fn.init.call(this,t),this.on("click.CloseModal",function(){AbstractModal.hideCurrent()})}return t.prototype.adjustHeight=function(t){var e=$(window).height(),n=t;return this.height(n>e?n:e)},t}());return t.prototype.bindCallModal=bindCallModal,t}(),AbstractModal=function(){function t(e){this.id=0,this.title="",this.type=this.constructor.name,this.style=e?e:t.STYLES.NONE,this.modal=$(),this.content_wrapper=$(),this.content="",this.scrollTop=0,this.wrapper_is_scrollable=!1,this.content_is_scrollable=!1,this.is_upload_disabled=!1,this.is_rendered=!1,this.is_inited=!1,this.is_shown=!1,__APP.MODALS.collection.push(this)}return t.prototype.modal_wrapper=(new Modals).modal_wrapper,Object.defineProperty(t.prototype,"block_scroll",{get:function(){return t.prototype.modal_wrapper.data("block_scroll")},set:function(e){return t.prototype.modal_wrapper.data("block_scroll",e)}}),t.hideCurrent=function(){__APP.MODALS.active_modal&&__APP.MODALS.active_modal.hide()},t.STYLES={NONE:0,OK_ONLY:1,OK_CANCEL:2,ABORT_RETRY_IGNORE:3,YES_NO_CANCEL:4,YES_NO:5,RETRY_CANCEL:6,CRITICAL:10,QUESTION:11,EXCLAMATION:12,INFORMATION:13},Object.freeze(t.STYLES),t.prototype.__render=function(e){var n;switch(this.style){case t.STYLES.OK_ONLY:n=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.PRIMARY,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"OK"});break;case t.STYLES.OK_CANCEL:n=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.PRIMARY,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"OK"},{classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Отмена"});break;case t.STYLES.ABORT_RETRY_IGNORE:n=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.MARGINAL_BUBBLEGUM,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Прервать"},{classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Повтор"},{classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Пропустить"});break;case t.STYLES.YES_NO_CANCEL:n=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.MARGINAL_FRANKLIN,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Да"},{classes:[__C.CLASSES.COLORS.MARGINAL_BUBBLEGUM,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Нет"},{classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Отмена"});break;case t.STYLES.YES_NO:n=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.MARGINAL_FRANKLIN,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Да"},{classes:[__C.CLASSES.COLORS.MARGINAL_BUBBLEGUM,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Нет"});break;case t.STYLES.RETRY_CANCEL:n=__APP.BUILD.button({classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Повтор"},{classes:[__C.CLASSES.COLORS.DEFAULT,__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"Отмена"})}return this.modal=__APP.BUILD.modal($.extend({type:this.type,title:this.title,content:this.content,footer_buttons:n},e)),this.content_wrapper=this.modal.find(".ModalContent"),this.is_rendered=!0,this.content||(this.content=this.content_wrapper.children()),this},t.prototype.__init=function(){function e(t){t.is_upload_disabled||t.block_scroll||(t.block_scroll=!0,t.onScrollToBottom(function(){t.block_scroll=!1,t.adjustDestroyerHeight()}))}var n=this;return this.is_rendered?(this.modal.find(".CloseModal").on("click.CloseModal",function(){t.hideCurrent()}),$(document).on("keyup.CloseModal",function(e){27==e.keyCode&&($(this).off("keyup.CloseModal"),t.hideCurrent())}),this.wrapper_is_scrollable&&this.onScrollToBottom!=t.prototype.onScrollToBottom&&this.modal_wrapper.on("scroll",function(){n.modal_wrapper.height()+n.modal_wrapper.scrollTop()>=n.modal.height()&&e(n)}),this.content_is_scrollable&&(this.content.scrollbar({onScroll:this.onScrollToBottom!=t.prototype.onScrollToBottom?function(t){t.scroll==t.maxScroll&&e(n)}:void 0}),this.modal.on("modal:disappear",function(){n.content.scrollTop(0)})),this.is_inited=!0,this):(console.error("Modal has not been rendered yet"),this)},t.prototype.__show=function(){var e=this;return this.is_rendered?(t.hideCurrent(),$("body").addClass("-open_modal"),__APP.MODALS.active_modal=this,this.modal_wrapper.append(this.modal.addClass("-faded").removeClass(__C.CLASSES.HIDDEN)),this.adjustDestroyerHeight(),this.modal.trigger("modal:show"),setTimeout(function(){e.modal.removeClass("-faded"),e.modal_wrapper.scrollTop(e.scrollTop),e.modal.trigger("modal:appear"),e.is_shown=!0},200),this.is_inited||this.init(),this):this.render().show()},t.prototype.__hide=function(){var t=this;return this.scrollTop=this.modal_wrapper.scrollTop(),$(document).off("keyup.CloseModal"),$("body").removeClass("-open_modal"),__APP.MODALS.active_modal=void 0,this.modal.addClass("-faded"),this.modal.trigger("modal:disappear"),setTimeout(function(){t.modal.addClass(__C.CLASSES.HIDDEN).trigger("modal:close"),t.is_shown=!1},200),this},t.prototype.onScrollToBottom=function(t){return t.call(this),this},t.prototype.adjustDestroyerHeight=function(){return __APP.MODALS.modal_destroyer.adjustHeight(this.modal.outerHeight(!0)),this},t.prototype.render=function(){return this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL]})},t.prototype.init=function(){return this.__init()},t.prototype.show=function(){return this.__show()},t.prototype.hide=function(){return this.__hide()},t.prototype.destroyNested=function(){return this},t.prototype.destroy=function(){var t=__APP.MODALS.collection.indexOf(this);return this.hide(),__APP.MODALS.modal_wrapper.trigger("modal.beforeDestroy"),this.destroyNested(),this.modal.remove(),t!=-1&&__APP.MODALS.collection.splice(t,1),__APP.MODALS.modal_wrapper.trigger("modal.afterDestroy"),this},t}(),AddStaffModal=extending(AbstractModal,function(){function t(t,e){AbstractModal.call(this),this.org_id=t,this.organization=new OneOrganization(this.org_id),this.role=e}return t.prototype.render=function(){return this.content=tmpl("modal-add-staff-content",{modal_id:this.id,org_id:this.org_id,role:this.role}),this.__render({width:380,classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.SIZE.TINY],content_classes:[__C.CLASSES.ALIGN.CENTER]}),this},t.prototype.init=function(){var t=this,e=this.content.find(".SearchByName");return bindRippleEffect(this.content),e.select2({width:"100%",placeholder:e.attr("placeholder"),ajax:{url:"/api/v1/users/",dataType:"JSON",data:function(t,e,n){return{name:t}},results:function(t,e,n){return{results:t.data.map(function(t){return{id:t.id,text:[t.last_name,t.first_name,t.middle_name].join(" ").trim()}})}}},dropdownCssClass:"form_select2_drop"}),this.content.find(".AddStaff").on("click",function(){var e=$(this).closest("form").serializeForm();t.organization.addStaff(e.user_id,e.role,function(n){__APP.CURRENT_PAGE.$view.trigger("staff:add",[e.role,n]),t.hide()})}),this},t}()),AuthModal=extending(AbstractModal,function(){function t(t){AbstractModal.call(this),this.content=tmpl("modal-auth-content",{heading:"Войдите через социальную сеть, чтобы совершить это действие"}),this.redirect_to=t}return t.prototype.render=function(){return this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.SIZE.TINY],content_classes:[__C.CLASSES.ALIGN.CENTER]}),this},t.prototype.init=function(){var t=this;return this.modal.find(".AuthButton").each(function(){$(this).on("click",function(e){var n=$(this).data("auth_network"),i=__APP.AUTH_URLS[n];yaCounter32442130&&yaCounter32442130.reachGoal(n.toUpperCase()+"AuthStart"),i=i+(i.indexOf("?")?"&":"?")+"redirect_to="+encodeURIComponent(t.redirect_to),isNotDesktop()?window.location.href=i:window.open(i,n.toUpperCase()+"_AUTH_WINDOW","status=1,toolbar=0,menubar=0&height=500,width=700"),e.preventDefault()})}),bindRippleEffect(this.modal),this},t}()),CityChooseModal=extending(AbstractModal,function(){function t(t){AbstractModal.call(this,AbstractModal.STYLES.OK_ONLY),this.cities=t,this.title="Выбор города"}return t.prototype.show=function(){var t=this;return this.cities?(this.__show(),this):(this.cities=new CitiesCollection,this.cities.fetchCities("timediff_seconds",0,"distance,local_name",function(){t.__show()}),this)},t.prototype.render=function(){return this.content=tmpl("modal-city-choose-content",{cities:tmpl("option",this.cities.map(function(t){return{val:t.id,display_name:t.local_name}}))}),this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL],width:400}),this},t.prototype.init=function(){return this.content.find("#city_choose_modal_select").select2({containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}).select2("val",1),this.__init(),this},t.prototype.hide=function(){__APP.USER.selected_city=this.cities.getByID(this.content.find("#city_choose_modal_select").val());try{localStorage.setItem("selected_city",JSON.stringify(__APP.USER.selected_city))}catch(t){}return this.__hide(),__APP.reload(),this},t}()),CropperModal=extending(AbstractModal,function(){function t(t,e){if(AbstractModal.call(this),!t)throw Error("To initiate cropper you need to pass image source (image_src)");e="object"==typeof e?e:{},this.image_src=t,this.content=tmpl("modal-cropper-content",{image_src:this.image_src}),this.options=$.extend({viewMode:1,responsive:!1,scalable:!1,zoomable:!1,zoomOnWheel:!1},e)}return t.prototype.render=function(){var t=this,e=this.content;return this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.SIZE.WIDE],content_classes:[__C.CLASSES.MODAL_STATES.NO_PADDING,__C.CLASSES.IMG_HOLDER],footer_buttons:tmpl("button",[{classes:[__C.CLASSES.COLORS.PRIMARY,"CropButton",__C.CLASSES.HOOKS.RIPPLE].join(" "),title:"Кадрировать"},{classes:[__C.CLASSES.COLORS.DEFAULT,"DestroyCropButton",__C.CLASSES.HOOKS.RIPPLE].join(" "),title:"Отмена"}])}),e.on("load",function(){e.cropper(t.options)}).attr("src",this.image_src),this},t.prototype.init=function(){var t=this;return this.modal.find(".CropButton").on("click.Crop",function(){t.crop(),t.hide()}),this.modal.find(".DestroyCropButton").on("click.DestroyCrop",function(){t.hide()}),this},t.prototype.destroyNested=function(){return this.content.cropper("destroy"),this.modal.find(".CropButton").off("click.Crop"),this.modal.find(".DestroyCropButton").off("click.DestroyCrop"),this},t.prototype.crop=function(){return this.modal.trigger("crop",[this.content.cropper("getCroppedCanvas").toDataURL()]),this},t}()),MapModal=extending(AbstractModal,function(){function t(t){if(AbstractModal.call(this),!t)throw Error("To initiate map you need to pass location (location)");this.location=t,this.content=tmpl("modal-map-content",{location:t})}return t.prototype.render=function(){return this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.SIZE.WIDE],content_classes:[__C.CLASSES.MODAL_STATES.NO_PADDING]}),this},t}()),MediaModal=extending(AbstractModal,function(){function t(t,e){if(AbstractModal.call(this),!t)throw Error("To open media you need to pass media source (src)");"image"===e&&(this.content=tmpl("modal-image-media-content",{src:t})),this.src=t,this.format=e?e:"image"}return t.prototype.render=function(){return this.__render({classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.SIZE.RESPONSIVE],content_classes:[__C.CLASSES.IMG_HOLDER,__C.CLASSES.MODAL_STATES.NO_PADDING]}),this},t.prototype.show=function(){var t=this;return this.content.on("load",function(){t.adjustDestroyerHeight()}),this.__show(),this},t}()),StdModal=extending(AbstractModal,function(){function t(t,e,n){AbstractModal.call(this,n),this.title=t,this.content=e}return t.STYLES=AbstractModal.STYLES,Object.freeze(t.STYLES),t}()),TicketsModal=extending(AbstractModal,function(){function t(t){if(AbstractModal.call(this),t instanceof ExtendedTicketsCollection)this.tickets=t;else{if(!(t instanceof Array||t instanceof OneExtendedTicket))throw Error("Constructor needs instance of OneExtendedTicket class to create new instance of TicketsModal");this.tickets=new ExtendedTicketsCollection,this.tickets.setData(t)}this.width=450}return t.prototype.render=function(){var t=this;return this.content=tmpl("modal-ticket-content",Builder.normalizeTicketProps(this.tickets).map(function(e,n){var i=t.tickets[n].order.payed_at||t.tickets[n].created_at;return e.card_classes.push("-ticket_extended"),$.extend(e,{number_formatted:formatTicketNumber(t.tickets[n].number),payed_at_formatted:(t.tickets[n].order.payed_at?"Куплен ":"Приобретен ")+moment.unix(i).format(__LOCALES.ru_RU.DATE.DATE_TIME_FORMAT),price_formatted:+t.tickets[n].price?formatCurrency(t.tickets[n].price," ",".","","руб."):"Бесплатно"})})),this.__render({width:this.width,content_classes:[__C.CLASSES.FLOATING_MATERIAL,__C.CLASSES.MODAL_STATES.NO_PADDING]}),this},t}()),AbstractListModal=extending(AbstractModal,function(){function t(t){AbstractModal.call(this),this.content=tmpl("modal-list-content"),this.entity=t,this.entities=new EntitiesCollection,this.content_is_scrollable=!0}return t.prototype.render=function(){return this.__render({width:384,height:"calc(100% - 140px)",classes:["material","-floating","-fixed"],content_classes:["list_modal_content"]}),this},t.prototype.uploadEntities=function(){return $.Deferred.resolve().promise()},t.prototype.buildEntities=function(t){return $()},t.prototype.show=function(){var t=this;return this.content.children().length?(this.__show(),this):(this.render(),this.content.append(this.buildEntities(this.entities)),this.entities.length<5?this.uploadEntities().done(function(){t.__show()}):this.__show(),this)},t.prototype.onScrollToBottom=function(t){var e=this,n=__APP.BUILD.loaderBlock(this.content);return this.uploadEntities().fail(function(){e.block_scroll=!1}).done(function(){n.remove(),t.call(e)}),this},t}()),FriendsListModal=extending(AbstractListModal,function(){function t(e){return"object"==typeof t.instance?t.instance:(AbstractListModal.call(this,e),this.title="Подписки на пользователей",this.entities=this.entity.friends,void(t.instance=this))}return t.prototype.uploadEntities=function(){var t=this;return __APP.USER.fetchFriends({length:20}).done(function(e){e.length?t.content.append(t.buildEntities(e)):t.is_upload_disabled=!0}).promise()},t.prototype.buildEntities=function(t){var e=__APP.BUILD.avatarBlocks(t,{is_link:!0,entity:"user",avatar_classes:["-size_40x40","-rounded"]});return bindPageLinks(e),e},t}()),SubscriptionsListModal=extending(AbstractListModal,function(){function t(t){AbstractListModal.call(this,t),this.title="Подписки на организации",this.entities=this.entity.subscriptions}return t.prototype.uploadEntities=function(){var t=this;return this.entity.fetchSubscriptions({length:20}).done(function(e){e.length?t.content.append(t.buildEntities(e)):t.is_upload_disabled=!0}).promise()},t.prototype.buildEntities=function(t){var e=__APP.BUILD.avatarBlocks(t,{is_link:!0,entity:"organization",avatar_classes:["-size_40x40","-rounded"]});return bindPageLinks(e),e},t}()),PreviewRegistrationModal=extending(AbstractModal,function(){function t(t){AbstractModal.call(this),this.event=t,this.title="Регистрация"}return t.prototype.render=function(){var t=this;return this.__render({classes:["material","-floating"],width:400,content:tmpl("modal-registration-content",{modal_id:this.id,required_star:tmpl("required-star"),event_title:this.event.title,fields:$.makeSet(this.event.registration_fields.map(t.buildRegistrationField.bind(t)))})}),this},t.prototype.init=function(){return this.content.find(".RegisterButton").prop("disabled",!0),this.__init(),this},t.prototype.buildRegistrationField=function(t){return __APP.BUILD.formInput({id:"registration_form_"+this.id+"_"+t.uuid,type:t.type===RegistrationFieldModel.TYPES.EXTENDED_CUSTOM?"textarea":t.type,name:t.uuid,classes:["Registration"+t.type.toCamelCase("_")+"Field"],label:$("<span>"+t.label+"</span>").add(t.required?tmpl("required-star"):$()),placeholder:t.label,required:t.required,helptext:function(t){switch(t){case RegistrationFieldModel.TYPES.EMAIL:return"На почту Вам поступит сообщение с подтверждением регистрации";case RegistrationFieldModel.TYPES.FIRST_NAME:return"Используйте настоящее имя для регистрации";case RegistrationFieldModel.TYPES.LAST_NAME:return"Используйте настоящюю фамилию для регистрации";default:return""}}(t.type)})},t}()),RegistrationModal=extending(PreviewRegistrationModal,function(){function t(t){PreviewRegistrationModal.call(this,t)}return t.prototype.init=function(){var t=this;return this.content.find(".RegisterButton").on("click.Register",function(){var e=$(this),n=e.closest(".RegistrationModalForm");e.attr("disabled",!0),isFormValid(n)?OneEvent.registerToEvent(t.event.id,n.serializeForm("array").map(function(t){return{uuid:t.name,value:t.value}})).always(function(){e.removeAttr("disabled")}).done(function(){t.modal.trigger("registration:success"),t.hide()}):e.removeAttr("disabled")}),bindRippleEffect(this.content),this.__init(),this},t}()),AbstractUsersModal=extending(AbstractModal,function(){function t(e,n){if(AbstractModal.call(this),this.title=n,this.entity_id=e,this.entities_length=30,this.is_upload_disabled=!1,this.users=new UsersCollection,this.is_first=!0,this.wrapper_is_scrollable=!0,this.constructor===t)throw new Error("Can't instantiate abstract class!")}return t.prototype.show=function(){var t=this;return this.block_scroll=!1,this.users.length?(this.__show(),this):(this.render(),this.uploadUsers(function(){t.__show()}),this)},t.prototype.init=function(){return bindPageLinks(this.modal),this.__init(),this},t.prototype.onScrollToBottom=function(t){var e=this;return this.uploadUsers(function(){t.call(e)}),this},t.prototype.hide=function(){return this.block_scroll=!1,this.modal_wrapper.off("scroll.uploadUsers"),this.__hide(),this},t.prototype.uploadUsers=function(t){},t.prototype.buildUsers=function(t){var e=$(),n="true"==this.content_wrapper.find(".UserTombstone").eq(-1).data("is_friend"),i=this;return t.forEach(function(t,a){(i.is_first&&!a||n!=t.is_friend)&&(e=e.add(tmpl("modal-users-divider",{label:t.is_friend?"Друзья":"Все"})),n=t.is_friend),e=e.add(__APP.BUILD.userTombstones(t,{tombstone_classes:["UserTombstone"],is_link:!0,dataset:{is_friend:t.is_friend}}))}),e},t.prototype.afterUpload=function(t){var e,n=this;t.length?(e=this.buildUsers(t),this.content_wrapper.append(e),this.is_first=!1,this.entities_length=10,this.adjustDestroyerHeight(),bindPageLinks(e),e.on("click.hideModal",function(){n.hide()})):this.is_upload_disabled=!0},t}()),EditorsModal=extending(AbstractUsersModal,function(){function t(t,e,n){AbstractUsersModal.call(this,t,e?e:"Редакторы"),this.ajax_data={order_by:"role,first_name"},n&&(this.ajax_data.roles=n)}return t.prototype.uploadUsers=function(t){var e=this;return this.users.fetchOrganizationStaff(this.entity_id,this.entities_length,this.ajax_data,function(n){e.afterUpload(n),t&&"function"==typeof t&&t(n)})},t.prototype.buildUsers=function(t){var e=$(),n=this.content_wrapper.find(".UserTombstone").last().data("role"),i={admin:"Администраторы",moderator:"Модераторы"},a=this;return t.forEach(function(t,o){(a.is_first&&!o||n!=t.role)&&(e=e.add(tmpl("modal-users-divider",{label:i[t.role]})),n=t.role),e=e.add(__APP.BUILD.userTombstones(t,{tombstone_classes:["UserTombstone"],is_link:!0,dataset:{role:t.role}}))}),e},t}()),FavoredModal=extending(AbstractUsersModal,function(){function t(t,e){if(!t)throw Error("To open favored modal you need to pass event_id");AbstractUsersModal.call(this,t,e?e:"Добавили в избранное"),this.ajax_data={fields:["is_friend"],order_by:"-is_friend,first_name"}}return t.prototype.uploadUsers=function(t){var e=this;return this.users.fetchEventFavorites(this.entity_id,this.entities_length,this.ajax_data,function(n){e.afterUpload(n),t&&"function"==typeof t&&t(n)})},t}()),SubscribersModal=extending(AbstractUsersModal,function(){function t(t,e){if(!t)throw Error("To open favored modal you need to pass organization_id");AbstractUsersModal.apply(this,[t,e?e:"Подписались"]),this.entity_id=t,this.ajax_data={fields:["is_friend"],order_by:"-is_friend,first_name"}}return t.prototype.uploadUsers=function(t){var e=this;return this.users.fetchOrganizationSubscribers(this.entity_id,this.entities_length,this.ajax_data,function(n){e.afterUpload(n),t&&"function"==typeof t&&t(n)})},t}()),Builder=function(){function t(){return"object"==typeof t.instance?t.instance:void(t.instance=this)}return t.normalizeBuildProps=function(t,e,n,i){return t=t?t:{},e?e.push("classes"):e=["classes"],n?n.push("dataset"):n=["dataset"],i?i.push("attributes"):i=["attributes"],e.forEach(function(e){t[e]=t[e]?"string"==typeof t[e]?t[e].split(" "):t[e]:[],t[e].toString=Array.toSpaceSeparatedString}),n.forEach(function(e){t[e]=t[e]?t[e]:{},t[e].toString=Array.isArray(t[e])?Array.toSpaceSeparatedString:Object.toHtmlDataSet}),i.forEach(function(e){t[e]=t[e]?t[e]:{},t[e].toString=Array.isArray(t[e])?Array.toSpaceSeparatedString:Object.toHtmlAttributes}),t},t.prototype.button=function(){var e=Array.prototype.slice.call(arguments);return tmpl("button",e.map(function(e){return t.normalizeBuildProps(e)})).each(function(t,n){e[t].dataset&&$(n).data(e[t].dataset)})},t.prototype.input=function(e,n,i){return tmpl("input",t.normalizeBuildProps({classes:n,attributes:e,dataset:i})).each(function(t,e){i&&$(e).data(i)})},t.prototype.textarea=function(e,n,i,a){return tmpl("textarea",t.normalizeBuildProps({value:i,classes:n,attributes:e,dataset:a})).each(function(t,e){a&&$(e).data(a)})},t.prototype.link=function(e){return tmpl("link",[].map.call(arguments,function(e){return t.normalizeBuildProps(e)}))},t.prototype.radioCheckbox=function(e,n){if("checkbox"==e||"radio"==e)return n=t.normalizeBuildProps(n,["unit_classes"]),n.classes.indexOf("form_checkbox")==-1&&n.classes.indexOf("form_radio")==-1&&n.classes.unshift("form_"+e),
n.unit_classes.unshift("form_unit"),n.attributes.checked||delete n.attributes.checked,n.attributes.tabindex=n.attributes.tabindex?n.attributes.tabindex:-1,tmpl("radio-checkbox",$.extend(n,{type:e}));throw Error('Принимаемый аргумент type может быть либо "radio" либо "checkbox", придурок')},t.prototype.radio=function(t){var e=this;return $.makeSet([].map.call(arguments,function(t){return e.radioCheckbox("radio",t)}))},t.prototype.checkbox=function(t){var e=this;return $.makeSet([].map.call(arguments,function(t){return e.radioCheckbox("checkbox",t)}))},t.prototype.formHelpText=function(e,n,i){return tmpl("form-helptext",t.normalizeBuildProps({text:e,dataset:n,attributes:i}))},t.prototype.formInput=function(e){var n=this,i=["hidden","text","search","tel","url","email","password","date","time","number","range","color","checkbox","radio","file","submit","image","reset","button"];return $.makeSet(Array.prototype.map.call(arguments,function(e){switch(e.type){case"radio":return n.radio(e);case"checkbox":return n.checkbox(e);default:return tmpl("form-unit",t.normalizeBuildProps($.extend(!0,{},e,{form_element:"textarea"===e.type?n.textarea($.extend({},e.attributes,{id:e.id,name:e.name||void 0,required:e.required||void 0,placeholder:e.placeholder,tabindex:e.tabindex}),e.classes?["form_textarea"].concat(e.classes):["form_textarea"],e.value,e.dataset):n.input($.extend({},e.attributes,{id:e.id,type:e.type&&i.indexOf(e.type)!==-1?e.type:"text",name:e.name||void 0,value:e.value||void 0,required:e.required||void 0,placeholder:e.placeholder,tabindex:e.tabindex}),e.classes?["form_input"].concat(e.classes):["form_input"],e.dataset),helptext:n.formHelpText(e.helptext,e.helptext_dataset,e.helptext_attributes)}),["unit_classes","label_classes"]))}}))},t.prototype.cap=function(e,n){return n||(n={}),n=t.normalizeBuildProps(n),tmpl("cap",$.extend({message:e},n))},t.prototype.tags=function(e,n){function i(t){return $.extend(!0,{},{name:t.name.toLowerCase(),page:"/search/"+encodeURIComponent("#"+t.name.toLowerCase())},n)}return n=t.normalizeBuildProps(n),e instanceof Array?tmpl("tag",e.map(i)):tmpl("tag",i(e))},t.prototype.loaderBlock=function(t,e){return tmpl("loader-block",{loader:tmpl("loader")},t,e)},t.prototype.socialLinks=function(e){var n=[],i={VK:"vk",GOOGLE:"google-plus",FACEBOOK:"facebook-official"};return $.each(OneUser.ACCOUNTS,function(a,o){var s={slug:o,icon_slug:i[a]};e.hasOwnProperty(o)?(s.html_tag="a",s.attributes={href:e[o],target:"_blank"}):s.html_tag="span",n.push(t.normalizeBuildProps(s))}),tmpl("user-page-social-link",n)},t.prototype.userTombstones=function(e,n){var i=this;return n=t.normalizeBuildProps(n,["avatar_classes","tombstone_classes"]),n.avatar_classes.push("-rounded"),n.avatar_classes.push("-size_"+(n.size?n.size:"70x70")),n.is_link?(n.html_tag="a",n.tombstone_classes.push("link Link")):n.html_tag="div",tmpl("user-tombstone",(e instanceof Array?e:[e]).map(function(t){return n.is_link&&(n.attributes.href="/user/"+t.id),$.extend(!0,{},t,{avatar:i.avatars(t,{classes:n.avatar_classes}),name:t.full_name?t.full_name:[t.first_name,t.last_name].join(" ")},n)}))},t.prototype.avatarBlocks=function(e,n){var i=this;return n=t.normalizeBuildProps(n,["avatar_classes","block_classes"]),n.is_link?(n.html_tag="a",n.block_classes.push("link","Link")):n.html_tag="div",tmpl("avatar-block",(e instanceof Array?e:[e]).map(function(t){var e,a;return n.entity&&n.entity===__C.ENTITIES.USER||t instanceof OneUser||t.first_name?(e=t.full_name?t.full_name:t.first_name+" "+t.last_name,a="/user/"+t.id):(e=t.short_name?t.short_name:t.name,a="/organization/"+t.id),$.extend(!0,{id:t.id,avatar:i.avatars(t,{classes:n.avatar_classes}),attributes:{href:a},name:e},n)}))},t.prototype.addUserAvatarBlock=function(e,n,i){var a;switch(i=t.normalizeBuildProps(i,["avatar_classes","block_classes"]),i.block_classes.push("link",__C.CLASSES.HOOKS.ADD_STAFF,__C.CLASSES.HOOKS.CALL_MODAL),n){case OneUser.ROLE.ADMIN:a="Добавить администратора";break;case OneUser.ROLE.MODERATOR:a="Добавить модератора"}return tmpl("avatar-block",$.extend({html_tag:"div",name:a,avatar:tmpl("avatar",{classes:i.avatar_classes,avatar_url:window.location.origin+"/app/img/add_user.svg"})},i)).data({modal_type:"add_staff",modal_org_id:e,modal_role:n})},t.prototype.avatars=function(e,n){function i(t){return $.extend(!0,{avatar_url:t.avatar_url,name:t.full_name?t.full_name:t.first_name+" "+t.last_name},n)}function a(t){return $.extend(!0,{avatar_url:t.img_small_url?t.img_small_url:t.img_url,name:t.short_name?t.short_name:t.name},n)}var o,s=function(){},r=[];if(!(!e||e instanceof Array&&!e.length)){switch(n=t.normalizeBuildProps(n),!0){case e instanceof OneUser:case e instanceof UsersCollection:s=i;break;case e instanceof OneOrganization:case e instanceof OrganizationsCollection:s=a;break;default:e instanceof Array||(r=[e]),s=r[0].avatar_url?i:a}return o=e instanceof Array?e:[e],tmpl("avatar",o.map(s))}},t.prototype.avatarCollection=function(e,n,i,a){var o,s,r=t.normalizeBuildProps(i,["counter_classes"]);for(r.dataset.max_amount=n,r.classes.push("-max_"+n),r.avatars=this.avatars(__APP.USER),o=0,s=1;s<=n&&e[o];o++)e[o].id!=__APP.USER.id&&(r.avatars=r.avatars.add(this.avatars(e[o])),s++);return r.more_avatars_count=s<=n?0:(a?a:e.length)-n,r.more_avatars_count<=0&&r.counter_classes.push("-cast"),tmpl("avatars-collection",r)},t.prototype.activity=function(e,n){var i=this instanceof t?this:new t,a={};return a[OneAbstractActivity.TYPES.SUBSCRIBE]="plus",a[OneAbstractActivity.TYPES.FAVE]="star",a[OneAbstractActivity.TYPES.UNSUBSCRIBE]=a[OneAbstractActivity.TYPES.UNFAVE]="minus",n=t.normalizeBuildProps(n,["avatar_classes"]),n.avatar_classes.push(__C.CLASSES.SIZES.X50,__C.CLASSES.UNIVERSAL_STATES.ROUNDED),tmpl("activity-block",(e instanceof Array?e:[e]).map(function(t){var e={},o=__LOCALES.ru_RU.TEXTS.ACTIVITY[OneAbstractActivity.TYPES_INDEX[t.type_code]];switch(!0){case t instanceof OneOrganizationActivity:e={entity:"organization",img_url:t.organization.img_small_url?t.organization.img_small_url:t.organization.img_url,entity_url:"/organization/"+t.organization.id,hero_text:t.organization.short_name};break;case t instanceof OneEventActivity:e={entity:"event",img_url:t.event.image_horizontal_small_url?t.event.image_horizontal_small_url:t.event.image_horizontal_url,entity_url:"/event/"+t.event.id,hero_text:t.event.title}}return $.extend(e,{creator_avatar:i.avatars(t.user,{classes:n.avatar_classes,is_link:n.avatar_is_link,badge:tmpl("avatar-badge",{icon_class:a[t.type_code]})}),type_code:t.type_code,additional_info:getGenderText(t.user.gender,o),creator_url:"/user/"+t.user.id,creator_name:t.user.full_name?t.user.full_name:t.user.first_name+" "+t.user.last_name,date:moment.unix(t.created_at).calendar(null,__LOCALES.ru_RU.DATE.CALENDAR_DATE_TIME)})}))},t.prototype.organizationItems=function(e,n){e=e instanceof Array?e:[e];var i=this,a=e.map(function(t){return t.counter_classes=t.new_events_count?[]:[__C.CLASSES.HIDDEN],t});return tmpl("organization-item",a.map(function(e){return $.extend(!0,{avatar_block:i.avatarBlocks(e,{entity:"organization",avatar_classes:["-size_30x30"]})},e,t.normalizeBuildProps(n,["avatar_classes","block_classes","counter_classes"]))}))},t.prototype.organizationCard=function(t){var e=this;return tmpl("organization-card",t.map(function(t){return $.extend(!0,{},t,{background_image:t.background_small_img_url||t.background_img_url?e.link({page:"/organization/"+t.id,classes:["organization_unit_background"],attributes:{style:"background-image: url("+(t.background_small_img_url||t.background_img_url)+")"}}):"",avatar:e.avatars(t,{classes:["organization_unit_avatar",__C.CLASSES.SIZES.X55,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.SHADOWED]}),subscribe_button:new SubscribeButton(t.id,{is_checked:t.is_subscribed,colors:{unchecked:__C.CLASSES.COLORS.MARGINAL_ACCENT,unchecked_hover:__C.CLASSES.COLORS.MARGINAL_ACCENT},has_icons:!1,classes:[__C.CLASSES.SIZES.LOW,__C.CLASSES.HOOKS.RIPPLE]}),subscribed_text:t.subscribed_count+getUnitsText(t.subscribed_count,__LOCALES.ru_RU.TEXTS.SUBSCRIBERS),redact_org_button:t.role===OneUser.ROLE.UNAUTH||t.role===OneUser.ROLE.USER?"":e.link({classes:["button",__C.CLASSES.SIZES.LOW,__C.CLASSES.COLORS.MARGINAL_PRIMARY,__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.PENCIL,__C.CLASSES.UNIVERSAL_STATES.EMPTY,__C.CLASSES.HOOKS.RIPPLE],page:"organization/"+t.id+"/edit"})})}))},t.prototype.eventBlocks=function(t,e){var n=this;return tmpl("event-block",t.map(function(t){var i=e.sort_date_type?e.sort_date_type:"nearest_event_date",a=moment.unix(t[i]?t[i]:t.first_event_date),o=e.last_date!=a.format(__C.DATE_FORMAT),s=[__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.SIZES.SMALL,__C.CLASSES.HOOKS.ADD_AVATAR.COLLECTION,__C.CLASSES.HOOKS.CALL_MODAL],r=$();return t.is_favorite&&s.push(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED),null!=t.is_favorite&&(t.registration_locally||t.ticketing_locally?(r=r.add(new AddToFavoriteButton(t.id,{is_add_avatar:!0,is_checked:t.is_favorite,classes:[__C.CLASSES.UNIVERSAL_STATES.EMPTY,__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.ADD_TO_FAVORITES,__C.CLASSES.HOOKS.RIPPLE],labels:null})),t.ticketing_locally||(r=r.add(new RegisterButton(t,{classes:["event_block_main_action_button",__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.ADD_TO_FAVORITES,__C.CLASSES.HOOKS.RIPPLE]})))):r=new AddToFavoriteButton(t.id,{is_add_avatar:!0,is_checked:t.is_favorite,classes:["event_block_main_action_button",__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.ADD_TO_FAVORITES,__C.CLASSES.HOOKS.RIPPLE]})),e.last_date=a.format(__C.DATE_FORMAT),$.extend({},t,{divider:o?tmpl("divider",{title:a.calendar().capitalize()}):"",action_buttons:r,date:a.format(__C.DATE_FORMAT),avatars_collection:n.avatarCollection(t.favored,4,{dataset:{modal_type:"favors",modal_event_id:t.id},classes:s,counter_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.COLORS.MARGINAL,__C.CLASSES.HOOKS.ADD_AVATAR.STATES.CASTABLE]},t.favored_users_count),time:t.dates.reduce(function(t,e){return moment.unix(e.event_date).format(__C.DATE_FORMAT)==a.format(__C.DATE_FORMAT)&&t.push(displayTimeRange(e.start_time,e.end_time)),t},[]).join("; ")})}))},t.prototype.organisationsCategoriesItems=function(t){return t instanceof Array||(t=[t]),tmpl("organization-category",t.map(function(t){var e,n=!0,i=[];return t.organizations&&t.organizations.new_events_count?n?(e=t.organizations.reduce(function(t,e){return t+e.new_events_count},0),i=e?["counter"]:["counter",__C.CLASSES.HIDDEN]):i=["fa_icon","fa-angle-down","-empty"]:(e="",i=[__C.CLASSES.HIDDEN]),{category_id:t.id,category_name:t.name,order_position:t.order_position,aside_classes:i,new_events_count:n?"+"+e:""}}))},t.prototype.subscribers=function(t,e){var n=this;return tmpl("subscriber",t.map(function(t,i){var a="undefined"==typeof e||e!=t.is_friend;return e=t.is_friend,{divider:a?tmpl("subscriber-divider",{label:t.is_friend?"Друзья":"Все подписчики"}):"",avatar_block:n.avatarBlocks(t,{is_link:!0,entity:__C.ENTITIES.USER,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.UNIVERSAL_STATES.SHADOWED],block_classes:["subscriber"]})}}))},t.prototype.eventCards=function(t){var e,n=this;return e=tmpl("feed-event",(t instanceof Array?t:[t]).map(function(t){var e,i=[__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.SIZES.SMALL,__C.CLASSES.HOOKS.ADD_AVATAR.COLLECTION,__C.CLASSES.HOOKS.CALL_MODAL],a=[],o=new OneOrganization(t.organization_id),s=$();return o.setData({short_name:t.organization_short_name,img_url:t.organization_logo_small_url}),t.registration_locally||t.ticketing_locally?(s=new AddToFavoriteButton(t.id,{is_add_avatar:!0,is_checked:t.is_favorite,classes:["feed_event_header_button",__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.EMPTY],labels:null,icons:{checked_hover:__C.CLASSES.ICONS.STAR},colors:{checked:__C.CLASSES.TEXT_COLORS.ACCENT,unchecked:"",checked_hover:__C.CLASSES.TEXT_COLORS.ACCENT,unchecked_hover:""}}),t.ticketing_locally||(e=new RegisterButton(t,{classes:[__C.CLASSES.SIZES.LOW,__C.CLASSES.SIZES.WIDE,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.RIPPLE]}))):e=new AddToFavoriteButton(t.id,{is_add_avatar:!0,is_checked:t.is_favorite,classes:[__C.CLASSES.SIZES.LOW,__C.CLASSES.SIZES.WIDE,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.RIPPLE]}),s=s.add(n.button({classes:["feed_event_header_button",__C.CLASSES.SIZES.LOW,__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.TIMES,__C.CLASSES.UNIVERSAL_STATES.EMPTY,"HideEvent"],dataset:{"event-id":t.id}})),t.is_favorite&&i.push(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED),a.push({text:displayDateRange(t.dates[0].event_date,t.dates[t.dates.length-1].event_date)+(t.is_same_time?", "+displayTimeRange(t.dates[0].start_time,t.dates[0].end_time):"")}),t.registration_required&&t.registration_till&&a.push({text:"Регистрация до "+moment.unix(t.registration_till).calendar().capitalize()}),t.is_free?a.push({text:"Бесплатно"}):a.push({text:"Цена от "+(t.min_price?formatCurrency(t.min_price):0)+" руб."}),$.extend(!0,{organization_avatar_block:n.avatarBlocks(o,{block_classes:[__C.CLASSES.SIZES.SMALL],is_link:!0,entity:"organization"}),action_button:e,avatars_collection:n.avatarCollection(t.favored,4,{dataset:{modal_type:"favors",modal_event_id:t.id},classes:i,counter_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.COLORS.MARGINAL_PRIMARY,__C.CLASSES.HOOKS.ADD_AVATAR.STATES.CASTABLE]},t.favored_users_count),feed_event_infos:tmpl("feed-event-info",a),header_buttons:s},t)})),t.forEach(function(t,n){e.eq(n).appear(function(){storeStat(t.id,__C.STATS.EVENT_ENTITY,__C.STATS.EVENT_VIEW)},{accY:100})}),__APP.USER.isLoggedOut()&&e.find(".HideEvent").remove(),e},t.normalizeTicketProps=function(e){return(e instanceof Array?e:[e]).map(function(e){var n,i=t.normalizeBuildProps({card_classes:[],title:e.event.title,location:e.event.location,status_name:e.status_name,status_type_code:e.status_type_code,ticket_type_name:e.ticket_type.name,image_horizontal_url:e.event.image_horizontal_url,image_horizontal_large_url:e.event.image_horizontal_large_url||e.event.image_horizontal_url,image_horizontal_medium_url:e.event.image_horizontal_medium_url},["card_classes"]);switch(i.status_type_code){case OneExtendedTicket.TICKET_STATUSES.PAYED:case OneExtendedTicket.TICKET_STATUSES.APPROVED:case OneExtendedTicket.TICKET_STATUSES.WITHOUT_PAYMENT:i.card_classes.push(__C.CLASSES.STATUS.SUCCESS);break;case OneExtendedTicket.TICKET_STATUSES.IS_PENDING:case OneExtendedTicket.TICKET_STATUSES.WAITING_FOR_PAYMENT:i.card_classes.push(__C.CLASSES.STATUS.PENDING);break;case OneExtendedTicket.TICKET_STATUSES.REJECTED:case OneExtendedTicket.TICKET_STATUSES.RETURNED_BY_CLIENT:case OneExtendedTicket.TICKET_STATUSES.RETURNED_BY_ORGANIZATION:i.card_classes.push(__C.CLASSES.STATUS.ERROR)}switch(i.status_type_code){case OneExtendedTicket.TICKET_STATUSES.IS_PENDING:case OneExtendedTicket.TICKET_STATUSES.WAITING_FOR_PAYMENT:case OneExtendedTicket.TICKET_STATUSES.RETURNED_BY_ORGANIZATION:case OneExtendedTicket.TICKET_STATUSES.RETURNED_BY_CLIENT:case OneExtendedTicket.TICKET_STATUSES.REJECTED:i.card_classes.push(__C.CLASSES.STATUS.DISABLED);break;default:i.card_classes.push(__C.CLASSES.HOOKS.CALL_MODAL)}return e.event.is_same_time?(n=e.event.dates[0],i.formatted_dates=displayDateRange(n.event_date,e.event.dates[e.event.dates.length-1].event_date)+", "+displayTimeRange(n.start_time,n.end_time)):(n=e.event.nearest_event_date,i.formatted_dates=displayDateRange(n,n)),i})},t.prototype.ticketCards=function(e){return tmpl("ticket-card",t.normalizeTicketProps(e)).each(function(t,n){$(n).data({modal_type:__C.MODAL_TYPES.TICKET,tickets:e[t]})})},t.prototype.modal=function(e){var n,i=t.normalizeBuildProps(e,["content_classes"]),a={modal_header:"",modal_type:i.type,modal_content:i.content,modal_classes:i.classes,modal_content_classes:i.content_classes,modal_footer:""};return i.header?a.modal_header=i.header:i.title&&(a.modal_header=tmpl("modal-header",{title:i.title,close_button:this.button({classes:[__C.CLASSES.UNIVERSAL_STATES.EMPTY,"-modal_destroyer",__C.CLASSES.HOOKS.CLOSE_MODAL,__C.CLASSES.HOOKS.RIPPLE],title:"×"})})),i.footer?a.modal_footer=i.footer:i.footer_buttons&&(a.modal_footer=tmpl("modal-footer",{footer_buttons:i.footer_buttons})),n=tmpl("modal",a),i.width&&n.width(i.width),i.height&&n.height(i.height),n},t}(),AbstractSidebar=function(){function t(){this.$sidebar=$("#main_sidebar"),this.$subscribed_orgs=$(".SidebarOrganizationsList")}return t.prototype.init=function(){this.$sidebar.find(".SidebarNav").addClass("-items_"+this.$sidebar.find(".SidebarNavItem").not(".-hidden").length),this.$sidebar.find(".SidebarScroll").scrollbar({disableBodyScroll:!0})},t.prototype.updateSubscriptions=function(){},t}(),Sidebar=extending(AbstractSidebar,function(){function t(){AbstractSidebar.call(this)}return t.prototype.init=function(){var t=this;t.updateSubscriptions(),$(window).on("subscribe unsubscribe",function(){t.updateSubscriptions()}),AbstractSidebar.prototype.init.call(this)},t.prototype.updateSubscriptions=function(){var t=this.$subscribed_orgs,e=0,n=$.map(t.children(),function(t){return $(t).data("organization_id")}),i=__APP.USER.subscriptions.filter(function(t){return n.indexOf(t.id)===-1}),a=n.filter(function(t){return!__APP.USER.subscriptions.has(t)});i.length&&(__APP.BUILD.organizationItems(i,{block_classes:["animated"],avatar_classes:["-size_30x30"]})[t.length?"prependTo":"appendTo"](t).each(function(t,n){setTimeout(function(){$(n).addClass("-show")},e+=100)}),bindPageLinks(t)),a.length&&a.forEach(function(e){var n=t.find('.organization_item[data-organization_id="'+e+'"]').removeClass("-show");setTimeout(function(){n.remove()},500)})},t}()),SidebarNoAuth=extending(AbstractSidebar,function(){function t(){AbstractSidebar.call(this)}return t.prototype.init=function(){this.$sidebar.find(".SidebarOrganizationsScroll").addClass(__C.CLASSES.HIDDEN),AbstractSidebar.prototype.init.call(this)},t}()),AbstractTopBar=function(){function t(){this.$main_header=$("#main_header")}return t.prototype.init=function(){this.$main_header.find("#search_bar_input").on("keypress",function(t){13==t.which&&__APP.changeState("/search/"+encodeURIComponent(this.value))}),bindRippleEffect(this.$main_header),bindPageLinks(this.$main_header)},t}(),TopBar=extending(AbstractTopBar,function(){function t(){AbstractTopBar.call(this)}return t.prototype.init=function(){this.$main_header.find("#user_bar").on("click.openUserBar",function(){var t=$(this),e=$(document);t.addClass("-open"),e.on("click.closeUserBar",function(n){$(n.target).parents("#user_bar").length||(e.off("click.closeUserBar"),t.removeClass("-open"))})}),this.$main_header.find(".LogoutButton").on("click",__APP.USER.logout),this.$main_header.find(".OpenSettingsButton").on("click",showSettingsModal),AbstractTopBar.prototype.init.call(this)},t}()),TopBarNoAuth=extending(AbstractTopBar,function(){function t(){AbstractTopBar.call(this)}return t.prototype.init=function(){this.$main_header.find(".LoginButton").on("click",function(){cookies.removeItem("auth_command"),cookies.removeItem("auth_entity_id"),new AuthModal(location.href).show()}),AbstractTopBar.prototype.init.call(this)},t}()),Page=function(){function t(){this.name=this.constructor.name,this.state_name=this.name,this.page_title="",this.$view=$(".PageView"),this.$wrapper=$(),this.wrapper_tmpl="std",this.with_header_tabs=!1,this.rendering_defer=$.Deferred(),this.fetching_data_defer=$.Deferred()}return t.routeNewPage=function(e){var n,i=decodeURIComponent(e).split("/"),a=[];return n=i.reduce(function(t,e){return e?t.hasOwnProperty(e)?t[e]:Object.keys(t).reduce(function(n,i){return!n&&0===i.indexOf("^")&&new RegExp(i).test(e)?(a.push(e),t[i]):n},!1):t},__APP.ROUTING),n=n.prototype instanceof t?n:n[""]&&n[""].prototype instanceof t?n[""]:NotFoundPage,new(Function.prototype.bind.apply(n,[null].concat(a)))},t.prototype.show=function(){var t=this,e=$("#main_header"),n=__APP.PREVIOUS_PAGE.wrapper_tmpl!==t.wrapper_tmpl,i=n?"$view":"$wrapper",a=__APP.PREVIOUS_PAGE[i].length?__APP.PREVIOUS_PAGE[i]:n?$(".PageView"):$(".PageView").find(".Content");t.page_title&&__APP.changeTitle(t.page_title),a.addClass("-faded"),setTimeout(function(){a.addClass(__C.CLASSES.HIDDEN),t.with_header_tabs?e.addClass("-with_tabs"):e.removeClass("-with_tabs"),$("body").removeClass(function(t,e){return(e.match(/(^|\s)-state_\S+/g)||[]).join(" ")}).addClass("-state_"+t.state_name.toUnderscore()),n&&t.$view.html(tmpl(t.wrapper_tmpl+"-wrapper",{})),t.$wrapper=t.$view.find(".Content"),t.$wrapper.empty(),t.$view.removeClass(__C.CLASSES.HIDDEN),t.$wrapper.removeClass(__C.CLASSES.HIDDEN),t[i].addClass("-faded"),t.rendering_defer.resolve()},200),$.when(t.rendering_defer,t.fetching_data_defer).done(function(){$(window).scrollTop(0),t.render(),bindPageLinks(),setTimeout(function(){t[i].removeClass("-faded")},200)})},t.prototype.fetchData=function(){return this.fetching_data_defer.resolve().promise()},t.prototype.render=function(){},t.prototype.destroy=function(){},t}(),AdminPage=extending(Page,function(){function t(){Page.apply(this),this.state_name="admin",this.SCALES={MINUTE:"minute",HOUR:"hour",DAY:"day",WEEK:"week",MONTH:"month",YEAR:"year",OVERALL:"overall"},this.highchart_defaults={chart:{backgroundColor:null,plotBorderWidth:null,plotShadow:!1,style:{fontFamily:"inherit",fontSize:"inherit"}},title:{text:!1},credits:{enabled:!1}}}return t.prototype.areaChartSeriesNormalize=function(t){function e(t,e,n){return{name:a[e],data:t.map(function(t,e){return[moment.unix(t.time_value).valueOf(),t[n]]})}}var n={open_conversion:{with:"open_site",to:"view"},fave_conversion:{with:"fave",to:"open_site"},conversion:{with:"subscribe",to:"view"}},i={subscribe_unsubscribe:{subscribe:"subscribe",unsubscribe:"unsubscribe"}},a={notifications_sent:"Отправлено уведомлений",view:"Просмотры",view_detail:"Открытий страницы события из ленты Evendate",conversion:"Конверсия",subscribe:"Подписалось",unsubscribe:"Отписалось",open_site:"Открытий страницы события",open_conversion:"Конверсия просмотра события в ленте к открытию страницы события",fave:"Кол-во пользователей, которые добавили событие в избранное",fave_conversion:"Конверсия открытия страницы события к добавлениям в избранное"},o={showInLegend:!1,lineWidth:0,fillOpacity:0,states:{hover:{enabled:!1}}},s={};return $.each(t,function(t,a){s[t]=[],n.hasOwnProperty(t)?(s[t].push($.extend(!0,{tooltip:{valueSuffix:" %"}},e(a,t,"value"))),$.each(n[t],function(n,i){s[t].push($.extend(!0,{},o,e(a,i,n)))})):i.hasOwnProperty(t)?$.each(i[t],function(n,i){s[t].push(e(a,i,n))}):s[t].push(e(a,t,"value"))}),s},t.prototype.buildAreaCharts=function(t,e){var n=this,i=n.areaChartSeriesNormalize(t),a={notifications_sent:{title:"Отправлено уведомлений пользователям",wrapper_class:"NotificationsSentAreaChart"},view:{title:"Просмотры",wrapper_class:"ViewAreaChart"},view_detail:{title:"Открытий страницы события",wrapper_class:"ViewDetailAreaChart"},open_site:{title:"Открытий страницы события из ленты Evendate",wrapper_class:"OpenSiteAreaChart"},open_conversion:{title:"Конверсия просмотров/открытий",wrapper_class:"OpenConversionsAreaChart"},fave:{title:"Добавлений в избранное",wrapper_class:"FaveAreaChart"},fave_conversion:{title:"Конверсия открытий/добавлений в избранное",wrapper_class:"FaveConversionsAreaChart"},subscribe_unsubscribe:{title:"Подписчики",wrapper_class:"SubscriberAreaChart"},conversion:{title:"Конверсия просмотров/подписок",wrapper_class:"ConversionAreaChart"}},o=[["rgba(35, 215, 146, 0.18)","rgba(101, 101, 101, 0.6)","rgba(101, 101, 101, 0.6)"],["rgba(35, 215, 146, 0.09)","rgba(101, 101, 101, 0.6)","rgba(101, 101, 101, 0.6)"]],s=$.extend(!0,{},n.highchart_defaults,{chart:{type:"areaspline",plotBackgroundColor:"#fcfcfc",plotBorderColor:"#ebebeb",plotBorderWidth:1},colors:[__C.COLORS.FRANKLIN,__C.COLORS.MUTED_80,__C.COLORS.ACCENT,__C.COLORS.MUTED,__C.COLORS.MUTED_50,__C.COLORS.MUTED_30],title:{align:"left",margin:20},legend:{enabled:!0,align:"left",itemStyle:{color:__C.COLORS.TEXT,cursor:"pointer",fontSize:"14px",fontWeight:"500",y:0},itemMarginTop:24,itemMarginBottom:5,symbolHeight:18,symbolWidth:18,symbolRadius:9,itemDistance:42,x:30},plotOptions:{series:{states:{hover:{lineWidth:2}}},areaspline:{fillOpacity:.5,marker:{enabled:!1,symbol:"circle",radius:2,states:{hover:{enabled:!0}}},dataGrouping:{dateTimeLabelFormats:{millisecond:["%b %e, %H:%M:%S.%L","%b %e, %H:%M:%S.%L","-%H:%M:%S.%L"],second:["%b %e, %H:%M:%S","%b %e, %H:%M:%S","-%H:%M:%S"],minute:["%b %e, %H:%M","%b %e, %H:%M","-%H:%M"],hour:["%b %e, %H:%M","%b %e, %H:%M","-%H:%M"],day:["%b %e, %Y","%b %e","-%b %e, %Y"],week:["%b %e, %Y","%b %e","-%b %e, %Y"],month:["%B %Y","%B","-%B %Y"],year:["%Y","%Y","-%Y"]}}}},tooltip:{headerFormat:"<b>{point.key}</b><br/>",positioner:function(t,e){return{x:this.chart.plotLeft,y:this.chart.plotTop}},shadow:!1,shape:"square",valueDecimals:0,xDateFormat:"%e %b %Y",shared:!0},scrollbar:{enabled:!1},navigator:{outlineColor:"#ebebeb",outlineWidth:1,maskInside:!1,maskFill:"rgba(245, 245, 245, 0.66)",handles:{backgroundColor:"#9fa7b6",borderColor:"#fff"},xAxis:{gridLineWidth:0,labels:{align:"left",reserveSpace:!0,style:{color:"#888"},x:0,y:null}}},rangeSelector:{buttonTheme:{width:null,height:22,fill:"none",stroke:"none",r:14,style:{color:__C.COLORS.MUTED_80,fontSize:"13px",fontWeight:"400",textTransform:"uppercase",dominantBaseline:"middle"},states:{hover:{fill:__C.COLORS.MUTED_50,style:{color:"#fff"}},select:{fill:__C.COLORS.MUTED_80,style:{color:"#fff",fontWeight:"400"}}}},buttons:[{type:"day",count:7,text:"   Неделя   "},{type:"month",count:1,text:"   Месяц   "},{type:"year",count:1,text:"   Год   "},{type:"all",text:"   Все время   "}],allButtonsEnabled:!0,selected:2,labelStyle:{display:"none"},inputEnabled:!1},xAxis:{gridLineWidth:1,gridLineDashStyle:"dash",type:"datetime",showEmpty:!1,tickPosition:"inside",dateTimeLabelFormats:{minute:"%H:%M",hour:"%H:%M",day:"%e %b",week:"%e %b",month:"%b %y",year:"%Y"}},yAxis:{allowDecimals:!1,floor:0,min:0,gridLineDashStyle:"dash",opposite:!1,title:{text:!1}}},e);$.each(i,function(t){var e={title:{text:a[t].title}};e.series=i[t].map(function(t,e){return 0!==t.fillOpacity?$.extend(!0,{},t,{fillColor:{linearGradient:{x1:0,x2:0,y1:0,y2:1},stops:o.map(function(t,n){return[n,t[e]]})}}):t}),"conversion"!=t&&"open_conversion"!=t&&"fave_conversion"!=t||(e.yAxis={max:100,labels:{format:"{value}%"}}),n.$wrapper.find("."+a[t].wrapper_class).highcharts("StockChart",$.extend(!0,{},s,e))})},t.prototype.updateScoreboards=function(t,e,n,i,a){var o=!!e.dynamics;i||(i=Object.keys(n)),i.forEach(function(i){var s,r="Scoreboard"+i.toCamelCase("_"),l=t.find("."+r);switch(i){case"conversion":case"open_conversion":case"fave_conversion":s="%"}l.length||(l=tmpl(o?"scoreboard-with-dynamics":"scoreboard",{type:r,title:n[i],size:a?"-size_"+a:"-size_normal",number:0+s,dynamic_by_week:0+s},t)),void 0!==e.numbers[i]&&l.find(".ScoreboardNumber").animateNumber({number:Math.round(e.numbers[i]),suffix:s},2e3,"easeOutSine"),o&&void 0!==e.dynamics[i]&&l.find(".ScoreboardDynamic").animateNumber({number:Math.round(e.dynamics[i]),prefix:0==e.dynamics[i]?void 0:e.dynamics[i]>0?"+":"-",suffix:s},2e3,"easeOutSine").siblings("label").removeClass("fa-caret-up -text_color_franklin fa-caret-down -text_color_bubblegum").addClass(0==e.dynamics[i]?"":e.dynamics[i]>0?"fa-caret-up -text_color_franklin":"fa-caret-down -text_color_bubblegum")})},t}()),AdminOrganizationPage=extending(AdminPage,function(){function t(t){AdminPage.apply(this),this.id=t,this.organization=new OneOrganization(this.id),this.with_header_tabs=!0}return t.prototype.fetchData=function(){return this.fetching_data_defer=this.organization.fetchOrganization(["description","img_medium_url","default_address","staff","privileges","events".appendAjaxData({length:3,future:!0,is_canceled:!0,is_delayed:!0,fields:["organization_short_name","public_at"],order_by:"nearest_event_date"})])},t.prototype.renderHeaderTabs=function(){__APP.renderHeaderTabs([{title:"Обзор",page:"/admin/organization/"+this.id+"/overview"},{title:"События",page:"/admin/organization/"+this.id+"/events"},{title:"Настройки",page:"/admin/organization/"+this.id+"/settings"}])},t}()),AdminOrganizationAuditoryPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.apply(this,arguments)}return t.prototype.render=function(){},t}()),AdminOrganizationEventsPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.apply(this,arguments),this.block_scroll=!1,this.future_events_data={future:!0,canceled_shown:!0},this.past_events_data={future:!1,canceled_shown:!0,order_by:"-first_event_date"},this.future_events=new EventsWithStatisticsCollection,this.past_events=new EventsWithStatisticsCollection}return t.buildEventRows=function(t,e){var n=tmpl("orgstat-events-row",t.map(function(t){return $.extend({},t,{date:moment.unix(t[e]).format(__LOCALES.ru_RU.DATE.DATE_FORMAT),timestamp:t[e],conversion:Math.round(0==t.view?t.view:100*t.view_detail/t.view)+"%"})}));return bindPageLinks(n),n},t.prototype.fetchData=function(){return this.fetching_data_defer=this.organization.fetchOrganization()},t.prototype.render=function(){var e,n,i=this,a=$(window);this.renderHeaderTabs(),__APP.changeTitle([{title:"Организации",page:"/admin"},this.organization.short_name+" - события"]),this.$wrapper.html(tmpl("orgstat-events-page")),this.future_events.fetchOrganizationsEvents(this.organization.id,this.future_events_data,0,function(){this.length&&i.$wrapper.find(".OrgStatFutureEventsWrapper").html(tmpl("orgstat-events-wrapper",{title:"Предстоящие события",rows:t.buildEventRows(i.future_events,"nearest_event_date")})).find("table").tablesort()}),this.past_events.fetchOrganizationsEvents(this.organization.id,this.past_events_data,30,function(){this.length&&(e=i.$wrapper.find(".OrgStatPastEventsWrapper"),e.html(tmpl("orgstat-events-wrapper",{title:"Прошедшие события",rows:t.buildEventRows(i.past_events,"first_event_date")})),n=e.find("table").tablesort(),a.on("scroll.uploadEvents",function(){a.height()+a.scrollTop()+200>=$(document).height()&&!i.block_scroll&&(i.block_scroll=!0,i.past_events.fetchOrganizationsEvents(i.organization.id,i.past_events_data,30,function(a){i.block_scroll=!1,a.length?(e.find("tbody").append(t.buildEventRows(a,"first_event_date")),n.refresh()):$(window).off("scroll.uploadEvents")}))}))})},t}()),AdminOrganizationOverviewPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.apply(this,arguments),this.graphics_stats=new OrganizationsStatistics(this.id),this.other_stats=new OrganizationsStatistics(this.id)}return t.buildStaffBlock=function(t,e){return e.length?tmpl("orgstat-overview-sidebar-wrapper-title",{title:t}).add(__APP.BUILD.avatarBlocks(e,{avatar_classes:["-size_40x40","-rounded"],entity:"user",is_link:!0})):$()},t.prototype.fetchData=function(){return this.fetching_data_defer=this.organization.fetchOrganizationWithEvents(["description","img_medium_url","default_address","staff","privileges"],{length:3,fields:["organization_short_name","public_at"],is_delayed:!0,filters:"future=true,is_canceled=false",order_by:"nearest_event_date"})},t.prototype.buildAreaCharts=function(){var t=this;AdminPage.prototype.buildAreaCharts.call(t,{subscribe_unsubscribe:t.graphics_stats.subscribe.map(function(e,n){return{time_value:e.time_value,subscribe:e.value,unsubscribe:t.graphics_stats.unsubscribe[n].value}}),view:t.graphics_stats.view,conversion:t.graphics_stats.conversion})},t.prototype.buildPieChart=function(t,e){function n(t){var e={browser:"Браузер",android:"Аndroid",ios:"iOS",female:"Женщины",male:"Мужчины",other:"Остальные",null:"Не указано"};return[{data:t.map(function(t,n){return{
name:t.name?e[t.name]:e[t.gender],y:t.count}})}]}var i={chart:{type:"pie",height:200,style:{fontFamily:"inherit",fontSize:"inherit"}},colors:[__C.COLORS.FRANKLIN,__C.COLORS.ACCENT,__C.COLORS.MUTED,__C.COLORS.MUTED_80,__C.COLORS.MUTED_50,__C.COLORS.MUTED_30],tooltip:{pointFormat:"<b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{center:[45,"50%"],allowPointSelect:!0,cursor:"pointer",size:120,dataLabels:{distance:-35,defer:!1,formatter:function(){return this.percentage>15?Math.round(this.percentage)+"%":null},style:{color:"#fff",fontSize:"20px",fontWeight:"300",textShadow:"none"},y:-6},showInLegend:!0}},legend:{align:"right",verticalAlign:"top",layout:"vertical",width:100,symbolHeight:0,symbolWidth:0,itemMarginBottom:5,labelFormatter:function(){return'<span style="color: '+this.color+'">'+this.name+"</span>"},itemStyle:{cursor:"pointer",fontSize:"14px",fontWeight:"500"},y:12}};t.highcharts($.extend(!0,{},this.highchart_defaults,i,{series:n(e)}))},t.prototype.render=function(){function e(t){return $.extend({},t,{is_link:!0,avatar_classes:["-size_40x40","-rounded"]})}var n=this,i={scale:Statistics.SCALES.WEEK,fields:["subscribe","view","fave","conversion"]},a="org_stats_"+this.id+"_data",o="org_stats_"+this.id+"_until",s=moment.unix(sessionStorage.getItem(o)).isAfter(moment());return __APP.USER.id===-1?(__APP.changeState("/feed/actual",!0,!0),null):(window.location.pathname.contains("overview")||__APP.changeState(window.location.pathname+"/overview",!0),this.renderHeaderTabs(),__APP.changeTitle([{title:"Организации",page:"/admin"},this.organization.short_name]),this.$wrapper.html(tmpl("orgstat-overview",$.extend(!0,{},this.organization,{avatar_block:__APP.BUILD.avatarBlocks(this.organization,{entity:"organization",block_classes:["-stack"]}),staff_block:t.buildStaffBlock("Администраторы",this.organization.admins.map(e)).add(t.buildStaffBlock("Модераторы",this.organization.moderators.map(e))),event_blocks:this.organization.events.length?tmpl("orgstat-overview-sidebar-wrapper",{content:tmpl("orgstat-overview-sidebar-wrapper-title",{title:"Предстоящие события"}).add(tmpl("orgstat-event-block",this.organization.events.map(function(t){var e=[];return t.canceled&&e.push({title:"Отменено"}),t.public_at&&moment.unix(t.public_at).isBefore()&&e.push({title:"Не опубликовано"}),{id:t.id,title:t.title,organization_short_name:t.organization_short_name,day:moment.unix(t.first_event_date).format("D"),month:moment.unix(t.first_event_date).format("MMM"),badges:tmpl("orgstat-event-block-badge",e)}})))}):""}))),s?(this.graphics_stats.setData(JSON.parse(sessionStorage.getItem(a))),this.buildAreaCharts()):(this.$wrapper.find(".OrgStatAreaCharts").children(".AreaChart").append(tmpl("loader")),this.graphics_stats.fetchStatistics(Statistics.SCALES.DAY,moment(__APP.EVENDATE_BEGIN,"DD-MM-YYYY").format(),["view","subscribe","unsubscribe","conversion"],null,function(){sessionStorage.setItem(a,JSON.stringify(n.graphics_stats)),sessionStorage.setItem(o,moment().add(15,"m").unix()),n.buildAreaCharts()})),this.other_stats.fetchStatistics(Statistics.SCALES.OVERALL,!1,["subscribe","view","fave","conversion","audience"],i,function(t){var e={numbers:{},dynamics:{}};$.each(t.dynamics,function(n,i){e.dynamics[n]=i[0].value,e.numbers[n]=t[n][0].value}),n.buildPieChart(n.$wrapper.find(".GenderPieChart"),this.audience.gender),n.buildPieChart(n.$wrapper.find(".DevicePieChart"),this.audience.devices),n.updateScoreboards(n.$wrapper.find(".Scoreboards"),e,{subscribe:"Подписчиков организатора",fave:"Добавлений в избранное",view:"Просмотров организатора",conversion:"Конверсия открытий/подписок"},["subscribe","fave","view","conversion"])}),bindRippleEffect(this.$wrapper),void bindPageLinks(this.$wrapper))},t}()),AdminOrganizationPromotionPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.apply(this,arguments)}return t.prototype.render=function(){},t}()),AdminOrganizationSettingsPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.call(this,t)}return t.prototype.fetchData=function(){return this.fetching_data_defer=this.organization.fetchOrganization(new Fields("city","country","default_address","description","brand_color","is_private","email","privileges","staff","site_url"))},t.prototype.updateOrganizationData=function(){return this.organization.updateOrganization(new OrganizationModel(this.organization))},t.prototype.init=function(){var t=this;bindCallModal(this.$wrapper),bindRippleEffect(this.$wrapper),this.$wrapper.find("#org_admin_settings_is_private").on("change",function(){t.organization.is_private=$(this).prop("checked"),t.updateOrganizationData()}),this.$wrapper.find(".SaveLocal").on("click",function(){t.organization.setData($(this).closest(".SaveLocalWrapper").serializeForm()),t.updateOrganizationData()}),this.$view.on("staff:add",function(e,n,i){var a=t.$wrapper.find(".StaffCollection");t.organization.staff.remove(i.id),t.organization.staff.setData(i),a.find(".User"+i.id).remove(),a.filter(function(t,e){return $(e).data("staff_type")===n}).children("."+__C.CLASSES.HOOKS.ADD_STAFF).before(__APP.BUILD.avatarBlocks(i,{is_link:!0,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]})),bindPageLinks(a)})},t.prototype.render=function(){var t=this,e={is_link:!0,avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]};this.renderHeaderTabs(),__APP.changeTitle([{title:"Организации",page:"/admin"},this.organization.short_name+" - настройки"]),this.$wrapper.html(tmpl("admin-organization-settings-page",$.extend({},this.organization,{admin_avatar_blocks:__APP.BUILD.avatarBlocks(this.organization.admins,e).add(__APP.BUILD.addUserAvatarBlock(this.organization.id,OneUser.ROLE.ADMIN,{avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]})),moderator_avatar_blocks:__APP.BUILD.avatarBlocks(this.organization.moderators,e).add(__APP.BUILD.addUserAvatarBlock(this.organization.id,OneUser.ROLE.MODERATOR,{avatar_classes:[__C.CLASSES.SIZES.X40,__C.CLASSES.UNIVERSAL_STATES.ROUNDED]})),private_checkbox:__APP.BUILD.checkbox({id:"org_admin_settings_is_private",name:"is_private",label:"Закрытая организация",attributes:{checked:t.organization.is_private}}),subdomain_radio:__APP.BUILD.radio({id:"org_admin_settings_subdomain_enabled",name:"domains"}),other_domain_radio:__APP.BUILD.radio({id:"org_admin_settings_other_domain_enabled",name:"domains"})}))),this.init()},t.prototype.destroy=function(){this.$view.off("staff:add")},t}()),AdminOrganizationSupportPage=extending(AdminOrganizationPage,function(){function t(t){AdminOrganizationPage.apply(this,arguments)}return t.prototype.render=function(){},t}()),FeedPage=extending(Page,function(){function t(){Page.call(this),this.fields=new Fields("organization_short_name","organization_logo_small_url","dates","is_same_time","favored_users_count","is_favorite","is_registered","ticketing_locally","registration_locally","registration_available","registration_required","registration_till","registration_limit_count","is_free","min_price",{favored:{fields:"is_friend",order_by:"-is_friend",length:10}}),this.events=new EventsCollection,this.next_events_length=20,this.wrapper_tmpl="feed",this.with_header_tabs=!0}return t.prototype.bindFeedEvents=function(t){trimAvatarsCollection(t),bindRippleEffect(t),bindDropdown(t),__APP.MODALS.bindCallModal(t),bindPageLinks(t),t.find(".HideEvent").not(".-Handled_HideEvent").each(function(){var t=$(this),e=t.parents(".FeedEvent"),n=t.data("event-id");t.on("click",function(){e.addClass("-cancel"),OneEvent.changeEventStatus(n,OneEvent.STATUS.HIDE,function(){e.after(tmpl("button",{classes:"-color_neutral ReturnEvent",title:"Вернуть событие",dataset:'data-event-id="'+n+'"'})),e.siblings(".ReturnEvent").not(".-Handled_ReturnEvent").on("click",function(){var t=$(this);OneEvent.changeEventStatus(n,OneEvent.STATUS.SHOW,function(){t.remove(),e.removeClass("-cancel")})}).addClass("-Handled_ReturnEvent")})})}).addClass("-Handled_HideEvent")},t.prototype.addNoEventsBlock=function(){var t=tmpl("feed-no-event",{text:"Как насчет того, чтобы подписаться на организации?",button:__APP.BUILD.link({title:"Перейти к каталогу",classes:["button","-color_neutral_accent","RippleEffect"],page:"/organizations"})},this.$wrapper);bindPageLinks(t),bindRippleEffect(t)},t.prototype.appendEvents=function(t){var e=this;return e.block_scroll=!0,e.events.fetchFeed(this.fields,this.next_events_length,function(n){var i=__APP.BUILD.eventCards(e.events.last_pushed);e.block_scroll=!1,i.length?(e.$wrapper.append(i),e.bindFeedEvents(i),t&&"function"==typeof t&&t(i)):(e.addNoEventsBlock(),$(window).off("scroll.upload"+e.constructor.name))})},t.prototype.initFeedCalendar=function(){var t=this,e=t.events.date,n=new Calendar(t.$view.find(".FeedCalendar"),{classes:{wrapper_class:"feed_calendar_wrapper",table_class:"feed_calendar_table",thead_class:"feed_calendar_thead",tbody_class:"feed_calendar_tbody",th_class:"feed_calendar_th",td_class:"feed_calendar_td",td_disabled:__C.CLASSES.DISABLED}});n.init(),e&&n.setMonth(e.split("-")[1],e.split("-")[0]).selectDays(e),n.setDaysWithEvents(),n.$calendar.on("month-changed",function(){bindPageLinks(n.$calendar),n.setDaysWithEvents()})},t.prototype.render=function(){var e=this,n=$(window);if(__APP.PREVIOUS_PAGE instanceof t||e.initFeedCalendar(),__APP.USER.isLoggedOut()){if(__APP.renderHeaderTabs([{title:"Актуальные",page:"/feed/actual"},{title:"По времени",page:"/feed/timeline"}]),e.$view.find(".BecomeOrg").on("click",function(t){return cookies.removeItem("auth_command"),cookies.removeItem("auth_entity_id"),new AuthModal(location.origin+"/add/organization").show(),!1}),"/feed/favored"==window.location.pathname||"/feed/recommendations"==window.location.pathname)return __APP.changeState("/feed/actual",!0,!0),null}else __APP.renderHeaderTabs([{title:"Актуальные",page:"/feed/actual"},{title:"По времени",page:"/feed/timeline"},{title:"Избранные",page:"/feed/favored"},{title:"Рекомендованные",page:"/feed/recommendations"}]);n.off("scroll"),e.appendEvents(function(){n.on("scroll.upload"+e.constructor.name,function(){n.height()+n.scrollTop()+200>=$(document).height()&&!e.block_scroll&&e.appendEvents()})})},t}()),ActualEventsPage=extending(FeedPage,function(){function t(){FeedPage.apply(this),this.events=new ActualEventsCollection,this.page_title="Актуальные события"}return t}()),DayEventsPage=extending(FeedPage,function(){function t(t){if(!t)throw Error("DayEventsCollection must have date parameter");FeedPage.apply(this),this.date=t,this.events=new DayEventsCollection(this.date),this.page_title="События на "+moment(this.date).format("D MMMM YYYY")}return t}()),FavoredEventsPage=extending(FeedPage,function(){function t(){FeedPage.apply(this),this.events=new FavoredEventsCollection,this.page_title="Избранные события"}return t}()),FriendsEventsPage=extending(FeedPage,function(){function t(){FeedPage.apply(this),this.events=new FriendsEventsCollection,this.page_title="События друзей"}return t}()),RecommendedEventsPage=extending(FeedPage,function(){function t(){FeedPage.apply(this),this.events=new RecommendedEventsCollection,this.page_title="Рекомендованные события"}return t}()),TimelineEventsPage=extending(FeedPage,function(){function t(){FeedPage.apply(this),this.events=new TimelineEventsCollection,this.page_title="События по времени"}return t}()),AdminEventPage=extending(AdminPage,function(){function t(t){AdminPage.apply(this,arguments),this.id=t,this.event=new OneEvent(this.id)}return t}()),AdminEventAuditoryPage=extending(AdminEventPage,function(){function t(t){AdminEventPage.apply(this,arguments)}return t.prototype.render=function(){},t}()),AdminEventOverviewPage=extending(AdminEventPage,function(){function t(t){AdminEventPage.apply(this,arguments),this.graphics_stats=new EventStatistics(this.id),this.scoreboards_stats=new EventStatistics(this.id)}return t.prototype.fetchData=function(){return this.fetching_data_defer=this.event.fetchEvent(new Fields("image_horizontal_medium_url","organization_short_name","favored_users_count","is_same_time","dates"))},t.prototype.render=function(){var t=this;return __APP.USER.id===-1?(__APP.changeState("/feed/actual",!0,!0),null):(__APP.changeTitle([{title:"Организации",page:"/admin"},{title:this.event.organization_short_name,page:"/admin/organization/"+this.event.organization_id},this.event.title]),this.$wrapper.html(tmpl("eventstat-overview",$.extend(!0,{},this.event,{dates_block:tmpl("eventstat-overview-datetime",{date:displayDateRange(this.event.first_event_date,this.event.last_event_date),time:this.event.is_same_time?displayTimeRange(this.event.dates[0].start_time,this.event.dates[0].end_time):"Разное время"})}))),this.$wrapper.find(".EventStatAreaCharts").children(".AreaChart").html(tmpl("loader")),this.scoreboards_stats.fetchStatistics(Statistics.SCALES.OVERALL,!1,["notifications_sent","view","fave","view_detail","fave_conversion","open_conversion"],null,function(e){var n={numbers:{}};$.each(e,function(t,e){n.numbers[t]=e[0].value}),t.updateScoreboards(t.$wrapper.find(".EventstatsScoreboards"),n,{fave:"Добавлений в избранное",view:"Просмотров события"},["fave","view"]),t.updateScoreboards(t.$wrapper.find(".EventstatsBigScoreboards"),n,{notifications_sent:"Уведомлений отправлено",view:"Просмотров",view_detail:"Открытий",open_conversion:"Конверсия открытий",fave:"Добавлений",fave_conversion:"Конверсия добавлений"},["notifications_sent","view","view_detail","open_conversion","fave","fave_conversion"],"big")}),this.graphics_stats.fetchStatistics(Statistics.SCALES.DAY,moment(__APP.EVENDATE_BEGIN,"DD-MM-YYYY").format(),["notifications_sent","view","fave","view_detail","fave_conversion","open_conversion"],null,function(e){t.buildAreaCharts(e,{rangeSelector:{selected:1}})}),__APP.MODALS.bindCallModal(t.$wrapper),void bindPageLinks(t.$wrapper))},t}()),AdminEventPromotionPage=extending(AdminEventPage,function(){function t(t){AdminEventPage.apply(this,arguments)}return t.prototype.render=function(){},t}()),AdminStatisticsEventEditPage=extending(AdminEventPage,function(){function t(t){AdminEventPage.apply(this,arguments)}return t.prototype.render=function(){},t}()),NotFoundPage=extending(Page,function(){function t(){Page.call(this)}return t.prototype.render=function(){__APP.changeTitle("Страница не найдена")},t}()),AdminOrganizationsPage=extending(AdminPage,function(){function t(){AdminPage.apply(this),this.my_organizations_fields=["img_medium_url","subscribed_count","staff"],this.page_title="Организации",this.my_organizations=new OrganizationsCollection}return t.buildMyOrganizationsBlocks=function(t){return tmpl("statistics-overview-organization",t.map(function(t){var e=2,n=[{name:OneUser.ROLE.ADMIN,title:"Администраторы",staff:t.admins,plural_name:OneUser.ROLE.ADMIN+"s_block"},{name:OneUser.ROLE.MODERATOR,title:"Модераторы",staff:t.moderators,plural_name:OneUser.ROLE.MODERATOR+"s_block"}];return $.extend(!0,{},t,{subscribers:t.subscribed_count+getUnitsText(t.subscribed_count,__LOCALES.ru_RU.TEXTS.SUBSCRIBERS),buttons:__APP.BUILD.link({title:"Редактировать",classes:["button","fa_icon","fa-pencil","-color_neutral","RippleEffect"],page:"/organization/"+t.id+"/edit"},{title:"Создать событие",classes:["button","fa_icon","fa-plus","-color_accent","RippleEffect"],page:"/add/event/to/"+t.id})},n.reduce(function(n,i){return n[i.plural_name]=__APP.BUILD.avatarCollection(i.staff.map(function(t){return $.extend({},t,{is_link:!0,avatar_classes:["-size_100x100","-rounded"]})}),e,{dataset:{modal_type:"editors",modal_specific_role:i.name,modal_title:i.title,modal_organization_id:t.id},classes:["-size_30x30","-rounded","-shifted","CallModal"],counter_classes:["-size_30x30","-color_marginal_primary"]}),n},{}))}))},t.prototype.fetchData=function(){return this.fetching_data_defer=this.my_organizations.fetchMyOrganizations("admin",this.my_organizations_fields,10,"")},t.prototype.bindOrganizationsEvents=function(t){return trimAvatarsCollection(t),bindPageLinks(t),__APP.MODALS.bindCallModal(t),bindRippleEffect(t),t},t.prototype.bindUploadOnScroll=function(){var e=this,n=$(window),i=function(){n.height()+n.scrollTop()+200>=$(document).height()&&!e.is_upload_disabled&&(n.off("scroll.uploadOrganizations"),e.my_organizations.fetchMyOrganizations("admin",e.my_organizations_fields,10,"",function(a){var o=t.buildMyOrganizationsBlocks(e.my_organizations.last_pushed);e.my_organizations.last_pushed.length?(e.$wrapper.find(".StatOverviewOrganizations").append(o),e.bindOrganizationsEvents(o),n.on("scroll.uploadOrganizations",i)):e.is_upload_disabled=!0}))};e.is_upload_disabled||n.on("scroll.uploadOrganizations",i)},t.prototype.init=function(){this.bindOrganizationsEvents(this.$wrapper),this.bindUploadOnScroll()},t.prototype.render=function(){return __APP.USER.id===-1?(__APP.changeState("/feed/actual",!0,!0),null):(this.$wrapper.html(tmpl("statistics-overview-wrapper",{organizations:t.buildMyOrganizationsBlocks(this.my_organizations)})),void this.init())},t.prototype.destroy=function(){$(window).off("scroll.uploadOrganizations")},t}()),RedactEventPage=extending(Page,function(){function t(t){Page.apply(this),this.page_title="Редактирование события",this.event=new OneEvent(t),this.state_name="edit_event"}return t.lastRegistrationCustomFieldId=0,t.buildRegistrationCustomField=function(e){e=e?e instanceof Array?e:[e]:[{}];var n;return n=tmpl("edit-event-registration-custom-field",e.filter(function(e){return!!RegistrationFieldModel.isCustomField(e)&&(e.id=e.id?e.id:t.lastRegistrationCustomFieldId++,!0)})),e.forEach(function(t){t.required&&n.find("#edit_event_registration_"+t.id+"_custom_field_required").prop("checked",!0),t.type&&n.find("#edit_event_registration_"+t.id+"_custom_field_"+t.type+"_type").prop("checked",!0)}),n.find(".RemoveRegistrationCustomField").on("click.RemoveRegistrationCustomField",function(){$(this).closest(".RegistrationCustomField").remove()}),n.find(".RegistrationCustomFieldLabel, .RegistrationCustomFieldType").on("change.RemoveRegistrationFieldUUID",function(){$(this).closest(".RegistrationCustomField").find(".RegistrationCustomFieldUUID").val("")}),n},t.prototype.fetchData=function(){return this.event.id?this.fetching_data_defer=this.event.fetchEvent(EventPage.fields):Page.prototype.fetchData.call(this)},t.prototype.init=function(){function e(t){t.is("input")?t.inputmask({alias:"numeric",autoGroup:!1,digits:2,digitsOptional:!0,allowPlus:!1,allowMinus:!1,rightAlign:!1}):(t=t.find("input"),t.length&&e(t))}var n=this,i=n.$wrapper.find(".EditEventPageTabs"),a=n.$wrapper.find(".edit_event_buttons").children(),o=a.filter("#edit_event_next_page"),s=a.filter("#edit_event_prev_page"),r=a.filter("#edit_event_submit");bindDatePickers(n.$wrapper),bindTimeInput(n.$wrapper),bindSelect2(n.$wrapper),bindTabs(n.$wrapper),bindControlSwitch(n.$wrapper),__APP.MODALS.bindCallModal(n.$wrapper),bindLimitInputSize(n.$wrapper),bindRippleEffect(n.$wrapper),bindFileLoadButton(n.$wrapper),ImgLoader.init(n.$wrapper),function(){function t(t){t.find(".RemoveRow").not(".-Handled_RemoveRow").each(function(t,e){$(e).on("click",function(){l.deselectDays($(this).closest("tr").data("date"))}).addClass("-Handled_RemoveRow")})}function e(){d={},l.selected_days.forEach(function(t,e,n){var i=moment(t);"undefined"==typeof d[i.month()]&&(d[i.month()]={},d[i.month()].selected_days=[],d[i.month()].month_name=_[i.format("MMMM")]),d[i.month()].selected_days.push(i.date())}),s.empty().removeClass("hidden"),Object.keys(d).length?$.each(d,function(t,e){s.append($("<p>").text(e.selected_days.join(", ")+" "+e.month_name))}):s.html("<p>Даты не выбраны</p>")}function i(t,e){t.sort(function(t,e){var n=$(t).data("date"),i=$(e).data("date");return n>i?1:n<i?-1:0}),t.detach().appendTo(e)}function a(e){var n=$(),a=moment().format(__C.DATE_FORMAT);Array.isArray(e)?e.forEach(function(t){n=n.add(tmpl("selected-table-day",{date:t,formatted_date:t.split("-").reverse().join("."),today:a}))}):n=tmpl("selected-table-day",{date:e,formatted_date:e.split("-").reverse().join("."),today:a}),bindDatePickers(n),bindTimeInput(n),t(n),u=u.add(n),n.find(".DatePicker").each(function(){var t=$(this).data("datepicker");t.$datepicker.on("date-picked",function(){l.deselectDays(t.prev_selected_day).selectDays(t.selected_day),i(u,r)})}),i(u,r)}function o(){if("select"===l.last_action)a(l.last_selected_days);else if("deselect"===l.last_action)if(Array.isArray(l.last_selected_days)){var t=[];l.last_selected_days.forEach(function(e){t.push(".TableDay_"+e)}),u.remove(t.join(", ")),u=u.not(t.join(", "))}else u.remove(".TableDay_"+l.last_selected_days),u=u.not(".TableDay_"+l.last_selected_days);i(u,r)}var s=n.$wrapper.find(".EventSelectedDaysText"),r=n.$wrapper.find(".SelectedDaysRows"),l=new Calendar(".EventDatesCalendar",{weekday_selection:!0,month_selection:!0,min_date:moment().format(__C.DATE_FORMAT)}),c=n.$wrapper.find(".AddDayToTable").data("datepicker"),d={},_={"январь":"января","февраль":"февраля","март":"марта","апрель":"апреля","май":"мая","июнь":"июня","июль":"июля","август":"августа","сентябрь":"сентября","октябрь":"октября","ноябрь":"ноября","декабрь":"декабря"},u=$();l.init(),a(l.selected_days),n.$wrapper.find(".SelectedDaysRows").toggleStatus("disabled"),l.$calendar.on("days-changed.displayFormattedText",e),l.$calendar.on("days-changed.buildTable",o),c.$datepicker.on("date-picked",function(){l.selectDays(c.selected_day)})}(),function(t){OrganizationsCollection.fetchMyOrganizations(["admin","moderator"],{fields:["default_address"]},function(e){var i,a=$(".EditEventOrganizations"),o=$(),s=n.$wrapper.find(".EditEventDefaultAddress"),r=a.find("#edit_event_organization");e.forEach(function(e){e.id==t&&(i=e.default_address),o=o.add(tmpl("option",{val:e.id,data:"data-image-url='"+e.img_url+"' data-default-address='"+e.default_address+"'",display_name:e.name}))}),r.append(o).select2({containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}).on("change",function(){s.data("default_address",$(this).children(":selected").data("default-address"))}),t?(r.select2("val",t),s.data("default_address",i)):s.data("default_address",e[0].default_address),o.length>1?a.removeClass("-hidden"):a.addClass("-hidden")})}(n.event.organization_id),bindCollapsing(n.$wrapper),i=i.resolveInstance(),n.$wrapper.find(".Placepicker").placepicker(),n.$wrapper.find(".EventTags").select2({tags:!0,width:"100%",placeholder:"Выберите до 5 тегов",maximumSelectionLength:5,maximumSelectionSize:5,tokenSeparators:[",",";"],multiple:!0,createSearchChoice:function(t,e){if(0===$(e).filter(function(){return 0===this.text.localeCompare(t)}).length)return{id:t,text:t}},ajax:{url:"/api/v1/tags/",dataType:"JSON",data:function(t,e){return{name:t}},results:function(t){var e=[];return t.data.forEach(function(t){t.text=t.name,e.push(t)}),{results:e}}},containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}),n.$wrapper.find(".EditEventDefaultAddress").off("click.defaultAddress").on("click.defaultAddress",function(){var t=$(this);t.closest(".form_group").find("input").val(t.data("default_address")).trigger("input")}),n.$wrapper.find("#edit_event_is_online").off("change.OnlineEvent").on("change.OnlineEvent",function(){n.$wrapper.find("#edit_event_placepicker").prop("required",!$(this).prop("checked"))}),n.$wrapper.find("#edit_event_free").off("change.FreeEvent").on("change.FreeEvent",function(){n.$wrapper.find(".MinPrice").toggleStatus("disabled")}),e(n.$wrapper.find(".MinPrice")),e(n.$wrapper.find("#edit_event_registration_limit_count")),n.$wrapper.find(".AddRegistrationCustomField").off("click.AddRegistrationCustomField").on("click.AddRegistrationCustomField",function(){t.buildRegistrationCustomField().insertBefore($(this))}),n.$wrapper.find(".RegistrationPreview").on("click.RegistrationPreview",function(){var t,e=$(this).closest("form").serializeForm(),n=new OneEvent;e.registration_fields=(new RegistrationFieldsCollection).setData(e.registration_fields.sort().map(function(t){return{uuid:guid(),type:e["registration_"+t+"_field_type"],label:e["registration_"+t+"_field_label"]||RegistrationFieldModel.DEFAULT_LABEL[e["registration_"+t+"_field_type"].toUpperCase()],required:e["registration_"+t+"_field_required"]}})),n.setData(e),t=new PreviewRegistrationModal(n),t.show()}),i.on("change.tabs",function(){0===i.currentTabsIndex?s.addClass(__C.CLASSES.HIDDEN):s.removeClass(__C.CLASSES.HIDDEN),i.currentTabsIndex===i.tabsCount-1?(o.addClass(__C.CLASSES.HIDDEN),r.removeClass(__C.CLASSES.HIDDEN)):(o.removeClass(__C.CLASSES.HIDDEN),r.addClass(__C.CLASSES.HIDDEN))}),o.off("click.nextPage").on("click.nextPage",function(){i.nextTab()}),s.off("click.nextPage").on("click.prevPage",function(){i.prevTab()}),r.off("click.Submit").on("click.Submit",function(){function t(){__APP.changeState("/event/"+n.event.id)}function e(t){n.$wrapper.removeClass("-faded"),console.error(t),console.log({MainCalendar:s,send_data:i,form_data:l})}var i,a,o=n.$wrapper.find("#edit-event-form"),s=n.$wrapper.find(".EventDatesCalendar").resolveInstance(),r=o.find("input.EventTags"),l=o.serializeForm(),c=!!n.event.id;if(a=function(t,e){function n(t,e,n){var i,a;return e&&(i=t.parents(".TabsBody:last"),a=i.closest(".Tabs").resolveInstance(),a.setToTab(a.find(".TabsBodyWrapper:first").children().index(i)),scrollTo(t,400,function(){showNotifier({text:n,status:!1})})),handleErrorField(t),!1}var i=!0,a=t.find("#edit_event_different_time").prop("checked")?t.find('[class^="TableDay_"]'):t.find(".MainTime");return t.find(":required").not(t.find(":disabled")).each(function(){var t=$(this);""===t.val().trim()?i=n(t,i,"Заполните все обязательные поля"):t.hasClass("LimitSize")&&t.val().trim().length>t.data("maxlength")&&(i=n(t,i,"Количество символов превышает установленное значение"))}),e.selected_days.length||(i=n(e.$calendar,i,"Выберите даты для события")),a.each(function(){var t=$(this),e=t.find(".StartHours, .StartMinutes, .EndHours, .EndMinutes"),a=t.find(".StartHours").val().trim()+t.find(".StartMinutes").val().trim(),o=t.find(".EndHours").val().trim()+t.find(".EndMinutes").val().trim();e.each(function(){var t=$(this);""===t.val().trim()&&(i=n(t,i,"Заполните время события"))}),i&&a>o&&(i=n(t,i,"Начальное время не может быть позже конечного"))}),""===r.val().trim()&&(i=n(r.siblings(".EventTags"),i,"Необходимо выбрать хотя бы один тэг")),!l.registration_limit_by_quantity||l.registration_fields&&l.registration_fields.length||(i=n(t.find("#edit_event_registration_fields"),i,"Должно быть выбрано хотя бы одно поле регистрации в анкете")),c||t.find(".DataUrl").each(function(){var t=$(this);""===t.val().trim()&&(i=n(t.closest(".ImgLoadWrap"),i,"Пожалуйста, добавьте к событию обложку"))}),i}(o,s))try{i={event_id:parseInt(l.event_id)?parseInt(l.event_id):null,title:l.title.trim(),organization_id:l.organization_id,description:l.description.trim(),is_online:l.is_online,location:l.location&&l.location.trim()?l.location.trim():null,detail_info_url:l.detail_info_url?l.detail_info_url.trim():null,image_horizontal:l.image_horizontal,filenames:{horizontal:l.filename_horizontal},is_free:l.is_free,min_price:l.is_free?null:l.min_price},i.registration_required=l.registration_required,l.registration_required&&(l.registration_limit_by_date&&(i.registration_till=moment(l.registration_till_date+"T"+l.registration_till_time_hours+":"+l.registration_till_time_minutes+":00").tz("UTC").format()),l.registration_limit_by_quantity&&(i.registration_locally=!0,i.registration_limit_count=l.registration_limit_count),l.registration_fields&&l.registration_fields.length&&(i.registration_locally=!0,i.registration_fields=(new RegistrationFieldsCollection).setData(l.registration_fields.map(function(t){var e=new RegistrationFieldModel;return e.required=l["registration_"+t+"_field_required"],l["registration_"+t+"_field_uuid"]&&(e.uuid=l["registration_"+t+"_field_uuid"]),l["registration_"+t+"_field_type"]&&(e.type=l["registration_"+t+"_field_type"]),l["registration_"+t+"_field_label"]&&(e.label=l["registration_"+t+"_field_label"].trim()),e})).getArrayCopy())),l.tags&&(i.tags=l.tags.split(",")),i.delayed_publication=l.delayed_publication,l.delayed_publication&&(i.public_at=moment(l.public_at_date+"T"+l.public_at_time_hours+":"+l.public_at_time_minutes+":00").tz("UTC").format()),i.different_time=l.different_time,i.dates=new DateModelsCollection,l.different_time?n.$wrapper.find(".SelectedDaysRows").children().each(function(t,e){var n=$(e);i.dates.push((new DateModel).setData({event_date:n.find(".DatePicker").data("selected_day"),start_time:n.find(".StartHours").val()+":"+n.find(".StartMinutes").val(),end_time:n.find(".EndHours").val()+":"+n.find(".EndMinutes").val()}))}):s.selected_days.forEach(function(t){i.dates.push((new DateModel).setData({event_date:t,start_time:l.start_hours+":"+l.start_minutes,end_time:l.end_hours+":"+l.end_minutes}))}),i.dates=i.dates.getArrayCopy(),n.$wrapper.addClass("-faded"),c?n.event.updateEvent(i,t,e):n.event.createEvent(i,t,e)}catch(t){e(t)}})},t.prototype.render=function(){function e(t){return t?t.split("/").reverse()[0]:""}var n=this,i=!!n.event.id,a=$.extend(!0,{},Object.getProps(n.event),{event_id:n.event.id?n.event.id:void 0,public_at_data_label:"Дата",current_date:moment().format(__C.DATE_FORMAT),tomorrow_date:moment().add(1,"d").format(__C.DATE_FORMAT),button_text:i?"Сохранить":"Опубликовать"}),o={registration_limit_count:n.event.registration_limit_count,registration_till_display_date:"Дата",tomorrow_date:a.tomorrow_date,predefined_field:tmpl("edit-event-registration-predefined-field",[{id:t.lastRegistrationCustomFieldId++,type:"email",name:"E-mail",description:"Текстовое поле для ввода адреса электронной почты"},{id:t.lastRegistrationCustomFieldId++,type:"first_name",name:"Имя",description:"Текстовое поле для ввода имени"},{id:t.lastRegistrationCustomFieldId++,type:"last_name",name:"Фамилия",description:"Текстовое поле для ввода фамилии"},{id:t.lastRegistrationCustomFieldId++,type:"phone_number",name:"Номер телефона",description:"Текстовое поля для ввода номера телефона"}])};if(__APP.USER.id===-1)return __APP.changeState("/feed/actual",!0,!0),null;if(window.location.pathname.contains("event/add"))return this.organization_id?__APP.changeState("/add/event/to/"+this.organization_id,!0,!0):__APP.changeState("/add/event",!0,!0),null;if(n.event.registration_required&&n.event.registration_till){var s=moment.unix(n.event.registration_till);o=$.extend(o,{registration_till_display_date:s.format(__LOCALES.ru_RU.DATE.DATE_FORMAT),registration_till_date:s.format(__C.DATE_FORMAT),registration_till_time_hours:s.format("HH"),registration_till_time_minutes:s.format("mm")})}if(null!=n.event.public_at){var r=moment.unix(n.event.public_at);a.public_at_data=r.format("YYYY-MM-DD"),a.public_at_data_label=r.format("DD.MM.YYYY"),a.public_at_time_hours=r.format("HH"),a.public_at_time_minutes=r.format("mm")}console.log(a),n.$wrapper.html(tmpl("edit-event-page",$.extend(a,{date_picker:tmpl("edit-event-datepicker",{today:a.current_date}),cover_picker:tmpl("edit-event-cover-picker",{image_horizontal_url:n.event.image_horizontal_url,image_horizontal_filename:e(n.event.image_horizontal_url)}),registration:tmpl("edit-event-registration",o)}))),n.init(),null!=a.public_at&&n.$wrapper.find("#edit_event_delayed_publication").prop("checked",!0).trigger("change"),i&&(!function(t,e,i){var a,o=t.find(".EventDatesCalendar").data("calendar"),s=e[0].start_time.split(":"),r=e[0].end_time?e[0].end_time.split(":"):[],l=t.find(".SelectedDaysRows"),c=[];i?(a=t.find(".MainTime"),a.find(".StartHours").val(s[0]),a.find(".StartMinutes").val(s[1]),r.length&&(a.find(".EndHours").val(r[0]),a.find(".EndMinutes").val(r[1]))):n.$wrapper.find("#edit_event_different_time").prop("checked",!0).trigger("change"),e.forEach(function(t){t.event_date=moment.unix(t.event_date).format("YYYY-MM-DD"),c.push(t.event_date)}),o.selectDays(c),e.forEach(function(t){var e=l.find(".TableDay_"+t.event_date),n=t.start_time.split(":"),i=t.end_time?t.end_time.split(":"):[];e.find(".StartHours").val(n[0]),e.find(".StartMinutes").val(n[1]),
i.length&&(e.find(".EndHours").val(i[0]),e.find(".EndMinutes").val(i[1]))})}(n.$wrapper,n.event.dates,n.event.is_same_time),function(t,e){var n=[];e.forEach(function(t){n.push({id:parseInt(t.id),text:t.name})}),t.find("#event_tags").select2("data",n)}(n.$wrapper,n.event.tags),n.event.image_horizontal_url&&toDataUrl(n.event.image_horizontal_url,function(t){n.$wrapper.find("#edit_event_image_horizontal_source").val(t?t:null)}),n.event.is_free||(n.$wrapper.find("#edit_event_free").prop("checked",!1).trigger("change"),n.$wrapper.find("#edit_event_min_price").val(n.event.min_price)),n.event.registration_required&&(n.$wrapper.find("#edit_event_registration_required").prop("checked",!0).trigger("change"),n.event.registration_till&&n.$wrapper.find("#edit_event_registration_limit_by_date").prop("checked",!0).trigger("change"),n.event.registration_limit_count&&n.$wrapper.find("#edit_event_registration_limit_by_quantity").prop("checked",!0).trigger("change"),a.registration_fields&&a.registration_fields.length&&n.$wrapper.find(".AddRegistrationCustomField").before(t.buildRegistrationCustomField(a.registration_fields.filter(function(t){var e=RegistrationFieldModel.isCustomField(t);return e||(n.$wrapper.find("#edit_event_registration_"+t.type+"_field_uuid").val(t.uuid),n.$wrapper.find("#edit_event_registration_"+t.type+"_field_enable").prop("checked",!0).trigger("change"),t.required&&n.$wrapper.find("#edit_event_registration_"+t.type+"_field_required").prop("checked",!0)),e})))),null==a.public_at&&n.$wrapper.find("#edit_event_delayed_publication").toggleStatus("disabled"))},t}()),AddEventPage=extending(RedactEventPage,function(){function t(t){RedactEventPage.apply(this),this.page_title="Добавить событие",this.organization_id=t}return t}()),EventPage=extending(Page,function(){function t(t){Page.apply(this),this.event=new OneEvent(t)}return t.fields=new Fields(["image_horizontal_medium_url","image_horizontal_large_url","favored_users_count","is_favorite","description","location","latitude","longitude","is_online","can_edit","is_free","min_price","organization_logo_small_url","organization_short_name","is_same_time","tags","detail_info_url","canceled","public_at","is_registered","registration_required","registration_approvement_required","registration_till","registration_limit_count","registration_locally","registration_fields","registration_available","registration_approved","registered_count","registered"],{dates:{length:0,fields:new Fields("start_time","end_time")},favored:{fields:new Fields("is_friend"),order_by:"-is_friend",length:10},notifications:{fields:new Fields("notification_type","done")},orders:{fields:new Fields("created_at")},tickets:new Fields("created_at","number","ticket_type")}),t.buildNotifications=function(t,e,n){var i=moment(),a={"notification-before-quarter-of-hour":{label:"За 15 минут",moment:moment.unix(n).subtract(15,"minutes").unix()},"notification-before-three-hours":{label:"За 3 часа",moment:moment.unix(n).subtract(3,"hours").unix()},"notification-before-day":{label:"За день",moment:moment.unix(n).subtract(1,"days").unix()},"notification-before-three-days":{label:"За 3 дня",moment:moment.unix(n).subtract(3,"days").unix()},"notification-before-week":{label:"За неделю",moment:moment.unix(n).subtract(1,"week").unix()}},o=$(),s={},r=0;for(var l in t)t.hasOwnProperty(l)&&(s[t[l].notification_type]=t[l]);for(var c in a)if(a.hasOwnProperty(c)){var d=moment.unix(a[c].moment).isBefore(i),_={id:"event_notify_"+ ++r,classes:["ToggleNotification"],name:"notification_time",label:a[c].label,attributes:{value:c},dataset:{event_id:e}};s[c]&&(d=d||s[c].done||!s[c].uuid,s[c].uuid&&(_.dataset.uuid=s[c].uuid),_.attributes.checked=!0),d&&(_.unit_classes=["-status_disabled"],_.attributes.disabled=!0),o=o.add(__APP.BUILD.checkbox(_))}return o},t.prototype.fetchData=function(){return this.fetching_data_defer=this.event.fetchEvent(t.fields)},t.prototype.init=function(){var t=this;trimAvatarsCollection(t.$wrapper),bindRippleEffect(t.$wrapper),bindDropdown(t.$wrapper),__APP.MODALS.bindCallModal(t.$wrapper),bindCollapsing(t.$wrapper),bindPageLinks(t.$wrapper),t.$wrapper.find(".ToggleNotification").each(function(){var e=$(this);e.on("change",function(){e.prop("disabled",!0),e.prop("checked")?t.event.addNotification(e.val(),function(t){e.data("uuid",t.uuid),e.prop("disabled",!1)}):t.event.deleteNotification(e.data("uuid"),function(){e.data("uuid",void 0),e.prop("disabled",!1)})})}),t.$wrapper.find(".CancelEvent").on("click.CancelEvent",function(){t.event.changeEventStatus(OneEvent.STATUS.CANCEL,function(){t.$wrapper.find(".event_canceled_cap").removeClass(__C.CLASSES.HIDDEN)})}),t.$wrapper.find(".CancelCancellation").on("click.CancelCancellation",function(){t.event.changeEventStatus(OneEvent.STATUS.BRING_BACK,function(){t.$wrapper.find(".event_canceled_cap").addClass(__C.CLASSES.HIDDEN)})}),t.$wrapper.find(".ExternalLink").on("click.sendStat",function(){storeStat(t.event.id,__C.STATS.EVENT_ENTITY,__C.STATS.EVENT_OPEN_SITE)}),t.$wrapper.find(".EventMap").on("click.sendStat",function(){storeStat(t.event.id,__C.STATS.EVENT_ENTITY,__C.STATS.EVENT_OPEN_MAP)})},t.prototype.render=function(){var e=this,n=[__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.SIZES.SMALL,__C.CLASSES.HOOKS.ADD_AVATAR.COLLECTION,__C.CLASSES.HOOKS.CALL_MODAL],i=$(),a=$(),o=$(),s=new OneOrganization(e.event.organization_id);if(s.setData({short_name:e.event.organization_short_name,img_url:e.event.organization_logo_small_url}),__APP.changeTitle(e.event.title),e.event.is_favorite&&n.push(__C.CLASSES.HOOKS.ADD_AVATAR.STATES.SHIFTED),i=__APP.BUILD.button({classes:[__C.CLASSES.UNIVERSAL_STATES.EMPTY,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.SIZES.LOW,__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.BELL_O,__C.CLASSES.COLORS.NEUTRAL,__C.CLASSES.HOOKS.RIPPLE,__C.CLASSES.HOOKS.DROPDOWN_BUTTON],dataset:{dropdown:"edit_notification",ddWidth:190,ddPosX:"self.center",ddPosY:6}}),e.event.registration_locally||e.event.ticketing_locally?(i=i.add(new AddToFavoriteButton(e.event.id,{is_add_avatar:!0,is_checked:e.event.is_favorite,classes:[__C.CLASSES.UNIVERSAL_STATES.EMPTY,__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.RIPPLE],labels:null,colors:{unchecked:__C.CLASSES.COLORS.NEUTRAL_ACCENT,unchecked_hover:__C.CLASSES.COLORS.NEUTRAL_ACCENT}})),e.event.ticketing_locally||(i=i.add(new RegisterButton(e.event,{classes:["event_main_action_button",__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.RIPPLE],colors:{unchecked:__C.CLASSES.COLORS.NEUTRAL_ACCENT,unchecked_hover:__C.CLASSES.COLORS.NEUTRAL_ACCENT}})))):i=i.add(new AddToFavoriteButton(e.event.id,{is_add_avatar:!0,is_checked:e.event.is_favorite,classes:["event_main_action_button",__C.CLASSES.SIZES.LOW,__C.CLASSES.UNIVERSAL_STATES.ROUNDED,__C.CLASSES.HOOKS.RIPPLE],colors:{unchecked:__C.CLASSES.COLORS.NEUTRAL_ACCENT,unchecked_hover:__C.CLASSES.COLORS.NEUTRAL_ACCENT}})),e.event.registration_till&&(o=o.add(tmpl("event-additional-info",{classes:__C.CLASSES.TEXT_COLORS.ACCENT+" "+__C.CLASSES.UNIVERSAL_STATES.TRANSFORM_UPPERCASE,text:"Регистрация до "+moment.unix(e.event.registration_till).calendar(null,__LOCALES.ru_RU.DATE.CALENDAR_DATE_TIME)}))),e.event.is_free||(o=o.add(tmpl("event-additional-info",{classes:__C.CLASSES.TEXT_COLORS.ACCENT,text:"от "+(e.event.min_price?formatCurrency(e.event.min_price):"0")+" руб."}))),e.event.is_online&&(o=o.add(tmpl("event-additional-info",{classes:__C.CLASSES.TEXT_COLORS.ACCENT,text:"Online"}))),a=e.event.is_same_time?a.add(tmpl("event-additional-field",{key:"Время",value:displayTimeRange(e.event.dates[0].start_time,e.event.dates[0].end_time)})):a.add(tmpl("event-date-time",{date_times:tmpl("event-date-time-row",formatDates(e.event.dates,{date:"{D} {MMMMs}",time:"{T}"},e.event.is_same_time))})),e.event.location&&(a=a.add(tmpl("event-additional-field",{key:"Место",value:e.event.location}))),a=a.add(tmpl("event-additional-field",{key:"Теги",value:__APP.BUILD.tags(e.event.tags)})),e.event.detail_info_url&&(a=a.add(tmpl("event-detail-link",{detail_info_url:e.event.detail_info_url}))),e.$wrapper.html(tmpl("event-page",$.extend({},e.event,{action_buttons:i,avatars_collection:__APP.BUILD.avatarCollection(e.event.favored,6,{dataset:{modal_type:"favors",modal_event_id:e.event.id},classes:n,counter_classes:[__C.CLASSES.SIZES.X30,__C.CLASSES.UNIVERSAL_STATES.BORDERED,__C.CLASSES.COLORS.MARGINAL,__C.CLASSES.HOOKS.ADD_AVATAR.STATES.CASTABLE]},e.event.favored_users_count),notifications:t.buildNotifications(e.event.notifications,e.event.id,e.event.last_event_date),event_map:e.event.location?tmpl("event-map",{location_sanitized:encodeURI(e.event.location)}):"",event_edit_functions:e.event.can_edit?tmpl("event-edit-functions",e.event):"",event_additional_info:o,canceled:e.event.canceled?"":__C.CLASSES.HIDDEN,organization_avatar_block:__APP.BUILD.avatarBlocks(s,{block_classes:[__C.CLASSES.SIZES.SMALL],is_link:!0,entity:__C.ENTITIES.ORGANIZATION}),event_additional_fields:a,cancel_cancellation:e.event.can_edit?tmpl("button",{classes:__C.CLASSES.COLORS.PRIMARY+" "+__C.CLASSES.HOOKS.RIPPLE+" CancelCancellation",title:"Вернуть событие"}):""}))),e.event.is_same_time){var r=e.event.nearest_event_date?moment.unix(e.event.nearest_event_date):moment.unix(e.event.first_event_date);e.calendar=new Calendar(e.$wrapper.find(".EventCalendar"),{classes:{wrapper_class:"feed_calendar_wrapper",td_class:"event_calendar_day"},selection_type:Calendar.SELECTION_TYPES.MULTI,disable_selection:!0}),e.calendar.init().setMonth(r.format("M"),r.format("YYYY")).selectDays(e.event.dates.map(function(t){return moment.unix(t.event_date).format(__C.DATE_FORMAT)}))}__APP.USER.id===-1&&$(".DropdownButton, .DropdownBox").remove(),e.init()},t}()),OnboardingPage=extending(Page,function(){function t(){Page.apply(this,arguments),this.ajax_data={length:30,offset:0,fields:"img_small_url"},this.state_name="onboarding_page",this.is_upload_disabled=!1,this.block_scroll=!0}return t.prototype.init=function(){bindRippleEffect(this.$wrapper),bindPageLinks(this.$wrapper),this.$wrapper.find(".Link").on("click",function(){$(this).is(".SkipOnboarding")&&cookies.setItem("skip_onboarding",1,moment().add(7,"d")._d),__APP.SIDEBAR.updateSubscriptions()})},t.prototype.bindSubscriptions=function(){this.$wrapper.find(".OnboardingOrgItem").not(".-Handled_OnboardingOrgItem").on("click",function(){var t=$(this);t.hasClass(__C.CLASSES.ACTIVE)?__APP.USER.unsubscribeFromOrganization(t.data("organization_id")):__APP.USER.subscribeToOrganization(t.data("organization_id")),t.toggleClass(__C.CLASSES.ACTIVE)}).addClass("-Handled_OnboardingOrgItem")},t.prototype.render=function(){function t(t){n.detach(),t.length?(e.$wrapper.find(".RecommendationsWrapper").last().append(tmpl("onboarding-recommendation",t)),e.bindSubscriptions(),e.block_scroll=!1):e.is_upload_disabled=!0}var e=this,n=tmpl("loader",{});return __APP.USER.id===-1?(__APP.changeState("/feed/actual",!0,!0),null):(e.$wrapper.html(tmpl("onboarding-main",{})),e.init(),e.$wrapper.find(".RecommendationsWrapper").last().append(n),OrganizationsCollection.fetchRecommendations(e.ajax_data,t),void e.$wrapper.find(".RecommendationsScrollbar").scrollbar({onScroll:function(i,a){i.scroll!=i.maxScroll||e.is_upload_disabled||e.block_scroll||(e.block_scroll=!0,e.$wrapper.find(".RecommendationsWrapper").last().append(n),OrganizationsCollection.fetchRecommendations(e.ajax_data,t))}}))},t}()),EditOrganizationPage=extending(Page,function(){function t(t){Page.apply(this),this.page_title="Редактировать организацию",this.organization=new OneOrganization(t),this.categories=new CategoriesCollection,this.cities=new CitiesCollection,this.state_name="edit_organization",this.fields=["description","site_url","default_address","vk_url","facebook_url","email"],this.adding_is_over=!1}return t.prototype.fetchData=function(){var t=this.cities.fetchCities(null,0,"local_name");return this.organization.id?this.fetching_data_defer=__APP.SERVER.multipleAjax(t,this.organization.fetchOrganization(this.fields)):this.fetching_data_defer=t},t.prototype.render=function(){function t(t){bindSelect2(t),bindTabs(t),bindLimitInputSize(t),bindRippleEffect(t),bindFileLoadButton(t),ImgLoader.init(t),t.find("#add_organization_address").placepicker(),t.find("#add_organization_submit").off("click.Submit").on("click.Submit",i)}function e(t){var e=r.find("#add_organization_city");e.append(tmpl("option",s.cities.map(function(t){return{val:t.id,display_name:t.local_name}}))).select2({containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}),t&&e.select2("val",t)}function n(t){s.categories.fetchCategories({},0,function(e){var n=r.find("#add_organization_type");n.html(tmpl("option",e.map(function(t){return{val:t.id,display_name:t.name}}))).select2({containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}),t&&n.select2("val",t)})}function i(){function t(t,e){var n=!0,i=t.find("#edit_event_different_time").prop("checked")?t.find('[class^="TableDay_"]'):t.find(".MainTime");return t.find(":required").not(":disabled").each(function(){var t=$(this),e=t.data("maxlength");(""===t.val()||e&&t.val().length>e)&&(n&&$("body").stop().animate({scrollTop:Math.ceil(t.offset().top-150)},1e3,"swing"),handleErrorField(t),n=!1)}),i.each(function(){var t=$(this),e=t.find(".StartHours").val()+t.find(".StartMinutes").val(),i=t.find(".EndHours").val()+t.find(".EndMinutes").val();e>i&&(n&&$("body").stop().animate({scrollTop:Math.ceil(t.offset().top-150)},1e3,"swing"),showNotifier({text:"Начальное время не может быть меньше конечного",status:!1}),n=!1)}),e||t.find(".DataUrl").each(function(){var t=$(this);""===t.val()&&(n&&$("body").stop().animate({scrollTop:Math.ceil(t.closest(".EditEventImgLoadWrap").offset().top-150)},1e3,"swing",function(){showNotifier({text:"Пожалуйста, добавьте обложку организации",status:!1})}),n=!1)}),n}function e(){s.adding_is_over=!0;try{sessionStorage.removeItem("organization_info")}catch(t){}$(".SidebarNav").find(".ContinueRegistration").remove(),socket.emit("utils.registrationFinished",a),socket.on("utils.updateImagesDone",function(){window.location.href="/organization/"+s.organization.id}),socket.emit("utils.updateImages")}var n=r.find("#add-organization-form"),i=new OrganizationModel,o=n.serializeForm(),l=t(n,!!o.organization_id);l&&(i.setData(o),s.organization.id?s.organization.updateOrganization(i,e):s.organization.createOrganization(i,e))}var a,o,s=this,r=this.$view,l=this.$wrapper,c=this.organization.id;if(__APP.USER.id===-1)return __APP.changeState("/feed/actual",!0,!0),null;if(window.location.pathname.contains("organization/add"))return __APP.changeState("/add/organization",!0,!0),null;if(c)this.adding_is_over=!0,a=$.extend(!0,{},this.organization),a.header_text="Редактирование организации",a.background_img_url&&(a.background_filename=a.background_img_url.split("/").reverse()[0]),a.img_url&&(a.logo_filename=a.img_url.split("/").reverse()[0]),$.extend(!0,a,a),l.html(tmpl("add-organization-page",a)),a.img_url&&toDataUrl(a.img_url,function(t){r.find("#add_organization_img_src").val(t?t:null)}),a.background_img_url&&toDataUrl(a.background_img_url,function(t){r.find("#add_organization_background_src").val(t?t:null)});else{try{o=JSON.parse(sessionStorage.getItem("organization_info")?sessionStorage.getItem("organization_info"):localStorage.getItem("organization_info")),sessionStorage.removeItem("organization_info")}catch(t){o={}}a=$.extend({header_text:"Новый организатор"},o,!0),l.html(tmpl("add-organization-page",a))}t(r),__APP.MODALS.bindCallModal(r),n(a.type_id),e(a.city_id||__APP.USER.selected_city.id)},t.prototype.destroy=function(){var t=this.$wrapper.find("#add-organization-form").serializeForm(),e=$(".SidebarNav");if(!this.adding_is_over){e.find(".ContinueRegistration").length||(e.prepend(__APP.BUILD.link({page:"/add/organization",title:"Продолжить регистрацию",classes:["sidebar_navigation_item","SidebarNavItem","ContinueRegistration"]})),bindPageLinks(e));try{sessionStorage.setItem("organization_info",JSON.stringify({city_id:t.city_id,type_id:t.type_id,name:t.name,short_name:t.short_name,email:t.email,site_url:t.site_url,default_address:t.default_address,description:t.description,facebook_url:t.facebook_url,vk_url:t.vk_url}))}catch(t){}}},t}()),AddOrganizationPage=extending(EditOrganizationPage,function(){function t(){EditOrganizationPage.apply(this),this.page_title="Новая организация"}return t}()),CatalogPage=extending(Page,function(){function t(t,e){Page.apply(this),$.isNumeric(t)&&!e&&(e=t,t=__APP.USER.selected_city.en_name),this.wrapper_tmpl="organizations",this.categories_ajax_data={order_by:"order_position"},this.organizations_ajax_data={fields:["background_small_img_url","img_small_url","is_subscribed","subscribed_count","privileges"],order_by:"-subscribed_count"},this.default_title="Организации",this.selected_city=new OneCity,this.selected_city_name=t||__APP.USER.selected_city.en_name,this.selected_category_id=e,this.cities=new CitiesCollection,this.categories=new CategoriesCollection,this.all_organizations=new OrganizationsCollection}return t.prototype.fetchData=function(){var t=this;return this.fetching_data_defer=this.cities.fetchCities(null,0,"distance,local_name",function(){t.selected_city_name&&(t.selected_city=this.getByName(t.selected_city_name),t.categories_ajax_data.city_id=t.selected_city.id)}).then(function(){return t.categories.fetchCategoriesWithOrganizations(t.categories_ajax_data,t.organizations_ajax_data,0).done(function(){t.all_organizations=t.categories.reduce(function(t,e){return t.setData(e.organizations)},new OrganizationsCollection).sort(function(t,e){return e.subscribed_count-t.subscribed_count})})}).promise()},t.prototype.selectCategory=function(t){this.selected_category_id=t?t:this.selected_category_id,this.$view.find(".Category").filter('[data-category-id="'+this.selected_category_id+'"]').addClass(__C.CLASSES.ACTIVE),__APP.changeState("/organizations/at/"+this.selected_city_name+"/"+this.selected_category_id,!0),__APP.changeTitle(this.categories.getByID(this.selected_category_id).name)},t.prototype.init=function(){function t(){bindRippleEffect(e.$view),bindPageLinks(e.$view)}var e=this,n=e.$view.find(".Category"),i=e.$view.find("#organizations_cities_select");$(window).on("subscribe.updateCatalog",function(t,n){var i=e.all_organizations.getByID(n);i.is_subscribed=!0,i.subscribed_count++}),$(window).on("unsubscribe.updateCatalog",function(t,n){var i=e.all_organizations.getByID(n);i.is_subscribed=!1,i.subscribed_count--}),t(),e.$view.find(".OrganizationsCategoriesScroll").scrollbar({disableBodyScroll:!0}),i.select2({containerCssClass:"form_select2",dropdownCssClass:"form_select2_drop"}).off("change.SelectCity").on("change.SelectCity",function(){__APP.changeState("/organizations/at/"+e.cities.getByID($(this).val()).en_name,!0,!0)}),e.selected_city_name&&i.select2("val",e.cities.getByName(e.selected_city_name).id),e.$view.find(".ShowAllOrganizations").off("click.showAllOrganizations").on("click.showAllOrganizations",function(){n.removeClass(__C.CLASSES.ACTIVE).siblings(".SubcategoryWrap").height(0),e.selected_category_id=void 0,__APP.changeState("/organizations/at/"+e.selected_city_name,!0),__APP.changeTitle(e.default_title),e.$wrapper.html(__APP.BUILD.organizationCard(e.all_organizations)),t()}),n.off("click.selectCategory").on("click.selectCategory",function(){var n=$(this),i=n.data("category-id"),a=n.next(".SubcategoryWrap"),o=!!a.length,s=n.hasClass(__C.CLASSES.ACTIVE);n.parent().find(".Category").not(n).removeClass(__C.CLASSES.ACTIVE).filter(".SubcategoryWrap").height(0),o?(a.height(s?0:a.children().outerHeight()),n.toggleClass(__C.CLASSES.ACTIVE)):s?(e.categories=new CategoriesCollection,e.categories.fetchCategoriesWithOrganizations(e.categories_ajax_data,e.organizations_ajax_data,0,function(){e.render()})):(e.selectCategory(i),e.$wrapper.html(__APP.BUILD.organizationCard(e.categories.getByID(i).organizations)),t())})},t.prototype.render=function(){this.$view.find("#organizations_cities_select").html(tmpl("option",this.cities.map(function(t){return{val:t.id,display_name:t.local_name}}))),this.$view.find(".OrganizationsCategoriesScroll").html(__APP.BUILD.organisationsCategoriesItems(this.categories)),this.$wrapper.html(__APP.BUILD.organizationCard(this.selected_category_id?this.categories.getByID(this.selected_category_id).organizations:this.all_organizations)),"/organizations"!=window.location.pathname&&"/organizations/"!=window.location.pathname||!this.selected_city_name||__APP.changeState("/organizations/at/"+this.selected_city_name,!0),this.selected_category_id?this.selectCategory(this.selected_category_id):__APP.changeTitle(this.default_title),this.init()},t.prototype.destroy=function(){$(window).off("subscribe.updateCatalog unsubscribe.updateCatalog")},t}()),OrganizationPage=extending(Page,function(){function t(t){var e={last_date:"",is_upload_disabled:!1};Page.apply(this,arguments),this.fields=new Fields("img_small_url","background_medium_img_url","description","site_url","is_subscribed","privileges","default_address","subscribed_count",{subscribed:{fields:"is_friend",order_by:"-is_friend,first_name",length:10}}),this.events_fields=new Fields("image_horizontal_medium_url","favored_users_count","is_favorite","is_registered","registration_available","registration_locally","ticketing_locally","dates",{favored:{length:5}}),this.event_types={future:$.extend(!0,{},e,{name:"future",scroll_event:"scroll.uploadFutureEvents",sort_date_type:"nearest_event_date"}),past:$.extend(!0,{},e,{name:"past",scroll_event:"scroll.uploadPastEvents",sort_date_type:"last_event_date"}),delayed:$.extend(!0,{},e,{name:"delayed",scroll_event:"scroll.uploadDelayedEvents",sort_date_type:"public_at"}),canceled:$.extend(!0,{},e,{name:"canceled",scroll_event:"scroll.uploadCanceledEvents",sort_date_type:"first_event_date"})},this.events_load=0,this.future_events=new FutureEventsCollection,this.past_events=new PastEventsCollection,this.delayed_events=new DelayedEventsCollection,this.canceled_events=new CanceledEventsCollection,this.organization=new OneOrganization(t)}return t.prototype.fetchData=function(){var t=this;return this.fetching_data_defer=this.organization.fetchOrganization(this.fields).done(function(e){t.is_admin=t.organization.role!=OneUser.ROLE.USER,t.max_events_load=t.is_admin?4:2}).promise()},t.prototype.appendEvents=function(t,e){var n,i=this.$wrapper.find("."+t.name.capitalize()+"Events");return e.length?n=__APP.BUILD.eventBlocks(e,t):(t.is_upload_disabled=!0,$(window).off(t.scroll_event),n=tmpl("organization-feed-no-event",{text:"Больше событий нет :("})),i.append(n),n},t.prototype.bindUploadEventsOnScroll=function(t){var e=this,n=$(window),i=function(){n.height()+n.scrollTop()+200>=$(document).height()&&!t.is_upload_disabled&&(n.off(t.scroll_event),e[t.name+"_events"].fetchOrganizationsFeed(e.organization.id,e.events_fields,10,function(a){e.bindFeedEvents(e.appendEvents(t,a)),n.on(t.scroll_event,i)}))};t.is_upload_disabled||n.on(t.scroll_event,i)},t.prototype.bindFeedEvents=function(t){bindRippleEffect(t),trimAvatarsCollection(t),__APP.MODALS.bindCallModal(t),bindPageLinks(t)},t.prototype.init=function(){var t,e=this;bindTabs(e.$wrapper),e.bindFeedEvents(e.$wrapper),__APP.MODALS.bindCallModal(e.$wrapper),e.$wrapper.find(".Tabs").on("change.tabs",function(){var t=[];$.each(e.event_types,function(){t.push(this.scroll_event)}),$(window).off(t.join(" ")),e.bindUploadEventsOnScroll(e.event_types[$(this).find(".Tab.-active").data("type")])}),e.$wrapper.find(".ExternalPage").on("click.sendStat",function(){storeStat(e.organization.id,__C.STATS.ORGANIZATION_ENTITY,__C.STATS.ORGANIZATION_OPEN_SITE)}),t=e.$wrapper.find(".SubscribersScroll").scrollbar({disableBodyScroll:!0,onScroll:function(n){n.scroll==n.maxScroll&&e.organization.subscribed.fetchOrganizationSubscribers(e.organization.id,10,{fields:"is_friend",order_by:"-is_friend,first_name"},function(n){n.length?t.append(__APP.BUILD.subscribers(n,e.organization.subscribed[e.organization.subscribed.length-1].is_friend)):t.off("scroll.onScroll"),bindPageLinks(t)})}})},t.prototype.render=function(){var t=this,e=new OneOrganization(t.organization.id);e.setData(t.organization),__APP.changeTitle(e.short_name),e.short_name=void 0,$(".SidebarOrganizationsList").find('[data-organization_id="'+e.id+'"]').find(".OrganizationCounter").addClass(__C.CLASSES.HIDDEN),t.$wrapper.html(tmpl("organization-wrapper",$.extend(!0,{background_image:e.background_img_url?tmpl("organization-background-image",e):"",avatar_block:__APP.BUILD.avatarBlocks(e,{block_classes:["organization_title_block"],avatar_classes:[__C.CLASSES.SIZES.SMALL,"organization_avatar"],entity:__C.ENTITIES.ORGANIZATION}),subscribe_button:new SubscribeButton(e.id,{is_checked:e.is_subscribed,colors:{checked:__C.CLASSES.COLORS.NEUTRAL,unchecked:__C.CLASSES.COLORS.ACCENT,checked_hover:__C.CLASSES.COLORS.NEUTRAL,unchecked_hover:__C.CLASSES.COLORS.ACCENT},classes:[__C.CLASSES.SIZES.LOW,__C.CLASSES.SIZES.WIDE,__C.CLASSES.HOOKS.RIPPLE]}),has_address:e.default_address?"":__C.CLASSES.HIDDEN,redact_org_button:e.role==OneUser.ROLE.ADMIN?__APP.BUILD.link({title:__LOCALES.ru_RU.TEXTS.BUTTON.EDIT,classes:["button",__C.CLASSES.SIZES.WIDE,__C.CLASSES.COLORS.NEUTRAL,__C.CLASSES.ICON_CLASS,__C.CLASSES.ICONS.PENCIL,__C.CLASSES.HOOKS.RIPPLE],page:"organization/"+e.id+"/edit/"}):"",hidden_for_users:t.is_admin?"":__C.CLASSES.HIDDEN,subscribed_blocks:__APP.BUILD.subscribers(e.subscribed)},e))),t.$wrapper.on("events_load.FutureEvents events_load.PastEvents events_load.DelayedEvents events_load.CanceledEvents",function(e){"FutureEvents"==e.namespace&&(t.init(),t.bindUploadEventsOnScroll(t.event_types.future)),t.bindFeedEvents(t.$wrapper.find("."+e.namespace)),++t.events_load==t.max_events_load&&t.$wrapper.off("events_load")}),t.future_events.fetchOrganizationsFeed(e.id,t.events_fields,10,function(e){t.appendEvents(t.event_types.future,e),t.$wrapper.trigger("events_load.FutureEvents")}),t.past_events.fetchOrganizationsFeed(e.id,t.events_fields,10,function(e){t.appendEvents(t.event_types.past,e),t.$wrapper.trigger("events_load.PastEvents")}),t.is_admin&&(t.delayed_events.fetchOrganizationsFeed(e.id,t.events_fields,10,function(e){t.appendEvents(t.event_types.delayed,e),t.$wrapper.trigger("events_load.DelayedEvents")}),t.canceled_events.fetchOrganizationsFeed(e.id,t.events_fields,10,function(e){t.appendEvents(t.event_types.canceled,e),t.$wrapper.trigger("events_load.CanceledEvents")}))},t}()),SearchPage=extending(Page,function(){function t(t){Page.apply(this,arguments),this.page_title="Поиск",this.$search_bar_input=$("#search_bar_input"),this.search_string=decodeURIComponent(t),this.events_ajax_data={length:10,fields:new Fields("image_horizontal_medium_url","detail_info_url","nearest_event_date","can_edit","location","is_favorite","is_registered","registration_available","registration_locally","registration_required","registration_till","ticketing_locally","is_free","min_price","favored_users_count","organization_name","organization_short_name","organization_logo_small_url","description","favored","is_same_time","tags","dates"),order_by:"nearest_event_date,-first_event_date"},this.organizations_ajax_data={length:30,fields:new Fields(["subscribed_count","img_small_url"])},this.past_events=!1,this.search_results=new SearchResults(this.search_string)}return t.buildOrganizationItems=function(t){return __APP.BUILD.organizationItems(t,{block_classes:["-show"],avatar_classes:["-size_50x50","-rounded"],counter_classes:[__C.CLASSES.HIDDEN]})},t.buildEventCards=function(t){var e=$();return 0==t.length?e=tmpl("search-no-events",{}):t.forEach(function(t){void 0!=t.nearest_event_date||this.past_events||(e=e.add(tmpl("divider",{title:"Прошедшие события"})),this.past_events=!0),e=e.add(__APP.BUILD.eventCards(t))}),e},t.prototype.fetchData=function(){return this.fetching_data_defer=this.search_results.fetchEventsAndOrganizations(this.events_ajax_data,this.organizations_ajax_data)},t.prototype.init=function(){function e(t){trimAvatarsCollection(t),bindRippleEffect(t),__APP.MODALS.bindCallModal(t),bindPageLinks(t),t.find(".HideEvent").remove()}var n,i=this,a=$(window);n=this.$wrapper.find(".SearchOrganizationsScrollbar").scrollbar({disableBodyScroll:!0,onScroll:function(e){e.scroll==e.maxScroll&&i.search_results.fetchOrganizations(i.organizations_ajax_data,function(e){e.length?n.append(t.buildOrganizationItems(e)):n.off("scroll.onScroll"),bindPageLinks(n)})}}),a.off("scroll.upload"+i.constructor.name),a.on("scroll.upload"+i.constructor.name,function(){a.height()+a.scrollTop()+200>=$(document).height()&&!i.block_scroll&&(i.block_scroll=!0,i.search_results.fetchEvents(i.events_ajax_data,function(n){var o;n.length?(o=t.buildEventCards(i.search_results.events.last_pushed),i.$wrapper.find(".SearchEvents").append(o),e(o),i.block_scroll=!1):a.off("scroll.upload"+i.constructor.name)}))}),e(this.$wrapper)},t.prototype.render=function(){var e={};this.$search_bar_input.val(this.search_string),e.events=t.buildEventCards(this.search_results.events),0==this.search_results.organizations.length?e.no_organizations=__C.CLASSES.HIDDEN:e.organizations=t.buildOrganizationItems(this.search_results.organizations),this.$wrapper.append(tmpl("search-wrapper",e)),this.init()},t}()),UserPage=extending(Page,function(){function t(t){Page.apply(this),this.user_id=t,this.user=new OneUser(t),this.events_metadata={last_date:""},this.disable_uploads={events:!1,activities:!1},this.favored_fetch_data={fields:new Fields("image_horizontal_medium_url","favored","dates"),order_by:"nearest_event_date,-first_event_date",length:10}}return t.bindEvents=function(t){bindRippleEffect(t),trimAvatarsCollection(t),__APP.MODALS.bindCallModal(t),bindPageLinks(t)},t.prototype.fetchData=function(){return this.user_id!=__APP.USER.id&&"me"!==this.user_id?this.fetching_data_defer=this.user.fetchUser(new Fields("type","is_friend","link","accounts","accounts_links",{friends:{fields:["is_friend"],length:4},favored:this.favored_fetch_data,subscriptions:{fields:["img_small_url"],length:4,order_by:["organization_type_order","organization_type_id"]}})):Page.prototype.fetchData.call(this)},t.prototype.uploadEntities=function(e){var n,i=this,a={activities:{fetch_method:this.user.actions.fetch,fetch_context:this.user.actions,fetch_arguments:[["organization","event","type_code","created_at"],20,"-created_at"],extra_function:function(t){t.forEach(function(t){t.user=i.user})},build_method:__APP.BUILD.activity,build_extra_arguments:[]},events:{fetch_method:this.user.fetchFavored,fetch_context:this.user,fetch_arguments:[this.favored_fetch_data],build_method:__APP.BUILD.eventBlocks,build_extra_arguments:[this.events_metadata]}},o=a[e],s=i.$wrapper.find(".TabsBody").filter('[data-tab_body_type="'+e+'"]');i.disable_uploads[e]||i.block_scroll||(n=__APP.BUILD.loaderBlock(s),i.block_scroll=!0,o.fetch_method.apply(o.fetch_context,o.fetch_arguments).done(function(a){var r;i.block_scroll=!1,n.remove(),a.length?(o.extra_function&&"function"==typeof o.extra_function&&o.extra_function(a),r=o.build_method.apply(i,[a].concat(o.build_extra_arguments)),s.append(r),t.bindEvents(r)):(s.children().length||s.append(__APP.BUILD.cap("Активности нет")),i.disable_uploads[e]=!0)}))},t.prototype.init=function(){function e(t,e){var n=t.$wrapper.find(".TabsBody").filter("."+__C.CLASSES.ACTIVE).data("tab_body_type"),i=$(window);i.off(Object.values(e).join(" ")),i.on(e[n],function(){if(isScrollRemain(200))switch(n){case"activities":t.uploadEntities("activities");break;case"events":t.uploadEntities("events")}})}var n=this,i={activities:"scroll.uploadActivities",events:"scroll.uploadEvents"};bindTabs(this.$wrapper),t.bindEvents(this.$wrapper),this.$wrapper.find(".Tabs").on("change.tabs",function(){e(n,i)}),e(this,i)},t.prototype.render=function(){var t,e,n=this;return this.user_id==__APP.USER.id?(__APP.changeState("/my/profile",!0,!0),null):(__APP.changeTitle(this.user.full_name),
this.user.actions.forEach(function(t){t.user=n.user}),t=this.user.subscriptions.length?__APP.BUILD.avatarBlocks(this.user.subscriptions.slice(0,4),{avatar_classes:["-size_30x30"],entity:"organization",is_link:!0}):__APP.BUILD.cap("Нет подписок"),e=this.user.favored.length?__APP.BUILD.eventBlocks(this.user.favored,this.events_metadata):__APP.BUILD.cap("Событий нет"),this.$wrapper.append(tmpl("user-page",{tombstone:__APP.BUILD.userTombstones(this.user,{avatar_classes:["-bordered","-shadowed"]}),links:__APP.BUILD.socialLinks(this.user.accounts_links),subscribed_orgs:t,show_all_subscribed_orgs_button:this.user.subscriptions.length?__APP.BUILD.button({classes:["-color_neutral_accent","CallModal","RippleEffect"],dataset:{modal_type:"subscribers_list",modal_entity:this.user},title:"Показать все"}):"",friends_hidden:__C.CLASSES.HIDDEN,favored_event_blocks:e})),this.uploadEntities("activities"),void this.init())},t}()),MyProfilePage=extending(UserPage,function(){function t(){UserPage.call(this,__APP.USER.id),this.page_title="Мой профиль",this.favored_fetch_data.fields.push("is_favorite"),this.user=__APP.USER}return t.prototype.fetchData=function(){return this.user.favored.length?Page.prototype.fetchData.call(this):this.fetching_data_defer=this.user.fetchFavored(this.favored_fetch_data)},t.prototype.render=function(){var t,e,n,i;__APP.changeTitle("Мой профиль"),this.user.actions.forEach(function(t){t.user=__APP.USER}),e=this.user.subscriptions.length?__APP.BUILD.avatarBlocks(this.user.subscriptions.slice(0,4),{avatar_classes:["-size_30x30"],entity:"organization",is_link:!0}):__APP.BUILD.cap("Нет подписок"),i=this.user.friends.length?__APP.BUILD.avatarBlocks(this.user.friends.slice(0,4),{avatar_classes:["-size_30x30","-rounded"],entity:"user",is_link:!0}):__APP.BUILD.cap("Нет друзей"),n=this.user.favored.length?__APP.BUILD.eventBlocks(this.user.favored,this.events_metadata):__APP.BUILD.cap("Событий нет"),this.$wrapper.append(tmpl("user-page",{tombstone:__APP.BUILD.userTombstones(this.user,{avatar_classes:["-bordered","-shadowed"]}),links:__APP.BUILD.socialLinks(this.user.accounts_links),subscribed_orgs:e,show_all_subscribed_orgs_button:this.user.subscriptions.length?__APP.BUILD.button({classes:["-color_neutral_accent","CallModal","RippleEffect"],dataset:{modal_type:"subscribers_list",modal_entity:this.user},title:"Показать все"}):"",subscribed_users:i,show_all_subscribed_users_button:this.user.friends.length?__APP.BUILD.button({classes:["-color_neutral_accent","CallModal","RippleEffect"],dataset:{modal_type:"friends_list",modal_entity:this.user},title:"Показать все"}):"",favored_event_blocks:n})),this.user.actions.length?(t=__APP.BUILD.activity(this.user.actions),this.$wrapper.find(".TabsBody").filter('[data-tab_body_type="activities"]').append(t),UserPage.bindEvents(t)):this.uploadEntities("activities"),this.init()},t}()),MyTicketsPage=extending(Page,function(){function t(){Page.call(this),this.page_title="Мои билеты",this.tickets=new MyTicketsCollection,this.disable_uploads=!1,this.block_scroll=!1,this.fetch_tickets_fields=new Fields("created_at","number","ticket_type",{order:{fields:new Fields("created_at")},event:{fields:new Fields("dates","is_same_time","image_horizontal_medium_url","location")}}),this.fetch_tickets_quantity=30}return t.prototype.fetchData=function(){return this.fetching_data_defer=this.tickets.fetchTickets(this.fetch_tickets_fields,this.fetch_tickets_quantity)},t.prototype.init=function(){var t=this;bindCallModal(this.$wrapper),$(window).on("scroll.uploadTickets",function(){if(isScrollRemain(200)){var e;t.disable_uploads||t.block_scroll||(e=__APP.BUILD.loaderBlock(t.$wrapper),t.block_scroll=!0,t.tickets.fetchTickets(t.fetch_tickets_fields,t.fetch_tickets_quantity).done(function(n){t.block_scroll=!1,n.length?t.$wrapper.find(".TicketsWrapper").append(__APP.BUILD.ticketCards(n)):t.disable_uploads=!0,e.remove()}))}})},t.prototype.render=function(){return __APP.USER.isLoggedOut()?(__APP.changeState("/",!0,!0),null):(this.$wrapper.html(tmpl("my-tickets-wrapper",{tickets:__APP.BUILD.ticketCards(this.tickets)})),void this.init())},t}()),ServerConnection=function(){function t(){return"object"==typeof t.instance?t.instance:(this.current_connections=[],void(t.instance=this))}function e(t,e,n){n="undefined"!=typeof n?n:function(){console.log(t),showNotifier({text:"Упс, что-то пошло не так",status:!1})},e="function"!=typeof e?function(){}:e;try{t.status?e(t.data,t.text):n(t)}catch(t){n(t)}}return t.HTTP_METHODS={GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE"},Object.freeze(t.HTTP_METHODS),t.ajaxErrorHandler=function(t,e,n,i){var a,o=Array.prototype.slice.call(arguments),s={};4==o.length?(a=["event","jqxhr","settings","thrownError"],o.forEach(function(t,e){s[a[e]]=t})):1==o.length?s=o[0]:o.forEach(function(t,e){s[e]=t}),console.groupCollapsed("AJAX error"),s.thrownError&&console.log("Thrown error:",s.thrownError),s.event&&s.event.type&&console.log("Error type:",s.event.type),s.event&&s.event.text&&console.log("Description:",s.event.text),s.jqxhr&&s.jqxhr.responseJSON&&s.jqxhr.responseJSON.text&&(console.log("Response:",s.jqxhr.responseJSON.text),showNotifier({text:s.jqxhr.responseJSON.text,status:!1})),s.settings&&(console.log("URL:",s.settings.url),console.log("Method:",s.settings.type)),s.stack?(console.log("Thrown error:",s.name),console.log("Description:",s.message),console.log("Error stacktrace:",s.stack)):console.error("Error stacktrace:"),console.groupEnd(),window.errors_array||(window.errors_array=[]),window.errors_array.push(s)},t.prototype.dealAjax=function(n,i,a,o,s,r){a=a||{};var l;return a.fields instanceof Fields&&(a.fields=a.fields.toString()),l=$.ajax({url:i,data:a,method:n,contentType:o||"application/x-www-form-urlencoded; charset=UTF-8"}),this.current_connections.push(l),l.fail(r).then(function(n,i,a){return e(n,function(t,e){s&&"function"==typeof s&&s(t)},t.ajaxErrorHandler),n.data}).promise()},t.prototype.multipleAjax=function(){var t,e=arguments[arguments.length-1]instanceof Function,n=e?Array.prototype.splice.call(arguments,0,arguments.length-1):Array.prototype.slice.call(arguments);return t=$.when.apply($,n),e&&t.done(Array.prototype.shift.call(arguments)),t.promise()},t.prototype.getData=function(e,n,i,a){return this.dealAjax(t.HTTP_METHODS.GET,e,this.validateData(n),"application/json",function(t){void 0!=n.length&&void 0!=n.offset&&(n.offset+=n.length),i&&"function"==typeof i&&i(t)},a)},t.prototype.updateData=function(e,n,i,a,o){return i?this.dealAjax(t.HTTP_METHODS.PUT,e,JSON.stringify(n),"application/json",a,o):this.dealAjax(t.HTTP_METHODS.PUT,e,n,"application/x-www-form-urlencoded; charset=UTF-8",a,o)},t.prototype.addData=function(e,n,i,a,o){return i?this.dealAjax(t.HTTP_METHODS.POST,e,JSON.stringify(n),"application/json",a,o):this.dealAjax(t.HTTP_METHODS.POST,e,n,"application/x-www-form-urlencoded; charset=UTF-8",a,o)},t.prototype.deleteData=function(e,n,i,a){return this.dealAjax(t.HTTP_METHODS.DELETE,e,n,"application/json",i,a)},t.prototype.validateData=function(t){t=t||{};var e=[];return t.order_by&&(e="string"==typeof t.order_by?t.order_by.split(","):t.order_by,e=e.map(function(t){return t.trim().replace("-","")}),t.order_by instanceof Array&&(t.order_by=t.order_by.join(","))),t.fields?t.fields instanceof Array?t.fields=t.fields.merge(e):t.fields instanceof Fields&&e.length&&e.forEach(function(e){t.fields.add(e)}):t.fields=e,t.fields=(t.fields=t.fields.toString())?t.fields:void 0,t},t.prototype.abortAllConnections=function(){for(var t;this.current_connections.length;)t=this.current_connections.pop(),"pending"===t.state()},t}(),__APP={SERVER:new ServerConnection,EVENDATE_BEGIN:"15-12-2015",AUTH_URLS:{},TOP_BAR:new AbstractTopBar,SIDEBAR:new AbstractSidebar,USER:new CurrentUser,PREVIOUS_PAGE:new Page,CURRENT_PAGE:new Page,ROUTING:{admin:{organization:{"^([0-9]+)":{add:{event:AddEventPage,"":AddEventPage},edit:EditOrganizationPage,overview:AdminOrganizationOverviewPage,events:AdminOrganizationEventsPage,settings:AdminOrganizationSettingsPage,"":AdminOrganizationOverviewPage}},event:{"^([0-9]+)":{edit:RedactEventPage,"":AdminEventOverviewPage}},"":AdminOrganizationsPage},add:{event:{to:{"^([0-9]+)":AddEventPage,"":AddEventPage},"":AddEventPage},organization:AddOrganizationPage},my:{tickets:MyTicketsPage,profile:MyProfilePage,"":MyProfilePage},event:{add_to:{"^([0-9]+)":AddEventPage,"":AddEventPage},add:{to:{"^([0-9]+)":AddEventPage,"":AddEventPage},"":AddEventPage},"^([0-9]+)":{edit:RedactEventPage,"":EventPage},"":FeedPage},feed:{actual:ActualEventsPage,timeline:TimelineEventsPage,favored:FavoredEventsPage,recommendations:RecommendedEventsPage,friends:FriendsEventsPage,day:{"^([0-9]{4}-[0-9]{2}-[0-9]{2})":DayEventsPage},"":ActualEventsPage},organizations:{at:{"^([0-9]+)":CatalogPage,"^([^/]+)":{"^([0-9]+)":CatalogPage,"":CatalogPage}},"^([0-9]+)":CatalogPage,"":CatalogPage},organization:{add:AddOrganizationPage,"^([0-9]+)":{edit:EditOrganizationPage,"":OrganizationPage},"":CatalogPage},onboarding:OnboardingPage,search:{"^([^/]+)":SearchPage},friends:MyProfilePage,friend:{"^([0-9]+)":UserPage,"":MyProfilePage},user:{me:MyProfilePage,"^([0-9]+)":UserPage,"":MyProfilePage},"":ActualEventsPage},MODALS:new Modals,BUILD:new Builder,renderHeaderTabs:function(t){var e=$("#main_header_bottom").find(".HeaderTabsWrapper");t=t instanceof Array?t:[t],t.forEach(function(t){t=Builder.normalizeBuildProps(t),t.classes.push("tab","Tab"),window.location.pathname.contains(t.page)&&t.classes.push(__C.CLASSES.ACTIVE)}),e.html(tmpl("tabs-header",{color:"default",tabs:tmpl("link",t)})),bindTabs(e),bindPageLinks(e)},changeTitle:function(t){var e,n=$();switch("string"==typeof t&&(e=t,t=t.split(" > ")),!0){case t instanceof Array:t.forEach(function(e,i){i&&(n=n.add('<span class="title_chunk fa_icon fa-angle-right -empty"></span>')),"object"==typeof e?(e.toString=Array.isArray(e)?Array.toSpaceSeparatedString:Object.toHtmlDataSet,n=n.add('<a href="'+e.page+'" class="title_chunk link Link">'+e.title+"</a>"),t[i]=e.title):n=n.add('<span class="title_chunk">'+e+"</span>")}),e||(e=t.join(" > "));break;case t instanceof jQuery:n=t,t.each(function(){this.text()&&(e+=this.text()+" ")})}bindPageLinks($("#page_title").html(n)),$("title").text(e?e:"Evendate")},changeState:function(t,e,n){t?(t=0==t.indexOf("/")?t:"/"+t,e?History.replaceState({_index:History.getCurrentIndex()},"",t):History.pushState({_index:History.getCurrentIndex()},"",t),(!e||e&&n)&&__APP.reInit()):console.error("Need to pass page name")},reload:function(){return __APP.changeState(location.pathname,!0,!0)},init:function(){var t=$(".SidebarNavItem"),e=window.location.pathname;__APP.CURRENT_PAGE=Page.routeNewPage(e),__APP.CURRENT_PAGE.fetchData(),__APP.CURRENT_PAGE.show(),t.removeClass(__C.CLASSES.ACTIVE).filter(function(){return 0===e.indexOf(this.getAttribute("href"))}).addClass(__C.CLASSES.ACTIVE)},reInit:function(){$(window).off("scroll"),__APP.SERVER.abortAllConnections(),__APP.PREVIOUS_PAGE=__APP.CURRENT_PAGE,__APP.PREVIOUS_PAGE.destroy(),__APP.init(),__APP.CURRENT_PAGE instanceof SearchPage||$("#search_bar_input").val("")}},__ERRORS=[],__LOCALES={ru_RU:{TEXTS:{BUTTON:{REMOVE_FAVORITE:"Убрать",ADD_FAVORITE:"В избранное",FAVORED:"В избранном",ADD_SUBSCRIPTION:"Подписаться",REMOVE_SUBSCRIPTION:"Отписаться",SUBSCRIBED:"Подписан",EDIT:"Изменить"},SUBSCRIBERS:{NOM:" подписчик",GEN:" подписчика",PLU:" подписчиков"},PEOPLE:{NOM:" человек",GEN:" человека",PLU:" человек"},FAVORED:{NOM:" участник",GEN:" участника",PLU:" участников"},ACTIVITY:{SUBSCRIBE:{MAS:"подписался на организацию",FEM:"подписалась на организацию",NEU:"подписалось на организацию"},UNSUBSCRIBE:{MAS:"отписался от организации",FEM:"отписалась от организации",NEU:"отписалось от организации"},FAVE:{MAS:"добавил в избранное событие",FEM:"добавила в избранное событие",NEU:"добавило в избранное событие"},UNFAVE:{MAS:"удалил из избранного событие",FEM:"удалила из избранного событие",NEU:"удалило из избранного событие"},SHARE:{MAS:"поделился событием",FEM:"поделилась событием",NEU:"поделилось событием"}},TICKET_STATUSES:{USED:"Билет использован",WAITING_FOR_PAYMENT:"Ожидает оплаты",IS_PENDING:"Ожидает подтверждения",APPROVED:"Подтверждено",PAYED:"Оплачено",WITHOUT_PAYMENT:"Подтверждено",TICKETS_ARE_OVER:"Билеты закончились",RETURNED_BY_ORGANIZATION:"Возврат билета организатором",PAYMENT_CANCELED_AUTO:"Отмена транзакции",PAYMENT_CANCELED_BY_CLIENT:"Отменено клиентом",RETURNED_BY_CLIENT:"Возврат билета",REJECTED:"Отклонено"}},DATE:{DATE_FORMAT:"DD.MM.YYYY",TIME_FORMAT:"HH:mm",DATE_TIME_FORMAT:"DD.MM.YYYY HH:mm",MONTH_SHORT_NAMES:["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"],MONTH_NAMES:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],CALENDAR_DATE_TIME:{sameDay:"[Сегодня в] HH:mm",lastDay:"[Вчера в] HH:mm",nextWeek:"dddd [в] HH:mm",lastWeek:"D MMMM [в] HH:mm",sameElse:"D MMMM [в] HH:mm"}}}},Object.seal(__APP),Object.freeze(__APP.SERVER),Object.freeze(__APP.ROUTING),Object.freeze(__APP.BUILD),Object.freeze(__C),Object.freeze(__LOCALES),window.paceOptions={ajax:!1,document:!1,eventLag:!1,elements:{},search_is_active:!1,search_query:null,search_xhr:null},__stats=[],askToSubscribe=null,checkRedirects(window.location.pathname),$(document).ajaxStart(function(){Pace.restart()}).ajaxError(function(t,e,n,i){i&&"abort"==i||ServerConnection.ajaxErrorHandler(t,e,n,i)}).ready(function(){var t,e,n=window.OneSignal||[];n.push(["init",{appId:"7471a586-01f3-4eef-b989-c809700a8658",autoRegister:!1,notifyButton:{enable:!1}}]),n.push(function(){n.isPushNotificationsSupported()&&n.isPushNotificationsEnabled(function(t){t||(window.askToSubscribe=function(){n.push(function(){n.on("subscriptionChange",function(t){t&&n.getUserId(function(t){$.ajax({url:"api/v1/users/me/devices",type:"PUT",data:{device_token:t,client_type:"browser",model:navigator.appVersion?navigator.appVersion:null,os_version:navigator.platform?navigator.platform:null},global:!1})})})}),n.push(["registerForPushNotifications"]),event.preventDefault()})})}),void 0!=window.moment&&(moment.locale(navigator.language),moment.updateLocale("ru",{monthsShort:__LOCALES.ru_RU.DATE.MONTH_SHORT_NAMES,calendar:{sameDay:"[Сегодня]",nextDay:"[Завтра]",lastDay:"[Вчера]",nextWeek:"dddd",lastWeek:"D MMMM",sameElse:"D MMMM"}})),void 0!=window.Highcharts&&Highcharts.setOptions({lang:{shortMonths:__LOCALES.ru_RU.DATE.MONTH_SHORT_NAMES}}),History.Adapter.bind(window,"statechange",function(){History.getCurrentIndex()-1!==History.getState().data._index&&__APP.reInit()}),t=__APP.USER.fetchUser(new Fields("accounts","accounts_links",{friends:{fields:["is_friend"],length:4},subscriptions:{fields:["img_small_url","subscribed_count","new_events_count","actual_events_count"]}})),e=__APP.SERVER.getData("/auth.php",{action:"get_urls",mobile:isNotDesktop()}),__APP.SERVER.multipleAjax(t,e,function(t,e){var n;checkRedirects(window.location.pathname);try{n=JSON.parse(localStorage.getItem("selected_city"))}catch(t){n=!1}__APP.AUTH_URLS=e,n?__APP.USER.selected_city.setData(n):(new CitiesCollection).fetchCities(new Fields("timediff_seconds","distance"),null,"-distance",function(){new CityChooseModal(this).show()}),__APP.USER.isLoggedOut()?(__APP.TOP_BAR=new TopBarNoAuth,__APP.SIDEBAR=new SidebarNoAuth):(__APP.TOP_BAR=new TopBar,__APP.SIDEBAR=new Sidebar),__APP.TOP_BAR.init(),__APP.SIDEBAR.init(),__APP.init(),bindPageLinks()}),setInterval(function(){if(0!=window.__stats.length){var t=window.__stats;window.__stats=[],$.ajax({url:"/api/v1/statistics/batch",data:JSON.stringify(t),type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",error:function(){window.__stats.concat(t)}})}},5e3)});